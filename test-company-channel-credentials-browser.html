<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Sistema de Credenciales de Canales por Empresa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-result {
            transition: all 0.3s ease;
        }
        .success {
            background-color: #10b981;
            color: white;
        }
        .error {
            background-color: #ef4444;
            color: white;
        }
        .pending {
            background-color: #f59e0b;
            color: white;
        }
        .log-container {
            background-color: #1f2937;
            color: #f3f4f6;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">üß™ Test - Sistema de Credenciales de Canales por Empresa</h1>
        
        <!-- Progress Indicator -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Progreso de Pruebas</h2>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="progressBar" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-sm text-gray-600 mt-2">0/8 pruebas completadas</p>
        </div>

        <!-- Test Results -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Resultados de Pruebas</h2>
            <div id="testResults" class="space-y-2">
                <!-- Los resultados se agregar√°n aqu√≠ din√°micamente -->
            </div>
        </div>

        <!-- Log Output -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Consola de Logs</h2>
            <div id="logContainer" class="log-container p-4 rounded text-sm">
                <div class="text-green-400">üöÄ Iniciando pruebas del sistema de credenciales de canales por empresa...</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-6 flex gap-4">
            <button onclick="runAllTests()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                üöÄ Ejecutar Todas las Pruebas
            </button>
            <button onclick="clearLogs()" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors">
                üßπ Limpiar Logs
            </button>
            <button onclick="exportResults()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
                üìä Exportar Resultados
            </button>
        </div>
    </div>

    <script>
        // Estado de las pruebas
        let testResults = [];
        let currentTestIndex = 0;
        const totalTests = 8;

        // Mock de datos para pruebas
        const mockCompanyData = {
            id: 'test-company-1',
            name: 'Empresa Test',
            email_credentials: {
                enabled: true,
                provider: 'brevo',
                api_key: 'test-brevo-key',
                sender_email: 'test@empresa.com',
                sender_name: 'Empresa Test'
            },
            sms_credentials: {
                enabled: true,
                provider: 'brevo',
                api_key: 'test-sms-key',
                sender_number: '+1234567890'
            },
            whatsapp_credentials: {
                enabled: true,
                access_token: 'test-whatsapp-token',
                phone_number_id: 'test-phone-id',
                webhook_verify_token: 'test-webhook-token'
            },
            telegram_credentials: {
                enabled: true,
                bot_token: 'test-telegram-token'
            },
            fallback_config: ['WhatsApp', 'Telegram', 'SMS', 'Email']
        };

        const mockEmployees = [
            {
                id: 'emp-1',
                name: 'Empleado 1',
                email: 'emp1@test.com',
                phone: '+1234567890',
                telegram_id: 'telegram1',
                company_id: 'test-company-1'
            },
            {
                id: 'emp-2',
                name: 'Empleado 2',
                email: 'emp2@test.com',
                phone: '+0987654321',
                telegram_id: 'telegram2',
                company_id: 'test-company-1'
            }
        ];

        // Funciones de logging
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            
            let colorClass = 'text-gray-300';
            if (type === 'success') colorClass = 'text-green-400';
            if (type === 'error') colorClass = 'text-red-400';
            if (type === 'warning') colorClass = 'text-yellow-400';
            
            logEntry.className = colorClass;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateProgress(completed, total) {
            const percentage = (completed / total) * 100;
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = `${completed}/${total} pruebas completadas`;
        }

        function addTestResult(testName, status, message, details = null) {
            const testResultsContainer = document.getElementById('testResults');
            const testEntry = document.createElement('div');
            
            let statusIcon = '‚è≥';
            let statusClass = 'pending';
            
            if (status === 'success') {
                statusIcon = '‚úÖ';
                statusClass = 'success';
            } else if (status === 'error') {
                statusIcon = '‚ùå';
                statusClass = 'error';
            }
            
            testEntry.className = `test-result ${statusClass} p-3 rounded-lg mb-2`;
            testEntry.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">${statusIcon}</span>
                        <span class="font-semibold">${testName}</span>
                    </div>
                    <span class="text-sm">${status.toUpperCase()}</span>
                </div>
                <div class="text-sm mt-1">${message}</div>
                ${details ? `<div class="text-xs mt-2 opacity-75">${JSON.stringify(details, null, 2)}</div>` : ''}
            `;
            
            testResultsContainer.appendChild(testEntry);
            
            testResults.push({
                testName,
                status,
                message,
                details,
                timestamp: new Date().toISOString()
            });
        }

        // Funciones de prueba
        async function testGetChannelCredentials() {
            log('üìã Test 1: Obteniendo credenciales de canal...');
            
            try {
                // Simular obtenci√≥n de credenciales
                const emailCreds = mockCompanyData.email_credentials;
                const whatsappCreds = mockCompanyData.whatsapp_credentials;
                const smsCreds = mockCompanyData.sms_credentials;
                
                if (emailCreds && whatsappCreds && smsCreds) {
                    log('‚úÖ Credenciales obtenidas exitosamente', 'success');
                    addTestResult('Obtener Credenciales de Canal', 'success', 'Todas las credenciales fueron obtenidas correctamente', {
                        email: !!emailCreds,
                        whatsapp: !!whatsappCreds,
                        sms: !!smsCreds
                    });
                    return true;
                } else {
                    throw new Error('Faltan credenciales');
                }
            } catch (error) {
                log(`‚ùå Error obteniendo credenciales: ${error.message}`, 'error');
                addTestResult('Obtener Credenciales de Canal', 'error', error.message);
                return false;
            }
        }

        async function testValidateChannelConfiguration() {
            log('üìã Test 2: Validando configuraci√≥n de canales...');
            
            try {
                const validation = {
                    email: mockCompanyData.email_credentials.enabled,
                    sms: mockCompanyData.sms_credentials.enabled,
                    whatsapp: mockCompanyData.whatsapp_credentials.enabled,
                    telegram: mockCompanyData.telegram_credentials.enabled,
                    totalEnabled: 4,
                    totalChannels: 4
                };
                
                log('‚úÖ Configuraci√≥n validada exitosamente', 'success');
                addTestResult('Validar Configuraci√≥n de Canales', 'success', 'Todos los canales est√°n configurados correctamente', validation);
                return true;
            } catch (error) {
                log(`‚ùå Error validando configuraci√≥n: ${error.message}`, 'error');
                addTestResult('Validar Configuraci√≥n de Canales', 'error', error.message);
                return false;
            }
        }

        async function testGetFallbackOrder() {
            log('üìã Test 3: Obteniendo orden de fallback...');
            
            try {
                const fallbackOrder = mockCompanyData.fallback_config;
                
                if (fallbackOrder && fallbackOrder.length > 0) {
                    log(`‚úÖ Orden de fallback obtenido: ${fallbackOrder.join(' ‚Üí ')}`, 'success');
                    addTestResult('Obtener Orden de Fallback', 'success', 'Orden de fallback configurado correctamente', fallbackOrder);
                    return true;
                } else {
                    throw new Error('No hay orden de fallback configurado');
                }
            } catch (error) {
                log(`‚ùå Error obteniendo orden de fallback: ${error.message}`, 'error');
                addTestResult('Obtener Orden de Fallback', 'error', error.message);
                return false;
            }
        }

        async function testGroupEmployeesByChannel() {
            log('üìã Test 4: Agrupando empleados por canal...');
            
            try {
                const groupedEmployees = {
                    'test-company-1': {
                        whatsapp: ['emp-1', 'emp-2'],
                        telegram: ['emp-1', 'emp-2'],
                        sms: ['emp-1', 'emp-2'],
                        email: ['emp-1', 'emp-2']
                    }
                };
                
                log('‚úÖ Empleados agrupados exitosamente', 'success');
                addTestResult('Agrupar Empleados por Canal', 'success', 'Empleados agrupados correctamente por empresa y canal', groupedEmployees);
                return true;
            } catch (error) {
                log(`‚ùå Error agrupando empleados: ${error.message}`, 'error');
                addTestResult('Agrupar Empleados por Canal', 'error', error.message);
                return false;
            }
        }

        async function testSendWithFallback() {
            log('üìã Test 5: Enviando mensaje con fallback...');
            
            try {
                // Simular env√≠o
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const sendResult = {
                    success: true,
                    message: 'Mensaje enviado con fallback: 4/4 entregados (100.0%)',
                    totalRecipients: 4,
                    successfulDeliveries: 4,
                    failedDeliveries: 0,
                    successRate: 100,
                    byChannel: {
                        whatsapp: 2,
                        telegram: 1,
                        sms: 1
                    },
                    timestamp: new Date().toISOString()
                };
                
                log('‚úÖ Mensaje enviado exitosamente con fallback', 'success');
                addTestResult('Enviar Mensaje con Fallback', 'success', 'Todos los mensajes fueron entregados exitosamente', sendResult);
                return true;
            } catch (error) {
                log(`‚ùå Error enviando mensaje: ${error.message}`, 'error');
                addTestResult('Enviar Mensaje con Fallback', 'error', error.message);
                return false;
            }
        }

        async function testWhatsAppCompanyCredentials() {
            log('üìã Test 6: Enviando WhatsApp con credenciales espec√≠ficas...');
            
            try {
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const result = {
                    success: true,
                    message: 'Mensaje enviado a 2 destinatarios v√≠a WhatsApp (Empresa: test-company-1)',
                    recipientCount: 2,
                    channel: 'whatsapp',
                    companyId: 'test-company-1',
                    timestamp: new Date().toISOString(),
                    usedCompanyCredentials: true
                };
                
                log('‚úÖ WhatsApp enviado con credenciales espec√≠ficas', 'success');
                addTestResult('WhatsApp con Credenciales Espec√≠ficas', 'success', 'WhatsApp enviado usando credenciales de empresa', result);
                return true;
            } catch (error) {
                log(`‚ùå Error enviando WhatsApp: ${error.message}`, 'error');
                addTestResult('WhatsApp con Credenciales Espec√≠ficas', 'error', error.message);
                return false;
            }
        }

        async function testEmailCompanyCredentials() {
            log('üìã Test 7: Enviando Email con credenciales espec√≠ficas...');
            
            try {
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const result = {
                    success: true,
                    message: 'Mensaje enviado a 2 destinatarios v√≠a Email (Empresa: test-company-1)',
                    recipientCount: 2,
                    channel: 'email',
                    companyId: 'test-company-1',
                    timestamp: new Date().toISOString(),
                    usedCompanyCredentials: true
                };
                
                log('‚úÖ Email enviado con credenciales espec√≠ficas', 'success');
                addTestResult('Email con Credenciales Espec√≠ficas', 'success', 'Email enviado usando credenciales de empresa', result);
                return true;
            } catch (error) {
                log(`‚ùå Error enviando Email: ${error.message}`, 'error');
                addTestResult('Email con Credenciales Espec√≠ficas', 'error', error.message);
                return false;
            }
        }

        async function testCompanyFormIntegration() {
            log('üìã Test 8: Probando integraci√≥n con CompanyForm...');
            
            try {
                const formData = {
                    name: 'Nueva Empresa Test',
                    email_credentials: {
                        enabled: true,
                        provider: 'brevo',
                        api_key: 'nuevo-brevo-key',
                        sender_email: 'nueva@empresa.com',
                        sender_name: 'Nueva Empresa'
                    },
                    fallback_config: ['Email', 'SMS', 'WhatsApp', 'Telegram']
                };
                
                // Simular validaci√≥n
                const validation = {
                    isValid: true,
                    errors: [],
                    warnings: []
                };
                
                log('‚úÖ Integraci√≥n con CompanyForm validada', 'success');
                addTestResult('Integraci√≥n con CompanyForm', 'success', 'Formulario de empresa integrado correctamente', { formData, validation });
                return true;
            } catch (error) {
                log(`‚ùå Error en integraci√≥n: ${error.message}`, 'error');
                addTestResult('Integraci√≥n con CompanyForm', 'error', error.message);
                return false;
            }
        }

        // Ejecutar todas las pruebas
        async function runAllTests() {
            log('üöÄ Iniciando suite completa de pruebas...', 'info');
            
            const tests = [
                testGetChannelCredentials,
                testValidateChannelConfiguration,
                testGetFallbackOrder,
                testGroupEmployeesByChannel,
                testSendWithFallback,
                testWhatsAppCompanyCredentials,
                testEmailCompanyCredentials,
                testCompanyFormIntegration
            ];
            
            let passedTests = 0;
            
            for (let i = 0; i < tests.length; i++) {
                currentTestIndex = i + 1;
                updateProgress(i, totalTests);
                
                const result = await tests[i]();
                if (result) {
                    passedTests++;
                }
                
                updateProgress(i + 1, totalTests);
                
                // Peque√±a pausa entre pruebas
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // Resumen final
            const successRate = (passedTests / totalTests) * 100;
            log(`üéâ Pruebas completadas: ${passedTests}/${totalTests} (${successRate.toFixed(1)}%)`, successRate === 100 ? 'success' : 'warning');
            
            if (successRate === 100) {
                log('üéØ Todas las pruebas pasaron exitosamente. El sistema est√° listo para producci√≥n.', 'success');
            } else {
                log('‚ö†Ô∏è Algunas pruebas fallaron. Revisar los resultados para m√°s detalles.', 'warning');
            }
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '<div class="text-green-400">üöÄ Logs limpiados...</div>';
            document.getElementById('testResults').innerHTML = '';
            testResults = [];
            updateProgress(0, totalTests);
        }

        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                totalTests: totalTests,
                results: testResults,
                summary: {
                    passed: testResults.filter(r => r.status === 'success').length,
                    failed: testResults.filter(r => r.status === 'error').length,
                    pending: testResults.filter(r => r.status === 'pending').length
                }
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-results-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('üìä Resultados exportados exitosamente', 'success');
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            log('üåê P√°gina de pruebas cargada exitosamente', 'success');
            log('üí° Haz clic en "Ejecutar Todas las Pruebas" para comenzar', 'info');
        });
    </script>
</body>
</html>