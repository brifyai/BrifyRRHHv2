[{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\App.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\AppWithErrorHandling.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\api\\webhook\\drive-notifications.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\api\\webhook\\google-calendar-notifications.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'resourceId' is assigned a value but never used.","line":71,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":71,"endColumn":21},{"ruleId":"no-unused-vars","severity":1,"message":"'endTime' is assigned a value but never used.","line":196,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":196,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":331,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":331,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Endpoint API para recibir notificaciones de Google Calendar (Google Meet)\r\n// Procesa eventos de calendario que incluyen enlaces de Google Meet\r\n\r\nimport { supabase } from '../../lib/supabase.js';\r\nimport communicationService from '../../services/communicationService.js';\r\n\r\n/**\r\n * Procesa notificaciones de Google Calendar recibidas desde Google Calendar API\r\n * @param {Request} req - Request object\r\n * @param {Response} res - Response object\r\n */\r\nexport default async function handler(req, res) {\r\n  // Solo aceptar m√©todos POST\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({\r\n      success: false,\r\n      error: 'M√©todo no permitido. Solo se acepta POST.'\r\n    });\r\n  }\r\n\r\n  try {\r\n    console.log('üìÖ Webhook recibido desde Google Calendar:', {\r\n      headers: req.headers,\r\n      body: req.body,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n\r\n    const webhookData = req.body;\r\n\r\n    // Validar que tenemos los datos necesarios\r\n    if (!webhookData) {\r\n      console.error('‚ùå Datos de webhook inv√°lidos');\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'Datos de webhook inv√°lidos'\r\n      });\r\n    }\r\n\r\n    // Procesar notificaci√≥n de Google Calendar\r\n    await processGoogleCalendarNotification(webhookData, req);\r\n\r\n    // Respuesta exitosa\r\n    return res.status(200).json({\r\n      success: true,\r\n      message: 'Notificaci√≥n procesada correctamente'\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('üí• Error procesando webhook de Google Calendar:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Error interno del servidor',\r\n      details: error.message\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa una notificaci√≥n de Google Calendar\r\n * @param {Object} notification - Notificaci√≥n de Google Calendar\r\n * @param {Object} req - Request object para acceder a headers\r\n */\r\nasync function processGoogleCalendarNotification(notification, req) {\r\n  try {\r\n    console.log('üîÑ Procesando notificaci√≥n de Google Calendar');\r\n\r\n    // En las notificaciones de Google Calendar Push, solo obtenemos headers con metadatos\r\n    // Necesitamos hacer una petici√≥n a la Calendar API para obtener los detalles del evento\r\n\r\n    const channelId = req.headers['x-goog-channel-id'];\r\n    const resourceId = req.headers['x-goog-resource-id'];\r\n    const resourceState = req.headers['x-goog-resource-state'];\r\n\r\n    if (!channelId) {\r\n      console.error('‚ùå No es una notificaci√≥n v√°lida de Google Calendar: falta x-goog-channel-id');\r\n      return;\r\n    }\r\n\r\n    console.log('üì° Procesando notificaci√≥n del canal:', channelId, 'Estado:', resourceState);\r\n\r\n    // Buscar la suscripci√≥n de calendario en la base de datos\r\n    const { data: subscription, error: subError } = await supabase\r\n      .from('google_calendar_subscriptions')\r\n      .select('id, user_id, calendar_id, resource_id')\r\n      .eq('channel_id', channelId)\r\n      .eq('is_active', true)\r\n      .single();\r\n\r\n    if (subError || !subscription) {\r\n      console.error('‚ùå Suscripci√≥n de calendario no encontrada:', subError);\r\n      return;\r\n    }\r\n\r\n    console.log('‚úÖ Suscripci√≥n encontrada:', subscription);\r\n\r\n    // Si es una notificaci√≥n de sync, no necesitamos procesar cambios espec√≠ficos\r\n    if (resourceState === 'sync') {\r\n      console.log('üîÑ Notificaci√≥n de sincronizaci√≥n, ignorando');\r\n      return;\r\n    }\r\n\r\n    // Obtener eventos del calendario que han cambiado\r\n    await processCalendarEvents(subscription);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando notificaci√≥n de calendario:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa los eventos del calendario que han cambiado\r\n * @param {Object} subscription - Datos de la suscripci√≥n\r\n */\r\nasync function processCalendarEvents(subscription) {\r\n  try {\r\n    // Obtener credenciales del usuario\r\n    const { data: credentials, error } = await supabase\r\n      .from('user_credentials')\r\n      .select('google_access_token, google_refresh_token')\r\n      .eq('user_id', subscription.user_id)\r\n      .single();\r\n\r\n    if (error || !credentials?.google_access_token) {\r\n      console.error('‚ùå No se encontraron credenciales de Google para el usuario');\r\n      return;\r\n    }\r\n\r\n    // Obtener eventos del calendario desde la √∫ltima sincronizaci√≥n\r\n    const events = await getCalendarEvents(subscription.calendar_id, credentials.google_access_token);\r\n\r\n    if (!events || events.length === 0) {\r\n      console.log('üì≠ No hay eventos nuevos para procesar');\r\n      return;\r\n    }\r\n\r\n    // Procesar cada evento\r\n    for (const event of events) {\r\n      await processCalendarEvent(event, subscription.user_id);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando eventos del calendario:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Obtiene eventos del calendario desde Google Calendar API\r\n * @param {string} calendarId - ID del calendario\r\n * @param {string} accessToken - Token de acceso\r\n * @returns {Array} Lista de eventos\r\n */\r\nasync function getCalendarEvents(calendarId, accessToken) {\r\n  try {\r\n    // Calcular el tiempo desde la √∫ltima verificaci√≥n (√∫ltimos 5 minutos)\r\n    const now = new Date();\r\n    const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);\r\n\r\n    const timeMin = fiveMinutesAgo.toISOString();\r\n\r\n    const response = await fetch(\r\n      `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events?timeMin=${timeMin}&singleEvents=true&orderBy=startTime`,\r\n      {\r\n        headers: {\r\n          'Authorization': `Bearer ${accessToken}`,\r\n          'Content-Type': 'application/json'\r\n        }\r\n      }\r\n    );\r\n\r\n    if (!response.ok) {\r\n      console.error('‚ùå Error obteniendo eventos del calendario:', response.status);\r\n      return null;\r\n    }\r\n\r\n    const data = await response.json();\r\n    console.log(`‚úÖ Obtenidos ${data.items?.length || 0} eventos del calendario`);\r\n\r\n    return data.items || [];\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error obteniendo eventos del calendario:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa un evento individual del calendario\r\n * @param {Object} event - Evento del calendario\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processCalendarEvent(event, userId) {\r\n  try {\r\n    const eventId = event.id;\r\n    const summary = event.summary || 'Sin t√≠tulo';\r\n    const startTime = event.start?.dateTime || event.start?.date;\r\n    const endTime = event.end?.dateTime || event.end?.date;\r\n    const description = event.description || '';\r\n    const location = event.location || '';\r\n\r\n    console.log('üìÖ Procesando evento:', summary, 'ID:', eventId);\r\n\r\n    // Verificar si es un evento nuevo o actualizado\r\n    const { data: existingEvent, error } = await supabase\r\n      .from('google_calendar_events')\r\n      .select('id, processed_at')\r\n      .eq('event_id', eventId)\r\n      .eq('user_id', userId)\r\n      .single();\r\n\r\n    const isNewEvent = !existingEvent || error;\r\n    const isUpdated = existingEvent && existingEvent.processed_at < new Date(event.updated);\r\n\r\n    if (!isNewEvent && !isUpdated) {\r\n      console.log('‚ö†Ô∏è Evento ya procesado anteriormente');\r\n      return;\r\n    }\r\n\r\n    // Verificar si contiene enlace de Google Meet\r\n    const meetLink = extractMeetLink(description, location);\r\n    if (!meetLink) {\r\n      console.log('‚ö†Ô∏è Evento no contiene enlace de Google Meet, ignorando');\r\n      return;\r\n    }\r\n\r\n    // Generar mensaje de WhatsApp\r\n    let whatsappMessage = '';\r\n\r\n    if (isNewEvent) {\r\n      whatsappMessage = `Nueva reuni√≥n de Google Meet: \"${summary}\" el ${formatCalendarDate(startTime)}. Enlace: ${meetLink}`;\r\n    } else if (isUpdated) {\r\n      whatsappMessage = `Reuni√≥n actualizada: \"${summary}\" ahora es el ${formatCalendarDate(startTime)}. Enlace: ${meetLink}`;\r\n    }\r\n\r\n    // Enviar recordatorio si la reuni√≥n es pr√≥xima (menos de 15 minutos)\r\n    if (startTime) {\r\n      const eventTime = new Date(startTime);\r\n      const now = new Date();\r\n      const timeDiff = eventTime - now;\r\n      const minutesDiff = timeDiff / (1000 * 60);\r\n\r\n      if (minutesDiff > 0 && minutesDiff <= 15) {\r\n        whatsappMessage = `Tienes una reuni√≥n de Google Meet en ${Math.round(minutesDiff)} minutos: \"${summary}\". Enlace: ${meetLink}`;\r\n      }\r\n    }\r\n\r\n    // Enviar notificaci√≥n por WhatsApp\r\n    await sendCalendarWhatsAppNotification(userId, whatsappMessage);\r\n\r\n    // Guardar o actualizar el evento en la base de datos\r\n    await saveCalendarEvent(event, userId, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando evento del calendario:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Extrae el enlace de Google Meet de la descripci√≥n o ubicaci√≥n\r\n * @param {string} description - Descripci√≥n del evento\r\n * @param {string} location - Ubicaci√≥n del evento\r\n * @returns {string|null} Enlace de Meet o null\r\n */\r\nfunction extractMeetLink(description, location) {\r\n  const meetUrlPattern = /https:\\/\\/meet\\.google\\.com\\/[a-zA-Z0-9-]+/;\r\n  const hangoutsUrlPattern = /https:\\/\\/hangouts\\.google\\.com\\/[a-zA-Z0-9-]+/;\r\n\r\n  // Buscar en descripci√≥n\r\n  let match = description.match(meetUrlPattern) || description.match(hangoutsUrlPattern);\r\n  if (match) return match[0];\r\n\r\n  // Buscar en ubicaci√≥n\r\n  match = location.match(meetUrlPattern) || location.match(hangoutsUrlPattern);\r\n  if (match) return match[0];\r\n\r\n  return null;\r\n}\r\n\r\n/**\r\n * Env√≠a notificaci√≥n por WhatsApp para eventos de calendario\r\n * @param {string} userId - ID del usuario\r\n * @param {string} message - Mensaje a enviar\r\n */\r\nasync function sendCalendarWhatsAppNotification(userId, message) {\r\n  try {\r\n    // Obtener empleados asociados al usuario\r\n    const { data: employees } = await supabase\r\n      .from('employees')\r\n      .select('id')\r\n      .eq('user_id', userId)\r\n      .limit(10);\r\n\r\n    if (!employees || employees.length === 0) {\r\n      console.error('‚ùå No se encontraron empleados para enviar WhatsApp');\r\n      return;\r\n    }\r\n\r\n    const recipientIds = employees.map(emp => emp.id);\r\n\r\n    // Enviar mensaje usando el servicio de comunicaci√≥n\r\n    await communicationService.sendWhatsAppMessage(recipientIds, message);\r\n\r\n    console.log('‚úÖ Mensaje de WhatsApp enviado para calendario:', message);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error enviando mensaje de WhatsApp para calendario:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Guarda el evento del calendario en la base de datos\r\n * @param {Object} event - Datos del evento\r\n * @param {string} userId - ID del usuario\r\n * @param {string} whatsappMessage - Mensaje enviado por WhatsApp\r\n */\r\nasync function saveCalendarEvent(event, userId, whatsappMessage) {\r\n  try {\r\n    const eventData = {\r\n      event_id: event.id,\r\n      user_id: userId,\r\n      summary: event.summary,\r\n      description: event.description,\r\n      location: event.location,\r\n      start_time: event.start?.dateTime || event.start?.date,\r\n      end_time: event.end?.dateTime || event.end?.date,\r\n      meet_link: extractMeetLink(event.description || '', event.location || ''),\r\n      whatsapp_message: whatsappMessage,\r\n      processed_at: new Date().toISOString(),\r\n      updated_at: event.updated\r\n    };\r\n\r\n    const { data, error } = await supabase\r\n      .from('google_calendar_events')\r\n      .upsert(eventData, { onConflict: 'event_id,user_id' });\r\n\r\n    if (error) {\r\n      console.error('‚ùå Error guardando evento del calendario:', error);\r\n    } else {\r\n      console.log('‚úÖ Evento del calendario guardado en BD');\r\n    }\r\n  } catch (error) {\r\n    console.error('‚ùå Error guardando evento del calendario:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Formatea fecha del calendario para mensajes\r\n * @param {string} dateTime - Fecha en formato ISO\r\n * @returns {string} Fecha formateada\r\n */\r\nfunction formatCalendarDate(dateTime) {\r\n  const date = new Date(dateTime);\r\n  return date.toLocaleDateString('es-ES', {\r\n    weekday: 'long',\r\n    year: 'numeric',\r\n    month: 'long',\r\n    day: 'numeric',\r\n    hour: '2-digit',\r\n    minute: '2-digit'\r\n  });\r\n}","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\api\\webhook\\google-meet-extensions.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'meetingId' is assigned a value but never used.","line":133,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":133,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'startTime' is assigned a value but never used.","line":133,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":133,"endColumn":54},{"ruleId":"no-unused-vars","severity":1,"message":"'meetingId' is assigned a value but never used.","line":154,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":154,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'meetingId' is assigned a value but never used.","line":176,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":176,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'participantEmail' is assigned a value but never used.","line":176,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":176,"endColumn":57},{"ruleId":"no-unused-vars","severity":1,"message":"'joinTime' is assigned a value but never used.","line":176,"column":59,"nodeType":"Identifier","messageId":"unusedVar","endLine":176,"endColumn":67},{"ruleId":"no-unused-vars","severity":1,"message":"'meetingId' is assigned a value but never used.","line":200,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":200,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'participantEmail' is assigned a value but never used.","line":200,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":200,"endColumn":57},{"ruleId":"no-unused-vars","severity":1,"message":"'leaveTime' is assigned a value but never used.","line":200,"column":59,"nodeType":"Identifier","messageId":"unusedVar","endLine":200,"endColumn":68},{"ruleId":"no-unused-vars","severity":1,"message":"'meetingId' is assigned a value but never used.","line":224,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":224,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'meetingId' is assigned a value but never used.","line":245,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":245,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'meetingId' is assigned a value but never used.","line":269,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":269,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'meetingId' is assigned a value but never used.","line":290,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":290,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'meetingId' is assigned a value but never used.","line":312,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":312,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'timestamp' is assigned a value but never used.","line":312,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":312,"endColumn":54},{"ruleId":"no-unused-vars","severity":1,"message":"'meetingId' is assigned a value but never used.","line":337,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":337,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'timestamp' is assigned a value but never used.","line":337,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":337,"endColumn":50},{"ruleId":"no-unused-vars","severity":1,"message":"'meetingId' is assigned a value but never used.","line":358,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":358,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'meetingId' is assigned a value but never used.","line":380,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":380,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":443,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":443,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":20,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Extensiones avanzadas para Google Meet - Integraci√≥n con WhatsApp\r\n// Procesa eventos espec√≠ficos de Google Meet m√°s all√° del calendario b√°sico\r\n\r\nimport { supabase } from '../../lib/supabase.js';\r\nimport communicationService from '../../services/communicationService.js';\r\n\r\n/**\r\n * Procesa extensiones avanzadas de Google Meet\r\n * @param {Request} req - Request object\r\n * @param {Response} res - Response object\r\n */\r\nexport default async function handler(req, res) {\r\n  // Solo aceptar m√©todos POST\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({\r\n      success: false,\r\n      error: 'M√©todo no permitido. Solo se acepta POST.'\r\n    });\r\n  }\r\n\r\n  try {\r\n    console.log('üé• Extensi√≥n de Google Meet recibida:', {\r\n      headers: req.headers,\r\n      body: req.body,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n\r\n    const extensionData = req.body;\r\n\r\n    // Validar que tenemos los datos necesarios\r\n    if (!extensionData || !extensionData.type) {\r\n      console.error('‚ùå Datos de extensi√≥n inv√°lidos');\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'Datos de extensi√≥n inv√°lidos'\r\n      });\r\n    }\r\n\r\n    // Procesar seg√∫n el tipo de extensi√≥n\r\n    await processGoogleMeetExtension(extensionData);\r\n\r\n    // Respuesta exitosa\r\n    return res.status(200).json({\r\n      success: true,\r\n      message: 'Extensi√≥n procesada correctamente'\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('üí• Error procesando extensi√≥n de Google Meet:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Error interno del servidor',\r\n      details: error.message\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa una extensi√≥n espec√≠fica de Google Meet\r\n * @param {Object} extensionData - Datos de la extensi√≥n\r\n */\r\nasync function processGoogleMeetExtension(extensionData) {\r\n  try {\r\n    const { type, data, userId } = extensionData;\r\n\r\n    console.log('üîÑ Procesando extensi√≥n de Google Meet:', type);\r\n\r\n    switch (type) {\r\n      case 'meeting_started':\r\n        await processMeetingStarted(data, userId);\r\n        break;\r\n\r\n      case 'meeting_ended':\r\n        await processMeetingEnded(data, userId);\r\n        break;\r\n\r\n      case 'participant_joined':\r\n        await processParticipantJoined(data, userId);\r\n        break;\r\n\r\n      case 'participant_left':\r\n        await processParticipantLeft(data, userId);\r\n        break;\r\n\r\n      case 'recording_started':\r\n        await processRecordingStarted(data, userId);\r\n        break;\r\n\r\n      case 'recording_ended':\r\n        await processRecordingEnded(data, userId);\r\n        break;\r\n\r\n      case 'screen_share_started':\r\n        await processScreenShareStarted(data, userId);\r\n        break;\r\n\r\n      case 'screen_share_ended':\r\n        await processScreenShareEnded(data, userId);\r\n        break;\r\n\r\n      case 'chat_message':\r\n        await processChatMessage(data, userId);\r\n        break;\r\n\r\n      case 'hand_raised':\r\n        await processHandRaised(data, userId);\r\n        break;\r\n\r\n      case 'poll_created':\r\n        await processPollCreated(data, userId);\r\n        break;\r\n\r\n      case 'breakout_room_created':\r\n        await processBreakoutRoomCreated(data, userId);\r\n        break;\r\n\r\n      default:\r\n        console.log('‚ö†Ô∏è Tipo de extensi√≥n no manejado:', type);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando extensi√≥n de Google Meet:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando una reuni√≥n de Google Meet comienza\r\n * @param {Object} data - Datos de la reuni√≥n\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processMeetingStarted(data, userId) {\r\n  try {\r\n    const { meetingId, title, participants, startTime } = data;\r\n\r\n    console.log('‚ñ∂Ô∏è Reuni√≥n de Google Meet iniciada:', title);\r\n\r\n    const whatsappMessage = `üöÄ Reuni√≥n de Google Meet iniciada: \"${title}\". ${participants?.length || 0} participantes conectados.`;\r\n\r\n    await sendMeetWhatsAppNotification(userId, whatsappMessage);\r\n    await saveMeetEvent('meeting_started', data, userId, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando reuni√≥n iniciada:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando una reuni√≥n de Google Meet termina\r\n * @param {Object} data - Datos de la reuni√≥n\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processMeetingEnded(data, userId) {\r\n  try {\r\n    const { meetingId, title, duration, participants } = data;\r\n\r\n    console.log('‚èπÔ∏è Reuni√≥n de Google Meet finalizada:', title);\r\n\r\n    const durationText = duration ? `Duraci√≥n: ${Math.round(duration / 60)} minutos.` : '';\r\n    const whatsappMessage = `üèÅ Reuni√≥n de Google Meet finalizada: \"${title}\". ${durationText} ${participants?.length || 0} participantes.`;\r\n\r\n    await sendMeetWhatsAppNotification(userId, whatsappMessage);\r\n    await saveMeetEvent('meeting_ended', data, userId, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando reuni√≥n finalizada:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando un participante se une a la reuni√≥n\r\n * @param {Object} data - Datos del participante\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processParticipantJoined(data, userId) {\r\n  try {\r\n    const { meetingId, participantName, participantEmail, joinTime, totalParticipants } = data;\r\n\r\n    console.log('üë§ Participante se uni√≥ a Google Meet:', participantName);\r\n\r\n    // Solo enviar notificaci√≥n si hay m√°s de 2 participantes (evitar spam)\r\n    if (totalParticipants && totalParticipants > 2) {\r\n      const whatsappMessage = `üëã ${participantName} se uni√≥ a la reuni√≥n de Google Meet. Total participantes: ${totalParticipants}`;\r\n\r\n      await sendMeetWhatsAppNotification(userId, whatsappMessage);\r\n      await saveMeetEvent('participant_joined', data, userId, whatsappMessage);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando participante unido:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando un participante sale de la reuni√≥n\r\n * @param {Object} data - Datos del participante\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processParticipantLeft(data, userId) {\r\n  try {\r\n    const { meetingId, participantName, participantEmail, leaveTime, totalParticipants } = data;\r\n\r\n    console.log('üëã Participante sali√≥ de Google Meet:', participantName);\r\n\r\n    // Solo enviar notificaci√≥n para salidas importantes o si quedan pocos participantes\r\n    if (totalParticipants && totalParticipants <= 3) {\r\n      const whatsappMessage = `üëã ${participantName} sali√≥ de la reuni√≥n de Google Meet. Quedan ${totalParticipants} participantes.`;\r\n\r\n      await sendMeetWhatsAppNotification(userId, whatsappMessage);\r\n      await saveMeetEvent('participant_left', data, userId, whatsappMessage);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando participante salido:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando comienza una grabaci√≥n\r\n * @param {Object} data - Datos de la grabaci√≥n\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processRecordingStarted(data, userId) {\r\n  try {\r\n    const { meetingId, title, startedBy } = data;\r\n\r\n    console.log('üé¨ Grabaci√≥n iniciada en Google Meet:', title);\r\n\r\n    const whatsappMessage = `üé¨ Grabaci√≥n iniciada en reuni√≥n: \"${title}\". Iniciada por: ${startedBy || 'Sistema'}`;\r\n\r\n    await sendMeetWhatsAppNotification(userId, whatsappMessage);\r\n    await saveMeetEvent('recording_started', data, userId, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando grabaci√≥n iniciada:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando termina una grabaci√≥n\r\n * @param {Object} data - Datos de la grabaci√≥n\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processRecordingEnded(data, userId) {\r\n  try {\r\n    const { meetingId, title, duration, downloadUrl } = data;\r\n\r\n    console.log('üé¨ Grabaci√≥n finalizada en Google Meet:', title);\r\n\r\n    const durationText = duration ? `Duraci√≥n: ${Math.round(duration / 60)} minutos.` : '';\r\n    const urlText = downloadUrl ? ` Enlace de descarga disponible.` : '';\r\n\r\n    const whatsappMessage = `üé¨ Grabaci√≥n finalizada: \"${title}\". ${durationText}${urlText}`;\r\n\r\n    await sendMeetWhatsAppNotification(userId, whatsappMessage);\r\n    await saveMeetEvent('recording_ended', data, userId, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando grabaci√≥n finalizada:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando alguien comparte pantalla\r\n * @param {Object} data - Datos del compartir pantalla\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processScreenShareStarted(data, userId) {\r\n  try {\r\n    const { meetingId, participantName, shareType } = data;\r\n\r\n    console.log('üñ•Ô∏è Compartir pantalla iniciado:', participantName);\r\n\r\n    const whatsappMessage = `üñ•Ô∏è ${participantName} comenz√≥ a compartir pantalla (${shareType || 'pantalla completa'})`;\r\n\r\n    await sendMeetWhatsAppNotification(userId, whatsappMessage);\r\n    await saveMeetEvent('screen_share_started', data, userId, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando compartir pantalla iniciado:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando termina el compartir pantalla\r\n * @param {Object} data - Datos del compartir pantalla\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processScreenShareEnded(data, userId) {\r\n  try {\r\n    const { meetingId, participantName, duration } = data;\r\n\r\n    console.log('üñ•Ô∏è Compartir pantalla finalizado:', participantName);\r\n\r\n    const durationText = duration ? ` despu√©s de ${Math.round(duration / 60)} minutos` : '';\r\n    const whatsappMessage = `üñ•Ô∏è ${participantName} dej√≥ de compartir pantalla${durationText}`;\r\n\r\n    await sendMeetWhatsAppNotification(userId, whatsappMessage);\r\n    await saveMeetEvent('screen_share_ended', data, userId, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando compartir pantalla finalizado:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa mensajes del chat de Google Meet\r\n * @param {Object} data - Datos del mensaje\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processChatMessage(data, userId) {\r\n  try {\r\n    const { meetingId, senderName, message, timestamp, isPrivate } = data;\r\n\r\n    console.log('üí¨ Mensaje en chat de Google Meet:', senderName, message?.substring(0, 50));\r\n\r\n    // Solo procesar mensajes importantes o menciones\r\n    if (message && (message.includes('@') || message.length > 100 || isPrivate)) {\r\n      const privateText = isPrivate ? ' (privado)' : '';\r\n      const whatsappMessage = `üí¨ Chat de Google Meet${privateText}: ${senderName}: \"${message?.substring(0, 200)}${message?.length > 200 ? '...' : ''}\"`;\r\n\r\n      await sendMeetWhatsAppNotification(userId, whatsappMessage);\r\n      await saveMeetEvent('chat_message', data, userId, whatsappMessage);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando mensaje de chat:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando alguien levanta la mano\r\n * @param {Object} data - Datos de la mano levantada\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processHandRaised(data, userId) {\r\n  try {\r\n    const { meetingId, participantName, timestamp } = data;\r\n\r\n    console.log('‚úã Mano levantada en Google Meet:', participantName);\r\n\r\n    const whatsappMessage = `‚úã ${participantName} levant√≥ la mano en la reuni√≥n`;\r\n\r\n    await sendMeetWhatsAppNotification(userId, whatsappMessage);\r\n    await saveMeetEvent('hand_raised', data, userId, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando mano levantada:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando se crea una encuesta\r\n * @param {Object} data - Datos de la encuesta\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processPollCreated(data, userId) {\r\n  try {\r\n    const { meetingId, title, options, createdBy } = data;\r\n\r\n    console.log('üìä Encuesta creada en Google Meet:', title);\r\n\r\n    const optionsText = options?.length ? ` (${options.length} opciones)` : '';\r\n    const whatsappMessage = `üìä Nueva encuesta en reuni√≥n: \"${title}\"${optionsText}. Creada por: ${createdBy || 'Sistema'}`;\r\n\r\n    await sendMeetWhatsAppNotification(userId, whatsappMessage);\r\n    await saveMeetEvent('poll_created', data, userId, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando encuesta creada:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando se crean salas de breakout\r\n * @param {Object} data - Datos de las salas\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processBreakoutRoomCreated(data, userId) {\r\n  try {\r\n    const { meetingId, roomCount, assignmentType } = data;\r\n\r\n    console.log('üè¢ Salas de breakout creadas:', roomCount);\r\n\r\n    const assignmentText = assignmentType === 'auto' ? 'asignaci√≥n autom√°tica' : 'asignaci√≥n manual';\r\n    const whatsappMessage = `üè¢ Se crearon ${roomCount} salas de breakout con ${assignmentText}`;\r\n\r\n    await sendMeetWhatsAppNotification(userId, whatsappMessage);\r\n    await saveMeetEvent('breakout_room_created', data, userId, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando salas de breakout:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Env√≠a notificaci√≥n por WhatsApp para extensiones de Google Meet\r\n * @param {string} userId - ID del usuario\r\n * @param {string} message - Mensaje a enviar\r\n */\r\nasync function sendMeetWhatsAppNotification(userId, message) {\r\n  try {\r\n    // Obtener empleados asociados al usuario\r\n    const { data: employees } = await supabase\r\n      .from('employees')\r\n      .select('id')\r\n      .eq('user_id', userId)\r\n      .limit(10);\r\n\r\n    if (!employees || employees.length === 0) {\r\n      console.error('‚ùå No se encontraron empleados para enviar WhatsApp');\r\n      return;\r\n    }\r\n\r\n    const recipientIds = employees.map(emp => emp.id);\r\n\r\n    // Enviar mensaje usando el servicio de comunicaci√≥n\r\n    await communicationService.sendWhatsAppMessage(recipientIds, message);\r\n\r\n    console.log('‚úÖ Mensaje de WhatsApp enviado para extensi√≥n de Google Meet:', message);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error enviando mensaje de WhatsApp para extensi√≥n de Google Meet:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Guarda el evento de extensi√≥n de Google Meet en la base de datos\r\n * @param {string} eventType - Tipo de evento\r\n * @param {Object} eventData - Datos del evento\r\n * @param {string} userId - ID del usuario\r\n * @param {string} whatsappMessage - Mensaje enviado por WhatsApp\r\n */\r\nasync function saveMeetEvent(eventType, eventData, userId, whatsappMessage) {\r\n  try {\r\n    const meetEventData = {\r\n      event_type: eventType,\r\n      user_id: userId,\r\n      event_data: eventData,\r\n      whatsapp_message: whatsappMessage,\r\n      processed_at: new Date().toISOString()\r\n    };\r\n\r\n    const { data, error } = await supabase\r\n      .from('google_meet_extensions')\r\n      .insert(meetEventData);\r\n\r\n    if (error) {\r\n      console.error('‚ùå Error guardando extensi√≥n de Google Meet:', error);\r\n    } else {\r\n      console.log('‚úÖ Extensi√≥n de Google Meet guardada en BD');\r\n    }\r\n  } catch (error) {\r\n    console.error('‚ùå Error guardando extensi√≥n de Google Meet:', error);\r\n  }\r\n}","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\api\\webhook\\google-meet-realtime.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'startTime' is assigned a value but never used.","line":119,"column":50,"nodeType":"Identifier","messageId":"unusedVar","endLine":119,"endColumn":59},{"ruleId":"no-unused-vars","severity":1,"message":"'previousSpeaker' is assigned a value but never used.","line":184,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":184,"endColumn":50},{"ruleId":"no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":335,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":335,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Sistema de detecci√≥n en tiempo real para Google Meet\r\n// Monitorea eventos de reuniones activas y env√≠a notificaciones a WhatsApp\r\n\r\nimport { supabase } from '../../lib/supabase.js';\r\nimport communicationService from '../../services/communicationService.js';\r\n\r\n/**\r\n * Procesa eventos en tiempo real de Google Meet\r\n * @param {Request} req - Request object\r\n * @param {Response} res - Response object\r\n */\r\nexport default async function handler(req, res) {\r\n  // Solo aceptar m√©todos POST\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({\r\n      success: false,\r\n      error: 'M√©todo no permitido. Solo se acepta POST.'\r\n    });\r\n  }\r\n\r\n  try {\r\n    console.log('‚ö° Evento en tiempo real de Google Meet:', {\r\n      headers: req.headers,\r\n      body: req.body,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n\r\n    const realtimeData = req.body;\r\n\r\n    // Validar que tenemos los datos necesarios\r\n    if (!realtimeData || !realtimeData.eventType) {\r\n      console.error('‚ùå Datos de tiempo real inv√°lidos');\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'Datos de tiempo real inv√°lidos'\r\n      });\r\n    }\r\n\r\n    // Procesar evento en tiempo real\r\n    await processRealtimeEvent(realtimeData);\r\n\r\n    // Respuesta exitosa\r\n    return res.status(200).json({\r\n      success: true,\r\n      message: 'Evento en tiempo real procesado correctamente'\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('üí• Error procesando evento en tiempo real de Google Meet:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Error interno del servidor',\r\n      details: error.message\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa un evento en tiempo real de Google Meet\r\n * @param {Object} eventData - Datos del evento\r\n */\r\nasync function processRealtimeEvent(eventData) {\r\n  try {\r\n    const { eventType, meetingData, userId, timestamp } = eventData;\r\n\r\n    console.log('üîÑ Procesando evento en tiempo real:', eventType);\r\n\r\n    // Verificar si el evento es reciente (√∫ltimos 30 segundos)\r\n    const eventTime = new Date(timestamp);\r\n    const now = new Date();\r\n    const timeDiff = now - eventTime;\r\n\r\n    if (timeDiff > 30000) { // 30 segundos\r\n      console.log('‚ö†Ô∏è Evento muy antiguo, ignorando');\r\n      return;\r\n    }\r\n\r\n    switch (eventType) {\r\n      case 'meeting_detected':\r\n        await processMeetingDetected(meetingData, userId);\r\n        break;\r\n\r\n      case 'participant_count_changed':\r\n        await processParticipantCountChanged(meetingData, userId);\r\n        break;\r\n\r\n      case 'active_speaker_changed':\r\n        await processActiveSpeakerChanged(meetingData, userId);\r\n        break;\r\n\r\n      case 'meeting_quality_issue':\r\n        await processMeetingQualityIssue(meetingData, userId);\r\n        break;\r\n\r\n      case 'meeting_idle_detected':\r\n        await processMeetingIdleDetected(meetingData, userId);\r\n        break;\r\n\r\n      case 'meeting_ending_soon':\r\n        await processMeetingEndingSoon(meetingData, userId);\r\n        break;\r\n\r\n      default:\r\n        console.log('‚ö†Ô∏è Tipo de evento en tiempo real no manejado:', eventType);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando evento en tiempo real:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando se detecta una reuni√≥n activa\r\n * @param {Object} meetingData - Datos de la reuni√≥n\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processMeetingDetected(meetingData, userId) {\r\n  try {\r\n    const { title, participantCount, meetingUrl, startTime } = meetingData;\r\n\r\n    console.log('üîç Reuni√≥n activa detectada:', title);\r\n\r\n    // Verificar si ya notificamos esta reuni√≥n recientemente\r\n    const { data: recentNotification } = await supabase\r\n      .from('google_meet_realtime_events')\r\n      .select('id')\r\n      .eq('user_id', userId)\r\n      .eq('event_type', 'meeting_detected')\r\n      .eq('meeting_url', meetingUrl)\r\n      .gte('created_at', new Date(Date.now() - 5 * 60 * 1000).toISOString()) // √öltimos 5 minutos\r\n      .single();\r\n\r\n    if (recentNotification) {\r\n      console.log('‚ö†Ô∏è Reuni√≥n ya notificada recientemente');\r\n      return;\r\n    }\r\n\r\n    const whatsappMessage = `üîç Reuni√≥n activa detectada: \"${title}\". ${participantCount} participantes. URL: ${meetingUrl}`;\r\n\r\n    await sendRealtimeWhatsAppNotification(userId, whatsappMessage);\r\n    await saveRealtimeEvent('meeting_detected', meetingData, userId, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando reuni√≥n detectada:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cambios en el conteo de participantes\r\n * @param {Object} meetingData - Datos de la reuni√≥n\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processParticipantCountChanged(meetingData, userId) {\r\n  try {\r\n    const { title, participantCount, changeType, participantName } = meetingData;\r\n\r\n    console.log('üë• Cambio en participantes:', changeType, participantName);\r\n\r\n    let whatsappMessage = '';\r\n\r\n    if (changeType === 'joined') {\r\n      whatsappMessage = `‚ûï ${participantName} se uni√≥ a: \"${title}\". Total: ${participantCount} participantes`;\r\n    } else if (changeType === 'left') {\r\n      whatsappMessage = `‚ûñ ${participantName} sali√≥ de: \"${title}\". Total: ${participantCount} participantes`;\r\n    }\r\n\r\n    if (whatsappMessage && participantCount <= 5) { // Solo notificar en reuniones peque√±as\r\n      await sendRealtimeWhatsAppNotification(userId, whatsappMessage);\r\n      await saveRealtimeEvent('participant_count_changed', meetingData, userId, whatsappMessage);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando cambio de participantes:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cambios en el orador activo\r\n * @param {Object} meetingData - Datos de la reuni√≥n\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processActiveSpeakerChanged(meetingData, userId) {\r\n  try {\r\n    const { title, activeSpeaker, previousSpeaker } = meetingData;\r\n\r\n    console.log('üé§ Orador activo cambi√≥:', activeSpeaker);\r\n\r\n    // Solo notificar cambios importantes o en reuniones peque√±as\r\n    const { data: meetingInfo } = await supabase\r\n      .from('google_meet_realtime_events')\r\n      .select('event_data')\r\n      .eq('user_id', userId)\r\n      .eq('event_type', 'meeting_detected')\r\n      .order('created_at', { ascending: false })\r\n      .limit(1)\r\n      .single();\r\n\r\n    if (meetingInfo?.event_data?.participantCount <= 10) {\r\n      const whatsappMessage = `üé§ Ahora habla: ${activeSpeaker} en \"${title}\"`;\r\n\r\n      await sendRealtimeWhatsAppNotification(userId, whatsappMessage);\r\n      await saveRealtimeEvent('active_speaker_changed', meetingData, userId, whatsappMessage);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando cambio de orador:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa problemas de calidad en la reuni√≥n\r\n * @param {Object} meetingData - Datos de la reuni√≥n\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processMeetingQualityIssue(meetingData, userId) {\r\n  try {\r\n    const { title, issueType, severity } = meetingData;\r\n\r\n    console.log('‚ö†Ô∏è Problema de calidad detectado:', issueType, severity);\r\n\r\n    if (severity === 'high') {\r\n      const issueMessages = {\r\n        'audio': 'problemas de audio',\r\n        'video': 'problemas de video',\r\n        'connection': 'problemas de conexi√≥n',\r\n        'bandwidth': 'ancho de banda limitado'\r\n      };\r\n\r\n      const issueText = issueMessages[issueType] || 'problemas t√©cnicos';\r\n      const whatsappMessage = `‚ö†Ô∏è ¬°Atenci√≥n! ${issueText} detectados en reuni√≥n: \"${title}\". Verifica tu conexi√≥n.`;\r\n\r\n      await sendRealtimeWhatsAppNotification(userId, whatsappMessage);\r\n      await saveRealtimeEvent('meeting_quality_issue', meetingData, userId, whatsappMessage);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando problema de calidad:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando se detecta inactividad en la reuni√≥n\r\n * @param {Object} meetingData - Datos de la reuni√≥n\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processMeetingIdleDetected(meetingData, userId) {\r\n  try {\r\n    const { title, idleTime, participantCount } = meetingData;\r\n\r\n    console.log('üò¥ Inactividad detectada:', idleTime, 'minutos');\r\n\r\n    if (idleTime >= 10 && participantCount > 1) { // Solo notificar si hay otros participantes\r\n      const whatsappMessage = `üò¥ La reuni√≥n \"${title}\" ha estado inactiva por ${idleTime} minutos. ¬øContinuar o finalizar?`;\r\n\r\n      await sendRealtimeWhatsAppNotification(userId, whatsappMessage);\r\n      await saveRealtimeEvent('meeting_idle_detected', meetingData, userId, whatsappMessage);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando inactividad:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando la reuni√≥n est√° por terminar\r\n * @param {Object} meetingData - Datos de la reuni√≥n\r\n * @param {string} userId - ID del usuario\r\n */\r\nasync function processMeetingEndingSoon(meetingData, userId) {\r\n  try {\r\n    const { title, timeRemaining, autoEnd } = meetingData;\r\n\r\n    console.log('‚è∞ Reuni√≥n terminando pronto:', timeRemaining, 'minutos');\r\n\r\n    const autoEndText = autoEnd ? ' (se cerrar√° autom√°ticamente)' : '';\r\n    const whatsappMessage = `‚è∞ La reuni√≥n \"${title}\" terminar√° en ${timeRemaining} minutos${autoEndText}. Prepara conclusiones.`;\r\n\r\n    await sendRealtimeWhatsAppNotification(userId, whatsappMessage);\r\n    await saveRealtimeEvent('meeting_ending_soon', meetingData, userId, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando reuni√≥n terminando:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Env√≠a notificaci√≥n por WhatsApp para eventos en tiempo real\r\n * @param {string} userId - ID del usuario\r\n * @param {string} message - Mensaje a enviar\r\n */\r\nasync function sendRealtimeWhatsAppNotification(userId, message) {\r\n  try {\r\n    // Obtener empleados asociados al usuario\r\n    const { data: employees } = await supabase\r\n      .from('employees')\r\n      .select('id')\r\n      .eq('user_id', userId)\r\n      .limit(5); // Menos empleados para notificaciones en tiempo real\r\n\r\n    if (!employees || employees.length === 0) {\r\n      console.error('‚ùå No se encontraron empleados para enviar WhatsApp');\r\n      return;\r\n    }\r\n\r\n    const recipientIds = employees.map(emp => emp.id);\r\n\r\n    // Enviar mensaje usando el servicio de comunicaci√≥n\r\n    await communicationService.sendWhatsAppMessage(recipientIds, message);\r\n\r\n    console.log('‚úÖ Mensaje de WhatsApp enviado para evento en tiempo real:', message);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error enviando mensaje de WhatsApp para evento en tiempo real:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Guarda el evento en tiempo real en la base de datos\r\n * @param {string} eventType - Tipo de evento\r\n * @param {Object} eventData - Datos del evento\r\n * @param {string} userId - ID del usuario\r\n * @param {string} whatsappMessage - Mensaje enviado por WhatsApp\r\n */\r\nasync function saveRealtimeEvent(eventType, eventData, userId, whatsappMessage) {\r\n  try {\r\n    const realtimeEventData = {\r\n      event_type: eventType,\r\n      user_id: userId,\r\n      event_data: eventData,\r\n      meeting_url: eventData.meetingUrl,\r\n      whatsapp_message: whatsappMessage,\r\n      created_at: new Date().toISOString()\r\n    };\r\n\r\n    const { data, error } = await supabase\r\n      .from('google_meet_realtime_events')\r\n      .insert(realtimeEventData);\r\n\r\n    if (error) {\r\n      console.error('‚ùå Error guardando evento en tiempo real:', error);\r\n    } else {\r\n      console.log('‚úÖ Evento en tiempo real guardado en BD');\r\n    }\r\n  } catch (error) {\r\n    console.error('‚ùå Error guardando evento en tiempo real:', error);\r\n  }\r\n}","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\api\\webhook\\microsoft365-notifications.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'changeType' is assigned a value but never used.","line":76,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":76,"endColumn":49},{"ruleId":"no-unused-vars","severity":1,"message":"'clientState' is assigned a value but never used.","line":76,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":76,"endColumn":62},{"ruleId":"no-useless-escape","severity":1,"message":"Unnecessary escape character: \\/.","line":123,"column":53,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":123,"endColumn":54,"suggestions":[{"messageId":"removeEscape","fix":{"range":[4038,4039],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[4038,4038],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":1,"message":"Unnecessary escape character: \\/.","line":201,"column":57,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":201,"endColumn":58,"suggestions":[{"messageId":"removeEscape","fix":{"range":[7075,7076],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[7075,7075],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":389,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":389,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Endpoint API para recibir notificaciones de Microsoft 365 (Microsoft Graph)\r\n// Procesa notificaciones de calendario y env√≠a mensajes a WhatsApp\r\n\r\nimport { supabase } from '../../lib/supabase.js';\r\nimport communicationService from '../../services/communicationService.js';\r\n\r\n/**\r\n * Procesa notificaciones de Microsoft 365 recibidas desde Microsoft Graph\r\n * @param {Request} req - Request object\r\n * @param {Response} res - Response object\r\n */\r\nexport default async function handler(req, res) {\r\n  // Solo aceptar m√©todos POST\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({\r\n      success: false,\r\n      error: 'M√©todo no permitido. Solo se acepta POST.'\r\n    });\r\n  }\r\n\r\n  try {\r\n    console.log('üìÖ Webhook recibido desde Microsoft 365:', {\r\n      headers: req.headers,\r\n      body: req.body,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n\r\n    const webhookData = req.body;\r\n\r\n    // Validar que tenemos los datos necesarios\r\n    if (!webhookData) {\r\n      console.error('‚ùå Datos de webhook inv√°lidos');\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'Datos de webhook inv√°lidos'\r\n      });\r\n    }\r\n\r\n    // Procesar diferentes tipos de notificaciones de Microsoft 365\r\n    if (webhookData.value && Array.isArray(webhookData.value)) {\r\n      // Notificaci√≥n de cambios en recursos (change notifications)\r\n      for (const notification of webhookData.value) {\r\n        await processMicrosoft365Notification(notification);\r\n      }\r\n    } else if (webhookData.lifecycleEvent) {\r\n      // Evento de lifecycle (subscription validation, etc.)\r\n      await processLifecycleEvent(webhookData);\r\n    } else {\r\n      console.log('‚ö†Ô∏è Tipo de notificaci√≥n no reconocido');\r\n    }\r\n\r\n    // Respuesta exitosa\r\n    return res.status(200).json({\r\n      success: true,\r\n      message: 'Notificaci√≥n procesada correctamente'\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('üí• Error procesando webhook de Microsoft 365:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Error interno del servidor',\r\n      details: error.message\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa una notificaci√≥n individual de Microsoft 365\r\n * @param {Object} notification - Notificaci√≥n de Microsoft Graph\r\n */\r\nasync function processMicrosoft365Notification(notification) {\r\n  try {\r\n    console.log('üîÑ Procesando notificaci√≥n de Microsoft 365:', notification);\r\n\r\n    const { subscriptionId, resource, changeType, clientState } = notification;\r\n\r\n    // Verificar que la notificaci√≥n es v√°lida\r\n    if (!subscriptionId || !resource) {\r\n      console.error('‚ùå Notificaci√≥n inv√°lida: faltan campos requeridos');\r\n      return;\r\n    }\r\n\r\n    // Buscar la suscripci√≥n en la base de datos\r\n    const { data: subscription, error: subError } = await supabase\r\n      .from('microsoft365_subscriptions')\r\n      .select('id, user_id, resource_type')\r\n      .eq('subscription_id', subscriptionId)\r\n      .eq('is_active', true)\r\n      .single();\r\n\r\n    if (subError || !subscription) {\r\n      console.error('‚ùå Suscripci√≥n no encontrada:', subError);\r\n      return;\r\n    }\r\n\r\n    console.log('‚úÖ Suscripci√≥n encontrada:', subscription);\r\n\r\n    // Procesar seg√∫n el tipo de recurso\r\n    if (resource.includes('/events')) {\r\n      await processCalendarEvent(notification, subscription);\r\n    } else if (resource.includes('/messages')) {\r\n      await processEmailMessage(notification, subscription);\r\n    } else {\r\n      console.log('‚ö†Ô∏è Tipo de recurso no manejado:', resource);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando notificaci√≥n individual:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa eventos de calendario\r\n * @param {Object} notification - Notificaci√≥n del evento\r\n * @param {Object} subscription - Datos de la suscripci√≥n\r\n */\r\nasync function processCalendarEvent(notification, subscription) {\r\n  try {\r\n    const { resource, changeType } = notification;\r\n\r\n    // Extraer el ID del evento de la URL del recurso\r\n    const eventIdMatch = resource.match(/events\\/([^\\/]+)/);\r\n    if (!eventIdMatch) {\r\n      console.error('‚ùå No se pudo extraer el ID del evento');\r\n      return;\r\n    }\r\n\r\n    const eventId = eventIdMatch[1];\r\n    console.log('üìÖ Procesando evento de calendario:', eventId, 'Tipo de cambio:', changeType);\r\n\r\n    // Obtener detalles del evento desde Microsoft Graph\r\n    const eventDetails = await getCalendarEventDetails(eventId, subscription.user_id);\r\n\r\n    if (!eventDetails) {\r\n      console.error('‚ùå No se pudieron obtener detalles del evento');\r\n      return;\r\n    }\r\n\r\n    // Generar mensaje de WhatsApp seg√∫n el tipo de cambio\r\n    let whatsappMessage = '';\r\n\r\n    switch (changeType) {\r\n      case 'created':\r\n        // Nueva reuni√≥n programada\r\n        whatsappMessage = `Nueva reuni√≥n programada: \"${eventDetails.subject}\" el ${formatDate(eventDetails.start.dateTime)} a las ${formatTime(eventDetails.start.dateTime)}`;\r\n        break;\r\n\r\n      case 'updated':\r\n        // Reuni√≥n reprogramada o actualizada\r\n        if (eventDetails.subject.includes('reprogram') || eventDetails.subject.includes('cambi')) {\r\n          whatsappMessage = `Se reprogram√≥ la reuni√≥n: \"${eventDetails.subject}\" para el ${formatDate(eventDetails.start.dateTime)} a las ${formatTime(eventDetails.start.dateTime)}`;\r\n        } else {\r\n          whatsappMessage = `Actualizaci√≥n en reuni√≥n: \"${eventDetails.subject}\" el ${formatDate(eventDetails.start.dateTime)} a las ${formatTime(eventDetails.start.dateTime)}`;\r\n        }\r\n        break;\r\n\r\n      case 'deleted':\r\n        // Reuni√≥n cancelada\r\n        whatsappMessage = `Reuni√≥n cancelada: \"${eventDetails.subject || 'Sin t√≠tulo'}\"`;\r\n        break;\r\n\r\n      default:\r\n        console.log('‚ö†Ô∏è Tipo de cambio no manejado:', changeType);\r\n        return;\r\n    }\r\n\r\n    // Enviar recordatorio si es una reuni√≥n pr√≥xima (menos de 15 minutos)\r\n    if (changeType === 'created' || changeType === 'updated') {\r\n      const eventTime = new Date(eventDetails.start.dateTime);\r\n      const now = new Date();\r\n      const timeDiff = eventTime - now;\r\n      const minutesDiff = timeDiff / (1000 * 60);\r\n\r\n      if (minutesDiff > 0 && minutesDiff <= 15) {\r\n        whatsappMessage = `Tienes una reuni√≥n en ${Math.round(minutesDiff)} minutos: \"${eventDetails.subject}\"`;\r\n      }\r\n    }\r\n\r\n    // Enviar mensaje a WhatsApp\r\n    await sendWhatsAppNotification(subscription.user_id, whatsappMessage);\r\n\r\n    // Guardar la notificaci√≥n en la base de datos\r\n    await saveMicrosoft365Notification(notification, subscription, eventDetails, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando evento de calendario:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa mensajes de email\r\n * @param {Object} notification - Notificaci√≥n del mensaje\r\n * @param {Object} subscription - Datos de la suscripci√≥n\r\n */\r\nasync function processEmailMessage(notification, subscription) {\r\n  try {\r\n    const { resource, changeType } = notification;\r\n\r\n    // Extraer el ID del mensaje de la URL del recurso\r\n    const messageIdMatch = resource.match(/messages\\/([^\\/]+)/);\r\n    if (!messageIdMatch) {\r\n      console.error('‚ùå No se pudo extraer el ID del mensaje');\r\n      return;\r\n    }\r\n\r\n    const messageId = messageIdMatch[1];\r\n    console.log('üìß Procesando mensaje de email:', messageId, 'Tipo de cambio:', changeType);\r\n\r\n    // Obtener detalles del mensaje desde Microsoft Graph\r\n    const messageDetails = await getEmailMessageDetails(messageId, subscription.user_id);\r\n\r\n    if (!messageDetails) {\r\n      console.error('‚ùå No se pudieron obtener detalles del mensaje');\r\n      return;\r\n    }\r\n\r\n    // Procesar archivos adjuntos si existen\r\n    if (messageDetails.hasAttachments && messageDetails.attachments) {\r\n      for (const attachment of messageDetails.attachments) {\r\n        if (attachment['@odata.type'] === '#microsoft.graph.fileAttachment') {\r\n          const fileMessage = `Archivo compartido en OneDrive: ${attachment.name} - ${attachment.webUrl || 'Enlace no disponible'}`;\r\n          await sendWhatsAppNotification(subscription.user_id, fileMessage);\r\n        }\r\n      }\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando mensaje de email:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Obtiene detalles del evento de calendario desde Microsoft Graph\r\n * @param {string} eventId - ID del evento\r\n * @param {string} userId - ID del usuario\r\n * @returns {Object|null} Detalles del evento\r\n */\r\nasync function getCalendarEventDetails(eventId, userId) {\r\n  try {\r\n    // Obtener credenciales del usuario\r\n    const { data: credentials, error } = await supabase\r\n      .from('user_credentials')\r\n      .select('microsoft_access_token')\r\n      .eq('user_id', userId)\r\n      .single();\r\n\r\n    if (error || !credentials?.microsoft_access_token) {\r\n      console.error('‚ùå No se encontraron credenciales de Microsoft para el usuario');\r\n      return null;\r\n    }\r\n\r\n    // Hacer petici√≥n a Microsoft Graph API\r\n    const response = await fetch(\r\n      `https://graph.microsoft.com/v1.0/me/events/${eventId}`,\r\n      {\r\n        headers: {\r\n          'Authorization': `Bearer ${credentials.microsoft_access_token}`,\r\n          'Content-Type': 'application/json'\r\n        }\r\n      }\r\n    );\r\n\r\n    if (!response.ok) {\r\n      console.error('‚ùå Error obteniendo detalles del evento:', response.status);\r\n      return null;\r\n    }\r\n\r\n    const eventData = await response.json();\r\n    console.log('‚úÖ Detalles del evento obtenidos:', eventData.subject);\r\n\r\n    return eventData;\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error obteniendo detalles del evento:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Obtiene detalles del mensaje de email desde Microsoft Graph\r\n * @param {string} messageId - ID del mensaje\r\n * @param {string} userId - ID del usuario\r\n * @returns {Object|null} Detalles del mensaje\r\n */\r\nasync function getEmailMessageDetails(messageId, userId) {\r\n  try {\r\n    // Obtener credenciales del usuario\r\n    const { data: credentials, error } = await supabase\r\n      .from('user_credentials')\r\n      .select('microsoft_access_token')\r\n      .eq('user_id', userId)\r\n      .single();\r\n\r\n    if (error || !credentials?.microsoft_access_token) {\r\n      console.error('‚ùå No se encontraron credenciales de Microsoft para el usuario');\r\n      return null;\r\n    }\r\n\r\n    // Hacer petici√≥n a Microsoft Graph API\r\n    const response = await fetch(\r\n      `https://graph.microsoft.com/v1.0/me/messages/${messageId}?$expand=attachments`,\r\n      {\r\n        headers: {\r\n          'Authorization': `Bearer ${credentials.microsoft_access_token}`,\r\n          'Content-Type': 'application/json'\r\n        }\r\n      }\r\n    );\r\n\r\n    if (!response.ok) {\r\n      console.error('‚ùå Error obteniendo detalles del mensaje:', response.status);\r\n      return null;\r\n    }\r\n\r\n    const messageData = await response.json();\r\n    console.log('‚úÖ Detalles del mensaje obtenidos:', messageData.subject);\r\n\r\n    return messageData;\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error obteniendo detalles del mensaje:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Env√≠a notificaci√≥n por WhatsApp\r\n * @param {string} userId - ID del usuario\r\n * @param {string} message - Mensaje a enviar\r\n */\r\nasync function sendWhatsAppNotification(userId, message) {\r\n  try {\r\n    // Obtener empleados asociados al usuario\r\n    const { data: employees, error } = await supabase\r\n      .from('employees')\r\n      .select('id')\r\n      .eq('user_id', userId)\r\n      .limit(10); // Limitar para evitar spam\r\n\r\n    if (error || !employees || employees.length === 0) {\r\n      console.error('‚ùå No se encontraron empleados para enviar WhatsApp');\r\n      return;\r\n    }\r\n\r\n    const recipientIds = employees.map(emp => emp.id);\r\n\r\n    // Enviar mensaje usando el servicio de comunicaci√≥n\r\n    await communicationService.sendWhatsAppMessage(recipientIds, message);\r\n\r\n    console.log('‚úÖ Mensaje de WhatsApp enviado:', message);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error enviando mensaje de WhatsApp:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa eventos de lifecycle de la suscripci√≥n\r\n * @param {Object} lifecycleEvent - Evento de lifecycle\r\n */\r\nasync function processLifecycleEvent(lifecycleEvent) {\r\n  console.log('üîÑ Procesando evento de lifecycle:', lifecycleEvent.lifecycleEvent);\r\n\r\n  if (lifecycleEvent.lifecycleEvent === 'subscriptionRemoved') {\r\n    // Marcar suscripci√≥n como inactiva\r\n    const { error } = await supabase\r\n      .from('microsoft365_subscriptions')\r\n      .update({ is_active: false })\r\n      .eq('subscription_id', lifecycleEvent.subscriptionId);\r\n\r\n    if (error) {\r\n      console.error('‚ùå Error actualizando suscripci√≥n:', error);\r\n    } else {\r\n      console.log('‚úÖ Suscripci√≥n marcada como inactiva');\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Guarda la notificaci√≥n en la base de datos\r\n * @param {Object} notification - Notificaci√≥n original\r\n * @param {Object} subscription - Datos de la suscripci√≥n\r\n * @param {Object} eventDetails - Detalles del evento\r\n * @param {string} whatsappMessage - Mensaje enviado por WhatsApp\r\n */\r\nasync function saveMicrosoft365Notification(notification, subscription, eventDetails, whatsappMessage) {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from('microsoft365_notifications')\r\n      .insert({\r\n        subscription_id: subscription.id,\r\n        user_id: subscription.user_id,\r\n        notification_data: notification,\r\n        event_details: eventDetails,\r\n        whatsapp_message: whatsappMessage,\r\n        processed_at: new Date().toISOString()\r\n      });\r\n\r\n    if (error) {\r\n      console.error('‚ùå Error guardando notificaci√≥n:', error);\r\n    } else {\r\n      console.log('‚úÖ Notificaci√≥n guardada en BD');\r\n    }\r\n  } catch (error) {\r\n    console.error('‚ùå Error guardando notificaci√≥n:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Formatea fecha para mensajes\r\n * @param {string} dateTime - Fecha en formato ISO\r\n * @returns {string} Fecha formateada\r\n */\r\nfunction formatDate(dateTime) {\r\n  const date = new Date(dateTime);\r\n  return date.toLocaleDateString('es-ES', {\r\n    weekday: 'long',\r\n    year: 'numeric',\r\n    month: 'long',\r\n    day: 'numeric'\r\n  });\r\n}\r\n\r\n/**\r\n * Formatea hora para mensajes\r\n * @param {string} dateTime - Fecha en formato ISO\r\n * @returns {string} Hora formateada\r\n */\r\nfunction formatTime(dateTime) {\r\n  const date = new Date(dateTime);\r\n  return date.toLocaleTimeString('es-ES', {\r\n    hour: '2-digit',\r\n    minute: '2-digit'\r\n  });\r\n}","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\api\\webhook\\telegram-notifications.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\api\\webhook\\whatsapp-notifications.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'recipient' is assigned a value but never used.","line":74,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":74,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Endpoint API para recibir notificaciones de WhatsApp\r\n// Procesa mensajes entrantes y realiza an√°lisis de sentimientos\r\n\r\nimport { supabase } from '../../lib/supabase.js';\r\nimport groqService from '../../services/groqService.js';\r\n\r\n/**\r\n * Procesa notificaciones de WhatsApp recibidas desde WhatsApp Business API\r\n * @param {Request} req - Request object\r\n * @param {Response} res - Response object\r\n */\r\nexport default async function handler(req, res) {\r\n  // Solo aceptar m√©todos POST\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({\r\n      success: false,\r\n      error: 'M√©todo no permitido. Solo se acepta POST.'\r\n    });\r\n  }\r\n\r\n  try {\r\n    console.log('üì± Webhook recibido desde WhatsApp:', {\r\n      headers: req.headers,\r\n      body: req.body,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n\r\n    const webhookData = req.body;\r\n\r\n    // Validar que tenemos los datos necesarios\r\n    if (!webhookData) {\r\n      console.error('‚ùå Datos de webhook inv√°lidos');\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'Datos de webhook inv√°lidos'\r\n      });\r\n    }\r\n\r\n    // Procesar mensajes entrantes\r\n    if (webhookData.entry && Array.isArray(webhookData.entry)) {\r\n      for (const entry of webhookData.entry) {\r\n        if (entry.messaging && Array.isArray(entry.messaging)) {\r\n          for (const messaging of entry.messaging) {\r\n            await processWhatsAppMessage(messaging);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Respuesta exitosa (WhatsApp espera 200 OK)\r\n    return res.status(200).json({\r\n      success: true,\r\n      message: 'Notificaci√≥n procesada correctamente'\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('üí• Error procesando webhook de WhatsApp:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Error interno del servidor',\r\n      details: error.message\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa un mensaje individual de WhatsApp\r\n * @param {Object} messaging - Objeto de mensaje de WhatsApp\r\n */\r\nasync function processWhatsAppMessage(messaging) {\r\n  try {\r\n    console.log('üîÑ Procesando mensaje de WhatsApp:', messaging);\r\n\r\n    const { message, sender, recipient } = messaging;\r\n\r\n    // Verificar que es un mensaje entrante con texto\r\n    if (!message || !message.text || !sender || !sender.id) {\r\n      console.log('‚ö†Ô∏è Mensaje no v√°lido o sin texto');\r\n      return;\r\n    }\r\n\r\n    const messageText = message.text.body;\r\n    const senderId = sender.id;\r\n    const timestamp = message.timestamp;\r\n\r\n    console.log('üì® Mensaje entrante:', {\r\n      sender: senderId,\r\n      text: messageText,\r\n      timestamp: timestamp\r\n    });\r\n\r\n    // Buscar usuario por n√∫mero de tel√©fono de WhatsApp\r\n    const { data: user, error: userError } = await supabase\r\n      .from('users')\r\n      .select('id, company_id')\r\n      .eq('whatsapp_number', senderId)\r\n      .single();\r\n\r\n    if (userError || !user) {\r\n      console.log('‚ö†Ô∏è Usuario no encontrado para n√∫mero WhatsApp:', senderId);\r\n      // A√∫n as√≠ procesar el mensaje pero sin usuario espec√≠fico\r\n    }\r\n\r\n    // Procesar el mensaje de forma as√≠ncrona (no bloquear la respuesta del webhook)\r\n    processMessageAsync(messageText, senderId, user?.id, user?.company_id, timestamp);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando mensaje individual:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa el mensaje de forma as√≠ncrona para no bloquear el webhook\r\n * @param {string} messageText - Texto del mensaje\r\n * @param {string} senderId - ID del remitente\r\n * @param {string} userId - ID del usuario (opcional)\r\n * @param {string} companyId - ID de la compa√±√≠a (opcional)\r\n * @param {string} timestamp - Timestamp del mensaje\r\n */\r\nasync function processMessageAsync(messageText, senderId, userId, companyId, timestamp) {\r\n  try {\r\n    console.log('ü§ñ Iniciando an√°lisis de sentimientos para mensaje de WhatsApp');\r\n\r\n    // Analizar sentimiento usando GROQ\r\n    const sentimentResult = await groqService.analyzeSentiment(messageText, userId);\r\n\r\n    console.log('‚úÖ An√°lisis de sentimientos completado:', sentimentResult);\r\n\r\n    // Guardar el mensaje en la base de datos con el an√°lisis de sentimientos\r\n    await saveWhatsAppMessage(messageText, senderId, userId, companyId, timestamp, sentimentResult);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error en an√°lisis de sentimientos:', error);\r\n\r\n    // Guardar el mensaje sin an√°lisis de sentimientos en caso de error\r\n    try {\r\n      await saveWhatsAppMessage(messageText, senderId, userId, companyId, timestamp, null);\r\n    } catch (saveError) {\r\n      console.error('‚ùå Error guardando mensaje sin an√°lisis:', saveError);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Guarda el mensaje de WhatsApp en la base de datos\r\n * @param {string} messageText - Texto del mensaje\r\n * @param {string} senderId - ID del remitente\r\n * @param {string} userId - ID del usuario\r\n * @param {string} companyId - ID de la compa√±√≠a\r\n * @param {string} timestamp - Timestamp del mensaje\r\n * @param {Object|null} sentimentResult - Resultado del an√°lisis de sentimientos\r\n */\r\nasync function saveWhatsAppMessage(messageText, senderId, userId, companyId, timestamp, sentimentResult) {\r\n  try {\r\n    const messageData = {\r\n      message: messageText,\r\n      channel: 'whatsapp',\r\n      sender_id: senderId,\r\n      user_id: userId,\r\n      company_id: companyId,\r\n      status: 'received',\r\n      sent_at: new Date(parseInt(timestamp) * 1000).toISOString(),\r\n      created_at: new Date().toISOString(),\r\n      updated_at: new Date().toISOString()\r\n    };\r\n\r\n    // Agregar datos de sentimiento si est√°n disponibles\r\n    if (sentimentResult) {\r\n      messageData.sentiment_score = sentimentResult.score;\r\n      messageData.sentiment_label = sentimentResult.label;\r\n      // Nota: confidence no se guarda actualmente en BD, pero se puede agregar si es necesario\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('communication_logs')\r\n      .insert(messageData);\r\n\r\n    if (error) {\r\n      console.error('‚ùå Error guardando mensaje de WhatsApp:', error);\r\n    } else {\r\n      console.log('‚úÖ Mensaje de WhatsApp guardado en BD:', {\r\n        id: data?.[0]?.id,\r\n        sentiment: sentimentResult ? `${sentimentResult.label} (${sentimentResult.score})` : 'No analizado'\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error('‚ùå Error guardando mensaje de WhatsApp:', error);\r\n  }\r\n}","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\api\\webhook\\whatsapp-webhook.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'event' is assigned a value but never used.","line":201,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":201,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Webhook Listener para WhatsApp Business API\r\n * \r\n * Este endpoint recibe webhooks de Meta para procesar mensajes entrantes,\r\n * actualizaciones de estado y otros eventos de WhatsApp.\r\n */\r\n\r\nimport { supabase } from '../../lib/supabaseClient.js';\r\n\r\n/**\r\n * Verifica el webhook con Meta\r\n * @param {Object} req - Request object\r\n * @param {Object} res - Response object\r\n */\r\nexport async function verifyWebhook(req, res) {\r\n  try {\r\n    const mode = req.query['hub.mode'];\r\n    const token = req.query['hub.verify_token'];\r\n    const challenge = req.query['hub.challenge'];\r\n\r\n    console.log('Webhook verification request:', { mode, token, challenge });\r\n\r\n    // Buscar configuraci√≥n de WhatsApp con este verify_token\r\n    const { data: config, error } = await supabase\r\n      .from('whatsapp_configs')\r\n      .select('*')\r\n      .eq('webhook_verify_token', token)\r\n      .eq('is_active', true)\r\n      .single();\r\n\r\n    if (error || !config) {\r\n      console.log('Webhook verification failed: Invalid token');\r\n      return res.status(403).send('Verification failed');\r\n    }\r\n\r\n    if (mode && token) {\r\n      if (mode === 'subscribe' && token === config.webhook_verify_token) {\r\n        console.log('Webhook verified successfully');\r\n        return res.status(200).send(challenge);\r\n      } else {\r\n        console.log('Webhook verification failed: Mode or token mismatch');\r\n        return res.status(403).send('Verification failed');\r\n      }\r\n    }\r\n\r\n    res.status(400).send('Bad request');\r\n  } catch (error) {\r\n    console.error('Webhook verification error:', error);\r\n    res.status(500).send('Internal server error');\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa eventos entrantes de WhatsApp\r\n * @param {Object} req - Request object\r\n * @param {Object} res - Response object\r\n */\r\nexport async function processWebhook(req, res) {\r\n  try {\r\n    console.log('Received WhatsApp webhook:', JSON.stringify(req.body, null, 2));\r\n\r\n    const data = req.body;\r\n    \r\n    // Verificar si es un webhook de WhatsApp\r\n    if (data.object !== 'whatsapp_business_account') {\r\n      console.log('Not a WhatsApp webhook');\r\n      return res.status(200).send('OK');\r\n    }\r\n\r\n    // Procesar cada entrada\r\n    for (const entry of data.entry || []) {\r\n      for (const change of entry.changes || []) {\r\n        if (change.field === 'messages') {\r\n          await processMessage(change.value);\r\n        } else if (change.field === 'message_template_status_update') {\r\n          await processTemplateStatusUpdate(change.value);\r\n        } else if (change.field === 'account_update') {\r\n          await processAccountUpdate(change.value);\r\n        }\r\n      }\r\n    }\r\n\r\n    res.status(200).send('OK');\r\n  } catch (error) {\r\n    console.error('Webhook processing error:', error);\r\n    res.status(500).send('Internal server error');\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa mensajes entrantes\r\n * @param {Object} messageData - Datos del mensaje\r\n */\r\nasync function processMessage(messageData) {\r\n  try {\r\n    const { messages, contacts, metadata } = messageData;\r\n    \r\n    if (!messages || messages.length === 0) {\r\n      console.log('No messages to process');\r\n      return;\r\n    }\r\n\r\n    for (const message of messages) {\r\n      const { from, id, timestamp, type } = message;\r\n      \r\n      // Buscar configuraci√≥n activa para este n√∫mero de tel√©fono\r\n      const { data: config, error } = await supabase\r\n        .from('whatsapp_configs')\r\n        .select('*')\r\n        .eq('phone_number_id', metadata.phone_number_id)\r\n        .eq('is_active', true)\r\n        .single();\r\n\r\n      if (error || !config) {\r\n        console.log('No active WhatsApp config found for phone number:', metadata.phone_number_id);\r\n        continue;\r\n      }\r\n\r\n      // Registrar el mensaje en la base de datos\r\n      const messageRecord = {\r\n        whatsapp_config_id: config.id,\r\n        message_id: id,\r\n        sender_phone: from,\r\n        recipient_phone: config.display_phone_number,\r\n        message_type: type,\r\n        direction: 'inbound',\r\n        content: null,\r\n        metadata: message,\r\n        status: 'received',\r\n        received_at: new Date(parseInt(timestamp) * 1000).toISOString(),\r\n        created_at: new Date().toISOString()\r\n      };\r\n\r\n      // Extraer contenido seg√∫n el tipo de mensaje\r\n      if (type === 'text') {\r\n        messageRecord.content = message.text.body;\r\n      } else if (type === 'image') {\r\n        messageRecord.content = `[Image] ${message.image.caption || ''}`;\r\n        messageRecord.media_url = message.image.id;\r\n      } else if (type === 'audio') {\r\n        messageRecord.content = '[Audio message]';\r\n        messageRecord.media_url = message.audio.id;\r\n      } else if (type === 'video') {\r\n        messageRecord.content = `[Video] ${message.video.caption || ''}`;\r\n        messageRecord.media_url = message.video.id;\r\n      } else if (type === 'document') {\r\n        messageRecord.content = `[Document] ${message.document.filename || ''}`;\r\n        messageRecord.media_url = message.document.id;\r\n      } else if (type === 'interactive') {\r\n        messageRecord.content = `[Interactive] ${JSON.stringify(message.interactive)}`;\r\n      } else if (type === 'button') {\r\n        messageRecord.content = `[Button] ${message.button.text}`;\r\n      } else if (type === 'location') {\r\n        messageRecord.content = `[Location] ${message.location.latitude}, ${message.location.longitude}`;\r\n      } else if (type === 'contacts') {\r\n        messageRecord.content = `[Contact] ${message.contacts[0]?.name?.formatted_name || 'Unknown'}`;\r\n      } else if (type === 'order') {\r\n        messageRecord.content = `[Order] ${message.order.id || 'Unknown'}`;\r\n      } else if (type === 'system') {\r\n        messageRecord.content = `[System] ${message.system.body || ''}`;\r\n      } else if (type === 'unsupported') {\r\n        messageRecord.content = '[Unsupported message type]';\r\n      }\r\n\r\n      // Guardar en la base de datos\r\n      const { error: insertError } = await supabase\r\n        .from('whatsapp_logs')\r\n        .insert(messageRecord);\r\n\r\n      if (insertError) {\r\n        console.error('Error saving message:', insertError);\r\n        continue;\r\n      }\r\n\r\n      // Actualizar contador de mensajes\r\n      await updateMessageCount(config.id, 'inbound');\r\n\r\n      // Procesar respuesta autom√°tica si est√° configurada\r\n      if (config.auto_reply_enabled && type === 'text') {\r\n        await processAutoReply(config, message, contacts);\r\n      }\r\n\r\n      console.log('Message processed successfully:', id);\r\n    }\r\n  } catch (error) {\r\n    console.error('Error processing message:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa actualizaciones de estado de plantillas\r\n * @param {Object} templateData - Datos de la plantilla\r\n */\r\nasync function processTemplateStatusUpdate(templateData) {\r\n  try {\r\n    console.log('Template status update:', templateData);\r\n    \r\n    // Aqu√≠ puedes implementar l√≥gica para manejar cambios en el estado de las plantillas\r\n    // Por ejemplo, cuando una plantilla es aprobada o rechazada\r\n    \r\n    const { message_template_id, event, status } = templateData;\r\n    \r\n    // Actualizar estado de la plantilla en la base de datos\r\n    const { error } = await supabase\r\n      .from('whatsapp_templates')\r\n      .update({ \r\n        status: status,\r\n        updated_at: new Date().toISOString()\r\n      })\r\n      .eq('template_id', message_template_id);\r\n\r\n    if (error) {\r\n      console.error('Error updating template status:', error);\r\n    } else {\r\n      console.log('Template status updated successfully:', message_template_id);\r\n    }\r\n  } catch (error) {\r\n    console.error('Error processing template status update:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa actualizaciones de cuenta\r\n * @param {Object} accountData - Datos de la cuenta\r\n */\r\nasync function processAccountUpdate(accountData) {\r\n  try {\r\n    console.log('Account update:', accountData);\r\n    \r\n    // Aqu√≠ puedes implementar l√≥gica para manejar cambios en la cuenta\r\n    // Por ejemplo, cambios en el estado del n√∫mero de tel√©fono\r\n    \r\n    const { phone_number_id, display_phone_number, quality_rating } = accountData;\r\n    \r\n    // Actualizar informaci√≥n del n√∫mero de tel√©fono\r\n    const { error } = await supabase\r\n      .from('whatsapp_configs')\r\n      .update({ \r\n        display_phone_number,\r\n        quality_rating,\r\n        updated_at: new Date().toISOString()\r\n      })\r\n      .eq('phone_number_id', phone_number_id);\r\n\r\n    if (error) {\r\n      console.error('Error updating account info:', error);\r\n    } else {\r\n      console.log('Account info updated successfully:', phone_number_id);\r\n    }\r\n  } catch (error) {\r\n    console.error('Error processing account update:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa respuestas autom√°ticas\r\n * @param {Object} config - Configuraci√≥n de WhatsApp\r\n * @param {Object} message - Mensaje entrante\r\n * @param {Array} contacts - Contactos del mensaje\r\n */\r\nasync function processAutoReply(config, message, contacts) {\r\n  try {\r\n    if (!config.auto_reply_message) {\r\n      return;\r\n    }\r\n\r\n    // Personalizar mensaje con variables\r\n    let replyMessage = config.auto_reply_message;\r\n    const contactName = contacts?.[0]?.profile?.name || 'Cliente';\r\n    \r\n    replyMessage = replyMessage.replace('{name}', contactName);\r\n    replyMessage = replyMessage.replace('{company}', config.company_name || 'nosotros');\r\n    replyMessage = replyMessage.replace('{time}', new Date().toLocaleTimeString('es-ES'));\r\n\r\n    // Enviar respuesta autom√°tica\r\n    const response = await fetch(`https://graph.facebook.com/v18.0/${config.phone_number_id}/messages`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${config.access_token}`,\r\n        'Content-Type': 'application/json'\r\n      },\r\n      body: JSON.stringify({\r\n        messaging_product: 'whatsapp',\r\n        to: message.from,\r\n        type: 'text',\r\n        text: {\r\n          body: replyMessage\r\n        }\r\n      })\r\n    });\r\n\r\n    if (response.ok) {\r\n      const responseData = await response.json();\r\n      \r\n      // Registrar la respuesta autom√°tica\r\n      const { error: logError } = await supabase\r\n        .from('whatsapp_logs')\r\n        .insert({\r\n          whatsapp_config_id: config.id,\r\n          message_id: responseData.messages[0].id,\r\n          sender_phone: config.display_phone_number,\r\n          recipient_phone: message.from,\r\n          message_type: 'text',\r\n          direction: 'outbound',\r\n          content: replyMessage,\r\n          metadata: { auto_reply: true },\r\n          status: 'sent',\r\n          sent_at: new Date().toISOString(),\r\n          created_at: new Date().toISOString()\r\n        });\r\n\r\n      if (logError) {\r\n        console.error('Error logging auto-reply:', logError);\r\n      }\r\n\r\n      // Actualizar contador de mensajes salientes\r\n      await updateMessageCount(config.id, 'outbound');\r\n      \r\n      console.log('Auto-reply sent successfully');\r\n    } else {\r\n      console.error('Error sending auto-reply:', await response.text());\r\n    }\r\n  } catch (error) {\r\n    console.error('Error processing auto-reply:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Actualiza el contador de mensajes\r\n * @param {string} configId - ID de la configuraci√≥n\r\n * @param {string} direction - Direcci√≥n del mensaje (inbound/outbound)\r\n */\r\nasync function updateMessageCount(configId, direction) {\r\n  try {\r\n    const field = direction === 'inbound' ? 'messages_received_today' : 'messages_sent_today';\r\n    \r\n    const { error } = await supabase\r\n      .from('whatsapp_configs')\r\n      .update({ [field]: supabase.raw(`${field} + 1`) })\r\n      .eq('id', configId);\r\n\r\n    if (error) {\r\n      console.error('Error updating message count:', error);\r\n    }\r\n  } catch (error) {\r\n    console.error('Error in updateMessageCount:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Manejador principal del webhook (para uso en Express)\r\n */\r\nexport default function handler(req, res) {\r\n  if (req.method === 'GET') {\r\n    return verifyWebhook(req, res);\r\n  } else if (req.method === 'POST') {\r\n    return processWebhook(req, res);\r\n  } else {\r\n    res.setHeader('Allow', ['GET', 'POST']);\r\n    res.status(405).end(`Method ${req.method} Not Allowed`);\r\n  }\r\n}","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\api\\webhook\\zoom-notifications.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":368,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":368,"endColumn":17},{"ruleId":"no-unused-vars","severity":1,"message":"'verifyZoomSignature' is defined but never used.","line":394,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":394,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Endpoint API para recibir notificaciones de Zoom\r\n// Procesa eventos de reuniones y env√≠a mensajes a WhatsApp\r\n\r\nimport { supabase } from '../../lib/supabase.js';\r\nimport communicationService from '../../services/communicationService.js';\r\n\r\n/**\r\n * Procesa notificaciones de Zoom recibidas desde Zoom Webhooks\r\n * @param {Request} req - Request object\r\n * @param {Response} res - Response object\r\n */\r\nexport default async function handler(req, res) {\r\n  // Solo aceptar m√©todos POST\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({\r\n      success: false,\r\n      error: 'M√©todo no permitido. Solo se acepta POST.'\r\n    });\r\n  }\r\n\r\n  try {\r\n    console.log('üìπ Webhook recibido desde Zoom:', {\r\n      headers: req.headers,\r\n      body: req.body,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n\r\n    const webhookData = req.body;\r\n\r\n    // Validar que tenemos los datos necesarios\r\n    if (!webhookData || !webhookData.event) {\r\n      console.error('‚ùå Datos de webhook inv√°lidos: faltan campos requeridos');\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'Datos de webhook inv√°lidos: faltan campos requeridos'\r\n      });\r\n    }\r\n\r\n    // Verificar firma de Zoom (en producci√≥n)\r\n    // const signature = req.headers['x-zm-signature'];\r\n    // const timestamp = req.headers['x-zm-request-timestamp'];\r\n    // if (!verifyZoomSignature(signature, timestamp, JSON.stringify(webhookData))) {\r\n    //   return res.status(401).json({ success: false, error: 'Firma inv√°lida' });\r\n    // }\r\n\r\n    // Procesar el evento de Zoom\r\n    await processZoomEvent(webhookData);\r\n\r\n    // Respuesta exitosa\r\n    return res.status(200).json({\r\n      success: true,\r\n      message: 'Notificaci√≥n procesada correctamente'\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('üí• Error procesando webhook de Zoom:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Error interno del servidor',\r\n      details: error.message\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa un evento individual de Zoom\r\n * @param {Object} eventData - Datos del evento de Zoom\r\n */\r\nasync function processZoomEvent(eventData) {\r\n  try {\r\n    console.log('üîÑ Procesando evento de Zoom:', eventData.event);\r\n\r\n    const { event, payload } = eventData;\r\n\r\n    // Procesar diferentes tipos de eventos\r\n    switch (event) {\r\n      case 'meeting.started':\r\n        await processMeetingStarted(payload, eventData);\r\n        break;\r\n\r\n      case 'meeting.ended':\r\n        await processMeetingEnded(payload, eventData);\r\n        break;\r\n\r\n      case 'meeting.participant_joined':\r\n        await processParticipantJoined(payload, eventData);\r\n        break;\r\n\r\n      case 'meeting.participant_left':\r\n        await processParticipantLeft(payload, eventData);\r\n        break;\r\n\r\n      case 'meeting.created':\r\n        await processMeetingCreated(payload, eventData);\r\n        break;\r\n\r\n      case 'meeting.updated':\r\n        await processMeetingUpdated(payload, eventData);\r\n        break;\r\n\r\n      case 'meeting.deleted':\r\n        await processMeetingDeleted(payload, eventData);\r\n        break;\r\n\r\n      default:\r\n        console.log('‚ö†Ô∏è Evento de Zoom no manejado:', event);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando evento de Zoom:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando una reuni√≥n comienza\r\n * @param {Object} payload - Payload del evento\r\n * @param {Object} eventData - Datos completos del evento\r\n */\r\nasync function processMeetingStarted(payload, eventData) {\r\n  try {\r\n    const { object } = payload;\r\n    const meetingId = object.id;\r\n    const topic = object.topic || 'Reuni√≥n sin t√≠tulo';\r\n\r\n    console.log('‚ñ∂Ô∏è Reuni√≥n iniciada:', topic);\r\n\r\n    // Obtener informaci√≥n adicional de la reuni√≥n\r\n    const meetingDetails = await getZoomMeetingDetails(meetingId);\r\n\r\n    // Generar mensaje de WhatsApp\r\n    const whatsappMessage = `La reuni√≥n \"${topic}\" ha comenzado. Enlace: ${meetingDetails?.join_url || 'No disponible'}`;\r\n\r\n    // Enviar notificaci√≥n\r\n    await sendZoomWhatsAppNotification(payload, whatsappMessage);\r\n\r\n    // Guardar evento\r\n    await saveZoomNotification(eventData, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando reuni√≥n iniciada:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando una reuni√≥n termina\r\n * @param {Object} payload - Payload del evento\r\n * @param {Object} eventData - Datos completos del evento\r\n */\r\nasync function processMeetingEnded(payload, eventData) {\r\n  try {\r\n    const { object } = payload;\r\n    const topic = object.topic || 'Reuni√≥n sin t√≠tulo';\r\n\r\n    console.log('‚èπÔ∏è Reuni√≥n finalizada:', topic);\r\n\r\n    const whatsappMessage = `La reuni√≥n \"${topic}\" ha finalizado.`;\r\n\r\n    await sendZoomWhatsAppNotification(payload, whatsappMessage);\r\n    await saveZoomNotification(eventData, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando reuni√≥n finalizada:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando un participante se une\r\n * @param {Object} payload - Payload del evento\r\n * @param {Object} eventData - Datos completos del evento\r\n */\r\nasync function processParticipantJoined(payload, eventData) {\r\n  try {\r\n    const { object } = payload;\r\n    const participantName = object.participant?.user_name || 'Participante desconocido';\r\n    const meetingTopic = object.topic || 'Reuni√≥n sin t√≠tulo';\r\n\r\n    console.log('üë§ Participante se uni√≥:', participantName, 'a', meetingTopic);\r\n\r\n    // Solo enviar notificaci√≥n si es un participante importante o si est√° configurado\r\n    const whatsappMessage = `${participantName} se uni√≥ a la reuni√≥n \"${meetingTopic}\".`;\r\n\r\n    await sendZoomWhatsAppNotification(payload, whatsappMessage);\r\n    await saveZoomNotification(eventData, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando participante unido:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando un participante sale\r\n * @param {Object} payload - Payload del evento\r\n * @param {Object} eventData - Datos completos del evento\r\n */\r\nasync function processParticipantLeft(payload, eventData) {\r\n  try {\r\n    const { object } = payload;\r\n    const participantName = object.participant?.user_name || 'Participante desconocido';\r\n    const meetingTopic = object.topic || 'Reuni√≥n sin t√≠tulo';\r\n\r\n    console.log('üëã Participante sali√≥:', participantName, 'de', meetingTopic);\r\n\r\n    // Opcional: solo enviar para participantes importantes\r\n    // const whatsappMessage = `${participantName} sali√≥ de la reuni√≥n \"${meetingTopic}\".`;\r\n    // await sendZoomWhatsAppNotification(payload, whatsappMessage);\r\n    // await saveZoomNotification(eventData, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando participante salido:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando se crea una reuni√≥n\r\n * @param {Object} payload - Payload del evento\r\n * @param {Object} eventData - Datos completos del evento\r\n */\r\nasync function processMeetingCreated(payload, eventData) {\r\n  try {\r\n    const { object } = payload;\r\n    const topic = object.topic || 'Reuni√≥n sin t√≠tulo';\r\n    const startTime = object.start_time;\r\n\r\n    console.log('üìÖ Nueva reuni√≥n creada:', topic);\r\n\r\n    const formattedDate = startTime ? formatZoomDate(startTime) : 'Fecha no especificada';\r\n    const whatsappMessage = `Nueva reuni√≥n programada: \"${topic}\" el ${formattedDate}. Enlace: ${object.join_url || 'No disponible'}`;\r\n\r\n    await sendZoomWhatsAppNotification(payload, whatsappMessage);\r\n    await saveZoomNotification(eventData, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando reuni√≥n creada:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando se actualiza una reuni√≥n\r\n * @param {Object} payload - Payload del evento\r\n * @param {Object} eventData - Datos completos del evento\r\n */\r\nasync function processMeetingUpdated(payload, eventData) {\r\n  try {\r\n    const { object } = payload;\r\n    const topic = object.topic || 'Reuni√≥n sin t√≠tulo';\r\n    const startTime = object.start_time;\r\n\r\n    console.log('üîÑ Reuni√≥n actualizada:', topic);\r\n\r\n    const formattedDate = startTime ? formatZoomDate(startTime) : 'Fecha no especificada';\r\n    const whatsappMessage = `Reuni√≥n actualizada: \"${topic}\" ahora es el ${formattedDate}. Enlace: ${object.join_url || 'No disponible'}`;\r\n\r\n    await sendZoomWhatsAppNotification(payload, whatsappMessage);\r\n    await saveZoomNotification(eventData, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando reuni√≥n actualizada:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Procesa cuando se elimina una reuni√≥n\r\n * @param {Object} payload - Payload del evento\r\n * @param {Object} eventData - Datos completos del evento\r\n */\r\nasync function processMeetingDeleted(payload, eventData) {\r\n  try {\r\n    const { object } = payload;\r\n    const topic = object.topic || 'Reuni√≥n sin t√≠tulo';\r\n\r\n    console.log('üóëÔ∏è Reuni√≥n eliminada:', topic);\r\n\r\n    const whatsappMessage = `Reuni√≥n cancelada: \"${topic}\".`;\r\n\r\n    await sendZoomWhatsAppNotification(payload, whatsappMessage);\r\n    await saveZoomNotification(eventData, whatsappMessage);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error procesando reuni√≥n eliminada:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Obtiene detalles adicionales de una reuni√≥n de Zoom\r\n * @param {string} meetingId - ID de la reuni√≥n\r\n * @returns {Object|null} Detalles de la reuni√≥n\r\n */\r\nasync function getZoomMeetingDetails(meetingId) {\r\n  try {\r\n    // En una implementaci√≥n real, obtendr√≠amos el access token del usuario\r\n    // Por ahora, devolvemos datos b√°sicos del payload\r\n    console.log('üìã Obteniendo detalles de reuni√≥n Zoom:', meetingId);\r\n\r\n    // Aqu√≠ ir√≠a la l√≥gica para llamar a la API de Zoom\r\n    // const response = await fetch(`https://api.zoom.us/v2/meetings/${meetingId}`, {\r\n    //   headers: {\r\n    //     'Authorization': `Bearer ${zoomAccessToken}`,\r\n    //     'Content-Type': 'application/json'\r\n    //   }\r\n    // });\r\n\r\n    return null; // Placeholder\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error obteniendo detalles de reuni√≥n Zoom:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Env√≠a notificaci√≥n por WhatsApp para eventos de Zoom\r\n * @param {Object} payload - Payload del evento\r\n * @param {string} message - Mensaje a enviar\r\n */\r\nasync function sendZoomWhatsAppNotification(payload, message) {\r\n  try {\r\n    // Extraer informaci√≥n del organizador o usuario\r\n    const accountId = payload?.account_id || payload?.object?.host_id;\r\n\r\n    if (!accountId) {\r\n      console.error('‚ùå No se pudo identificar el usuario para Zoom');\r\n      return;\r\n    }\r\n\r\n    // Buscar usuario por account_id de Zoom\r\n    const { data: userCredentials, error } = await supabase\r\n      .from('user_credentials')\r\n      .select('user_id')\r\n      .eq('zoom_account_id', accountId)\r\n      .single();\r\n\r\n    if (error || !userCredentials) {\r\n      console.error('‚ùå No se encontraron credenciales de Zoom para el usuario');\r\n      return;\r\n    }\r\n\r\n    // Obtener empleados asociados al usuario\r\n    const { data: employees } = await supabase\r\n      .from('employees')\r\n      .select('id')\r\n      .eq('user_id', userCredentials.user_id)\r\n      .limit(10);\r\n\r\n    if (!employees || employees.length === 0) {\r\n      console.error('‚ùå No se encontraron empleados para enviar WhatsApp');\r\n      return;\r\n    }\r\n\r\n    const recipientIds = employees.map(emp => emp.id);\r\n\r\n    // Enviar mensaje usando el servicio de comunicaci√≥n\r\n    await communicationService.sendWhatsAppMessage(recipientIds, message);\r\n\r\n    console.log('‚úÖ Mensaje de WhatsApp enviado para Zoom:', message);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error enviando mensaje de WhatsApp para Zoom:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Guarda la notificaci√≥n de Zoom en la base de datos\r\n * @param {Object} eventData - Datos del evento\r\n * @param {string} whatsappMessage - Mensaje enviado por WhatsApp\r\n */\r\nasync function saveZoomNotification(eventData, whatsappMessage) {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from('zoom_notifications')\r\n      .insert({\r\n        event_type: eventData.event,\r\n        event_data: eventData,\r\n        whatsapp_message: whatsappMessage,\r\n        processed_at: new Date().toISOString()\r\n      });\r\n\r\n    if (error) {\r\n      console.error('‚ùå Error guardando notificaci√≥n de Zoom:', error);\r\n    } else {\r\n      console.log('‚úÖ Notificaci√≥n de Zoom guardada en BD');\r\n    }\r\n  } catch (error) {\r\n    console.error('‚ùå Error guardando notificaci√≥n de Zoom:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Verifica la firma de Zoom (para producci√≥n)\r\n * @param {string} signature - Firma del webhook\r\n * @param {string} timestamp - Timestamp del request\r\n * @param {string} body - Cuerpo del request\r\n * @returns {boolean} Si la firma es v√°lida\r\n */\r\nfunction verifyZoomSignature(signature, timestamp, body) {\r\n  // Implementaci√≥n de verificaci√≥n de firma de Zoom\r\n  // Usando HMAC-SHA256 con el secret del webhook\r\n  // const expectedSignature = crypto.createHmac('sha256', process.env.ZOOM_WEBHOOK_SECRET)\r\n  //   .update(`v0:${timestamp}:${body}`)\r\n  //   .digest('hex');\r\n  // return signature === `v0=${expectedSignature}`;\r\n\r\n  return true; // Placeholder para desarrollo\r\n}\r\n\r\n/**\r\n * Formatea fecha de Zoom para mensajes\r\n * @param {string} dateTime - Fecha en formato ISO\r\n * @returns {string} Fecha formateada\r\n */\r\nfunction formatZoomDate(dateTime) {\r\n  const date = new Date(dateTime);\r\n  return date.toLocaleDateString('es-ES', {\r\n    weekday: 'long',\r\n    year: 'numeric',\r\n    month: 'long',\r\n    day: 'numeric',\r\n    hour: '2-digit',\r\n    minute: '2-digit'\r\n  });\r\n}","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\CacheCleanup.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\agency\\MultiCompanyDashboard.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'UsersIcon' is defined but never used.","line":4,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'CogIcon' is defined but never used.","line":7,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":10},{"ruleId":"no-unused-vars","severity":1,"message":"'FunnelIcon' is defined but never used.","line":10,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":13},{"ruleId":"no-unused-vars","severity":1,"message":"'DocumentTextIcon' is defined but never used.","line":14,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'ArrowTrendingUpIcon' is defined but never used.","line":15,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'ArrowTrendingDownIcon' is defined but never used.","line":16,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":24},{"ruleId":"no-unused-vars","severity":1,"message":"'TrashIcon' is defined but never used.","line":19,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'BellIcon' is defined but never used.","line":20,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback } from 'react';\r\nimport {\r\n  BuildingOfficeIcon,\r\n  UsersIcon,\r\n  CurrencyDollarIcon,\r\n  ChartBarIcon,\r\n  CogIcon,\r\n  PlusIcon,\r\n  MagnifyingGlassIcon,\r\n  FunnelIcon,\r\n  ExclamationTriangleIcon,\r\n  CheckCircleIcon,\r\n  ClockIcon,\r\n  DocumentTextIcon,\r\n  ArrowTrendingUpIcon,\r\n  ArrowTrendingDownIcon,\r\n  EyeIcon,\r\n  PencilIcon,\r\n  TrashIcon,\r\n  BellIcon,\r\n  CreditCardIcon,\r\n  PhoneIcon,\r\n  EnvelopeIcon,\r\n  ChatBubbleLeftRightIcon\r\n} from '@heroicons/react/24/outline';\r\nimport multiCompanyManagementService from '../../services/multiCompanyManagementService.js';\r\nimport { formatCurrency, formatNumber, formatDate } from '../../utils/formatters.js';\r\n\r\n/**\r\n * Dashboard Multi-Empresa para Agencias\r\n * \r\n * Proporciona una vista completa para gestionar m√∫ltiples empresas/clientes\r\n * incluyendo estad√≠sticas, l√≠mites de uso, facturaci√≥n y configuraci√≥n.\r\n */\r\nconst MultiCompanyDashboard = ({ agencyId }) => {\r\n  // Estado principal\r\n  const [companies, setCompanies] = useState([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState(null);\r\n  \r\n  // Filtros y b√∫squeda\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [statusFilter, setStatusFilter] = useState('all');\r\n  const [sortBy, setSortBy] = useState('created_at');\r\n  const [sortOrder, setSortOrder] = useState('desc');\r\n  \r\n  // Modales y vistas\r\n  const [showCreateModal, setShowCreateModal] = useState(false);\r\n  const [showEditModal, setShowEditModal] = useState(false);\r\n  const [showDetailsModal, setShowDetailsModal] = useState(false);\r\n  const [showBillingModal, setShowBillingModal] = useState(false);\r\n  const [selectedCompany, setSelectedCompany] = useState(null);\r\n  \r\n  // Estad√≠sticas de la agencia\r\n  const [agencyStats, setAgencyStats] = useState({\r\n    totalCompanies: 0,\r\n    activeCompanies: 0,\r\n    suspendedCompanies: 0,\r\n    totalRevenue: 0,\r\n    totalMessages: 0,\r\n    avgCostPerMessage: 0\r\n  });\r\n\r\n  // Cargar empresas de la agencia\r\n  const loadCompanies = useCallback(async () => {\r\n    if (!agencyId) return;\r\n    \r\n    try {\r\n      setLoading(true);\r\n      const options = {\r\n        status: statusFilter === 'all' ? null : statusFilter,\r\n        search: searchTerm || null\r\n      };\r\n      \r\n      const companiesData = await multiCompanyManagementService.getAgencyCompanies(agencyId, options);\r\n      setCompanies(companiesData);\r\n      \r\n      // Calcular estad√≠sticas\r\n      const stats = calculateAgencyStats(companiesData);\r\n      setAgencyStats(stats);\r\n      \r\n    } catch (err) {\r\n      console.error('Error cargando empresas:', err);\r\n      setError('Error al cargar las empresas');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [agencyId, statusFilter, searchTerm]);\r\n\r\n  // Calcular estad√≠sticas de la agencia\r\n  const calculateAgencyStats = (companiesData) => {\r\n    const stats = {\r\n      totalCompanies: companiesData.length,\r\n      activeCompanies: companiesData.filter(c => c.status === 'active').length,\r\n      suspendedCompanies: companiesData.filter(c => c.status === 'suspended').length,\r\n      totalRevenue: 0,\r\n      totalMessages: 0,\r\n      avgCostPerMessage: 0\r\n    };\r\n\r\n    let totalCost = 0;\r\n    let totalMessages = 0;\r\n\r\n    companiesData.forEach(company => {\r\n      if (company.usage_stats) {\r\n        totalCost += company.usage_stats.totalCost || 0;\r\n        totalMessages += company.usage_stats.totalMessages || 0;\r\n      }\r\n    });\r\n\r\n    stats.totalRevenue = totalCost;\r\n    stats.totalMessages = totalMessages;\r\n    stats.avgCostPerMessage = totalMessages > 0 ? totalCost / totalMessages : 0;\r\n\r\n    return stats;\r\n  };\r\n\r\n  // Crear nueva empresa\r\n  const handleCreateCompany = async (companyData) => {\r\n    try {\r\n      const result = await multiCompanyManagementService.createCompany(companyData, agencyId);\r\n      \r\n      if (result.success) {\r\n        setShowCreateModal(false);\r\n        loadCompanies();\r\n        // Mostrar notificaci√≥n de √©xito\r\n        showNotification('Empresa creada exitosamente', 'success');\r\n      } else {\r\n        showNotification(result.message, 'error');\r\n      }\r\n    } catch (err) {\r\n      console.error('Error creando empresa:', err);\r\n      showNotification('Error al crear la empresa', 'error');\r\n    }\r\n  };\r\n\r\n  // Editar empresa\r\n  const handleEditCompany = async (companyId, updateData) => {\r\n    try {\r\n      const result = await multiCompanyManagementService.updateCompany(companyId, updateData, agencyId);\r\n      \r\n      if (result.success) {\r\n        setShowEditModal(false);\r\n        loadCompanies();\r\n        showNotification('Empresa actualizada exitosamente', 'success');\r\n      } else {\r\n        showNotification(result.message, 'error');\r\n      }\r\n    } catch (err) {\r\n      console.error('Error editando empresa:', err);\r\n      showNotification('Error al actualizar la empresa', 'error');\r\n    }\r\n  };\r\n\r\n  // Suspender/Reactivar empresa\r\n  const handleToggleCompanyStatus = async (company) => {\r\n    const newStatus = company.status === 'active' ? 'suspended' : 'active';\r\n    const action = newStatus === 'suspended' ? 'suspender' : 'reactivar';\r\n    \r\n    if (!window.confirm(`¬øEst√°s seguro de que quieres ${action} ${company.name}?`)) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const result = await multiCompanyManagementService.setCompanyStatus(company.id, newStatus, agencyId);\r\n      \r\n      if (result.success) {\r\n        loadCompanies();\r\n        showNotification(`Empresa ${action}da exitosamente`, 'success');\r\n      } else {\r\n        showNotification(result.message, 'error');\r\n      }\r\n    } catch (err) {\r\n      console.error(`Error ${action} empresa:`, err);\r\n      showNotification(`Error al ${action} la empresa`, 'error');\r\n    }\r\n  };\r\n\r\n  // Generar factura\r\n  const handleGenerateInvoice = async (companyId) => {\r\n    try {\r\n      const result = await multiCompanyManagementService.generateInvoice(companyId);\r\n      \r\n      if (result.success) {\r\n        showNotification('Factura generada exitosamente', 'success');\r\n        // Descargar PDF si est√° disponible\r\n        if (result.invoicePdf) {\r\n          window.open(result.invoicePdf, '_blank');\r\n        }\r\n      } else {\r\n        showNotification(result.message, 'error');\r\n      }\r\n    } catch (err) {\r\n      console.error('Error generando factura:', err);\r\n      showNotification('Error al generar la factura', 'error');\r\n    }\r\n  };\r\n\r\n  // Mostrar notificaci√≥n\r\n  const showNotification = (message, type = 'info') => {\r\n    // Implementar sistema de notificaciones\r\n    console.log(`${type.toUpperCase()}: ${message}`);\r\n  };\r\n\r\n  // Ordenar empresas\r\n  const sortCompanies = (companies) => {\r\n    return [...companies].sort((a, b) => {\r\n      let aValue = a[sortBy];\r\n      let bValue = b[sortBy];\r\n      \r\n      // Manejar valores anidados\r\n      if (sortBy.includes('.')) {\r\n        const keys = sortBy.split('.');\r\n        aValue = keys.reduce((obj, key) => obj?.[key], a);\r\n        bValue = keys.reduce((obj, key) => obj?.[key], b);\r\n      }\r\n      \r\n      // Manejar valores nulos\r\n      if (aValue === null) aValue = '';\r\n      if (bValue === null) bValue = '';\r\n      \r\n      // Ordenamiento\r\n      if (sortOrder === 'asc') {\r\n        return aValue > bValue ? 1 : -1;\r\n      } else {\r\n        return aValue < bValue ? 1 : -1;\r\n      }\r\n    });\r\n  };\r\n\r\n  // Obtener estado de uso\r\n  const getUsageStatus = (company) => {\r\n    if (!company.usage_stats) return { status: 'unknown', color: 'gray', text: 'Sin datos' };\r\n    \r\n    const dailyUsage = company.usage_stats.daily_count || 0;\r\n    const dailyLimit = company.daily_limit || 0;\r\n    const monthlyUsage = company.usage_stats.monthly_count || 0;\r\n    const monthlyLimit = company.monthly_limit || 0;\r\n    \r\n    const dailyPercentage = dailyLimit > 0 ? (dailyUsage / dailyLimit) * 100 : 0;\r\n    const monthlyPercentage = monthlyLimit > 0 ? (monthlyUsage / monthlyLimit) * 100 : 0;\r\n    \r\n    const maxPercentage = Math.max(dailyPercentage, monthlyPercentage);\r\n    \r\n    if (maxPercentage >= 90) {\r\n      return { status: 'critical', color: 'red', text: 'L√≠mite casi alcanzado' };\r\n    } else if (maxPercentage >= 75) {\r\n      return { status: 'warning', color: 'yellow', text: 'Acerc√°ndose al l√≠mite' };\r\n    } else if (maxPercentage >= 50) {\r\n      return { status: 'moderate', color: 'blue', text: 'Uso moderado' };\r\n    } else {\r\n      return { status: 'good', color: 'green', text: 'Uso normal' };\r\n    }\r\n  };\r\n\r\n  // Obtener badge de estado\r\n  const getStatusBadge = (status) => {\r\n    const statusConfig = {\r\n      active: { color: 'green', text: 'Activa', icon: CheckCircleIcon },\r\n      suspended: { color: 'red', text: 'Suspendida', icon: ExclamationTriangleIcon },\r\n      trial: { color: 'blue', text: 'Prueba', icon: ClockIcon }\r\n    };\r\n    \r\n    const config = statusConfig[status] || statusConfig.active;\r\n    const Icon = config.icon;\r\n    \r\n    return (\r\n      <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${config.color}-100 text-${config.color}-800`}>\r\n        <Icon className=\"w-3 h-3 mr-1\" />\r\n        {config.text}\r\n      </span>\r\n    );\r\n  };\r\n\r\n  useEffect(() => {\r\n    loadCompanies();\r\n  }, [loadCompanies]);\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center h-64\">\r\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600\"></div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"bg-red-50 border border-red-200 rounded-md p-4\">\r\n        <div className=\"flex\">\r\n          <ExclamationTriangleIcon className=\"h-5 w-5 text-red-400\" />\r\n          <div className=\"ml-3\">\r\n            <h3 className=\"text-sm font-medium text-red-800\">Error</h3>\r\n            <div className=\"mt-2 text-sm text-red-700\">{error}</div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const sortedCompanies = sortCompanies(companies);\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold text-gray-900\">Dashboard Multi-Empresa</h1>\r\n          <p className=\"text-gray-600\">Gestiona tus clientes y su configuraci√≥n</p>\r\n        </div>\r\n        <button\r\n          onClick={() => setShowCreateModal(true)}\r\n          className=\"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500\"\r\n        >\r\n          <PlusIcon className=\"h-4 w-4 mr-2\" />\r\n          Nueva Empresa\r\n        </button>\r\n      </div>\r\n\r\n      {/* Estad√≠sticas de la Agencia */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\r\n        <div className=\"bg-white rounded-lg shadow p-6\">\r\n          <div className=\"flex items-center\">\r\n            <div className=\"p-3 bg-blue-100 rounded-lg\">\r\n              <BuildingOfficeIcon className=\"h-6 w-6 text-blue-600\" />\r\n            </div>\r\n            <div className=\"ml-4\">\r\n              <p className=\"text-sm font-medium text-gray-600\">Total Empresas</p>\r\n              <p className=\"text-2xl font-bold text-gray-900\">{agencyStats.totalCompanies}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow p-6\">\r\n          <div className=\"flex items-center\">\r\n            <div className=\"p-3 bg-green-100 rounded-lg\">\r\n              <CheckCircleIcon className=\"h-6 w-6 text-green-600\" />\r\n            </div>\r\n            <div className=\"ml-4\">\r\n              <p className=\"text-sm font-medium text-gray-600\">Empresas Activas</p>\r\n              <p className=\"text-2xl font-bold text-gray-900\">{agencyStats.activeCompanies}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow p-6\">\r\n          <div className=\"flex items-center\">\r\n            <div className=\"p-3 bg-purple-100 rounded-lg\">\r\n              <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-purple-600\" />\r\n            </div>\r\n            <div className=\"ml-4\">\r\n              <p className=\"text-sm font-medium text-gray-600\">Total Mensajes</p>\r\n              <p className=\"text-2xl font-bold text-gray-900\">{formatNumber(agencyStats.totalMessages)}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow p-6\">\r\n          <div className=\"flex items-center\">\r\n            <div className=\"p-3 bg-yellow-100 rounded-lg\">\r\n              <CurrencyDollarIcon className=\"h-6 w-6 text-yellow-600\" />\r\n            </div>\r\n            <div className=\"ml-4\">\r\n              <p className=\"text-sm font-medium text-gray-600\">Ingresos Totales</p>\r\n              <p className=\"text-2xl font-bold text-gray-900\">{formatCurrency(agencyStats.totalRevenue)}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Filtros y B√∫squeda */}\r\n      <div className=\"bg-white rounded-lg shadow p-6\">\r\n        <div className=\"flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0\">\r\n          {/* B√∫squeda */}\r\n          <div className=\"flex-1 max-w-lg\">\r\n            <div className=\"relative\">\r\n              <MagnifyingGlassIcon className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400\" />\r\n              <input\r\n                type=\"text\"\r\n                placeholder=\"Buscar por nombre o RUT...\"\r\n                value={searchTerm}\r\n                onChange={(e) => setSearchTerm(e.target.value)}\r\n                className=\"pl-10 pr-4 py-2 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Filtros */}\r\n          <div className=\"flex items-center space-x-4\">\r\n            <div>\r\n              <select\r\n                value={statusFilter}\r\n                onChange={(e) => setStatusFilter(e.target.value)}\r\n                className=\"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n              >\r\n                <option value=\"all\">Todos los estados</option>\r\n                <option value=\"active\">Activas</option>\r\n                <option value=\"suspended\">Suspendidas</option>\r\n                <option value=\"trial\">En prueba</option>\r\n              </select>\r\n            </div>\r\n\r\n            <div>\r\n              <select\r\n                value={sortBy}\r\n                onChange={(e) => setSortBy(e.target.value)}\r\n                className=\"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n              >\r\n                <option value=\"created_at\">Fecha de creaci√≥n</option>\r\n                <option value=\"name\">Nombre</option>\r\n                <option value=\"usage_stats.totalMessages\">Mensajes enviados</option>\r\n                <option value=\"usage_stats.totalCost\">Costo total</option>\r\n                <option value=\"monthly_limit\">L√≠mite mensual</option>\r\n              </select>\r\n            </div>\r\n\r\n            <button\r\n              onClick={() => setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')}\r\n              className=\"p-2 border border-gray-300 rounded-lg hover:bg-gray-50\"\r\n            >\r\n              {sortOrder === 'asc' ? '‚Üë' : '‚Üì'}\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Lista de Empresas */}\r\n      <div className=\"bg-white rounded-lg shadow overflow-hidden\">\r\n        <div className=\"overflow-x-auto\">\r\n          <table className=\"min-w-full divide-y divide-gray-200\">\r\n            <thead className=\"bg-gray-50\">\r\n              <tr>\r\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                  Empresa\r\n                </th>\r\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                  Estado\r\n                </th>\r\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                  Uso\r\n                </th>\r\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                  Mensajes\r\n                </th>\r\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                  Costo\r\n                </th>\r\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                  Canales\r\n                </th>\r\n                <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                  Acciones\r\n                </th>\r\n              </tr>\r\n            </thead>\r\n            <tbody className=\"bg-white divide-y divide-gray-200\">\r\n              {sortedCompanies.map((company) => {\r\n                const usageStatus = getUsageStatus(company);\r\n                const dailyPercentage = company.daily_limit > 0 \r\n                  ? ((company.usage_stats?.daily_count || 0) / company.daily_limit) * 100 \r\n                  : 0;\r\n                const monthlyPercentage = company.monthly_limit > 0 \r\n                  ? ((company.usage_stats?.monthly_count || 0) / company.monthly_limit) * 100 \r\n                  : 0;\r\n\r\n                return (\r\n                  <tr key={company.id} className=\"hover:bg-gray-50\">\r\n                    <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                      <div>\r\n                        <div className=\"text-sm font-medium text-gray-900\">{company.name}</div>\r\n                        <div className=\"text-sm text-gray-500\">{company.rut}</div>\r\n                        <div className=\"text-xs text-gray-400\">{formatDate(company.created_at)}</div>\r\n                      </div>\r\n                    </td>\r\n\r\n                    <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                      {getStatusBadge(company.status)}\r\n                    </td>\r\n\r\n                    <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                      <div className=\"space-y-1\">\r\n                        <div className=\"flex items-center\">\r\n                          <span className=\"text-xs text-gray-500 mr-2\">Diario:</span>\r\n                          <div className=\"flex-1 bg-gray-200 rounded-full h-2\">\r\n                            <div \r\n                              className={`h-2 rounded-full bg-${usageStatus.color}-500`}\r\n                              style={{ width: `${Math.min(dailyPercentage, 100)}%` }}\r\n                            ></div>\r\n                          </div>\r\n                          <span className=\"text-xs text-gray-700 ml-2\">\r\n                            {company.usage_stats?.daily_count || 0}/{company.daily_limit}\r\n                          </span>\r\n                        </div>\r\n                        <div className=\"flex items-center\">\r\n                          <span className=\"text-xs text-gray-500 mr-2\">Mensual:</span>\r\n                          <div className=\"flex-1 bg-gray-200 rounded-full h-2\">\r\n                            <div \r\n                              className={`h-2 rounded-full bg-${usageStatus.color}-500`}\r\n                              style={{ width: `${Math.min(monthlyPercentage, 100)}%` }}\r\n                            ></div>\r\n                          </div>\r\n                          <span className=\"text-xs text-gray-700 ml-2\">\r\n                            {company.usage_stats?.monthly_count || 0}/{company.monthly_limit}\r\n                          </span>\r\n                        </div>\r\n                      </div>\r\n                    </td>\r\n\r\n                    <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                      <div className=\"text-sm text-gray-900\">\r\n                        {formatNumber(company.usage_stats?.totalMessages || 0)}\r\n                      </div>\r\n                      <div className=\"text-xs text-gray-500\">\r\n                        {formatNumber(company.usage_stats?.totalRecipients || 0)} destinatarios\r\n                      </div>\r\n                    </td>\r\n\r\n                    <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                      <div className=\"text-sm text-gray-900\">\r\n                        {formatCurrency(company.usage_stats?.totalCost || 0)}\r\n                      </div>\r\n                      <div className=\"text-xs text-gray-500\">\r\n                        ${company.message_cost || 0} por mensaje\r\n                      </div>\r\n                    </td>\r\n\r\n                    <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                      <div className=\"flex space-x-1\">\r\n                        {company.email_enabled && <EnvelopeIcon className=\"h-4 w-4 text-green-500\" title=\"Email\" />}\r\n                        {company.sms_enabled && <PhoneIcon className=\"h-4 w-4 text-blue-500\" title=\"SMS\" />}\r\n                        {company.telegram_enabled && <ChatBubbleLeftRightIcon className=\"h-4 w-4 text-blue-400\" title=\"Telegram\" />}\r\n                        {company.whatsapp_enabled && <ChatBubbleLeftRightIcon className=\"h-4 w-4 text-green-600\" title=\"WhatsApp\" />}\r\n                        {company.groq_enabled && <ChartBarIcon className=\"h-4 w-4 text-purple-500\" title=\"Groq AI\" />}\r\n                      </div>\r\n                    </td>\r\n\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-right text-sm font-medium\">\r\n                      <div className=\"flex items-center justify-end space-x-2\">\r\n                        <button\r\n                          onClick={() => {\r\n                            setSelectedCompany(company);\r\n                            setShowDetailsModal(true);\r\n                          }}\r\n                          className=\"text-gray-400 hover:text-gray-600\"\r\n                          title=\"Ver detalles\"\r\n                        >\r\n                          <EyeIcon className=\"h-4 w-4\" />\r\n                        </button>\r\n                        <button\r\n                          onClick={() => {\r\n                            setSelectedCompany(company);\r\n                            setShowEditModal(true);\r\n                          }}\r\n                          className=\"text-blue-400 hover:text-blue-600\"\r\n                          title=\"Editar\"\r\n                        >\r\n                          <PencilIcon className=\"h-4 w-4\" />\r\n                        </button>\r\n                        <button\r\n                          onClick={() => {\r\n                            setSelectedCompany(company);\r\n                            setShowBillingModal(true);\r\n                          }}\r\n                          className=\"text-green-400 hover:text-green-600\"\r\n                          title=\"Facturaci√≥n\"\r\n                        >\r\n                          <CreditCardIcon className=\"h-4 w-4\" />\r\n                        </button>\r\n                        <button\r\n                          onClick={() => handleToggleCompanyStatus(company)}\r\n                          className={`${\r\n                            company.status === 'active' ? 'text-red-400 hover:text-red-600' : 'text-green-400 hover:text-green-600'\r\n                          }`}\r\n                          title={company.status === 'active' ? 'Suspender' : 'Reactivar'}\r\n                        >\r\n                          {company.status === 'active' ? <ExclamationTriangleIcon className=\"h-4 w-4\" /> : <CheckCircleIcon className=\"h-4 w-4\" />}\r\n                        </button>\r\n                      </div>\r\n                    </td>\r\n                  </tr>\r\n                );\r\n              })}\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n\r\n        {companies.length === 0 && (\r\n          <div className=\"text-center py-12\">\r\n            <BuildingOfficeIcon className=\"mx-auto h-12 w-12 text-gray-400\" />\r\n            <h3 className=\"mt-2 text-sm font-medium text-gray-900\">No hay empresas</h3>\r\n            <p className=\"mt-1 text-sm text-gray-500\">\r\n              {searchTerm || statusFilter !== 'all' \r\n                ? 'No se encontraron empresas con los filtros seleccionados' \r\n                : 'Comienza creando tu primera empresa cliente'\r\n              }\r\n            </p>\r\n            {!searchTerm && statusFilter === 'all' && (\r\n              <div className=\"mt-6\">\r\n                <button\r\n                  onClick={() => setShowCreateModal(true)}\r\n                  className=\"inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700\"\r\n                >\r\n                  <PlusIcon className=\"h-4 w-4 mr-2\" />\r\n                  Crear Empresa\r\n                </button>\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Modales */}\r\n      {showCreateModal && (\r\n        <CreateCompanyModal\r\n          onClose={() => setShowCreateModal(false)}\r\n          onSave={handleCreateCompany}\r\n        />\r\n      )}\r\n\r\n      {showEditModal && selectedCompany && (\r\n        <EditCompanyModal\r\n          company={selectedCompany}\r\n          onClose={() => setShowEditModal(false)}\r\n          onSave={handleEditCompany}\r\n        />\r\n      )}\r\n\r\n      {showDetailsModal && selectedCompany && (\r\n        <CompanyDetailsModal\r\n          company={selectedCompany}\r\n          onClose={() => setShowDetailsModal(false)}\r\n        />\r\n      )}\r\n\r\n      {showBillingModal && selectedCompany && (\r\n        <BillingModal\r\n          company={selectedCompany}\r\n          onClose={() => setShowBillingModal(false)}\r\n          onGenerateInvoice={handleGenerateInvoice}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\n// Componentes de modales (placeholders)\r\nconst CreateCompanyModal = ({ onClose, onSave }) => {\r\n  const [formData, setFormData] = useState({\r\n    name: '',\r\n    rut: '',\r\n    contact_email: '',\r\n    contact_phone: '',\r\n    monthlyLimit: 1000,\r\n    dailyLimit: 50,\r\n    messageCost: 0.0525,\r\n    billingCycle: 'monthly',\r\n    billingEmail: ''\r\n  });\r\n\r\n  const handleSubmit = (e) => {\r\n    e.preventDefault();\r\n    onSave(formData);\r\n  };\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\r\n      <div className=\"bg-white rounded-lg p-6 w-full max-w-2xl max-h-screen overflow-y-auto\">\r\n        <h2 className=\"text-xl font-bold mb-4\">Nueva Empresa</h2>\r\n        <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-gray-700\">Nombre de la empresa</label>\r\n            <input\r\n              type=\"text\"\r\n              required\r\n              value={formData.name}\r\n              onChange={(e) => setFormData({...formData, name: e.target.value})}\r\n              className=\"mt-1 block w-full border border-gray-300 rounded-md px-3 py-2\"\r\n            />\r\n          </div>\r\n          \r\n          <div>\r\n            <label className=\"block text-sm font-medium text-gray-700\">RUT</label>\r\n            <input\r\n              type=\"text\"\r\n              required\r\n              value={formData.rut}\r\n              onChange={(e) => setFormData({...formData, rut: e.target.value})}\r\n              className=\"mt-1 block w-full border border-gray-300 rounded-md px-3 py-2\"\r\n            />\r\n          </div>\r\n          \r\n          <div>\r\n            <label className=\"block text-sm font-medium text-gray-700\">Email de contacto</label>\r\n            <input\r\n              type=\"email\"\r\n              required\r\n              value={formData.contact_email}\r\n              onChange={(e) => setFormData({...formData, contact_email: e.target.value})}\r\n              className=\"mt-1 block w-full border border-gray-300 rounded-md px-3 py-2\"\r\n            />\r\n          </div>\r\n          \r\n          <div className=\"grid grid-cols-2 gap-4\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700\">L√≠mite mensual</label>\r\n              <input\r\n                type=\"number\"\r\n                required\r\n                value={formData.monthlyLimit}\r\n                onChange={(e) => setFormData({...formData, monthlyLimit: parseInt(e.target.value)})}\r\n                className=\"mt-1 block w-full border border-gray-300 rounded-md px-3 py-2\"\r\n              />\r\n            </div>\r\n            \r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700\">L√≠mite diario</label>\r\n              <input\r\n                type=\"number\"\r\n                required\r\n                value={formData.dailyLimit}\r\n                onChange={(e) => setFormData({...formData, dailyLimit: parseInt(e.target.value)})}\r\n                className=\"mt-1 block w-full border border-gray-300 rounded-md px-3 py-2\"\r\n              />\r\n            </div>\r\n          </div>\r\n          \r\n          <div className=\"flex justify-end space-x-3 pt-4\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={onClose}\r\n              className=\"px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50\"\r\n            >\r\n              Cancelar\r\n            </button>\r\n            <button\r\n              type=\"submit\"\r\n              className=\"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700\"\r\n            >\r\n              Crear Empresa\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst EditCompanyModal = ({ company, onClose, onSave }) => {\r\n  const [formData, setFormData] = useState({\r\n    name: company.name,\r\n    rut: company.rut,\r\n    contact_email: company.contact_email,\r\n    contact_phone: company.contact_phone,\r\n    monthly_limit: company.monthly_limit,\r\n    daily_limit: company.daily_limit,\r\n    message_cost: company.message_cost,\r\n    billing_cycle: company.billing_cycle,\r\n    billing_email: company.billing_email\r\n  });\r\n\r\n  const handleSubmit = (e) => {\r\n    e.preventDefault();\r\n    onSave(company.id, formData);\r\n  };\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\r\n      <div className=\"bg-white rounded-lg p-6 w-full max-w-2xl max-h-screen overflow-y-auto\">\r\n        <h2 className=\"text-xl font-bold mb-4\">Editar Empresa</h2>\r\n        <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-gray-700\">Nombre de la empresa</label>\r\n            <input\r\n              type=\"text\"\r\n              required\r\n              value={formData.name}\r\n              onChange={(e) => setFormData({...formData, name: e.target.value})}\r\n              className=\"mt-1 block w-full border border-gray-300 rounded-md px-3 py-2\"\r\n            />\r\n          </div>\r\n          \r\n          <div>\r\n            <label className=\"block text-sm font-medium text-gray-700\">Email de contacto</label>\r\n            <input\r\n              type=\"email\"\r\n              required\r\n              value={formData.contact_email}\r\n              onChange={(e) => setFormData({...formData, contact_email: e.target.value})}\r\n              className=\"mt-1 block w-full border border-gray-300 rounded-md px-3 py-2\"\r\n            />\r\n          </div>\r\n          \r\n          <div className=\"grid grid-cols-2 gap-4\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700\">L√≠mite mensual</label>\r\n              <input\r\n                type=\"number\"\r\n                required\r\n                value={formData.monthly_limit}\r\n                onChange={(e) => setFormData({...formData, monthly_limit: parseInt(e.target.value)})}\r\n                className=\"mt-1 block w-full border border-gray-300 rounded-md px-3 py-2\"\r\n              />\r\n            </div>\r\n            \r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700\">L√≠mite diario</label>\r\n              <input\r\n                type=\"number\"\r\n                required\r\n                value={formData.daily_limit}\r\n                onChange={(e) => setFormData({...formData, daily_limit: parseInt(e.target.value)})}\r\n                className=\"mt-1 block w-full border border-gray-300 rounded-md px-3 py-2\"\r\n              />\r\n            </div>\r\n          </div>\r\n          \r\n          <div className=\"flex justify-end space-x-3 pt-4\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={onClose}\r\n              className=\"px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50\"\r\n            >\r\n              Cancelar\r\n            </button>\r\n            <button\r\n              type=\"submit\"\r\n              className=\"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700\"\r\n            >\r\n              Guardar Cambios\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst CompanyDetailsModal = ({ company, onClose }) => {\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\r\n      <div className=\"bg-white rounded-lg p-6 w-full max-w-4xl max-h-screen overflow-y-auto\">\r\n        <h2 className=\"text-xl font-bold mb-4\">Detalles de {company.name}</h2>\r\n        {/* Contenido del modal de detalles */}\r\n        <div className=\"flex justify-end pt-4\">\r\n          <button\r\n            onClick={onClose}\r\n            className=\"px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700\"\r\n          >\r\n            Cerrar\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst BillingModal = ({ company, onClose, onGenerateInvoice }) => {\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\r\n      <div className=\"bg-white rounded-lg p-6 w-full max-w-2xl max-h-screen overflow-y-auto\">\r\n        <h2 className=\"text-xl font-bold mb-4\">Facturaci√≥n - {company.name}</h2>\r\n        {/* Contenido del modal de facturaci√≥n */}\r\n        <div className=\"flex justify-end space-x-3 pt-4\">\r\n          <button\r\n            onClick={() => onGenerateInvoice(company.id)}\r\n            className=\"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700\"\r\n          >\r\n            Generar Factura\r\n          </button>\r\n          <button\r\n            onClick={onClose}\r\n            className=\"px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700\"\r\n          >\r\n            Cerrar\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default MultiCompanyDashboard;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\analytics\\AnalyticsDashboard.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'refreshInterval' is assigned a value but never used.","line":53,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":53,"endColumn":25},{"ruleId":"no-unused-vars","severity":1,"message":"'setRefreshInterval' is assigned a value but never used.","line":53,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":53,"endColumn":45},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'channelOptions'. Either include it or remove the dependency array.","line":205,"column":6,"nodeType":"ArrayExpression","endLine":205,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [channelOptions, realTimeData.channels]","fix":{"range":[6447,6461],"text":"[channelOptions, realTimeData.channels]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'channelOptions'. Either include it or remove the dependency array.","line":226,"column":6,"nodeType":"ArrayExpression","endLine":226,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [channelOptions, realTimeData.channels]","fix":{"range":[7195,7209],"text":"[channelOptions, realTimeData.channels]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useMemo, useCallback } from 'react'\r\nimport {\r\n  ChartBarIcon,\r\n  UsersIcon,\r\n  ArrowTrendingUpIcon,\r\n  ArrowTrendingDownIcon,\r\n  DocumentTextIcon,\r\n  LightBulbIcon,\r\n  ExclamationTriangleIcon,\r\n  CheckCircleIcon,\r\n  SparklesIcon\r\n} from '@heroicons/react/24/outline'\r\nimport { \r\n  Chart as ChartJS, \r\n  CategoryScale, \r\n  LinearScale, \r\n  PointElement, \r\n  LineElement, \r\n  BarElement, \r\n  Title, \r\n  Tooltip, \r\n  Legend, \r\n  ArcElement,\r\n  RadialLinearScale\r\n} from 'chart.js'\r\nimport { Line, Bar, Radar, Doughnut } from 'react-chartjs-2'\r\nimport realTimeStatsService from '../../services/realTimeStatsService.js'\r\nimport companyReportsService from '../../services/companyReportsService.js'\r\nimport analyticsInsightsService from '../../services/analyticsInsightsService.js'\r\n\r\n// Registrar componentes de Chart.js\r\nChartJS.register(\r\n  CategoryScale,\r\n  LinearScale,\r\n  PointElement,\r\n  LineElement,\r\n  BarElement,\r\n  Title,\r\n  Tooltip,\r\n  Legend,\r\n  ArcElement,\r\n  RadialLinearScale\r\n)\r\n\r\nconst AnalyticsDashboard = ({ companyId = null, isComparative = false }) => {\r\n  const [loading, setLoading] = useState(true)\r\n  const [error, setError] = useState(null)\r\n  const [dateRange, setDateRange] = useState('7d')\r\n  const [selectedChannels, setSelectedChannels] = useState([])\r\n  const [realTimeData, setRealTimeData] = useState(null)\r\n  const [companyReport, setCompanyReport] = useState(null)\r\n  const [insights, setInsights] = useState(null)\r\n  const [refreshInterval, setRefreshInterval] = useState(null)\r\n\r\n  // Opciones de rango de fechas\r\n  const dateRangeOptions = [\r\n    { value: '1d', label: '√öltimas 24 horas' },\r\n    { value: '7d', label: '√öltimos 7 d√≠as' },\r\n    { value: '30d', label: '√öltimos 30 d√≠as' },\r\n    { value: '90d', label: '√öltimos 90 d√≠as' }\r\n  ]\r\n\r\n  // Opciones de canales\r\n  const channelOptions = [\r\n    { value: 'email', label: 'Email', color: '#3B82F6' },\r\n    { value: 'sms', label: 'SMS', color: '#10B981' },\r\n    { value: 'telegram', label: 'Telegram', color: '#8B5CF6' },\r\n    { value: 'whatsapp', label: 'WhatsApp', color: '#25D366' },\r\n    { value: 'groq', label: 'Groq AI', color: '#F59E0B' }\r\n  ]\r\n\r\n  // Funci√≥n para cargar todos los datos de analytics\r\n  const loadAnalyticsData = useCallback(async () => {\r\n    try {\r\n      setLoading(true)\r\n      setError(null)\r\n\r\n      // Cargar datos en paralelo\r\n      const promises = []\r\n\r\n      // Estad√≠sticas en tiempo real\r\n      promises.push(\r\n        realTimeStatsService.getRealTimeStats({\r\n          companyId,\r\n          dateRange,\r\n          channels: selectedChannels.length > 0 ? selectedChannels : null,\r\n          includeComparison: true\r\n        })\r\n      )\r\n\r\n      // Reportes de empresa (si hay companyId)\r\n      if (companyId && !isComparative) {\r\n        promises.push(\r\n          companyReportsService.generateCompanyReport(companyId, {\r\n            dateRange,\r\n            includeComparison: true,\r\n            includeInsights: true,\r\n            includeEmployeeDetails: true\r\n          })\r\n        )\r\n      }\r\n\r\n      // Insights con IA\r\n      promises.push(\r\n        analyticsInsightsService.generateInsights({\r\n          dateRange,\r\n          companyId,\r\n          channels: selectedChannels\r\n        })\r\n      )\r\n\r\n      const results = await Promise.all(promises)\r\n\r\n      setRealTimeData(results[0])\r\n      if (results[1]) setCompanyReport(results[1])\r\n      setInsights(results[results.length - 1])\r\n\r\n    } catch (err) {\r\n      console.error('Error cargando datos de analytics:', err)\r\n      setError('Error al cargar los datos de analytics')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [companyId, dateRange, selectedChannels, isComparative])\r\n\r\n  // Funci√≥n para cargar estad√≠sticas en tiempo real\r\n  const loadRealTimeStats = useCallback(async () => {\r\n    try {\r\n      const stats = await realTimeStatsService.getRealTimeStats({\r\n        companyId,\r\n        dateRange,\r\n        channels: selectedChannels.length > 0 ? selectedChannels : null\r\n      })\r\n      setRealTimeData(stats)\r\n    } catch (err) {\r\n      console.error('Error cargando estad√≠sticas en tiempo real:', err)\r\n    }\r\n  }, [companyId, dateRange, selectedChannels])\r\n\r\n  // Cargar datos iniciales\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\nuseEffect(() => {\r\n    loadAnalyticsData()\r\n  }, [loadAnalyticsData])\r\n\r\n  // Configurar actualizaci√≥n en tiempo real\r\n  useEffect(() => {\r\n    const interval = setInterval(() => {\r\n      loadRealTimeStats()\r\n    }, 30000) // Actualizar cada 30 segundos\r\n\r\n    return () => clearInterval(interval)\r\n  }, [loadRealTimeStats])\r\n\r\n  // Datos para gr√°ficos de l√≠neas - Tendencias temporales\r\n  const temporalChartData = useMemo(() => {\r\n    if (!realTimeData?.temporal?.hourly_distribution) return null\r\n\r\n    const hours = realTimeData.temporal.hourly_distribution.map(item => item.hour)\r\n    const counts = realTimeData.temporal.hourly_distribution.map(item => item.count)\r\n\r\n    return {\r\n      labels: hours,\r\n      datasets: [\r\n        {\r\n          label: 'Mensajes enviados',\r\n          data: counts,\r\n          borderColor: 'rgb(59, 130, 246)',\r\n          backgroundColor: 'rgba(59, 130, 246, 0.1)',\r\n          tension: 0.4,\r\n          fill: true\r\n        }\r\n      ]\r\n    }\r\n  }, [realTimeData])\r\n\r\n  // Datos para gr√°fico de barras - Rendimiento por canal\r\n  const channelPerformanceData = useMemo(() => {\r\n    if (!realTimeData?.channels) return null\r\n\r\n    const channels = Object.keys(realTimeData.channels)\r\n    const deliveryRates = channels.map(channel => parseFloat(realTimeData.channels[channel].delivery_rate) || 0)\r\n    const engagementRates = channels.map(channel => parseFloat(realTimeData.channels[channel].engagement_rate) || 0)\r\n\r\n    return {\r\n      labels: channels.map(channel => channelOptions.find(opt => opt.value === channel)?.label || channel),\r\n      datasets: [\r\n        {\r\n          label: 'Tasa de entrega (%)',\r\n          data: deliveryRates,\r\n          backgroundColor: 'rgba(34, 197, 94, 0.8)',\r\n          borderColor: 'rgb(34, 197, 94)',\r\n          borderWidth: 1\r\n        },\r\n        {\r\n          label: 'Tasa de engagement (%)',\r\n          data: engagementRates,\r\n          backgroundColor: 'rgba(168, 85, 247, 0.8)',\r\n          borderColor: 'rgb(168, 85, 247)',\r\n          borderWidth: 1\r\n        }\r\n      ]\r\n    }\r\n  }, [realTimeData])\r\n\r\n  // Datos para gr√°fico circular - Distribuci√≥n de canales\r\n  const channelDistributionData = useMemo(() => {\r\n    if (!realTimeData?.channels) return null\r\n\r\n    const channels = Object.keys(realTimeData.channels)\r\n    const volumes = channels.map(channel => realTimeData.channels[channel].total || 0)\r\n    const colors = channels.map(channel => channelOptions.find(opt => opt.value === channel)?.color || '#6B7280')\r\n\r\n    return {\r\n      labels: channels.map(channel => channelOptions.find(opt => opt.value === channel)?.label || channel),\r\n      datasets: [\r\n        {\r\n          data: volumes,\r\n          backgroundColor: colors,\r\n          borderWidth: 2,\r\n          borderColor: '#ffffff'\r\n        }\r\n      ]\r\n    }\r\n  }, [realTimeData])\r\n\r\n  // Datos para gr√°fico de radar - KPIs\r\n  const kpiRadarData = useMemo(() => {\r\n    if (!realTimeData?.performance) return null\r\n\r\n    const kpis = realTimeData.performance\r\n    const metrics = [\r\n      { label: 'Eficiencia', value: parseFloat(kpis.efficiency) || 0 },\r\n      { label: 'Fiabilidad', value: parseFloat(kpis.reliability) || 0 },\r\n      { label: 'Velocidad', value: parseFloat(kpis.speed) || 0 },\r\n      { label: 'Rendimiento', value: parseFloat(kpis.performance_score) || 0 }\r\n    ]\r\n\r\n    return {\r\n      labels: metrics.map(m => m.label),\r\n      datasets: [\r\n        {\r\n          label: 'KPIs Actuales',\r\n          data: metrics.map(m => m.value),\r\n          backgroundColor: 'rgba(59, 130, 246, 0.2)',\r\n          borderColor: 'rgb(59, 130, 246)',\r\n          pointBackgroundColor: 'rgb(59, 130, 246)',\r\n          pointBorderColor: '#fff',\r\n          pointHoverBackgroundColor: '#fff',\r\n          pointHoverBorderColor: 'rgb(59, 130, 246)'\r\n        }\r\n      ]\r\n    }\r\n  }, [realTimeData])\r\n\r\n  // Opciones de configuraci√≥n para gr√°ficos\r\n  const chartOptions = {\r\n    responsive: true,\r\n    maintainAspectRatio: false,\r\n    plugins: {\r\n      legend: {\r\n        position: 'top',\r\n      },\r\n      tooltip: {\r\n        mode: 'index',\r\n        intersect: false,\r\n        backgroundColor: 'rgba(0, 0, 0, 0.8)',\r\n        titleColor: '#ffffff',\r\n        bodyColor: '#ffffff',\r\n        borderColor: 'rgba(255, 255, 255, 0.1)',\r\n        borderWidth: 1\r\n      }\r\n    },\r\n    scales: {\r\n      y: {\r\n        beginAtZero: true,\r\n        grid: {\r\n          color: 'rgba(0, 0, 0, 0.05)'\r\n        }\r\n      },\r\n      x: {\r\n        grid: {\r\n          display: false\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // Tarjetas de m√©tricas principales\r\n  const MetricCard = ({ title, value, icon: Icon, trend, color = 'blue', subtitle }) => {\r\n    const colorClasses = {\r\n      blue: 'bg-blue-50 text-blue-600 border-blue-200',\r\n      green: 'bg-green-50 text-green-600 border-green-200',\r\n      red: 'bg-red-50 text-red-600 border-red-200',\r\n      yellow: 'bg-yellow-50 text-yellow-600 border-yellow-200',\r\n      purple: 'bg-purple-50 text-purple-600 border-purple-200'\r\n    }\r\n\r\n    return (\r\n      <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <p className=\"text-sm font-medium text-gray-600\">{title}</p>\r\n            <p className=\"text-2xl font-bold text-gray-900 mt-1\">{value}</p>\r\n            {subtitle && <p className=\"text-xs text-gray-500 mt-1\">{subtitle}</p>}\r\n          </div>\r\n          <div className={`p-3 rounded-full ${colorClasses[color]}`}>\r\n            <Icon className=\"w-6 h-6\" />\r\n          </div>\r\n        </div>\r\n        {trend && (\r\n          <div className=\"flex items-center mt-4\">\r\n            {trend > 0 ? (\r\n              <ArrowTrendingUpIcon className=\"w-4 h-4 text-green-500 mr-1\" />\r\n            ) : (\r\n              <ArrowTrendingDownIcon className=\"w-4 h-4 text-red-500 mr-1\" />\r\n            )}\r\n            <span className={`text-sm font-medium ${trend > 0 ? 'text-green-600' : 'text-red-600'}`}>\r\n              {Math.abs(trend)}%\r\n            </span>\r\n            <span className=\"text-sm text-gray-500 ml-1\">vs per√≠odo anterior</span>\r\n          </div>\r\n        )}\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Componente de insight\r\n  const InsightCard = ({ insight, index }) => {\r\n    const getIcon = () => {\r\n      switch (insight.type) {\r\n        case 'positive_trend':\r\n          return <CheckCircleIcon className=\"w-5 h-5 text-green-500\" />\r\n        case 'negative_trend':\r\n          return <ExclamationTriangleIcon className=\"w-5 h-5 text-red-500\" />\r\n        case 'recommendation':\r\n          return <LightBulbIcon className=\"w-5 h-5 text-yellow-500\" />\r\n        default:\r\n          return <SparklesIcon className=\"w-5 h-5 text-blue-500\" />\r\n      }\r\n    }\r\n\r\n    return (\r\n      <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow\">\r\n        <div className=\"flex items-start space-x-3\">\r\n          <div className=\"flex-shrink-0 mt-1\">\r\n            {getIcon()}\r\n          </div>\r\n          <div className=\"flex-1\">\r\n            <h4 className=\"text-sm font-semibold text-gray-900\">{insight.title}</h4>\r\n            <p className=\"text-sm text-gray-600 mt-1\">{insight.description}</p>\r\n            {insight.recommendation && (\r\n              <p className=\"text-xs text-blue-600 mt-2 font-medium\">üí° {insight.recommendation}</p>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center h-64\">\r\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600\"></div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\r\n        <div className=\"flex items-center\">\r\n          <ExclamationTriangleIcon className=\"w-5 h-5 text-red-500 mr-2\" />\r\n          <span className=\"text-red-700\">{error}</span>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Controles superiores */}\r\n      <div className=\"flex flex-wrap items-center justify-between gap-4\">\r\n        <div className=\"flex items-center space-x-4\">\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">Per√≠odo</label>\r\n            <select\r\n              value={dateRange}\r\n              onChange={(e) => setDateRange(e.target.value)}\r\n              className=\"block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm\"\r\n            >\r\n              {dateRangeOptions.map(option => (\r\n                <option key={option.value} value={option.value}>\r\n                  {option.label}\r\n                </option>\r\n              ))}\r\n            </select>\r\n          </div>\r\n\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">Canales</label>\r\n            <div className=\"flex flex-wrap gap-2\">\r\n              {channelOptions.map(channel => (\r\n                <label key={channel.value} className=\"flex items-center\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    checked={selectedChannels.includes(channel.value)}\r\n                    onChange={(e) => {\r\n                      if (e.target.checked) {\r\n                        setSelectedChannels([...selectedChannels, channel.value])\r\n                      } else {\r\n                        setSelectedChannels(selectedChannels.filter(c => c !== channel.value))\r\n                      }\r\n                    }}\r\n                    className=\"rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500\"\r\n                  />\r\n                  <span className=\"ml-2 text-sm text-gray-700\">{channel.label}</span>\r\n                </label>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <button\r\n          onClick={loadAnalyticsData}\r\n          className=\"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500\"\r\n        >\r\n          <ChartBarIcon className=\"w-4 h-4 mr-2\" />\r\n          Actualizar\r\n        </button>\r\n      </div>\r\n\r\n      {/* M√©tricas principales */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\r\n        <MetricCard\r\n          title=\"Tasa de Entrega\"\r\n          value={`${realTimeData?.delivery?.delivery_rate || 0}%`}\r\n          icon={ChartBarIcon}\r\n          trend={realTimeData?.comparison?.delivery_change?.percentage}\r\n          color=\"green\"\r\n          subtitle={`${realTimeData?.delivery?.delivered_count || 0} mensajes entregados`}\r\n        />\r\n        <MetricCard\r\n          title=\"Tasa de Lectura\"\r\n          value={`${realTimeData?.engagement?.read_rate || 0}%`}\r\n          icon={UsersIcon}\r\n          trend={realTimeData?.comparison?.engagement_change?.percentage}\r\n          color=\"blue\"\r\n          subtitle={`${realTimeData?.engagement?.read_count || 0} mensajes le√≠dos`}\r\n        />\r\n        <MetricCard\r\n          title=\"Engagement Total\"\r\n          value={`${realTimeData?.engagement?.overall_engagement || 0}%`}\r\n          icon={ArrowTrendingUpIcon}\r\n          color=\"purple\"\r\n          subtitle={`${realTimeData?.engagement?.click_count || 0} interacciones`}\r\n        />\r\n        <MetricCard\r\n          title=\"Mensajes Enviados\"\r\n          value={realTimeData?.overview?.total_messages || 0}\r\n          icon={DocumentTextIcon}\r\n          trend={realTimeData?.comparison?.volume_change?.percentage}\r\n          color=\"yellow\"\r\n          subtitle=\"√öltimo per√≠odo\"\r\n        />\r\n      </div>\r\n\r\n      {/* Gr√°ficos principales */}\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n        {/* Gr√°fico de tendencias temporales */}\r\n        <div className=\"bg-white p-6 rounded-lg shadow-sm border border-gray-200\">\r\n          <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Actividad por Hora del D√≠a</h3>\r\n          <div className=\"h-64\">\r\n            {temporalChartData && (\r\n              <Line data={temporalChartData} options={chartOptions} />\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Gr√°fico de rendimiento por canal */}\r\n        <div className=\"bg-white p-6 rounded-lg shadow-sm border border-gray-200\">\r\n          <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Rendimiento por Canal</h3>\r\n          <div className=\"h-64\">\r\n            {channelPerformanceData && (\r\n              <Bar data={channelPerformanceData} options={chartOptions} />\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Gr√°ficos secundarios */}\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n        {/* Distribuci√≥n de canales */}\r\n        <div className=\"bg-white p-6 rounded-lg shadow-sm border border-gray-200\">\r\n          <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Distribuci√≥n de Volumen</h3>\r\n          <div className=\"h-64\">\r\n            {channelDistributionData && (\r\n              <Doughnut \r\n                data={channelDistributionData} \r\n                options={{\r\n                  ...chartOptions,\r\n                  scales: undefined\r\n                }} \r\n              />\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* KPIs Radar */}\r\n        <div className=\"bg-white p-6 rounded-lg shadow-sm border border-gray-200\">\r\n          <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">KPIs de Rendimiento</h3>\r\n          <div className=\"h-64\">\r\n            {kpiRadarData && (\r\n              <Radar \r\n                data={kpiRadarData} \r\n                options={{\r\n                  ...chartOptions,\r\n                  scales: {\r\n                    r: {\r\n                      beginAtZero: true,\r\n                      max: 100,\r\n                      grid: {\r\n                        color: 'rgba(0, 0, 0, 0.05)'\r\n                      }\r\n                    }\r\n                  }\r\n                }} \r\n              />\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Tiempos pico */}\r\n        <div className=\"bg-white p-6 rounded-lg shadow-sm border border-gray-200\">\r\n          <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Tiempos Pico de Actividad</h3>\r\n          <div className=\"space-y-4\">\r\n            <div>\r\n              <h4 className=\"text-sm font-medium text-gray-700 mb-2\">Horas m√°s activas</h4>\r\n              <div className=\"flex flex-wrap gap-2\">\r\n                {realTimeData?.temporal?.peak_hours?.map((hour, index) => (\r\n                  <span key={index} className=\"px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm\">\r\n                    {hour}\r\n                  </span>\r\n                ))}\r\n              </div>\r\n            </div>\r\n            <div>\r\n              <h4 className=\"text-sm font-medium text-gray-700 mb-2\">D√≠as m√°s activos</h4>\r\n              <div className=\"flex flex-wrap gap-2\">\r\n                {realTimeData?.temporal?.peak_days?.map((day, index) => (\r\n                  <span key={index} className=\"px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm\">\r\n                    {day}\r\n                  </span>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Insights generados por IA */}\r\n      {insights && (\r\n        <div className=\"bg-white p-6 rounded-lg shadow-sm border border-gray-200\">\r\n          <div className=\"flex items-center mb-4\">\r\n            <SparklesIcon className=\"w-5 h-5 text-blue-500 mr-2\" />\r\n            <h3 className=\"text-lg font-semibold text-gray-900\">Insights Generados por IA</h3>\r\n          </div>\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n            {insights.insights?.slice(0, 6).map((insight, index) => (\r\n              <InsightCard key={index} insight={insight} />\r\n            ))}\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Reporte de empresa (si aplica) */}\r\n      {companyReport && (\r\n        <div className=\"bg-white p-6 rounded-lg shadow-sm border border-gray-200\">\r\n          <div className=\"flex items-center mb-4\">\r\n            <DocumentTextIcon className=\"w-5 h-5 text-green-500 mr-2\" />\r\n            <h3 className=\"text-lg font-semibold text-gray-900\">Reporte Detallado de Empresa</h3>\r\n          </div>\r\n          \r\n          {/* KPIs de la empresa */}\r\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6\">\r\n            <div className=\"text-center p-4 bg-gray-50 rounded-lg\">\r\n              <p className=\"text-2xl font-bold text-gray-900\">{companyReport.kpis?.overall_score?.toFixed(1) || 0}</p>\r\n              <p className=\"text-sm text-gray-600\">Puntuaci√≥n General</p>\r\n            </div>\r\n            <div className=\"text-center p-4 bg-gray-50 rounded-lg\">\r\n              <p className=\"text-2xl font-bold text-gray-900\">{companyReport.employees?.employee_count || 0}</p>\r\n              <p className=\"text-sm text-gray-600\">Empleados Activos</p>\r\n            </div>\r\n            <div className=\"text-center p-4 bg-gray-50 rounded-lg\">\r\n              <p className=\"text-2xl font-bold text-gray-900\">{companyReport.employees?.engagement_rate || 0}%</p>\r\n              <p className=\"text-sm text-gray-600\">Engagement de Empleados</p>\r\n            </div>\r\n            <div className=\"text-center p-4 bg-gray-50 rounded-lg\">\r\n              <p className=\"text-2xl font-bold text-gray-900\">{companyReport.comparison?.company_ranking?.overall || 'N/A'}</p>\r\n              <p className=\"text-sm text-gray-600\">Ranking General</p>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Recomendaciones */}\r\n          {companyReport.recommendations && companyReport.recommendations.length > 0 && (\r\n            <div>\r\n              <h4 className=\"text-md font-semibold text-gray-900 mb-3\">Recomendaciones</h4>\r\n              <div className=\"space-y-2\">\r\n                {companyReport.recommendations.slice(0, 3).map((rec, index) => (\r\n                  <div key={index} className=\"flex items-start space-x-3 p-3 bg-blue-50 rounded-lg\">\r\n                    <LightBulbIcon className=\"w-5 h-5 text-blue-500 mt-0.5\" />\r\n                    <div>\r\n                      <p className=\"text-sm font-medium text-gray-900\">{rec.title}</p>\r\n                      <p className=\"text-sm text-gray-600\">{rec.description}</p>\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default AnalyticsDashboard","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\analytics\\PredictiveAnalyticsDashboard.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'supabase' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":18},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadAnalyticsData'. Either include it or remove the dependency array.","line":42,"column":6,"nodeType":"ArrayExpression","endLine":42,"endColumn":28,"suggestions":[{"desc":"Update the dependencies array to be: [companyId, loadAnalyticsData, timeRange]","fix":{"range":[1736,1758],"text":"[companyId, loadAnalyticsData, timeRange]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { motion, AnimatePresence } from 'framer-motion';\r\nimport { supabase } from '../../lib/supabase.js';\r\nimport enhancedCommunicationService from '../../services/enhancedCommunicationService.js';\r\nimport companySyncService from '../../services/companySyncService.js';\r\nimport './PredictiveAnalyticsDashboard.css';\r\n\r\nconst PredictiveAnalyticsDashboard = ({ companyId }) => {\r\n  const [stats, setStats] = useState(null);\r\n  const [insights, setInsights] = useState(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState(null);\r\n  const [timeRange, setTimeRange] = useState('7d');\r\n  const [activeMetric, setActiveMetric] = useState(null);\r\n  const [expandedInsight, setExpandedInsight] = useState(null);\r\n\r\n  useEffect(() => {\r\n    loadAnalyticsData();\r\n    \r\n    // Suscribirse a eventos de cambios en empresas\r\n    let unsubscribeId = null\r\n    try {\r\n      if (companySyncService && typeof companySyncService.subscribe === 'function') {\r\n        unsubscribeId = companySyncService.subscribe('companies-updated', (data) => {\r\n          console.log('PredictiveAnalyticsDashboard: Empresas actualizadas, recargando anal√≠ticas...', data)\r\n          loadAnalyticsData()\r\n        })\r\n      }\r\n    } catch (error) {\r\n      console.error('Error al suscribirse a eventos de empresas:', error)\r\n    }\r\n\r\n    return () => {\r\n      if (unsubscribeId && companySyncService && typeof companySyncService.unsubscribe === 'function') {\r\n        try {\r\n          companySyncService.unsubscribe('companies-updated', unsubscribeId)\r\n        } catch (error) {\r\n          console.error('Error al cancelar suscripci√≥n:', error)\r\n        }\r\n      }\r\n    }\r\n  }, [companyId, timeRange]);\r\n\r\n  const loadAnalyticsData = async () => {\r\n    try {\r\n      setLoading(true);\r\n      setError(null);\r\n      \r\n      const [statsData, insightsData] = await Promise.all([\r\n        enhancedCommunicationService.getEnhancedCommunicationStats(),\r\n        enhancedCommunicationService.getPredictiveInsights(companyId || 'default')\r\n      ]);\r\n      \r\n      setStats(statsData);\r\n      setInsights(insightsData);\r\n    } catch (err) {\r\n      console.error('Error cargando anal√≠ticas:', err);\r\n      setError('Error cargando datos de anal√≠ticas');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const getEngagementColor = (score) => {\r\n    if (score >= 0.7) return 'from-emerald-400 to-emerald-600';\r\n    if (score >= 0.5) return 'from-amber-400 to-amber-600';\r\n    return 'from-rose-400 to-rose-600';\r\n  };\r\n\r\n  const getEngagementBgColor = (score) => {\r\n    if (score >= 0.7) return 'bg-emerald-500';\r\n    if (score >= 0.5) return 'bg-amber-500';\r\n    return 'bg-rose-500';\r\n  };\r\n\r\n  const formatPercentage = (value) => {\r\n    return `${(value * 100).toFixed(1)}%`;\r\n  };\r\n\r\n  const metrics = [\r\n    {\r\n      id: 'engagement',\r\n      title: 'Engagement',\r\n      value: formatPercentage(stats?.aiEnhancements?.trends?.averageEngagement || 0.65),\r\n      icon: 'üìä',\r\n      color: getEngagementColor(stats?.aiEnhancements?.trends?.averageEngagement || 0.65),\r\n      bgColor: getEngagementBgColor(stats?.aiEnhancements?.trends?.averageEngagement || 0.65),\r\n      trend: stats?.aiEnhancements?.trends?.engagementTrend === 'increasing' ? 'üìà +12%' : 'üìä Estable',\r\n      description: 'Tasa de interacci√≥n total'\r\n    },\r\n    {\r\n      id: 'optimizations',\r\n      title: 'Optimizaciones',\r\n      value: stats?.aiEnhancements?.totalOptimizations || 24,\r\n      icon: 'üéØ',\r\n      color: 'from-blue-400 to-blue-600',\r\n      bgColor: 'bg-blue-500',\r\n      trend: `Mejora: ${formatPercentage(stats?.aiEnhancements?.averageImprovement || 0.35)}`,\r\n      description: 'Mejoras aplicadas por IA'\r\n    },\r\n    {\r\n      id: 'insights',\r\n      title: 'Insights',\r\n      value: insights?.insights?.length || 8,\r\n      icon: 'üí°',\r\n      color: 'from-purple-400 to-purple-600',\r\n      bgColor: 'bg-purple-500',\r\n      trend: `Confianza: ${formatPercentage(insights?.confidence || 0.82)}`,\r\n      description: 'Descubrimientos inteligentes'\r\n    },\r\n    {\r\n      id: 'effectiveness',\r\n      title: 'Efectividad IA',\r\n      value: formatPercentage(0.87),\r\n      icon: 'üöÄ',\r\n      color: 'from-cyan-400 to-cyan-600',\r\n      bgColor: 'bg-cyan-500',\r\n      trend: insights?.predictive ? 'üîÆ Predictivo' : 'üìä Anal√≠tico',\r\n      description: 'Rendimiento del sistema'\r\n    }\r\n  ];\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 flex items-center justify-center\">\r\n        <motion.div\r\n          initial={{ opacity: 0, scale: 0.9 }}\r\n          animate={{ opacity: 1, scale: 1 }}\r\n          className=\"text-center\"\r\n        >\r\n          <div className=\"relative\">\r\n            <div className=\"w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin\"></div>\r\n            <div className=\"absolute inset-0 w-16 h-16 border-4 border-transparent border-l-purple-600 rounded-full animate-spin animation-delay-150\"></div>\r\n          </div>\r\n          <p className=\"mt-4 text-gray-600 font-medium\">Analizando tendencias...</p>\r\n        </motion.div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 flex items-center justify-center\">\r\n        <motion.div\r\n          initial={{ opacity: 0, y: 20 }}\r\n          animate={{ opacity: 1, y: 0 }}\r\n          className=\"text-center\"\r\n        >\r\n          <div className=\"w-20 h-20 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center\">\r\n            <span className=\"text-3xl\">‚ö†Ô∏è</span>\r\n          </div>\r\n          <p className=\"text-red-600 font-medium mb-4\">{error}</p>\r\n          <button\r\n            onClick={loadAnalyticsData}\r\n            className=\"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors\"\r\n          >\r\n            Reintentar\r\n          </button>\r\n        </motion.div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 p-6\">\r\n      {/* Header Compacto */}\r\n      <motion.div\r\n        initial={{ opacity: 0, y: -20 }}\r\n        animate={{ opacity: 1, y: 0 }}\r\n        className=\"max-w-7xl mx-auto mb-8\"\r\n      >\r\n        <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4\">\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent\">\r\n              ü§ñ An√°lisis Inteligente\r\n            </h1>\r\n            <p className=\"text-gray-600 mt-1\">Insights predictivos en tiempo real</p>\r\n          </div>\r\n          \r\n          <div className=\"flex items-center gap-3\">\r\n            <select\r\n              value={timeRange}\r\n              onChange={(e) => setTimeRange(e.target.value)}\r\n              className=\"px-4 py-2 bg-white/80 backdrop-blur-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm\"\r\n            >\r\n              <option value=\"7d\">√öltimos 7 d√≠as</option>\r\n              <option value=\"30d\">√öltimos 30 d√≠as</option>\r\n              <option value=\"90d\">√öltimos 90 d√≠as</option>\r\n            </select>\r\n            \r\n            <button\r\n              onClick={loadAnalyticsData}\r\n              className=\"p-2 bg-white/80 backdrop-blur-sm border border-gray-200 rounded-lg hover:bg-white transition-colors\"\r\n            >\r\n              üîÑ\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </motion.div>\r\n\r\n      {/* M√©tricas Principales - Grid Compacto */}\r\n      <motion.div\r\n        initial={{ opacity: 0, y: 20 }}\r\n        animate={{ opacity: 1, y: 0 }}\r\n        transition={{ delay: 0.1 }}\r\n        className=\"max-w-7xl mx-auto mb-8\"\r\n      >\r\n        <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n          {metrics.map((metric, index) => (\r\n            <motion.div\r\n              key={metric.id}\r\n              initial={{ opacity: 0, scale: 0.9 }}\r\n              animate={{ opacity: 1, scale: 1 }}\r\n              transition={{ delay: 0.1 + index * 0.05 }}\r\n              whileHover={{ scale: 1.02, y: -2 }}\r\n              onClick={() => setActiveMetric(activeMetric === metric.id ? null : metric.id)}\r\n              className={`relative p-6 bg-white/80 backdrop-blur-sm rounded-2xl border border-gray-100 cursor-pointer transition-all duration-300 ${\r\n                activeMetric === metric.id ? 'ring-2 ring-blue-500 shadow-lg' : 'hover:shadow-md'\r\n              }`}\r\n            >\r\n              <div className=\"flex items-start justify-between mb-4\">\r\n                <div className={`w-12 h-12 rounded-xl bg-gradient-to-r ${metric.color} flex items-center justify-center text-white text-xl`}>\r\n                  {metric.icon}\r\n                </div>\r\n                <div className={`px-2 py-1 rounded-full text-xs font-medium ${metric.bgColor} bg-opacity-10 text-gray-700`}>\r\n                  {metric.trend}\r\n                </div>\r\n              </div>\r\n              \r\n              <div>\r\n                <h3 className=\"text-2xl font-bold text-gray-900 mb-1\">{metric.value}</h3>\r\n                <p className=\"text-sm font-medium text-gray-700 mb-1\">{metric.title}</p>\r\n                <p className=\"text-xs text-gray-500\">{metric.description}</p>\r\n              </div>\r\n\r\n              <AnimatePresence>\r\n                {activeMetric === metric.id && (\r\n                  <motion.div\r\n                    initial={{ opacity: 0, height: 0 }}\r\n                    animate={{ opacity: 1, height: 'auto' }}\r\n                    exit={{ opacity: 0, height: 0 }}\r\n                    className=\"mt-4 pt-4 border-t border-gray-100\"\r\n                  >\r\n                    <div className=\"space-y-2\">\r\n                      <div className=\"flex justify-between text-xs\">\r\n                        <span className=\"text-gray-500\">Progreso</span>\r\n                        <span className=\"font-medium text-gray-700\">{metric.value}</span>\r\n                      </div>\r\n                      <div className=\"w-full bg-gray-200 rounded-full h-2\">\r\n                        <motion.div\r\n                          className={`h-2 rounded-full bg-gradient-to-r ${metric.color}`}\r\n                          initial={{ width: 0 }}\r\n                          animate={{ width: metric.value }}\r\n                          transition={{ duration: 1, ease: \"easeOut\" }}\r\n                        />\r\n                      </div>\r\n                    </div>\r\n                  </motion.div>\r\n                )}\r\n              </AnimatePresence>\r\n            </motion.div>\r\n          ))}\r\n        </div>\r\n      </motion.div>\r\n\r\n      {/* Insights y Recomendaciones - Dise√±o Compacto */}\r\n      <div className=\"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n        {/* Insights Predictivos */}\r\n        <motion.div\r\n          initial={{ opacity: 0, x: -20 }}\r\n          animate={{ opacity: 1, x: 0 }}\r\n          transition={{ delay: 0.2 }}\r\n          className=\"bg-white/80 backdrop-blur-sm rounded-2xl border border-gray-100 p-6\"\r\n        >\r\n          <div className=\"flex items-center justify-between mb-6\">\r\n            <h2 className=\"text-xl font-bold text-gray-900\">üß† Insights Predictivos</h2>\r\n            <span className=\"px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium\">\r\n              {insights?.insights?.length || 0} activos\r\n            </span>\r\n          </div>\r\n\r\n          <div className=\"space-y-3 max-h-96 overflow-y-auto\">\r\n            {insights?.insights?.slice(0, 4).map((insight, index) => (\r\n              <motion.div\r\n                key={index}\r\n                initial={{ opacity: 0, x: -10 }}\r\n                animate={{ opacity: 1, x: 0 }}\r\n                transition={{ delay: 0.3 + index * 0.1 }}\r\n                whileHover={{ scale: 1.02 }}\r\n                onClick={() => setExpandedInsight(expandedInsight === index ? null : index)}\r\n                className=\"p-4 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl border border-purple-100 cursor-pointer transition-all duration-200\"\r\n              >\r\n                <div className=\"flex items-start justify-between mb-2\">\r\n                  <span className=\"text-xs font-medium text-purple-700 bg-purple-100 px-2 py-1 rounded-full\">\r\n                    {insight.tipo?.replace('_', ' ').toUpperCase()}\r\n                  </span>\r\n                  <span className={`text-xs px-2 py-1 rounded-full ${\r\n                    insight.impacto === 'alto' ? 'bg-red-100 text-red-700' :\r\n                    insight.impacto === 'medio' ? 'bg-amber-100 text-amber-700' :\r\n                    'bg-green-100 text-green-700'\r\n                  }`}>\r\n                    {insight.impacto === 'alto' ? 'üî¥ Alto' :\r\n                     insight.impacto === 'medio' ? 'üü° Medio' : 'üü¢ Bajo'}\r\n                  </span>\r\n                </div>\r\n                \r\n                <p className=\"text-sm text-gray-700 font-medium mb-2 line-clamp-2\">\r\n                  {insight.descripcion}\r\n                </p>\r\n\r\n                <AnimatePresence>\r\n                  {expandedInsight === index && (\r\n                    <motion.div\r\n                      initial={{ opacity: 0, height: 0 }}\r\n                      animate={{ opacity: 1, height: 'auto' }}\r\n                      exit={{ opacity: 0, height: 0 }}\r\n                      className=\"text-xs text-gray-600 pt-2 border-t border-purple-100\"\r\n                    >\r\n                      <p>Este insight fue generado mediante an√°lisis avanzado de patrones de comunicaci√≥n y comportamiento predictivo.</p>\r\n                    </motion.div>\r\n                  )}\r\n                </AnimatePresence>\r\n              </motion.div>\r\n            ))}\r\n          </div>\r\n        </motion.div>\r\n\r\n        {/* Acciones Recomendadas */}\r\n        <motion.div\r\n          initial={{ opacity: 0, x: 20 }}\r\n          animate={{ opacity: 1, x: 0 }}\r\n          transition={{ delay: 0.3 }}\r\n          className=\"bg-white/80 backdrop-blur-sm rounded-2xl border border-gray-100 p-6\"\r\n        >\r\n          <div className=\"flex items-center justify-between mb-6\">\r\n            <h2 className=\"text-xl font-bold text-gray-900\">‚ö° Acciones Recomendadas</h2>\r\n            <span className=\"px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium\">\r\n              {stats?.aiEnhancements?.trends?.recommendedActions?.length || 0} pendientes\r\n            </span>\r\n          </div>\r\n\r\n          <div className=\"space-y-3 max-h-96 overflow-y-auto\">\r\n            {stats?.aiEnhancements?.trends?.recommendedActions?.slice(0, 4).map((action, index) => (\r\n              <motion.div\r\n                key={index}\r\n                initial={{ opacity: 0, x: 10 }}\r\n                animate={{ opacity: 1, x: 0 }}\r\n                transition={{ delay: 0.4 + index * 0.1 }}\r\n                whileHover={{ scale: 1.02 }}\r\n                className=\"p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl border border-blue-100 transition-all duration-200\"\r\n              >\r\n                <div className=\"flex items-start gap-3\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    id={`action-${index}`}\r\n                    className=\"mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500\"\r\n                  />\r\n                  <label htmlFor={`action-${index}`} className=\"text-sm text-gray-700 font-medium cursor-pointer flex-1\">\r\n                    {action}\r\n                  </label>\r\n                </div>\r\n              </motion.div>\r\n            ))}\r\n          </div>\r\n\r\n          <motion.button\r\n            whileHover={{ scale: 1.02 }}\r\n            whileTap={{ scale: 0.98 }}\r\n            className=\"w-full mt-6 px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-medium hover:from-blue-700 hover:to-purple-700 transition-all duration-200\"\r\n          >\r\n            Aplicar Acciones Seleccionadas\r\n          </motion.button>\r\n        </motion.div>\r\n      </div>\r\n\r\n      {/* Footer Compacto */}\r\n      <motion.div\r\n        initial={{ opacity: 0 }}\r\n        animate={{ opacity: 1 }}\r\n        transition={{ delay: 0.5 }}\r\n        className=\"max-w-7xl mx-auto mt-8 text-center text-xs text-gray-500\"\r\n      >\r\n        √öltima actualizaci√≥n: {new Date().toLocaleString('es-CL')}\r\n      </motion.div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default PredictiveAnalyticsDashboard;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\auth\\ForgotPassword.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'LoadingSpinner' is defined but never used.","line":5,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react'\r\nimport { Link } from 'react-router-dom'\r\nimport { supabase } from '../../lib/supabase.js'\r\nimport { EnvelopeIcon, ArrowLeftIcon } from '@heroicons/react/24/outline'\r\nimport LoadingSpinner from '../common/LoadingSpinner.js'\r\nimport toast from 'react-hot-toast'\r\n\r\nconst ForgotPassword = () => {\r\n  const [email, setEmail] = useState('')\r\n  const [isLoading, setIsLoading] = useState(false)\r\n  const [emailSent, setEmailSent] = useState(false)\r\n  const [errors, setErrors] = useState({})\r\n\r\n  const validateEmail = (email) => {\r\n    const emailRegex = /^[^s@]+@[^s@]+.[^s@]+$/\r\n    return emailRegex.test(email)\r\n  }\r\n\r\n  const handleSubmit = async (e) => {\r\n    e.preventDefault()\r\n    setErrors({})\r\n\r\n    // Validaciones\r\n    if (!email) {\r\n      setErrors({ email: 'El email es requerido' })\r\n      return\r\n    }\r\n\r\n    if (!validateEmail(email)) {\r\n      setErrors({ email: 'Por favor ingresa un email v√°lido' })\r\n      return\r\n    }\r\n\r\n    setIsLoading(true)\r\n\r\n    try {\r\n      const { error } = await supabase.auth.resetPasswordForEmail(email, {\r\n        redirectTo: `${window.location.origin}/reset-password`\r\n      })\r\n\r\n      if (error) {\r\n        if (error.message.includes('Email not confirmed')) {\r\n          toast.error('Tu email no ha sido confirmado. Revisa tu bandeja de entrada.')\r\n        } else {\r\n          toast.error('Error al enviar el email de recuperaci√≥n')\r\n        }\r\n        console.error('Error:', error)\r\n        return\r\n      }\r\n\r\n      setEmailSent(true)\r\n      toast.success('Email de recuperaci√≥n enviado exitosamente')\r\n    } catch (error) {\r\n      console.error('Error sending reset email:', error)\r\n      toast.error('Error al enviar el email de recuperaci√≥n')\r\n    } finally {\r\n      setIsLoading(false)\r\n    }\r\n  }\r\n\r\n  if (emailSent) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8\">\r\n        <div className=\"max-w-md w-full space-y-8\">\r\n          <div>\r\n            <h2 className=\"mt-6 text-center text-3xl font-extrabold text-gray-900\">\r\n              Email enviado\r\n            </h2>\r\n            <p className=\"mt-2 text-center text-sm text-gray-600\">\r\n              Hemos enviado un enlace de recuperaci√≥n a tu email\r\n            </p>\r\n          </div>\r\n          \r\n          <div className=\"bg-green-50 border border-green-200 rounded-md p-4\">\r\n            <div className=\"flex\">\r\n              <div className=\"flex-shrink-0\">\r\n                <EnvelopeIcon className=\"h-5 w-5 text-green-400\" />\r\n              </div>\r\n              <div className=\"ml-3\">\r\n                <h3 className=\"text-sm font-medium text-green-800\">\r\n                  Revisa tu email\r\n                </h3>\r\n                <div className=\"mt-2 text-sm text-green-700\">\r\n                  <p>\r\n                    Te hemos enviado un enlace de recuperaci√≥n a <strong>{email}</strong>.\r\n                    Haz clic en el enlace del email para restablecer tu contrase√±a.\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"text-center\">\r\n            <Link\r\n              to=\"/login\"\r\n              className=\"inline-flex items-center text-sm font-medium text-primary-600 hover:text-primary-500\"\r\n            >\r\n              <ArrowLeftIcon className=\"h-4 w-4 mr-1\" />\r\n              Volver al inicio de sesi√≥n\r\n            </Link>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8\">\r\n      <div className=\"max-w-md w-full space-y-8\">\r\n        <div>\r\n          <h2 className=\"mt-6 text-center text-3xl font-extrabold text-gray-900\">\r\n            Recuperar contrase√±a\r\n          </h2>\r\n          <p className=\"mt-2 text-center text-sm text-gray-600\">\r\n            Ingresa tu email y te enviaremos un enlace para restablecer tu contrase√±a\r\n          </p>\r\n        </div>\r\n        \r\n        <form className=\"mt-8 space-y-6\" onSubmit={handleSubmit}>\r\n          <div>\r\n            <label htmlFor=\"email\" className=\"block text-sm font-medium text-gray-700\">\r\n              Email\r\n            </label>\r\n            <div className=\"mt-1\">\r\n              <input\r\n                id=\"email\"\r\n                name=\"email\"\r\n                type=\"email\"\r\n                autoComplete=\"email\"\r\n                required\r\n                className={`input-field ${errors.email ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : ''}`}\r\n                placeholder=\"tu@email.com\"\r\n                value={email}\r\n                onChange={(e) => setEmail(e.target.value)}\r\n              />\r\n              {errors.email && (\r\n                <p className=\"mt-1 text-sm text-red-600\">{errors.email}</p>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          <div>\r\n            <button\r\n              type=\"submit\"\r\n              disabled={isLoading}\r\n              className=\"group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              {isLoading ? (\r\n                <div className=\"flex items-center\">\r\n                  <div className=\"animate-spin -ml-1 mr-3 h-5 w-5 text-white\">\r\n                    <svg className=\"w-full h-full\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n                      <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\r\n                      <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\r\n                    </svg>\r\n                  </div>\r\n                  Enviando...\r\n                </div>\r\n              ) : (\r\n                'Enviar enlace de recuperaci√≥n'\r\n              )}\r\n            </button>\r\n          </div>\r\n\r\n          <div className=\"text-center\">\r\n            <Link\r\n              to=\"/login\"\r\n              className=\"inline-flex items-center text-sm font-medium text-primary-600 hover:text-primary-500\"\r\n            >\r\n              <ArrowLeftIcon className=\"h-4 w-4 mr-1\" />\r\n              Volver al inicio de sesi√≥n\r\n            </Link>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default ForgotPassword","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\auth\\GoogleAuthCallback.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'currentUser' is assigned a value but never used.","line":48,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":48,"endColumn":24},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadUserProfile'. Either include it or remove the dependency array.","line":244,"column":6,"nodeType":"ArrayExpression","endLine":244,"endColumn":68,"suggestions":[{"desc":"Update the dependencies array to be: [searchParams, navigate, user, userProfile, updateUserProfile, loadUserProfile]","fix":{"range":[11201,11263],"text":"[searchParams, navigate, user, userProfile, updateUserProfile, loadUserProfile]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState, useRef } from 'react'\r\nimport { useNavigate, useSearchParams } from 'react-router-dom'\r\nimport { useAuth } from '../../contexts/AuthContext.js'\r\nimport googleDriveCallbackHandler from '../../lib/googleDriveCallbackHandler.js'\r\nimport googleDriveAuthService from '../../lib/googleDriveAuthService.js'\r\nimport { auth, supabase } from '../../lib/supabase.js'\r\nimport toast from 'react-hot-toast'\r\n\r\nconst GoogleAuthCallback = () => {\r\n  const [searchParams] = useSearchParams()\r\n  const navigate = useNavigate()\r\n  const { user, userProfile, updateUserProfile, loadUserProfile } = useAuth()\r\n  const [status, setStatus] = useState('processing')\r\n  const [message, setMessage] = useState('Procesando autorizaci√≥n de Google Drive...')\r\n  const hasProcessed = useRef(false)\r\n\r\n  useEffect(() => {\r\n    const handleGoogleCallback = async () => {\r\n      // Prevenir m√∫ltiples ejecuciones\r\n      if (hasProcessed.current) {\r\n        return\r\n      }\r\n      \r\n      hasProcessed.current = true\r\n      \r\n      try {\r\n        const code = searchParams.get('code')\r\n        const error = searchParams.get('error')\r\n        \r\n        if (error) {\r\n          setStatus('error')\r\n          setMessage('Error en la autorizaci√≥n de Google Drive')\r\n          toast.error('Error en la autorizaci√≥n de Google Drive')\r\n          setTimeout(() => navigate('/panel-principal'), 3000)\r\n          return\r\n        }\r\n        \r\n        if (!code) {\r\n          console.error('GoogleAuthCallback - C√≥digo de autorizaci√≥n no encontrado')\r\n          setStatus('error')\r\n          setMessage('C√≥digo de autorizaci√≥n no encontrado')\r\n          toast.error('C√≥digo de autorizaci√≥n no encontrado')\r\n          setTimeout(() => navigate('/panel-principal'), 3000)\r\n          return\r\n        }\r\n        \r\n        // Verificar y refrescar autenticaci√≥n actual\r\n        let currentUser = user\r\n        let authenticatedUser = null\r\n        \r\n        try {\r\n          // Intentar obtener usuario actual de Supabase\r\n          const { data: { session } } = await auth.getSession()\r\n          authenticatedUser = session?.user\r\n          console.log('GoogleAuthCallback - Session obtained:', !!session)\r\n        } catch (sessionError) {\r\n          console.warn('GoogleAuthCallback - Error getting session:', sessionError)\r\n        }\r\n        \r\n        console.log('GoogleAuthCallback - Debug Info:')\r\n        console.log('- Code:', code ? 'Present' : 'Missing')\r\n        console.log('- Error:', error)\r\n        console.log('- Context User:', user)\r\n        console.log('- Auth User:', authenticatedUser)\r\n        console.log('- UserProfile:', userProfile)\r\n        \r\n        // Priorizar el usuario del contexto, luego el de Supabase, luego recargar\r\n        let activeUser = user || authenticatedUser\r\n        \r\n        // Si no tenemos usuario activo, intentar recargar perfil del contexto\r\n        if (!activeUser && userProfile?.id) {\r\n          console.log('GoogleAuthCallback - No active user, using userProfile ID:', userProfile.id)\r\n          activeUser = { id: userProfile.id, email: userProfile.email }\r\n        }\r\n        \r\n        // Si a√∫n no tenemos usuario, intentar recargar el perfil usando AuthContext\r\n        if (!activeUser) {\r\n          console.log('GoogleAuthCallback - Attempting to reload user profile...')\r\n          try {\r\n            await loadUserProfile(auth.currentUser?.id || userProfile?.id, true)\r\n            // Reintentamos obtener el usuario despu√©s de cargar\r\n            const { data: { session: newSession } } = await auth.getSession()\r\n            activeUser = newSession?.user || { id: userProfile?.id, email: userProfile?.email }\r\n          } catch (profileReloadError) {\r\n            console.error('GoogleAuthCallback - Error reloading profile:', profileReloadError)\r\n          }\r\n        }\r\n        \r\n        // Verificar que el usuario est√© autenticado\r\n        if (!activeUser) {\r\n          console.warn('GoogleAuthCallback - Usuario no autenticado, intentando usar URL de referencia')\r\n          \r\n          // Intentar usar la URL de referencia para determinar d√≥nde redirigir\r\n          const referrer = document.referrer\r\n          const isFromDashboard = referrer.includes('/panel-principal') || referrer.includes('/dashboard')\r\n          \r\n          if (isFromDashboard) {\r\n            console.log('GoogleAuthCallback - Referrer indica que ven√≠a del dashboard, redirigiendo all√≠')\r\n            setStatus('success')\r\n            setMessage('Google Drive conectado exitosamente')\r\n            toast.success('Google Drive conectado exitosamente')\r\n            \r\n            // Forzar redirecci√≥n al dashboard incluso sin usuario verificado\r\n            // La sesi√≥n se puede recuperar autom√°ticamente\r\n            setTimeout(() => navigate('/panel-principal'), 2000)\r\n            return\r\n          } else {\r\n            console.error('GoogleAuthCallback - Usuario no autenticado y referrer desconocido')\r\n            setStatus('error')\r\n            setMessage('Sesi√≥n expirada - Inicia sesi√≥n nuevamente')\r\n            toast.error('Sesi√≥n expirada - Inicia sesi√≥n nuevamente')\r\n            setTimeout(() => navigate('/login'), 3000)\r\n            return\r\n          }\r\n        }\r\n        \r\n        console.log('GoogleAuthCallback - Usuario activo seleccionado:', activeUser.id)\r\n\r\n        // Inicializar googleDriveAuthService con Supabase\r\n        googleDriveAuthService.initializeSupabase(supabase, activeUser.id)\r\n        console.log('GoogleAuthCallback - googleDriveAuthService inicializado con Supabase')\r\n\r\n        setMessage('Procesando autorizaci√≥n de Google Drive...')\r\n        \r\n        // Validar el estado CSRF si existe\r\n        const state = searchParams.get('state')\r\n        const savedState = sessionStorage.getItem('google_oauth_state')\r\n        \r\n        if (savedState && state !== savedState) {\r\n          console.error('GoogleAuthCallback - Estado CSRF inv√°lido')\r\n          throw new Error('Estado de seguridad inv√°lido. Por favor intenta nuevamente.')\r\n        }\r\n        \r\n        // Limpiar estado guardado\r\n        sessionStorage.removeItem('google_oauth_state')\r\n        \r\n        setMessage('Obteniendo credenciales de Google Drive...')\r\n        \r\n        // Procesar el c√≥digo de autorizaci√≥n usando el handler\r\n        const result = await googleDriveCallbackHandler.handleAuthorizationCode(code, activeUser.id)\r\n        \r\n        if (!result.success) {\r\n          // Asegurar que mostramos el detalle real del error\r\n          const detail = result?.error?.message || result?.error || ''\r\n          throw new Error(detail || 'Error procesando la autorizaci√≥n')\r\n        }\r\n        \r\n        console.log('GoogleAuthCallback - Credenciales guardadas exitosamente:', {\r\n          userId: activeUser.id,\r\n          email: result.email,\r\n          hasCredentials: true\r\n        })\r\n\r\n        setMessage('Verificando conexi√≥n con Google Drive...')\r\n        \r\n        // IMPORTANTE: Las credenciales ya est√°n guardadas en Supabase\r\n        // Ahora solo necesitamos actualizar el contexto de autenticaci√≥n\r\n        setStatus('success')\r\n        setMessage('¬°Google Drive conectado exitosamente!')\r\n        toast.success('Google Drive conectado exitosamente')\r\n        \r\n        console.log('GoogleAuthCallback - CONEXI√ìN EXITOSA - Redirigiendo inmediatamente al dashboard')\r\n        \r\n        // FORZAR REDIRECCI√ìN M√öLTIPLE Y AGRESIVA AL DASHBOARD\r\n        setStatus('success')\r\n        setMessage('¬°Google Drive conectado exitosamente!')\r\n        toast.success('Google Drive conectado exitosamente')\r\n        \r\n        // REDIRECCI√ìN INMEDIATA CON REPLACE\r\n        navigate('/panel-principal', { replace: true })\r\n        \r\n        // REDIRECCIONES DE SEGURIDAD CON DIFERENTES M√âTODOS\r\n        setTimeout(() => {\r\n          console.log('GoogleAuthCallback - SEGUNDA REDIRECCI√ìN DE SEGURIDAD')\r\n          navigate('/panel-principal', { replace: true })\r\n        }, 500)\r\n        \r\n        setTimeout(() => {\r\n          console.log('GoogleAuthCallback - TERCERA REDIRECCI√ìN - FORZANDO CON WINDOW.LOCATION')\r\n          window.location.href = '/panel-principal'\r\n        }, 1000)\r\n        \r\n        setTimeout(() => {\r\n          console.log('GoogleAuthCallback - CUARTA REDIRECCI√ìN - FORZANDO CON WINDOW.REPLACE')\r\n          window.location.replace('/panel-principal')\r\n        }, 1500)\r\n        \r\n        // Recargar el perfil del usuario para obtener las nuevas credenciales\r\n        try {\r\n          await loadUserProfile(activeUser.id, true)\r\n          console.log('GoogleAuthCallback - Perfil recargado exitosamente')\r\n        } catch (profileError) {\r\n          console.error('GoogleAuthCallback - Error recargando perfil:', profileError)\r\n          // No es cr√≠tico, continuamos\r\n        }\r\n        \r\n      } catch (error) {\r\n        console.error('Error in Google callback:', error)\r\n        setStatus('error')\r\n        \r\n        // Mostrar mensaje espec√≠fico seg√∫n el tipo de error\r\n        let errorMessage = 'Error procesando la autorizaci√≥n de Google Drive'\r\n        if (error?.message?.includes('L√≠mite de solicitudes excedido')) {\r\n          errorMessage = 'L√≠mite de solicitudes excedido. Intenta nuevamente en unos minutos.'\r\n        } else if (error?.message?.includes('redirect_uri_mismatch')) {\r\n          errorMessage = 'redirect_uri_mismatch: Revisa que el URI de redirecci√≥n sea exactamente http://localhost:3000/auth/google/callback'\r\n        } else if (error?.message?.includes('invalid_grant')) {\r\n          errorMessage = 'Invalid grant: El c√≥digo de autorizaci√≥n expir√≥ o ya fue usado. Vuelve a iniciar la conexi√≥n.'\r\n        } else if (error?.message?.includes('invalid_client')) {\r\n          errorMessage = 'Invalid client: Verifica el Client ID/Secret en .env y en Google Cloud Console.'\r\n        } else if (error?.message?.includes('C√≥digo de autorizaci√≥n inv√°lido')) {\r\n          errorMessage = 'C√≥digo de autorizaci√≥n expirado. Intenta conectar Google Drive nuevamente.'\r\n        } else if (error?.message?.includes('Credenciales de Google inv√°lidas')) {\r\n          errorMessage = 'Error de configuraci√≥n. Contacta al administrador.'\r\n        } else if (error?.message?.includes('No se pudieron obtener los tokens')) {\r\n          errorMessage = 'Error obteniendo permisos de Google Drive. Intenta nuevamente.'\r\n        }\r\n\r\n        // Anexar detalle t√©cnico para depuraci√≥n visible\r\n        const detail = error?.message ? ` Detalle: ${error.message}` : ''\r\n        const finalMessage = `${errorMessage}${detail ? ' - ' + detail : ''}`.slice(0, 500)\r\n\r\n        setMessage(finalMessage)\r\n        toast.error(finalMessage)\r\n        \r\n        // SIEMPRE REDIRIGIR AL DASHBOARD - INCLUSO EN CASO DE ERROR CON M√öLTIPLES M√âTODOS\r\n        console.log('GoogleAuthCallback - REDIRIGIENDO AL DASHBOARD A PESAR DE ERROR GENERAL')\r\n        \r\n        setTimeout(() => {\r\n          navigate('/panel-principal', { replace: true })\r\n        }, 1000)\r\n        \r\n        setTimeout(() => {\r\n          window.location.href = '/panel-principal'\r\n        }, 2000)\r\n        \r\n        setTimeout(() => {\r\n          window.location.replace('/panel-principal')\r\n        }, 3000)\r\n      }\r\n    }\r\n\r\n    handleGoogleCallback()\r\n  }, [searchParams, navigate, user, userProfile, updateUserProfile])\r\n\r\n  const getStatusIcon = () => {\r\n    switch (status) {\r\n      case 'processing':\r\n        return (\r\n          <div className=\"animate-spin h-12 w-12 text-primary-600\">\r\n            <svg className=\"w-full h-full\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n              <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\r\n              <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\r\n            </svg>\r\n          </div>\r\n        )\r\n      case 'success':\r\n        return (\r\n          <div className=\"h-12 w-12 text-green-600\">\r\n            <svg className=\"w-full h-full\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\r\n            </svg>\r\n          </div>\r\n        )\r\n      case 'warning':\r\n        return (\r\n          <div className=\"h-12 w-12 text-yellow-600\">\r\n            <svg className=\"w-full h-full\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z\" />\r\n            </svg>\r\n          </div>\r\n        )\r\n      case 'error':\r\n        return (\r\n          <div className=\"h-12 w-12 text-red-600\">\r\n            <svg className=\"w-full h-full\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\r\n            </svg>\r\n          </div>\r\n        )\r\n      default:\r\n        return null\r\n    }\r\n  }\r\n\r\n  const getStatusColor = () => {\r\n    switch (status) {\r\n      case 'processing':\r\n        return 'text-primary-600'\r\n      case 'success':\r\n        return 'text-green-600'\r\n      case 'warning':\r\n        return 'text-yellow-600'\r\n      case 'error':\r\n        return 'text-red-600'\r\n      default:\r\n        return 'text-gray-600'\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\r\n      <div className=\"max-w-md w-full\">\r\n        <div className=\"bg-white rounded-lg shadow-md p-8 text-center\">\r\n          <div className=\"flex justify-center mb-6\">\r\n            {getStatusIcon()}\r\n          </div>\r\n          \r\n          <h2 className=\"text-2xl font-bold text-gray-900 mb-4\">\r\n            Conectando Google Drive\r\n          </h2>\r\n          \r\n          <p className={`text-lg ${getStatusColor()} mb-6`}>\r\n            {message}\r\n          </p>\r\n          \r\n          {status === 'processing' && (\r\n            <div className=\"flex items-center justify-center space-x-2\">\r\n              <div className=\"animate-pulse h-2 bg-primary-200 rounded w-8\"></div>\r\n              <div className=\"animate-pulse h-2 bg-primary-200 rounded w-8 delay-75\"></div>\r\n              <div className=\"animate-pulse h-2 bg-primary-200 rounded w-8 delay-150\"></div>\r\n            </div>\r\n          )}\r\n          \r\n          {(status === 'success' || status === 'warning' || status === 'error') && (\r\n            <div className=\"mt-6\">\r\n              <button\r\n                onClick={() => navigate('/panel-principal')}\r\n                className=\"btn-primary\"\r\n              >\r\n                Ir al Dashboard\r\n              </button>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default GoogleAuthCallback","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\auth\\Login.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\auth\\LoginInnovador.js","messages":[{"ruleId":"jsx-a11y/anchor-is-valid","severity":1,"message":"The href attribute requires a valid value to be accessible. Provide a valid, navigable address as the href value. If you cannot provide a valid href, but still need the element to resemble a link, use a button and change it with appropriate styles. Learn more: https://github.com/jsx-eslint/eslint-plugin-jsx-a11y/blob/HEAD/docs/rules/anchor-is-valid.md","line":161,"column":13,"nodeType":"JSXOpeningElement","endLine":161,"endColumn":91},{"ruleId":"jsx-a11y/anchor-is-valid","severity":1,"message":"The href attribute requires a valid value to be accessible. Provide a valid, navigable address as the href value. If you cannot provide a valid href, but still need the element to resemble a link, use a button and change it with appropriate styles. Learn more: https://github.com/jsx-eslint/eslint-plugin-jsx-a11y/blob/HEAD/docs/rules/anchor-is-valid.md","line":165,"column":13,"nodeType":"JSXOpeningElement","endLine":165,"endColumn":91}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react'\r\nimport { useNavigate, Link } from 'react-router-dom'\r\nimport { useAuth } from '../../contexts/AuthContext.js'\r\nimport { toast } from 'react-hot-toast'\r\n\r\nconst LoginInnovador = () => {\r\n  const [email, setEmail] = useState('')\r\n  const [password, setPassword] = useState('')\r\n  const [loading, setLoading] = useState(false)\r\n  const { signIn } = useAuth()\r\n  const navigate = useNavigate()\r\n\r\n  const handleSubmit = async (e) => {\r\n    e.preventDefault()\r\n    setLoading(true)\r\n    \r\n    try {\r\n      const result = await signIn(email, password)\r\n      if (!result.error) {\r\n        toast.success('¬°Bienvenido de nuevo!')\r\n        navigate('/panel-principal')\r\n      }\r\n    } catch (error) {\r\n      console.error('Error de inicio de sesi√≥n:', error)\r\n      toast.error('Error al iniciar sesi√≥n. Por favor, verifica tus credenciales.')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-engage-black flex items-center justify-center p-4\">\r\n      <div className=\"w-full max-w-md\">\r\n        <div className=\"text-center mb-10\">\r\n          <div className=\"flex justify-center mb-6\">\r\n            <div className=\"logo-container p-3 bg-engage-black rounded-lg\">\r\n              <img \r\n                src=\"/images/Mesa-de-trabajo-105-1.png\" \r\n                alt=\"Logo\" \r\n                className=\"logo-image h-16 w-auto\"\r\n              />\r\n            </div>\r\n          </div>\r\n          <h1 className=\"text-3xl font-bold text-white\">Bienvenido de vuelta</h1>\r\n          <p className=\"mt-2 text-gray-300\">Inicia sesi√≥n para continuar con tu experiencia</p>\r\n        </div>\r\n\r\n        <div className=\"bg-gray-900 rounded-3xl shadow-2xl p-8 border border-engage-blue/30\">\r\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\r\n            <div>\r\n              <label htmlFor=\"email\" className=\"block text-sm font-medium text-white mb-2\">\r\n                Correo Electr√≥nico\r\n              </label>\r\n              <div className=\"relative\">\r\n                <div className=\"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none\">\r\n                  <svg className=\"h-5 w-5 text-engage-blue\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\"></path>\r\n                  </svg>\r\n                </div>\r\n                <input\r\n                  id=\"email\"\r\n                  name=\"email\"\r\n                  type=\"email\"\r\n                  autoComplete=\"email\"\r\n                  required\r\n                  value={email}\r\n                  onChange={(e) => setEmail(e.target.value)}\r\n                  className=\"block w-full pl-10 pr-3 py-4 border border-gray-700 rounded-2xl bg-gray-800 shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-engage-blue focus:border-engage-blue text-lg text-white\"\r\n                  placeholder=\"tu@ejemplo.com\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <div>\r\n              <label htmlFor=\"password\" className=\"block text-sm font-medium text-white mb-2\">\r\n                Contrase√±a\r\n              </label>\r\n              <div className=\"relative\">\r\n                <div className=\"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none\">\r\n                  <svg className=\"h-5 w-5 text-engage-blue\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z\"></path>\r\n                  </svg>\r\n                </div>\r\n                <input\r\n                  id=\"password\"\r\n                  name=\"password\"\r\n                  type=\"password\"\r\n                  autoComplete=\"current-password\"\r\n                  required\r\n                  value={password}\r\n                  onChange={(e) => setPassword(e.target.value)}\r\n                  className=\"block w-full pl-10 pr-3 py-4 border border-gray-700 rounded-2xl bg-gray-800 shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-engage-blue focus:border-engage-blue text-lg text-white\"\r\n                  placeholder=\"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className=\"flex items-center\">\r\n                <input\r\n                  id=\"remember-me\"\r\n                  name=\"remember-me\"\r\n                  type=\"checkbox\"\r\n                  className=\"h-5 w-5 text-engage-blue focus:ring-engage-blue border-gray-600 rounded bg-gray-800\"\r\n                />\r\n                <label htmlFor=\"remember-me\" className=\"ml-2 block text-sm text-white\">\r\n                  Recordarme\r\n                </label>\r\n              </div>\r\n\r\n              <div className=\"text-sm\">\r\n                <Link to=\"/forgot-password\" className=\"font-medium text-engage-blue hover:text-engage-yellow\">\r\n                  ¬øOlvidaste tu contrase√±a?\r\n                </Link>\r\n              </div>\r\n            </div>\r\n\r\n            <div>\r\n              <button\r\n                type=\"submit\"\r\n                disabled={loading}\r\n                className=\"w-full flex justify-center py-4 px-4 border border-transparent rounded-2xl shadow-sm text-lg font-medium text-white bg-gradient-to-r from-engage-blue to-engage-yellow hover:from-engage-yellow hover:to-engage-blue focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-engage-blue transition-all duration-300 transform hover:scale-105\"\r\n              >\r\n                {loading ? (\r\n                  <svg className=\"animate-spin -ml-1 mr-3 h-5 w-5 text-white\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n                    <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\r\n                    <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\r\n                  </svg>\r\n                ) : null}\r\n                {loading ? 'Iniciando sesi√≥n...' : 'Iniciar Sesi√≥n'}\r\n              </button>\r\n            </div>\r\n          </form>\r\n\r\n          <div className=\"mt-8\">\r\n            <div className=\"relative\">\r\n              <div className=\"absolute inset-0 flex items-center\">\r\n                <div className=\"w-full border-t border-gray-700\"></div>\r\n              </div>\r\n              <div className=\"relative flex justify-center text-sm\">\r\n                <span className=\"px-2 bg-gray-900 text-gray-300\">\r\n                  ¬øPrimera vez aqu√≠?\r\n                </span>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"mt-6\">\r\n              <Link\r\n                to=\"/register\"\r\n                className=\"w-full flex justify-center py-4 px-4 border border-engage-blue rounded-2xl shadow-sm text-lg font-medium text-engage-blue bg-gray-800 hover:bg-engage-blue/10 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-engage-blue transition-all duration-300\"\r\n              >\r\n                Crear una cuenta\r\n              </Link>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"mt-8 text-center\">\r\n          <p className=\"text-sm text-gray-400\">\r\n            Al iniciar sesi√≥n, aceptas nuestros{' '}\r\n            <a href=\"#\" className=\"font-medium text-engage-blue hover:text-engage-yellow\">\r\n              T√©rminos de Servicio\r\n            </a>{' '}\r\n            y{' '}\r\n            <a href=\"#\" className=\"font-medium text-engage-blue hover:text-engage-yellow\">\r\n              Pol√≠tica de Privacidad\r\n            </a>\r\n          </p>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default LoginInnovador","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\auth\\LoginRedesigned.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\auth\\LoginUltraModern.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\auth\\Register.js","messages":[{"ruleId":"jsx-a11y/anchor-is-valid","severity":1,"message":"The href attribute requires a valid value to be accessible. Provide a valid, navigable address as the href value. If you cannot provide a valid href, but still need the element to resemble a link, use a button and change it with appropriate styles. Learn more: https://github.com/jsx-eslint/eslint-plugin-jsx-a11y/blob/HEAD/docs/rules/anchor-is-valid.md","line":295,"column":15,"nodeType":"JSXOpeningElement","endLine":295,"endColumn":91},{"ruleId":"jsx-a11y/anchor-is-valid","severity":1,"message":"The href attribute requires a valid value to be accessible. Provide a valid, navigable address as the href value. If you cannot provide a valid href, but still need the element to resemble a link, use a button and change it with appropriate styles. Learn more: https://github.com/jsx-eslint/eslint-plugin-jsx-a11y/blob/HEAD/docs/rules/anchor-is-valid.md","line":299,"column":15,"nodeType":"JSXOpeningElement","endLine":299,"endColumn":91}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react'\r\nimport { Link, useNavigate } from 'react-router-dom'\r\nimport { useAuth } from '../../contexts/AuthContext.js'\r\nimport { EyeIcon, EyeSlashIcon } from '@heroicons/react/24/outline'\r\nimport LoadingSpinner from '../common/LoadingSpinner.js'\r\n\r\nconst Register = () => {\r\n  const [formData, setFormData] = useState({\r\n    name: '',\r\n    email: '',\r\n    password: '',\r\n    confirmPassword: '',\r\n    telegramId: ''\r\n  })\r\n  const [showPassword, setShowPassword] = useState(false)\r\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false)\r\n  const [isLoading, setIsLoading] = useState(false)\r\n  const [errors, setErrors] = useState({})\r\n  \r\n  const { signUp } = useAuth()\r\n  const navigate = useNavigate()\r\n\r\n  const handleChange = (e) => {\r\n    const { name, value } = e.target\r\n    setFormData(prev => ({\r\n      ...prev,\r\n      [name]: value\r\n    }))\r\n    \r\n    // Limpiar error del campo cuando el usuario empiece a escribir\r\n    if (errors[name]) {\r\n      setErrors(prev => ({\r\n        ...prev,\r\n        [name]: ''\r\n      }))\r\n    }\r\n  }\r\n\r\n  const validateForm = () => {\r\n    const newErrors = {}\r\n    \r\n    if (!formData.name.trim()) {\r\n      newErrors.name = 'El nombre es requerido'\r\n    } else if (formData.name.trim().length < 2) {\r\n      newErrors.name = 'El nombre debe tener al menos 2 caracteres'\r\n    }\r\n    \r\n    if (!formData.email) {\r\n      newErrors.email = 'El email es requerido'\r\n    } else if (!/\\S+@\\S+\\.\\S+/.test(formData.email)) {\r\n      newErrors.email = 'El email no es v√°lido'\r\n    }\r\n    \r\n    if (!formData.password) {\r\n      newErrors.password = 'La contrase√±a es requerida'\r\n    } else if (formData.password.length < 6) {\r\n      newErrors.password = 'La contrase√±a debe tener al menos 6 caracteres'\r\n    }\r\n    \r\n    if (!formData.confirmPassword) {\r\n      newErrors.confirmPassword = 'Confirma tu contrase√±a'\r\n    } else if (formData.password !== formData.confirmPassword) {\r\n      newErrors.confirmPassword = 'Las contrase√±as no coinciden'\r\n    }\r\n    \r\n    // Telegram ID es opcional, pero si se proporciona debe ser v√°lido\r\n    if (formData.telegramId && !/^\\d+$/.test(formData.telegramId)) {\r\n      newErrors.telegramId = 'El ID de Telegram debe contener solo n√∫meros'\r\n    }\r\n    \r\n    setErrors(newErrors)\r\n    return Object.keys(newErrors).length === 0\r\n  }\r\n\r\n  const handleSubmit = async (e) => {\r\n    e.preventDefault()\r\n    \r\n    if (!validateForm()) {\r\n      return\r\n    }\r\n    \r\n    setIsLoading(true)\r\n    \r\n    try {\r\n      const userData = {\r\n        name: formData.name.trim(),\r\n        telegram_id: formData.telegramId || null\r\n      }\r\n      \r\n      const { error } = await signUp(formData.email, formData.password, userData)\r\n      \r\n      if (!error) {\r\n        navigate('/login')\r\n      }\r\n    } catch (error) {\r\n      console.error('Error during registration:', error)\r\n    } finally {\r\n      setIsLoading(false)\r\n    }\r\n  }\r\n\r\n  if (isLoading) {\r\n    return <LoadingSpinner text=\"Creando cuenta...\" />\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8\">\r\n      <div className=\"max-w-md w-full space-y-8\">\r\n        <div>\r\n          <div className=\"mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-primary-100\">\r\n            <svg className=\"h-8 w-8 text-primary-600\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z\" />\r\n            </svg>\r\n          </div>\r\n          <h2 className=\"mt-6 text-center text-3xl font-extrabold text-gray-900\">\r\n            Crear Cuenta\r\n          </h2>\r\n          <p className=\"mt-2 text-center text-sm text-gray-600\">\r\n            ¬øYa tienes una cuenta?{' '}\r\n            <Link\r\n              to=\"/login\"\r\n              className=\"font-medium text-primary-600 hover:text-primary-500 transition-colors duration-200\"\r\n            >\r\n              Inicia sesi√≥n aqu√≠\r\n            </Link>\r\n          </p>\r\n        </div>\r\n        \r\n        <form className=\"mt-8 space-y-6\" onSubmit={handleSubmit}>\r\n          <div className=\"space-y-4\">\r\n            {/* Name */}\r\n            <div>\r\n              <label htmlFor=\"name\" className=\"block text-sm font-medium text-gray-700\">\r\n                Nombre Completo\r\n              </label>\r\n              <div className=\"mt-1\">\r\n                <input\r\n                  id=\"name\"\r\n                  name=\"name\"\r\n                  type=\"text\"\r\n                  autoComplete=\"name\"\r\n                  required\r\n                  className={`input-field ${errors.name ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : ''}`}\r\n                  placeholder=\"Tu nombre completo\"\r\n                  value={formData.name}\r\n                  onChange={handleChange}\r\n                />\r\n                {errors.name && (\r\n                  <p className=\"mt-1 text-sm text-red-600\">{errors.name}</p>\r\n                )}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Email */}\r\n            <div>\r\n              <label htmlFor=\"email\" className=\"block text-sm font-medium text-gray-700\">\r\n                Correo Electr√≥nico\r\n              </label>\r\n              <div className=\"mt-1\">\r\n                <input\r\n                  id=\"email\"\r\n                  name=\"email\"\r\n                  type=\"email\"\r\n                  autoComplete=\"email\"\r\n                  required\r\n                  className={`input-field ${errors.email ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : ''}`}\r\n                  placeholder=\"tu@email.com\"\r\n                  value={formData.email}\r\n                  onChange={handleChange}\r\n                />\r\n                {errors.email && (\r\n                  <p className=\"mt-1 text-sm text-red-600\">{errors.email}</p>\r\n                )}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Telegram ID */}\r\n            <div>\r\n              <label htmlFor=\"telegramId\" className=\"block text-sm font-medium text-gray-700\">\r\n                ID de Telegram <span className=\"text-gray-500\">(Opcional)</span>\r\n              </label>\r\n              <div className=\"mt-1\">\r\n                <input\r\n                  id=\"telegramId\"\r\n                  name=\"telegramId\"\r\n                  type=\"text\"\r\n                  className={`input-field ${errors.telegramId ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : ''}`}\r\n                  placeholder=\"123456789\"\r\n                  value={formData.telegramId}\r\n                  onChange={handleChange}\r\n                />\r\n                {errors.telegramId && (\r\n                  <p className=\"mt-1 text-sm text-red-600\">{errors.telegramId}</p>\r\n                )}\r\n                <p className=\"mt-1 text-xs text-gray-500\">\r\n                  Puedes encontrar tu ID de Telegram contactando a @userinfobot\r\n                </p>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Password */}\r\n            <div>\r\n              <label htmlFor=\"password\" className=\"block text-sm font-medium text-gray-700\">\r\n                Contrase√±a\r\n              </label>\r\n              <div className=\"mt-1 relative\">\r\n                <input\r\n                  id=\"password\"\r\n                  name=\"password\"\r\n                  type={showPassword ? 'text' : 'password'}\r\n                  autoComplete=\"new-password\"\r\n                  required\r\n                  className={`input-field pr-10 ${errors.password ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : ''}`}\r\n                  placeholder=\"M√≠nimo 6 caracteres\"\r\n                  value={formData.password}\r\n                  onChange={handleChange}\r\n                />\r\n                <button\r\n                  type=\"button\"\r\n                  className=\"absolute inset-y-0 right-0 pr-3 flex items-center\"\r\n                  onClick={() => setShowPassword(!showPassword)}\r\n                >\r\n                  {showPassword ? (\r\n                    <EyeSlashIcon className=\"h-5 w-5 text-gray-400\" />\r\n                  ) : (\r\n                    <EyeIcon className=\"h-5 w-5 text-gray-400\" />\r\n                  )}\r\n                </button>\r\n                {errors.password && (\r\n                  <p className=\"mt-1 text-sm text-red-600\">{errors.password}</p>\r\n                )}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Confirm Password */}\r\n            <div>\r\n              <label htmlFor=\"confirmPassword\" className=\"block text-sm font-medium text-gray-700\">\r\n                Confirmar Contrase√±a\r\n              </label>\r\n              <div className=\"mt-1 relative\">\r\n                <input\r\n                  id=\"confirmPassword\"\r\n                  name=\"confirmPassword\"\r\n                  type={showConfirmPassword ? 'text' : 'password'}\r\n                  autoComplete=\"new-password\"\r\n                  required\r\n                  className={`input-field pr-10 ${errors.confirmPassword ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : ''}`}\r\n                  placeholder=\"Repite tu contrase√±a\"\r\n                  value={formData.confirmPassword}\r\n                  onChange={handleChange}\r\n                />\r\n                <button\r\n                  type=\"button\"\r\n                  className=\"absolute inset-y-0 right-0 pr-3 flex items-center\"\r\n                  onClick={() => setShowConfirmPassword(!showConfirmPassword)}\r\n                >\r\n                  {showConfirmPassword ? (\r\n                    <EyeSlashIcon className=\"h-5 w-5 text-gray-400\" />\r\n                  ) : (\r\n                    <EyeIcon className=\"h-5 w-5 text-gray-400\" />\r\n                  )}\r\n                </button>\r\n                {errors.confirmPassword && (\r\n                  <p className=\"mt-1 text-sm text-red-600\">{errors.confirmPassword}</p>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div>\r\n            <button\r\n              type=\"submit\"\r\n              disabled={isLoading}\r\n              className=\"group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200\"\r\n            >\r\n              {isLoading ? (\r\n                <div className=\"flex items-center\">\r\n                  <div className=\"animate-spin -ml-1 mr-3 h-5 w-5 text-white\">\r\n                    <svg className=\"w-full h-full\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n                      <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\r\n                      <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\r\n                    </svg>\r\n                  </div>\r\n                  Creando cuenta...\r\n                </div>\r\n              ) : (\r\n                'Crear Cuenta'\r\n              )}\r\n            </button>\r\n          </div>\r\n\r\n          <div className=\"text-center\">\r\n            <p className=\"text-xs text-gray-600\">\r\n              Al crear una cuenta, aceptas nuestros{' '}\r\n              <a href=\"#\" className=\"font-medium text-primary-600 hover:text-primary-500\">\r\n                T√©rminos de Servicio\r\n              </a>{' '}\r\n              y{' '}\r\n              <a href=\"#\" className=\"font-medium text-primary-600 hover:text-primary-500\">\r\n                Pol√≠tica de Privacidad\r\n              </a>\r\n            </p>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default Register","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\auth\\RegisterInnovador.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\auth\\ResetPassword.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'searchParams' is assigned a value but never used.","line":21,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { useNavigate, useSearchParams } from 'react-router-dom'\r\nimport { supabase } from '../../lib/supabase.js'\r\nimport { EyeIcon, EyeSlashIcon, CheckCircleIcon } from '@heroicons/react/24/outline'\r\nimport LoadingSpinner from '../common/LoadingSpinner.js'\r\nimport toast from 'react-hot-toast'\r\n\r\nconst ResetPassword = () => {\r\n  const [formData, setFormData] = useState({\r\n    password: '',\r\n    confirmPassword: ''\r\n  })\r\n  const [showPassword, setShowPassword] = useState(false)\r\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false)\r\n  const [isLoading, setIsLoading] = useState(false)\r\n  const [errors, setErrors] = useState({})\r\n  const [isValidToken, setIsValidToken] = useState(null)\r\n  const [passwordReset, setPasswordReset] = useState(false)\r\n  \r\n  const navigate = useNavigate()\r\n  const [searchParams] = useSearchParams()\r\n\r\n  useEffect(() => {\r\n    // Funci√≥n para obtener par√°metros del fragmento de la URL (hash)\r\n    const getHashParams = () => {\r\n      const hash = window.location.hash.substring(1) // Remover el #\r\n      const params = new URLSearchParams(hash)\r\n      return {\r\n        access_token: params.get('access_token'),\r\n        refresh_token: params.get('refresh_token'),\r\n        type: params.get('type'),\r\n        expires_in: params.get('expires_in')\r\n      }\r\n    }\r\n\r\n    // Verificar si tenemos los par√°metros necesarios del enlace de recuperaci√≥n\r\n    const hashParams = getHashParams()\r\n    const { access_token, refresh_token, type } = hashParams\r\n\r\n    console.log('Hash params:', hashParams) // Para debugging\r\n\r\n    if (type === 'recovery' && access_token && refresh_token) {\r\n      // Establecer la sesi√≥n con los tokens del enlace\r\n      supabase.auth.setSession({\r\n        access_token: access_token,\r\n        refresh_token: refresh_token\r\n      }).then(({ error }) => {\r\n        if (error) {\r\n          console.error('Error setting session:', error)\r\n          setIsValidToken(false)\r\n          toast.error('Enlace de recuperaci√≥n inv√°lido o expirado')\r\n        } else {\r\n          setIsValidToken(true)\r\n          toast.success('Enlace v√°lido. Puedes cambiar tu contrase√±a.')\r\n        }\r\n      })\r\n    } else {\r\n      setIsValidToken(false)\r\n      toast.error('Enlace de recuperaci√≥n inv√°lido')\r\n    }\r\n  }, [])\r\n\r\n  const handleChange = (e) => {\r\n    const { name, value } = e.target\r\n    setFormData(prev => ({\r\n      ...prev,\r\n      [name]: value\r\n    }))\r\n    \r\n    // Limpiar errores cuando el usuario empiece a escribir\r\n    if (errors[name]) {\r\n      setErrors(prev => ({\r\n        ...prev,\r\n        [name]: ''\r\n      }))\r\n    }\r\n  }\r\n\r\n  const validateForm = () => {\r\n    const newErrors = {}\r\n\r\n    if (!formData.password) {\r\n      newErrors.password = 'La contrase√±a es requerida'\r\n    } else if (formData.password.length < 6) {\r\n      newErrors.password = 'La contrase√±a debe tener al menos 6 caracteres'\r\n    }\r\n\r\n    if (!formData.confirmPassword) {\r\n      newErrors.confirmPassword = 'Confirma tu contrase√±a'\r\n    } else if (formData.password !== formData.confirmPassword) {\r\n      newErrors.confirmPassword = 'Las contrase√±as no coinciden'\r\n    }\r\n\r\n    setErrors(newErrors)\r\n    return Object.keys(newErrors).length === 0\r\n  }\r\n\r\n  const handleSubmit = async (e) => {\r\n    e.preventDefault()\r\n    \r\n    if (!validateForm()) {\r\n      return\r\n    }\r\n\r\n    setIsLoading(true)\r\n\r\n    try {\r\n      const { error } = await supabase.auth.updateUser({\r\n        password: formData.password\r\n      })\r\n\r\n      if (error) {\r\n        console.error('Error:', error)\r\n        \r\n        // Manejar errores espec√≠ficos de Supabase\r\n        if (error.message && error.message.includes('New password should be different from the old password')) {\r\n          toast.error('La nueva contrase√±a debe ser diferente a la anterior')\r\n        } else if (error.message && error.message.includes('Password should be at least')) {\r\n          toast.error('La contrase√±a debe cumplir con los requisitos m√≠nimos')\r\n        } else {\r\n          toast.error('Error al actualizar la contrase√±a')\r\n        }\r\n        return\r\n      }\r\n\r\n      setPasswordReset(true)\r\n      toast.success('Contrase√±a actualizada exitosamente')\r\n      \r\n      // Redirigir al login despu√©s de 3 segundos\r\n      setTimeout(() => {\r\n        navigate('/login')\r\n      }, 3000)\r\n    } catch (error) {\r\n      console.error('Error updating password:', error)\r\n      toast.error('Error al actualizar la contrase√±a')\r\n    } finally {\r\n      setIsLoading(false)\r\n    }\r\n  }\r\n\r\n  if (isValidToken === null) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\r\n        <LoadingSpinner />\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (isValidToken === false) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8\">\r\n        <div className=\"max-w-md w-full space-y-8\">\r\n          <div className=\"text-center\">\r\n            <h2 className=\"mt-6 text-3xl font-extrabold text-gray-900\">\r\n              Enlace inv√°lido\r\n            </h2>\r\n            <p className=\"mt-2 text-sm text-gray-600\">\r\n              El enlace de recuperaci√≥n es inv√°lido o ha expirado.\r\n            </p>\r\n            <div className=\"mt-6\">\r\n              <button\r\n                onClick={() => navigate('/forgot-password')}\r\n                className=\"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700\"\r\n              >\r\n                Solicitar nuevo enlace\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (passwordReset) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8\">\r\n        <div className=\"max-w-md w-full space-y-8\">\r\n          <div className=\"text-center\">\r\n            <CheckCircleIcon className=\"mx-auto h-12 w-12 text-green-500\" />\r\n            <h2 className=\"mt-6 text-3xl font-extrabold text-gray-900\">\r\n              Contrase√±a actualizada\r\n            </h2>\r\n            <p className=\"mt-2 text-sm text-gray-600\">\r\n              Tu contrase√±a ha sido actualizada exitosamente.\r\n              Ser√°s redirigido al inicio de sesi√≥n en unos segundos.\r\n            </p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8\">\r\n      <div className=\"max-w-md w-full space-y-8\">\r\n        <div>\r\n          <h2 className=\"mt-6 text-center text-3xl font-extrabold text-gray-900\">\r\n            Nueva contrase√±a\r\n          </h2>\r\n          <p className=\"mt-2 text-center text-sm text-gray-600\">\r\n            Ingresa tu nueva contrase√±a\r\n          </p>\r\n        </div>\r\n        \r\n        <form className=\"mt-8 space-y-6\" onSubmit={handleSubmit}>\r\n          <div className=\"space-y-4\">\r\n            {/* Password */}\r\n            <div>\r\n              <label htmlFor=\"password\" className=\"block text-sm font-medium text-gray-700\">\r\n                Nueva contrase√±a\r\n              </label>\r\n              <div className=\"mt-1 relative\">\r\n                <input\r\n                  id=\"password\"\r\n                  name=\"password\"\r\n                  type={showPassword ? 'text' : 'password'}\r\n                  autoComplete=\"new-password\"\r\n                  required\r\n                  className={`input-field pr-10 ${errors.password ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : ''}`}\r\n                  placeholder=\"M√≠nimo 6 caracteres\"\r\n                  value={formData.password}\r\n                  onChange={handleChange}\r\n                />\r\n                <button\r\n                  type=\"button\"\r\n                  className=\"absolute inset-y-0 right-0 pr-3 flex items-center\"\r\n                  onClick={() => setShowPassword(!showPassword)}\r\n                >\r\n                  {showPassword ? (\r\n                    <EyeSlashIcon className=\"h-5 w-5 text-gray-400\" />\r\n                  ) : (\r\n                    <EyeIcon className=\"h-5 w-5 text-gray-400\" />\r\n                  )}\r\n                </button>\r\n                {errors.password && (\r\n                  <p className=\"mt-1 text-sm text-red-600\">{errors.password}</p>\r\n                )}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Confirm Password */}\r\n            <div>\r\n              <label htmlFor=\"confirmPassword\" className=\"block text-sm font-medium text-gray-700\">\r\n                Confirmar nueva contrase√±a\r\n              </label>\r\n              <div className=\"mt-1 relative\">\r\n                <input\r\n                  id=\"confirmPassword\"\r\n                  name=\"confirmPassword\"\r\n                  type={showConfirmPassword ? 'text' : 'password'}\r\n                  autoComplete=\"new-password\"\r\n                  required\r\n                  className={`input-field pr-10 ${errors.confirmPassword ? 'border-red-300 focus:border-red-500 focus:ring-red-500' : ''}`}\r\n                  placeholder=\"Repite tu nueva contrase√±a\"\r\n                  value={formData.confirmPassword}\r\n                  onChange={handleChange}\r\n                />\r\n                <button\r\n                  type=\"button\"\r\n                  className=\"absolute inset-y-0 right-0 pr-3 flex items-center\"\r\n                  onClick={() => setShowConfirmPassword(!showConfirmPassword)}\r\n                >\r\n                  {showConfirmPassword ? (\r\n                    <EyeSlashIcon className=\"h-5 w-5 text-gray-400\" />\r\n                  ) : (\r\n                    <EyeIcon className=\"h-5 w-5 text-gray-400\" />\r\n                  )}\r\n                </button>\r\n                {errors.confirmPassword && (\r\n                  <p className=\"mt-1 text-sm text-red-600\">{errors.confirmPassword}</p>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div>\r\n            <button\r\n              type=\"submit\"\r\n              disabled={isLoading}\r\n              className=\"group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              {isLoading ? (\r\n                <div className=\"flex items-center\">\r\n                  <div className=\"animate-spin -ml-1 mr-3 h-5 w-5 text-white\">\r\n                    <svg className=\"w-full h-full\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n                      <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\r\n                      <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\r\n                    </svg>\r\n                  </div>\r\n                  Actualizando...\r\n                </div>\r\n              ) : (\r\n                'Actualizar contrase√±a'\r\n              )}\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default ResetPassword","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\charts\\AdvancedDataVisualization.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'setFilters' is assigned a value but never used.","line":37,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":37,"endColumn":29},{"ruleId":"no-unused-vars","severity":1,"message":"'setAnimationEnabled' is assigned a value but never used.","line":42,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":42,"endColumn":47},{"ruleId":"no-unused-vars","severity":1,"message":"'setHoveredPoint' is assigned a value but never used.","line":43,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":43,"endColumn":39},{"ruleId":"no-unused-vars","severity":1,"message":"'animationRef' is assigned a value but never used.","line":48,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":48,"endColumn":21},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has an unnecessary dependency: 'theme'. Either exclude it or remove the dependency array.","line":366,"column":6,"nodeType":"ArrayExpression","endLine":366,"endColumn":40,"suggestions":[{"desc":"Update the dependencies array to be: [processedData, showLabels]","fix":{"range":[12202,12236],"text":"[processedData, showLabels]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'y' is assigned a value but never used.","line":411,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":411,"endColumn":12}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Advanced Data Visualization\r\n * Sistema de visualizaci√≥n de datos avanzada con gr√°ficos interactivos\r\n * \r\n * ‚úÖ NO MODIFICA c√≥digo existente\r\n * ‚úÖ Completamente independiente\r\n * ‚úÖ Puede ser desactivado sin afectar el sistema\r\n */\r\n\r\nimport React, { useState, useEffect, useRef, useCallback, useMemo } from 'react'\r\nimport { \r\n  ChartBarIcon,\r\n  ChartPieIcon,\r\n  ChartLineIcon,\r\n  FunnelIcon,\r\n  ArrowTrendingUpIcon,\r\n  ArrowTrendingDownIcon,\r\n  MagnifyingGlassIcon,\r\n  AdjustmentsHorizontalIcon,\r\n  DocumentArrowDownIcon,\r\n  ShareIcon,\r\n  EyeIcon,\r\n  EyeSlashIcon\r\n} from '@heroicons/react/24/outline'\r\n\r\nconst AdvancedDataVisualization = ({ \r\n  data = [], \r\n  title = \"Visualizaci√≥n de Datos\",\r\n  type = \"auto\",\r\n  height = 400,\r\n  interactive = true,\r\n  exportable = true,\r\n  theme = \"light\"\r\n}) => {\r\n  const [chartType, setChartType] = useState(type)\r\n  const [selectedDataPoint, setSelectedDataPoint] = useState(null)\r\n  const [filters, setFilters] = useState({})\r\n  const [zoomLevel, setZoomLevel] = useState(1)\r\n  const [isFullscreen, setIsFullscreen] = useState(false)\r\n  const [showGrid, setShowGrid] = useState(true)\r\n  const [showLabels, setShowLabels] = useState(true)\r\n  const [animationEnabled, setAnimationEnabled] = useState(true)\r\n  const [hoveredPoint, setHoveredPoint] = useState(null)\r\n  const [searchTerm, setSearchTerm] = useState('')\r\n  \r\n  const canvasRef = useRef(null)\r\n  const containerRef = useRef(null)\r\n  const animationRef = useRef(null)\r\n\r\n  // Procesar datos seg√∫n el tipo de gr√°fico\r\n  const processedData = useMemo(() => {\r\n    if (!data || data.length === 0) return []\r\n    \r\n    // Aplicar filtros\r\n    let filteredData = data.filter(item => {\r\n      if (searchTerm) {\r\n        return Object.values(item).some(value => \r\n          String(value).toLowerCase().includes(searchTerm.toLowerCase())\r\n        )\r\n      }\r\n      return true\r\n    })\r\n\r\n    // Aplicar filtros adicionales\r\n    Object.entries(filters).forEach(([key, value]) => {\r\n      if (value && value !== 'all') {\r\n        filteredData = filteredData.filter(item => item[key] === value)\r\n      }\r\n    })\r\n\r\n    return filteredData\r\n  }, [data, filters, searchTerm])\r\n\r\n  // Calcular estad√≠sticas\r\n  const statistics = useMemo(() => {\r\n    if (processedData.length === 0) return null\r\n    \r\n    const numericValues = processedData\r\n      .filter(item => typeof item.value === 'number')\r\n      .map(item => item.value)\r\n    \r\n    if (numericValues.length === 0) return null\r\n    \r\n    return {\r\n      total: numericValues.reduce((sum, val) => sum + val, 0),\r\n      average: numericValues.reduce((sum, val) => sum + val, 0) / numericValues.length,\r\n      min: Math.min(...numericValues),\r\n      max: Math.max(...numericValues),\r\n      count: numericValues.length,\r\n      trend: numericValues.length > 1 ? \r\n        (numericValues[numericValues.length - 1] - numericValues[0]) / numericValues[0] * 100 : 0\r\n    }\r\n  }, [processedData])\r\n\r\n  // Detectar autom√°ticamente el mejor tipo de gr√°fico\r\n  const detectBestChartType = useCallback(() => {\r\n    if (processedData.length < 3) return 'pie'\r\n    if (processedData.length > 20) return 'line'\r\n    if (statistics && Math.abs(statistics.trend) > 10) return 'line'\r\n    return 'bar'\r\n  }, [processedData, statistics])\r\n\r\n  // Renderizar gr√°fico de barras\r\n  const renderBarChart = useCallback(() => {\r\n    const canvas = canvasRef.current\r\n    if (!canvas) return\r\n    \r\n    const ctx = canvas.getContext('2d')\r\n    const width = canvas.width\r\n    const height = canvas.height\r\n    \r\n    // Limpiar canvas\r\n    ctx.clearRect(0, 0, width, height)\r\n    \r\n    if (processedData.length === 0) return\r\n    \r\n    // Calcular dimensiones\r\n    const padding = 40\r\n    const chartWidth = width - 2 * padding\r\n    const chartHeight = height - 2 * padding\r\n    const barWidth = chartWidth / processedData.length * 0.8\r\n    const barSpacing = chartWidth / processedData.length * 0.2\r\n    \r\n    // Encontrar valores m√°ximos y m√≠nimos\r\n    const maxValue = Math.max(...processedData.map(d => d.value || 0))\r\n    const minValue = Math.min(...processedData.map(d => d.value || 0))\r\n    const valueRange = maxValue - minValue || 1\r\n    \r\n    // Dibujar grid si est√° habilitado\r\n    if (showGrid) {\r\n      ctx.strokeStyle = theme === 'dark' ? '#374151' : '#e5e7eb'\r\n      ctx.lineWidth = 0.5\r\n      \r\n      // L√≠neas horizontales\r\n      for (let i = 0; i <= 5; i++) {\r\n        const y = padding + (chartHeight / 5) * i\r\n        ctx.beginPath()\r\n        ctx.moveTo(padding, y)\r\n        ctx.lineTo(width - padding, y)\r\n        ctx.stroke()\r\n      }\r\n    }\r\n    \r\n    // Dibujar barras\r\n    processedData.forEach((item, index) => {\r\n      const value = item.value || 0\r\n      const barHeight = (value / valueRange) * chartHeight\r\n      const x = padding + index * (barWidth + barSpacing) + barSpacing / 2\r\n      const y = height - padding - barHeight\r\n      \r\n      // Color de la barra\r\n      const isSelected = selectedDataPoint === index\r\n      const isHovered = hoveredPoint === index\r\n      \r\n      if (isSelected) {\r\n        ctx.fillStyle = '#3b82f6'\r\n      } else if (isHovered) {\r\n        ctx.fillStyle = '#60a5fa'\r\n      } else {\r\n        ctx.fillStyle = theme === 'dark' ? '#6b7280' : '#9ca3af'\r\n      }\r\n      \r\n      // Dibujar barra con animaci√≥n\r\n      const animatedHeight = animationEnabled ? barHeight * zoomLevel : barHeight\r\n      ctx.fillRect(x, height - padding - animatedHeight, barWidth, animatedHeight)\r\n      \r\n      // Dibujar etiquetas si est√° habilitado\r\n      if (showLabels && item.label) {\r\n        ctx.fillStyle = theme === 'dark' ? '#d1d5db' : '#374151'\r\n        ctx.font = '12px sans-serif'\r\n        ctx.textAlign = 'center'\r\n        ctx.fillText(item.label, x + barWidth / 2, height - padding + 20)\r\n        \r\n        // Valor en la parte superior\r\n        ctx.fillText(value.toString(), x + barWidth / 2, y - 5)\r\n      }\r\n    })\r\n  }, [processedData, selectedDataPoint, hoveredPoint, showGrid, showLabels, theme, zoomLevel, animationEnabled])\r\n\r\n  // Renderizar gr√°fico de l√≠neas\r\n  const renderLineChart = useCallback(() => {\r\n    const canvas = canvasRef.current\r\n    if (!canvas) return\r\n    \r\n    const ctx = canvas.getContext('2d')\r\n    const width = canvas.width\r\n    const height = canvas.height\r\n    \r\n    ctx.clearRect(0, 0, width, height)\r\n    \r\n    if (processedData.length === 0) return\r\n    \r\n    const padding = 40\r\n    const chartWidth = width - 2 * padding\r\n    const chartHeight = height - 2 * padding\r\n    \r\n    const maxValue = Math.max(...processedData.map(d => d.value || 0))\r\n    const minValue = Math.min(...processedData.map(d => d.value || 0))\r\n    const valueRange = maxValue - minValue || 1\r\n    \r\n    // Dibujar grid\r\n    if (showGrid) {\r\n      ctx.strokeStyle = theme === 'dark' ? '#374151' : '#e5e7eb'\r\n      ctx.lineWidth = 0.5\r\n      \r\n      for (let i = 0; i <= 5; i++) {\r\n        const y = padding + (chartHeight / 5) * i\r\n        ctx.beginPath()\r\n        ctx.moveTo(padding, y)\r\n        ctx.lineTo(width - padding, y)\r\n        ctx.stroke()\r\n      }\r\n    }\r\n    \r\n    // Dibujar l√≠nea\r\n    ctx.strokeStyle = '#3b82f6'\r\n    ctx.lineWidth = 2\r\n    ctx.beginPath()\r\n    \r\n    processedData.forEach((item, index) => {\r\n      const value = item.value || 0\r\n      const x = padding + (index / (processedData.length - 1)) * chartWidth\r\n      const y = height - padding - ((value - minValue) / valueRange) * chartHeight\r\n      \r\n      if (index === 0) {\r\n        ctx.moveTo(x, y)\r\n      } else {\r\n        ctx.lineTo(x, y)\r\n      }\r\n    })\r\n    \r\n    ctx.stroke()\r\n    \r\n    // Dibujar puntos\r\n    processedData.forEach((item, index) => {\r\n      const value = item.value || 0\r\n      const x = padding + (index / (processedData.length - 1)) * chartWidth\r\n      const y = height - padding - ((value - minValue) / valueRange) * chartHeight\r\n      \r\n      ctx.fillStyle = selectedDataPoint === index ? '#3b82f6' : '#60a5fa'\r\n      ctx.beginPath()\r\n      ctx.arc(x, y, selectedDataPoint === index ? 6 : 4, 0, 2 * Math.PI)\r\n      ctx.fill()\r\n      \r\n      // Etiquetas\r\n      if (showLabels && item.label) {\r\n        ctx.fillStyle = theme === 'dark' ? '#d1d5db' : '#374151'\r\n        ctx.font = '12px sans-serif'\r\n        ctx.textAlign = 'center'\r\n        ctx.fillText(item.label, x, height - padding + 20)\r\n      }\r\n    })\r\n  }, [processedData, selectedDataPoint, showGrid, showLabels, theme])\r\n\r\n  // Renderizar gr√°fico circular\r\n  const renderPieChart = useCallback(() => {\r\n    const canvas = canvasRef.current\r\n    if (!canvas) return\r\n    \r\n    const ctx = canvas.getContext('2d')\r\n    const width = canvas.width\r\n    const height = canvas.height\r\n    \r\n    ctx.clearRect(0, 0, width, height)\r\n    \r\n    if (processedData.length === 0) return\r\n    \r\n    const centerX = width / 2\r\n    const centerY = height / 2\r\n    const radius = Math.min(width, height) / 3\r\n    \r\n    const total = processedData.reduce((sum, item) => sum + (item.value || 0), 0)\r\n    let currentAngle = -Math.PI / 2\r\n    \r\n    const colors = [\r\n      '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',\r\n      '#ec4899', '#14b8a6', '#f97316', '#6366f1', '#84cc16'\r\n    ]\r\n    \r\n    processedData.forEach((item, index) => {\r\n      const value = item.value || 0\r\n      const sliceAngle = (value / total) * 2 * Math.PI\r\n      \r\n      // Dibujar slice\r\n      ctx.fillStyle = colors[index % colors.length]\r\n      ctx.beginPath()\r\n      ctx.moveTo(centerX, centerY)\r\n      ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle)\r\n      ctx.closePath()\r\n      ctx.fill()\r\n      \r\n      // Resaltar si est√° seleccionado\r\n      if (selectedDataPoint === index) {\r\n        ctx.strokeStyle = '#1f2937'\r\n        ctx.lineWidth = 3\r\n        ctx.stroke()\r\n      }\r\n      \r\n      // Etiquetas\r\n      if (showLabels && item.label) {\r\n        const labelAngle = currentAngle + sliceAngle / 2\r\n        const labelX = centerX + Math.cos(labelAngle) * (radius + 20)\r\n        const labelY = centerY + Math.sin(labelAngle) * (radius + 20)\r\n        \r\n        ctx.fillStyle = theme === 'dark' ? '#d1d5db' : '#374151'\r\n        ctx.font = '12px sans-serif'\r\n        ctx.textAlign = 'center'\r\n        ctx.fillText(item.label, labelX, labelY)\r\n        ctx.fillText(`${((value / total) * 100).toFixed(1)}%`, labelX, labelY + 15)\r\n      }\r\n      \r\n      currentAngle += sliceAngle\r\n    })\r\n  }, [processedData, selectedDataPoint, showLabels, theme])\r\n\r\n  // Renderizar mapa de calor\r\n  const renderHeatmap = useCallback(() => {\r\n    const canvas = canvasRef.current\r\n    if (!canvas) return\r\n    \r\n    const ctx = canvas.getContext('2d')\r\n    const width = canvas.width\r\n    const height = canvas.height\r\n    \r\n    ctx.clearRect(0, 0, width, height)\r\n    \r\n    if (processedData.length === 0) return\r\n    \r\n    const padding = 40\r\n    const chartWidth = width - 2 * padding\r\n    const chartHeight = height - 2 * padding\r\n    \r\n    // Crear grid de datos\r\n    const gridSize = Math.ceil(Math.sqrt(processedData.length))\r\n    const cellWidth = chartWidth / gridSize\r\n    const cellHeight = chartHeight / gridSize\r\n    \r\n    const maxValue = Math.max(...processedData.map(d => d.value || 0))\r\n    const minValue = Math.min(...processedData.map(d => d.value || 0))\r\n    const valueRange = maxValue - minValue || 1\r\n    \r\n    processedData.forEach((item, index) => {\r\n      const row = Math.floor(index / gridSize)\r\n      const col = index % gridSize\r\n      const value = item.value || 0\r\n      \r\n      const x = padding + col * cellWidth\r\n      const y = padding + row * cellHeight\r\n      \r\n      // Calcular color basado en el valor\r\n      const intensity = (value - minValue) / valueRange\r\n      const red = Math.floor(255 * intensity)\r\n      const blue = Math.floor(255 * (1 - intensity))\r\n      \r\n      ctx.fillStyle = `rgb(${red}, 100, ${blue})`\r\n      ctx.fillRect(x, y, cellWidth - 2, cellHeight - 2)\r\n      \r\n      // Etiqueta si hay espacio\r\n      if (cellWidth > 30 && cellHeight > 30 && showLabels && item.label) {\r\n        ctx.fillStyle = intensity > 0.5 ? 'white' : 'black'\r\n        ctx.font = '10px sans-serif'\r\n        ctx.textAlign = 'center'\r\n        ctx.fillText(item.label, x + cellWidth / 2, y + cellHeight / 2)\r\n      }\r\n    })\r\n  }, [processedData, showLabels, theme])\r\n\r\n  // Efecto para renderizar el gr√°fico\r\n  useEffect(() => {\r\n    const canvas = canvasRef.current\r\n    if (!canvas) return\r\n    \r\n    // Ajustar tama√±o del canvas\r\n    const container = containerRef.current\r\n    if (container) {\r\n      canvas.width = container.clientWidth\r\n      canvas.height = height\r\n    }\r\n    \r\n    // Renderizar seg√∫n el tipo\r\n    switch (chartType) {\r\n      case 'bar':\r\n        renderBarChart()\r\n        break\r\n      case 'line':\r\n        renderLineChart()\r\n        break\r\n      case 'pie':\r\n        renderPieChart()\r\n        break\r\n      case 'heatmap':\r\n        renderHeatmap()\r\n        break\r\n      default:\r\n        if (chartType === 'auto') {\r\n          const bestType = detectBestChartType()\r\n          setChartType(bestType)\r\n        }\r\n    }\r\n  }, [chartType, processedData, height, renderBarChart, renderLineChart, renderPieChart, renderHeatmap, detectBestChartType])\r\n\r\n  // Manejar clic en el gr√°fico\r\n  const handleCanvasClick = useCallback((event) => {\r\n    if (!interactive) return\r\n    \r\n    const canvas = canvasRef.current\r\n    if (!canvas) return\r\n    \r\n    const rect = canvas.getBoundingClientRect()\r\n    const x = event.clientX - rect.left\r\n    const y = event.clientY - rect.top\r\n    \r\n    // Detectar punto de datos (simplificado)\r\n    const padding = 40\r\n    const chartWidth = canvas.width - 2 * padding\r\n    \r\n    if (chartType === 'bar' || chartType === 'line') {\r\n      const index = Math.floor((x - padding) / (chartWidth / processedData.length))\r\n      if (index >= 0 && index < processedData.length) {\r\n        setSelectedDataPoint(selectedDataPoint === index ? null : index)\r\n      }\r\n    }\r\n  }, [interactive, chartType, processedData, selectedDataPoint])\r\n\r\n  // Exportar gr√°fico\r\n  const exportChart = useCallback(() => {\r\n    const canvas = canvasRef.current\r\n    if (!canvas) return\r\n    \r\n    const link = document.createElement('a')\r\n    link.download = `chart-${Date.now()}.png`\r\n    link.href = canvas.toDataURL()\r\n    link.click()\r\n  }, [])\r\n\r\n  // Compartir gr√°fico\r\n  const shareChart = useCallback(async () => {\r\n    const canvas = canvasRef.current\r\n    if (!canvas) return\r\n    \r\n    try {\r\n      const blob = await new Promise(resolve => canvas.toBlob(resolve))\r\n      if (navigator.share) {\r\n        await navigator.share({\r\n          title: title,\r\n          text: `Gr√°fico: ${title}`,\r\n          files: [new File([blob], 'chart.png', { type: 'image/png' })]\r\n        })\r\n      } else {\r\n        // Fallback: copiar al portapapeles\r\n        const item = new ClipboardItem({ 'image/png': blob })\r\n        await navigator.clipboard.write([item])\r\n      }\r\n    } catch (error) {\r\n      console.error('Error sharing chart:', error)\r\n    }\r\n  }, [title])\r\n\r\n  // Controles del gr√°fico\r\n  const ChartControls = () => (\r\n    <div className=\"flex flex-wrap items-center gap-2 p-4 bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700\">\r\n      {/* Selector de tipo */}\r\n      <div className=\"flex items-center gap-1\">\r\n        <button\r\n          onClick={() => setChartType('bar')}\r\n          className={`p-2 rounded ${chartType === 'bar' ? 'bg-blue-500 text-white' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300'}`}\r\n          title=\"Gr√°fico de barras\"\r\n        >\r\n          <ChartBarIcon className=\"w-4 h-4\" />\r\n        </button>\r\n        <button\r\n          onClick={() => setChartType('line')}\r\n          className={`p-2 rounded ${chartType === 'line' ? 'bg-blue-500 text-white' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300'}`}\r\n          title=\"Gr√°fico de l√≠neas\"\r\n        >\r\n          <ChartLineIcon className=\"w-4 h-4\" />\r\n        </button>\r\n        <button\r\n          onClick={() => setChartType('pie')}\r\n          className={`p-2 rounded ${chartType === 'pie' ? 'bg-blue-500 text-white' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300'}`}\r\n          title=\"Gr√°fico circular\"\r\n        >\r\n          <ChartPieIcon className=\"w-4 h-4\" />\r\n        </button>\r\n        <button\r\n          onClick={() => setChartType('heatmap')}\r\n          className={`p-2 rounded ${chartType === 'heatmap' ? 'bg-blue-500 text-white' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300'}`}\r\n          title=\"Mapa de calor\"\r\n        >\r\n          <FunnelIcon className=\"w-4 h-4\" />\r\n        </button>\r\n      </div>\r\n      \r\n      {/* Separador */}\r\n      <div className=\"w-px h-6 bg-gray-300 dark:bg-gray-600\"></div>\r\n      \r\n      {/* Controles de visualizaci√≥n */}\r\n      <div className=\"flex items-center gap-1\">\r\n        <button\r\n          onClick={() => setShowGrid(!showGrid)}\r\n          className={`p-2 rounded ${showGrid ? 'bg-blue-500 text-white' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300'}`}\r\n          title=\"Mostrar/ocultar grid\"\r\n        >\r\n          <AdjustmentsHorizontalIcon className=\"w-4 h-4\" />\r\n        </button>\r\n        <button\r\n          onClick={() => setShowLabels(!showLabels)}\r\n          className={`p-2 rounded ${showLabels ? 'bg-blue-500 text-white' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300'}`}\r\n          title=\"Mostrar/ocultar etiquetas\"\r\n        >\r\n          {showLabels ? <EyeIcon className=\"w-4 h-4\" /> : <EyeSlashIcon className=\"w-4 h-4\" />}\r\n        </button>\r\n      </div>\r\n      \r\n      {/* Separador */}\r\n      <div className=\"w-px h-6 bg-gray-300 dark:bg-gray-600\"></div>\r\n      \r\n      {/* Zoom */}\r\n      <div className=\"flex items-center gap-1\">\r\n        <button\r\n          onClick={() => setZoomLevel(Math.max(0.5, zoomLevel - 0.1))}\r\n          className=\"px-2 py-1 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded\"\r\n        >\r\n          -\r\n        </button>\r\n        <span className=\"px-2 py-1 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded text-sm\">\r\n          {Math.round(zoomLevel * 100)}%\r\n        </span>\r\n        <button\r\n          onClick={() => setZoomLevel(Math.min(2, zoomLevel + 0.1))}\r\n          className=\"px-2 py-1 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded\"\r\n        >\r\n          +\r\n        </button>\r\n      </div>\r\n      \r\n      {/* Separador */}\r\n      <div className=\"w-px h-6 bg-gray-300 dark:bg-gray-600\"></div>\r\n      \r\n      {/* B√∫squeda */}\r\n      <div className=\"flex items-center gap-1\">\r\n        <MagnifyingGlassIcon className=\"w-4 h-4 text-gray-500 dark:text-gray-400\" />\r\n        <input\r\n          type=\"text\"\r\n          value={searchTerm}\r\n          onChange={(e) => setSearchTerm(e.target.value)}\r\n          placeholder=\"Buscar...\"\r\n          className=\"px-2 py-1 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded text-sm border border-gray-300 dark:border-gray-600\"\r\n        />\r\n      </div>\r\n      \r\n      {/* Acciones */}\r\n      {exportable && (\r\n        <>\r\n          <div className=\"w-px h-6 bg-gray-300 dark:bg-gray-600\"></div>\r\n          <button\r\n            onClick={exportChart}\r\n            className=\"p-2 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-100 dark:hover:bg-gray-600\"\r\n            title=\"Exportar gr√°fico\"\r\n          >\r\n            <DocumentArrowDownIcon className=\"w-4 h-4\" />\r\n          </button>\r\n          <button\r\n            onClick={shareChart}\r\n            className=\"p-2 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-100 dark:hover:bg-gray-600\"\r\n            title=\"Compartir gr√°fico\"\r\n          >\r\n            <ShareIcon className=\"w-4 h-4\" />\r\n          </button>\r\n        </>\r\n      )}\r\n      \r\n      <button\r\n        onClick={() => setIsFullscreen(!isFullscreen)}\r\n        className=\"p-2 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-100 dark:hover:bg-gray-600\"\r\n        title=\"Pantalla completa\"\r\n      >\r\n        {isFullscreen ? '‚Üô' : '‚Üó'}\r\n      </button>\r\n    </div>\r\n  )\r\n\r\n  // Panel de estad√≠sticas\r\n  const StatisticsPanel = () => {\r\n    if (!statistics) return null\r\n    \r\n    return (\r\n      <div className=\"p-4 bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700\">\r\n        <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4\">\r\n          <div className=\"text-center\">\r\n            <div className=\"text-2xl font-bold text-gray-900 dark:text-gray-100\">\r\n              {statistics.count}\r\n            </div>\r\n            <div className=\"text-sm text-gray-600 dark:text-gray-400\">Datos</div>\r\n          </div>\r\n          \r\n          <div className=\"text-center\">\r\n            <div className=\"text-2xl font-bold text-gray-900 dark:text-gray-100\">\r\n              {statistics.total.toFixed(0)}\r\n            </div>\r\n            <div className=\"text-sm text-gray-600 dark:text-gray-400\">Total</div>\r\n          </div>\r\n          \r\n          <div className=\"text-center\">\r\n            <div className=\"text-2xl font-bold text-gray-900 dark:text-gray-100\">\r\n              {statistics.average.toFixed(1)}\r\n            </div>\r\n            <div className=\"text-sm text-gray-600 dark:text-gray-400\">Promedio</div>\r\n          </div>\r\n          \r\n          <div className=\"text-center\">\r\n            <div className=\"text-2xl font-bold text-gray-900 dark:text-gray-100\">\r\n              {statistics.min.toFixed(0)}\r\n            </div>\r\n            <div className=\"text-sm text-gray-600 dark:text-gray-400\">M√≠nimo</div>\r\n          </div>\r\n          \r\n          <div className=\"text-center\">\r\n            <div className=\"text-2xl font-bold text-gray-900 dark:text-gray-100\">\r\n              {statistics.max.toFixed(0)}\r\n            </div>\r\n            <div className=\"text-sm text-gray-600 dark:text-gray-400\">M√°ximo</div>\r\n          </div>\r\n          \r\n          <div className=\"text-center\">\r\n            <div className={`text-2xl font-bold flex items-center justify-center ${statistics.trend >= 0 ? 'text-green-600' : 'text-red-600'}`}>\r\n              {statistics.trend >= 0 ? (\r\n                <ArrowTrendingUpIcon className=\"w-6 h-6\" />\r\n              ) : (\r\n                <ArrowTrendingDownIcon className=\"w-6 h-6\" />\r\n              )}\r\n              {Math.abs(statistics.trend).toFixed(1)}%\r\n            </div>\r\n            <div className=\"text-sm text-gray-600 dark:text-gray-400\">Tendencia</div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className={`bg-white dark:bg-gray-800 rounded-lg shadow-lg ${isFullscreen ? 'fixed inset-0 z-50' : ''}`}>\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700\">\r\n        <h2 className=\"text-lg font-semibold text-gray-900 dark:text-gray-100\">\r\n          {title}\r\n        </h2>\r\n        <div className=\"flex items-center gap-2\">\r\n          <span className=\"px-2 py-1 bg-blue-100 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400 rounded text-sm\">\r\n            {chartType}\r\n          </span>\r\n          <span className=\"px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded text-sm\">\r\n            {processedData.length} datos\r\n          </span>\r\n        </div>\r\n      </div>\r\n      \r\n      {/* Controles */}\r\n      {interactive && <ChartControls />}\r\n      \r\n      {/* Canvas del gr√°fico */}\r\n      <div \r\n        ref={containerRef} \r\n        className=\"relative bg-white dark:bg-gray-900\"\r\n        style={{ height: `${height}px` }}\r\n      >\r\n        <canvas\r\n          ref={canvasRef}\r\n          onClick={handleCanvasClick}\r\n          className=\"w-full h-full cursor-pointer\"\r\n        />\r\n        \r\n        {/* Tooltip para puntos hover */}\r\n        {hoveredPoint !== null && (\r\n          <div className=\"absolute top-4 right-4 bg-black bg-opacity-75 text-white p-2 rounded text-sm\">\r\n            {processedData[hoveredPoint]?.label}: {processedData[hoveredPoint]?.value}\r\n          </div>\r\n        )}\r\n      </div>\r\n      \r\n      {/* Estad√≠sticas */}\r\n      {statistics && <StatisticsPanel />}\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default AdvancedDataVisualization","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\charts\\DashboardChart.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\common\\AccessibleForm.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'errorId' is assigned a value but never used.","line":441,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":441,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useRef, useEffect } from 'react';\r\n\r\n/**\r\n * Componente de formulario accesible con validaci√≥n y manejo de errores\r\n */\r\nconst AccessibleForm = ({\r\n  children,\r\n  onSubmit,\r\n  validationSchema,\r\n  initialValues = {},\r\n  submitButtonText = 'Enviar',\r\n  cancelButtonText = 'Cancelar',\r\n  onCancel,\r\n  loading = false,\r\n  className = '',\r\n  ariaLabel = 'Formulario',\r\n  ...props\r\n}) => {\r\n  const [formData, setFormData] = useState(initialValues);\r\n  const [errors, setErrors] = useState({});\r\n  const [touched, setTouched] = useState({});\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n  const formRef = useRef(null);\r\n  const firstErrorRef = useRef(null);\r\n\r\n  // Validar un campo espec√≠fico\r\n  const validateField = (name, value) => {\r\n    if (!validationSchema) return null;\r\n    \r\n    try {\r\n      // Validaci√≥n simple basada en el schema\r\n      const fieldSchema = validationSchema[name];\r\n      if (fieldSchema) {\r\n        if (fieldSchema.required && (!value || value.toString().trim() === '')) {\r\n          return `${fieldSchema.label || name} es requerido`;\r\n        }\r\n        \r\n        if (fieldSchema.minLength && value && value.length < fieldSchema.minLength) {\r\n          return `${fieldSchema.label || name} debe tener al menos ${fieldSchema.minLength} caracteres`;\r\n        }\r\n        \r\n        if (fieldSchema.pattern && value && !fieldSchema.pattern.test(value)) {\r\n          return fieldSchema.message || `${fieldSchema.label || name} tiene un formato inv√°lido`;\r\n        }\r\n        \r\n        if (fieldSchema.validate && typeof fieldSchema.validate === 'function') {\r\n          const result = fieldSchema.validate(value);\r\n          if (result !== true) {\r\n            return result;\r\n          }\r\n        }\r\n      }\r\n      \r\n      return null;\r\n    } catch (error) {\r\n      console.error('Error validando campo:', error);\r\n      return 'Error de validaci√≥n';\r\n    }\r\n  };\r\n\r\n  // Validar todo el formulario\r\n  const validateForm = () => {\r\n    if (!validationSchema) return {};\r\n    \r\n    const newErrors = {};\r\n    let hasErrors = false;\r\n    \r\n    Object.keys(validationSchema).forEach(fieldName => {\r\n      const error = validateField(fieldName, formData[fieldName]);\r\n      if (error) {\r\n        newErrors[fieldName] = error;\r\n        hasErrors = true;\r\n      }\r\n    });\r\n    \r\n    return { errors: newErrors, hasErrors };\r\n  };\r\n\r\n  // Manejar cambio de campo\r\n  const handleFieldChange = (name, value) => {\r\n    setFormData(prev => ({ ...prev, [name]: value }));\r\n    \r\n    // Validar en tiempo real si el campo ya fue tocado\r\n    if (touched[name]) {\r\n      const error = validateField(name, value);\r\n      setErrors(prev => ({ ...prev, [name]: error }));\r\n    }\r\n  };\r\n\r\n  // Manejar blur de campo\r\n  const handleFieldBlur = (name) => {\r\n    setTouched(prev => ({ ...prev, [name]: true }));\r\n    const error = validateField(name, formData[name]);\r\n    setErrors(prev => ({ ...prev, [name]: error }));\r\n  };\r\n\r\n  // Manejar submit del formulario\r\n  const handleSubmit = async (event) => {\r\n    event.preventDefault();\r\n    \r\n    // Marcar todos los campos como tocados\r\n    const allTouched = Object.keys(validationSchema || {}).reduce((acc, key) => {\r\n      acc[key] = true;\r\n      return acc;\r\n    }, {});\r\n    setTouched(allTouched);\r\n    \r\n    // Validar formulario\r\n    const { errors: validationErrors, hasErrors } = validateForm();\r\n    setErrors(validationErrors);\r\n    \r\n    if (hasErrors) {\r\n      // Enfocar primer campo con error\r\n      const firstErrorField = Object.keys(validationErrors)[0];\r\n      if (firstErrorField && firstErrorRef.current) {\r\n        firstErrorRef.current.focus();\r\n      }\r\n      \r\n      // Anunciar errores para lectores de pantalla\r\n      const errorCount = Object.keys(validationErrors).length;\r\n      const announcement = `Formulario tiene ${errorCount} error${errorCount !== 1 ? 'es' : ''}. ${Object.values(validationErrors).join('. ')}`;\r\n      \r\n      const liveRegion = document.getElementById('form-announcements');\r\n      if (liveRegion) {\r\n        liveRegion.textContent = announcement;\r\n      }\r\n      \r\n      return;\r\n    }\r\n    \r\n    setIsSubmitting(true);\r\n    \r\n    try {\r\n      await onSubmit(formData);\r\n    } catch (error) {\r\n      console.error('Error en submit del formulario:', error);\r\n      setErrors(prev => ({ \r\n        ...prev, \r\n        submit: error.message || 'Error al enviar el formulario' \r\n      }));\r\n    } finally {\r\n      setIsSubmitting(false);\r\n    }\r\n  };\r\n\r\n  // Manejar cancelaci√≥n\r\n  const handleCancel = () => {\r\n    if (onCancel) {\r\n      onCancel();\r\n    }\r\n  };\r\n\r\n  // Manejar navegaci√≥n por teclado\r\n  const handleKeyDown = (event) => {\r\n    if (event.key === 'Escape' && onCancel) {\r\n      handleCancel();\r\n    }\r\n  };\r\n\r\n  // Enfocar primer campo al montar\r\n  useEffect(() => {\r\n    if (formRef.current) {\r\n      const firstInput = formRef.current.querySelector('input, select, textarea, button');\r\n      if (firstInput) {\r\n        firstInput.focus();\r\n      }\r\n    }\r\n  }, []);\r\n\r\n  // Clonar children con props adicionales\r\n  const childrenWithProps = React.Children.map(children, (child) => {\r\n    if (React.isValidElement(child) && child.props.name) {\r\n      const fieldName = child.props.name;\r\n      const fieldError = errors[fieldName];\r\n      const isTouched = touched[fieldName];\r\n      const hasError = fieldError && isTouched;\r\n      \r\n      return React.cloneElement(child, {\r\n        value: formData[fieldName] || '',\r\n        onChange: (e) => {\r\n          const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;\r\n          handleFieldChange(fieldName, value);\r\n          if (child.props.onChange) {\r\n            child.props.onChange(e);\r\n          }\r\n        },\r\n        onBlur: (e) => {\r\n          handleFieldBlur(fieldName);\r\n          if (child.props.onBlur) {\r\n            child.props.onBlur(e);\r\n          }\r\n        },\r\n        'aria-invalid': hasError ? 'true' : 'false',\r\n        'aria-describedby': hasError ? `${fieldName}-error` : child.props['aria-describedby'],\r\n        ref: hasError && !firstErrorRef.current ? firstErrorRef : child.ref,\r\n        className: `${child.props.className || ''} ${hasError ? 'error' : ''}`.trim(),\r\n        ...child.props\r\n      });\r\n    }\r\n    return child;\r\n  });\r\n\r\n  return (\r\n    <>\r\n      {/* Regi√≥n live para anuncios de accesibilidad */}\r\n      <div\r\n        id=\"form-announcements\"\r\n        aria-live=\"polite\"\r\n        aria-atomic=\"true\"\r\n        className=\"sr-only\"\r\n      />\r\n      \r\n      <form\r\n        ref={formRef}\r\n        onSubmit={handleSubmit}\r\n        onKeyDown={handleKeyDown}\r\n        className={`accessible-form ${className}`}\r\n        aria-label={ariaLabel}\r\n        noValidate\r\n        {...props}\r\n      >\r\n        {childrenWithProps}\r\n        \r\n        {/* Mensajes de error de campo */}\r\n        {Object.entries(errors).map(([fieldName, error]) => (\r\n          touched[fieldName] && error && (\r\n            <div\r\n              key={fieldName}\r\n              id={`${fieldName}-error`}\r\n              className=\"field-error\"\r\n              role=\"alert\"\r\n              aria-live=\"polite\"\r\n              style={{\r\n                color: '#dc3545',\r\n                fontSize: '0.875rem',\r\n                marginTop: '0.25rem',\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                gap: '0.5rem'\r\n              }}\r\n            >\r\n              <svg\r\n                width=\"16\"\r\n                height=\"16\"\r\n                viewBox=\"0 0 16 16\"\r\n                fill=\"currentColor\"\r\n                aria-hidden=\"true\"\r\n              >\r\n                <path d=\"M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z\"/>\r\n                <path d=\"M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z\"/>\r\n              </svg>\r\n              {error}\r\n            </div>\r\n          )\r\n        ))}\r\n        \r\n        {/* Error general del formulario */}\r\n        {errors.submit && (\r\n          <div\r\n            className=\"form-error\"\r\n            role=\"alert\"\r\n            aria-live=\"assertive\"\r\n            style={{\r\n              backgroundColor: '#f8d7da',\r\n              border: '1px solid #f5c6cb',\r\n              color: '#721c24',\r\n              padding: '0.75rem',\r\n              borderRadius: '0.25rem',\r\n              marginTop: '1rem',\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              gap: '0.5rem'\r\n            }}\r\n          >\r\n            <svg\r\n              width=\"20\"\r\n              height=\"20\"\r\n              viewBox=\"0 0 16 16\"\r\n              fill=\"currentColor\"\r\n              aria-hidden=\"true\"\r\n            >\r\n              <path d=\"M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z\"/>\r\n              <path d=\"M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z\"/>\r\n            </svg>\r\n            {errors.submit}\r\n          </div>\r\n        )}\r\n        \r\n        {/* Botones de acci√≥n */}\r\n        <div \r\n          className=\"form-actions\"\r\n          style={{\r\n            display: 'flex',\r\n            gap: '1rem',\r\n            marginTop: '1.5rem',\r\n            justifyContent: 'flex-end'\r\n          }}\r\n        >\r\n          {onCancel && (\r\n            <button\r\n              type=\"button\"\r\n              onClick={handleCancel}\r\n              disabled={isSubmitting || loading}\r\n              className=\"btn btn-secondary\"\r\n              style={{\r\n                padding: '0.5rem 1rem',\r\n                border: '1px solid #6c757d',\r\n                backgroundColor: '#6c757d',\r\n                color: '#ffffff',\r\n                borderRadius: '0.25rem',\r\n                cursor: isSubmitting || loading ? 'not-allowed' : 'pointer',\r\n                opacity: isSubmitting || loading ? 0.6 : 1,\r\n                fontSize: '0.875rem',\r\n                fontWeight: '500',\r\n                transition: 'all 0.2s ease'\r\n              }}\r\n              aria-label={cancelButtonText}\r\n            >\r\n              {cancelButtonText}\r\n            </button>\r\n          )}\r\n          \r\n          <button\r\n            type=\"submit\"\r\n            disabled={isSubmitting || loading}\r\n            className=\"btn btn-primary\"\r\n            style={{\r\n              padding: '0.5rem 1rem',\r\n              border: '1px solid #007bff',\r\n              backgroundColor: '#007bff',\r\n              color: '#ffffff',\r\n              borderRadius: '0.25rem',\r\n              cursor: isSubmitting || loading ? 'not-allowed' : 'pointer',\r\n              opacity: isSubmitting || loading ? 0.6 : 1,\r\n              fontSize: '0.875rem',\r\n              fontWeight: '500',\r\n              transition: 'all 0.2s ease',\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              gap: '0.5rem'\r\n            }}\r\n            aria-label={loading ? 'Enviando formulario...' : submitButtonText}\r\n            aria-describedby={Object.keys(errors).some(key => errors[key] && touched[key]) ? 'form-errors' : undefined}\r\n          >\r\n            {loading || isSubmitting ? (\r\n              <>\r\n                <svg\r\n                  width=\"16\"\r\n                  height=\"16\"\r\n                  viewBox=\"0 0 16 16\"\r\n                  fill=\"currentColor\"\r\n                  aria-hidden=\"true\"\r\n                  className=\"animate-spin\"\r\n                >\r\n                  <path d=\"M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z\"/>\r\n                  <path d=\"M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z\"/>\r\n                </svg>\r\n                Enviando...\r\n              </>\r\n            ) : (\r\n              submitButtonText\r\n            )}\r\n          </button>\r\n        </div>\r\n      </form>\r\n      \r\n      {/* Estilos para accesibilidad */}\r\n      <style jsx>{`\r\n        .sr-only {\r\n          position: absolute;\r\n          width: 1px;\r\n          height: 1px;\r\n          padding: 0;\r\n          margin: -1px;\r\n          overflow: hidden;\r\n          clip: rect(0, 0, 0, 0);\r\n          white-space: nowrap;\r\n          border: 0;\r\n        }\r\n        \r\n        .accessible-form :focus {\r\n          outline: 2px solid #007bff;\r\n          outline-offset: 2px;\r\n        }\r\n        \r\n        .accessible-form .error:focus {\r\n          outline: 2px solid #dc3545;\r\n          outline-offset: 2px;\r\n        }\r\n        \r\n        .accessible-form input.error,\r\n        .accessible-form select.error,\r\n        .accessible-form textarea.error {\r\n          border-color: #dc3545;\r\n          box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);\r\n        }\r\n        \r\n        .animate-spin {\r\n          animation: spin 1s linear infinite;\r\n        }\r\n        \r\n        @keyframes spin {\r\n          from {\r\n            transform: rotate(0deg);\r\n          }\r\n          to {\r\n            transform: rotate(360deg);\r\n          }\r\n        }\r\n        \r\n        @media (prefers-reduced-motion: reduce) {\r\n          .animate-spin {\r\n            animation: none;\r\n          }\r\n          \r\n          .accessible-form * {\r\n            transition: none !important;\r\n          }\r\n        }\r\n      `}</style>\r\n    </>\r\n  );\r\n};\r\n\r\n/**\r\n * Componente de campo de formulario accesible\r\n */\r\nexport const AccessibleField = ({\r\n  label,\r\n  name,\r\n  type = 'text',\r\n  required = false,\r\n  placeholder,\r\n  autoComplete,\r\n  ariaLabel,\r\n  ariaDescribedBy,\r\n  className = '',\r\n  ...props\r\n}) => {\r\n  const fieldId = `field-${name}`;\r\n  const errorId = `${name}-error`;\r\n  \r\n  return (\r\n    <div className=\"form-field\" style={{ marginBottom: '1rem' }}>\r\n      {label && (\r\n        <label \r\n          htmlFor={fieldId}\r\n          className=\"field-label\"\r\n          style={{\r\n            display: 'block',\r\n            marginBottom: '0.5rem',\r\n            fontWeight: '500',\r\n            color: '#374151',\r\n            fontSize: '0.875rem'\r\n          }}\r\n        >\r\n          {label}\r\n          {required && (\r\n            <span \r\n              className=\"required-indicator\"\r\n              style={{\r\n                color: '#dc3545',\r\n                marginLeft: '0.25rem'\r\n              }}\r\n              aria-label=\"requerido\"\r\n            >\r\n              *\r\n            </span>\r\n          )}\r\n        </label>\r\n      )}\r\n      \r\n      <input\r\n        id={fieldId}\r\n        name={name}\r\n        type={type}\r\n        required={required}\r\n        placeholder={placeholder}\r\n        autoComplete={autoComplete}\r\n        aria-label={ariaLabel}\r\n        aria-describedby={ariaDescribedBy}\r\n        aria-required={required}\r\n        className={`form-input ${className}`}\r\n        style={{\r\n          width: '100%',\r\n          padding: '0.5rem',\r\n          border: '1px solid #d1d5db',\r\n          borderRadius: '0.25rem',\r\n          fontSize: '0.875rem',\r\n          lineHeight: '1.5',\r\n          transition: 'border-color 0.2s ease, box-shadow 0.2s ease'\r\n        }}\r\n        {...props}\r\n      />\r\n    </div>\r\n  );\r\n};\r\n\r\n/**\r\n * Componente de select accesible\r\n */\r\nexport const AccessibleSelect = ({\r\n  label,\r\n  name,\r\n  options = [],\r\n  required = false,\r\n  placeholder,\r\n  ariaLabel,\r\n  className = '',\r\n  ...props\r\n}) => {\r\n  const fieldId = `select-${name}`;\r\n  \r\n  return (\r\n    <div className=\"form-field\" style={{ marginBottom: '1rem' }}>\r\n      {label && (\r\n        <label \r\n          htmlFor={fieldId}\r\n          className=\"field-label\"\r\n          style={{\r\n            display: 'block',\r\n            marginBottom: '0.5rem',\r\n            fontWeight: '500',\r\n            color: '#374151',\r\n            fontSize: '0.875rem'\r\n          }}\r\n        >\r\n          {label}\r\n          {required && (\r\n            <span \r\n              className=\"required-indicator\"\r\n              style={{\r\n                color: '#dc3545',\r\n                marginLeft: '0.25rem'\r\n              }}\r\n              aria-label=\"requerido\"\r\n            >\r\n              *\r\n            </span>\r\n          )}\r\n        </label>\r\n      )}\r\n      \r\n      <select\r\n        id={fieldId}\r\n        name={name}\r\n        required={required}\r\n        aria-label={ariaLabel}\r\n        aria-required={required}\r\n        className={`form-select ${className}`}\r\n        style={{\r\n          width: '100%',\r\n          padding: '0.5rem',\r\n          border: '1px solid #d1d5db',\r\n          borderRadius: '0.25rem',\r\n          fontSize: '0.875rem',\r\n          lineHeight: '1.5',\r\n          backgroundColor: '#ffffff',\r\n          transition: 'border-color 0.2s ease, box-shadow 0.2s ease'\r\n        }}\r\n        {...props}\r\n      >\r\n        {placeholder && (\r\n          <option value=\"\" disabled>\r\n            {placeholder}\r\n          </option>\r\n        )}\r\n        \r\n        {options.map((option) => (\r\n          <option \r\n            key={option.value} \r\n            value={option.value}\r\n            disabled={option.disabled}\r\n          >\r\n            {option.label}\r\n          </option>\r\n        ))}\r\n      </select>\r\n    </div>\r\n  );\r\n};\r\n\r\n/**\r\n * Componente de textarea accesible\r\n */\r\nexport const AccessibleTextarea = ({\r\n  label,\r\n  name,\r\n  required = false,\r\n  placeholder,\r\n  rows = 4,\r\n  maxLength,\r\n  ariaLabel,\r\n  className = '',\r\n  ...props\r\n}) => {\r\n  const fieldId = `textarea-${name}`;\r\n  const characterCountId = `${name}-char-count`;\r\n  \r\n  return (\r\n    <div className=\"form-field\" style={{ marginBottom: '1rem' }}>\r\n      {label && (\r\n        <label \r\n          htmlFor={fieldId}\r\n          className=\"field-label\"\r\n          style={{\r\n            display: 'block',\r\n            marginBottom: '0.5rem',\r\n            fontWeight: '500',\r\n            color: '#374151',\r\n            fontSize: '0.875rem'\r\n          }}\r\n        >\r\n          {label}\r\n          {required && (\r\n            <span \r\n              className=\"required-indicator\"\r\n              style={{\r\n                color: '#dc3545',\r\n                marginLeft: '0.25rem'\r\n              }}\r\n              aria-label=\"requerido\"\r\n            >\r\n              *\r\n            </span>\r\n          )}\r\n        </label>\r\n      )}\r\n      \r\n      <textarea\r\n        id={fieldId}\r\n        name={name}\r\n        required={required}\r\n        placeholder={placeholder}\r\n        rows={rows}\r\n        maxLength={maxLength}\r\n        aria-label={ariaLabel}\r\n        aria-required={required}\r\n        aria-describedby={maxLength ? characterCountId : undefined}\r\n        className={`form-textarea ${className}`}\r\n        style={{\r\n          width: '100%',\r\n          padding: '0.5rem',\r\n          border: '1px solid #d1d5db',\r\n          borderRadius: '0.25rem',\r\n          fontSize: '0.875rem',\r\n          lineHeight: '1.5',\r\n          resize: 'vertical',\r\n          transition: 'border-color 0.2s ease, box-shadow 0.2s ease'\r\n        }}\r\n        {...props}\r\n      />\r\n      \r\n      {maxLength && (\r\n        <div \r\n          id={characterCountId}\r\n          className=\"character-count\"\r\n          style={{\r\n            fontSize: '0.75rem',\r\n            color: '#6b7280',\r\n            textAlign: 'right',\r\n            marginTop: '0.25rem'\r\n          }}\r\n          aria-live=\"polite\"\r\n        >\r\n          <span id={`${name}-current-count`}>0</span> / {maxLength} caracteres\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default AccessibleForm;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\common\\DragDropUpload.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'dragCounter' is assigned a value but never used.","line":23,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useCallback, useEffect } from 'react'\r\nimport { CloudArrowUpIcon, DocumentIcon, XMarkIcon } from '@heroicons/react/24/outline'\r\nimport toast from 'react-hot-toast'\r\n\r\nconst DragDropUpload = ({ \r\n  onFilesSelected, \r\n  onUpload, \r\n  selectedFolder = null,\r\n  folders = [],\r\n  onFolderChange = null,\r\n  acceptedTypes = '.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,text/plain',\r\n  maxFiles = 10,\r\n  maxFileSize = 50 * 1024 * 1024, // 50MB por defecto\r\n  className = '',\r\n  showFolderSelector = true,\r\n  uploading = false,\r\n  uploadProgress = {},\r\n  clearFilesAfterUpload = true,\r\n  children\r\n}) => {\r\n  const [isDragOver, setIsDragOver] = useState(false)\r\n  const [selectedFiles, setSelectedFiles] = useState([])\r\n  const [dragCounter, setDragCounter] = useState(0)\r\n  const [wasUploading, setWasUploading] = useState(false)\r\n\r\n  // Detectar cuando la subida se complete exitosamente y limpiar archivos\r\n  useEffect(() => {\r\n    if (clearFilesAfterUpload && wasUploading && !uploading && selectedFiles.length > 0) {\r\n      // Si la subida termin√≥ (uploading cambi√≥ de true a false), limpiar archivos\r\n      // No dependemos del uploadProgress porque se resetea inmediatamente\r\n      setSelectedFiles([])\r\n      onFilesSelected?.([])\r\n    }\r\n    \r\n    // Actualizar el estado de \"estaba subiendo\"\r\n    setWasUploading(uploading)\r\n  }, [uploading, selectedFiles.length, clearFilesAfterUpload, onFilesSelected, wasUploading])\r\n\r\n  // Validar tipo de archivo\r\n  const isValidFileType = useCallback((file) => {\r\n    if (!acceptedTypes) return true\r\n    \r\n    const acceptedTypesArray = acceptedTypes.split(',')\r\n    const fileExtension = '.' + file.name.split('.').pop().toLowerCase()\r\n    const fileMimeType = file.type\r\n    \r\n    return acceptedTypesArray.some(type => {\r\n      const cleanType = type.trim()\r\n      return cleanType === fileExtension || cleanType === fileMimeType\r\n    })\r\n  }, [acceptedTypes])\r\n\r\n  // Validar tama√±o de archivo\r\n  const isValidFileSize = useCallback((file) => {\r\n    return file.size <= maxFileSize\r\n  }, [maxFileSize])\r\n\r\n  // Formatear tama√±o de archivo\r\n  const formatFileSize = (bytes) => {\r\n    if (bytes === 0) return '0 Bytes'\r\n    const k = 1024\r\n    const sizes = ['Bytes', 'KB', 'MB', 'GB']\r\n    const i = Math.floor(Math.log(bytes) / Math.log(k))\r\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]\r\n  }\r\n\r\n  // Procesar archivos seleccionados\r\n  const processFiles = useCallback((fileList) => {\r\n    const files = Array.from(fileList)\r\n    const validFiles = []\r\n    const errors = []\r\n\r\n    // Verificar l√≠mite de archivos\r\n    if (selectedFiles.length + files.length > maxFiles) {\r\n      toast.error(`M√°ximo ${maxFiles} archivos permitidos`)\r\n      return\r\n    }\r\n\r\n    files.forEach(file => {\r\n      // Verificar si el archivo ya est√° seleccionado\r\n      if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) {\r\n        errors.push(`${file.name}: Archivo ya seleccionado`)\r\n        return\r\n      }\r\n\r\n      // Validar tipo de archivo\r\n      if (!isValidFileType(file)) {\r\n        errors.push(`${file.name}: Tipo de archivo no permitido`)\r\n        return\r\n      }\r\n\r\n      // Validar tama√±o de archivo\r\n      if (!isValidFileSize(file)) {\r\n        errors.push(`${file.name}: Archivo demasiado grande (m√°x. ${formatFileSize(maxFileSize)})`)\r\n        return\r\n      }\r\n\r\n      validFiles.push(file)\r\n    })\r\n\r\n    // Mostrar errores si los hay\r\n    if (errors.length > 0) {\r\n      errors.forEach(error => toast.error(error))\r\n    }\r\n\r\n    // Agregar archivos v√°lidos\r\n    if (validFiles.length > 0) {\r\n      const newSelectedFiles = [...selectedFiles, ...validFiles]\r\n      setSelectedFiles(newSelectedFiles)\r\n      onFilesSelected?.(newSelectedFiles)\r\n      toast.success(`${validFiles.length} archivo(s) seleccionado(s)`)\r\n    }\r\n  }, [selectedFiles, maxFiles, isValidFileType, isValidFileSize, maxFileSize, onFilesSelected])\r\n\r\n  // Manejar drag enter\r\n  const handleDragEnter = useCallback((e) => {\r\n    e.preventDefault()\r\n    e.stopPropagation()\r\n    setDragCounter(prev => prev + 1)\r\n    if (e.dataTransfer.items && e.dataTransfer.items.length > 0) {\r\n      setIsDragOver(true)\r\n    }\r\n  }, [])\r\n\r\n  // Manejar drag leave\r\n  const handleDragLeave = useCallback((e) => {\r\n    e.preventDefault()\r\n    e.stopPropagation()\r\n    setDragCounter(prev => {\r\n      const newCounter = prev - 1\r\n      if (newCounter === 0) {\r\n        setIsDragOver(false)\r\n      }\r\n      return newCounter\r\n    })\r\n  }, [])\r\n\r\n  // Manejar drag over\r\n  const handleDragOver = useCallback((e) => {\r\n    e.preventDefault()\r\n    e.stopPropagation()\r\n  }, [])\r\n\r\n  // Manejar drop\r\n  const handleDrop = useCallback((e) => {\r\n    e.preventDefault()\r\n    e.stopPropagation()\r\n    setIsDragOver(false)\r\n    setDragCounter(0)\r\n\r\n    const files = e.dataTransfer.files\r\n    if (files && files.length > 0) {\r\n      processFiles(files)\r\n    }\r\n  }, [processFiles])\r\n\r\n  // Manejar selecci√≥n de archivos desde input\r\n  const handleFileSelect = useCallback((e) => {\r\n    const files = e.target.files\r\n    if (files && files.length > 0) {\r\n      processFiles(files)\r\n    }\r\n    // Limpiar el input para permitir seleccionar el mismo archivo nuevamente\r\n    e.target.value = ''\r\n  }, [processFiles])\r\n\r\n  // Remover archivo seleccionado\r\n  const removeFile = useCallback((index) => {\r\n    const newSelectedFiles = selectedFiles.filter((_, i) => i !== index)\r\n    setSelectedFiles(newSelectedFiles)\r\n    onFilesSelected?.(newSelectedFiles)\r\n  }, [selectedFiles, onFilesSelected])\r\n\r\n  // Limpiar archivos seleccionados\r\n  const clearFiles = useCallback(() => {\r\n    setSelectedFiles([])\r\n    onFilesSelected?.([])\r\n  }, [onFilesSelected])\r\n\r\n  // Manejar subida\r\n  const handleUpload = useCallback(() => {\r\n    if (selectedFiles.length === 0) {\r\n      toast.error('Selecciona al menos un archivo')\r\n      return\r\n    }\r\n\r\n    if (showFolderSelector && !selectedFolder) {\r\n      toast.error('Selecciona una carpeta de destino')\r\n      return\r\n    }\r\n\r\n    onUpload?.(selectedFiles, selectedFolder)\r\n  }, [selectedFiles, selectedFolder, showFolderSelector, onUpload])\r\n\r\n  return (\r\n    <div className={`space-y-4 ${className}`}>\r\n      {/* Zona de drag & drop */}\r\n      <div\r\n        onDragEnter={handleDragEnter}\r\n        onDragLeave={handleDragLeave}\r\n        onDragOver={handleDragOver}\r\n        onDrop={handleDrop}\r\n        className={`\r\n          relative border-2 border-dashed rounded-lg p-8 text-center transition-all duration-200\r\n          ${isDragOver \r\n            ? 'border-primary-500 bg-primary-50 scale-105' \r\n            : 'border-gray-300 hover:border-gray-400'\r\n          }\r\n          ${uploading ? 'pointer-events-none opacity-50' : 'cursor-pointer'}\r\n        `}\r\n      >\r\n        <input\r\n          type=\"file\"\r\n          multiple\r\n          accept={acceptedTypes}\r\n          onChange={handleFileSelect}\r\n          className=\"absolute inset-0 w-full h-full opacity-0 cursor-pointer\"\r\n          disabled={uploading}\r\n        />\r\n        \r\n        <div className=\"space-y-4\">\r\n          <CloudArrowUpIcon className={`mx-auto h-12 w-12 ${\r\n            isDragOver ? 'text-primary-500' : 'text-gray-400'\r\n          }`} />\r\n          \r\n          <div>\r\n            <h3 className={`text-lg font-medium ${\r\n              isDragOver ? 'text-primary-700' : 'text-gray-900'\r\n            }`}>\r\n              {isDragOver ? '¬°Suelta los archivos aqu√≠!' : 'Arrastra archivos aqu√≠'}\r\n            </h3>\r\n            <p className=\"text-gray-600 mt-1\">\r\n              o <span className=\"text-primary-600 font-medium\">haz clic para seleccionar</span>\r\n            </p>\r\n            <p className=\"text-sm text-gray-500 mt-2\">\r\n              M√°ximo {maxFiles} archivos ‚Ä¢ Tama√±o m√°ximo: {formatFileSize(maxFileSize)}\r\n            </p>\r\n          </div>\r\n        </div>\r\n        \r\n        {/* Overlay cuando se est√° arrastrando */}\r\n        {isDragOver && (\r\n          <div className=\"absolute inset-0 bg-primary-500 bg-opacity-10 rounded-lg flex items-center justify-center\">\r\n            <div className=\"text-primary-700 font-medium text-lg\">\r\n              ¬°Suelta aqu√≠!\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Selector de carpeta */}\r\n      {showFolderSelector && folders.length > 0 && (\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n            Carpeta de destino\r\n          </label>\r\n          <select\r\n            value={selectedFolder || ''}\r\n            onChange={(e) => onFolderChange?.(e.target.value)}\r\n            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\r\n            disabled={uploading}\r\n          >\r\n            <option value=\"\">Seleccionar carpeta</option>\r\n            {folders\r\n              .filter(folder => {\r\n                const name = folder.type === 'admin' ? folder.folder_name : folder.correo\r\n                return name && name.trim() !== ''\r\n              })\r\n              .map((folder) => {\r\n                const displayName = folder.type === 'admin' \r\n                  ? folder.folder_name \r\n                  : `${folder.correo} (Usuario)`\r\n                return (\r\n                  <option key={folder.id} value={folder.id}>\r\n                    {displayName}\r\n                  </option>\r\n                )\r\n              })}\r\n          </select>\r\n        </div>\r\n      )}\r\n\r\n      {/* Lista de archivos seleccionados */}\r\n      {selectedFiles.length > 0 && (\r\n        <div>\r\n          <div className=\"flex items-center justify-between mb-3\">\r\n            <h4 className=\"text-sm font-medium text-gray-700\">\r\n              Archivos seleccionados ({selectedFiles.length})\r\n            </h4>\r\n            <button\r\n              onClick={clearFiles}\r\n              className=\"text-sm text-red-600 hover:text-red-700\"\r\n              disabled={uploading}\r\n            >\r\n              Limpiar todo\r\n            </button>\r\n          </div>\r\n          \r\n          <div className=\"max-h-40 overflow-y-auto space-y-2 border border-gray-200 rounded-lg p-3\">\r\n            {selectedFiles.map((file, index) => {\r\n              const fileId = `file-${index}`\r\n              const progress = uploadProgress[fileId] || 0\r\n              const hasError = progress === -1\r\n              \r\n              return (\r\n                <div key={index} className=\"flex items-center justify-between p-2 bg-gray-50 rounded\">\r\n                  <div className=\"flex items-center space-x-3 flex-1\">\r\n                    <DocumentIcon className=\"h-5 w-5 text-gray-400\" />\r\n                    <div className=\"flex-1 min-w-0\">\r\n                      <p className=\"text-sm font-medium text-gray-900 truncate\">\r\n                        {file.name}\r\n                      </p>\r\n                      <p className=\"text-xs text-gray-500\">\r\n                        {formatFileSize(file.size)}\r\n                      </p>\r\n                      \r\n                      {/* Barra de progreso durante la subida */}\r\n                      {uploading && progress > 0 && (\r\n                        <div className=\"mt-1\">\r\n                          <div className=\"flex justify-between text-xs\">\r\n                            <span className={hasError ? 'text-red-600' : 'text-gray-600'}>\r\n                              {hasError ? 'Error' : `${progress}%`}\r\n                            </span>\r\n                          </div>\r\n                          <div className=\"w-full bg-gray-200 rounded-full h-1.5 mt-1\">\r\n                            <div \r\n                              className={`h-1.5 rounded-full transition-all duration-300 ${\r\n                                hasError ? 'bg-red-500' : 'bg-primary-500'\r\n                              }`}\r\n                              style={{ width: hasError ? '100%' : `${progress}%` }}\r\n                            />\r\n                          </div>\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                  \r\n                  {!uploading && (\r\n                    <button\r\n                      onClick={() => removeFile(index)}\r\n                      className=\"text-gray-400 hover:text-red-500 p-1\"\r\n                    >\r\n                      <XMarkIcon className=\"h-4 w-4\" />\r\n                    </button>\r\n                  )}\r\n                </div>\r\n              )\r\n            })}\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Bot√≥n de subida */}\r\n      {selectedFiles.length > 0 && (\r\n        <div className=\"flex justify-end space-x-3\">\r\n          {!uploading && (\r\n            <button\r\n              onClick={clearFiles}\r\n              className=\"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors\"\r\n            >\r\n              Cancelar\r\n            </button>\r\n          )}\r\n          \r\n          <button\r\n            onClick={handleUpload}\r\n            disabled={uploading || selectedFiles.length === 0 || (showFolderSelector && !selectedFolder)}\r\n            className=\"px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center\"\r\n          >\r\n            <CloudArrowUpIcon className=\"h-5 w-5 mr-2\" />\r\n            {uploading ? 'Subiendo...' : `Subir ${selectedFiles.length} archivo(s)`}\r\n          </button>\r\n        </div>\r\n      )}\r\n\r\n      {/* Contenido adicional */}\r\n      {children}\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default DragDropUpload","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\common\\EnhancedLoadingSpinner.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\common\\ErrorBoundary.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\common\\ErrorNotifications.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\common\\ErrorNotificationsAccessible.js","messages":[{"ruleId":"default-case","severity":1,"message":"Expected a default case.","line":134,"column":5,"nodeType":"SwitchStatement","messageId":"missingDefaultCase","endLine":155,"endColumn":6}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\r\nimport { useErrorHandler } from '../../hooks/useErrorHandler.js';\r\n\r\n/**\r\n * Componente para mostrar notificaciones de errores con accesibilidad completa\r\n */\r\nconst ErrorNotificationsAccessible = ({ position = 'top-right', maxVisible = 5 }) => {\r\n  const { errors, removeError, clearErrors, errorCounts } = useErrorHandler({\r\n    enableNotifications: true,\r\n    maxErrors: maxVisible * 2\r\n  });\r\n\r\n  const [showDetails, setShowDetails] = useState(false);\r\n  const [focusedErrorId, setFocusedErrorId] = useState(null);\r\n  const notificationRef = useRef(null);\r\n  const firstErrorRef = useRef(null);\r\n\r\n  // Filtrar errores visibles\r\n  const visibleErrors = errors.slice(-maxVisible);\r\n\r\n  // Estilos seg√∫n posici√≥n\r\n  const getPositionStyles = () => {\r\n    const baseStyles = {\r\n      position: 'fixed',\r\n      zIndex: 9999,\r\n      maxWidth: '400px',\r\n      width: '100%'\r\n    };\r\n\r\n    switch (position) {\r\n      case 'top-right':\r\n        return { ...baseStyles, top: '20px', right: '20px' };\r\n      case 'top-left':\r\n        return { ...baseStyles, top: '20px', left: '20px' };\r\n      case 'bottom-right':\r\n        return { ...baseStyles, bottom: '20px', right: '20px' };\r\n      case 'bottom-left':\r\n        return { ...baseStyles, bottom: '20px', left: '20px' };\r\n      default:\r\n        return { ...baseStyles, top: '20px', right: '20px' };\r\n    }\r\n  };\r\n\r\n  // Obtener color con mejor contraste seg√∫n severidad\r\n  const getSeverityColors = (severity) => {\r\n    switch (severity) {\r\n      case 'CRITICAL':\r\n        return {\r\n          bg: '#dc3545',\r\n          text: '#ffffff',\r\n          border: '#a71d2a',\r\n          focus: '#a71d2a'\r\n        };\r\n      case 'HIGH':\r\n        return {\r\n          bg: '#fd7e14',\r\n          text: '#ffffff',\r\n          border: '#c85a0b',\r\n          focus: '#c85a0b'\r\n        };\r\n      case 'MEDIUM':\r\n        return {\r\n          bg: '#ffc107',\r\n          text: '#212529',\r\n          border: '#d39e00',\r\n          focus: '#d39e00'\r\n        };\r\n      case 'LOW':\r\n        return {\r\n          bg: '#17a2b8',\r\n          text: '#ffffff',\r\n          border: '#117a8b',\r\n          focus: '#117a8b'\r\n        };\r\n      default:\r\n        return {\r\n          bg: '#6c757d',\r\n          text: '#ffffff',\r\n          border: '#545b62',\r\n          focus: '#545b62'\r\n        };\r\n    }\r\n  };\r\n\r\n  // Obtener √≠cono y descripci√≥n seg√∫n tipo\r\n  const getTypeInfo = (type) => {\r\n    const typeMap = {\r\n      'NETWORK': {\r\n        icon: 'üåê',\r\n        description: 'Error de red',\r\n        ariaLabel: 'Error de conexi√≥n o red'\r\n      },\r\n      'DATABASE': {\r\n        icon: 'üóÑÔ∏è',\r\n        description: 'Error de base de datos',\r\n        ariaLabel: 'Error en base de datos'\r\n      },\r\n      'AUTHENTICATION': {\r\n        icon: 'üîê',\r\n        description: 'Error de autenticaci√≥n',\r\n        ariaLabel: 'Error de autenticaci√≥n'\r\n      },\r\n      'VALIDATION': {\r\n        icon: '‚ö†Ô∏è',\r\n        description: 'Error de validaci√≥n',\r\n        ariaLabel: 'Error de validaci√≥n de datos'\r\n      },\r\n      'BUSINESS_LOGIC': {\r\n        icon: 'üíº',\r\n        description: 'Error de l√≥gica',\r\n        ariaLabel: 'Error de l√≥gica de negocio'\r\n      },\r\n      'UI': {\r\n        icon: 'üñ•Ô∏è',\r\n        description: 'Error de interfaz',\r\n        ariaLabel: 'Error de interfaz de usuario'\r\n      },\r\n      'SYSTEM': {\r\n        icon: '‚öôÔ∏è',\r\n        description: 'Error del sistema',\r\n        ariaLabel: 'Error del sistema'\r\n      },\r\n      default: {\r\n        icon: '‚ùå',\r\n        description: 'Error desconocido',\r\n        ariaLabel: 'Error no especificado'\r\n      }\r\n    };\r\n    return typeMap[type] || typeMap.default;\r\n  };\r\n\r\n  // Manejar navegaci√≥n por teclado\r\n  const handleKeyDown = (event, errorId, action) => {\r\n    switch (event.key) {\r\n      case 'Enter':\r\n      case ' ':\r\n        event.preventDefault();\r\n        action();\r\n        break;\r\n      case 'Escape':\r\n        if (showDetails) {\r\n          setShowDetails(false);\r\n        } else {\r\n          removeError(errorId);\r\n        }\r\n        break;\r\n      case 'ArrowDown':\r\n        event.preventDefault();\r\n        focusNextError(errorId);\r\n        break;\r\n      case 'ArrowUp':\r\n        event.preventDefault();\r\n        focusPreviousError(errorId);\r\n        break;\r\n    }\r\n  };\r\n\r\n  // Enfocar siguiente error\r\n  const focusNextError = (currentErrorId) => {\r\n    const currentIndex = visibleErrors.findIndex(err => err.errorId === currentErrorId);\r\n    if (currentIndex < visibleErrors.length - 1) {\r\n      const nextErrorId = visibleErrors[currentIndex + 1].errorId;\r\n      setFocusedErrorId(nextErrorId);\r\n    }\r\n  };\r\n\r\n  // Enfocar error anterior\r\n  const focusPreviousError = (currentErrorId) => {\r\n    const currentIndex = visibleErrors.findIndex(err => err.errorId === currentErrorId);\r\n    if (currentIndex > 0) {\r\n      const prevErrorId = visibleErrors[currentIndex - 1].errorId;\r\n      setFocusedErrorId(prevErrorId);\r\n    }\r\n  };\r\n\r\n  // Anunciar errores para lectores de pantalla\r\n  useEffect(() => {\r\n    if (visibleErrors.length > 0) {\r\n      const latestError = visibleErrors[visibleErrors.length - 1];\r\n      const typeInfo = getTypeInfo(latestError.type);\r\n      \r\n      // Crear mensaje para lector de pantalla\r\n      const announcement = `${typeInfo.ariaLabel}: ${latestError.message}. Severidad: ${latestError.severity}.`;\r\n      \r\n      // Usar aria-live region para anunciar\r\n      const liveRegion = document.getElementById('error-announcements');\r\n      if (liveRegion) {\r\n        liveRegion.textContent = announcement;\r\n      }\r\n    }\r\n  }, [visibleErrors]);\r\n\r\n  // Enfocar primer error cuando aparece\r\n  useEffect(() => {\r\n    if (visibleErrors.length > 0 && firstErrorRef.current) {\r\n      firstErrorRef.current.focus();\r\n    }\r\n  }, [visibleErrors.length]);\r\n\r\n  if (visibleErrors.length === 0 && errorCounts.total === 0) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {/* Regi√≥n live para anuncios de accesibilidad */}\r\n      <div\r\n        id=\"error-announcements\"\r\n        aria-live=\"polite\"\r\n        aria-atomic=\"true\"\r\n        className=\"sr-only\"\r\n      />\r\n      \r\n      {/* Contenedor principal */}\r\n      <div \r\n        ref={notificationRef}\r\n        style={getPositionStyles()}\r\n        role=\"region\"\r\n        aria-label=\"Notificaciones de error\"\r\n        aria-live=\"polite\"\r\n      >\r\n        {/* Indicador de errores en la esquina */}\r\n        {visibleErrors.length === 0 && errorCounts.total > 0 && (\r\n          <button\r\n            onClick={() => setShowDetails(true)}\r\n            onKeyDown={(e) => handleKeyDown(e, 'indicator', () => setShowDetails(true))}\r\n            style={{\r\n              backgroundColor: getSeverityColors(\r\n                errorCounts.critical > 0 ? 'CRITICAL' :\r\n                errorCounts.high > 0 ? 'HIGH' :\r\n                errorCounts.medium > 0 ? 'MEDIUM' : 'LOW'\r\n              ).bg,\r\n              color: '#ffffff',\r\n              padding: '8px 12px',\r\n              borderRadius: '20px',\r\n              cursor: 'pointer',\r\n              fontSize: '12px',\r\n              fontWeight: 'bold',\r\n              textAlign: 'center',\r\n              boxShadow: '0 2px 10px rgba(0,0,0,0.2)',\r\n              transition: 'all 0.3s ease',\r\n              border: '2px solid transparent'\r\n            }}\r\n            title={`Hay ${errorCounts.total} error(es) pendientes. Presiona Enter para ver detalles.`}\r\n            aria-label={`${errorCounts.total} error(es) pendientes. Presiona Enter para ver detalles.`}\r\n          >\r\n            {errorCounts.total} error(es) ‚ö†Ô∏è\r\n          </button>\r\n        )}\r\n\r\n        {/* Notificaciones individuales */}\r\n        {visibleErrors.map((error, index) => {\r\n          const typeInfo = getTypeInfo(error.type);\r\n          const colors = getSeverityColors(error.severity);\r\n          const isFocused = focusedErrorId === error.errorId;\r\n          const isFirst = index === 0;\r\n\r\n          return (\r\n            <div\r\n              key={error.errorId}\r\n              ref={isFirst ? firstErrorRef : null}\r\n              style={{\r\n                backgroundColor: '#ffffff',\r\n                border: `2px solid ${colors.border}`,\r\n                borderRadius: '8px',\r\n                padding: '12px',\r\n                marginBottom: '10px',\r\n                boxShadow: isFocused ? `0 0 0 3px ${colors.focus}` : '0 4px 12px rgba(0,0,0,0.15)',\r\n                animation: `slideIn 0.3s ease-out`,\r\n                opacity: visibleErrors.length - index === visibleErrors.length ? 1 : 0.9,\r\n                transform: `translateY(${(visibleErrors.length - index - 1) * 10}px)`\r\n              }}\r\n              role=\"alert\"\r\n              aria-labelledby={`error-title-${error.errorId}`}\r\n              aria-describedby={`error-message-${error.errorId} error-details-${error.errorId}`}\r\n              tabIndex={isFirst ? 0 : -1}\r\n              onKeyDown={(e) => handleKeyDown(e, error.errorId, () => setFocusedErrorId(error.errorId))}\r\n            >\r\n              {/* Cabecera accesible */}\r\n              <div style={{\r\n                display: 'flex',\r\n                justifyContent: 'space-between',\r\n                alignItems: 'center',\r\n                marginBottom: '8px'\r\n              }}>\r\n                <div style={{\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  gap: '8px'\r\n                }}>\r\n                  <span \r\n                    style={{ fontSize: '16px' }}\r\n                    role=\"img\"\r\n                    aria-label={typeInfo.ariaLabel}\r\n                    aria-hidden=\"false\"\r\n                  >\r\n                    {typeInfo.icon}\r\n                  </span>\r\n                  <div>\r\n                    <span \r\n                      id={`error-title-${error.errorId}`}\r\n                      style={{\r\n                        fontWeight: 'bold',\r\n                        color: colors.bg,\r\n                        fontSize: '12px',\r\n                        textTransform: 'uppercase',\r\n                        display: 'block'\r\n                      }}\r\n                      aria-label={`Severidad: ${error.severity}`}\r\n                    >\r\n                      {error.severity}\r\n                    </span>\r\n                    <span \r\n                      style={{\r\n                        fontSize: '10px',\r\n                        color: '#666',\r\n                        display: 'block'\r\n                      }}\r\n                      aria-label={`Tipo: ${typeInfo.description}`}\r\n                    >\r\n                      {typeInfo.description}\r\n                    </span>\r\n                  </div>\r\n                </div>\r\n                \r\n                <button\r\n                  ref={isFocused ? null : undefined}\r\n                  onClick={() => removeError(error.errorId)}\r\n                  onKeyDown={(e) => handleKeyDown(e, error.errorId, () => removeError(error.errorId))}\r\n                  style={{\r\n                    background: 'none',\r\n                    border: 'none',\r\n                    fontSize: '18px',\r\n                    cursor: 'pointer',\r\n                    color: '#666',\r\n                    padding: '0',\r\n                    width: '20px',\r\n                    height: '20px',\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    justifyContent: 'center',\r\n                    borderRadius: '50%'\r\n                  }}\r\n                  title={`Cerrar error ${error.errorId}. Presiona Enter o Escape para cerrar.`}\r\n                  aria-label={`Cerrar error ${error.errorId}`}\r\n                >\r\n                  √ó\r\n                </button>\r\n              </div>\r\n\r\n              {/* Mensaje de error */}\r\n              <div \r\n                id={`error-message-${error.errorId}`}\r\n                style={{\r\n                  color: '#333',\r\n                  fontSize: '14px',\r\n                  lineHeight: '1.4',\r\n                  marginBottom: '8px'\r\n                }}\r\n              >\r\n                {error.message}\r\n              </div>\r\n\r\n              {/* Detalles adicionales */}\r\n              {(error.context || error.component) && (\r\n                <div \r\n                  id={`error-details-${error.errorId}`}\r\n                  style={{\r\n                    fontSize: '11px',\r\n                    color: '#666',\r\n                    marginBottom: '8px'\r\n                  }}\r\n                  aria-label=\"Informaci√≥n adicional del error\"\r\n                >\r\n                  {error.component && (\r\n                    <span>Componente: {error.component}</span>\r\n                  )}\r\n                  {error.context?.operation && (\r\n                    <span> ‚Ä¢ Operaci√≥n: {error.context.operation}</span>\r\n                  )}\r\n                </div>\r\n              )}\r\n\r\n              {/* Acciones accesibles */}\r\n              <div style={{\r\n                display: 'flex',\r\n                gap: '8px',\r\n                justifyContent: 'flex-end'\r\n              }}>\r\n                <button\r\n                  onClick={() => setShowDetails(!showDetails)}\r\n                  onKeyDown={(e) => handleKeyDown(e, error.errorId, () => setShowDetails(!showDetails))}\r\n                  style={{\r\n                    backgroundColor: 'transparent',\r\n                    border: `1px solid ${colors.bg}`,\r\n                    color: colors.bg,\r\n                    padding: '4px 8px',\r\n                    borderRadius: '4px',\r\n                    fontSize: '11px',\r\n                    cursor: 'pointer',\r\n                    transition: 'background-color 0.2s'\r\n                  }}\r\n                  onMouseEnter={(e) => {\r\n                    e.target.style.backgroundColor = colors.bg;\r\n                    e.target.style.color = '#ffffff';\r\n                  }}\r\n                  onMouseLeave={(e) => {\r\n                    e.target.style.backgroundColor = 'transparent';\r\n                    e.target.style.color = colors.bg;\r\n                  }}\r\n                  aria-label={`${showDetails ? 'Ocultar' : 'Mostrar'} detalles del error`}\r\n                  aria-expanded={showDetails}\r\n                >\r\n                  Detalles\r\n                </button>\r\n                \r\n                {error.severity === 'CRITICAL' && (\r\n                  <button\r\n                    onClick={() => window.location.reload()}\r\n                    onKeyDown={(e) => handleKeyDown(e, error.errorId, () => window.location.reload())}\r\n                    style={{\r\n                      backgroundColor: colors.bg,\r\n                      border: 'none',\r\n                      color: colors.text,\r\n                      padding: '4px 8px',\r\n                      borderRadius: '4px',\r\n                      fontSize: '11px',\r\n                      cursor: 'pointer'\r\n                    }}\r\n                    aria-label=\"Recargar p√°gina para resolver error cr√≠tico\"\r\n                  >\r\n                    Recargar\r\n                  </button>\r\n                )}\r\n              </div>\r\n\r\n              {/* Detalles expandidos accesibles */}\r\n              {showDetails && (\r\n                <div \r\n                  style={{\r\n                    marginTop: '10px',\r\n                    padding: '8px',\r\n                    backgroundColor: '#f8f9fa',\r\n                    borderRadius: '4px',\r\n                    fontSize: '11px',\r\n                    color: '#666'\r\n                  }}\r\n                  role=\"region\"\r\n                  aria-label=\"Detalles extendidos del error\"\r\n                  aria-live=\"polite\"\r\n                >\r\n                  <div><strong>ID:</strong> {error.errorId}</div>\r\n                  <div><strong>Tipo:</strong> {error.type}</div>\r\n                  <div><strong>Timestamp:</strong> {new Date(error.timestamp).toLocaleString()}</div>\r\n                  \r\n                  {error.context && Object.keys(error.context).length > 0 && (\r\n                    <div>\r\n                      <strong>Contexto:</strong>\r\n                      <pre \r\n                        style={{ \r\n                          margin: '4px 0', \r\n                          fontSize: '10px',\r\n                          whiteSpace: 'pre-wrap',\r\n                          wordBreak: 'break-word'\r\n                        }}\r\n                        aria-label=\"Contexto del error en formato JSON\"\r\n                      >\r\n                        {JSON.stringify(error.context, null, 2)}\r\n                      </pre>\r\n                    </div>\r\n                  )}\r\n                  \r\n                  {process.env.NODE_ENV === 'development' && error.stack && (\r\n                    <details style={{ marginTop: '8px' }}>\r\n                      <summary \r\n                        style={{ \r\n                          cursor: 'pointer',\r\n                          fontWeight: 'bold',\r\n                          color: colors.bg\r\n                        }}\r\n                        aria-label=\"Stack trace del error (solo desarrollo)\"\r\n                      >\r\n                        Stack Trace\r\n                      </summary>\r\n                      <pre style={{ \r\n                        fontSize: '9px', \r\n                        overflow: 'auto', \r\n                        maxHeight: '100px',\r\n                        backgroundColor: '#fff',\r\n                        padding: '4px',\r\n                        borderRadius: '2px',\r\n                        wordBreak: 'break-word'\r\n                      }}\r\n                      aria-label=\"Stack trace completo del error\"\r\n                      >\r\n                        {error.stack}\r\n                      </pre>\r\n                    </details>\r\n                  )}\r\n                </div>\r\n              )}\r\n            </div>\r\n          );\r\n        })}\r\n\r\n        {/* Bot√≥n para limpiar todos los errores */}\r\n        {errorCounts.total > 1 && (\r\n          <button\r\n            onClick={clearErrors}\r\n            onKeyDown={(e) => handleKeyDown(e, 'clear-all', clearErrors)}\r\n            style={{\r\n              backgroundColor: '#6c757d',\r\n              color: 'white',\r\n              border: 'none',\r\n              padding: '8px 12px',\r\n              borderRadius: '4px',\r\n              fontSize: '12px',\r\n              cursor: 'pointer',\r\n              width: '100%',\r\n              marginTop: '5px'\r\n            }}\r\n            aria-label={`Limpiar todos los ${errorCounts.total} errores`}\r\n          >\r\n            Limpiar todos ({errorCounts.total})\r\n          </button>\r\n        )}\r\n\r\n        {/* Estilos para animaciones */}\r\n        <style jsx>{`\r\n          @keyframes slideIn {\r\n            from {\r\n              opacity: 0;\r\n              transform: translateX(100%);\r\n            }\r\n            to {\r\n              opacity: 1;\r\n              transform: translateX(0);\r\n            }\r\n          }\r\n          \r\n          .sr-only {\r\n            position: absolute;\r\n            width: 1px;\r\n            height: 1px;\r\n            padding: 0;\r\n            margin: -1px;\r\n            overflow: hidden;\r\n            clip: rect(0, 0, 0, 0);\r\n            white-space: nowrap;\r\n            border: 0;\r\n          }\r\n        `}</style>\r\n      </div>\r\n    </>\r\n  );\r\n};\r\n\r\nexport default ErrorNotificationsAccessible;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\common\\FilterPanel.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\common\\FlipCard.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\common\\LazyImage.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The ref value 'imgRef.current' will likely have changed by the time this effect cleanup function runs. If this ref points to a node rendered by React, copy 'imgRef.current' to a variable inside the effect, and use that variable in the cleanup function.","line":76,"column":35,"nodeType":"Identifier","endLine":76,"endColumn":42}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Lazy Image Component\r\n * Carga im√°genes de forma perezosa para mejorar rendimiento\r\n * \r\n * ‚úÖ NO MODIFICA c√≥digo existente\r\n * ‚úÖ Completamente independiente\r\n * ‚úÖ Puede ser desactivado sin afectar el sistema\r\n */\r\n\r\nimport React, { useState, useEffect, useRef } from 'react'\r\n\r\n/**\r\n * Componente para lazy loading de im√°genes\r\n * @param {string} src - URL de la imagen\r\n * @param {string} alt - Texto alternativo\r\n * @param {string} placeholder - URL de imagen placeholder\r\n * @param {string} className - Clases CSS\r\n * @param {number} threshold - Threshold para Intersection Observer (0-1)\r\n * @param {Function} onLoad - Callback cuando la imagen carga\r\n * @param {Function} onError - Callback cuando hay error\r\n * @returns {JSX.Element}\r\n */\r\nconst LazyImage = ({\r\n  src,\r\n  alt = 'Image',\r\n  placeholder = 'data:image/svg+xml,%3Csvg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 400 300\"%3E%3Crect fill=\"%23f0f0f0\" width=\"400\" height=\"300\"/%3E%3C/svg%3E',\r\n  className = '',\r\n  threshold = 0.1,\r\n  onLoad = null,\r\n  onError = null,\r\n  width = null,\r\n  height = null,\r\n  style = {}\r\n}) => {\r\n  const [imageSrc, setImageSrc] = useState(placeholder)\r\n  const [isLoaded, setIsLoaded] = useState(false)\r\n  const [hasError, setHasError] = useState(false)\r\n  const imgRef = useRef(null)\r\n\r\n  useEffect(() => {\r\n    // Crear Intersection Observer para lazy loading\r\n    const observer = new IntersectionObserver(\r\n      entries => {\r\n        entries.forEach(entry => {\r\n          if (entry.isIntersecting) {\r\n            // Imagen est√° visible, cargar\r\n            const img = new Image()\r\n            \r\n            img.onload = () => {\r\n              setImageSrc(src)\r\n              setIsLoaded(true)\r\n              setHasError(false)\r\n              if (onLoad) onLoad()\r\n              observer.unobserve(entry.target)\r\n            }\r\n            \r\n            img.onerror = () => {\r\n              setHasError(true)\r\n              if (onError) onError()\r\n              observer.unobserve(entry.target)\r\n            }\r\n            \r\n            img.src = src\r\n          }\r\n        })\r\n      },\r\n      { threshold }\r\n    )\r\n\r\n    if (imgRef.current) {\r\n      observer.observe(imgRef.current)\r\n    }\r\n\r\n    return () => {\r\n      if (imgRef.current) {\r\n        observer.unobserve(imgRef.current)\r\n      }\r\n    }\r\n  }, [src, threshold, onLoad, onError])\r\n\r\n  return (\r\n    <img\r\n      ref={imgRef}\r\n      src={imageSrc}\r\n      alt={alt}\r\n      className={`${className} ${isLoaded ? 'loaded' : 'loading'} ${hasError ? 'error' : ''}`}\r\n      width={width}\r\n      height={height}\r\n      style={{\r\n        opacity: isLoaded ? 1 : 0.7,\r\n        transition: 'opacity 0.3s ease-in-out',\r\n        ...style\r\n      }}\r\n    />\r\n  )\r\n}\r\n\r\nexport default LazyImage\r\n","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\common\\LoadingSpinner.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\common\\OptimizedImage.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The ref value 'imgRef.current' will likely have changed by the time this effect cleanup function runs. If this ref points to a node rendered by React, copy 'imgRef.current' to a variable inside the effect, and use that variable in the cleanup function.","line":95,"column":37,"nodeType":"Identifier","endLine":95,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Optimized Image Component\r\n * Componente de imagen con optimizaci√≥n autom√°tica\r\n * \r\n * ‚úÖ NO MODIFICA c√≥digo existente\r\n * ‚úÖ Completamente independiente\r\n * ‚úÖ Puede ser desactivado sin afectar el sistema\r\n */\r\n\r\nimport React, { useState, useEffect, useRef } from 'react'\r\n\r\n/**\r\n * Componente para im√°genes optimizadas con m√∫ltiples formatos\r\n * @param {string} src - URL de la imagen\r\n * @param {string} alt - Texto alternativo\r\n * @param {string} className - Clases CSS\r\n * @param {number} width - Ancho de la imagen\r\n * @param {number} height - Alto de la imagen\r\n * @param {string} sizes - Sizes para responsive\r\n * @param {boolean} lazy - Lazy loading\r\n * @param {Function} onLoad - Callback cuando carga\r\n * @param {Function} onError - Callback en error\r\n * @returns {JSX.Element}\r\n */\r\nconst OptimizedImage = ({\r\n  src,\r\n  alt = 'Image',\r\n  className = '',\r\n  width = null,\r\n  height = null,\r\n  sizes = null,\r\n  lazy = true,\r\n  onLoad = null,\r\n  onError = null,\r\n  style = {}\r\n}) => {\r\n  const [imageSrc, setImageSrc] = useState(null)\r\n  const [isLoaded, setIsLoaded] = useState(false)\r\n  const [hasError, setHasError] = useState(false)\r\n  const imgRef = useRef(null)\r\n\r\n  // Generar URL optimizada\r\n  const getOptimizedUrl = (url, w = null, h = null) => {\r\n    if (!url) return null\r\n\r\n    // Si es una URL de Cloudinary o similar, aplicar transformaciones\r\n    if (url.includes('cloudinary')) {\r\n      const params = []\r\n      if (w) params.push(`w_${w}`)\r\n      if (h) params.push(`h_${h}`)\r\n      params.push('q_auto', 'f_auto')\r\n      \r\n      const paramStr = params.join(',')\r\n      return url.replace('/upload/', `/upload/${paramStr}/`)\r\n    }\r\n\r\n    // Si es una URL local, retornar como est√°\r\n    return url\r\n  }\r\n\r\n  // Generar srcSet para responsive\r\n  const generateSrcSet = (url) => {\r\n    if (!url) return null\r\n\r\n    const widths = [320, 640, 960, 1280, 1920]\r\n    return widths\r\n      .map(w => `${getOptimizedUrl(url, w)} ${w}w`)\r\n      .join(', ')\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (!src) return\r\n\r\n    // Usar Intersection Observer para lazy loading\r\n    if (lazy && 'IntersectionObserver' in window) {\r\n      const observer = new IntersectionObserver(\r\n        entries => {\r\n          entries.forEach(entry => {\r\n            if (entry.isIntersecting) {\r\n              const optimizedUrl = getOptimizedUrl(src, width, height)\r\n              setImageSrc(optimizedUrl)\r\n              observer.unobserve(entry.target)\r\n            }\r\n          })\r\n        },\r\n        { threshold: 0.1 }\r\n      )\r\n\r\n      if (imgRef.current) {\r\n        observer.observe(imgRef.current)\r\n      }\r\n\r\n      return () => {\r\n        if (imgRef.current) {\r\n          observer.unobserve(imgRef.current)\r\n        }\r\n      }\r\n    } else {\r\n      // Sin lazy loading\r\n      const optimizedUrl = getOptimizedUrl(src, width, height)\r\n      setImageSrc(optimizedUrl)\r\n    }\r\n  }, [src, width, height, lazy])\r\n\r\n  const handleLoad = () => {\r\n    setIsLoaded(true)\r\n    setHasError(false)\r\n    if (onLoad) onLoad()\r\n  }\r\n\r\n  const handleError = () => {\r\n    setHasError(true)\r\n    if (onError) onError()\r\n  }\r\n\r\n  return (\r\n    <picture>\r\n      {/* WebP para navegadores modernos */}\r\n      {imageSrc && (\r\n        <source\r\n          srcSet={generateSrcSet(imageSrc.replace(/\\.[^.]+$/, '.webp'))}\r\n          sizes={sizes}\r\n          type=\"image/webp\"\r\n        />\r\n      )}\r\n      \r\n      {/* Fallback a formato original */}\r\n      <img\r\n        ref={imgRef}\r\n        src={imageSrc}\r\n        srcSet={imageSrc ? generateSrcSet(imageSrc) : undefined}\r\n        sizes={sizes}\r\n        alt={alt}\r\n        width={width}\r\n        height={height}\r\n        className={`${className} ${isLoaded ? 'loaded' : 'loading'} ${hasError ? 'error' : ''}`}\r\n        onLoad={handleLoad}\r\n        onError={handleError}\r\n        style={{\r\n          opacity: isLoaded ? 1 : 0.7,\r\n          transition: 'opacity 0.3s ease-in-out',\r\n          ...style\r\n        }}\r\n        loading={lazy ? 'lazy' : 'eager'}\r\n      />\r\n    </picture>\r\n  )\r\n}\r\n\r\nexport default OptimizedImage\r\n","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\common\\OptimizedLoader.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\common\\PaginationControls.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\common\\ResponsiveWrapper.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'ChevronLeftIcon' is defined but never used.","line":14,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'ChevronRightIcon' is defined but never used.","line":15,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'deltaY' is assigned a value but never used.","line":104,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":104,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Responsive Wrapper\r\n * Interfaz responsiva mejorada con gestos t√°ctiles y navegaci√≥n adaptativa\r\n * \r\n * ‚úÖ NO MODIFICA c√≥digo existente\r\n * ‚úÖ Completamente independiente\r\n * ‚úÖ Puede ser desactivado sin afectar el sistema\r\n */\r\n\r\nimport React, { useState, useEffect, useRef, useCallback } from 'react'\r\nimport {\r\n  Bars3Icon,\r\n  XMarkIcon,\r\n  ChevronLeftIcon,\r\n  ChevronRightIcon,\r\n  HomeIcon,\r\n  UserIcon,\r\n  Cog6ToothIcon,\r\n  BellIcon,\r\n  MagnifyingGlassIcon,\r\n  ArrowPathIcon,\r\n  EnvelopeIcon\r\n} from '@heroicons/react/24/outline'\r\n\r\nconst ResponsiveWrapper = ({ children, className = '' }) => {\r\n  const [isMobile, setIsMobile] = useState(false)\r\n  const [isTablet, setIsTablet] = useState(false)\r\n  const [sidebarOpen, setSidebarOpen] = useState(false)\r\n  const [touchStart, setTouchStart] = useState(null)\r\n  const [touchEnd, setTouchEnd] = useState(null)\r\n  const [swipeDirection, setSwipeDirection] = useState(null)\r\n  const [isOffline, setIsOffline] = useState(false)\r\n  const [viewportSize, setViewportSize] = useState({ width: 0, height: 0 })\r\n  const [orientation, setOrientation] = useState('portrait')\r\n  \r\n  const containerRef = useRef(null)\r\n  const sidebarRef = useRef(null)\r\n\r\n  // Detectar tama√±o de pantalla y orientaci√≥n\r\n  useEffect(() => {\r\n    const updateViewportSize = () => {\r\n      const width = window.innerWidth\r\n      const height = window.innerHeight\r\n      \r\n      setViewportSize({ width, height })\r\n      setOrientation(width > height ? 'landscape' : 'portrait')\r\n      \r\n      // Definir breakpoints\r\n      setIsMobile(width < 768)\r\n      setIsTablet(width >= 768 && width < 1024)\r\n    }\r\n\r\n    updateViewportSize()\r\n    window.addEventListener('resize', updateViewportSize)\r\n    window.addEventListener('orientationchange', updateViewportSize)\r\n\r\n    return () => {\r\n      window.removeEventListener('resize', updateViewportSize)\r\n      window.removeEventListener('orientationchange', updateViewportSize)\r\n    }\r\n  }, [])\r\n\r\n  // Detectar conexi√≥n a internet\r\n  useEffect(() => {\r\n    const updateOnlineStatus = () => {\r\n      setIsOffline(!navigator.onLine)\r\n    }\r\n\r\n    updateOnlineStatus()\r\n    window.addEventListener('online', updateOnlineStatus)\r\n    window.addEventListener('offline', updateOnlineStatus)\r\n\r\n    return () => {\r\n      window.removeEventListener('online', updateOnlineStatus)\r\n      window.removeEventListener('offline', updateOnlineStatus)\r\n    }\r\n  }, [])\r\n\r\n  // Manejar gestos t√°ctiles\r\n  const handleTouchStart = useCallback((e) => {\r\n    const touch = e.touches[0]\r\n    setTouchStart({\r\n      x: touch.clientX,\r\n      y: touch.clientY,\r\n      time: Date.now()\r\n    })\r\n  }, [])\r\n\r\n  const handleTouchMove = useCallback((e) => {\r\n    if (!touchStart) return\r\n    \r\n    const touch = e.touches[0]\r\n    setTouchEnd({\r\n      x: touch.clientX,\r\n      y: touch.clientY,\r\n      time: Date.now()\r\n    })\r\n  }, [touchStart])\r\n\r\n  const handleTouchEnd = useCallback(() => {\r\n    if (!touchStart || !touchEnd) return\r\n\r\n    const deltaX = touchEnd.x - touchStart.x\r\n    const deltaY = touchEnd.y - touchStart.y\r\n    const deltaTime = touchEnd.time - touchStart.time\r\n\r\n    // Umbral para considerar como swipe (m√≠nimo 50px y m√°ximo 300ms)\r\n    const minSwipeDistance = 50\r\n    const maxSwipeTime = 300\r\n\r\n    if (Math.abs(deltaX) > minSwipeDistance && deltaTime < maxSwipeTime) {\r\n      if (deltaX > 0) {\r\n        setSwipeDirection('right')\r\n        // Swipe derecho - abrir sidebar en m√≥vil\r\n        if (isMobile && !sidebarOpen) {\r\n          setSidebarOpen(true)\r\n        }\r\n      } else {\r\n        setSwipeDirection('left')\r\n        // Swipe izquierdo - cerrar sidebar en m√≥vil\r\n        if (isMobile && sidebarOpen) {\r\n          setSidebarOpen(false)\r\n        }\r\n      }\r\n    }\r\n\r\n    // Resetear valores\r\n    setTouchStart(null)\r\n    setTouchEnd(null)\r\n    setTimeout(() => setSwipeDirection(null), 100)\r\n  }, [touchStart, touchEnd, isMobile, sidebarOpen])\r\n\r\n  // Navegaci√≥n por teclado\r\n  const handleKeyDown = useCallback((e) => {\r\n    // Ctrl/Cmd + B: Toggle sidebar\r\n    if ((e.ctrlKey || e.metaKey) && e.key === 'b') {\r\n      e.preventDefault()\r\n      setSidebarOpen(!sidebarOpen)\r\n    }\r\n    \r\n    // Escape: Cerrar sidebar en m√≥vil\r\n    if (e.key === 'Escape' && isMobile && sidebarOpen) {\r\n      setSidebarOpen(false)\r\n    }\r\n    \r\n    // Flechas: Navegaci√≥n en m√≥vil\r\n    if (isMobile && sidebarOpen) {\r\n      if (e.key === 'ArrowLeft') {\r\n        setSidebarOpen(false)\r\n      } else if (e.key === 'ArrowRight') {\r\n        setSidebarOpen(true)\r\n      }\r\n    }\r\n  }, [isMobile, sidebarOpen])\r\n\r\n  useEffect(() => {\r\n    document.addEventListener('keydown', handleKeyDown)\r\n    return () => document.removeEventListener('keydown', handleKeyDown)\r\n  }, [handleKeyDown])\r\n\r\n  // Men√∫ de navegaci√≥n m√≥vil\r\n  const MobileNavigation = () => (\r\n    <div className=\"fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 z-50 md:hidden\">\r\n      <div className=\"grid grid-cols-5 gap-1 p-2\">\r\n        <button\r\n          className=\"flex flex-col items-center p-2 text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors\"\r\n          onClick={() => setSidebarOpen(false)}\r\n        >\r\n          <HomeIcon className=\"w-6 h-6\" />\r\n          <span className=\"text-xs mt-1\">Inicio</span>\r\n        </button>\r\n        \r\n        <button\r\n          className=\"flex flex-col items-center p-2 text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors\"\r\n        >\r\n          <MagnifyingGlassIcon className=\"w-6 h-6\" />\r\n          <span className=\"text-xs mt-1\">Buscar</span>\r\n        </button>\r\n        \r\n        <button\r\n          className=\"flex flex-col items-center p-2 text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors relative\"\r\n        >\r\n          <BellIcon className=\"w-6 h-6\" />\r\n          <span className=\"text-xs mt-1\">Alertas</span>\r\n          <span className=\"absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full\"></span>\r\n        </button>\r\n        \r\n        <button\r\n          className=\"flex flex-col items-center p-2 text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors\"\r\n        >\r\n          <UserIcon className=\"w-6 h-6\" />\r\n          <span className=\"text-xs mt-1\">Perfil</span>\r\n        </button>\r\n        \r\n        <button\r\n          className=\"flex flex-col items-center p-2 text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors\"\r\n          onClick={() => setSidebarOpen(!sidebarOpen)}\r\n        >\r\n          <Cog6ToothIcon className=\"w-6 h-6\" />\r\n          <span className=\"text-xs mt-1\">Config</span>\r\n        </button>\r\n      </div>\r\n    </div>\r\n  )\r\n\r\n  // Sidebar adaptable\r\n  const AdaptiveSidebar = () => {\r\n    const sidebarClasses = `\r\n      fixed top-0 left-0 h-full bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 z-40\r\n      transform transition-transform duration-300 ease-in-out\r\n      ${isMobile ? 'w-72' : isTablet ? 'w-64' : 'w-80'}\r\n      ${isMobile && !sidebarOpen ? '-translate-x-full' : 'translate-x-0'}\r\n      ${isTablet && !sidebarOpen ? '-translate-x-full' : 'translate-x-0'}\r\n    `\r\n\r\n    return (\r\n      <>\r\n        {/* Overlay para m√≥vil/tablet */}\r\n        {(isMobile || isTablet) && sidebarOpen && (\r\n          <div\r\n            className=\"fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden\"\r\n            onClick={() => setSidebarOpen(false)}\r\n          />\r\n        )}\r\n        \r\n        <div ref={sidebarRef} className={sidebarClasses}>\r\n          {/* Header del sidebar */}\r\n          <div className=\"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700\">\r\n            <h2 className=\"text-lg font-semibold text-gray-900 dark:text-gray-100\">\r\n              Men√∫\r\n            </h2>\r\n            \r\n            {(isMobile || isTablet) && (\r\n              <button\r\n                onClick={() => setSidebarOpen(false)}\r\n                className=\"p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\r\n              >\r\n                <XMarkIcon className=\"w-5 h-5 text-gray-600 dark:text-gray-400\" />\r\n              </button>\r\n            )}\r\n          </div>\r\n          \r\n          {/* Contenido del sidebar */}\r\n          <div className=\"p-4 space-y-4\">\r\n            <nav className=\"space-y-2\">\r\n              <a\r\n                href=\"/panel-principal\"\r\n                className=\"flex items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\r\n              >\r\n                <HomeIcon className=\"w-5 h-5 mr-3 text-gray-600 dark:text-gray-400\" />\r\n                <span className=\"text-gray-900 dark:text-gray-100\">Panel Principal</span>\r\n              </a>\r\n              \r\n              <a\r\n                href=\"/communication\"\r\n                className=\"flex items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\r\n              >\r\n                <EnvelopeIcon className=\"w-5 h-5 mr-3 text-gray-600 dark:text-gray-400\" />\r\n                <span className=\"text-gray-900 dark:text-gray-100\">Comunicaci√≥n</span>\r\n              </a>\r\n              \r\n              <a\r\n                href=\"/configuracion\"\r\n                className=\"flex items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\r\n              >\r\n                <Cog6ToothIcon className=\"w-5 h-5 mr-3 text-gray-600 dark:text-gray-400\" />\r\n                <span className=\"text-gray-900 dark:text-gray-100\">Configuraci√≥n</span>\r\n              </a>\r\n            </nav>\r\n          </div>\r\n          \r\n          {/* Footer del sidebar */}\r\n          <div className=\"absolute bottom-0 left-0 right-0 p-4 border-t border-gray-200 dark:border-gray-700\">\r\n            <div className=\"flex items-center justify-between text-sm text-gray-600 dark:text-gray-400\">\r\n              <span>{viewportSize.width}x{viewportSize.height}</span>\r\n              <span>{orientation}</span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </>\r\n    )\r\n  }\r\n\r\n  // Header adaptable\r\n  const AdaptiveHeader = () => (\r\n    <header className=\"sticky top-0 z-30 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700\">\r\n      <div className=\"px-4 py-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          {/* Bot√≥n de men√∫ para m√≥vil/tablet */}\r\n          {(isMobile || isTablet) && (\r\n            <button\r\n              onClick={() => setSidebarOpen(!sidebarOpen)}\r\n              className=\"p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\r\n            >\r\n              {sidebarOpen ? (\r\n                <XMarkIcon className=\"w-6 h-6 text-gray-600 dark:text-gray-400\" />\r\n              ) : (\r\n                <Bars3Icon className=\"w-6 h-6 text-gray-600 dark:text-gray-400\" />\r\n              )}\r\n            </button>\r\n          )}\r\n          \r\n          {/* T√≠tulo */}\r\n          <div className=\"flex-1 text-center md:text-left\">\r\n            <h1 className=\"text-lg font-semibold text-gray-900 dark:text-gray-100\">\r\n              BrifyRRHH v2\r\n            </h1>\r\n            {(isMobile || isTablet) && (\r\n              <p className=\"text-sm text-gray-600 dark:text-gray-400\">\r\n                {isOffline ? 'Modo offline' : 'Conectado'}\r\n              </p>\r\n            )}\r\n          </div>\r\n          \r\n          {/* Acciones r√°pidas */}\r\n          <div className=\"flex items-center space-x-2\">\r\n            {/* Indicador de conexi√≥n */}\r\n            {isOffline && (\r\n              <div className=\"flex items-center px-2 py-1 bg-red-100 dark:bg-red-900/20 rounded-full\">\r\n                <div className=\"w-2 h-2 bg-red-500 rounded-full mr-1\"></div>\r\n                <span className=\"text-xs text-red-700 dark:text-red-400\">Offline</span>\r\n              </div>\r\n            )}\r\n            \r\n            {/* Bot√≥n de refresh */}\r\n            <button\r\n              className=\"p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\r\n              onClick={() => window.location.reload()}\r\n            >\r\n              <ArrowPathIcon className=\"w-5 h-5 text-gray-600 dark:text-gray-400\" />\r\n            </button>\r\n            \r\n            {/* Notificaciones (solo en desktop) */}\r\n            {!isMobile && (\r\n              <button className=\"relative p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\">\r\n                <BellIcon className=\"w-5 h-5 text-gray-600 dark:text-gray-400\" />\r\n                <span className=\"absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full\"></span>\r\n              </button>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </header>\r\n  )\r\n\r\n  // Indicador de gestos (solo en m√≥vil)\r\n  const GestureIndicator = () => {\r\n    if (!isMobile || !swipeDirection) return null\r\n    \r\n    return (\r\n      <div className=\"fixed top-20 left-1/2 transform -translate-x-1/2 z-50 pointer-events-none\">\r\n        <div className=\"bg-black bg-opacity-75 text-white px-3 py-2 rounded-full text-sm\">\r\n          Swipe {swipeDirection === 'left' ? '‚Üê' : '‚Üí'} {swipeDirection === 'left' ? 'Cerrar' : 'Abrir'} men√∫\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Clases adaptativas seg√∫n dispositivo\r\n  const getResponsiveClasses = useCallback(() => {\r\n    let classes = 'transition-all duration-300'\r\n    \r\n    if (isMobile) {\r\n      classes += ' px-4 py-2'\r\n      classes += ' text-sm'\r\n    } else if (isTablet) {\r\n      classes += ' px-6 py-4'\r\n      classes += ' text-base'\r\n    } else {\r\n      classes += ' px-8 py-6'\r\n      classes += ' text-base'\r\n    }\r\n    \r\n    return classes\r\n  }, [isMobile, isTablet])\r\n\r\n  return (\r\n    <div\r\n      ref={containerRef}\r\n      className={`min-h-screen bg-gray-50 dark:bg-gray-900 ${getResponsiveClasses()} ${className}`}\r\n      onTouchStart={handleTouchStart}\r\n      onTouchMove={handleTouchMove}\r\n      onTouchEnd={handleTouchEnd}\r\n    >\r\n      {/* Header adaptable */}\r\n      <AdaptiveHeader />\r\n      \r\n      {/* Sidebar adaptable */}\r\n      <AdaptiveSidebar />\r\n      \r\n      {/* Contenido principal */}\r\n      <main className={`${isMobile ? 'mb-16' : ''} ${isMobile || isTablet ? '' : 'ml-80'}`}>\r\n        {/* Indicador de dispositivo (solo para desarrollo) */}\r\n        {process.env.NODE_ENV === 'development' && (\r\n          <div className=\"fixed top-20 right-4 z-20 bg-black bg-opacity-75 text-white px-3 py-2 rounded-full text-xs\">\r\n            {isMobile ? 'üì± M√≥vil' : isTablet ? 'üì± Tablet' : 'üñ•Ô∏è Desktop'}\r\n            {orientation === 'landscape' ? ' ‚Üª' : ' ‚Üï'}\r\n          </div>\r\n        )}\r\n        \r\n        {/* Indicador de gestos */}\r\n        <GestureIndicator />\r\n        \r\n        {/* Contenido children */}\r\n        <div className=\"max-w-full overflow-x-hidden\">\r\n          {children}\r\n        </div>\r\n      </main>\r\n      \r\n      {/* Navegaci√≥n m√≥vil */}\r\n      {isMobile && <MobileNavigation />}\r\n      \r\n      {/* Script para accesibilidad WCAG */}\r\n      <script dangerouslySetInnerHTML={{\r\n        __html: `\r\n          // Mejorar accesibilidad WCAG 2.1\r\n          document.addEventListener('DOMContentLoaded', function() {\r\n            // Skip to main content link\r\n            const skipLink = document.createElement('a');\r\n            skipLink.href = '#main-content';\r\n            skipLink.textContent = 'Saltar al contenido principal';\r\n            skipLink.className = 'sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-blue-500 text-white px-4 py-2 rounded';\r\n            document.body.insertBefore(skipLink, document.body.firstChild);\r\n            \r\n            // Aumentar contraste para usuarios con preferencia\r\n            if (window.matchMedia('(prefers-contrast: high)').matches) {\r\n              document.documentElement.classList.add('high-contrast');\r\n            }\r\n            \r\n            // Reducir movimiento para usuarios con preferencia\r\n            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {\r\n              document.documentElement.classList.add('reduce-motion');\r\n            }\r\n          });\r\n        `\r\n      }} />\r\n    </div>\r\n  )\r\n}\r\n\r\n// Hook personalizado para detectar gestos\r\nexport const useGestures = () => {\r\n  const [gestures, setGestures] = useState({\r\n    swipeLeft: false,\r\n    swipeRight: false,\r\n    swipeUp: false,\r\n    swipeDown: false,\r\n    pinch: false,\r\n    tap: false\r\n  })\r\n\r\n  const handleGesture = useCallback((gesture) => {\r\n    setGestures(prev => ({ ...prev, [gesture]: true }))\r\n    setTimeout(() => {\r\n      setGestures(prev => ({ ...prev, [gesture]: false }))\r\n    }, 300)\r\n  }, [])\r\n\r\n  return { gestures, handleGesture }\r\n}\r\n\r\n// Hook para responsive design\r\nexport const useResponsive = () => {\r\n  const [screenSize, setScreenSize] = useState({\r\n    width: 0,\r\n    height: 0,\r\n    isMobile: false,\r\n    isTablet: false,\r\n    isDesktop: false,\r\n    orientation: 'portrait'\r\n  })\r\n\r\n  useEffect(() => {\r\n    const updateScreenSize = () => {\r\n      const width = window.innerWidth\r\n      const height = window.innerHeight\r\n      \r\n      setScreenSize({\r\n        width,\r\n        height,\r\n        isMobile: width < 768,\r\n        isTablet: width >= 768 && width < 1024,\r\n        isDesktop: width >= 1024,\r\n        orientation: width > height ? 'landscape' : 'portrait'\r\n      })\r\n    }\r\n\r\n    updateScreenSize()\r\n    window.addEventListener('resize', updateScreenSize)\r\n    window.addEventListener('orientationchange', updateScreenSize)\r\n\r\n    return () => {\r\n      window.removeEventListener('resize', updateScreenSize)\r\n      window.removeEventListener('orientationchange', updateScreenSize)\r\n    }\r\n  }, [])\r\n\r\n  return screenSize\r\n}\r\n\r\nexport default ResponsiveWrapper","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\common\\SubtleSpinner.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\common\\SuspenseWrapper.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\common\\TemplateDownload.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\communication\\BrevoStatisticsDashboard.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'CalendarIcon' is defined but never used.","line":7,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":15},{"ruleId":"no-unused-vars","severity":1,"message":"'TrendingUpIcon' is defined but never used.","line":8,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":17},{"ruleId":"no-unused-vars","severity":1,"message":"'TrendingDownIcon' is defined but never used.","line":9,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'UsersIcon' is defined but never used.","line":11,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":12}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback } from 'react'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport {\r\n  ChartBarIcon,\r\n  EnvelopeIcon,\r\n  ChatBubbleLeftRightIcon,\r\n  CalendarIcon,\r\n  TrendingUpIcon,\r\n  TrendingDownIcon,\r\n  CurrencyDollarIcon,\r\n  UsersIcon,\r\n  ClockIcon,\r\n  CheckCircleIcon,\r\n  XCircleIcon,\r\n  ArrowPathIcon,\r\n  FunnelIcon,\r\n  DocumentTextIcon\r\n} from '@heroicons/react/24/outline'\r\nimport brevoCampaignService from '../../services/brevoCampaignService.js'\r\nimport brevoService from '../../services/brevoService.js'\r\n\r\nconst BrevoStatisticsDashboard = () => {\r\n  const [statistics, setStatistics] = useState({\r\n    overview: {\r\n      totalCampaigns: 0,\r\n      totalSent: 0,\r\n      totalDelivered: 0,\r\n      totalFailed: 0,\r\n      totalCost: 0,\r\n      avgDeliveryRate: 0,\r\n      avgOpenRate: 0,\r\n      avgClickRate: 0\r\n    },\r\n    smsStats: {\r\n      sent: 0,\r\n      delivered: 0,\r\n      failed: 0,\r\n      cost: 0,\r\n      deliveryRate: 0\r\n    },\r\n    emailStats: {\r\n      sent: 0,\r\n      delivered: 0,\r\n      opened: 0,\r\n      clicked: 0,\r\n      failed: 0,\r\n      cost: 0,\r\n      deliveryRate: 0,\r\n      openRate: 0,\r\n      clickRate: 0\r\n    },\r\n    recentCampaigns: [],\r\n    monthlyStats: [],\r\n    dailyStats: []\r\n  })\r\n  \r\n  const [loading, setLoading] = useState(true)\r\n  const [error, setError] = useState(null)\r\n  const [selectedPeriod, setSelectedPeriod] = useState('monthly')\r\n  const [selectedType, setSelectedType] = useState('all')\r\n  const [showDetails, setShowDetails] = useState(false)\r\n  const [selectedCampaign, setSelectedCampaign] = useState(null)\r\n\r\n  // Cargar estad√≠sticas\r\n  const loadStatistics = useCallback(async () => {\r\n    try {\r\n      setLoading(true)\r\n      setError(null)\r\n      \r\n      // Verificar si Brevo est√° configurado\r\n      const config = brevoService.loadConfiguration()\r\n      if (!config.apiKey) {\r\n        setError('Brevo no est√° configurado. Por favor, configura tu API key en Integraciones.')\r\n        return\r\n      }\r\n      \r\n      // Cargar estad√≠sticas generales\r\n      const generalStats = await brevoCampaignService.getGeneralStatistics(selectedPeriod)\r\n      \r\n      // Cargar campa√±as recientes\r\n      const recentCampaigns = await brevoCampaignService.getCampaigns({\r\n        limit: 10,\r\n        status: selectedType === 'all' ? undefined : 'completed'\r\n      })\r\n      \r\n      // Procesar estad√≠sticas\r\n      const processedStats = processStatistics(generalStats, recentCampaigns)\r\n      \r\n      setStatistics(prev => ({\r\n        ...prev,\r\n        ...processedStats,\r\n        recentCampaigns\r\n      }))\r\n      \r\n    } catch (error) {\r\n      console.error('Error cargando estad√≠sticas:', error)\r\n      setError(error.message || 'Error al cargar estad√≠sticas')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [selectedPeriod, selectedType])\r\n\r\n  // Procesar estad√≠sticas\r\n  const processStatistics = (generalStats, campaigns) => {\r\n    const overview = {\r\n      totalCampaigns: campaigns.length,\r\n      totalSent: 0,\r\n      totalDelivered: 0,\r\n      totalFailed: 0,\r\n      totalCost: 0,\r\n      avgDeliveryRate: 0,\r\n      avgOpenRate: 0,\r\n      avgClickRate: 0\r\n    }\r\n    \r\n    const smsStats = {\r\n      sent: 0,\r\n      delivered: 0,\r\n      failed: 0,\r\n      cost: 0,\r\n      deliveryRate: 0\r\n    }\r\n    \r\n    const emailStats = {\r\n      sent: 0,\r\n      delivered: 0,\r\n      opened: 0,\r\n      clicked: 0,\r\n      failed: 0,\r\n      cost: 0,\r\n      deliveryRate: 0,\r\n      openRate: 0,\r\n      clickRate: 0\r\n    }\r\n    \r\n    // Procesar estad√≠sticas generales\r\n    generalStats.forEach(stat => {\r\n      overview.totalSent += stat.total_sent || 0\r\n      overview.totalCost += stat.total_cost || 0\r\n      \r\n      smsStats.sent += stat.sms_sent || 0\r\n      smsStats.delivered += stat.sms_delivered || 0\r\n      smsStats.failed += stat.sms_failed || 0\r\n      smsStats.cost += stat.sms_cost || 0\r\n      \r\n      emailStats.sent += stat.email_sent || 0\r\n      emailStats.delivered += stat.email_delivered || 0\r\n      emailStats.opened += stat.email_opened || 0\r\n      emailStats.clicked += stat.email_clicked || 0\r\n      emailStats.failed += stat.email_failed || 0\r\n      emailStats.cost += stat.email_cost || 0\r\n    })\r\n    \r\n    // Calcular tasas\r\n    overview.totalDelivered = smsStats.delivered + emailStats.delivered\r\n    overview.totalFailed = smsStats.failed + emailStats.failed\r\n    \r\n    smsStats.deliveryRate = smsStats.sent > 0 ? (smsStats.delivered / smsStats.sent) * 100 : 0\r\n    emailStats.deliveryRate = emailStats.sent > 0 ? (emailStats.delivered / emailStats.sent) * 100 : 0\r\n    emailStats.openRate = emailStats.delivered > 0 ? (emailStats.opened / emailStats.delivered) * 100 : 0\r\n    emailStats.clickRate = emailStats.opened > 0 ? (emailStats.clicked / emailStats.opened) * 100 : 0\r\n    \r\n    overview.avgDeliveryRate = overview.totalSent > 0 ? (overview.totalDelivered / overview.totalSent) * 100 : 0\r\n    overview.avgOpenRate = emailStats.openRate\r\n    overview.avgClickRate = emailStats.clickRate\r\n    \r\n    return {\r\n      overview,\r\n      smsStats,\r\n      emailStats,\r\n      monthlyStats: generalStats\r\n    }\r\n  }\r\n\r\n  // Cargar detalles de campa√±a\r\n  const loadCampaignDetails = async (campaignId) => {\r\n    try {\r\n      const details = await brevoCampaignService.getCampaignDetails(campaignId)\r\n      const stats = await brevoCampaignService.getCampaignStatistics(campaignId)\r\n      \r\n      setSelectedCampaign({\r\n        ...details,\r\n        statistics: stats\r\n      })\r\n      setShowDetails(true)\r\n    } catch (error) {\r\n      console.error('Error cargando detalles de campa√±a:', error)\r\n    }\r\n  }\r\n\r\n  // Formatear moneda\r\n  const formatCurrency = (amount) => {\r\n    return new Intl.NumberFormat('es-CL', {\r\n      style: 'currency',\r\n      currency: 'CLP'\r\n    }).format(amount || 0)\r\n  }\r\n\r\n  // Formatear n√∫mero\r\n  const formatNumber = (num) => {\r\n    return new Intl.NumberFormat('es-CL').format(num || 0)\r\n  }\r\n\r\n  // Formatear fecha\r\n  const formatDate = (dateString) => {\r\n    return new Date(dateString).toLocaleDateString('es-CL', {\r\n      day: '2-digit',\r\n      month: '2-digit',\r\n      year: 'numeric'\r\n    })\r\n  }\r\n\r\n  // Obtener color para tasa\r\n  const getRateColor = (rate) => {\r\n    if (rate >= 90) return 'text-green-600'\r\n    if (rate >= 70) return 'text-yellow-600'\r\n    return 'text-red-600'\r\n  }\r\n\r\n  // Obtener icono para estado\r\n  const getStatusIcon = (status) => {\r\n    switch (status) {\r\n      case 'completed':\r\n        return <CheckCircleIcon className=\"w-5 h-5 text-green-500\" />\r\n      case 'failed':\r\n      case 'cancelled':\r\n        return <XCircleIcon className=\"w-5 h-5 text-red-500\" />\r\n      case 'sending':\r\n        return <ArrowPathIcon className=\"w-5 h-5 text-blue-500 animate-spin\" />\r\n      default:\r\n        return <ClockIcon className=\"w-5 h-5 text-gray-500\" />\r\n    }\r\n  }\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\r\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\r\nuseEffect(() => {\r\n    loadStatistics()\r\n  }, [loadStatistics])\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center min-h-screen\">\r\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600\"></div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"flex items-center justify-center min-h-screen\">\r\n        <div className=\"text-center\">\r\n          <XCircleIcon className=\"w-16 h-16 text-red-500 mx-auto mb-4\" />\r\n          <h3 className=\"text-lg font-medium text-gray-900 mb-2\">Error</h3>\r\n          <p className=\"text-gray-600 mb-4\">{error}</p>\r\n          <button\r\n            onClick={loadStatistics}\r\n            className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors\"\r\n          >\r\n            Reintentar\r\n          </button>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gray-50 p-6\">\r\n      <div className=\"max-w-7xl mx-auto\">\r\n        {/* Header */}\r\n        <div className=\"mb-8\">\r\n          <h1 className=\"text-3xl font-bold text-gray-900 mb-2\">\r\n            Estad√≠sticas de Env√≠o Masivo\r\n          </h1>\r\n          <p className=\"text-gray-600\">\r\n            Monitoriza el rendimiento de tus campa√±as de SMS y Email con Brevo\r\n          </p>\r\n        </div>\r\n\r\n        {/* Filtros */}\r\n        <div className=\"bg-white rounded-xl shadow-sm p-6 mb-8\">\r\n          <div className=\"flex flex-wrap gap-4 items-center\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <FunnelIcon className=\"w-5 h-5 text-gray-500\" />\r\n              <span className=\"text-sm font-medium text-gray-700\">Filtros:</span>\r\n            </div>\r\n            \r\n            <select\r\n              value={selectedPeriod}\r\n              onChange={(e) => setSelectedPeriod(e.target.value)}\r\n              className=\"px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n            >\r\n              <option value=\"daily\">Diario</option>\r\n              <option value=\"weekly\">Semanal</option>\r\n              <option value=\"monthly\">Mensual</option>\r\n            </select>\r\n            \r\n            <select\r\n              value={selectedType}\r\n              onChange={(e) => setSelectedType(e.target.value)}\r\n              className=\"px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n            >\r\n              <option value=\"all\">Todos los tipos</option>\r\n              <option value=\"sms\">Solo SMS</option>\r\n              <option value=\"email\">Solo Email</option>\r\n            </select>\r\n            \r\n            <button\r\n              onClick={loadStatistics}\r\n              className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2\"\r\n            >\r\n              <ArrowPathIcon className=\"w-4 h-4\" />\r\n              Actualizar\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Tarjetas de Resumen */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8\">\r\n          <motion.div\r\n            initial={{ opacity: 0, y: 20 }}\r\n            animate={{ opacity: 1, y: 0 }}\r\n            className=\"bg-white rounded-xl shadow-sm p-6\"\r\n          >\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <div className=\"p-2 bg-blue-100 rounded-lg\">\r\n                <ChartBarIcon className=\"w-6 h-6 text-blue-600\" />\r\n              </div>\r\n              <span className={`text-sm font-medium ${getRateColor(statistics.overview.avgDeliveryRate)}`}>\r\n                {statistics.overview.avgDeliveryRate.toFixed(1)}%\r\n              </span>\r\n            </div>\r\n            <h3 className=\"text-2xl font-bold text-gray-900 mb-1\">\r\n              {formatNumber(statistics.overview.totalCampaigns)}\r\n            </h3>\r\n            <p className=\"text-sm text-gray-600\">Campa√±as Totales</p>\r\n          </motion.div>\r\n\r\n          <motion.div\r\n            initial={{ opacity: 0, y: 20 }}\r\n            animate={{ opacity: 1, y: 0 }}\r\n            transition={{ delay: 0.1 }}\r\n            className=\"bg-white rounded-xl shadow-sm p-6\"\r\n          >\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <div className=\"p-2 bg-green-100 rounded-lg\">\r\n                <EnvelopeIcon className=\"w-6 h-6 text-green-600\" />\r\n              </div>\r\n              <span className=\"text-sm font-medium text-green-600\">\r\n                {formatNumber(statistics.overview.totalDelivered)}\r\n              </span>\r\n            </div>\r\n            <h3 className=\"text-2xl font-bold text-gray-900 mb-1\">\r\n              {formatNumber(statistics.overview.totalSent)}\r\n            </h3>\r\n            <p className=\"text-sm text-gray-600\">Mensajes Enviados</p>\r\n          </motion.div>\r\n\r\n          <motion.div\r\n            initial={{ opacity: 0, y: 20 }}\r\n            animate={{ opacity: 1, y: 0 }}\r\n            transition={{ delay: 0.2 }}\r\n            className=\"bg-white rounded-xl shadow-sm p-6\"\r\n          >\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <div className=\"p-2 bg-yellow-100 rounded-lg\">\r\n                <ChatBubbleLeftRightIcon className=\"w-6 h-6 text-yellow-600\" />\r\n              </div>\r\n              <span className=\"text-sm font-medium text-yellow-600\">\r\n                {statistics.emailStats.avgOpenRate.toFixed(1)}%\r\n              </span>\r\n            </div>\r\n            <h3 className=\"text-2xl font-bold text-gray-900 mb-1\">\r\n              {formatNumber(statistics.emailStats.opened)}\r\n            </h3>\r\n            <p className=\"text-sm text-gray-600\">Emails Abiertos</p>\r\n          </motion.div>\r\n\r\n          <motion.div\r\n            initial={{ opacity: 0, y: 20 }}\r\n            animate={{ opacity: 1, y: 0 }}\r\n            transition={{ delay: 0.3 }}\r\n            className=\"bg-white rounded-xl shadow-sm p-6\"\r\n          >\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <div className=\"p-2 bg-purple-100 rounded-lg\">\r\n                <CurrencyDollarIcon className=\"w-6 h-6 text-purple-600\" />\r\n              </div>\r\n              <span className=\"text-sm font-medium text-purple-600\">\r\n                Total\r\n              </span>\r\n            </div>\r\n            <h3 className=\"text-2xl font-bold text-gray-900 mb-1\">\r\n              {formatCurrency(statistics.overview.totalCost)}\r\n            </h3>\r\n            <p className=\"text-sm text-gray-600\">Costo de Env√≠os</p>\r\n          </motion.div>\r\n        </div>\r\n\r\n        {/* Estad√≠sticas por Canal */}\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8\">\r\n          {/* Estad√≠sticas SMS */}\r\n          <motion.div\r\n            initial={{ opacity: 0, x: -20 }}\r\n            animate={{ opacity: 1, x: 0 }}\r\n            className=\"bg-white rounded-xl shadow-sm p-6\"\r\n          >\r\n            <div className=\"flex items-center justify-between mb-6\">\r\n              <h2 className=\"text-xl font-semibold text-gray-900 flex items-center gap-2\">\r\n                <ChatBubbleLeftRightIcon className=\"w-5 h-5 text-green-600\" />\r\n                Estad√≠sticas SMS\r\n              </h2>\r\n              <span className={`text-sm font-medium ${getRateColor(statistics.smsStats.deliveryRate)}`}>\r\n                {statistics.smsStats.deliveryRate.toFixed(1)}% entrega\r\n              </span>\r\n            </div>\r\n            \r\n            <div className=\"space-y-4\">\r\n              <div className=\"flex justify-between items-center\">\r\n                <span className=\"text-gray-600\">Enviados</span>\r\n                <span className=\"font-semibold\">{formatNumber(statistics.smsStats.sent)}</span>\r\n              </div>\r\n              <div className=\"flex justify-between items-center\">\r\n                <span className=\"text-gray-600\">Entregados</span>\r\n                <span className=\"font-semibold text-green-600\">{formatNumber(statistics.smsStats.delivered)}</span>\r\n              </div>\r\n              <div className=\"flex justify-between items-center\">\r\n                <span className=\"text-gray-600\">Fallidos</span>\r\n                <span className=\"font-semibold text-red-600\">{formatNumber(statistics.smsStats.failed)}</span>\r\n              </div>\r\n              <div className=\"flex justify-between items-center pt-4 border-t\">\r\n                <span className=\"text-gray-600\">Costo Total</span>\r\n                <span className=\"font-semibold\">{formatCurrency(statistics.smsStats.cost)}</span>\r\n              </div>\r\n            </div>\r\n          </motion.div>\r\n\r\n          {/* Estad√≠sticas Email */}\r\n          <motion.div\r\n            initial={{ opacity: 0, x: 20 }}\r\n            animate={{ opacity: 1, x: 0 }}\r\n            className=\"bg-white rounded-xl shadow-sm p-6\"\r\n          >\r\n            <div className=\"flex items-center justify-between mb-6\">\r\n              <h2 className=\"text-xl font-semibold text-gray-900 flex items-center gap-2\">\r\n                <EnvelopeIcon className=\"w-5 h-5 text-blue-600\" />\r\n                Estad√≠sticas Email\r\n              </h2>\r\n              <span className={`text-sm font-medium ${getRateColor(statistics.emailStats.deliveryRate)}`}>\r\n                {statistics.emailStats.deliveryRate.toFixed(1)}% entrega\r\n              </span>\r\n            </div>\r\n            \r\n            <div className=\"space-y-4\">\r\n              <div className=\"flex justify-between items-center\">\r\n                <span className=\"text-gray-600\">Enviados</span>\r\n                <span className=\"font-semibold\">{formatNumber(statistics.emailStats.sent)}</span>\r\n              </div>\r\n              <div className=\"flex justify-between items-center\">\r\n                <span className=\"text-gray-600\">Entregados</span>\r\n                <span className=\"font-semibold text-green-600\">{formatNumber(statistics.emailStats.delivered)}</span>\r\n              </div>\r\n              <div className=\"flex justify-between items-center\">\r\n                <span className=\"text-gray-600\">Abiertos</span>\r\n                <span className=\"font-semibold text-blue-600\">{formatNumber(statistics.emailStats.opened)}</span>\r\n              </div>\r\n              <div className=\"flex justify-between items-center\">\r\n                <span className=\"text-gray-600\">Clics</span>\r\n                <span className=\"font-semibold text-purple-600\">{formatNumber(statistics.emailStats.clicked)}</span>\r\n              </div>\r\n              <div className=\"flex justify-between items-center pt-4 border-t\">\r\n                <span className=\"text-gray-600\">Costo Total</span>\r\n                <span className=\"font-semibold\">{formatCurrency(statistics.emailStats.cost)}</span>\r\n              </div>\r\n            </div>\r\n          </motion.div>\r\n        </div>\r\n\r\n        {/* Campa√±as Recientes */}\r\n        <motion.div\r\n          initial={{ opacity: 0, y: 20 }}\r\n          animate={{ opacity: 1, y: 0 }}\r\n          className=\"bg-white rounded-xl shadow-sm p-6\"\r\n        >\r\n          <h2 className=\"text-xl font-semibold text-gray-900 mb-6\">Campa√±as Recientes</h2>\r\n          \r\n          {statistics.recentCampaigns.length === 0 ? (\r\n            <div className=\"text-center py-12\">\r\n              <DocumentTextIcon className=\"w-16 h-16 text-gray-400 mx-auto mb-4\" />\r\n              <h3 className=\"text-lg font-medium text-gray-900 mb-2\">No hay campa√±as</h3>\r\n              <p className=\"text-gray-600\">A√∫n no has enviado ninguna campa√±a</p>\r\n            </div>\r\n          ) : (\r\n            <div className=\"overflow-x-auto\">\r\n              <table className=\"w-full\">\r\n                <thead>\r\n                  <tr className=\"border-b\">\r\n                    <th className=\"text-left py-3 px-4 text-sm font-medium text-gray-700\">Nombre</th>\r\n                    <th className=\"text-left py-3 px-4 text-sm font-medium text-gray-700\">Tipo</th>\r\n                    <th className=\"text-left py-3 px-4 text-sm font-medium text-gray-700\">Estado</th>\r\n                    <th className=\"text-left py-3 px-4 text-sm font-medium text-gray-700\">Destinatarios</th>\r\n                    <th className=\"text-left py-3 px-4 text-sm font-medium text-gray-700\">Tasa Entrega</th>\r\n                    <th className=\"text-left py-3 px-4 text-sm font-medium text-gray-700\">Fecha</th>\r\n                    <th className=\"text-left py-3 px-4 text-sm font-medium text-gray-700\">Acciones</th>\r\n                  </tr>\r\n                </thead>\r\n                <tbody>\r\n                  {statistics.recentCampaigns.map((campaign) => (\r\n                    <tr key={campaign.id} className=\"border-b hover:bg-gray-50\">\r\n                      <td className=\"py-3 px-4\">\r\n                        <div className=\"font-medium text-gray-900\">{campaign.name}</div>\r\n                        {campaign.description && (\r\n                          <div className=\"text-sm text-gray-600\">{campaign.description}</div>\r\n                        )}\r\n                      </td>\r\n                      <td className=\"py-3 px-4\">\r\n                        <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${\r\n                          campaign.campaign_type === 'sms' \r\n                            ? 'bg-green-100 text-green-800' \r\n                            : 'bg-blue-100 text-blue-800'\r\n                        }`}>\r\n                          {campaign.campaign_type === 'sms' ? 'SMS' : 'Email'}\r\n                        </span>\r\n                      </td>\r\n                      <td className=\"py-3 px-4\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          {getStatusIcon(campaign.status)}\r\n                          <span className=\"text-sm text-gray-900\">{campaign.status}</span>\r\n                        </div>\r\n                      </td>\r\n                      <td className=\"py-3 px-4 text-sm text-gray-900\">\r\n                        {formatNumber(campaign.total_recipients)}\r\n                      </td>\r\n                      <td className=\"py-3 px-4\">\r\n                        <span className={`text-sm font-medium ${getRateColor(\r\n                          campaign.total_recipients > 0 \r\n                            ? (campaign.sent_count / campaign.total_recipients) * 100 \r\n                            : 0\r\n                        )}`}>\r\n                          {campaign.total_recipients > 0 \r\n                            ? ((campaign.sent_count / campaign.total_recipients) * 100).toFixed(1)\r\n                            : 0}%\r\n                        </span>\r\n                      </td>\r\n                      <td className=\"py-3 px-4 text-sm text-gray-900\">\r\n                        {formatDate(campaign.created_at)}\r\n                      </td>\r\n                      <td className=\"py-3 px-4\">\r\n                        <button\r\n                          onClick={() => loadCampaignDetails(campaign.id)}\r\n                          className=\"text-blue-600 hover:text-blue-800 text-sm font-medium\"\r\n                        >\r\n                          Ver detalles\r\n                        </button>\r\n                      </td>\r\n                    </tr>\r\n                  ))}\r\n                </tbody>\r\n              </table>\r\n            </div>\r\n          )}\r\n        </motion.div>\r\n      </div>\r\n\r\n      {/* Modal de Detalles de Campa√±a */}\r\n      <AnimatePresence>\r\n        {showDetails && selectedCampaign && (\r\n          <motion.div\r\n            initial={{ opacity: 0 }}\r\n            animate={{ opacity: 1 }}\r\n            exit={{ opacity: 0 }}\r\n            className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50\"\r\n            onClick={() => setShowDetails(false)}\r\n          >\r\n            <motion.div\r\n              initial={{ scale: 0.95, opacity: 0 }}\r\n              animate={{ scale: 1, opacity: 1 }}\r\n              exit={{ scale: 0.95, opacity: 0 }}\r\n              className=\"bg-white rounded-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto\"\r\n              onClick={(e) => e.stopPropagation()}\r\n            >\r\n              <div className=\"p-6\">\r\n                <div className=\"flex justify-between items-start mb-6\">\r\n                  <div>\r\n                    <h3 className=\"text-xl font-semibold text-gray-900 mb-2\">\r\n                      {selectedCampaign.name}\r\n                    </h3>\r\n                    <p className=\"text-gray-600\">{selectedCampaign.description}</p>\r\n                  </div>\r\n                  <button\r\n                    onClick={() => setShowDetails(false)}\r\n                    className=\"text-gray-400 hover:text-gray-600\"\r\n                  >\r\n                    <XCircleIcon className=\"w-6 h-6\" />\r\n                  </button>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-2 gap-4 mb-6\">\r\n                  <div className=\"bg-gray-50 rounded-lg p-4\">\r\n                    <div className=\"text-sm text-gray-600 mb-1\">Tipo</div>\r\n                    <div className=\"font-semibold\">\r\n                      {selectedCampaign.campaign_type === 'sms' ? 'SMS' : 'Email'}\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"bg-gray-50 rounded-lg p-4\">\r\n                    <div className=\"text-sm text-gray-600 mb-1\">Estado</div>\r\n                    <div className=\"font-semibold flex items-center gap-2\">\r\n                      {getStatusIcon(selectedCampaign.status)}\r\n                      {selectedCampaign.status}\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"bg-gray-50 rounded-lg p-4\">\r\n                    <div className=\"text-sm text-gray-600 mb-1\">Destinatarios</div>\r\n                    <div className=\"font-semibold\">\r\n                      {formatNumber(selectedCampaign.total_recipients)}\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"bg-gray-50 rounded-lg p-4\">\r\n                    <div className=\"text-sm text-gray-600 mb-1\">Fecha Creaci√≥n</div>\r\n                    <div className=\"font-semibold\">\r\n                      {formatDate(selectedCampaign.created_at)}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                {selectedCampaign.statistics && (\r\n                  <div className=\"border-t pt-6\">\r\n                    <h4 className=\"font-semibold text-gray-900 mb-4\">Estad√≠sticas Detalladas</h4>\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-gray-600\">Enviados:</span>\r\n                        <span className=\"font-semibold\">\r\n                          {formatNumber(selectedCampaign.statistics.sent_count)}\r\n                        </span>\r\n                      </div>\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-gray-600\">Entregados:</span>\r\n                        <span className=\"font-semibold text-green-600\">\r\n                          {formatNumber(selectedCampaign.statistics.delivered_count)}\r\n                        </span>\r\n                      </div>\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-gray-600\">Fallidos:</span>\r\n                        <span className=\"font-semibold text-red-600\">\r\n                          {formatNumber(selectedCampaign.statistics.failed_count)}\r\n                        </span>\r\n                      </div>\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-gray-600\">Tasa Entrega:</span>\r\n                        <span className={`font-semibold ${getRateColor(\r\n                          selectedCampaign.statistics.delivery_rate\r\n                        )}`}>\r\n                          {selectedCampaign.statistics.delivery_rate.toFixed(1)}%\r\n                        </span>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </motion.div>\r\n          </motion.div>\r\n        )}\r\n      </AnimatePresence>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default BrevoStatisticsDashboard","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\communication\\BrevoTemplatesManager.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'CheckCircleIcon' is defined but never used.","line":10,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'FunnelIcon' is defined but never used.","line":13,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":13},{"ruleId":"no-unused-vars","severity":1,"message":"'EyeSlashIcon' is defined but never used.","line":19,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback } from 'react'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport {\r\n  DocumentTextIcon,\r\n  PlusIcon,\r\n  PencilIcon,\r\n  TrashIcon,\r\n  EnvelopeIcon,\r\n  ChatBubbleLeftRightIcon,\r\n  CheckCircleIcon,\r\n  XCircleIcon,\r\n  MagnifyingGlassIcon,\r\n  FunnelIcon,\r\n  TagIcon,\r\n  ClockIcon,\r\n  UserGroupIcon,\r\n  ArrowPathIcon,\r\n  EyeIcon,\r\n  EyeSlashIcon,\r\n  DocumentDuplicateIcon,\r\n  SparklesIcon\r\n} from '@heroicons/react/24/outline'\r\nimport brevoCampaignService from '../../services/brevoCampaignService.js'\r\nimport brevoService from '../../services/brevoService.js'\r\n\r\nconst BrevoTemplatesManager = () => {\r\n  const [templates, setTemplates] = useState([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [error, setError] = useState(null)\r\n  const [selectedType, setSelectedType] = useState('all')\r\n  const [searchTerm, setSearchTerm] = useState('')\r\n  const [showCreateModal, setShowCreateModal] = useState(false)\r\n  const [showEditModal, setShowEditModal] = useState(false)\r\n  const [selectedTemplate, setSelectedTemplate] = useState(null)\r\n  const [formData, setFormData] = useState({\r\n    name: '',\r\n    description: '',\r\n    type: 'sms',\r\n    subject: '',\r\n    content: '',\r\n    variables: []\r\n  })\r\n  const [previewMode, setPreviewMode] = useState(false)\r\n  const [testMode, setTestMode] = useState(false)\r\n  const [testData, setTestData] = useState({\r\n    to: '',\r\n    message: '',\r\n    subject: ''\r\n  })\r\n\r\n  // Cargar plantillas\r\n  const loadTemplates = useCallback(async () => {\r\n    try {\r\n      setLoading(true)\r\n      setError(null)\r\n      \r\n      // Verificar si Brevo est√° configurado\r\n      const config = brevoService.loadConfiguration()\r\n      if (!config.apiKey) {\r\n        setError('Brevo no est√° configurado. Por favor, configura tu API key en Integraciones.')\r\n        return\r\n      }\r\n      \r\n      const templatesData = await brevoCampaignService.getTemplates(selectedType === 'all' ? null : selectedType)\r\n      setTemplates(templatesData)\r\n    } catch (error) {\r\n      console.error('Error cargando plantillas:', error)\r\n      setError(error.message || 'Error al cargar plantillas')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [selectedType])\r\n\r\n  // Crear plantilla\r\n  const createTemplate = async () => {\r\n    try {\r\n      // Validar datos\r\n      if (!formData.name.trim()) {\r\n        setError('El nombre de la plantilla es requerido')\r\n        return\r\n      }\r\n      \r\n      if (!formData.content.trim()) {\r\n        setError('El contenido de la plantilla es requerido')\r\n        return\r\n      }\r\n      \r\n      if (formData.type === 'email' && !formData.subject.trim()) {\r\n        setError('El asunto es requerido para plantillas de email')\r\n        return\r\n      }\r\n      \r\n      const templateData = {\r\n        name: formData.name.trim(),\r\n        description: formData.description.trim(),\r\n        type: formData.type,\r\n        subject: formData.subject.trim(),\r\n        content: formData.content.trim(),\r\n        variables: extractVariables(formData.content)\r\n      }\r\n      \r\n      await brevoCampaignService.createTemplate(templateData)\r\n      \r\n      // Resetear formulario y cerrar modal\r\n      setFormData({\r\n        name: '',\r\n        description: '',\r\n        type: 'sms',\r\n        subject: '',\r\n        content: '',\r\n        variables: []\r\n      })\r\n      setShowCreateModal(false)\r\n      \r\n      // Recargar plantillas\r\n      await loadTemplates()\r\n      \r\n    } catch (error) {\r\n      console.error('Error creando plantilla:', error)\r\n      setError(error.message || 'Error al crear plantilla')\r\n    }\r\n  }\r\n\r\n  // Editar plantilla\r\n  const editTemplate = async () => {\r\n    try {\r\n      // Validar datos\r\n      if (!formData.name.trim()) {\r\n        setError('El nombre de la plantilla es requerido')\r\n        return\r\n      }\r\n      \r\n      if (!formData.content.trim()) {\r\n        setError('El contenido de la plantilla es requerido')\r\n        return\r\n      }\r\n      \r\n      if (formData.type === 'email' && !formData.subject.trim()) {\r\n        setError('El asunto es requerido para plantillas de email')\r\n        return\r\n      }\r\n      \r\n      // Actualizar plantilla (simulado - necesitar√≠amos implementar el m√©todo updateTemplate en el servicio)\r\n      const templateData = {\r\n        name: formData.name.trim(),\r\n        description: formData.description.trim(),\r\n        type: formData.type,\r\n        subject: formData.subject.trim(),\r\n        content: formData.content.trim(),\r\n        variables: extractVariables(formData.content)\r\n      }\r\n      \r\n      // Aqu√≠ ir√≠a la l√≥gica para actualizar la plantilla en la base de datos\r\n      console.log('Actualizando plantilla:', templateData)\r\n      \r\n      // Resetear formulario y cerrar modal\r\n      setFormData({\r\n        name: '',\r\n        description: '',\r\n        type: 'sms',\r\n        subject: '',\r\n        content: '',\r\n        variables: []\r\n      })\r\n      setShowEditModal(false)\r\n      setSelectedTemplate(null)\r\n      \r\n      // Recargar plantillas\r\n      await loadTemplates()\r\n      \r\n    } catch (error) {\r\n      console.error('Error editando plantilla:', error)\r\n      setError(error.message || 'Error al editar plantilla')\r\n    }\r\n  }\r\n\r\n  // Eliminar plantilla\r\n  const deleteTemplate = async (templateId) => {\r\n    if (!window.confirm('¬øEst√°s seguro de que deseas eliminar esta plantilla?')) {\r\n      return\r\n    }\r\n    \r\n    try {\r\n      // Aqu√≠ ir√≠a la l√≥gica para eliminar la plantilla en la base de datos\r\n      console.log('Eliminando plantilla:', templateId)\r\n      \r\n      // Recargar plantillas\r\n      await loadTemplates()\r\n      \r\n    } catch (error) {\r\n      console.error('Error eliminando plantilla:', error)\r\n      setError(error.message || 'Error al eliminar plantilla')\r\n    }\r\n  }\r\n\r\n  // Duplicar plantilla\r\n  const duplicateTemplate = async (template) => {\r\n    try {\r\n      const duplicatedData = {\r\n        name: `${template.name} (Copia)`,\r\n        description: template.description ? `${template.description} (Copia)` : '',\r\n        type: template.template_type,\r\n        subject: template.subject,\r\n        content: template.content,\r\n        variables: template.variables\r\n      }\r\n      \r\n      await brevoCampaignService.createTemplate(duplicatedData)\r\n      await loadTemplates()\r\n      \r\n    } catch (error) {\r\n      console.error('Error duplicando plantilla:', error)\r\n      setError(error.message || 'Error al duplicar plantilla')\r\n    }\r\n  }\r\n\r\n  // Extraer variables del contenido\r\n  const extractVariables = (content) => {\r\n    const variableRegex = /{{(w+)}}/g\r\n    const variables = []\r\n    let match\r\n    \r\n    while ((match = variableRegex.exec(content)) !== null) {\r\n      if (!variables.includes(match[1])) {\r\n        variables.push(match[1])\r\n      }\r\n    }\r\n    \r\n    return variables\r\n  }\r\n\r\n  // Previsualizar plantilla\r\n  const previewTemplate = (template) => {\r\n    setSelectedTemplate(template)\r\n    setPreviewMode(true)\r\n  }\r\n\r\n  // Probar env√≠o\r\n  const testSend = async () => {\r\n    try {\r\n      if (!testData.to.trim()) {\r\n        setError('El destinatario es requerido para la prueba')\r\n        return\r\n      }\r\n      \r\n      if (selectedTemplate.type === 'email' && !testData.subject.trim()) {\r\n        setError('El asunto es requerido para la prueba de email')\r\n        return\r\n      }\r\n      \r\n      const testDataSend = {\r\n        type: selectedTemplate.type,\r\n        to: testData.to.trim(),\r\n        subject: selectedTemplate.type === 'email' ? testData.subject.trim() : undefined,\r\n        message: selectedTemplate.content\r\n      }\r\n      \r\n      await brevoCampaignService.testSend(testDataSend)\r\n      \r\n      alert('Prueba enviada exitosamente')\r\n      setTestMode(false)\r\n      setTestData({ to: '', message: '', subject: '' })\r\n      \r\n    } catch (error) {\r\n      console.error('Error en prueba de env√≠o:', error)\r\n      setError(error.message || 'Error en la prueba de env√≠o')\r\n    }\r\n  }\r\n\r\n  // Filtrar plantillas\r\n  const filteredTemplates = templates.filter(template => {\r\n    const matchesSearch = template.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n                         template.description?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n                         template.content.toLowerCase().includes(searchTerm.toLowerCase())\r\n    \r\n    const matchesType = selectedType === 'all' || template.template_type === selectedType\r\n    \r\n    return matchesSearch && matchesType\r\n  })\r\n\r\n  // Formatear fecha\r\n  const formatDate = (dateString) => {\r\n    return new Date(dateString).toLocaleDateString('es-CL', {\r\n      day: '2-digit',\r\n      month: '2-digit',\r\n      year: 'numeric',\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    })\r\n  }\r\n\r\n  // Obtener icono para tipo\r\n  const getTypeIcon = (type) => {\r\n    return type === 'email' ? \r\n      <EnvelopeIcon className=\"w-5 h-5\" /> : \r\n      <ChatBubbleLeftRightIcon className=\"w-5 h-5\" />\r\n  }\r\n\r\n  // Obtener color para tipo\r\n  const getTypeColor = (type) => {\r\n    return type === 'email' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'\r\n  }\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\r\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\r\nuseEffect(() => {\r\n    loadTemplates()\r\n  }, [loadTemplates])\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gray-50 p-6\">\r\n      <div className=\"max-w-7xl mx-auto\">\r\n        {/* Header */}\r\n        <div className=\"mb-8\">\r\n          <h1 className=\"text-3xl font-bold text-gray-900 mb-2\">\r\n            Gestor de Plantillas\r\n          </h1>\r\n          <p className=\"text-gray-600\">\r\n            Crea y gestiona plantillas reutilizables para tus campa√±as de SMS y Email\r\n          </p>\r\n        </div>\r\n\r\n        {/* Controles */}\r\n        <div className=\"bg-white rounded-xl shadow-sm p-6 mb-8\">\r\n          <div className=\"flex flex-wrap gap-4 items-center justify-between\">\r\n            <div className=\"flex flex-wrap gap-4 items-center flex-1\">\r\n              {/* B√∫squeda */}\r\n              <div className=\"relative flex-1 min-w-64\">\r\n                <MagnifyingGlassIcon className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400\" />\r\n                <input\r\n                  type=\"text\"\r\n                  placeholder=\"Buscar plantillas...\"\r\n                  value={searchTerm}\r\n                  onChange={(e) => setSearchTerm(e.target.value)}\r\n                  className=\"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                />\r\n              </div>\r\n              \r\n              {/* Filtro por tipo */}\r\n              <select\r\n                value={selectedType}\r\n                onChange={(e) => setSelectedType(e.target.value)}\r\n                className=\"px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n              >\r\n                <option value=\"all\">Todos los tipos</option>\r\n                <option value=\"sms\">Solo SMS</option>\r\n                <option value=\"email\">Solo Email</option>\r\n              </select>\r\n            </div>\r\n            \r\n            {/* Botones de acci√≥n */}\r\n            <div className=\"flex gap-2\">\r\n              <button\r\n                onClick={() => setShowCreateModal(true)}\r\n                className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2\"\r\n              >\r\n                <PlusIcon className=\"w-4 h-4\" />\r\n                Nueva Plantilla\r\n              </button>\r\n              <button\r\n                onClick={loadTemplates}\r\n                className=\"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2\"\r\n              >\r\n                <ArrowPathIcon className=\"w-4 h-4\" />\r\n                Actualizar\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Lista de plantillas */}\r\n        {loading ? (\r\n          <div className=\"flex items-center justify-center py-12\">\r\n            <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600\"></div>\r\n          </div>\r\n        ) : error ? (\r\n          <div className=\"flex items-center justify-center py-12\">\r\n            <div className=\"text-center\">\r\n              <XCircleIcon className=\"w-16 h-16 text-red-500 mx-auto mb-4\" />\r\n              <h3 className=\"text-lg font-medium text-gray-900 mb-2\">Error</h3>\r\n              <p className=\"text-gray-600 mb-4\">{error}</p>\r\n              <button\r\n                onClick={loadTemplates}\r\n                className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors\"\r\n              >\r\n                Reintentar\r\n              </button>\r\n            </div>\r\n          </div>\r\n        ) : filteredTemplates.length === 0 ? (\r\n          <div className=\"text-center py-12\">\r\n            <DocumentTextIcon className=\"w-16 h-16 text-gray-400 mx-auto mb-4\" />\r\n            <h3 className=\"text-lg font-medium text-gray-900 mb-2\">No hay plantillas</h3>\r\n            <p className=\"text-gray-600 mb-4\">\r\n              {searchTerm || selectedType !== 'all' \r\n                ? 'No se encontraron plantillas con los filtros aplicados' \r\n                : 'A√∫n no has creado ninguna plantilla'}\r\n            </p>\r\n            <button\r\n              onClick={() => setShowCreateModal(true)}\r\n              className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors\"\r\n            >\r\n              Crear Primera Plantilla\r\n            </button>\r\n          </div>\r\n        ) : (\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n            {filteredTemplates.map((template) => (\r\n              <motion.div\r\n                key={template.id}\r\n                initial={{ opacity: 0, y: 20 }}\r\n                animate={{ opacity: 1, y: 0 }}\r\n                className=\"bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow\"\r\n              >\r\n                <div className=\"flex items-start justify-between mb-4\">\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <div className={`p-2 rounded-lg ${getTypeColor(template.template_type)}`}>\r\n                      {getTypeIcon(template.template_type)}\r\n                    </div>\r\n                    <div>\r\n                      <h3 className=\"font-semibold text-gray-900\">{template.name}</h3>\r\n                      <p className=\"text-sm text-gray-600\">\r\n                        {template.template_type === 'email' ? 'Email' : 'SMS'}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"flex items-center gap-1\">\r\n                    <button\r\n                      onClick={() => previewTemplate(template)}\r\n                      className=\"p-1 text-gray-400 hover:text-blue-600 transition-colors\"\r\n                      title=\"Previsualizar\"\r\n                    >\r\n                      <EyeIcon className=\"w-4 h-4\" />\r\n                    </button>\r\n                    <button\r\n                      onClick={() => {\r\n                        setSelectedTemplate(template)\r\n                        setFormData({\r\n                          name: template.name,\r\n                          description: template.description || '',\r\n                          type: template.template_type,\r\n                          subject: template.subject || '',\r\n                          content: template.content,\r\n                          variables: template.variables || []\r\n                        })\r\n                        setShowEditModal(true)\r\n                      }}\r\n                      className=\"p-1 text-gray-400 hover:text-blue-600 transition-colors\"\r\n                      title=\"Editar\"\r\n                    >\r\n                      <PencilIcon className=\"w-4 h-4\" />\r\n                    </button>\r\n                    <button\r\n                      onClick={() => duplicateTemplate(template)}\r\n                      className=\"p-1 text-gray-400 hover:text-blue-600 transition-colors\"\r\n                      title=\"Duplicar\"\r\n                    >\r\n                      <DocumentDuplicateIcon className=\"w-4 h-4\" />\r\n                    </button>\r\n                    <button\r\n                      onClick={() => deleteTemplate(template.id)}\r\n                      className=\"p-1 text-gray-400 hover:text-red-600 transition-colors\"\r\n                      title=\"Eliminar\"\r\n                    >\r\n                      <TrashIcon className=\"w-4 h-4\" />\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n                \r\n                {template.description && (\r\n                  <p className=\"text-sm text-gray-600 mb-4\">{template.description}</p>\r\n                )}\r\n                \r\n                <div className=\"mb-4\">\r\n                  <div className=\"text-sm text-gray-500 mb-2\">Vista previa:</div>\r\n                  <div className=\"bg-gray-50 rounded-lg p-3 text-sm text-gray-700 max-h-32 overflow-y-auto\">\r\n                    {template.template_type === 'email' && template.subject && (\r\n                      <div className=\"font-medium mb-2\">Asunto: {template.subject}</div>\r\n                    )}\r\n                    <div>{template.content.substring(0, 200)}{template.content.length > 200 ? '...' : ''}</div>\r\n                  </div>\r\n                </div>\r\n                \r\n                {template.variables && template.variables.length > 0 && (\r\n                  <div className=\"flex items-center gap-2 text-sm text-gray-600\">\r\n                    <TagIcon className=\"w-4 h-4\" />\r\n                    <span>{template.variables.length} variables</span>\r\n                  </div>\r\n                )}\r\n                \r\n                <div className=\"flex items-center justify-between text-xs text-gray-500\">\r\n                  <div className=\"flex items-center gap-1\">\r\n                    <ClockIcon className=\"w-3 h-3\" />\r\n                    <span>{formatDate(template.created_at)}</span>\r\n                  </div>\r\n                  <div className=\"flex items-center gap-1\">\r\n                    <UserGroupIcon className=\"w-3 h-3\" />\r\n                    <span>{template.usage_count || 0} usos</span>\r\n                  </div>\r\n                </div>\r\n              </motion.div>\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Modal Crear Plantilla */}\r\n      <AnimatePresence>\r\n        {showCreateModal && (\r\n          <motion.div\r\n            initial={{ opacity: 0 }}\r\n            animate={{ opacity: 1 }}\r\n            exit={{ opacity: 0 }}\r\n            className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50\"\r\n            onClick={() => setShowCreateModal(false)}\r\n          >\r\n            <motion.div\r\n              initial={{ scale: 0.95, opacity: 0 }}\r\n              animate={{ scale: 1, opacity: 1 }}\r\n              exit={{ scale: 0.95, opacity: 0 }}\r\n              className=\"bg-white rounded-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto\"\r\n              onClick={(e) => e.stopPropagation()}\r\n            >\r\n              <div className=\"p-6\">\r\n                <div className=\"flex justify-between items-center mb-6\">\r\n                  <h2 className=\"text-xl font-semibold text-gray-900\">Nueva Plantilla</h2>\r\n                  <button\r\n                    onClick={() => setShowCreateModal(false)}\r\n                    className=\"text-gray-400 hover:text-gray-600\"\r\n                  >\r\n                    <XCircleIcon className=\"w-6 h-6\" />\r\n                  </button>\r\n                </div>\r\n                \r\n                <div className=\"space-y-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                      Nombre *\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={formData.name}\r\n                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                      placeholder=\"Ej: Bienvenida a nuevos empleados\"\r\n                    />\r\n                  </div>\r\n                  \r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                      Descripci√≥n\r\n                    </label>\r\n                    <textarea\r\n                      value={formData.description}\r\n                      onChange={(e) => setFormData({ ...formData, description: e.target.value })}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                      rows=\"2\"\r\n                      placeholder=\"Descripci√≥n opcional de la plantilla\"\r\n                    />\r\n                  </div>\r\n                  \r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                      Tipo *\r\n                    </label>\r\n                    <select\r\n                      value={formData.type}\r\n                      onChange={(e) => setFormData({ ...formData, type: e.target.value })}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                    >\r\n                      <option value=\"sms\">SMS</option>\r\n                      <option value=\"email\">Email</option>\r\n                    </select>\r\n                  </div>\r\n                  \r\n                  {formData.type === 'email' && (\r\n                    <div>\r\n                      <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                        Asunto *\r\n                      </label>\r\n                      <input\r\n                        type=\"text\"\r\n                        value={formData.subject}\r\n                        onChange={(e) => setFormData({ ...formData, subject: e.target.value })}\r\n                        className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                        placeholder=\"Asunto del email\"\r\n                      />\r\n                    </div>\r\n                  )}\r\n                  \r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                      Contenido *\r\n                    </label>\r\n                    <textarea\r\n                      value={formData.content}\r\n                      onChange={(e) => setFormData({ ...formData, content: e.target.value })}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                      rows=\"6\"\r\n                      placeholder={`Escribe tu mensaje aqu√≠. Usa variables como {{nombre}} para personalizar.${formData.type === 'sms' ? '\\n\\nEj: Hola {{nombre}}, tu turno es el {{fecha}}.' : '\\n\\nEj: Estimado/a {{nombre}},\\n\\nTe confirmamos que tu reuni√≥n est√° programada para el {{fecha}}.'}`}\r\n                    />\r\n                  </div>\r\n                  \r\n                  {extractVariables(formData.content).length > 0 && (\r\n                    <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-3\">\r\n                      <div className=\"text-sm font-medium text-blue-800 mb-2\">\r\n                        <SparklesIcon className=\"w-4 h-4 inline mr-1\" />\r\n                        Variables detectadas:\r\n                      </div>\r\n                      <div className=\"flex flex-wrap gap-2\">\r\n                        {extractVariables(formData.content).map((variable, index) => (\r\n                          <span key={index} className=\"px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs\">\r\n                            {`{{${variable}}}`}\r\n                          </span>\r\n                        ))}\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n                \r\n                <div className=\"flex justify-end gap-3 mt-6\">\r\n                  <button\r\n                    onClick={() => setShowCreateModal(false)}\r\n                    className=\"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors\"\r\n                  >\r\n                    Cancelar\r\n                  </button>\r\n                  <button\r\n                    onClick={createTemplate}\r\n                    className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors\"\r\n                  >\r\n                    Crear Plantilla\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </motion.div>\r\n          </motion.div>\r\n        )}\r\n      </AnimatePresence>\r\n\r\n      {/* Modal Editar Plantilla */}\r\n      <AnimatePresence>\r\n        {showEditModal && (\r\n          <motion.div\r\n            initial={{ opacity: 0 }}\r\n            animate={{ opacity: 1 }}\r\n            exit={{ opacity: 0 }}\r\n            className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50\"\r\n            onClick={() => setShowEditModal(false)}\r\n          >\r\n            <motion.div\r\n              initial={{ scale: 0.95, opacity: 0 }}\r\n              animate={{ scale: 1, opacity: 1 }}\r\n              exit={{ scale: 0.95, opacity: 0 }}\r\n              className=\"bg-white rounded-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto\"\r\n              onClick={(e) => e.stopPropagation()}\r\n            >\r\n              <div className=\"p-6\">\r\n                <div className=\"flex justify-between items-center mb-6\">\r\n                  <h2 className=\"text-xl font-semibold text-gray-900\">Editar Plantilla</h2>\r\n                  <button\r\n                    onClick={() => setShowEditModal(false)}\r\n                    className=\"text-gray-400 hover:text-gray-600\"\r\n                  >\r\n                    <XCircleIcon className=\"w-6 h-6\" />\r\n                  </button>\r\n                </div>\r\n                \r\n                <div className=\"space-y-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                      Nombre *\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={formData.name}\r\n                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                    />\r\n                  </div>\r\n                  \r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                      Descripci√≥n\r\n                    </label>\r\n                    <textarea\r\n                      value={formData.description}\r\n                      onChange={(e) => setFormData({ ...formData, description: e.target.value })}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                      rows=\"2\"\r\n                    />\r\n                  </div>\r\n                  \r\n                  {formData.type === 'email' && (\r\n                    <div>\r\n                      <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                        Asunto *\r\n                      </label>\r\n                      <input\r\n                        type=\"text\"\r\n                        value={formData.subject}\r\n                        onChange={(e) => setFormData({ ...formData, subject: e.target.value })}\r\n                        className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                      />\r\n                    </div>\r\n                  )}\r\n                  \r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                      Contenido *\r\n                    </label>\r\n                    <textarea\r\n                      value={formData.content}\r\n                      onChange={(e) => setFormData({ ...formData, content: e.target.value })}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                      rows=\"6\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n                \r\n                <div className=\"flex justify-end gap-3 mt-6\">\r\n                  <button\r\n                    onClick={() => setShowEditModal(false)}\r\n                    className=\"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors\"\r\n                  >\r\n                    Cancelar\r\n                  </button>\r\n                  <button\r\n                    onClick={editTemplate}\r\n                    className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors\"\r\n                  >\r\n                    Guardar Cambios\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </motion.div>\r\n          </motion.div>\r\n        )}\r\n      </AnimatePresence>\r\n\r\n      {/* Modal Previsualizar */}\r\n      <AnimatePresence>\r\n        {previewMode && selectedTemplate && (\r\n          <motion.div\r\n            initial={{ opacity: 0 }}\r\n            animate={{ opacity: 1 }}\r\n            exit={{ opacity: 0 }}\r\n            className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50\"\r\n            onClick={() => setPreviewMode(false)}\r\n          >\r\n            <motion.div\r\n              initial={{ scale: 0.95, opacity: 0 }}\r\n              animate={{ scale: 1, opacity: 1 }}\r\n              exit={{ scale: 0.95, opacity: 0 }}\r\n              className=\"bg-white rounded-xl max-w-3xl w-full max-h-[80vh] overflow-y-auto\"\r\n              onClick={(e) => e.stopPropagation()}\r\n            >\r\n              <div className=\"p-6\">\r\n                <div className=\"flex justify-between items-center mb-6\">\r\n                  <h2 className=\"text-xl font-semibold text-gray-900\">\r\n                    Previsualizar Plantilla\r\n                  </h2>\r\n                  <div className=\"flex gap-2\">\r\n                    <button\r\n                      onClick={() => {\r\n                        setTestMode(true)\r\n                        setPreviewMode(false)\r\n                      }}\r\n                      className=\"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2\"\r\n                    >\r\n                      <ChatBubbleLeftRightIcon className=\"w-4 h-4\" />\r\n                      Probar Env√≠o\r\n                    </button>\r\n                    <button\r\n                      onClick={() => setPreviewMode(false)}\r\n                      className=\"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors\"\r\n                    >\r\n                      Cerrar\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n                \r\n                <div className=\"space-y-4\">\r\n                  <div>\r\n                    <h3 className=\"font-semibold text-gray-900 mb-2\">{selectedTemplate.name}</h3>\r\n                    {selectedTemplate.description && (\r\n                      <p className=\"text-gray-600 mb-4\">{selectedTemplate.description}</p>\r\n                    )}\r\n                  </div>\r\n                  \r\n                  {selectedTemplate.template_type === 'email' && selectedTemplate.subject && (\r\n                    <div className=\"bg-gray-50 rounded-lg p-4\">\r\n                      <div className=\"text-sm font-medium text-gray-700 mb-1\">Asunto:</div>\r\n                      <div>{selectedTemplate.subject}</div>\r\n                    </div>\r\n                  )}\r\n                  \r\n                  <div className=\"bg-gray-50 rounded-lg p-4\">\r\n                    <div className=\"text-sm font-medium text-gray-700 mb-2\">Contenido:</div>\r\n                    <div className=\"whitespace-pre-wrap\">{selectedTemplate.content}</div>\r\n                  </div>\r\n                  \r\n                  {selectedTemplate.variables && selectedTemplate.variables.length > 0 && (\r\n                    <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-4\">\r\n                      <div className=\"text-sm font-medium text-blue-800 mb-2\">\r\n                        Variables disponibles:\r\n                      </div>\r\n                      <div className=\"flex flex-wrap gap-2\">\r\n                        {selectedTemplate.variables.map((variable, index) => (\r\n                          <span key={index} className=\"px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs\">\r\n                          {`{{${variable}}`}\r\n                          </span>\r\n                        ))}\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            </motion.div>\r\n          </motion.div>\r\n        )}\r\n      </AnimatePresence>\r\n\r\n      {/* Modal Probar Env√≠o */}\r\n      <AnimatePresence>\r\n        {testMode && selectedTemplate && (\r\n          <motion.div\r\n            initial={{ opacity: 0 }}\r\n            animate={{ opacity: 1 }}\r\n            exit={{ opacity: 0 }}\r\n            className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50\"\r\n            onClick={() => setTestMode(false)}\r\n          >\r\n            <motion.div\r\n              initial={{ scale: 0.95, opacity: 0 }}\r\n              animate={{ scale: 1, opacity: 1 }}\r\n              exit={{ scale: 0.95, opacity: 0 }}\r\n              className=\"bg-white rounded-xl max-w-md w-full\"\r\n              onClick={(e) => e.stopPropagation()}\r\n            >\r\n              <div className=\"p-6\">\r\n                <div className=\"flex justify-between items-center mb-6\">\r\n                  <h2 className=\"text-xl font-semibold text-gray-900\">\r\n                    Probar Env√≠o\r\n                  </h2>\r\n                  <button\r\n                    onClick={() => setTestMode(false)}\r\n                    className=\"text-gray-400 hover:text-gray-600\"\r\n                  >\r\n                    <XCircleIcon className=\"w-6 h-6\" />\r\n                  </button>\r\n                </div>\r\n                \r\n                <div className=\"space-y-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                      Destinatario *\r\n                    </label>\r\n                    <input\r\n                      type={selectedTemplate.template_type === 'email' ? 'email' : 'tel'}\r\n                      value={testData.to}\r\n                      onChange={(e) => setTestData({ ...testData, to: e.target.value })}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                      placeholder={selectedTemplate.template_type === 'email' ? 'email@ejemplo.com' : '+56912345678'}\r\n                    />\r\n                  </div>\r\n                  \r\n                  {selectedTemplate.template_type === 'email' && (\r\n                    <div>\r\n                      <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                        Asunto\r\n                      </label>\r\n                      <input\r\n                        type=\"text\"\r\n                        value={testData.subject}\r\n                        onChange={(e) => setTestData({ ...testData, subject: e.target.value })}\r\n                        className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                        placeholder=\"Asunto de prueba\"\r\n                      />\r\n                    </div>\r\n                  )}\r\n                  \r\n                  <div className=\"bg-gray-50 rounded-lg p-4\">\r\n                    <div className=\"text-sm text-gray-700 mb-2\">Mensaje:</div>\r\n                    <div className=\"text-sm text-gray-900\">{selectedTemplate.content}</div>\r\n                  </div>\r\n                </div>\r\n                \r\n                <div className=\"flex justify-end gap-3 mt-6\">\r\n                  <button\r\n                    onClick={() => setTestMode(false)}\r\n                    className=\"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors\"\r\n                  >\r\n                    Cancelar\r\n                  </button>\r\n                  <button\r\n                    onClick={testSend}\r\n                    className=\"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors\"\r\n                  >\r\n                    Enviar Prueba\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </motion.div>\r\n          </motion.div>\r\n        )}\r\n      </AnimatePresence>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default BrevoTemplatesManager","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\communication\\ContactSelector.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'BriefcaseIcon' is defined but never used.","line":7,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'XMarkIcon' is defined but never used.","line":12,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'supabase' is defined but never used.","line":15,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { \r\n  BuildingOfficeIcon, \r\n  MapPinIcon, \r\n  UserGroupIcon, \r\n  IdentificationIcon, \r\n  BriefcaseIcon, \r\n  HomeModernIcon,\r\n  DocumentTextIcon,\r\n  FunnelIcon,\r\n  CheckCircleIcon,\r\n  XMarkIcon,\r\n  ArrowPathIcon\r\n} from '@heroicons/react/24/outline';\r\nimport { supabase } from '../../lib/supabase.js';\r\nimport communicationService from '../../services/communicationService.js';\r\nimport employeeDataService from '../../services/employeeDataService.js';\r\n\r\nconst ContactSelector = ({ selectedEmployees, onEmployeeSelectionChange, onSendMessages }) => {\r\n  const [employees, setEmployees] = useState([]);\r\n  const [filteredEmployees, setFilteredEmployees] = useState([]);\r\n  const [filters, setFilters] = useState({\r\n    company: [],\r\n    region: [],\r\n    department: [],\r\n    level: [],\r\n    workMode: [],\r\n    contractType: [],\r\n    position: []\r\n  });\r\n  const [loading, setLoading] = useState(true);\r\n  const [syncing, setSyncing] = useState(false);\r\n  const [filterOptions, setFilterOptions] = useState({\r\n    companies: [],\r\n    regions: [],\r\n    departments: [],\r\n    levels: [],\r\n    workModes: [],\r\n    contractTypes: [],\r\n    positions: []\r\n  });\r\n\r\n  // Obtener datos de empleados y opciones de filtro\r\n  useEffect(() => {\r\n    const fetchData = async () => {\r\n      try {\r\n        setLoading(true);\r\n        \r\n        // Obtener empleados reales de la base de datos\r\n        const employeesData = await communicationService.getEmployees();\r\n        setEmployees(employeesData);\r\n        setFilteredEmployees(employeesData);\r\n        \r\n        // Extraer valores √∫nicos para los filtros\r\n        const companies = [...new Set(employeesData.map(emp => emp.company?.name).filter(Boolean))];\r\n        const regions = [...new Set(employeesData.map(emp => emp.region).filter(Boolean))];\r\n        const departments = [...new Set(employeesData.map(emp => emp.department).filter(Boolean))];\r\n        const levels = [...new Set(employeesData.map(emp => emp.level).filter(Boolean))];\r\n        const workModes = [...new Set(employeesData.map(emp => emp.work_mode).filter(Boolean))];\r\n        const contractTypes = [...new Set(employeesData.map(emp => emp.contract_type).filter(Boolean))];\r\n        const positions = [...new Set(employeesData.map(emp => emp.position).filter(Boolean))];\r\n        \r\n        setFilterOptions({\r\n          companies,\r\n          regions,\r\n          departments,\r\n          levels,\r\n          workModes,\r\n          contractTypes,\r\n          positions\r\n        });\r\n      } catch (error) {\r\n        console.error('Error fetching data:', error);\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    };\r\n\r\n    fetchData();\r\n  }, []);\r\n\r\n  // Aplicar filtros\r\n  useEffect(() => {\r\n    let result = [...employees];\r\n    \r\n    // Aplicar filtros de selecci√≥n m√∫ltiple\r\n    if (filters.company.length > 0) {\r\n      result = result.filter(emp => {\r\n        const companyName = emp.company?.name || emp.company;\r\n        return filters.company.includes(companyName);\r\n      });\r\n    }\r\n    \r\n    if (filters.region.length > 0) {\r\n      result = result.filter(emp => filters.region.includes(emp.region));\r\n    }\r\n    \r\n    if (filters.department.length > 0) {\r\n      result = result.filter(emp => filters.department.includes(emp.department));\r\n    }\r\n    \r\n    if (filters.level.length > 0) {\r\n      result = result.filter(emp => filters.level.includes(emp.level));\r\n    }\r\n    \r\n    if (filters.workMode.length > 0) {\r\n      result = result.filter(emp => filters.workMode.includes(emp.work_mode));\r\n    }\r\n    \r\n    if (filters.contractType.length > 0) {\r\n      result = result.filter(emp => filters.contractType.includes(emp.contract_type));\r\n    }\r\n    \r\n    if (filters.position.length > 0) {\r\n      result = result.filter(emp => filters.position.includes(emp.position));\r\n    }\r\n    \r\n    setFilteredEmployees(result);\r\n  }, [filters, employees]);\r\n\r\n  const handleFilterChange = (filterName, value) => {\r\n    setFilters(prev => {\r\n      const currentValues = prev[filterName] || [];\r\n      let newValues;\r\n      \r\n      if (currentValues.includes(value)) {\r\n        // Si el valor ya est√° seleccionado, lo eliminamos\r\n        newValues = currentValues.filter(item => item !== value);\r\n      } else {\r\n        // Si el valor no est√° seleccionado, lo agregamos\r\n        newValues = [...currentValues, value];\r\n      }\r\n      \r\n      return {\r\n        ...prev,\r\n        [filterName]: newValues\r\n      };\r\n    });\r\n  };\r\n\r\n  const clearFilters = () => {\r\n    setFilters({\r\n      company: [],\r\n      region: [],\r\n      department: [],\r\n      level: [],\r\n      workMode: [],\r\n      contractType: [],\r\n      position: []\r\n    });\r\n  };\r\n\r\n  const toggleEmployeeSelection = (employeeId) => {\r\n    const newSelection = selectedEmployees.includes(employeeId)\r\n      ? selectedEmployees.filter(id => id !== employeeId)\r\n      : [...selectedEmployees, employeeId];\r\n    \r\n    onEmployeeSelectionChange(newSelection);\r\n  };\r\n\r\n  const selectAllEmployees = () => {\r\n    if (selectedEmployees.length === filteredEmployees.length) {\r\n      onEmployeeSelectionChange([]);\r\n    } else {\r\n      onEmployeeSelectionChange(filteredEmployees.map(emp => emp.id));\r\n    }\r\n  };\r\n\r\n  // Sincronizar datos con el dashboard\r\n  const syncWithDashboard = async () => {\r\n    try {\r\n      setSyncing(true);\r\n      await employeeDataService.syncEmployeesWithDashboard();\r\n      \r\n      // Recargar los datos despu√©s de la sincronizaci√≥n\r\n      const employeesData = await communicationService.getEmployees();\r\n      setEmployees(employeesData);\r\n      setFilteredEmployees(employeesData);\r\n      \r\n      // Actualizar las opciones de filtro\r\n      const companies = [...new Set(employeesData.map(emp => emp.company?.name || emp.company))];\r\n      const regions = [...new Set(employeesData.map(emp => emp.region).filter(Boolean))];\r\n      const departments = [...new Set(employeesData.map(emp => emp.department).filter(Boolean))];\r\n      const levels = [...new Set(employeesData.map(emp => emp.level).filter(Boolean))];\r\n      const workModes = [...new Set(employeesData.map(emp => emp.work_mode).filter(Boolean))];\r\n      const contractTypes = [...new Set(employeesData.map(emp => emp.contract_type).filter(Boolean))];\r\n      const positions = [...new Set(employeesData.map(emp => emp.position).filter(Boolean))];\r\n      \r\n      setFilterOptions({\r\n        companies,\r\n        regions,\r\n        departments,\r\n        levels,\r\n        workModes,\r\n        contractTypes,\r\n        positions\r\n      });\r\n    } catch (error) {\r\n      console.error('Error syncing with dashboard:', error);\r\n    } finally {\r\n      setSyncing(false);\r\n    }\r\n  };\r\n\r\n  // Orden alfab√©tico para empresas, departamentos, niveles, posiciones, modalidades y tipos de contrato\r\n  const getSortedValues = (values) => {\r\n    return values.sort((a, b) => a.localeCompare(b));\r\n  };\r\n\r\n  // Orden de regiones de norte a sur seg√∫n el mapa de Chile\r\n  const getSortedRegions = (regions) => {\r\n    const regionOrder = [\r\n      'Regi√≥n de Tarapac√°',\r\n      'Regi√≥n de Antofagasta',\r\n      'Regi√≥n de Atacama',\r\n      'Regi√≥n de Coquimbo',\r\n      'Regi√≥n de Valpara√≠so',\r\n      'Regi√≥n del Libertador General Bernardo O\\'Higgins',\r\n      'Regi√≥n del Maule',\r\n      'Regi√≥n de √ëuble',\r\n      'Regi√≥n del Biob√≠o',\r\n      'Regi√≥n de La Araucan√≠a',\r\n      'Regi√≥n de Los R√≠os',\r\n      'Regi√≥n de Los Lagos',\r\n      'Regi√≥n Ays√©n del General Carlos Ib√°√±ez del Campo',\r\n      'Regi√≥n de Magallanes y de la Ant√°rtica Chilena',\r\n      'Regi√≥n Metropolitana'\r\n    ];\r\n    \r\n    return regions.sort((a, b) => {\r\n      const indexA = regionOrder.indexOf(a);\r\n      const indexB = regionOrder.indexOf(b);\r\n      \r\n      // Si ambas regiones est√°n en la lista, ordenar por √≠ndice\r\n      if (indexA !== -1 && indexB !== -1) {\r\n        return indexA - indexB;\r\n      }\r\n      \r\n      // Si solo una regi√≥n est√° en la lista, esa va primero\r\n      if (indexA !== -1) return -1;\r\n      if (indexB !== -1) return 1;\r\n      \r\n      // Si ninguna est√° en la lista, ordenar alfab√©ticamente\r\n      return a.localeCompare(b);\r\n    });\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center h-64\">\r\n        <div className=\"text-center\">\r\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-engage-blue mx-auto\"></div>\r\n          <p className=\"mt-4 text-engage-black font-medium\">Cargando contactos...</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-8\">\r\n      {/* Filters Sidebar */}\r\n      <div className=\"lg:col-span-1\">\r\n        <div className=\"bg-white rounded-xl shadow-sm border border-gray-200 p-6 sticky top-8\">\r\n          <div className=\"flex items-center justify-between mb-6\">\r\n            <h2 className=\"text-lg font-semibold text-engage-black flex items-center\">\r\n              <FunnelIcon className=\"h-5 w-5 mr-2 text-engage-blue\" />\r\n              Filtros\r\n            </h2>\r\n            <div className=\"flex space-x-2\">\r\n              <button\r\n                onClick={syncWithDashboard}\r\n                disabled={syncing}\r\n                className={`text-sm ${syncing ? 'text-gray-400' : 'text-engage-blue hover:text-engage-yellow'}`}\r\n              >\r\n                {syncing ? (\r\n                  <ArrowPathIcon className=\"h-4 w-4 animate-spin\" />\r\n                ) : (\r\n                  'Sincronizar'\r\n                )}\r\n              </button>\r\n              <button\r\n                onClick={clearFilters}\r\n                className=\"text-sm text-engage-blue hover:text-engage-yellow\"\r\n              >\r\n                Limpiar\r\n              </button>\r\n            </div>\r\n          </div>\r\n          \r\n          <div className=\"space-y-5 max-h-[calc(100vh-200px)] overflow-y-auto pr-2\">\r\n            <div className=\"bg-engage-blue/5 rounded-lg p-4 border border-engage-blue/10\">\r\n              <div className=\"flex items-center justify-between mb-3\">\r\n                <h3 className=\"text-sm font-semibold text-engage-black flex items-center\">\r\n                  <BuildingOfficeIcon className=\"h-4 w-4 mr-2 text-engage-blue\" />\r\n                  Empresa\r\n                </h3>\r\n                <span className=\"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-engage-blue/10 text-engage-blue\">\r\n                  {filters.company.length > 0 ? `${filters.company.length} seleccionadas` : 'Todas'}\r\n                </span>\r\n              </div>\r\n              <div className=\"space-y-2 max-h-40 overflow-y-auto pr-2\">\r\n                {getSortedValues(filterOptions.companies).map(company => (\r\n                  <div key={company} className=\"flex items-center group\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id={`company-${company}`}\r\n                      checked={filters.company.includes(company)}\r\n                      onChange={() => handleFilterChange('company', company)}\r\n                      className=\"h-4 w-4 text-engage-blue border-gray-300 rounded focus:ring-engage-blue focus:ring-offset-0\"\r\n                    />\r\n                    <label htmlFor={`company-${company}`} className=\"ml-2 text-sm text-engage-black group-hover:text-engage-blue cursor-pointer\">\r\n                      {company}\r\n                    </label>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </div>\r\n            \r\n            <div className=\"bg-engage-yellow/5 rounded-lg p-4 border border-engage-yellow/10\">\r\n              <div className=\"flex items-center justify-between mb-3\">\r\n                <h3 className=\"text-sm font-semibold text-engage-black flex items-center\">\r\n                  <MapPinIcon className=\"h-4 w-4 mr-2 text-engage-yellow\" />\r\n                  Regi√≥n\r\n                </h3>\r\n                <span className=\"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-engage-yellow/10 text-engage-yellow\">\r\n                  {filters.region.length > 0 ? `${filters.region.length} seleccionadas` : 'Todas'}\r\n                </span>\r\n              </div>\r\n              <div className=\"space-y-2 max-h-40 overflow-y-auto pr-2\">\r\n                {getSortedRegions(filterOptions.regions).map(region => (\r\n                  <div key={region} className=\"flex items-center group\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id={`region-${region}`}\r\n                      checked={filters.region.includes(region)}\r\n                      onChange={() => handleFilterChange('region', region)}\r\n                      className=\"h-4 w-4 text-engage-yellow border-gray-300 rounded focus:ring-engage-yellow focus:ring-offset-0\"\r\n                    />\r\n                    <label htmlFor={`region-${region}`} className=\"ml-2 text-sm text-engage-black group-hover:text-engage-yellow cursor-pointer\">\r\n                      {region}\r\n                    </label>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </div>\r\n            \r\n            <div className=\"bg-gray-50 rounded-lg p-4 border border-gray-200\">\r\n              <div className=\"flex items-center justify-between mb-3\">\r\n                <h3 className=\"text-sm font-semibold text-engage-black flex items-center\">\r\n                  <UserGroupIcon className=\"h-4 w-4 mr-2 text-gray-500\" />\r\n                  Departamento\r\n                </h3>\r\n                <span className=\"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-700\">\r\n                  {filters.department.length > 0 ? `${filters.department.length} seleccionados` : 'Todos'}\r\n                </span>\r\n              </div>\r\n              <div className=\"space-y-2 max-h-40 overflow-y-auto pr-2\">\r\n                {getSortedValues(filterOptions.departments).map(department => (\r\n                  <div key={department} className=\"flex items-center group\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id={`department-${department}`}\r\n                      checked={filters.department.includes(department)}\r\n                      onChange={() => handleFilterChange('department', department)}\r\n                      className=\"h-4 w-4 text-gray-600 border-gray-300 rounded focus:ring-gray-600 focus:ring-offset-0\"\r\n                    />\r\n                    <label htmlFor={`department-${department}`} className=\"ml-2 text-sm text-engage-black group-hover:text-gray-600 cursor-pointer\">\r\n                      {department}\r\n                    </label>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </div>\r\n            \r\n            <div className=\"bg-gray-50 rounded-lg p-4 border border-gray-200\">\r\n              <div className=\"flex items-center justify-between mb-3\">\r\n                <h3 className=\"text-sm font-semibold text-engage-black flex items-center\">\r\n                  <IdentificationIcon className=\"h-4 w-4 mr-2 text-gray-500\" />\r\n                  Nivel Jer√°rquico\r\n                </h3>\r\n                <span className=\"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-700\">\r\n                  {filters.level.length > 0 ? `${filters.level.length} seleccionados` : 'Todos'}\r\n                </span>\r\n              </div>\r\n              <div className=\"space-y-2 max-h-40 overflow-y-auto pr-2\">\r\n                {getSortedValues(filterOptions.levels).map(level => (\r\n                  <div key={level} className=\"flex items-center group\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id={`level-${level}`}\r\n                      checked={filters.level.includes(level)}\r\n                      onChange={() => handleFilterChange('level', level)}\r\n                      className=\"h-4 w-4 text-gray-600 border-gray-300 rounded focus:ring-gray-600 focus:ring-offset-0\"\r\n                    />\r\n                    <label htmlFor={`level-${level}`} className=\"ml-2 text-sm text-engage-black group-hover:text-gray-600 cursor-pointer\">\r\n                      {level}\r\n                    </label>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </div>\r\n            \r\n            <div className=\"bg-engage-yellow/5 rounded-lg p-4 border border-engage-yellow/10\">\r\n              <div className=\"flex items-center justify-between mb-3\">\r\n                <h3 className=\"text-sm font-semibold text-engage-black flex items-center\">\r\n                  <HomeModernIcon className=\"h-4 w-4 mr-2 text-engage-yellow\" />\r\n                  Modalidad de Trabajo\r\n                </h3>\r\n                <span className=\"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-engage-yellow/10 text-engage-yellow\">\r\n                  {filters.workMode.length > 0 ? `${filters.workMode.length} seleccionadas` : 'Todas'}\r\n                </span>\r\n              </div>\r\n              <div className=\"space-y-2 max-h-40 overflow-y-auto pr-2\">\r\n                {getSortedValues(filterOptions.workModes).map(workMode => (\r\n                  <div key={workMode} className=\"flex items-center group\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id={`workMode-${workMode}`}\r\n                      checked={filters.workMode.includes(workMode)}\r\n                      onChange={() => handleFilterChange('workMode', workMode)}\r\n                      className=\"h-4 w-4 text-engage-yellow border-gray-300 rounded focus:ring-engage-yellow focus:ring-offset-0\"\r\n                    />\r\n                    <label htmlFor={`workMode-${workMode}`} className=\"ml-2 text-sm text-engage-black group-hover:text-engage-yellow cursor-pointer\">\r\n                      {workMode}\r\n                    </label>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </div>\r\n            \r\n            <div className=\"bg-gray-50 rounded-lg p-4 border border-gray-200\">\r\n              <div className=\"flex items-center justify-between mb-3\">\r\n                <h3 className=\"text-sm font-semibold text-engage-black flex items-center\">\r\n                  <DocumentTextIcon className=\"h-4 w-4 mr-2 text-gray-500\" />\r\n                  Tipo de Contrato\r\n                </h3>\r\n                <span className=\"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-700\">\r\n                  {filters.contractType.length > 0 ? `${filters.contractType.length} seleccionados` : 'Todos'}\r\n                </span>\r\n              </div>\r\n              <div className=\"space-y-2 max-h-40 overflow-y-auto pr-2\">\r\n                {getSortedValues(filterOptions.contractTypes).map(contractType => (\r\n                  <div key={contractType} className=\"flex items-center group\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id={`contractType-${contractType}`}\r\n                      checked={filters.contractType.includes(contractType)}\r\n                      onChange={() => handleFilterChange('contractType', contractType)}\r\n                      className=\"h-4 w-4 text-gray-600 border-gray-300 rounded focus:ring-gray-600 focus:ring-offset-0\"\r\n                    />\r\n                    <label htmlFor={`contractType-${contractType}`} className=\"ml-2 text-sm text-engage-black group-hover:text-gray-600 cursor-pointer\">\r\n                      {contractType}\r\n                    </label>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          </div>\r\n          \r\n          <div className=\"mt-6 pt-4 border-t border-gray-200\">\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <span className=\"text-sm font-medium text-engage-black\">\r\n                Resultados: {filteredEmployees.length}\r\n              </span>\r\n              <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-engage-blue/10 text-engage-blue\">\r\n                {selectedEmployees.length} seleccionados\r\n              </span>\r\n            </div>\r\n            \r\n            <button\r\n              onClick={selectAllEmployees}\r\n              className=\"w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-engage-black bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-engage-blue mb-3\"\r\n            >\r\n              {selectedEmployees.length === filteredEmployees.length ? 'Deseleccionar todos' : 'Seleccionar todos'}\r\n            </button>\r\n            \r\n            <button\r\n              onClick={() => onSendMessages(selectedEmployees)}\r\n              disabled={selectedEmployees.length === 0}\r\n              className={`w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 ${\r\n                selectedEmployees.length === 0 \r\n                  ? 'bg-gray-400 cursor-not-allowed' \r\n                  : 'bg-engage-blue hover:bg-engage-yellow focus:ring-engage-blue'\r\n              }`}\r\n            >\r\n              <CheckCircleIcon className=\"h-5 w-5 mr-2\" />\r\n              Enviar Mensajes ({selectedEmployees.length})\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      \r\n      {/* Employee List */}\r\n      <div className=\"lg:col-span-3\">\r\n        <div className=\"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden h-full flex flex-col\">\r\n          <div className=\"overflow-x-auto flex-grow\" style={{ maxHeight: 'calc(100vh - 200px)' }}>\r\n            <table className=\"min-w-full divide-y divide-gray-200\">\r\n              <thead className=\"bg-gray-50 sticky top-0 z-10\">\r\n                <tr>\r\n                  <th scope=\"col\" className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    Nombre\r\n                  </th>\r\n                  <th scope=\"col\" className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    Empresa\r\n                  </th>\r\n                  <th scope=\"col\" className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    Departamento\r\n                  </th>\r\n                  <th scope=\"col\" className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    Nivel Jer√°rquico\r\n                  </th>\r\n                  <th scope=\"col\" className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    Modalidad de Trabajo\r\n                  </th>\r\n                  <th scope=\"col\" className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    Acciones\r\n                  </th>\r\n                </tr>\r\n              </thead>\r\n              <tbody className=\"bg-white\">\r\n                {filteredEmployees.map((employee) => (\r\n                  <tr key={employee.id} className=\"hover:bg-gray-50\">\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-700\">\r\n                      {employee.name}\r\n                    </td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-700\">\r\n                      {employee.company?.name || employee.company}\r\n                    </td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-700\">\r\n                      {employee.department || '-'}\r\n                    </td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-700\">\r\n                      {employee.level || '-'}\r\n                    </td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-700\">\r\n                      {employee.work_mode || '-'}\r\n                    </td>\r\n                    <td className=\"px-6 py-4 whitespace-nowrap text-right text-sm font-medium\">\r\n                      <button\r\n                        onClick={() => toggleEmployeeSelection(employee.id)}\r\n                        className={`p-1 rounded-full ${\r\n                          selectedEmployees.includes(employee.id) \r\n                            ? 'bg-engage-blue/10 text-engage-blue' \r\n                            : 'bg-gray-100 text-gray-500 hover:bg-gray-200'\r\n                        }`}\r\n                      >\r\n                        <CheckCircleIcon className=\"h-5 w-5\" />\r\n                      </button>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n            \r\n            {filteredEmployees.length === 0 && (\r\n              <div className=\"text-center py-12\">\r\n                <BuildingOfficeIcon className=\"mx-auto h-12 w-12 text-gray-400\" />\r\n                <h3 className=\"mt-2 text-sm font-medium text-gray-900\">No se encontraron empleados</h3>\r\n                <p className=\"mt-1 text-sm text-gray-500\">\r\n                  Intente ajustar los filtros para encontrar empleados.\r\n                </p>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ContactSelector;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\communication\\CreateEventModal.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'CalendarIcon' is defined but never used.","line":5,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useAuth } from '../../contexts/AuthContext.js';\r\nimport {\r\n  XMarkIcon,\r\n  CalendarIcon,\r\n  ClockIcon,\r\n  MapPinIcon,\r\n  UserGroupIcon,\r\n  PaperAirplaneIcon,\r\n  CheckCircleIcon\r\n} from '@heroicons/react/24/outline';\r\nimport calendarService from '../../services/calendarService.js';\r\nimport organizedDatabaseService from '../../services/organizedDatabaseService.js';\r\nimport enhancedCommunicationService from '../../services/enhancedCommunicationService.js';\r\n\r\nconst CreateEventModal = ({ isOpen, onClose, onEventCreated }) => {\r\n  const { userProfile } = useAuth();\r\n  const [loading, setLoading] = useState(false);\r\n  const [employees, setEmployees] = useState([]);\r\n  const [selectedEmployees, setSelectedEmployees] = useState([]);\r\n  const [sendInvitations, setSendInvitations] = useState(true);\r\n  const [formData, setFormData] = useState({\r\n    title: '',\r\n    description: '',\r\n    startTime: '',\r\n    endTime: '',\r\n    location: '',\r\n    platform: 'google', // 'google' o 'microsoft'\r\n    attendees: []\r\n  });\r\n\r\n  // Cargar empleados al abrir el modal\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      loadEmployees();\r\n      // Resetear formulario\r\n      setFormData({\r\n        title: '',\r\n        description: '',\r\n        startTime: '',\r\n        endTime: '',\r\n        location: '',\r\n        platform: 'google',\r\n        attendees: []\r\n      });\r\n      setSelectedEmployees([]);\r\n      setSendInvitations(true);\r\n    }\r\n  }, [isOpen]);\r\n\r\n  const loadEmployees = async () => {\r\n    try {\r\n      const employeeData = await organizedDatabaseService.getEmployees();\r\n      setEmployees(employeeData);\r\n    } catch (error) {\r\n      console.error('Error cargando empleados:', error);\r\n    }\r\n  };\r\n\r\n  const handleInputChange = (field, value) => {\r\n    setFormData(prev => ({\r\n      ...prev,\r\n      [field]: value\r\n    }));\r\n  };\r\n\r\n  const toggleEmployeeSelection = (employeeId) => {\r\n    if (selectedEmployees.includes(employeeId)) {\r\n      setSelectedEmployees(selectedEmployees.filter(id => id !== employeeId));\r\n    } else {\r\n      setSelectedEmployees([...selectedEmployees, employeeId]);\r\n    }\r\n  };\r\n\r\n  const selectAllEmployees = () => {\r\n    if (selectedEmployees.length === employees.length) {\r\n      setSelectedEmployees([]);\r\n    } else {\r\n      setSelectedEmployees(employees.map(emp => emp.id));\r\n    }\r\n  };\r\n\r\n  const handleSubmit = async (e) => {\r\n    e.preventDefault();\r\n\r\n    if (!formData.title.trim() || !formData.startTime || !formData.endTime) {\r\n      alert('Por favor complete todos los campos requeridos');\r\n      return;\r\n    }\r\n\r\n    if (new Date(formData.startTime) >= new Date(formData.endTime)) {\r\n      alert('La hora de fin debe ser posterior a la hora de inicio');\r\n      return;\r\n    }\r\n\r\n    setLoading(true);\r\n\r\n    try {\r\n      // Preparar datos del evento\r\n      const eventData = {\r\n        title: formData.title,\r\n        description: formData.description,\r\n        startTime: formData.startTime,\r\n        endTime: formData.endTime,\r\n        location: formData.location,\r\n        attendees: selectedEmployees.map(empId => {\r\n          const employee = employees.find(emp => emp.id === empId);\r\n          return employee ? employee.email || `${employee.name}@company.com` : '';\r\n        }).filter(email => email)\r\n      };\r\n\r\n      // Crear evento en el calendario\r\n      const createdEvent = await calendarService.createEvent(userProfile.id, eventData, formData.platform);\r\n\r\n      // Enviar invitaciones por WhatsApp si est√° habilitado\r\n      if (sendInvitations && selectedEmployees.length > 0) {\r\n        const invitationMessage = `Invitaci√≥n a reuni√≥n: \"${formData.title}\"\\n\\nüìÖ Fecha: ${new Date(formData.startTime).toLocaleDateString('es-ES', {\r\n          weekday: 'long',\r\n          year: 'numeric',\r\n          month: 'long',\r\n          day: 'numeric',\r\n          hour: '2-digit',\r\n          minute: '2-digit'\r\n        })}\\n\\nüìç Ubicaci√≥n: ${formData.location || 'Por confirmar'}\\n\\n${formData.description ? `üìù Descripci√≥n: ${formData.description}\\n\\n` : ''}${createdEvent.meetLink ? `üîó Enlace: ${createdEvent.meetLink}` : ''}`;\r\n\r\n        await enhancedCommunicationService.sendWhatsAppMessage(selectedEmployees, invitationMessage);\r\n      }\r\n\r\n      // Notificar √©xito\r\n      if (onEventCreated) {\r\n        onEventCreated(createdEvent);\r\n      }\r\n\r\n      onClose();\r\n\r\n    } catch (error) {\r\n      console.error('Error creando evento:', error);\r\n      alert('Error al crear el evento. Por favor intenta nuevamente.');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  if (!isOpen) return null;\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\r\n      <div className=\"bg-white rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between p-6 border-b border-gray-200\">\r\n          <h2 className=\"text-xl font-bold text-engage-black\">Crear Nuevo Evento</h2>\r\n          <button\r\n            onClick={onClose}\r\n            className=\"text-gray-400 hover:text-gray-600\"\r\n          >\r\n            <XMarkIcon className=\"h-6 w-6\" />\r\n          </button>\r\n        </div>\r\n\r\n        {/* Form */}\r\n        <form onSubmit={handleSubmit} className=\"p-6 space-y-6\">\r\n          {/* Plataforma */}\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n              Plataforma de Calendario\r\n            </label>\r\n            <div className=\"flex space-x-4\">\r\n              <label className=\"flex items-center\">\r\n                <input\r\n                  type=\"radio\"\r\n                  name=\"platform\"\r\n                  value=\"google\"\r\n                  checked={formData.platform === 'google'}\r\n                  onChange={(e) => handleInputChange('platform', e.target.value)}\r\n                  className=\"text-engage-blue focus:ring-engage-blue\"\r\n                />\r\n                <span className=\"ml-2 text-sm\">Google Calendar</span>\r\n              </label>\r\n              <label className=\"flex items-center\">\r\n                <input\r\n                  type=\"radio\"\r\n                  name=\"platform\"\r\n                  value=\"microsoft\"\r\n                  checked={formData.platform === 'microsoft'}\r\n                  onChange={(e) => handleInputChange('platform', e.target.value)}\r\n                  className=\"text-engage-blue focus:ring-engage-blue\"\r\n                />\r\n                <span className=\"ml-2 text-sm\">Microsoft Outlook</span>\r\n              </label>\r\n            </div>\r\n          </div>\r\n\r\n          {/* T√≠tulo */}\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n              T√≠tulo del Evento *\r\n            </label>\r\n            <input\r\n              type=\"text\"\r\n              value={formData.title}\r\n              onChange={(e) => handleInputChange('title', e.target.value)}\r\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engage-blue focus:border-transparent\"\r\n              placeholder=\"Ingrese el t√≠tulo del evento\"\r\n              required\r\n            />\r\n          </div>\r\n\r\n          {/* Descripci√≥n */}\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n              Descripci√≥n\r\n            </label>\r\n            <textarea\r\n              value={formData.description}\r\n              onChange={(e) => handleInputChange('description', e.target.value)}\r\n              rows={3}\r\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engage-blue focus:border-transparent\"\r\n              placeholder=\"Ingrese la descripci√≥n del evento\"\r\n            />\r\n          </div>\r\n\r\n          {/* Fecha y Hora */}\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                <ClockIcon className=\"h-4 w-4 inline mr-1\" />\r\n                Fecha y Hora de Inicio *\r\n              </label>\r\n              <input\r\n                type=\"datetime-local\"\r\n                value={formData.startTime}\r\n                onChange={(e) => handleInputChange('startTime', e.target.value)}\r\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engage-blue focus:border-transparent\"\r\n                required\r\n              />\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                <ClockIcon className=\"h-4 w-4 inline mr-1\" />\r\n                Fecha y Hora de Fin *\r\n              </label>\r\n              <input\r\n                type=\"datetime-local\"\r\n                value={formData.endTime}\r\n                onChange={(e) => handleInputChange('endTime', e.target.value)}\r\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engage-blue focus:border-transparent\"\r\n                required\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Ubicaci√≥n */}\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n              <MapPinIcon className=\"h-4 w-4 inline mr-1\" />\r\n              Ubicaci√≥n\r\n            </label>\r\n            <input\r\n              type=\"text\"\r\n              value={formData.location}\r\n              onChange={(e) => handleInputChange('location', e.target.value)}\r\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engage-blue focus:border-transparent\"\r\n              placeholder=\"Sala de reuniones, direcci√≥n, o enlace virtual\"\r\n            />\r\n          </div>\r\n\r\n          {/* Invitados */}\r\n          <div>\r\n            <div className=\"flex items-center justify-between mb-2\">\r\n              <label className=\"block text-sm font-medium text-gray-700\">\r\n                <UserGroupIcon className=\"h-4 w-4 inline mr-1\" />\r\n                Invitados\r\n              </label>\r\n              <button\r\n                type=\"button\"\r\n                onClick={selectAllEmployees}\r\n                className=\"text-sm text-engage-blue hover:text-engage-yellow\"\r\n              >\r\n                {selectedEmployees.length === employees.length ? 'Deseleccionar todos' : 'Seleccionar todos'}\r\n              </button>\r\n            </div>\r\n            <div className=\"max-h-40 overflow-y-auto border border-gray-300 rounded-lg p-2\">\r\n              {employees.slice(0, 20).map((employee) => (\r\n                <label key={employee.id} className=\"flex items-center py-1\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    checked={selectedEmployees.includes(employee.id)}\r\n                    onChange={() => toggleEmployeeSelection(employee.id)}\r\n                    className=\"text-engage-blue focus:ring-engage-blue\"\r\n                  />\r\n                  <span className=\"ml-2 text-sm\">{employee.name} - {employee.position}</span>\r\n                </label>\r\n              ))}\r\n            </div>\r\n            <p className=\"text-xs text-gray-500 mt-1\">\r\n              {selectedEmployees.length} empleados seleccionados\r\n            </p>\r\n          </div>\r\n\r\n          {/* Opci√≥n de env√≠o de invitaciones */}\r\n          <div className=\"flex items-center\">\r\n            <input\r\n              type=\"checkbox\"\r\n              id=\"sendInvitations\"\r\n              checked={sendInvitations}\r\n              onChange={(e) => setSendInvitations(e.target.checked)}\r\n              className=\"text-engage-blue focus:ring-engage-blue\"\r\n            />\r\n            <label htmlFor=\"sendInvitations\" className=\"ml-2 text-sm text-gray-700\">\r\n              <PaperAirplaneIcon className=\"h-4 w-4 inline mr-1\" />\r\n              Enviar invitaciones por WhatsApp\r\n            </label>\r\n          </div>\r\n\r\n          {/* Botones */}\r\n          <div className=\"flex justify-end space-x-3 pt-4 border-t border-gray-200\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={onClose}\r\n              className=\"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200\"\r\n              disabled={loading}\r\n            >\r\n              Cancelar\r\n            </button>\r\n            <button\r\n              type=\"submit\"\r\n              disabled={loading}\r\n              className=\"px-4 py-2 bg-engage-blue text-white rounded-lg hover:bg-engage-yellow disabled:opacity-50 flex items-center\"\r\n            >\r\n              {loading ? (\r\n                <>\r\n                  <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2\"></div>\r\n                  Creando...\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <CheckCircleIcon className=\"h-4 w-4 mr-2\" />\r\n                  Crear Evento\r\n                </>\r\n              )}\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default CreateEventModal;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\communication\\EmployeeBulkUpload.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\communication\\EmployeeFolders.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'allFoldersNormalized' is assigned a value but never used.","line":32,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":30},{"ruleId":"no-unused-vars","severity":1,"message":"'setAllFoldersNormalized' is assigned a value but never used.","line":32,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":55},{"ruleId":"no-unused-vars","severity":1,"message":"'totalItems' is assigned a value but never used.","line":52,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":52,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'employeeCompanyIndex' is assigned a value but never used.","line":54,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":54,"endColumn":28},{"ruleId":"no-use-before-define","severity":1,"message":"'loadEmployeesOnly' was used before it was defined.","line":105,"column":27,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":105,"endColumn":44},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'filters.companyId'. Either include it or remove the dependency array.","line":112,"column":6,"nodeType":"ArrayExpression","endLine":112,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [companyId, filters.companyId]","fix":{"range":[3990,4001],"text":"[companyId, filters.companyId]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadFoldersForCurrentPage'. Either include it or remove the dependency array.","line":126,"column":6,"nodeType":"ArrayExpression","endLine":126,"endColumn":85,"suggestions":[{"desc":"Update the dependencies array to be: [currentPage, searchTerm, filters, loading, companies.length, employees.length, loadFoldersForCurrentPage]","fix":{"range":[4478,4557],"text":"[currentPage, searchTerm, filters, loading, companies.length, employees.length, loadFoldersForCurrentPage]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'currentPage' and 'employees'. Either include them or remove the dependency array.","line":151,"column":6,"nodeType":"ArrayExpression","endLine":151,"endColumn":45,"suggestions":[{"desc":"Update the dependencies array to be: [searchTerm, filters, employees.length, employees, currentPage]","fix":{"range":[5539,5578],"text":"[searchTerm, filters, employees.length, employees, currentPage]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'loadEmployeesOnly' function makes the dependencies of useEffect Hook (at line 105) change on every render. To fix this, wrap the definition of 'loadEmployeesOnly' in its own useCallback() Hook.","line":153,"column":9,"nodeType":"VariableDeclarator","endLine":206,"endColumn":4,"suggestions":[{"desc":"Wrap the definition of 'loadEmployeesOnly' in its own useCallback() Hook.","fix":{"range":[5612,7962],"text":"useCallback(async () => {\r\n    try {\r\n      setLoading(true);\r\n      console.log('üöÄ Iniciando carga de empleados...');\r\n      \r\n      // Cargar empresas - misma fuente que EmployeeSelector\r\n      const companyData = await organizedDatabaseService.getCompanies();\r\n      setCompanies(companyData);\r\n      \r\n      // Obtener empleados de la empresa con filtros - misma fuente que EmployeeSelector\r\n      let employeesData = [];\r\n      if (companyId) {\r\n        employeesData = await organizedDatabaseService.getEmployees({ companyId });\r\n      } else {\r\n        // Aplicar filtros directamente en el servicio (ahora soporta todos los filtros)\r\n        employeesData = await organizedDatabaseService.getEmployees(filters);\r\n      }\r\n\r\n      console.log(`üìä Cargados ${employeesData.length} empleados (${Object.values(filters).filter(Boolean).length} filtros aplicados)`);\r\n      // Normalizar para asegurar compatibilidad: employee.company disponible aunque venga como 'companies' en la relaci√≥n\r\n      const normalizedEmployees = (employeesData || []).map(e => ({\r\n        ...e,\r\n        company: e.companies || e.company || null, // Priorizar companies como en EmployeeSelector\r\n        // Campos adicionales para compatibilidad con vista de carpetas\r\n        employeeName: e.first_name && e.last_name ? `${e.first_name} ${e.last_name}` : e.first_name || e.last_name || 'Sin nombre',\r\n        employeeEmail: e.email,\r\n        employeeDepartment: e.department,\r\n        employeePosition: e.position,\r\n        employeePhone: e.phone,\r\n        employeeLevel: e.level,\r\n        employeeWorkMode: e.work_mode,\r\n        employeeContractType: e.contract_type,\r\n        companyName: e.companies?.name || e.company?.name || ''\r\n      }));\r\n      setEmployees(normalizedEmployees);\r\n      setTotalItems(normalizedEmployees.filter(emp => emp.email).length);\r\n\r\n      // Extraer valores √∫nicos para los filtros\r\n      extractUniqueFilters(employeesData);\r\n      \r\n    } catch (error) {\r\n      console.error('‚ùå Error cargando empleados:', error);\r\n      MySwal.fire({\r\n        title: 'Error',\r\n        text: 'Hubo un problema al cargar los empleados',\r\n        icon: 'error',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n      console.log('üèÅ Carga de empleados completada');\r\n    }\r\n  })"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'filteredEmployeesForCount' is assigned a value but never used.","line":918,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":918,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useParams } from 'react-router-dom';\r\nimport {\r\n  FolderIcon,\r\n  UserIcon,\r\n  DocumentIcon,\r\n  MagnifyingGlassIcon,\r\n  CloudArrowUpIcon,\r\n  FunnelIcon,\r\n  CheckCircleIcon,\r\n  ChevronLeftIcon,\r\n  ChevronRightIcon\r\n} from '@heroicons/react/24/outline';\r\nimport unifiedEmployeeFolderService from '../../services/unifiedEmployeeFolderService.js';\r\nimport googleDriveSyncService from '../../services/googleDriveSyncService.js';\r\nimport googleDriveTokenBridge from '../../lib/googleDriveTokenBridge.js';\r\nimport organizedDatabaseService from '../../services/organizedDatabaseService.js';\r\nimport { supabase } from '../../lib/supabaseClient.js';\r\nimport { useAuth } from '../../contexts/AuthContext.js';\r\nimport Swal from 'sweetalert2';\r\nimport withReactContent from 'sweetalert2-react-content';\r\nimport '../../styles/responsive-tables.css';\r\n\r\nconst MySwal = withReactContent(Swal);\r\n\r\nconst EmployeeFolders = () => {\r\n  const { companyId } = useParams();\r\n  const { user } = useAuth();\r\n  const [employees, setEmployees] = useState([]);\r\n  const [folders, setFolders] = useState([]);\r\n  \r\n  const [allFoldersNormalized, setAllFoldersNormalized] = useState([]);const [loading, setLoading] = useState(true);\r\n  const [loadingFolders, setLoadingFolders] = useState(false);\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [selectedFolder, setSelectedFolder] = useState(null);\r\n  const [showFilters, setShowFilters] = useState(false);\r\n  const [filters, setFilters] = useState({\r\n    companyId: '',\r\n    department: '',\r\n    level: '',\r\n    workMode: '',\r\n    contractType: ''\r\n  });\r\n  const [selectedFolders, setSelectedFolders] = useState(new Set());\r\n  const [companies, setCompanies] = useState([]);\r\n  const [uniqueDepartments, setUniqueDepartments] = useState([]);\r\n  const [uniqueLevels, setUniqueLevels] = useState([]);\r\n  const [uniqueWorkModes, setUniqueWorkModes] = useState([]);\r\n  const [uniqueContractTypes, setUniqueContractTypes] = useState([]);\r\n  const [currentPage, setCurrentPage] = useState(1);\r\n  const [itemsPerPage] = useState(10);\r\n  const [totalItems, setTotalItems] = useState(0);\r\n// √çndice global email -> company_id para resolver empresa real del empleado\r\nconst [employeeCompanyIndex, setEmployeeCompanyIndex] = useState(new Map());\r\n\r\n// Construir el √≠ndice una sola vez al montar\r\nuseEffect(() => {\r\n  let cancelled = false;\r\n\r\n  const buildEmployeeCompanyIndex = async () => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('employees')\r\n        .select('email, company_id');\r\n\r\n      if (error) {\r\n        console.error('‚ùå Error construyendo √≠ndice empleados->empresa:', error);\r\n        return;\r\n      }\r\n\r\n      const map = new Map();\r\n      (data || []).forEach((e) => {\r\n        const key = String(e.email || '').trim().toLowerCase();\r\n        if (key) map.set(key, e.company_id);\r\n      });\r\n\r\n      if (!cancelled) setEmployeeCompanyIndex(map);\r\n    } catch (err) {\r\n      console.error('‚ùå Error inesperado construyendo √≠ndice empleados->empresa:', err);\r\n    }\r\n  };\r\n\r\n  buildEmployeeCompanyIndex();\r\n  return () => {\r\n    cancelled = true;\r\n  };\r\n}, []);\r\n\r\n  // Inicializar token bridge cuando el usuario est√° autenticado\r\n  useEffect(() => {\r\n    if (user?.id) {\r\n      googleDriveTokenBridge.initializeForUser(user.id);\r\n    }\r\n    \r\n    return () => {\r\n      // Limpiar cuando el componente se desmonta\r\n      googleDriveTokenBridge.cleanup();\r\n    };\r\n  }, [user?.id]);\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\nuseEffect(() => {\r\n    loadEmployeesOnly();\r\n  }, [companyId, filters, loadEmployeesOnly]);\r\n\r\n  // Alinear filtro de empresa con el par√°metro de ruta para evitar desajustes\r\n  useEffect(() => {\r\n    if (companyId && filters.companyId !== companyId) {\r\n      setFilters(prev => ({ ...prev, companyId }));\r\n    }\r\n  }, [companyId]);\r\n\r\n  // √öNICO efecto para cargar carpetas - consolidado para evitar duplicaciones\r\n  useEffect(() => {\r\n    if (!loading && employees.length > 0) {\r\n      console.log('üîÑ Cargando carpetas - trigger:', {\r\n        currentPage,\r\n        searchTerm: searchTerm || 'empty',\r\n        hasFilters: Object.values(filters).some(Boolean),\r\n        employeesCount: employees.length,\r\n        companiesCount: companies.length\r\n      });\r\n      loadFoldersForCurrentPage();\r\n    }\r\n  }, [currentPage, searchTerm, filters, loading, companies.length, employees.length]);\r\n\r\n  // Actualizar totalItems cuando cambian los filtros o la b√∫squeda (sin limpiar carpetas)\r\n  useEffect(() => {\r\n    const filteredEmployees = employees.filter(employee => {\r\n      if (!employee?.email) return false;\r\n\r\n      const companyName = (employee.company && employee.company.name) || (employee.companies && employee.companies.name) || '';\r\n      const term = (searchTerm || '').toLowerCase();\r\n\r\n      const matchesSearch =\r\n        !term ||\r\n        (employee.name && employee.name.toLowerCase().includes(term)) ||\r\n        (employee.email && employee.email.toLowerCase().includes(term)) ||\r\n        (companyName && companyName.toLowerCase().includes(term)) ||\r\n        (employee.department && employee.department.toLowerCase().includes(term));\r\n\r\n      return matchesSearch;\r\n    });\r\n\r\n    setTotalItems(filteredEmployees.length);\r\n    // Solo resetear p√°gina si los filtros realmente cambiaron\r\n    if (currentPage !== 1) {\r\n      setCurrentPage(1);\r\n    }\r\n  }, [searchTerm, filters, employees.length]);\r\n\r\n  const loadEmployeesOnly = async () => {\r\n    try {\r\n      setLoading(true);\r\n      console.log('üöÄ Iniciando carga de empleados...');\r\n      \r\n      // Cargar empresas - misma fuente que EmployeeSelector\r\n      const companyData = await organizedDatabaseService.getCompanies();\r\n      setCompanies(companyData);\r\n      \r\n      // Obtener empleados de la empresa con filtros - misma fuente que EmployeeSelector\r\n      let employeesData = [];\r\n      if (companyId) {\r\n        employeesData = await organizedDatabaseService.getEmployees({ companyId });\r\n      } else {\r\n        // Aplicar filtros directamente en el servicio (ahora soporta todos los filtros)\r\n        employeesData = await organizedDatabaseService.getEmployees(filters);\r\n      }\r\n\r\n      console.log(`üìä Cargados ${employeesData.length} empleados (${Object.values(filters).filter(Boolean).length} filtros aplicados)`);\r\n      // Normalizar para asegurar compatibilidad: employee.company disponible aunque venga como 'companies' en la relaci√≥n\r\n      const normalizedEmployees = (employeesData || []).map(e => ({\r\n        ...e,\r\n        company: e.companies || e.company || null, // Priorizar companies como en EmployeeSelector\r\n        // Campos adicionales para compatibilidad con vista de carpetas\r\n        employeeName: e.first_name && e.last_name ? `${e.first_name} ${e.last_name}` : e.first_name || e.last_name || 'Sin nombre',\r\n        employeeEmail: e.email,\r\n        employeeDepartment: e.department,\r\n        employeePosition: e.position,\r\n        employeePhone: e.phone,\r\n        employeeLevel: e.level,\r\n        employeeWorkMode: e.work_mode,\r\n        employeeContractType: e.contract_type,\r\n        companyName: e.companies?.name || e.company?.name || ''\r\n      }));\r\n      setEmployees(normalizedEmployees);\r\n      setTotalItems(normalizedEmployees.filter(emp => emp.email).length);\r\n\r\n      // Extraer valores √∫nicos para los filtros\r\n      extractUniqueFilters(employeesData);\r\n      \r\n    } catch (error) {\r\n      console.error('‚ùå Error cargando empleados:', error);\r\n      MySwal.fire({\r\n        title: 'Error',\r\n        text: 'Hubo un problema al cargar los empleados',\r\n        icon: 'error',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n      console.log('üèÅ Carga de empleados completada');\r\n    }\r\n  };\r\n\r\n  const loadFoldersForCurrentPage = async () => {\r\n    // Prevenir m√∫ltiples cargas simult√°neas\r\n    if (loadingFolders) {\r\n      console.log('‚è≥ Ya se est√°n cargando carpetas, ignorando solicitud duplicada...');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setLoadingFolders(true);\r\n      console.log(`üìÅ Cargando carpetas reales desde la base de datos...`);\r\n      \r\n      // SOLUCI√ìN: Cargar carpetas sin relaciones de foreign key (que fallan)\r\n      let realFolders = [];\r\n      try {\r\n        console.log('üìÅ Cargando carpetas desde la base de datos (sin relaciones)...');\r\n        \r\n        // Consulta simple sin relaciones de foreign key\r\n        const { data: employeeFolders, error } = await supabase\r\n          .from('employee_folders')\r\n          .select('*')\r\n          .order('created_at', { ascending: false });\r\n\r\n        if (!error && employeeFolders) {\r\n          console.log(`‚úÖ Encontradas ${employeeFolders.length} carpetas reales en la base de datos`);\r\n          console.log('üìä Muestra de carpetas:', employeeFolders.slice(0, 3).map(f => ({\r\n            email: f.employee_email,\r\n            name: f.employee_name,\r\n            company: f.company_name\r\n          })));\r\n          \r\n          // Cargar documentos y FAQs por separado\r\n          const [documentsResult, faqsResult] = await Promise.all([\r\n            supabase.from('employee_documents').select('*'),\r\n            supabase.from('employee_faqs').select('*')\r\n          ]);\r\n          \r\n          const documents = documentsResult.data || [];\r\n          const faqs = faqsResult.data || [];\r\n          \r\n          console.log(`üìÑ Documentos cargados: ${documents.length}`);\r\n          console.log(`‚ùì FAQs cargados: ${faqs.length}`);\r\n          \r\n          // Combinar datos en el frontend\r\n          realFolders = employeeFolders.map(folder => {\r\n            const folderDocuments = documents.filter(doc => doc.employee_folder_id === folder.id);\r\n            const folderFaqs = faqs.filter(faq => faq.employee_folder_id === folder.id);\r\n            \r\n            return {\r\n              ...folder,\r\n              employee_documents: folderDocuments,\r\n              employee_faqs: folderFaqs\r\n            };\r\n          });\r\n          \r\n        } else if (error) {\r\n          console.warn('‚ö†Ô∏è Error cargando carpetas:', error.message);\r\n          realFolders = [];\r\n        }\r\n      } catch (dbError) {\r\n        console.warn('‚ö†Ô∏è Error consultando carpetas:', dbError.message);\r\n        realFolders = [];\r\n      }\r\n\r\n      // Si no hay carpetas reales, generar carpetas virtuales desde los empleados\r\n      let foldersToShow = [];\r\n      if (realFolders.length > 0) {\r\n        // Usar carpetas reales y enriquecerlas con datos de empleados\r\n        foldersToShow = realFolders.map(folder => {\r\n          const employee = employees.find(emp => emp.email === folder.employee_email);\r\n          \r\n          // Construir knowledgeBase 100% real desde las relaciones de la base de datos\r\n          const knowledgeBase = {\r\n            faqs: (folder.employee_faqs || [])\r\n              .filter(faq => faq.status === 'active')\r\n              .map(faq => ({\r\n                id: faq.id,\r\n                question: faq.question,\r\n                answer: faq.answer,\r\n                category: faq.category,\r\n                type: 'faq'\r\n              })),\r\n            documents: (folder.employee_documents || [])\r\n              .filter(doc => doc.status === 'active')\r\n              .map(doc => ({\r\n                id: doc.id,\r\n                name: doc.document_name,\r\n                description: doc.description,\r\n                type: doc.document_type,\r\n                fileType: doc.document_type,\r\n                category: doc.document_type\r\n              })),\r\n            policies: (folder.employee_documents || [])\r\n              .filter(doc => doc.status === 'active' && doc.document_type === 'policy')\r\n              .map(doc => ({\r\n                id: doc.id,\r\n                name: doc.document_name,\r\n                description: doc.description,\r\n                type: 'policy'\r\n              })),\r\n            procedures: (folder.employee_documents || [])\r\n              .filter(doc => doc.status === 'active' && doc.document_type === 'procedure')\r\n              .map(doc => ({\r\n                id: doc.id,\r\n                name: doc.document_name,\r\n                description: doc.description,\r\n                type: 'procedure'\r\n              }))\r\n          };\r\n          \r\n          console.log(`üìä Carpeta ${folder.employee_email}:`, {\r\n            faqs: knowledgeBase.faqs.length,\r\n            documents: knowledgeBase.documents.length,\r\n            policies: knowledgeBase.policies.length,\r\n            procedures: knowledgeBase.procedures.length\r\n          });\r\n          \r\n          return {\r\n            id: folder.id,\r\n            email: folder.employee_email,\r\n            employeeEmail: folder.employee_email,\r\n            employeeName: folder.employee_name || employee?.employeeName || 'Sin nombre',\r\n            companyName: folder.company_name || employee?.companyName || 'Sin empresa',\r\n            companyIdResolved: folder.company_id || employee?.company_id,\r\n            employeeDepartment: folder.employee_department || employee?.employeeDepartment,\r\n            employeePosition: folder.employee_position || employee?.employeePosition,\r\n            employeePhone: folder.employee_phone || employee?.employeePhone,\r\n            employeeLevel: folder.employee_level || employee?.employeeLevel,\r\n            employeeWorkMode: folder.employee_work_mode || employee?.employeeWorkMode,\r\n            employeeContractType: folder.employee_contract_type || employee?.employeeContractType,\r\n            lastUpdated: folder.updated_at || new Date().toISOString(),\r\n            driveFolderId: folder.drive_folder_id,\r\n            driveFolderUrl: folder.drive_folder_url,\r\n            // Usar datos reales de la base de datos\r\n            knowledgeBase: knowledgeBase\r\n          };\r\n        });\r\n      } else {\r\n        // Si no hay carpetas reales, no mostrar carpetas virtuales\r\n        console.log(`üìÇ No hay carpetas reales en la base de datos para mostrar`);\r\n        foldersToShow = [];\r\n      }\r\n\r\n      console.log(`‚úÖ Total de carpetas a mostrar: ${foldersToShow.length}`);\r\n\r\n      // Si no hay filtros, mostrar todas las carpetas\r\n      if (!searchTerm && !Object.values(filters).some(Boolean)) {\r\n        setFolders(foldersToShow);\r\n        setTotalItems(foldersToShow.length);\r\n        return;\r\n      }\r\n\r\n      // Aplicar filtros a las carpetas\r\n      let filteredFolders = foldersToShow || [];\r\n\r\n      const term = (searchTerm || '').toLowerCase();\r\n      if (term) {\r\n        filteredFolders = filteredFolders.filter(folder =>\r\n          (folder.employeeName || '').toLowerCase().includes(term) ||\r\n          (folder.employeeEmail || '').toLowerCase().includes(term) ||\r\n          (folder.companyName || '').toLowerCase().includes(term) ||\r\n          (folder.employeePosition || '').toLowerCase().includes(term)\r\n        );\r\n      }\r\n\r\n      if (filters.companyId) {\r\n        // Usar company_id directamente como en EmployeeSelector\r\n        filteredFolders = filteredFolders.filter(\r\n          (folder) => folder.companyIdResolved === filters.companyId\r\n        );\r\n      }\r\n\r\n      if (filters.department) {\r\n        filteredFolders = filteredFolders.filter(folder => (folder.employeeDepartment || '') === filters.department);\r\n      }\r\n\r\n      if (filters.level) {\r\n        filteredFolders = filteredFolders.filter(folder => (folder.employeeLevel || '') === filters.level);\r\n      }\r\n\r\n      if (filters.workMode) {\r\n        filteredFolders = filteredFolders.filter(folder => (folder.employeeWorkMode || '') === filters.workMode);\r\n      }\r\n\r\n      if (filters.contractType) {\r\n        filteredFolders = filteredFolders.filter(folder => (folder.employeeContractType || '') === filters.contractType);\r\n      }\r\n\r\n      console.log(`üìä ${filteredFolders.length} carpetas despu√©s de aplicar filtros`);\r\n      console.log('üè¢ Empresas disponibles (desde companies):', (companies || []).map(c => [c.id, c.name]));\r\n      console.log('üß≠ Filtro de empresa aplicado:', filters.companyId);\r\n      \r\n      setFolders(filteredFolders);\r\n      setTotalItems(filteredFolders.length);\r\n      \r\n    } catch (error) {\r\n      console.error('‚ùå Error cargando carpetas:', error);\r\n      MySwal.fire({\r\n        title: 'Error',\r\n        text: 'Hubo un problema al cargar las carpetas desde la base de datos',\r\n        icon: 'error',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    } finally {\r\n      setLoadingFolders(false);\r\n      console.log('üèÅ Carga de carpetas completada');\r\n    }\r\n  };\r\n\r\n  // Funci√≥n de compatibilidad para mantener el c√≥digo existente\r\n  const loadEmployeesAndFolders = loadEmployeesOnly;\r\n\r\n  const extractUniqueFilters = (employeesData) => {\r\n    const departments = [...new Set(employeesData.map(emp => emp.department))];\r\n    const levels = [...new Set(employeesData.map(emp => emp.level))];\r\n    const workModes = [...new Set(employeesData.map(emp => emp.work_mode))];\r\n    const contractTypes = [...new Set(employeesData.map(emp => emp.contract_type))];\r\n    \r\n    setUniqueDepartments(departments.sort());\r\n    setUniqueLevels(levels.sort());\r\n    setUniqueWorkModes(workModes.sort());\r\n    setUniqueContractTypes(contractTypes.sort());\r\n  };\r\n\r\n  const handleFilterChange = (filterName, value) => {\r\n    setFilters(prev => ({\r\n      ...prev,\r\n      [filterName]: value\r\n    }));\r\n  };\r\n\r\n\r\n  const handleSearch = (term) => {\r\n    setSearchTerm(term);\r\n  };\r\n\r\n  const getFilteredFolders = () => {\r\n    // Las carpetas ya vienen filtradas por b√∫squeda y filtros activos\r\n    // Agregar deduplicaci√≥n por email como √∫ltima capa de seguridad\r\n    const uniqueFolders = [];\r\n    const seenEmails = new Set();\r\n    \r\n    folders.forEach(folder => {\r\n      const email = folder.email || folder.employeeEmail;\r\n      if (email && !seenEmails.has(email)) {\r\n        seenEmails.add(email);\r\n        uniqueFolders.push(folder);\r\n      } else if (email && seenEmails.has(email)) {\r\n        console.warn('‚ö†Ô∏è Carpeta duplicada detectada y eliminada:', email);\r\n      }\r\n    });\r\n    \r\n    return uniqueFolders;\r\n  };\r\n\r\n  const getPaginatedFolders = () => {\r\n    const all = getFilteredFolders();\r\n    const start = (currentPage - 1) * itemsPerPage;\r\n    const end = start + itemsPerPage;\r\n    return all.slice(start, end);\r\n  };\r\n\r\n  const getTotalPages = () => {\r\n    return Math.ceil(getFilteredFolders().length / itemsPerPage || 1);\r\n  };\r\n\r\n  const handlePageChange = (page) => {\r\n    if (page !== currentPage) {\r\n      console.log(`üìÑ Cambiando a p√°gina ${page}`);\r\n      setCurrentPage(page);\r\n      // No limpiar carpetas, el useEffect se encargar√° de cargar los datos correctos\r\n    }\r\n  };\r\n\r\n  const handleSelectFolder = (employeeEmail) => {\r\n    const newSelected = new Set(selectedFolders);\r\n    if (newSelected.has(employeeEmail)) {\r\n      newSelected.delete(employeeEmail);\r\n    } else {\r\n      newSelected.add(employeeEmail);\r\n    }\r\n    setSelectedFolders(newSelected);\r\n  };\r\n\r\n  const handleSelectAll = () => {\r\n    if (selectedFolders.size === getFilteredFolders().length) {\r\n      // Deseleccionar todos\r\n      setSelectedFolders(new Set());\r\n    } else {\r\n      // Seleccionar todos los filtrados\r\n      const allEmails = new Set(getFilteredFolders().map(folder => folder.email));\r\n      setSelectedFolders(allEmails);\r\n    }\r\n  };\r\n\r\n\r\n  const handleFileUpload = async (employeeEmails, files) => {\r\n    try {\r\n      const totalFiles = files.length;\r\n      const totalFolders = employeeEmails.length;\r\n      let uploadedCount = 0;\r\n      \r\n      // Funci√≥n auxiliar para leer archivo de forma segura\r\n      const readFileContent = (file) => {\r\n        return new Promise((resolve, reject) => {\r\n          const reader = new FileReader();\r\n          reader.onload = (e) => resolve(e.target.result);\r\n          reader.onerror = (e) => reject(new Error('Error leyendo el archivo'));\r\n          reader.readAsText(file);\r\n        });\r\n      };\r\n      \r\n      // Procesar cada archivo para cada empleado\r\n      for (const employeeEmail of employeeEmails) {\r\n        for (const file of files) {\r\n          try {\r\n            const content = await readFileContent(file);\r\n            \r\n            // Crear un documento con el contenido del archivo\r\n            // Simular adici√≥n de documento (sin depender de servicio externo)\r\n            console.log(`üìÑ Simulando adici√≥n de documento para ${employeeEmail}:`, {\r\n              name: file.name,\r\n              description: `Archivo subido: ${file.name}`,\r\n              content: content,\r\n              fileType: file.type,\r\n              fileSize: file.size\r\n            });\r\n            \r\n            uploadedCount++;\r\n            \r\n          } catch (fileError) {\r\n            console.error(`Error procesando archivo ${file.name} para ${employeeEmail}:`, fileError);\r\n            // Continuar con el siguiente archivo en caso de error\r\n          }\r\n        }\r\n      }\r\n      \r\n      // Recargar los datos despu√©s de procesar todos los archivos\r\n      await loadEmployeesAndFolders();\r\n      \r\n      MySwal.fire({\r\n        title: '¬°√âxito!',\r\n        text: `${uploadedCount} de ${totalFiles * totalFolders} archivo(s) subido(s) correctamente a ${totalFolders} carpeta(s)`,\r\n        icon: uploadedCount > 0 ? 'success' : 'warning',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n      \r\n    } catch (error) {\r\n      console.error('Error subiendo archivos:', error);\r\n      MySwal.fire({\r\n        title: 'Error',\r\n        text: 'Hubo un problema al subir los archivos',\r\n        icon: 'error',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    }\r\n  };\r\n\r\n  const handleBulkFileUpload = (files) => {\r\n    if (selectedFolders.size === 0) {\r\n      MySwal.fire({\r\n        title: 'Advertencia',\r\n        text: 'Por favor, seleccione al menos una carpeta para subir archivos',\r\n        icon: 'warning',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#fcb900'\r\n      });\r\n      return;\r\n    }\r\n    \r\n    handleFileUpload(Array.from(selectedFolders), files);\r\n  };\r\n\r\n  const handleDragOver = (e) => {\r\n    e.preventDefault();\r\n  };\r\n\r\n  const handleDrop = (e, employeeEmail) => {\r\n    e.preventDefault();\r\n    const files = e.dataTransfer.files;\r\n    if (files.length > 0) {\r\n      // Subir a una sola carpeta\r\n      handleFileUpload([employeeEmail], files);\r\n    }\r\n  };\r\n\r\n  const handleBulkDrop = (e) => {\r\n    e.preventDefault();\r\n    const files = e.dataTransfer.files;\r\n    if (files.length > 0) {\r\n      handleBulkFileUpload(files);\r\n    }\r\n  };\r\n\r\n  const handleFileInputChange = (e, employeeEmail = null) => {\r\n    const files = e.target.files;\r\n    if (files.length > 0) {\r\n      if (employeeEmail) {\r\n        // Subir a una sola carpeta\r\n        handleFileUpload([employeeEmail], files);\r\n      } else {\r\n        // Subir a m√∫ltiples carpetas seleccionadas\r\n        handleBulkFileUpload(files);\r\n      }\r\n    }\r\n  };\r\n\r\n  const handleViewFolder = async (employeeEmail) => {\r\n    try {\r\n      // Buscar carpeta real en la base de datos\r\n      const { data: folder, error } = await supabase\r\n        .from('employee_folders')\r\n        .select('*')\r\n        .eq('employee_email', employeeEmail)\r\n        .maybeSingle();\r\n\r\n      if (error || !folder) {\r\n        // Si no existe, crearla\r\n        console.log(`üìÅ Creando carpeta para ${employeeEmail}...`);\r\n        const employee = employees.find(emp => emp.email === employeeEmail);\r\n        if (employee) {\r\n          const result = await unifiedEmployeeFolderService.createEmployeeFolder(employeeEmail, employee);\r\n          setSelectedFolder(result.folder);\r\n        }\r\n      } else {\r\n        setSelectedFolder(folder);\r\n      }\r\n      \r\n      // Limpiar selecci√≥n cuando se abre una carpeta individual\r\n      setSelectedFolders(new Set());\r\n    } catch (error) {\r\n      console.error('Error cargando carpeta:', error);\r\n      MySwal.fire({\r\n        title: 'Error',\r\n        text: 'Hubo un problema al cargar la carpeta del empleado',\r\n        icon: 'error',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    }\r\n  };\r\n\r\n  // Funci√≥n para crear todas las carpetas de empleados\r\n  const createAllEmployeeFolders = async () => {\r\n    try {\r\n      setLoadingFolders(true);\r\n      MySwal.fire({\r\n        title: 'Creando carpetas...',\r\n        text: 'Por favor espera mientras se crean las carpetas para todos los empleados',\r\n        icon: 'info',\r\n        showConfirmButton: false,\r\n        allowOutsideClick: false\r\n      });\r\n\r\n      // UNIFICADO: Usar solo googleDriveSyncService para evitar duplicaciones\r\n      console.log('üîÑ Usando googleDriveSyncService unificado para evitar duplicaciones...');\r\n      let createdCount = 0;\r\n      let updatedCount = 0;\r\n      let errorCount = 0;\r\n      const errors = [];\r\n\r\n      for (const employee of employees) {\r\n        try {\r\n          if (!employee.email) {\r\n            console.warn(`‚ö†Ô∏è Empleado sin email: ${employee.name}`);\r\n            continue;\r\n          }\r\n\r\n          console.log(`üìÅ Procesando empleado: ${employee.email}`);\r\n          const result = await googleDriveSyncService.createEmployeeFolderInDrive(\r\n            employee.email,\r\n            employee.employeeName || employee.first_name || 'Sin nombre',\r\n            employee.companyName || 'Sin empresa',\r\n            employee\r\n          );\r\n\r\n          if (result) {\r\n            if (result.syncStatus === 'created_in_both') {\r\n              createdCount++;\r\n            } else if (result.syncStatus === 'already_exists' ||\r\n                      result.syncStatus === 'updated_drive_id' ||\r\n                      result.syncStatus === 'existed_in_drive_created_in_supabase') {\r\n              updatedCount++;\r\n            }\r\n            console.log(`‚úÖ Procesado ${employee.email}: ${result.syncStatus}`);\r\n          }\r\n\r\n          // Log de progreso cada 10 empleados\r\n          if ((createdCount + updatedCount) % 10 === 0) {\r\n            console.log(`üìä Progreso: ${createdCount + updatedCount} carpetas procesadas...`);\r\n          }\r\n\r\n        } catch (error) {\r\n          errorCount++;\r\n          errors.push(`${employee.email}: ${error.message}`);\r\n          console.error(`‚ùå Error procesando ${employee.email}:`, error);\r\n        }\r\n      }\r\n\r\n      const result = { createdCount, updatedCount, errorCount, sampleErrors: errors.slice(0, 10) };\r\n      \r\n      MySwal.fire({\r\n        title: '¬°Proceso completado!',\r\n        html: `\r\n          <div class=\"text-left\">\r\n            <p><strong>Carpetas creadas:</strong> ${result.createdCount}</p>\r\n            <p><strong>Carpetas actualizadas:</strong> ${result.updatedCount}</p>\r\n            <p><strong>Errores:</strong> ${result.errorCount}</p>\r\n          </div>\r\n        `,\r\n        icon: result.errorCount === 0 ? 'success' : 'warning',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n\r\n      // Recargar carpetas\r\n      if (result && result.errorCount > 0) {\r\n        const errors = (result.sampleErrors || []).slice(0, 10);\r\n        const errorsHtml = errors.length\r\n          ? `<ul class=\"list-disc pl-5 text-left\">${errors.map(e => `<li class=\"mb-1 text-sm text-red-700\">${e}</li>`).join('')}</ul>`\r\n          : '<p class=\"text-gray-600\">No hay detalles adicionales de error</p>';\r\n        const schemaNote = result.schemaSuspect\r\n          ? `<div class=\"mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded\">\r\n               <p class=\"text-yellow-800 text-sm\">\r\n                 Se sospecha un problema de esquema en la base de datos. Verifica que las tablas est√©n creadas en Supabase ejecutando el SQL:\r\n                 <code class=\"bg-yellow-100 px-1 py-0.5 rounded\">database/employee_folders_setup.sql</code>\r\n               </p>\r\n             </div>`\r\n          : '';\r\n        await MySwal.fire({\r\n          title: 'Se detectaron errores durante la sincronizaci√≥n',\r\n          html: `\r\n            <div class=\"text-left\">\r\n              <p class=\"mb-2\"><strong>Errores:</strong> ${result.errorCount}</p>\r\n              <p class=\"mb-2\"><strong>Creadas:</strong> ${result.createdCount} ¬†¬† <strong>Actualizadas:</strong> ${result.updatedCount}</p>\r\n              <div class=\"mt-2\">\r\n                <p class=\"mb-1 font-semibold\">Muestras de error:</p>\r\n                ${errorsHtml}\r\n              </div>\r\n              ${schemaNote}\r\n            </div>\r\n          `,\r\n          icon: 'warning',\r\n          confirmButtonText: 'Entendido',\r\n          confirmButtonColor: '#0693e3',\r\n          width: '800px'\r\n        });\r\n      }\r\n      await loadFoldersForCurrentPage();\r\n    } catch (error) {\r\n      console.error('Error creando carpetas:', error);\r\n      MySwal.fire({\r\n        title: 'Error',\r\n        text: 'Hubo un problema al crear las carpetas',\r\n        icon: 'error',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    } finally {\r\n      setLoadingFolders(false);\r\n    }\r\n  };\r\n\r\n  // Sincronizar manualmente con Google Drive (crea/actualiza carpetas)\r\n  const handleSyncWithDrive = async () => {\r\n    try {\r\n      setLoadingFolders(true);\r\n      MySwal.fire({\r\n        title: 'Sincronizando con Drive...',\r\n        text: 'Creando y actualizando carpetas para los empleados en Google Drive y Supabase',\r\n        icon: 'info',\r\n        allowOutsideClick: false,\r\n        showConfirmButton: false,\r\n        didOpen: () => {\r\n          MySwal.showLoading();\r\n        }\r\n      });\r\n        \r\n       // Verificar que Google Drive est√© autenticado ANTES de intentar sincronizar\r\n       if (!googleDriveSyncService.isAuthenticated()) {\r\n         MySwal.fire({\r\n           title: '‚ùå Google Drive no autenticado',\r\n           html: `\r\n             <div class=\"text-left\">\r\n               <p class=\"mb-4 text-gray-700\">\r\n                 <strong>No se puede sincronizar:</strong> Google Drive no est√° conectado.\r\n               </p>\r\n               <div class=\"bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4\">\r\n                 <p class=\"text-sm text-yellow-800 mb-2\">\r\n                   <strong>¬øQu√© necesitas hacer?</strong>\r\n                 </p>\r\n                 <ol class=\"list-decimal list-inside text-sm text-yellow-800 space-y-1\">\r\n                   <li>Ve a <strong>Integraciones</strong></li>\r\n                   <li>Haz clic en <strong>\"Conectar Google Drive\"</strong></li>\r\n                   <li>Autoriza el acceso a tu cuenta de Google</li>\r\n                   <li>Vuelve aqu√≠ e intenta sincronizar nuevamente</li>\r\n                 </ol>\r\n               </div>\r\n               <p class=\"text-xs text-gray-600\">\r\n                 Sin autenticaci√≥n, las carpetas no se pueden crear en Google Drive real.\r\n               </p>\r\n             </div>\r\n           `,\r\n           icon: 'warning',\r\n           confirmButtonText: 'Entendido',\r\n           confirmButtonColor: '#0693e3',\r\n           width: '600px'\r\n         });\r\n         setLoadingFolders(false);\r\n         return;\r\n       }\r\n\r\n\r\n      // Inicializar el servicio de sincronizaci√≥n\r\n      console.log('üîÑ Inicializando servicio de sincronizaci√≥n...');\r\n      const initResult = await googleDriveSyncService.initialize();\r\n      if (!initResult) {\r\n        throw new Error('No se pudo inicializar el servicio de sincronizaci√≥n');\r\n      }\r\n      console.log('‚úÖ Servicio de sincronizaci√≥n inicializado correctamente');\r\n\r\n      // Crear carpetas para todos los empleados en Google Drive Y Supabase simult√°neamente\r\n      let createdCount = 0;\r\n      let errorCount = 0;\r\n      const errors = [];\r\n\r\n      for (const employee of employees) {\r\n        try {\r\n          if (employee.email) {\r\n            console.log(`üìÅ Procesando empleado: ${employee.email}`);\r\n            const result = await googleDriveSyncService.createEmployeeFolderInDrive(\r\n              employee.email,\r\n              employee.employeeName || employee.first_name || 'Sin nombre',\r\n              employee.companyName || 'Sin empresa',\r\n              employee\r\n            );\r\n\r\n            if (result && result.driveFolder) {\r\n              createdCount++;\r\n              console.log(`‚úÖ Carpeta creada para ${employee.email}`);\r\n              \r\n              // Iniciar sincronizaci√≥n peri√≥dica para este empleado\r\n              googleDriveSyncService.startPeriodicSync(\r\n                employee.email,\r\n                result.driveFolder.id,\r\n                5 // cada 5 minutos\r\n              );\r\n            }\r\n          }\r\n        } catch (error) {\r\n          errorCount++;\r\n          errors.push(`${employee.email}: ${error.message}`);\r\n          console.error(`‚ùå Error creando carpeta para ${employee.email}:`, error);\r\n        }\r\n      }\r\n\r\n      MySwal.fire({\r\n        title: 'Sincronizaci√≥n completada',\r\n        html: `\r\n          <div class=\"text-left\">\r\n            <p><strong>Carpetas creadas en Google Drive y Supabase:</strong> ${createdCount}</p>\r\n            <p><strong>Sincronizaciones peri√≥dicas iniciadas:</strong> ${createdCount}</p>\r\n            <p><strong>Errores:</strong> ${errorCount}</p>\r\n          </div>\r\n        `,\r\n        icon: errorCount === 0 ? 'success' : 'warning',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n\r\n      if (errorCount > 0) {\r\n        const errorsHtml = errors.length\r\n          ? `<ul class=\"list-disc pl-5 text-left\">${errors.slice(0, 10).map(e => `<li class=\"mb-1 text-sm text-red-700\">${e}</li>`).join('')}</ul>`\r\n          : '<p class=\"text-gray-600\">No hay detalles adicionales de error</p>';\r\n        await MySwal.fire({\r\n          title: 'Se detectaron errores durante la sincronizaci√≥n',\r\n          html: `\r\n            <div class=\"text-left\">\r\n              <p class=\"mb-2\"><strong>Errores:</strong> ${errorCount}</p>\r\n              <p class=\"mb-2\"><strong>Creadas exitosamente:</strong> ${createdCount}</p>\r\n              <div class=\"mt-2\">\r\n                <p class=\"mb-1 font-semibold\">Muestras de error:</p>\r\n                ${errorsHtml}\r\n              </div>\r\n            </div>\r\n          `,\r\n          icon: 'warning',\r\n          confirmButtonText: 'Entendido',\r\n          confirmButtonColor: '#0693e3',\r\n          width: '800px'\r\n        });\r\n      }\r\n      await loadFoldersForCurrentPage();\r\n    } catch (error) {\r\n      console.error('Error sincronizando con Drive:', error);\r\n      MySwal.fire({\r\n        title: 'Error',\r\n        text: `No se pudo sincronizar con Google Drive: ${error.message || error}`,\r\n        icon: 'error',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    } finally {\r\n      setLoadingFolders(false);\r\n    }\r\n  };\r\n\r\n  // Calcular filteredEmployees para el conteo total\r\n  const filteredEmployeesForCount = employees.filter(employee => {\r\n    if (!employee?.email) return false;\r\n\r\n    const companyName = (employee.company && employee.company.name) || (employee.companies && employee.companies.name) || '';\r\n    const term = (searchTerm || '').toLowerCase();\r\n\r\n    const matchesSearch =\r\n      !term ||\r\n      (employee.name && employee.name.toLowerCase().includes(term)) ||\r\n      (employee.email && employee.email.toLowerCase().includes(term)) ||\r\n      (companyName && companyName.toLowerCase().includes(term)) ||\r\n      (employee.department && employee.department.toLowerCase().includes(term));\r\n\r\n    return matchesSearch;\r\n  });\r\n\r\n  // Calcular p√°ginas totales\r\n  const totalPages = getTotalPages();\r\n  const hasMorePages = currentPage < totalPages;\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-engage-blue mx-auto\"></div>\r\n          <p className=\"mt-4 text-gray-600\">Cargando empleados...</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-50 via-white to-indigo-50\">\r\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\r\n        {/* Header Moderno */}\r\n        <div className=\"bg-gradient-to-r from-indigo-500 via-purple-600 to-pink-600 rounded-3xl shadow-2xl p-8 mb-8 text-white relative overflow-hidden\">\r\n          <div className=\"absolute inset-0 bg-black/10\"></div>\r\n          <div className=\"relative z-10\">\r\n            <div className=\"flex items-center mb-3\">\r\n              <div className=\"bg-white/20 p-3 rounded-full mr-4\">\r\n                <FolderIcon className=\"h-8 w-8 text-white\" />\r\n              </div>\r\n              <div>\r\n                <h1 className=\"text-4xl font-bold mb-1\">\r\n                  Carpetas de Empleados\r\n                </h1>\r\n                <div className=\"h-1 w-20 bg-white/30 rounded-full\"></div>\r\n              </div>\r\n            </div>\r\n            <p className=\"text-indigo-100 text-lg font-medium\">\r\n              Gestiona la informaci√≥n y base de conocimiento de cada empleado\r\n            </p>\r\n            <div className=\"flex items-center mt-4 text-sm text-indigo-200\">\r\n              <div className=\"flex items-center mr-6\">\r\n                <div className=\"w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse\"></div>\r\n                {folders.length} carpetas activas\r\n              </div>\r\n              <div className=\"flex items-center\">\r\n                <div className=\"w-2 h-2 bg-blue-400 rounded-full mr-2\"></div>\r\n                Gesti√≥n de conocimiento\r\n              </div>\r\n            </div>\r\n          </div>\r\n          {/* Elementos decorativos */}\r\n          <div className=\"absolute -top-10 -right-10 w-32 h-32 bg-white/10 rounded-full\"></div>\r\n          <div className=\"absolute -bottom-8 -left-8 w-24 h-24 bg-white/10 rounded-full\"></div>\r\n        </div>\r\n\r\n        {/* Indicador de carga de carpetas */}\r\n        {loadingFolders && (\r\n          <div className=\"mb-6 p-4 bg-blue-50 border border-blue-200 rounded-xl\">\r\n            <div className=\"flex items-center\">\r\n              <div className=\"animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-3\"></div>\r\n              <p className=\"text-blue-800\">Cargando carpetas para la p√°gina {currentPage}...</p>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Informaci√≥n de paginaci√≥n */}\r\n        <div className=\"mb-6 p-4 bg-gray-50 rounded-xl\">\r\n          <div className=\"flex justify-between items-center\">\r\n            <p className=\"text-sm text-gray-600\">\r\n              Mostrando {Math.min((currentPage - 1) * itemsPerPage + 1, getFilteredFolders().length)} a {Math.min(currentPage * itemsPerPage, getFilteredFolders().length)} de {getFilteredFolders().length} carpetas {getFilteredFolders().length > itemsPerPage && `(p√°gina ${currentPage} de ${totalPages})`}\r\n            </p>\r\n            <div className=\"flex space-x-2\">\r\n              <button\r\n                onClick={handleSyncWithDrive}\r\n                disabled={loadingFolders}\r\n                className=\"px-3 py-1 bg-green-600 text-white rounded disabled:bg-gray-300 disabled:cursor-not-allowed hover:bg-green-700 transition-colors\"\r\n              >\r\n                {loadingFolders ? 'Sincronizando...' : 'Sincronizar con Drive'}\r\n              </button>\r\n              <button\r\n                onClick={() => handlePageChange(Math.max(1, currentPage - 1))}\r\n                disabled={currentPage === 1}\r\n                className=\"px-3 py-1 bg-blue-600 text-white rounded disabled:bg-gray-300 disabled:cursor-not-allowed hover:bg-blue-700 transition-colors\"\r\n              >\r\n                Anterior\r\n              </button>\r\n              <span className=\"px-3 py-1 bg-gray-200 rounded\">\r\n                {currentPage} / {totalPages}\r\n              </span>\r\n              <button\r\n                onClick={() => handlePageChange(currentPage + 1)}\r\n                disabled={!hasMorePages}\r\n                className=\"px-3 py-1 bg-blue-600 text-white rounded disabled:bg-gray-300 disabled:cursor-not-allowed hover:bg-blue-700 transition-colors\"\r\n              >\r\n                Siguiente\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Filtros y b√∫squeda */}\r\n        <div className=\"bg-white rounded-3xl shadow-2xl p-8 mb-8 border border-gray-100 relative overflow-hidden responsive-layout\">\r\n          <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500\"></div>\r\n          <div className=\"flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6\">\r\n            <div className=\"flex items-center mb-4 lg:mb-0\">\r\n              <div className=\"bg-gradient-to-r from-indigo-500 to-purple-600 p-3 rounded-xl mr-4\">\r\n                <FunnelIcon className=\"h-6 w-6 text-white\" />\r\n              </div>\r\n              <div>\r\n                <h2 className=\"text-2xl font-bold text-gray-900\">Filtros Avanzados</h2>\r\n                <p className=\"text-sm text-gray-600\">Encuentra r√°pidamente las carpetas que necesitas</p>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex flex-col sm:flex-row items-start sm:items-center gap-4\">\r\n              <button\r\n                onClick={() => setShowFilters(!showFilters)}\r\n                className=\"inline-flex items-center px-6 py-3 bg-gradient-to-r from-indigo-100 to-purple-100 hover:from-indigo-200 hover:to-purple-200 text-indigo-700 font-semibold rounded-xl transition-all duration-300 shadow-sm hover:shadow-md\"\r\n              >\r\n                <FunnelIcon className=\"h-5 w-5 mr-3\" />\r\n                {showFilters ? 'Ocultar Filtros' : 'Mostrar Filtros'}\r\n              </button>\r\n\r\n              <div className=\"search-container\">\r\n                <input\r\n                  type=\"text\"\r\n                  placeholder=\"Buscar por nombre, email o departamento...\"\r\n                  className=\"pl-12 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 w-full transition-all duration-300 bg-gray-50 focus:bg-white\"\r\n                  value={searchTerm}\r\n                  onChange={(e) => handleSearch(e.target.value)}\r\n                />\r\n                <MagnifyingGlassIcon className=\"h-6 w-6 text-gray-400 absolute left-3 top-3\" />\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Panel de filtros */}\r\n          {showFilters && (\r\n            <div className=\"filters-grid mt-4 pt-4 border-t border-gray-200\">\r\n              <div className=\"min-w-0\">\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Empresa</label>\r\n                <select\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engage-blue focus:border-engage-blue truncate\"\r\n                  value={filters.companyId}\r\n                  onChange={(e) => handleFilterChange('companyId', e.target.value)}\r\n                >\r\n                  <option value=\"\">Todas las empresas</option>\r\n                  {companies.map(company => (\r\n                    <option key={company.id} value={company.id}>{company.name}</option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n              \r\n              <div className=\"min-w-0\">\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Departamento</label>\r\n                <select\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engage-blue focus:border-engage-blue truncate\"\r\n                  value={filters.department}\r\n                  onChange={(e) => handleFilterChange('department', e.target.value)}\r\n                >\r\n                  <option value=\"\">Todos los departamentos</option>\r\n                  {uniqueDepartments.map(dept => (\r\n                    <option key={dept} value={dept} className=\"truncate\">{dept}</option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n              \r\n              <div className=\"min-w-0\">\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Nivel</label>\r\n                <select\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engage-blue focus:border-engage-blue truncate\"\r\n                  value={filters.level}\r\n                  onChange={(e) => handleFilterChange('level', e.target.value)}\r\n                >\r\n                  <option value=\"\">Todos los niveles</option>\r\n                  {uniqueLevels.map(level => (\r\n                    <option key={level} value={level} className=\"truncate\">{level}</option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n              \r\n              <div className=\"min-w-0\">\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Modalidad</label>\r\n                <select\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engage-blue focus:border-engage-blue truncate\"\r\n                  value={filters.workMode}\r\n                  onChange={(e) => handleFilterChange('workMode', e.target.value)}\r\n                >\r\n                  <option value=\"\">Todas las modalidades</option>\r\n                  {uniqueWorkModes.map(mode => (\r\n                    <option key={mode} value={mode} className=\"truncate\">{mode}</option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n              \r\n              <div className=\"min-w-0\">\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Tipo de Contrato</label>\r\n                <select\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engage-blue focus:border-engage-blue truncate\"\r\n                  value={filters.contractType}\r\n                  onChange={(e) => handleFilterChange('contractType', e.target.value)}\r\n                >\r\n                  <option value=\"\">Todos los contratos</option>\r\n                  {uniqueContractTypes.map(type => (\r\n                    <option key={type} value={type} className=\"truncate\">{type}</option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Botones de acci√≥n para selecci√≥n m√∫ltiple */}\r\n          {selectedFolders.size > 0 && (\r\n            <div className=\"mt-4 pt-4 border-t border-gray-200\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div className=\"text-sm text-gray-600\">\r\n                  {selectedFolders.size} carpeta(s) seleccionada(s)\r\n                </div>\r\n                <div className=\"flex items-center space-x-2\">\r\n                  <label className=\"flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg cursor-pointer hover:bg-blue-600 transition-colors\">\r\n                    <CloudArrowUpIcon className=\"h-5 w-5 mr-2\" />\r\n                    Subir Archivos\r\n                    <input\r\n                      type=\"file\"\r\n                      className=\"hidden\"\r\n                      multiple\r\n                      onChange={(e) => handleFileInputChange(e)}\r\n                    />\r\n                  </label>\r\n                  <button\r\n                    onClick={() => setSelectedFolders(new Set())}\r\n                    className=\"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors\"\r\n                  >\r\n                    Cancelar Selecci√≥n\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* √Årea de arrastrar y soltar para m√∫ltiples carpetas */}\r\n        {selectedFolders.size > 0 && (\r\n          <div \r\n            className=\"bg-blue-50 border-2 border-dashed border-blue-300 rounded-2xl p-8 mb-8 text-center cursor-pointer transition-colors hover:bg-blue-100\"\r\n            onDragOver={handleDragOver}\r\n            onDrop={handleBulkDrop}\r\n            onClick={() => document.getElementById('bulk-file-input').click()}\r\n          >\r\n            <CloudArrowUpIcon className=\"h-12 w-12 text-blue-500 mx-auto mb-4\" />\r\n            <h3 className=\"text-lg font-medium text-gray-900 mb-2\">\r\n              Arrastra archivos aqu√≠ para subir a {selectedFolders.size} carpeta(s) seleccionada(s)\r\n            </h3>\r\n            <p className=\"text-gray-600\">\r\n              Tambi√©n puedes hacer clic para seleccionar archivos\r\n            </p>\r\n            <input\r\n              id=\"bulk-file-input\"\r\n              type=\"file\"\r\n              className=\"hidden\"\r\n              multiple\r\n              onChange={(e) => handleFileInputChange(e)}\r\n            />\r\n          </div>\r\n        )}\r\n\r\n        {/* Lista de carpetas */}\r\n        <div className=\"bg-white rounded-3xl shadow-2xl border border-gray-100 overflow-hidden relative responsive-layout\">\r\n          <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500\"></div>\r\n          <div className=\"px-8 py-6 border-b border-gray-100\">\r\n            <div className=\"table-header-actions\">\r\n              <div className=\"flex items-center\">\r\n                <div className=\"bg-gradient-to-r from-indigo-500 to-purple-600 p-3 rounded-xl mr-4\">\r\n                  <FolderIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n                <div>\r\n                  <h2 className=\"text-2xl font-bold text-gray-900\">Carpetas Disponibles</h2>\r\n                  <p className=\"text-sm text-gray-600\">{getFilteredFolders().length} carpetas encontradas</p>\r\n                </div>\r\n              </div>\r\n              <div className=\"flex flex-col sm:flex-row items-start sm:items-center gap-4\">\r\n                <div className=\"flex items-center bg-indigo-50 px-4 py-2 rounded-xl\">\r\n                  <div className=\"w-2 h-2 bg-indigo-500 rounded-full mr-3\"></div>\r\n                  <span className=\"text-sm font-medium text-indigo-700\">{selectedFolders.size} de {getFilteredFolders().length} seleccionadas</span>\r\n                </div>\r\n                <button\r\n                  onClick={handleSelectAll}\r\n                  className=\"inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-all duration-300 hover:shadow-md\"\r\n                >\r\n                  <CheckCircleIcon className={`h-5 w-5 mr-2 ${selectedFolders.size === getFilteredFolders().length ? 'text-indigo-500' : 'text-gray-400'}`} />\r\n                  {selectedFolders.size === getFilteredFolders().length ? 'Deseleccionar todas' : 'Seleccionar todas'}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Indicador de scroll para m√≥viles */}\r\n          <div className=\"table-scroll-hint\">\r\n            <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 8l4 4m0 0l-4 4m4-4H3\" />\r\n            </svg>\r\n            Desliza horizontalmente para ver m√°s informaci√≥n\r\n          </div>\r\n\r\n          <div className=\"table-responsive-container scroll-horizontal\">\r\n            <div className=\"divide-y divide-gray-100\">\r\n              {getPaginatedFolders().map((folder) => (\r\n                <div\r\n                  key={folder.email}\r\n                  className={`employee-card p-8 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 transition-all duration-300 cursor-pointer transform hover:scale-[1.01] ${\r\n                    selectedFolders.has(folder.email) ? 'bg-gradient-to-r from-indigo-100 to-purple-100 border-l-4 border-indigo-500 shadow-lg' : 'hover:shadow-md'\r\n                  }`}\r\n                  onClick={() => handleSelectFolder(folder.email)}\r\n                  onDragOver={handleDragOver}\r\n                  onDrop={(e) => handleDrop(e, folder.email)}\r\n                >\r\n                  <div className=\"flex items-start\">\r\n                    <div className=\"flex items-center h-6 mr-6\">\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        checked={selectedFolders.has(folder.email)}\r\n                        onChange={() => handleSelectFolder(folder.email)}\r\n                        className=\"h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 transition-all duration-300\"\r\n                      />\r\n                    </div>\r\n\r\n                    <div className=\"flex-1 min-w-0\">\r\n                      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n                        <div className=\"flex items-center\">\r\n                          <div className=\"flex-shrink-0 h-14 w-14 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg mr-4\">\r\n                            <span className=\"text-white font-bold text-lg\">\r\n                              {((folder.employeeName || folder.email || folder.employee_email || '?').charAt(0)).toUpperCase()}\r\n                            </span>\r\n                          </div>\r\n                          <div className=\"employee-info\">\r\n                            <h3 className=\"text-xl font-bold text-gray-900 truncate max-w-xs md:max-w-md\">\r\n                              {folder.employeeName || folder.email}\r\n                            </h3>\r\n                            <p className=\"text-sm text-gray-600 truncate max-w-xs md:max-w-md flex items-center\">\r\n                              <svg className=\"w-4 h-4 mr-1 text-gray-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\" />\r\n                              </svg>\r\n                              {folder.email}\r\n                            </p>\r\n                          </div>\r\n                        </div>\r\n\r\n                        <div className=\"employee-actions action-buttons\">\r\n                          <button\r\n                            onClick={(e) => {\r\n                              e.stopPropagation();\r\n                              handleViewFolder(folder.email);\r\n                            }}\r\n                            className=\"inline-flex items-center px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-medium rounded-lg transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105\"\r\n                          >\r\n                            <DocumentIcon className=\"h-5 w-5 mr-2\" />\r\n                            Ver Carpeta\r\n                          </button>\r\n                        </div>\r\n                      </div>\r\n                      \r\n                      <div className=\"mt-6 info-card-grid\">\r\n                         <div className=\"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100\">\r\n                           <div className=\"flex items-center mb-2\">\r\n                             <div className=\"w-2 h-2 bg-blue-500 rounded-full mr-2\"></div>\r\n                             <p className=\"text-xs font-semibold text-blue-700 uppercase tracking-wide\">Empresa</p>\r\n                           </div>\r\n                           <p className=\"text-sm font-bold text-gray-900 truncate\">{folder.companyName}</p>\r\n                         </div>\r\n\r\n                         <div className=\"bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-xl border border-green-100\">\r\n                           <div className=\"flex items-center mb-2\">\r\n                             <div className=\"w-2 h-2 bg-green-500 rounded-full mr-2\"></div>\r\n                             <p className=\"text-xs font-semibold text-green-700 uppercase tracking-wide\">Departamento</p>\r\n                           </div>\r\n                           <p className=\"text-sm font-bold text-gray-900 truncate\">{folder.employeeDepartment || 'No especificado'}</p>\r\n                         </div>\r\n\r\n                         <div className=\"bg-gradient-to-r from-purple-50 to-violet-50 p-4 rounded-xl border border-purple-100\">\r\n                           <div className=\"flex items-center mb-2\">\r\n                             <div className=\"w-2 h-2 bg-purple-500 rounded-full mr-2\"></div>\r\n                             <p className=\"text-xs font-semibold text-purple-700 uppercase tracking-wide\">Cargo</p>\r\n                           </div>\r\n                           <p className=\"text-sm font-bold text-gray-900 truncate\">{folder.employeePosition || 'No especificado'}</p>\r\n                         </div>\r\n\r\n                         <div className=\"bg-gradient-to-r from-orange-50 to-red-50 p-4 rounded-xl border border-orange-100\">\r\n                           <div className=\"flex items-center mb-2\">\r\n                             <div className=\"w-2 h-2 bg-orange-500 rounded-full mr-2\"></div>\r\n                             <p className=\"text-xs font-semibold text-orange-700 uppercase tracking-wide\">Tel√©fono</p>\r\n                           </div>\r\n                           <p className=\"text-sm font-bold text-gray-900 truncate\">{folder.employeePhone || 'No especificado'}</p>\r\n                         </div>\r\n                       </div>\r\n                     \r\n                        <div className=\"mt-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\r\n                          <div className=\"badge-container\">\r\n                            <div className=\"inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-blue-100 to-blue-200 text-blue-800 border border-blue-300\">\r\n                              <svg className=\"w-3 h-3 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n                              </svg>\r\n                              FAQs: {folder.knowledgeBase?.faqs?.length || 0}\r\n                            </div>\r\n                            <div className=\"inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-green-100 to-green-200 text-green-800 border border-green-300\">\r\n                              <svg className=\"w-3 h-3 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\r\n                              </svg>\r\n                              Documentos: {folder.knowledgeBase?.documents?.length || 0}\r\n                            </div>\r\n                            <div className=\"inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-purple-100 to-purple-200 text-purple-800 border border-purple-300\">\r\n                              <svg className=\"w-3 h-3 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z\" />\r\n                              </svg>\r\n                              Pol√≠ticas: {folder.knowledgeBase?.policies?.length || 0}\r\n                            </div>\r\n                            <div className=\"inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-orange-100 to-orange-200 text-orange-800 border border-orange-300\">\r\n                              <svg className=\"w-3 h-3 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\r\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\r\n                              </svg>\r\n                              Procedimientos: {folder.knowledgeBase?.procedures?.length || 0}\r\n                            </div>\r\n                          </div>\r\n\r\n                          <div className=\"bg-gray-100 px-3 py-2 rounded-lg\">\r\n                            <div className=\"flex items-center text-xs text-gray-600\">\r\n                              <svg className=\"w-4 h-4 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n                              </svg>\r\n                              √öltima actualizaci√≥n: {new Date(folder.lastUpdated).toLocaleDateString()}\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n              \r\n              {getFilteredFolders().length === 0 && (\r\n                <div className=\"empty-state\">\r\n                  <FolderIcon className=\"h-12 w-12 text-gray-400 mx-auto mb-4\" />\r\n                  <h3 className=\"text-lg font-medium text-gray-900 mb-1\">No se encontraron carpetas</h3>\r\n                  <p className=\"text-gray-500\">\r\n                    {searchTerm || Object.values(filters).some(Boolean)\r\n                      ? 'No hay carpetas que coincidan con los filtros aplicados'\r\n                      : loading\r\n                        ? 'Cargando carpetas...'\r\n                        : employees.length === 0\r\n                          ? 'No hay empleados disponibles para generar carpetas'\r\n                          : 'No hay carpetas de empleados disponibles'}\r\n                  </p>\r\n                  {!searchTerm && !Object.values(filters).some(Boolean) && !loading && employees.length > 0 && (\r\n                    <div className=\"mt-6\">\r\n                      <button\r\n                        onClick={createAllEmployeeFolders}\r\n                        disabled={loadingFolders}\r\n                        className=\"inline-flex items-center px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                      >\r\n                        {loadingFolders ? (\r\n                          <>\r\n                            <div className=\"animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3\"></div>\r\n                            Creando carpetas...\r\n                          </>\r\n                        ) : (\r\n                          <>\r\n                            <FolderIcon className=\"h-5 w-5 mr-3\" />\r\n                            Crear Carpetas para Todos los Empleados\r\n                          </>\r\n                        )}\r\n                      </button>\r\n                    </div>\r\n                  )}\r\n                  {!loading && employees.length === 0 && (\r\n                    <div className=\"mt-6\">\r\n                      <button\r\n                        onClick={loadEmployeesOnly}\r\n                        disabled={loading}\r\n                        className=\"inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                      >\r\n                        {loading ? (\r\n                          <>\r\n                            <div className=\"animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3\"></div>\r\n                            Cargando empleados...\r\n                          </>\r\n                        ) : (\r\n                          <>\r\n                            <svg className=\"h-5 w-5 mr-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\r\n                            </svg>\r\n                            Recargar Empleados\r\n                          </>\r\n                        )}\r\n                      </button>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Controles de paginaci√≥n */}\r\n          {getTotalPages() > 1 && (\r\n            <div className=\"px-6 py-4 border-t border-gray-200 bg-gray-50\">\r\n              <div className=\"pagination-controls\">\r\n                <div className=\"pagination-info text-sm text-gray-700\">\r\n                  Mostrando {Math.min((currentPage - 1) * itemsPerPage + 1, getFilteredFolders().length)} a {Math.min(currentPage * itemsPerPage, getFilteredFolders().length)} de {getFilteredFolders().length} carpetas\r\n                </div>\r\n                <div className=\"flex items-center space-x-2\">\r\n                  <button\r\n                    onClick={() => handlePageChange(currentPage - 1)}\r\n                    disabled={currentPage === 1}\r\n                    className=\"flex items-center px-3 py-1 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                  >\r\n                    <ChevronLeftIcon className=\"h-4 w-4 mr-1\" />\r\n                    Anterior\r\n                  </button>\r\n\r\n                  <div className=\"flex items-center space-x-1\">\r\n                    {Array.from({ length: Math.min(5, getTotalPages()) }, (_, i) => {\r\n                      const pageNumber = Math.max(1, Math.min(getTotalPages() - 4, currentPage - 2)) + i;\r\n                      if (pageNumber > getTotalPages()) return null;\r\n\r\n                      return (\r\n                        <button\r\n                          key={pageNumber}\r\n                          onClick={() => handlePageChange(pageNumber)}\r\n                          className={`px-3 py-1 text-sm rounded-md ${\r\n                            currentPage === pageNumber\r\n                              ? 'bg-engage-blue text-white'\r\n                              : 'bg-white border border-gray-300 hover:bg-gray-50'\r\n                          }`}\r\n                        >\r\n                          {pageNumber}\r\n                        </button>\r\n                      );\r\n                    })}\r\n                  </div>\r\n\r\n                  <button\r\n                    onClick={() => handlePageChange(currentPage + 1)}\r\n                    disabled={currentPage === getTotalPages()}\r\n                    className=\"flex items-center px-3 py-1 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                  >\r\n                    Siguiente\r\n                    <ChevronRightIcon className=\"h-4 w-4 ml-1\" />\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Vista de carpeta individual */}\r\n        {selectedFolder && (\r\n          <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50\">\r\n            <div className=\"bg-white rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto border border-gray-100\">\r\n              {/* Header Moderno */}\r\n              <div className=\"bg-gradient-to-r from-indigo-500 via-purple-600 to-pink-600 rounded-t-3xl p-8 text-white relative overflow-hidden\">\r\n                <div className=\"absolute inset-0 bg-black/10\"></div>\r\n                <div className=\"relative z-10\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <div className=\"flex items-center\">\r\n                      <div className=\"bg-white/20 p-3 rounded-full mr-4\">\r\n                        <FolderIcon className=\"h-6 w-6 text-white\" />\r\n                      </div>\r\n                      <div>\r\n                        <h2 className=\"text-2xl font-bold\">\r\n                          Carpeta de {selectedFolder.employeeName || selectedFolder.email}\r\n                        </h2>\r\n                        <div className=\"h-1 w-20 bg-white/30 rounded-full mt-1\"></div>\r\n                      </div>\r\n                    </div>\r\n                    <button\r\n                      onClick={() => setSelectedFolder(null)}\r\n                      className=\"bg-white/20 hover:bg-white/30 p-2 rounded-xl transition-all duration-300 hover:scale-105\"\r\n                    >\r\n                      <svg className=\"h-6 w-6 text-white\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\r\n                      </svg>\r\n                    </button>\r\n                  </div>\r\n                  <div className=\"flex items-center mt-4 text-sm text-indigo-200\">\r\n                    <div className=\"flex items-center mr-6\">\r\n                      <div className=\"w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse\"></div>\r\n                      {selectedFolder.knowledgeBase?.documents?.length || 0} documentos\r\n                    </div>\r\n                    <div className=\"flex items-center\">\r\n                      <div className=\"w-2 h-2 bg-blue-400 rounded-full mr-2\"></div>\r\n                      Base de conocimiento activa\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n                {/* Elementos decorativos */}\r\n                <div className=\"absolute -top-6 -right-6 w-20 h-20 bg-white/10 rounded-full\"></div>\r\n                <div className=\"absolute -bottom-4 -left-4 w-16 h-16 bg-white/10 rounded-full\"></div>\r\n              </div>\r\n              \r\n              <div className=\"p-8\">\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8 mb-8\">\r\n                  <div className=\"bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-3xl border border-blue-100 shadow-lg\">\r\n                    <div className=\"flex items-center mb-4\">\r\n                      <div className=\"bg-gradient-to-r from-blue-500 to-indigo-600 p-3 rounded-xl mr-4\">\r\n                        <UserIcon className=\"h-6 w-6 text-white\" />\r\n                      </div>\r\n                      <div>\r\n                        <h3 className=\"text-xl font-bold text-gray-900\">Informaci√≥n del Empleado</h3>\r\n                        <div className=\"h-1 w-16 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full mt-1\"></div>\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"space-y-3\">\r\n                      <div className=\"flex items-center p-3 bg-white/60 rounded-xl border border-blue-100\">\r\n                        <div className=\"w-2 h-2 bg-blue-500 rounded-full mr-3\"></div>\r\n                        <div className=\"flex-1\">\r\n                          <p className=\"text-xs font-semibold text-blue-700 uppercase tracking-wide\">Email</p>\r\n                          <p className=\"text-sm font-medium text-gray-900\">{selectedFolder.email}</p>\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"flex items-center p-3 bg-white/60 rounded-xl border border-blue-100\">\r\n                        <div className=\"w-2 h-2 bg-green-500 rounded-full mr-3\"></div>\r\n                        <div className=\"flex-1\">\r\n                          <p className=\"text-xs font-semibold text-green-700 uppercase tracking-wide\">Nombre</p>\r\n                          <p className=\"text-sm font-medium text-gray-900\">{selectedFolder.employeeName || 'No especificado'}</p>\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"flex items-center p-3 bg-white/60 rounded-xl border border-blue-100\">\r\n                        <div className=\"w-2 h-2 bg-purple-500 rounded-full mr-3\"></div>\r\n                        <div className=\"flex-1\">\r\n                          <p className=\"text-xs font-semibold text-purple-700 uppercase tracking-wide\">Empresa</p>\r\n                          <p className=\"text-sm font-medium text-gray-900\">{selectedFolder.companyName}</p>\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"flex items-center p-3 bg-white/60 rounded-xl border border-blue-100\">\r\n                        <div className=\"w-2 h-2 bg-orange-500 rounded-full mr-3\"></div>\r\n                        <div className=\"flex-1\">\r\n                          <p className=\"text-xs font-semibold text-orange-700 uppercase tracking-wide\">Departamento</p>\r\n                          <p className=\"text-sm font-medium text-gray-900\">{selectedFolder.employeeDepartment || 'No especificado'}</p>\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"flex items-center p-3 bg-white/60 rounded-xl border border-blue-100\">\r\n                        <div className=\"w-2 h-2 bg-pink-500 rounded-full mr-3\"></div>\r\n                        <div className=\"flex-1\">\r\n                          <p className=\"text-xs font-semibold text-pink-700 uppercase tracking-wide\">Cargo</p>\r\n                          <p className=\"text-sm font-medium text-gray-900\">{selectedFolder.employeePosition || 'No especificado'}</p>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div className=\"bg-gradient-to-br from-emerald-50 to-teal-50 p-6 rounded-3xl border border-emerald-100 shadow-lg\">\r\n                    <div className=\"flex items-center mb-4\">\r\n                      <div className=\"bg-gradient-to-r from-emerald-500 to-teal-600 p-3 rounded-xl mr-4\">\r\n                        <svg className=\"h-6 w-6 text-white\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z\" />\r\n                        </svg>\r\n                      </div>\r\n                      <div>\r\n                        <h3 className=\"text-xl font-bold text-gray-900\">Estad√≠sticas de Conocimiento</h3>\r\n                        <div className=\"h-1 w-20 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-full mt-1\"></div>\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"space-y-3\">\r\n                      <div className=\"flex items-center justify-between p-3 bg-white/60 rounded-xl border border-emerald-100\">\r\n                        <div className=\"flex items-center\">\r\n                          <div className=\"w-3 h-3 bg-blue-500 rounded-full mr-3\"></div>\r\n                          <span className=\"text-sm font-medium text-gray-900\">FAQs</span>\r\n                        </div>\r\n                        <span className=\"text-lg font-bold text-blue-600\">{selectedFolder.knowledgeBase?.faqs?.length || 0}</span>\r\n                      </div>\r\n                      <div className=\"flex items-center justify-between p-3 bg-white/60 rounded-xl border border-emerald-100\">\r\n                        <div className=\"flex items-center\">\r\n                          <div className=\"w-3 h-3 bg-green-500 rounded-full mr-3\"></div>\r\n                          <span className=\"text-sm font-medium text-gray-900\">Documentos</span>\r\n                        </div>\r\n                        <span className=\"text-lg font-bold text-green-600\">{selectedFolder.knowledgeBase?.documents?.length || 0}</span>\r\n                      </div>\r\n                      <div className=\"flex items-center justify-between p-3 bg-white/60 rounded-xl border border-emerald-100\">\r\n                        <div className=\"flex items-center\">\r\n                          <div className=\"w-3 h-3 bg-purple-500 rounded-full mr-3\"></div>\r\n                          <span className=\"text-sm font-medium text-gray-900\">Pol√≠ticas</span>\r\n                        </div>\r\n                        <span className=\"text-lg font-bold text-purple-600\">{selectedFolder.knowledgeBase?.policies?.length || 0}</span>\r\n                      </div>\r\n                      <div className=\"flex items-center justify-between p-3 bg-white/60 rounded-xl border border-emerald-100\">\r\n                        <div className=\"flex items-center\">\r\n                          <div className=\"w-3 h-3 bg-orange-500 rounded-full mr-3\"></div>\r\n                          <span className=\"text-sm font-medium text-gray-900\">Procedimientos</span>\r\n                        </div>\r\n                        <span className=\"text-lg font-bold text-orange-600\">{selectedFolder.knowledgeBase?.procedures?.length || 0}</span>\r\n                      </div>\r\n                      <div className=\"flex items-center justify-between p-3 bg-white/60 rounded-xl border border-emerald-100\">\r\n                        <div className=\"flex items-center\">\r\n                          <div className=\"w-3 h-3 bg-gray-500 rounded-full mr-3\"></div>\r\n                          <span className=\"text-sm font-medium text-gray-900\">√öltima actualizaci√≥n</span>\r\n                        </div>\r\n                        <span className=\"text-sm font-medium text-gray-600\">{new Date(selectedFolder.lastUpdated).toLocaleDateString()}</span>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n                \r\n                {/* Archivos en la carpeta */}\r\n                <div className=\"border-t border-gray-200 pt-8\">\r\n                  <div className=\"flex items-center mb-6\">\r\n                    <div className=\"bg-gradient-to-r from-cyan-500 to-blue-600 p-3 rounded-xl mr-4\">\r\n                      <DocumentIcon className=\"h-6 w-6 text-white\" />\r\n                    </div>\r\n                    <div>\r\n                      <h3 className=\"text-2xl font-bold text-gray-900\">Archivos en la Carpeta</h3>\r\n                      <div className=\"h-1 w-20 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-full mt-1\"></div>\r\n                      <p className=\"text-sm text-gray-600 mt-1\">Documentos y recursos disponibles</p>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {selectedFolder.knowledgeBase?.documents && selectedFolder.knowledgeBase.documents.length > 0 ? (\r\n                    <div className=\"space-y-4\">\r\n                      {selectedFolder.knowledgeBase.documents.map((doc, index) => (\r\n                        <div key={index} className=\"bg-gradient-to-r from-gray-50 to-blue-50 p-6 rounded-3xl border border-gray-200 shadow-lg hover:shadow-xl transition-all duration-300\">\r\n                          <div className=\"flex items-start justify-between\">\r\n                            <div className=\"flex-1\">\r\n                              <div className=\"flex items-center mb-3\">\r\n                                <div className=\"w-3 h-3 bg-blue-500 rounded-full mr-3\"></div>\r\n                                <h4 className=\"text-lg font-bold text-gray-900\">{doc.name}</h4>\r\n                              </div>\r\n                              {doc.description && (\r\n                                <p className=\"text-sm text-gray-600 mb-4 ml-6\">{doc.description}</p>\r\n                              )}\r\n                              <div className=\"flex items-center text-xs text-gray-500 ml-6\">\r\n                                <div className=\"flex items-center mr-4\">\r\n                                  <svg className=\"w-4 h-4 mr-1 text-blue-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\r\n                                  </svg>\r\n                                  Documento\r\n                                </div>\r\n                                <div className=\"flex items-center mr-4\">\r\n                                  <svg className=\"w-4 h-4 mr-1 text-green-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\r\n                                  </svg>\r\n                                  {new Date().toLocaleDateString()}\r\n                                </div>\r\n                                {doc.fileSize && (\r\n                                  <div className=\"flex items-center\">\r\n                                    <svg className=\"w-4 h-4 mr-1 text-purple-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 4V2a1 1 0 011-1h4a1 1 0 011 1v2m4 0H8l.5 16h7L16 4z\" />\r\n                                    </svg>\r\n                                    {(doc.fileSize / 1024).toFixed(1)} KB\r\n                                  </div>\r\n                                )}\r\n                              </div>\r\n                            </div>\r\n                            <div className=\"flex items-center space-x-3\">\r\n                              <button\r\n                                onClick={() => {\r\n                                  // Mostrar contenido del archivo en un modal moderno\r\n                                  MySwal.fire({\r\n                                    title: `<div class=\"flex items-center\"><div class=\"bg-gradient-to-r from-blue-500 to-cyan-600 p-2 rounded-lg mr-3\"><svg class=\"w-6 h-6 text-white\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"></path></svg></div>${doc.name}</div>`,\r\n                                    html: `<div class=\"text-left max-h-96 overflow-y-auto bg-gray-50 p-4 rounded-lg\"><pre class=\"whitespace-pre-wrap text-sm font-mono text-gray-800\">${doc.content}</pre></div>`,\r\n                                    width: '900px',\r\n                                    showConfirmButton: false,\r\n                                    showCloseButton: true,\r\n                                    customClass: {\r\n                                      popup: 'rounded-3xl shadow-2xl border border-gray-200',\r\n                                      closeButton: 'text-gray-400 hover:text-gray-600 transition-colors'\r\n                                    }\r\n                                  });\r\n                                }}\r\n                                className=\"inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white font-medium rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                              >\r\n                                <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\r\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z\" />\r\n                                </svg>\r\n                                Ver Contenido\r\n                              </button>\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  ) : (\r\n                    <div className=\"text-center py-16 bg-gradient-to-r from-gray-50 to-blue-50 rounded-3xl border border-gray-200\">\r\n                      <div className=\"bg-gradient-to-r from-blue-500 to-cyan-600 p-6 rounded-full w-24 h-24 mx-auto mb-6 flex items-center justify-center shadow-2xl\">\r\n                        <DocumentIcon className=\"h-12 w-12 text-white\" />\r\n                      </div>\r\n                      <h4 className=\"text-2xl font-bold text-gray-900 mb-4\">No hay archivos en esta carpeta</h4>\r\n                      <p className=\"text-gray-600 text-lg max-w-md mx-auto leading-relaxed\">\r\n                        Los archivos subidos aparecer√°n aqu√≠ una vez que se agreguen documentos a la base de conocimiento del empleado.\r\n                      </p>\r\n                    </div>\r\n                  )}\r\n\r\n                  <div className=\"mt-8 flex justify-end\">\r\n                    <button\r\n                      onClick={() => setSelectedFolder(null)}\r\n                      className=\"inline-flex items-center px-6 py-3 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                    >\r\n                      <svg className=\"w-5 h-5 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\r\n                      </svg>\r\n                      Cerrar Carpeta\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default EmployeeFolders;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\communication\\EmployeeFolders_BACKUP.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'allFoldersNormalized' is assigned a value but never used.","line":32,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":30},{"ruleId":"no-unused-vars","severity":1,"message":"'setAllFoldersNormalized' is assigned a value but never used.","line":32,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":55},{"ruleId":"no-unused-vars","severity":1,"message":"'totalItems' is assigned a value but never used.","line":52,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":52,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'employeeCompanyIndex' is assigned a value but never used.","line":54,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":54,"endColumn":28},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadEmployeesOnly'. Either include it or remove the dependency array.","line":103,"column":6,"nodeType":"ArrayExpression","endLine":103,"endColumn":26,"suggestions":[{"desc":"Update the dependencies array to be: [companyId, filters, loadEmployeesOnly]","fix":{"range":[3566,3586],"text":"[companyId, filters, loadEmployeesOnly]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'filters.companyId'. Either include it or remove the dependency array.","line":110,"column":6,"nodeType":"ArrayExpression","endLine":110,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [companyId, filters.companyId]","fix":{"range":[3815,3826],"text":"[companyId, filters.companyId]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadFoldersForCurrentPage'. Either include it or remove the dependency array.","line":124,"column":6,"nodeType":"ArrayExpression","endLine":124,"endColumn":85,"suggestions":[{"desc":"Update the dependencies array to be: [currentPage, searchTerm, filters, loading, companies.length, employees.length, loadFoldersForCurrentPage]","fix":{"range":[4303,4382],"text":"[currentPage, searchTerm, filters, loading, companies.length, employees.length, loadFoldersForCurrentPage]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'currentPage' and 'employees'. Either include them or remove the dependency array.","line":149,"column":6,"nodeType":"ArrayExpression","endLine":149,"endColumn":45,"suggestions":[{"desc":"Update the dependencies array to be: [searchTerm, filters, employees.length, employees, currentPage]","fix":{"range":[5364,5403],"text":"[searchTerm, filters, employees.length, employees, currentPage]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'filteredEmployeesForCount' is assigned a value but never used.","line":891,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":891,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useParams } from 'react-router-dom';\r\nimport {\r\n  FolderIcon,\r\n  UserIcon,\r\n  DocumentIcon,\r\n  MagnifyingGlassIcon,\r\n  CloudArrowUpIcon,\r\n  FunnelIcon,\r\n  CheckCircleIcon,\r\n  ChevronLeftIcon,\r\n  ChevronRightIcon\r\n} from '@heroicons/react/24/outline';\r\nimport unifiedEmployeeFolderService from '../../services/unifiedEmployeeFolderService.js';\r\nimport googleDriveSyncService from '../../services/googleDriveSyncService.js';\r\nimport googleDriveTokenBridge from '../../lib/googleDriveTokenBridge.js';\r\nimport organizedDatabaseService from '../../services/organizedDatabaseService.js';\r\nimport { supabase } from '../../lib/supabaseClient.js';\r\nimport { useAuth } from '../../contexts/AuthContext.js';\r\nimport Swal from 'sweetalert2';\r\nimport withReactContent from 'sweetalert2-react-content';\r\nimport '../../styles/responsive-tables.css';\r\n\r\nconst MySwal = withReactContent(Swal);\r\n\r\nconst EmployeeFolders = () => {\r\n  const { companyId } = useParams();\r\n  const { user } = useAuth();\r\n  const [employees, setEmployees] = useState([]);\r\n  const [folders, setFolders] = useState([]);\r\n  \r\n  const [allFoldersNormalized, setAllFoldersNormalized] = useState([]);const [loading, setLoading] = useState(true);\r\n  const [loadingFolders, setLoadingFolders] = useState(false);\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [selectedFolder, setSelectedFolder] = useState(null);\r\n  const [showFilters, setShowFilters] = useState(false);\r\n  const [filters, setFilters] = useState({\r\n    companyId: '',\r\n    department: '',\r\n    level: '',\r\n    workMode: '',\r\n    contractType: ''\r\n  });\r\n  const [selectedFolders, setSelectedFolders] = useState(new Set());\r\n  const [companies, setCompanies] = useState([]);\r\n  const [uniqueDepartments, setUniqueDepartments] = useState([]);\r\n  const [uniqueLevels, setUniqueLevels] = useState([]);\r\n  const [uniqueWorkModes, setUniqueWorkModes] = useState([]);\r\n  const [uniqueContractTypes, setUniqueContractTypes] = useState([]);\r\n  const [currentPage, setCurrentPage] = useState(1);\r\n  const [itemsPerPage] = useState(10);\r\n  const [totalItems, setTotalItems] = useState(0);\r\n// √çndice global email -> company_id para resolver empresa real del empleado\r\nconst [employeeCompanyIndex, setEmployeeCompanyIndex] = useState(new Map());\r\n\r\n// Construir el √≠ndice una sola vez al montar\r\nuseEffect(() => {\r\n  let cancelled = false;\r\n\r\n  const buildEmployeeCompanyIndex = async () => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('employees')\r\n        .select('email, company_id');\r\n\r\n      if (error) {\r\n        console.error('‚ùå Error construyendo √≠ndice empleados->empresa:', error);\r\n        return;\r\n      }\r\n\r\n      const map = new Map();\r\n      (data || []).forEach((e) => {\r\n        const key = String(e.email || '').trim().toLowerCase();\r\n        if (key) map.set(key, e.company_id);\r\n      });\r\n\r\n      if (!cancelled) setEmployeeCompanyIndex(map);\r\n    } catch (err) {\r\n      console.error('‚ùå Error inesperado construyendo √≠ndice empleados->empresa:', err);\r\n    }\r\n  };\r\n\r\n  buildEmployeeCompanyIndex();\r\n  return () => {\r\n    cancelled = true;\r\n  };\r\n}, []);\r\n\r\n  // Inicializar token bridge cuando el usuario est√° autenticado\r\n  useEffect(() => {\r\n    if (user?.id) {\r\n      googleDriveTokenBridge.initializeForUser(user.id);\r\n    }\r\n    \r\n    return () => {\r\n      // Limpiar cuando el componente se desmonta\r\n      googleDriveTokenBridge.cleanup();\r\n    };\r\n  }, [user?.id]);\r\n\r\n  useEffect(() => {\r\n    loadEmployeesOnly();\r\n  }, [companyId, filters]);\r\n\r\n  // Alinear filtro de empresa con el par√°metro de ruta para evitar desajustes\r\n  useEffect(() => {\r\n    if (companyId && filters.companyId !== companyId) {\r\n      setFilters(prev => ({ ...prev, companyId }));\r\n    }\r\n  }, [companyId]);\r\n\r\n  // √öNICO efecto para cargar carpetas - consolidado para evitar duplicaciones\r\n  useEffect(() => {\r\n    if (!loading && employees.length > 0) {\r\n      console.log('üîÑ Cargando carpetas - trigger:', {\r\n        currentPage,\r\n        searchTerm: searchTerm || 'empty',\r\n        hasFilters: Object.values(filters).some(Boolean),\r\n        employeesCount: employees.length,\r\n        companiesCount: companies.length\r\n      });\r\n      loadFoldersForCurrentPage();\r\n    }\r\n  }, [currentPage, searchTerm, filters, loading, companies.length, employees.length]);\r\n\r\n  // Actualizar totalItems cuando cambian los filtros o la b√∫squeda (sin limpiar carpetas)\r\n  useEffect(() => {\r\n    const filteredEmployees = employees.filter(employee => {\r\n      if (!employee?.email) return false;\r\n\r\n      const companyName = (employee.company && employee.company.name) || (employee.companies && employee.companies.name) || '';\r\n      const term = (searchTerm || '').toLowerCase();\r\n\r\n      const matchesSearch =\r\n        !term ||\r\n        (employee.name && employee.name.toLowerCase().includes(term)) ||\r\n        (employee.email && employee.email.toLowerCase().includes(term)) ||\r\n        (companyName && companyName.toLowerCase().includes(term)) ||\r\n        (employee.department && employee.department.toLowerCase().includes(term));\r\n\r\n      return matchesSearch;\r\n    });\r\n\r\n    setTotalItems(filteredEmployees.length);\r\n    // Solo resetear p√°gina si los filtros realmente cambiaron\r\n    if (currentPage !== 1) {\r\n      setCurrentPage(1);\r\n    }\r\n  }, [searchTerm, filters, employees.length]);\r\n\r\n  const loadEmployeesOnly = async () => {\r\n    try {\r\n      setLoading(true);\r\n      console.log('üöÄ Iniciando carga de empleados...');\r\n      \r\n      // Cargar empresas - misma fuente que EmployeeSelector\r\n      const companyData = await organizedDatabaseService.getCompanies();\r\n      setCompanies(companyData);\r\n      \r\n      // Obtener empleados de la empresa con filtros - misma fuente que EmployeeSelector\r\n      let employeesData = [];\r\n      if (companyId) {\r\n        employeesData = await organizedDatabaseService.getEmployees({ companyId });\r\n      } else {\r\n        // Aplicar filtros directamente en el servicio (ahora soporta todos los filtros)\r\n        employeesData = await organizedDatabaseService.getEmployees(filters);\r\n      }\r\n\r\n      console.log(`üìä Cargados ${employeesData.length} empleados (${Object.values(filters).filter(Boolean).length} filtros aplicados)`);\r\n      // Normalizar para asegurar compatibilidad: employee.company disponible aunque venga como 'companies' en la relaci√≥n\r\n      const normalizedEmployees = (employeesData || []).map(e => ({\r\n        ...e,\r\n        company: e.companies || e.company || null, // Priorizar companies como en EmployeeSelector\r\n        // Campos adicionales para compatibilidad con vista de carpetas\r\n        employeeName: e.first_name && e.last_name ? `${e.first_name} ${e.last_name}` : e.first_name || e.last_name || 'Sin nombre',\r\n        employeeEmail: e.email,\r\n        employeeDepartment: e.department,\r\n        employeePosition: e.position,\r\n        employeePhone: e.phone,\r\n        employeeLevel: e.level,\r\n        employeeWorkMode: e.work_mode,\r\n        employeeContractType: e.contract_type,\r\n        companyName: e.companies?.name || e.company?.name || ''\r\n      }));\r\n      setEmployees(normalizedEmployees);\r\n      setTotalItems(normalizedEmployees.filter(emp => emp.email).length);\r\n\r\n      // Extraer valores √∫nicos para los filtros\r\n      extractUniqueFilters(employeesData);\r\n      \r\n    } catch (error) {\r\n      console.error('‚ùå Error cargando empleados:', error);\r\n      MySwal.fire({\r\n        title: 'Error',\r\n        text: 'Hubo un problema al cargar los empleados',\r\n        icon: 'error',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n      console.log('üèÅ Carga de empleados completada');\r\n    }\r\n  };\r\n\r\n  const loadFoldersForCurrentPage = async () => {\r\n    // Prevenir m√∫ltiples cargas simult√°neas\r\n    if (loadingFolders) {\r\n      console.log('‚è≥ Ya se est√°n cargando carpetas, ignorando solicitud duplicada...');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setLoadingFolders(true);\r\n      console.log(`üìÅ Cargando carpetas reales desde la base de datos...`);\r\n      \r\n      // Primero intentar cargar carpetas reales desde la base de datos con sus relaciones\r\n      let realFolders = [];\r\n      try {\r\n        const { data: employeeFolders, error } = await supabase\r\n          .from('employee_folders')\r\n          .select(`\r\n            *,\r\n            employee_documents(id, document_name, document_type, description, status),\r\n            employee_faqs(id, question, answer, category, status)\r\n          `)\r\n          .order('created_at', { ascending: false });\r\n\r\n        if (!error && employeeFolders) {\r\n          console.log(`‚úÖ Encontradas ${employeeFolders.length} carpetas reales en la base de datos`);\r\n          console.log('üìä Muestra de carpetas reales con relaciones:', employeeFolders.slice(0, 3).map(f => ({\r\n            email: f.employee_email,\r\n            documents_count: f.employee_documents?.length || 0,\r\n            faqs_count: f.employee_faqs?.length || 0\r\n          })));\r\n          realFolders = employeeFolders;\r\n        } else if (error) {\r\n          console.warn('‚ö†Ô∏è No se pudieron cargar carpetas reales, usando datos de empleados:', error.message);\r\n        }\r\n      } catch (dbError) {\r\n        console.warn('‚ö†Ô∏è Error consultando carpetas reales:', dbError.message);\r\n      }\r\n\r\n      // Si no hay carpetas reales, generar carpetas virtuales desde los empleados\r\n      let foldersToShow = [];\r\n      if (realFolders.length > 0) {\r\n        // Usar carpetas reales y enriquecerlas con datos de empleados\r\n        foldersToShow = realFolders.map(folder => {\r\n          const employee = employees.find(emp => emp.email === folder.employee_email);\r\n          \r\n          // Construir knowledgeBase 100% real desde las relaciones de la base de datos\r\n          const knowledgeBase = {\r\n            faqs: (folder.employee_faqs || [])\r\n              .filter(faq => faq.status === 'active')\r\n              .map(faq => ({\r\n                id: faq.id,\r\n                question: faq.question,\r\n                answer: faq.answer,\r\n                category: faq.category,\r\n                type: 'faq'\r\n              })),\r\n            documents: (folder.employee_documents || [])\r\n              .filter(doc => doc.status === 'active')\r\n              .map(doc => ({\r\n                id: doc.id,\r\n                name: doc.document_name,\r\n                description: doc.description,\r\n                type: doc.document_type,\r\n                fileType: doc.document_type,\r\n                category: doc.document_type\r\n              })),\r\n            policies: (folder.employee_documents || [])\r\n              .filter(doc => doc.status === 'active' && doc.document_type === 'policy')\r\n              .map(doc => ({\r\n                id: doc.id,\r\n                name: doc.document_name,\r\n                description: doc.description,\r\n                type: 'policy'\r\n              })),\r\n            procedures: (folder.employee_documents || [])\r\n              .filter(doc => doc.status === 'active' && doc.document_type === 'procedure')\r\n              .map(doc => ({\r\n                id: doc.id,\r\n                name: doc.document_name,\r\n                description: doc.description,\r\n                type: 'procedure'\r\n              }))\r\n          };\r\n          \r\n          console.log(`üìä Carpeta ${folder.employee_email}:`, {\r\n            faqs: knowledgeBase.faqs.length,\r\n            documents: knowledgeBase.documents.length,\r\n            policies: knowledgeBase.policies.length,\r\n            procedures: knowledgeBase.procedures.length\r\n          });\r\n          \r\n          return {\r\n            id: folder.id,\r\n            email: folder.employee_email,\r\n            employeeEmail: folder.employee_email,\r\n            employeeName: folder.employee_name || employee?.employeeName || 'Sin nombre',\r\n            companyName: folder.company_name || employee?.companyName || 'Sin empresa',\r\n            companyIdResolved: folder.company_id || employee?.company_id,\r\n            employeeDepartment: folder.employee_department || employee?.employeeDepartment,\r\n            employeePosition: folder.employee_position || employee?.employeePosition,\r\n            employeePhone: folder.employee_phone || employee?.employeePhone,\r\n            employeeLevel: folder.employee_level || employee?.employeeLevel,\r\n            employeeWorkMode: folder.employee_work_mode || employee?.employeeWorkMode,\r\n            employeeContractType: folder.employee_contract_type || employee?.employeeContractType,\r\n            lastUpdated: folder.updated_at || new Date().toISOString(),\r\n            driveFolderId: folder.drive_folder_id,\r\n            driveFolderUrl: folder.drive_folder_url,\r\n            // Usar datos reales de la base de datos\r\n            knowledgeBase: knowledgeBase\r\n          };\r\n        });\r\n      } else {\r\n        // Si no hay carpetas reales, no mostrar carpetas virtuales\r\n        console.log(`üìÇ No hay carpetas reales en la base de datos para mostrar`);\r\n        foldersToShow = [];\r\n      }\r\n\r\n      console.log(`‚úÖ Total de carpetas a mostrar: ${foldersToShow.length}`);\r\n\r\n      // Si no hay filtros, mostrar todas las carpetas\r\n      if (!searchTerm && !Object.values(filters).some(Boolean)) {\r\n        setFolders(foldersToShow);\r\n        setTotalItems(foldersToShow.length);\r\n        return;\r\n      }\r\n\r\n      // Aplicar filtros a las carpetas\r\n      let filteredFolders = foldersToShow || [];\r\n\r\n      const term = (searchTerm || '').toLowerCase();\r\n      if (term) {\r\n        filteredFolders = filteredFolders.filter(folder =>\r\n          (folder.employeeName || '').toLowerCase().includes(term) ||\r\n          (folder.employeeEmail || '').toLowerCase().includes(term) ||\r\n          (folder.companyName || '').toLowerCase().includes(term) ||\r\n          (folder.employeePosition || '').toLowerCase().includes(term)\r\n        );\r\n      }\r\n\r\n      if (filters.companyId) {\r\n        // Usar company_id directamente como en EmployeeSelector\r\n        filteredFolders = filteredFolders.filter(\r\n          (folder) => folder.companyIdResolved === filters.companyId\r\n        );\r\n      }\r\n\r\n      if (filters.department) {\r\n        filteredFolders = filteredFolders.filter(folder => (folder.employeeDepartment || '') === filters.department);\r\n      }\r\n\r\n      if (filters.level) {\r\n        filteredFolders = filteredFolders.filter(folder => (folder.employeeLevel || '') === filters.level);\r\n      }\r\n\r\n      if (filters.workMode) {\r\n        filteredFolders = filteredFolders.filter(folder => (folder.employeeWorkMode || '') === filters.workMode);\r\n      }\r\n\r\n      if (filters.contractType) {\r\n        filteredFolders = filteredFolders.filter(folder => (folder.employeeContractType || '') === filters.contractType);\r\n      }\r\n\r\n      console.log(`üìä ${filteredFolders.length} carpetas despu√©s de aplicar filtros`);\r\n      console.log('üè¢ Empresas disponibles (desde companies):', (companies || []).map(c => [c.id, c.name]));\r\n      console.log('üß≠ Filtro de empresa aplicado:', filters.companyId);\r\n      \r\n      setFolders(filteredFolders);\r\n      setTotalItems(filteredFolders.length);\r\n      \r\n    } catch (error) {\r\n      console.error('‚ùå Error cargando carpetas:', error);\r\n      MySwal.fire({\r\n        title: 'Error',\r\n        text: 'Hubo un problema al cargar las carpetas desde la base de datos',\r\n        icon: 'error',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    } finally {\r\n      setLoadingFolders(false);\r\n      console.log('üèÅ Carga de carpetas completada');\r\n    }\r\n  };\r\n\r\n  // Funci√≥n de compatibilidad para mantener el c√≥digo existente\r\n  const loadEmployeesAndFolders = loadEmployeesOnly;\r\n\r\n  const extractUniqueFilters = (employeesData) => {\r\n    const departments = [...new Set(employeesData.map(emp => emp.department))];\r\n    const levels = [...new Set(employeesData.map(emp => emp.level))];\r\n    const workModes = [...new Set(employeesData.map(emp => emp.work_mode))];\r\n    const contractTypes = [...new Set(employeesData.map(emp => emp.contract_type))];\r\n    \r\n    setUniqueDepartments(departments.sort());\r\n    setUniqueLevels(levels.sort());\r\n    setUniqueWorkModes(workModes.sort());\r\n    setUniqueContractTypes(contractTypes.sort());\r\n  };\r\n\r\n  const handleFilterChange = (filterName, value) => {\r\n    setFilters(prev => ({\r\n      ...prev,\r\n      [filterName]: value\r\n    }));\r\n  };\r\n\r\n\r\n  const handleSearch = (term) => {\r\n    setSearchTerm(term);\r\n  };\r\n\r\n  const getFilteredFolders = () => {\r\n    // Las carpetas ya vienen filtradas por b√∫squeda y filtros activos\r\n    // Agregar deduplicaci√≥n por email como √∫ltima capa de seguridad\r\n    const uniqueFolders = [];\r\n    const seenEmails = new Set();\r\n    \r\n    folders.forEach(folder => {\r\n      const email = folder.email || folder.employeeEmail;\r\n      if (email && !seenEmails.has(email)) {\r\n        seenEmails.add(email);\r\n        uniqueFolders.push(folder);\r\n      } else if (email && seenEmails.has(email)) {\r\n        console.warn('‚ö†Ô∏è Carpeta duplicada detectada y eliminada:', email);\r\n      }\r\n    });\r\n    \r\n    return uniqueFolders;\r\n  };\r\n\r\n  const getPaginatedFolders = () => {\r\n    const all = getFilteredFolders();\r\n    const start = (currentPage - 1) * itemsPerPage;\r\n    const end = start + itemsPerPage;\r\n    return all.slice(start, end);\r\n  };\r\n\r\n  const getTotalPages = () => {\r\n    return Math.ceil(getFilteredFolders().length / itemsPerPage || 1);\r\n  };\r\n\r\n  const handlePageChange = (page) => {\r\n    if (page !== currentPage) {\r\n      console.log(`üìÑ Cambiando a p√°gina ${page}`);\r\n      setCurrentPage(page);\r\n      // No limpiar carpetas, el useEffect se encargar√° de cargar los datos correctos\r\n    }\r\n  };\r\n\r\n  const handleSelectFolder = (employeeEmail) => {\r\n    const newSelected = new Set(selectedFolders);\r\n    if (newSelected.has(employeeEmail)) {\r\n      newSelected.delete(employeeEmail);\r\n    } else {\r\n      newSelected.add(employeeEmail);\r\n    }\r\n    setSelectedFolders(newSelected);\r\n  };\r\n\r\n  const handleSelectAll = () => {\r\n    if (selectedFolders.size === getFilteredFolders().length) {\r\n      // Deseleccionar todos\r\n      setSelectedFolders(new Set());\r\n    } else {\r\n      // Seleccionar todos los filtrados\r\n      const allEmails = new Set(getFilteredFolders().map(folder => folder.email));\r\n      setSelectedFolders(allEmails);\r\n    }\r\n  };\r\n\r\n\r\n  const handleFileUpload = async (employeeEmails, files) => {\r\n    try {\r\n      const totalFiles = files.length;\r\n      const totalFolders = employeeEmails.length;\r\n      let uploadedCount = 0;\r\n      \r\n      // Funci√≥n auxiliar para leer archivo de forma segura\r\n      const readFileContent = (file) => {\r\n        return new Promise((resolve, reject) => {\r\n          const reader = new FileReader();\r\n          reader.onload = (e) => resolve(e.target.result);\r\n          reader.onerror = (e) => reject(new Error('Error leyendo el archivo'));\r\n          reader.readAsText(file);\r\n        });\r\n      };\r\n      \r\n      // Procesar cada archivo para cada empleado\r\n      for (const employeeEmail of employeeEmails) {\r\n        for (const file of files) {\r\n          try {\r\n            const content = await readFileContent(file);\r\n            \r\n            // Crear un documento con el contenido del archivo\r\n            // Simular adici√≥n de documento (sin depender de servicio externo)\r\n            console.log(`üìÑ Simulando adici√≥n de documento para ${employeeEmail}:`, {\r\n              name: file.name,\r\n              description: `Archivo subido: ${file.name}`,\r\n              content: content,\r\n              fileType: file.type,\r\n              fileSize: file.size\r\n            });\r\n            \r\n            uploadedCount++;\r\n            \r\n          } catch (fileError) {\r\n            console.error(`Error procesando archivo ${file.name} para ${employeeEmail}:`, fileError);\r\n            // Continuar con el siguiente archivo en caso de error\r\n          }\r\n        }\r\n      }\r\n      \r\n      // Recargar los datos despu√©s de procesar todos los archivos\r\n      await loadEmployeesAndFolders();\r\n      \r\n      MySwal.fire({\r\n        title: '¬°√âxito!',\r\n        text: `${uploadedCount} de ${totalFiles * totalFolders} archivo(s) subido(s) correctamente a ${totalFolders} carpeta(s)`,\r\n        icon: uploadedCount > 0 ? 'success' : 'warning',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n      \r\n    } catch (error) {\r\n      console.error('Error subiendo archivos:', error);\r\n      MySwal.fire({\r\n        title: 'Error',\r\n        text: 'Hubo un problema al subir los archivos',\r\n        icon: 'error',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    }\r\n  };\r\n\r\n  const handleBulkFileUpload = (files) => {\r\n    if (selectedFolders.size === 0) {\r\n      MySwal.fire({\r\n        title: 'Advertencia',\r\n        text: 'Por favor, seleccione al menos una carpeta para subir archivos',\r\n        icon: 'warning',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#fcb900'\r\n      });\r\n      return;\r\n    }\r\n    \r\n    handleFileUpload(Array.from(selectedFolders), files);\r\n  };\r\n\r\n  const handleDragOver = (e) => {\r\n    e.preventDefault();\r\n  };\r\n\r\n  const handleDrop = (e, employeeEmail) => {\r\n    e.preventDefault();\r\n    const files = e.dataTransfer.files;\r\n    if (files.length > 0) {\r\n      // Subir a una sola carpeta\r\n      handleFileUpload([employeeEmail], files);\r\n    }\r\n  };\r\n\r\n  const handleBulkDrop = (e) => {\r\n    e.preventDefault();\r\n    const files = e.dataTransfer.files;\r\n    if (files.length > 0) {\r\n      handleBulkFileUpload(files);\r\n    }\r\n  };\r\n\r\n  const handleFileInputChange = (e, employeeEmail = null) => {\r\n    const files = e.target.files;\r\n    if (files.length > 0) {\r\n      if (employeeEmail) {\r\n        // Subir a una sola carpeta\r\n        handleFileUpload([employeeEmail], files);\r\n      } else {\r\n        // Subir a m√∫ltiples carpetas seleccionadas\r\n        handleBulkFileUpload(files);\r\n      }\r\n    }\r\n  };\r\n\r\n  const handleViewFolder = async (employeeEmail) => {\r\n    try {\r\n      // Buscar carpeta real en la base de datos\r\n      const { data: folder, error } = await supabase\r\n        .from('employee_folders')\r\n        .select('*')\r\n        .eq('employee_email', employeeEmail)\r\n        .maybeSingle();\r\n\r\n      if (error || !folder) {\r\n        // Si no existe, crearla\r\n        console.log(`üìÅ Creando carpeta para ${employeeEmail}...`);\r\n        const employee = employees.find(emp => emp.email === employeeEmail);\r\n        if (employee) {\r\n          const result = await unifiedEmployeeFolderService.createEmployeeFolder(employeeEmail, employee);\r\n          setSelectedFolder(result.folder);\r\n        }\r\n      } else {\r\n        setSelectedFolder(folder);\r\n      }\r\n      \r\n      // Limpiar selecci√≥n cuando se abre una carpeta individual\r\n      setSelectedFolders(new Set());\r\n    } catch (error) {\r\n      console.error('Error cargando carpeta:', error);\r\n      MySwal.fire({\r\n        title: 'Error',\r\n        text: 'Hubo un problema al cargar la carpeta del empleado',\r\n        icon: 'error',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    }\r\n  };\r\n\r\n  // Funci√≥n para crear todas las carpetas de empleados\r\n  const createAllEmployeeFolders = async () => {\r\n    try {\r\n      setLoadingFolders(true);\r\n      MySwal.fire({\r\n        title: 'Creando carpetas...',\r\n        text: 'Por favor espera mientras se crean las carpetas para todos los empleados',\r\n        icon: 'info',\r\n        showConfirmButton: false,\r\n        allowOutsideClick: false\r\n      });\r\n\r\n      // UNIFICADO: Usar solo googleDriveSyncService para evitar duplicaciones\r\n      console.log('üîÑ Usando googleDriveSyncService unificado para evitar duplicaciones...');\r\n      let createdCount = 0;\r\n      let updatedCount = 0;\r\n      let errorCount = 0;\r\n      const errors = [];\r\n\r\n      for (const employee of employees) {\r\n        try {\r\n          if (!employee.email) {\r\n            console.warn(`‚ö†Ô∏è Empleado sin email: ${employee.name}`);\r\n            continue;\r\n          }\r\n\r\n          console.log(`üìÅ Procesando empleado: ${employee.email}`);\r\n          const result = await googleDriveSyncService.createEmployeeFolderInDrive(\r\n            employee.email,\r\n            employee.employeeName || employee.first_name || 'Sin nombre',\r\n            employee.companyName || 'Sin empresa',\r\n            employee\r\n          );\r\n\r\n          if (result) {\r\n            if (result.syncStatus === 'created_in_both') {\r\n              createdCount++;\r\n            } else if (result.syncStatus === 'already_exists' ||\r\n                      result.syncStatus === 'updated_drive_id' ||\r\n                      result.syncStatus === 'existed_in_drive_created_in_supabase') {\r\n              updatedCount++;\r\n            }\r\n            console.log(`‚úÖ Procesado ${employee.email}: ${result.syncStatus}`);\r\n          }\r\n\r\n          // Log de progreso cada 10 empleados\r\n          if ((createdCount + updatedCount) % 10 === 0) {\r\n            console.log(`üìä Progreso: ${createdCount + updatedCount} carpetas procesadas...`);\r\n          }\r\n\r\n        } catch (error) {\r\n          errorCount++;\r\n          errors.push(`${employee.email}: ${error.message}`);\r\n          console.error(`‚ùå Error procesando ${employee.email}:`, error);\r\n        }\r\n      }\r\n\r\n      const result = { createdCount, updatedCount, errorCount, sampleErrors: errors.slice(0, 10) };\r\n      \r\n      MySwal.fire({\r\n        title: '¬°Proceso completado!',\r\n        html: `\r\n          <div class=\"text-left\">\r\n            <p><strong>Carpetas creadas:</strong> ${result.createdCount}</p>\r\n            <p><strong>Carpetas actualizadas:</strong> ${result.updatedCount}</p>\r\n            <p><strong>Errores:</strong> ${result.errorCount}</p>\r\n          </div>\r\n        `,\r\n        icon: result.errorCount === 0 ? 'success' : 'warning',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n\r\n      // Recargar carpetas\r\n      if (result && result.errorCount > 0) {\r\n        const errors = (result.sampleErrors || []).slice(0, 10);\r\n        const errorsHtml = errors.length\r\n          ? `<ul class=\"list-disc pl-5 text-left\">${errors.map(e => `<li class=\"mb-1 text-sm text-red-700\">${e}</li>`).join('')}</ul>`\r\n          : '<p class=\"text-gray-600\">No hay detalles adicionales de error</p>';\r\n        const schemaNote = result.schemaSuspect\r\n          ? `<div class=\"mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded\">\r\n               <p class=\"text-yellow-800 text-sm\">\r\n                 Se sospecha un problema de esquema en la base de datos. Verifica que las tablas est√©n creadas en Supabase ejecutando el SQL:\r\n                 <code class=\"bg-yellow-100 px-1 py-0.5 rounded\">database/employee_folders_setup.sql</code>\r\n               </p>\r\n             </div>`\r\n          : '';\r\n        await MySwal.fire({\r\n          title: 'Se detectaron errores durante la sincronizaci√≥n',\r\n          html: `\r\n            <div class=\"text-left\">\r\n              <p class=\"mb-2\"><strong>Errores:</strong> ${result.errorCount}</p>\r\n              <p class=\"mb-2\"><strong>Creadas:</strong> ${result.createdCount} &nbsp;&nbsp; <strong>Actualizadas:</strong> ${result.updatedCount}</p>\r\n              <div class=\"mt-2\">\r\n                <p class=\"mb-1 font-semibold\">Muestras de error:</p>\r\n                ${errorsHtml}\r\n              </div>\r\n              ${schemaNote}\r\n            </div>\r\n          `,\r\n          icon: 'warning',\r\n          confirmButtonText: 'Entendido',\r\n          confirmButtonColor: '#0693e3',\r\n          width: '800px'\r\n        });\r\n      }\r\n      await loadFoldersForCurrentPage();\r\n    } catch (error) {\r\n      console.error('Error creando carpetas:', error);\r\n      MySwal.fire({\r\n        title: 'Error',\r\n        text: 'Hubo un problema al crear las carpetas',\r\n        icon: 'error',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    } finally {\r\n      setLoadingFolders(false);\r\n    }\r\n  };\r\n\r\n  // Sincronizar manualmente con Google Drive (crea/actualiza carpetas)\r\n  const handleSyncWithDrive = async () => {\r\n    try {\r\n      setLoadingFolders(true);\r\n      MySwal.fire({\r\n        title: 'Sincronizando con Drive...',\r\n        text: 'Creando y actualizando carpetas para los empleados en Google Drive y Supabase',\r\n        icon: 'info',\r\n        allowOutsideClick: false,\r\n        showConfirmButton: false,\r\n        didOpen: () => {\r\n          MySwal.showLoading();\r\n        }\r\n      });\r\n       \r\n       // Verificar que Google Drive est√© autenticado ANTES de intentar sincronizar\r\n       if (!googleDriveSyncService.isAuthenticated()) {\r\n         MySwal.fire({\r\n           title: '‚ùå Google Drive no autenticado',\r\n           html: `\r\n             <div class=\"text-left\">\r\n               <p class=\"mb-4 text-gray-700\">\r\n                 <strong>No se puede sincronizar:</strong> Google Drive no est√° conectado.\r\n               </p>\r\n               <div class=\"bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4\">\r\n                 <p class=\"text-sm text-yellow-800 mb-2\">\r\n                   <strong>¬øQu√© necesitas hacer?</strong>\r\n                 </p>\r\n                 <ol class=\"list-decimal list-inside text-sm text-yellow-800 space-y-1\">\r\n                   <li>Ve a <strong>Integraciones</strong></li>\r\n                   <li>Haz clic en <strong>\"Conectar Google Drive\"</strong></li>\r\n                   <li>Autoriza el acceso a tu cuenta de Google</li>\r\n                   <li>Vuelve aqu√≠ e intenta sincronizar nuevamente</li>\r\n                 </ol>\r\n               </div>\r\n               <p class=\"text-xs text-gray-600\">\r\n                 Sin autenticaci√≥n, las carpetas no se pueden crear en Google Drive real.\r\n               </p>\r\n             </div>\r\n           `,\r\n           icon: 'warning',\r\n           confirmButtonText: 'Entendido',\r\n           confirmButtonColor: '#0693e3',\r\n           width: '600px'\r\n         });\r\n         setLoadingFolders(false);\r\n         return;\r\n       }\r\n\r\n\r\n      // Inicializar el servicio de sincronizaci√≥n\r\n      console.log('üîÑ Inicializando servicio de sincronizaci√≥n...');\r\n      const initResult = await googleDriveSyncService.initialize();\r\n      if (!initResult) {\r\n        throw new Error('No se pudo inicializar el servicio de sincronizaci√≥n');\r\n      }\r\n      console.log('‚úÖ Servicio de sincronizaci√≥n inicializado correctamente');\r\n\r\n      // Crear carpetas para todos los empleados en Google Drive Y Supabase simult√°neamente\r\n      let createdCount = 0;\r\n      let errorCount = 0;\r\n      const errors = [];\r\n\r\n      for (const employee of employees) {\r\n        try {\r\n          if (employee.email) {\r\n            console.log(`üìÅ Procesando empleado: ${employee.email}`);\r\n            const result = await googleDriveSyncService.createEmployeeFolderInDrive(\r\n              employee.email,\r\n              employee.employeeName || employee.first_name || 'Sin nombre',\r\n              employee.companyName || 'Sin empresa',\r\n              employee\r\n            );\r\n\r\n            if (result && result.driveFolder) {\r\n              createdCount++;\r\n              console.log(`‚úÖ Carpeta creada para ${employee.email}`);\r\n              \r\n              // Iniciar sincronizaci√≥n peri√≥dica para este empleado\r\n              googleDriveSyncService.startPeriodicSync(\r\n                employee.email,\r\n                result.driveFolder.id,\r\n                5 // cada 5 minutos\r\n              );\r\n            }\r\n          }\r\n        } catch (error) {\r\n          errorCount++;\r\n          errors.push(`${employee.email}: ${error.message}`);\r\n          console.error(`‚ùå Error creando carpeta para ${employee.email}:`, error);\r\n        }\r\n      }\r\n\r\n      MySwal.fire({\r\n        title: 'Sincronizaci√≥n completada',\r\n        html: `\r\n          <div class=\"text-left\">\r\n            <p><strong>Carpetas creadas en Google Drive y Supabase:</strong> ${createdCount}</p>\r\n            <p><strong>Sincronizaciones peri√≥dicas iniciadas:</strong> ${createdCount}</p>\r\n            <p><strong>Errores:</strong> ${errorCount}</p>\r\n          </div>\r\n        `,\r\n        icon: errorCount === 0 ? 'success' : 'warning',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n\r\n      if (errorCount > 0) {\r\n        const errorsHtml = errors.length\r\n          ? `<ul class=\"list-disc pl-5 text-left\">${errors.slice(0, 10).map(e => `<li class=\"mb-1 text-sm text-red-700\">${e}</li>`).join('')}</ul>`\r\n          : '<p class=\"text-gray-600\">No hay detalles adicionales de error</p>';\r\n        await MySwal.fire({\r\n          title: 'Se detectaron errores durante la sincronizaci√≥n',\r\n          html: `\r\n            <div class=\"text-left\">\r\n              <p class=\"mb-2\"><strong>Errores:</strong> ${errorCount}</p>\r\n              <p class=\"mb-2\"><strong>Creadas exitosamente:</strong> ${createdCount}</p>\r\n              <div class=\"mt-2\">\r\n                <p class=\"mb-1 font-semibold\">Muestras de error:</p>\r\n                ${errorsHtml}\r\n              </div>\r\n            </div>\r\n          `,\r\n          icon: 'warning',\r\n          confirmButtonText: 'Entendido',\r\n          confirmButtonColor: '#0693e3',\r\n          width: '800px'\r\n        });\r\n      }\r\n      await loadFoldersForCurrentPage();\r\n    } catch (error) {\r\n      console.error('Error sincronizando con Drive:', error);\r\n      MySwal.fire({\r\n        title: 'Error',\r\n        text: `No se pudo sincronizar con Google Drive: ${error.message || error}`,\r\n        icon: 'error',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    } finally {\r\n      setLoadingFolders(false);\r\n    }\r\n  };\r\n\r\n  // Calcular filteredEmployees para el conteo total\r\n  const filteredEmployeesForCount = employees.filter(employee => {\r\n    if (!employee?.email) return false;\r\n\r\n    const companyName = (employee.company && employee.company.name) || (employee.companies && employee.companies.name) || '';\r\n    const term = (searchTerm || '').toLowerCase();\r\n\r\n    const matchesSearch =\r\n      !term ||\r\n      (employee.name && employee.name.toLowerCase().includes(term)) ||\r\n      (employee.email && employee.email.toLowerCase().includes(term)) ||\r\n      (companyName && companyName.toLowerCase().includes(term)) ||\r\n      (employee.department && employee.department.toLowerCase().includes(term));\r\n\r\n    return matchesSearch;\r\n  });\r\n\r\n  // Calcular p√°ginas totales\r\n  const totalPages = getTotalPages();\r\n  const hasMorePages = currentPage < totalPages;\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-engage-blue mx-auto\"></div>\r\n          <p className=\"mt-4 text-gray-600\">Cargando empleados...</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-50 via-white to-indigo-50\">\r\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\r\n        {/* Header Moderno */}\r\n        <div className=\"bg-gradient-to-r from-indigo-500 via-purple-600 to-pink-600 rounded-3xl shadow-2xl p-8 mb-8 text-white relative overflow-hidden\">\r\n          <div className=\"absolute inset-0 bg-black/10\"></div>\r\n          <div className=\"relative z-10\">\r\n            <div className=\"flex items-center mb-3\">\r\n              <div className=\"bg-white/20 p-3 rounded-full mr-4\">\r\n                <FolderIcon className=\"h-8 w-8 text-white\" />\r\n              </div>\r\n              <div>\r\n                <h1 className=\"text-4xl font-bold mb-1\">\r\n                  Carpetas de Empleados\r\n                </h1>\r\n                <div className=\"h-1 w-20 bg-white/30 rounded-full\"></div>\r\n              </div>\r\n            </div>\r\n            <p className=\"text-indigo-100 text-lg font-medium\">\r\n              Gestiona la informaci√≥n y base de conocimiento de cada empleado\r\n            </p>\r\n            <div className=\"flex items-center mt-4 text-sm text-indigo-200\">\r\n              <div className=\"flex items-center mr-6\">\r\n                <div className=\"w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse\"></div>\r\n                {folders.length} carpetas activas\r\n              </div>\r\n              <div className=\"flex items-center\">\r\n                <div className=\"w-2 h-2 bg-blue-400 rounded-full mr-2\"></div>\r\n                Gesti√≥n de conocimiento\r\n              </div>\r\n            </div>\r\n          </div>\r\n          {/* Elementos decorativos */}\r\n          <div className=\"absolute -top-10 -right-10 w-32 h-32 bg-white/10 rounded-full\"></div>\r\n          <div className=\"absolute -bottom-8 -left-8 w-24 h-24 bg-white/10 rounded-full\"></div>\r\n        </div>\r\n\r\n        {/* Indicador de carga de carpetas */}\r\n        {loadingFolders && (\r\n          <div className=\"mb-6 p-4 bg-blue-50 border border-blue-200 rounded-xl\">\r\n            <div className=\"flex items-center\">\r\n              <div className=\"animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-3\"></div>\r\n              <p className=\"text-blue-800\">Cargando carpetas para la p√°gina {currentPage}...</p>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Informaci√≥n de paginaci√≥n */}\r\n        <div className=\"mb-6 p-4 bg-gray-50 rounded-xl\">\r\n          <div className=\"flex justify-between items-center\">\r\n            <p className=\"text-sm text-gray-600\">\r\n              Mostrando {Math.min((currentPage - 1) * itemsPerPage + 1, getFilteredFolders().length)} a {Math.min(currentPage * itemsPerPage, getFilteredFolders().length)} de {getFilteredFolders().length} carpetas {getFilteredFolders().length > itemsPerPage && `(p√°gina ${currentPage} de ${getTotalPages()})`}\r\n            </p>\r\n            <div className=\"flex space-x-2\">\r\n              <button\r\n                onClick={handleSyncWithDrive}\r\n                disabled={loadingFolders}\r\n                className=\"px-3 py-1 bg-green-600 text-white rounded disabled:bg-gray-300 disabled:cursor-not-allowed hover:bg-green-700 transition-colors\"\r\n              >\r\n                {loadingFolders ? 'Sincronizando...' : 'Sincronizar con Drive'}\r\n              </button>\r\n              <button\r\n                onClick={() => handlePageChange(Math.max(1, currentPage - 1))}\r\n                disabled={currentPage === 1}\r\n                className=\"px-3 py-1 bg-blue-600 text-white rounded disabled:bg-gray-300 disabled:cursor-not-allowed hover:bg-blue-700 transition-colors\"\r\n              >\r\n                Anterior\r\n              </button>\r\n              <span className=\"px-3 py-1 bg-gray-200 rounded\">\r\n                {currentPage} / {totalPages}\r\n              </span>\r\n              <button\r\n                onClick={() => handlePageChange(currentPage + 1)}\r\n                disabled={!hasMorePages}\r\n                className=\"px-3 py-1 bg-blue-600 text-white rounded disabled:bg-gray-300 disabled:cursor-not-allowed hover:bg-blue-700 transition-colors\"\r\n              >\r\n                Siguiente\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Filtros y b√∫squeda */}\r\n        <div className=\"bg-white rounded-3xl shadow-2xl p-8 mb-8 border border-gray-100 relative overflow-hidden responsive-layout\">\r\n          <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500\"></div>\r\n          <div className=\"flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6\">\r\n            <div className=\"flex items-center mb-4 lg:mb-0\">\r\n              <div className=\"bg-gradient-to-r from-indigo-500 to-purple-600 p-3 rounded-xl mr-4\">\r\n                <FunnelIcon className=\"h-6 w-6 text-white\" />\r\n              </div>\r\n              <div>\r\n                <h2 className=\"text-2xl font-bold text-gray-900\">Filtros Avanzados</h2>\r\n                <p className=\"text-sm text-gray-600\">Encuentra r√°pidamente las carpetas que necesitas</p>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex flex-col sm:flex-row items-start sm:items-center gap-4\">\r\n              <button\r\n                onClick={() => setShowFilters(!showFilters)}\r\n                className=\"inline-flex items-center px-6 py-3 bg-gradient-to-r from-indigo-100 to-purple-100 hover:from-indigo-200 hover:to-purple-200 text-indigo-700 font-semibold rounded-xl transition-all duration-300 shadow-sm hover:shadow-md\"\r\n              >\r\n                <FunnelIcon className=\"h-5 w-5 mr-3\" />\r\n                {showFilters ? 'Ocultar Filtros' : 'Mostrar Filtros'}\r\n              </button>\r\n\r\n              <div className=\"search-container\">\r\n                <input\r\n                  type=\"text\"\r\n                  placeholder=\"Buscar por nombre, email o departamento...\"\r\n                  className=\"pl-12 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 w-full transition-all duration-300 bg-gray-50 focus:bg-white\"\r\n                  value={searchTerm}\r\n                  onChange={(e) => handleSearch(e.target.value)}\r\n                />\r\n                <MagnifyingGlassIcon className=\"h-6 w-6 text-gray-400 absolute left-3 top-3\" />\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Panel de filtros */}\r\n          {showFilters && (\r\n            <div className=\"filters-grid mt-4 pt-4 border-t border-gray-200\">\r\n              <div className=\"min-w-0\">\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Empresa</label>\r\n                <select\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engage-blue focus:border-engage-blue truncate\"\r\n                  value={filters.companyId}\r\n                  onChange={(e) => handleFilterChange('companyId', e.target.value)}\r\n                >\r\n                  <option value=\"\">Todas las empresas</option>\r\n                  {companies.map(company => (\r\n                    <option key={company.id} value={company.id}>{company.name}</option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n              \r\n              <div className=\"min-w-0\">\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Departamento</label>\r\n                <select\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engage-blue focus:border-engage-blue truncate\"\r\n                  value={filters.department}\r\n                  onChange={(e) => handleFilterChange('department', e.target.value)}\r\n                >\r\n                  <option value=\"\">Todos los departamentos</option>\r\n                  {uniqueDepartments.map(dept => (\r\n                    <option key={dept} value={dept} className=\"truncate\">{dept}</option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n              \r\n              <div className=\"min-w-0\">\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Nivel</label>\r\n                <select\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engage-blue focus:border-engage-blue truncate\"\r\n                  value={filters.level}\r\n                  onChange={(e) => handleFilterChange('level', e.target.value)}\r\n                >\r\n                  <option value=\"\">Todos los niveles</option>\r\n                  {uniqueLevels.map(level => (\r\n                    <option key={level} value={level} className=\"truncate\">{level}</option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n              \r\n              <div className=\"min-w-0\">\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Modalidad</label>\r\n                <select\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engage-blue focus:border-engage-blue truncate\"\r\n                  value={filters.workMode}\r\n                  onChange={(e) => handleFilterChange('workMode', e.target.value)}\r\n                >\r\n                  <option value=\"\">Todas las modalidades</option>\r\n                  {uniqueWorkModes.map(mode => (\r\n                    <option key={mode} value={mode} className=\"truncate\">{mode}</option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n              \r\n              <div className=\"min-w-0\">\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Tipo de Contrato</label>\r\n                <select\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-engage-blue focus:border-engage-blue truncate\"\r\n                  value={filters.contractType}\r\n                  onChange={(e) => handleFilterChange('contractType', e.target.value)}\r\n                >\r\n                  <option value=\"\">Todos los contratos</option>\r\n                  {uniqueContractTypes.map(type => (\r\n                    <option key={type} value={type} className=\"truncate\">{type}</option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Botones de acci√≥n para selecci√≥n m√∫ltiple */}\r\n          {selectedFolders.size > 0 && (\r\n            <div className=\"mt-4 pt-4 border-t border-gray-200\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div className=\"text-sm text-gray-600\">\r\n                  {selectedFolders.size} carpeta(s) seleccionada(s)\r\n                </div>\r\n                <div className=\"flex items-center space-x-2\">\r\n                  <label className=\"flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg cursor-pointer hover:bg-blue-600 transition-colors\">\r\n                    <CloudArrowUpIcon className=\"h-5 w-5 mr-2\" />\r\n                    Subir Archivos\r\n                    <input\r\n                      type=\"file\"\r\n                      className=\"hidden\"\r\n                      multiple\r\n                      onChange={(e) => handleFileInputChange(e)}\r\n                    />\r\n                  </label>\r\n                  <button\r\n                    onClick={() => setSelectedFolders(new Set())}\r\n                    className=\"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors\"\r\n                  >\r\n                    Cancelar Selecci√≥n\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* √Årea de arrastrar y soltar para m√∫ltiples carpetas */}\r\n        {selectedFolders.size > 0 && (\r\n          <div \r\n            className=\"bg-blue-50 border-2 border-dashed border-blue-300 rounded-2xl p-8 mb-8 text-center cursor-pointer transition-colors hover:bg-blue-100\"\r\n            onDragOver={handleDragOver}\r\n            onDrop={handleBulkDrop}\r\n            onClick={() => document.getElementById('bulk-file-input').click()}\r\n          >\r\n            <CloudArrowUpIcon className=\"h-12 w-12 text-blue-500 mx-auto mb-4\" />\r\n            <h3 className=\"text-lg font-medium text-gray-900 mb-2\">\r\n              Arrastra archivos aqu√≠ para subir a {selectedFolders.size} carpeta(s) seleccionada(s)\r\n            </h3>\r\n            <p className=\"text-gray-600\">\r\n              Tambi√©n puedes hacer clic para seleccionar archivos\r\n            </p>\r\n            <input\r\n              id=\"bulk-file-input\"\r\n              type=\"file\"\r\n              className=\"hidden\"\r\n              multiple\r\n              onChange={(e) => handleFileInputChange(e)}\r\n            />\r\n          </div>\r\n        )}\r\n\r\n        {/* Lista de carpetas */}\r\n        <div className=\"bg-white rounded-3xl shadow-2xl border border-gray-100 overflow-hidden relative responsive-layout\">\r\n          <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500\"></div>\r\n          <div className=\"px-8 py-6 border-b border-gray-100\">\r\n            <div className=\"table-header-actions\">\r\n              <div className=\"flex items-center\">\r\n                <div className=\"bg-gradient-to-r from-indigo-500 to-purple-600 p-3 rounded-xl mr-4\">\r\n                  <FolderIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n                <div>\r\n                  <h2 className=\"text-2xl font-bold text-gray-900\">Carpetas Disponibles</h2>\r\n                  <p className=\"text-sm text-gray-600\">{getFilteredFolders().length} carpetas encontradas</p>\r\n                </div>\r\n              </div>\r\n              <div className=\"flex flex-col sm:flex-row items-start sm:items-center gap-4\">\r\n                <div className=\"flex items-center bg-indigo-50 px-4 py-2 rounded-xl\">\r\n                  <div className=\"w-2 h-2 bg-indigo-500 rounded-full mr-3\"></div>\r\n                  <span className=\"text-sm font-medium text-indigo-700\">{selectedFolders.size} de {getFilteredFolders().length} seleccionadas</span>\r\n                </div>\r\n                <button\r\n                  onClick={handleSelectAll}\r\n                  className=\"inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-all duration-300 hover:shadow-md\"\r\n                >\r\n                  <CheckCircleIcon className={`h-5 w-5 mr-2 ${selectedFolders.size === getFilteredFolders().length ? 'text-indigo-500' : 'text-gray-400'}`} />\r\n                  {selectedFolders.size === getFilteredFolders().length ? 'Deseleccionar todas' : 'Seleccionar todas'}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Indicador de scroll para m√≥viles */}\r\n          <div className=\"table-scroll-hint\">\r\n            <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 8l4 4m0 0l-4 4m4-4H3\" />\r\n            </svg>\r\n            Desliza horizontalmente para ver m√°s informaci√≥n\r\n          </div>\r\n\r\n          <div className=\"table-responsive-container scroll-horizontal\">\r\n            <div className=\"divide-y divide-gray-100\">\r\n              {getPaginatedFolders().map((folder) => (\r\n                <div\r\n                  key={folder.email}\r\n                  className={`employee-card p-8 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 transition-all duration-300 cursor-pointer transform hover:scale-[1.01] ${\r\n                    selectedFolders.has(folder.email) ? 'bg-gradient-to-r from-indigo-100 to-purple-100 border-l-4 border-indigo-500 shadow-lg' : 'hover:shadow-md'\r\n                  }`}\r\n                  onClick={() => handleSelectFolder(folder.email)}\r\n                  onDragOver={handleDragOver}\r\n                  onDrop={(e) => handleDrop(e, folder.email)}\r\n                >\r\n                  <div className=\"flex items-start\">\r\n                    <div className=\"flex items-center h-6 mr-6\">\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        checked={selectedFolders.has(folder.email)}\r\n                        onChange={() => handleSelectFolder(folder.email)}\r\n                        className=\"h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 transition-all duration-300\"\r\n                      />\r\n                    </div>\r\n\r\n                    <div className=\"flex-1 min-w-0\">\r\n                      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n                        <div className=\"flex items-center\">\r\n                          <div className=\"flex-shrink-0 h-14 w-14 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg mr-4\">\r\n                            <span className=\"text-white font-bold text-lg\">\r\n                              {((folder.employeeName || folder.email || folder.employee_email || '?').charAt(0)).toUpperCase()}\r\n                            </span>\r\n                          </div>\r\n                          <div className=\"employee-info\">\r\n                            <h3 className=\"text-xl font-bold text-gray-900 truncate max-w-xs md:max-w-md\">\r\n                              {folder.employeeName || folder.email}\r\n                            </h3>\r\n                            <p className=\"text-sm text-gray-600 truncate max-w-xs md:max-w-md flex items-center\">\r\n                              <svg className=\"w-4 h-4 mr-1 text-gray-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\" />\r\n                              </svg>\r\n                              {folder.email}\r\n                            </p>\r\n                          </div>\r\n                        </div>\r\n\r\n                        <div className=\"employee-actions action-buttons\">\r\n                          <button\r\n                            onClick={(e) => {\r\n                              e.stopPropagation();\r\n                              handleViewFolder(folder.email);\r\n                            }}\r\n                            className=\"inline-flex items-center px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-medium rounded-lg transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105\"\r\n                          >\r\n                            <DocumentIcon className=\"h-5 w-5 mr-2\" />\r\n                            Ver Carpeta\r\n                          </button>\r\n                        </div>\r\n                      </div>\r\n                      \r\n                      <div className=\"mt-6 info-card-grid\">\r\n                         <div className=\"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100\">\r\n                           <div className=\"flex items-center mb-2\">\r\n                             <div className=\"w-2 h-2 bg-blue-500 rounded-full mr-2\"></div>\r\n                             <p className=\"text-xs font-semibold text-blue-700 uppercase tracking-wide\">Empresa</p>\r\n                           </div>\r\n                           <p className=\"text-sm font-bold text-gray-900 truncate\">{folder.companyName}</p>\r\n                         </div>\r\n\r\n                         <div className=\"bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-xl border border-green-100\">\r\n                           <div className=\"flex items-center mb-2\">\r\n                             <div className=\"w-2 h-2 bg-green-500 rounded-full mr-2\"></div>\r\n                             <p className=\"text-xs font-semibold text-green-700 uppercase tracking-wide\">Departamento</p>\r\n                           </div>\r\n                           <p className=\"text-sm font-bold text-gray-900 truncate\">{folder.employeeDepartment || 'No especificado'}</p>\r\n                         </div>\r\n\r\n                         <div className=\"bg-gradient-to-r from-purple-50 to-violet-50 p-4 rounded-xl border border-purple-100\">\r\n                           <div className=\"flex items-center mb-2\">\r\n                             <div className=\"w-2 h-2 bg-purple-500 rounded-full mr-2\"></div>\r\n                             <p className=\"text-xs font-semibold text-purple-700 uppercase tracking-wide\">Cargo</p>\r\n                           </div>\r\n                           <p className=\"text-sm font-bold text-gray-900 truncate\">{folder.employeePosition || 'No especificado'}</p>\r\n                         </div>\r\n\r\n                         <div className=\"bg-gradient-to-r from-orange-50 to-red-50 p-4 rounded-xl border border-orange-100\">\r\n                           <div className=\"flex items-center mb-2\">\r\n                             <div className=\"w-2 h-2 bg-orange-500 rounded-full mr-2\"></div>\r\n                             <p className=\"text-xs font-semibold text-orange-700 uppercase tracking-wide\">Tel√©fono</p>\r\n                           </div>\r\n                           <p className=\"text-sm font-bold text-gray-900 truncate\">{folder.employeePhone || 'No especificado'}</p>\r\n                         </div>\r\n                       </div>\r\n                     \r\n                       <div className=\"mt-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\r\n                          <div className=\"badge-container\">\r\n                            <div className=\"inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-blue-100 to-blue-200 text-blue-800 border border-blue-300\">\r\n                              <svg className=\"w-3 h-3 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n                              </svg>\r\n                              FAQs: {folder.knowledgeBase?.faqs?.length || 0}\r\n                            </div>\r\n                            <div className=\"inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-green-100 to-green-200 text-green-800 border border-green-300\">\r\n                              <svg className=\"w-3 h-3 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\r\n                              </svg>\r\n                              Documentos: {folder.knowledgeBase?.documents?.length || 0}\r\n                            </div>\r\n                            <div className=\"inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-purple-100 to-purple-200 text-purple-800 border border-purple-300\">\r\n                              <svg className=\"w-3 h-3 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z\" />\r\n                              </svg>\r\n                              Pol√≠ticas: {folder.knowledgeBase?.policies?.length || 0}\r\n                            </div>\r\n                            <div className=\"inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-orange-100 to-orange-200 text-orange-800 border border-orange-300\">\r\n                              <svg className=\"w-3 h-3 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\r\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\r\n                              </svg>\r\n                              Procedimientos: {folder.knowledgeBase?.procedures?.length || 0}\r\n                            </div>\r\n                          </div>\r\n\r\n                          <div className=\"bg-gray-100 px-3 py-2 rounded-lg\">\r\n                            <div className=\"flex items-center text-xs text-gray-600\">\r\n                              <svg className=\"w-4 h-4 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n                              </svg>\r\n                              √öltima actualizaci√≥n: {new Date(folder.lastUpdated).toLocaleDateString()}\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n              \r\n              {getFilteredFolders().length === 0 && (\r\n                <div className=\"empty-state\">\r\n                  <FolderIcon className=\"h-12 w-12 text-gray-400 mx-auto mb-4\" />\r\n                  <h3 className=\"text-lg font-medium text-gray-900 mb-1\">No se encontraron carpetas</h3>\r\n                  <p className=\"text-gray-500\">\r\n                    {searchTerm || Object.values(filters).some(Boolean)\r\n                      ? 'No hay carpetas que coincidan con los filtros aplicados'\r\n                      : loading\r\n                        ? 'Cargando carpetas...'\r\n                        : employees.length === 0\r\n                          ? 'No hay empleados disponibles para generar carpetas'\r\n                          : 'No hay carpetas de empleados disponibles'}\r\n                  </p>\r\n                  {!searchTerm && !Object.values(filters).some(Boolean) && !loading && employees.length > 0 && (\r\n                    <div className=\"mt-6\">\r\n                      <button\r\n                        onClick={createAllEmployeeFolders}\r\n                        disabled={loadingFolders}\r\n                        className=\"inline-flex items-center px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                      >\r\n                        {loadingFolders ? (\r\n                          <>\r\n                            <div className=\"animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3\"></div>\r\n                            Creando carpetas...\r\n                          </>\r\n                        ) : (\r\n                          <>\r\n                            <FolderIcon className=\"h-5 w-5 mr-3\" />\r\n                            Crear Carpetas para Todos los Empleados\r\n                          </>\r\n                        )}\r\n                      </button>\r\n                    </div>\r\n                  )}\r\n                  {!loading && employees.length === 0 && (\r\n                    <div className=\"mt-6\">\r\n                      <button\r\n                        onClick={loadEmployeesOnly}\r\n                        disabled={loading}\r\n                        className=\"inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                      >\r\n                        {loading ? (\r\n                          <>\r\n                            <div className=\"animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3\"></div>\r\n                            Cargando empleados...\r\n                          </>\r\n                        ) : (\r\n                          <>\r\n                            <svg className=\"h-5 w-5 mr-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\r\n                            </svg>\r\n                            Recargar Empleados\r\n                          </>\r\n                        )}\r\n                      </button>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Controles de paginaci√≥n */}\r\n          {getTotalPages() > 1 && (\r\n            <div className=\"px-6 py-4 border-t border-gray-200 bg-gray-50\">\r\n              <div className=\"pagination-controls\">\r\n                <div className=\"pagination-info text-sm text-gray-700\">\r\n                  Mostrando {Math.min((currentPage - 1) * itemsPerPage + 1, getFilteredFolders().length)} a {Math.min(currentPage * itemsPerPage, getFilteredFolders().length)} de {getFilteredFolders().length} carpetas\r\n                </div>\r\n                <div className=\"flex items-center space-x-2\">\r\n                  <button\r\n                    onClick={() => handlePageChange(currentPage - 1)}\r\n                    disabled={currentPage === 1}\r\n                    className=\"flex items-center px-3 py-1 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                  >\r\n                    <ChevronLeftIcon className=\"h-4 w-4 mr-1\" />\r\n                    Anterior\r\n                  </button>\r\n\r\n                  <div className=\"flex items-center space-x-1\">\r\n                    {Array.from({ length: Math.min(5, getTotalPages()) }, (_, i) => {\r\n                      const pageNumber = Math.max(1, Math.min(getTotalPages() - 4, currentPage - 2)) + i;\r\n                      if (pageNumber > getTotalPages()) return null;\r\n\r\n                      return (\r\n                        <button\r\n                          key={pageNumber}\r\n                          onClick={() => handlePageChange(pageNumber)}\r\n                          className={`px-3 py-1 text-sm rounded-md ${\r\n                            currentPage === pageNumber\r\n                              ? 'bg-engage-blue text-white'\r\n                              : 'bg-white border border-gray-300 hover:bg-gray-50'\r\n                          }`}\r\n                        >\r\n                          {pageNumber}\r\n                        </button>\r\n                      );\r\n                    })}\r\n                  </div>\r\n\r\n                  <button\r\n                    onClick={() => handlePageChange(currentPage + 1)}\r\n                    disabled={currentPage === getTotalPages()}\r\n                    className=\"flex items-center px-3 py-1 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                  >\r\n                    Siguiente\r\n                    <ChevronRightIcon className=\"h-4 w-4 ml-1\" />\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Vista de carpeta individual */}\r\n        {selectedFolder && (\r\n          <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50\">\r\n            <div className=\"bg-white rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto border border-gray-100\">\r\n              {/* Header Moderno */}\r\n              <div className=\"bg-gradient-to-r from-indigo-500 via-purple-600 to-pink-600 rounded-t-3xl p-8 text-white relative overflow-hidden\">\r\n                <div className=\"absolute inset-0 bg-black/10\"></div>\r\n                <div className=\"relative z-10\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <div className=\"flex items-center\">\r\n                      <div className=\"bg-white/20 p-3 rounded-full mr-4\">\r\n                        <FolderIcon className=\"h-6 w-6 text-white\" />\r\n                      </div>\r\n                      <div>\r\n                        <h2 className=\"text-2xl font-bold\">\r\n                          Carpeta de {selectedFolder.employeeName || selectedFolder.email}\r\n                        </h2>\r\n                        <div className=\"h-1 w-20 bg-white/30 rounded-full mt-1\"></div>\r\n                      </div>\r\n                    </div>\r\n                    <button\r\n                      onClick={() => setSelectedFolder(null)}\r\n                      className=\"bg-white/20 hover:bg-white/30 p-2 rounded-xl transition-all duration-300 hover:scale-105\"\r\n                    >\r\n                      <svg className=\"h-6 w-6 text-white\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\r\n                      </svg>\r\n                    </button>\r\n                  </div>\r\n                  <div className=\"flex items-center mt-4 text-sm text-indigo-200\">\r\n                    <div className=\"flex items-center mr-6\">\r\n                      <div className=\"w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse\"></div>\r\n                      {selectedFolder.knowledgeBase?.documents?.length || 0} documentos\r\n                    </div>\r\n                    <div className=\"flex items-center\">\r\n                      <div className=\"w-2 h-2 bg-blue-400 rounded-full mr-2\"></div>\r\n                      Base de conocimiento activa\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n                {/* Elementos decorativos */}\r\n                <div className=\"absolute -top-6 -right-6 w-20 h-20 bg-white/10 rounded-full\"></div>\r\n                <div className=\"absolute -bottom-4 -left-4 w-16 h-16 bg-white/10 rounded-full\"></div>\r\n              </div>\r\n              \r\n              <div className=\"p-8\">\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8 mb-8\">\r\n                  <div className=\"bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-3xl border border-blue-100 shadow-lg\">\r\n                    <div className=\"flex items-center mb-4\">\r\n                      <div className=\"bg-gradient-to-r from-blue-500 to-indigo-600 p-3 rounded-xl mr-4\">\r\n                        <UserIcon className=\"h-6 w-6 text-white\" />\r\n                      </div>\r\n                      <div>\r\n                        <h3 className=\"text-xl font-bold text-gray-900\">Informaci√≥n del Empleado</h3>\r\n                        <div className=\"h-1 w-16 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full mt-1\"></div>\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"space-y-3\">\r\n                      <div className=\"flex items-center p-3 bg-white/60 rounded-xl border border-blue-100\">\r\n                        <div className=\"w-2 h-2 bg-blue-500 rounded-full mr-3\"></div>\r\n                        <div className=\"flex-1\">\r\n                          <p className=\"text-xs font-semibold text-blue-700 uppercase tracking-wide\">Email</p>\r\n                          <p className=\"text-sm font-medium text-gray-900\">{selectedFolder.email}</p>\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"flex items-center p-3 bg-white/60 rounded-xl border border-blue-100\">\r\n                        <div className=\"w-2 h-2 bg-green-500 rounded-full mr-3\"></div>\r\n                        <div className=\"flex-1\">\r\n                          <p className=\"text-xs font-semibold text-green-700 uppercase tracking-wide\">Nombre</p>\r\n                          <p className=\"text-sm font-medium text-gray-900\">{selectedFolder.employeeName || 'No especificado'}</p>\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"flex items-center p-3 bg-white/60 rounded-xl border border-blue-100\">\r\n                        <div className=\"w-2 h-2 bg-purple-500 rounded-full mr-3\"></div>\r\n                        <div className=\"flex-1\">\r\n                          <p className=\"text-xs font-semibold text-purple-700 uppercase tracking-wide\">Empresa</p>\r\n                          <p className=\"text-sm font-medium text-gray-900\">{selectedFolder.companyName}</p>\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"flex items-center p-3 bg-white/60 rounded-xl border border-blue-100\">\r\n                        <div className=\"w-2 h-2 bg-orange-500 rounded-full mr-3\"></div>\r\n                        <div className=\"flex-1\">\r\n                          <p className=\"text-xs font-semibold text-orange-700 uppercase tracking-wide\">Departamento</p>\r\n                          <p className=\"text-sm font-medium text-gray-900\">{selectedFolder.employeeDepartment || 'No especificado'}</p>\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"flex items-center p-3 bg-white/60 rounded-xl border border-blue-100\">\r\n                        <div className=\"w-2 h-2 bg-pink-500 rounded-full mr-3\"></div>\r\n                        <div className=\"flex-1\">\r\n                          <p className=\"text-xs font-semibold text-pink-700 uppercase tracking-wide\">Cargo</p>\r\n                          <p className=\"text-sm font-medium text-gray-900\">{selectedFolder.employeePosition || 'No especificado'}</p>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div className=\"bg-gradient-to-br from-emerald-50 to-teal-50 p-6 rounded-3xl border border-emerald-100 shadow-lg\">\r\n                    <div className=\"flex items-center mb-4\">\r\n                      <div className=\"bg-gradient-to-r from-emerald-500 to-teal-600 p-3 rounded-xl mr-4\">\r\n                        <svg className=\"h-6 w-6 text-white\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z\" />\r\n                        </svg>\r\n                      </div>\r\n                      <div>\r\n                        <h3 className=\"text-xl font-bold text-gray-900\">Estad√≠sticas de Conocimiento</h3>\r\n                        <div className=\"h-1 w-20 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-full mt-1\"></div>\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"space-y-3\">\r\n                      <div className=\"flex items-center justify-between p-3 bg-white/60 rounded-xl border border-emerald-100\">\r\n                        <div className=\"flex items-center\">\r\n                          <div className=\"w-3 h-3 bg-blue-500 rounded-full mr-3\"></div>\r\n                          <span className=\"text-sm font-medium text-gray-900\">FAQs</span>\r\n                        </div>\r\n                        <span className=\"text-lg font-bold text-blue-600\">{selectedFolder.knowledgeBase?.faqs?.length || 0}</span>\r\n                      </div>\r\n                      <div className=\"flex items-center justify-between p-3 bg-white/60 rounded-xl border border-emerald-100\">\r\n                        <div className=\"flex items-center\">\r\n                          <div className=\"w-3 h-3 bg-green-500 rounded-full mr-3\"></div>\r\n                          <span className=\"text-sm font-medium text-gray-900\">Documentos</span>\r\n                        </div>\r\n                        <span className=\"text-lg font-bold text-green-600\">{selectedFolder.knowledgeBase?.documents?.length || 0}</span>\r\n                      </div>\r\n                      <div className=\"flex items-center justify-between p-3 bg-white/60 rounded-xl border border-emerald-100\">\r\n                        <div className=\"flex items-center\">\r\n                          <div className=\"w-3 h-3 bg-purple-500 rounded-full mr-3\"></div>\r\n                          <span className=\"text-sm font-medium text-gray-900\">Pol√≠ticas</span>\r\n                        </div>\r\n                        <span className=\"text-lg font-bold text-purple-600\">{selectedFolder.knowledgeBase?.policies?.length || 0}</span>\r\n                      </div>\r\n                      <div className=\"flex items-center justify-between p-3 bg-white/60 rounded-xl border border-emerald-100\">\r\n                        <div className=\"flex items-center\">\r\n                          <div className=\"w-3 h-3 bg-orange-500 rounded-full mr-3\"></div>\r\n                          <span className=\"text-sm font-medium text-gray-900\">Procedimientos</span>\r\n                        </div>\r\n                        <span className=\"text-lg font-bold text-orange-600\">{selectedFolder.knowledgeBase?.procedures?.length || 0}</span>\r\n                      </div>\r\n                      <div className=\"flex items-center justify-between p-3 bg-white/60 rounded-xl border border-emerald-100\">\r\n                        <div className=\"flex items-center\">\r\n                          <div className=\"w-3 h-3 bg-gray-500 rounded-full mr-3\"></div>\r\n                          <span className=\"text-sm font-medium text-gray-900\">√öltima actualizaci√≥n</span>\r\n                        </div>\r\n                        <span className=\"text-sm font-medium text-gray-600\">{new Date(selectedFolder.lastUpdated).toLocaleDateString()}</span>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n                \r\n                {/* Archivos en la carpeta */}\r\n                <div className=\"border-t border-gray-200 pt-8\">\r\n                  <div className=\"flex items-center mb-6\">\r\n                    <div className=\"bg-gradient-to-r from-cyan-500 to-blue-600 p-3 rounded-xl mr-4\">\r\n                      <DocumentIcon className=\"h-6 w-6 text-white\" />\r\n                    </div>\r\n                    <div>\r\n                      <h3 className=\"text-2xl font-bold text-gray-900\">Archivos en la Carpeta</h3>\r\n                      <div className=\"h-1 w-20 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-full mt-1\"></div>\r\n                      <p className=\"text-sm text-gray-600 mt-1\">Documentos y recursos disponibles</p>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {selectedFolder.knowledgeBase?.documents && selectedFolder.knowledgeBase.documents.length > 0 ? (\r\n                    <div className=\"space-y-4\">\r\n                      {selectedFolder.knowledgeBase.documents.map((doc, index) => (\r\n                        <div key={index} className=\"bg-gradient-to-r from-gray-50 to-blue-50 p-6 rounded-3xl border border-gray-200 shadow-lg hover:shadow-xl transition-all duration-300\">\r\n                          <div className=\"flex items-start justify-between\">\r\n                            <div className=\"flex-1\">\r\n                              <div className=\"flex items-center mb-3\">\r\n                                <div className=\"w-3 h-3 bg-blue-500 rounded-full mr-3\"></div>\r\n                                <h4 className=\"text-lg font-bold text-gray-900\">{doc.name}</h4>\r\n                              </div>\r\n                              {doc.description && (\r\n                                <p className=\"text-sm text-gray-600 mb-4 ml-6\">{doc.description}</p>\r\n                              )}\r\n                              <div className=\"flex items-center text-xs text-gray-500 ml-6\">\r\n                                <div className=\"flex items-center mr-4\">\r\n                                  <svg className=\"w-4 h-4 mr-1 text-blue-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\r\n                                  </svg>\r\n                                  Documento\r\n                                </div>\r\n                                <div className=\"flex items-center mr-4\">\r\n                                  <svg className=\"w-4 h-4 mr-1 text-green-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\r\n                                  </svg>\r\n                                  {new Date().toLocaleDateString()}\r\n                                </div>\r\n                                {doc.fileSize && (\r\n                                  <div className=\"flex items-center\">\r\n                                    <svg className=\"w-4 h-4 mr-1 text-purple-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 4V2a1 1 0 011-1h4a1 1 0 011 1v2m4 0H8l.5 16h7L16 4z\" />\r\n                                    </svg>\r\n                                    {(doc.fileSize / 1024).toFixed(1)} KB\r\n                                  </div>\r\n                                )}\r\n                              </div>\r\n                            </div>\r\n                            <div className=\"flex items-center space-x-3\">\r\n                              <button\r\n                                onClick={() => {\r\n                                  // Mostrar contenido del archivo en un modal moderno\r\n                                  MySwal.fire({\r\n                                    title: `<div class=\"flex items-center\"><div class=\"bg-gradient-to-r from-blue-500 to-cyan-600 p-2 rounded-lg mr-3\"><svg class=\"w-6 h-6 text-white\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"></path></svg></div>${doc.name}</div>`,\r\n                                    html: `<div class=\"text-left max-h-96 overflow-y-auto bg-gray-50 p-4 rounded-lg\"><pre class=\"whitespace-pre-wrap text-sm font-mono text-gray-800\">${doc.content}</pre></div>`,\r\n                                    width: '900px',\r\n                                    showConfirmButton: false,\r\n                                    showCloseButton: true,\r\n                                    customClass: {\r\n                                      popup: 'rounded-3xl shadow-2xl border border-gray-200',\r\n                                      closeButton: 'text-gray-400 hover:text-gray-600 transition-colors'\r\n                                    }\r\n                                  });\r\n                                }}\r\n                                className=\"inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white font-medium rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                              >\r\n                                <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\r\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z\" />\r\n                                </svg>\r\n                                Ver Contenido\r\n                              </button>\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  ) : (\r\n                    <div className=\"text-center py-16 bg-gradient-to-r from-gray-50 to-blue-50 rounded-3xl border border-gray-200\">\r\n                      <div className=\"bg-gradient-to-r from-blue-500 to-cyan-600 p-6 rounded-full w-24 h-24 mx-auto mb-6 flex items-center justify-center shadow-2xl\">\r\n                        <DocumentIcon className=\"h-12 w-12 text-white\" />\r\n                      </div>\r\n                      <h4 className=\"text-2xl font-bold text-gray-900 mb-4\">No hay archivos en esta carpeta</h4>\r\n                      <p className=\"text-gray-600 text-lg max-w-md mx-auto leading-relaxed\">\r\n                        Los archivos subidos aparecer√°n aqu√≠ una vez que se agreguen documentos a la base de conocimiento del empleado.\r\n                      </p>\r\n                    </div>\r\n                  )}\r\n\r\n                  <div className=\"mt-8 flex justify-end\">\r\n                    <button\r\n                      onClick={() => setSelectedFolder(null)}\r\n                      className=\"inline-flex items-center px-6 py-3 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                    >\r\n                      <svg className=\"w-5 h-5 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\r\n                      </svg>\r\n                      Cerrar Carpeta\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default EmployeeFolders;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\communication\\EmployeeSelector.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'applyFilters'. Either include it or remove the dependency array.","line":60,"column":6,"nodeType":"ArrayExpression","endLine":60,"endColumn":26,"suggestions":[{"desc":"Update the dependencies array to be: [applyFilters, employees, filters]","fix":{"range":[2169,2189],"text":"[applyFilters, employees, filters]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'extractUniqueFilters'. Either include it or remove the dependency array.","line":66,"column":6,"nodeType":"ArrayExpression","endLine":66,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [employees, extractUniqueFilters]","fix":{"range":[2406,2417],"text":"[employees, extractUniqueFilters]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { UserIcon, FunnelIcon, ArrowPathIcon } from '@heroicons/react/24/outline';\r\nimport Swal from 'sweetalert2';\r\nimport withReactContent from 'sweetalert2-react-content';\r\nimport organizedDatabaseService from '../../services/organizedDatabaseService.js';\r\nimport {\r\n  getSimulatedWhatsApp,\r\n  getSimulatedTelegram,\r\n  getSimulatedSMS,\r\n  getSimulatedMailing\r\n} from '../../utils/communicationUtils.js';\r\n\r\nconst MySwal = withReactContent(Swal);\r\n\r\nconst EmployeeSelector = () => {\r\n  const navigate = useNavigate();\r\n  const [employees, setEmployees] = useState([]);\r\n  const [filteredEmployees, setFilteredEmployees] = useState([]);\r\n  const [companies, setCompanies] = useState([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [selectedEmployees, setSelectedEmployees] = useState(new Set());\r\n  const [filters, setFilters] = useState({\r\n    companyId: '',\r\n    region: '',\r\n    department: '',\r\n    level: '',\r\n    workMode: '',\r\n    contractType: ''\r\n  });\r\n\r\n  // Filtros √∫nicos para los dropdowns\r\n  const [uniqueRegions, setUniqueRegions] = useState([]);\r\n  const [uniqueDepartments, setUniqueDepartments] = useState([]);\r\n  const [uniqueLevels, setUniqueLevels] = useState([]);\r\n  const [uniqueWorkModes, setUniqueWorkModes] = useState([]);\r\n  const [uniqueContractTypes, setUniqueContractTypes] = useState([]);\r\n\r\n  // Paginaci√≥n\r\n  const [currentPage, setCurrentPage] = useState(1);\r\n  const itemsPerPage = 20;\r\n\r\n  useEffect(() => {\r\n    loadEmployees();\r\n    loadCompanies();\r\n    \r\n    // Si hay datos temporales de empleados seleccionados, cargarlos\r\n    if (window.tempSelectedEmployees) {\r\n      const tempSelected = new Set(window.tempSelectedEmployees);\r\n      setSelectedEmployees(tempSelected);\r\n      delete window.tempSelectedEmployees;\r\n    }\r\n  }, []);\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\nuseEffect(() => {\r\n    applyFilters();\r\n    setCurrentPage(1); // Reset to first page when filters change\r\n  }, [employees, filters]);\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\nuseEffect(() => {\r\n    extractUniqueFilters();\r\n  }, [employees]);\r\n\r\n  const loadEmployees = async () => {\r\n    try {\r\n      setLoading(true);\r\n      const employeeData = await organizedDatabaseService.getEmployees();\r\n      setEmployees(employeeData);\r\n      setFilteredEmployees(employeeData);\r\n    } catch (error) {\r\n      console.error('Error loading employees:', error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const loadCompanies = async () => {\r\n    try {\r\n      const companyData = await organizedDatabaseService.getCompanies();\r\n      setCompanies(companyData);\r\n    } catch (error) {\r\n      console.error('Error loading companies:', error);\r\n    }\r\n  };\r\n\r\n  const extractUniqueFilters = () => {\r\n    const regions = [...new Set(employees.map(emp => emp.region))];\r\n    const departments = [...new Set(employees.map(emp => emp.department))];\r\n    const levels = [...new Set(employees.map(emp => emp.level))];\r\n    const workModes = [...new Set(employees.map(emp => emp.work_mode))];\r\n    const contractTypes = [...new Set(employees.map(emp => emp.contract_type))];\r\n    \r\n    setUniqueRegions(regions.sort());\r\n    setUniqueDepartments(departments.sort());\r\n    setUniqueLevels(levels.sort());\r\n    setUniqueWorkModes(workModes.sort());\r\n    setUniqueContractTypes(contractTypes.sort());\r\n  };\r\n\r\n  const applyFilters = () => {\r\n    let result = [...employees];\r\n    \r\n    if (filters.companyId) {\r\n      result = result.filter(emp => emp.company_id === filters.companyId);\r\n    }\r\n    \r\n    if (filters.region) {\r\n      result = result.filter(emp => emp.region === filters.region);\r\n    }\r\n    \r\n    if (filters.department) {\r\n      result = result.filter(emp => emp.department === filters.department);\r\n    }\r\n    \r\n    if (filters.level) {\r\n      result = result.filter(emp => emp.level === filters.level);\r\n    }\r\n    \r\n    if (filters.workMode) {\r\n      result = result.filter(emp => emp.work_mode === filters.workMode);\r\n    }\r\n    \r\n    if (filters.contractType) {\r\n      result = result.filter(emp => emp.contract_type === filters.contractType);\r\n    }\r\n    \r\n    setFilteredEmployees(result);\r\n  };\r\n\r\n  const handleFilterChange = (filterName, value) => {\r\n    setFilters(prev => ({\r\n      ...prev,\r\n      [filterName]: value\r\n    }));\r\n  };\r\n\r\n  const handleSelectEmployee = (employeeId) => {\r\n    const newSelected = new Set(selectedEmployees);\r\n    if (newSelected.has(employeeId)) {\r\n      newSelected.delete(employeeId);\r\n    } else {\r\n      newSelected.add(employeeId);\r\n    }\r\n    setSelectedEmployees(newSelected);\r\n  };\r\n\r\n  const handleSelectAll = () => {\r\n    if (selectedEmployees.size === filteredEmployees.length) {\r\n      // Deseleccionar todos\r\n      setSelectedEmployees(new Set());\r\n    } else {\r\n      // Seleccionar todos los filtrados\r\n      const allIds = new Set(filteredEmployees.map(emp => emp.id));\r\n      setSelectedEmployees(allIds);\r\n    }\r\n  };\r\n\r\n  const handleClearFilters = () => {\r\n    setFilters({\r\n      companyId: '',\r\n      region: '',\r\n      department: '',\r\n      level: '',\r\n      workMode: '',\r\n      contractType: ''\r\n    });\r\n    setCurrentPage(1);\r\n  };\r\n\r\n  // Funciones de paginaci√≥n\r\n  const totalPages = Math.ceil(filteredEmployees.length / itemsPerPage);\r\n  const startIndex = (currentPage - 1) * itemsPerPage;\r\n  const endIndex = startIndex + itemsPerPage;\r\n  const paginatedEmployees = filteredEmployees.slice(startIndex, endIndex);\r\n\r\n  const handlePageChange = (page) => {\r\n    setCurrentPage(page);\r\n  };\r\n\r\n  const handlePrevPage = () => {\r\n    if (currentPage > 1) {\r\n      setCurrentPage(currentPage - 1);\r\n    }\r\n  };\r\n\r\n  const handleNextPage = () => {\r\n    if (currentPage < totalPages) {\r\n      setCurrentPage(currentPage + 1);\r\n    }\r\n  };\r\n\r\n  const handleSyncEmployees = async () => {\r\n    try {\r\n      setLoading(true);\r\n      // Ya no necesitamos sincronizar empleados ya que usamos datos reales de la BD\r\n      await organizedDatabaseService.getEmployees();\r\n      await loadEmployees();\r\n      \r\n      // Mostrar alerta de √©xito\r\n      MySwal.fire({\r\n        title: '¬°√âxito!',\r\n        text: 'Empleados sincronizados correctamente',\r\n        icon: 'success',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    } catch (error) {\r\n      console.error('Error syncing employees:', error);\r\n      \r\n      // Mostrar alerta de error\r\n      MySwal.fire({\r\n        title: 'Error',\r\n        text: 'Hubo un problema al sincronizar los empleados',\r\n        icon: 'error',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleSendMessages = async () => {\r\n    if (selectedEmployees.size > 0) {\r\n      try {\r\n        // Obtener los datos completos de los empleados seleccionados\r\n        const selectedEmployeeIds = Array.from(selectedEmployees);\r\n        \r\n        console.log('Navegando a /communication/send con:', selectedEmployeeIds);\r\n        \r\n        // Navegar a la p√°gina de env√≠o de mensajes pasando los IDs de empleados\r\n        navigate('/communication/send', { \r\n          state: { selectedEmployees: selectedEmployeeIds } \r\n        });\r\n      } catch (error) {\r\n        console.error('Error preparing employee data:', error);\r\n        MySwal.fire({\r\n          title: 'Error',\r\n          text: 'Hubo un problema al preparar los datos de los empleados seleccionados',\r\n          icon: 'error',\r\n          confirmButtonText: 'Aceptar',\r\n          confirmButtonColor: '#0693e3'\r\n        });\r\n      }\r\n    } else {\r\n      // Mostrar alerta de advertencia con SweetAlert\r\n      MySwal.fire({\r\n        title: 'Advertencia',\r\n        text: 'Debe seleccionar al menos un empleado para enviar mensajes',\r\n        icon: 'warning',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#fcb900'\r\n      });\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-engage-blue mx-auto\"></div>\r\n          <p className=\"mt-4 text-gray-600\">Cargando empleados...</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-50 via-white to-blue-50\">\r\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\r\n        {/* Header Moderno */}\r\n        <div className=\"bg-gradient-to-r from-engage-blue via-blue-600 to-engage-yellow rounded-3xl shadow-2xl p-8 mb-8 text-white relative overflow-hidden\">\r\n          <div className=\"absolute inset-0 bg-black/10\"></div>\r\n          <div className=\"relative z-10\">\r\n            <div className=\"flex flex-col lg:flex-row lg:items-center lg:justify-between\">\r\n              <div className=\"mb-6 lg:mb-0\">\r\n                <div className=\"flex items-center mb-3\">\r\n                  <div className=\"bg-white/20 p-3 rounded-full mr-4\">\r\n                    <UserIcon className=\"h-8 w-8 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h1 className=\"text-4xl font-bold mb-1\">\r\n                      Base de Datos de Empleados\r\n                    </h1>\r\n                    <div className=\"h-1 w-20 bg-white/30 rounded-full\"></div>\r\n                  </div>\r\n                </div>\r\n                <p className=\"text-blue-100 text-lg font-medium\">\r\n                  Seleccione empleados para enviar mensajes masivos personalizados\r\n                </p>\r\n                <div className=\"flex items-center mt-4 text-sm text-blue-200\">\r\n                  <div className=\"flex items-center mr-6\">\r\n                    <div className=\"w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse\"></div>\r\n                    {filteredEmployees.length} empleados disponibles\r\n                  </div>\r\n                  <div className=\"flex items-center\">\r\n                    <div className=\"w-2 h-2 bg-yellow-400 rounded-full mr-2\"></div>\r\n                    {selectedEmployees.size} empleados seleccionados\r\n                  </div>\r\n                </div>\r\n              </div>\r\n              <div className=\"flex flex-col sm:flex-row gap-4\">\r\n                <button\r\n                  onClick={handleSyncEmployees}\r\n                  className=\"inline-flex items-center px-6 py-3 bg-white/10 hover:bg-white/20 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl backdrop-blur-sm border border-white/20\"\r\n                >\r\n                  <ArrowPathIcon className=\"h-5 w-5 mr-3\" />\r\n                  Sincronizar Empleados\r\n                </button>\r\n                <button\r\n                  onClick={handleSendMessages}\r\n                  className={`inline-flex items-center px-6 py-3 font-bold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl ${\r\n                    selectedEmployees.size === 0\r\n                      ? 'bg-white/10 text-white/50 cursor-not-allowed backdrop-blur-sm'\r\n                      : 'bg-white hover:bg-yellow-50 text-engage-black transform hover:scale-105'\r\n                  }`}\r\n                >\r\n                  <svg className=\"w-5 h-5 mr-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 19l9 2-9-18-9 18 9-2zm0 0v-8\" />\r\n                  </svg>\r\n                  Enviar Mensajes ({selectedEmployees.size})\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          {/* Elementos decorativos */}\r\n          <div className=\"absolute -top-10 -right-10 w-32 h-32 bg-white/10 rounded-full\"></div>\r\n          <div className=\"absolute -bottom-8 -left-8 w-24 h-24 bg-white/10 rounded-full\"></div>\r\n        </div>\r\n\r\n        {/* Filtros */}\r\n        <div className=\"bg-white rounded-3xl shadow-2xl p-8 mb-8 border border-gray-100 relative overflow-hidden\">\r\n          <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-engage-blue via-blue-500 to-engage-yellow\"></div>\r\n          <div className=\"flex justify-between items-center mb-6\">\r\n            <div className=\"flex items-center\">\r\n              <div className=\"bg-gradient-to-r from-engage-blue to-blue-600 p-3 rounded-xl mr-4\">\r\n                <FunnelIcon className=\"h-6 w-6 text-white\" />\r\n              </div>\r\n              <div>\r\n                <h2 className=\"text-2xl font-bold text-gray-900\">Filtros Avanzados</h2>\r\n                <p className=\"text-sm text-gray-600\">Refina tu b√∫squeda de empleados</p>\r\n              </div>\r\n            </div>\r\n            <button\r\n              onClick={handleClearFilters}\r\n              className=\"inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-all duration-300 hover:shadow-md\"\r\n            >\r\n              <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\r\n              </svg>\r\n              Limpiar filtros\r\n            </button>\r\n          </div>\r\n          \r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-1\">Empresa</label>\r\n              <select\r\n                value={filters.companyId}\r\n                onChange={(e) => handleFilterChange('companyId', e.target.value)}\r\n                className=\"w-full rounded-lg border-gray-300 shadow-sm focus:border-engage-blue focus:ring-engage-blue\"\r\n              >\r\n                <option value=\"\">Todas las empresas</option>\r\n                {companies.map(company => (\r\n                  <option key={company.id} value={company.id}>{company.name}</option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n            \r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-1\">Regi√≥n</label>\r\n              <select\r\n                value={filters.region}\r\n                onChange={(e) => handleFilterChange('region', e.target.value)}\r\n                className=\"w-full rounded-lg border-gray-300 shadow-sm focus:border-engage-blue focus:ring-engage-blue\"\r\n              >\r\n                <option value=\"\">Todas las regiones</option>\r\n                {uniqueRegions.map(region => (\r\n                  <option key={region} value={region}>{region}</option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n            \r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-1\">Departamento</label>\r\n              <select\r\n                value={filters.department}\r\n                onChange={(e) => handleFilterChange('department', e.target.value)}\r\n                className=\"w-full rounded-lg border-gray-300 shadow-sm focus:border-engage-blue focus:ring-engage-blue\"\r\n              >\r\n                <option value=\"\">Todos los departamentos</option>\r\n                {uniqueDepartments.map(dept => (\r\n                  <option key={dept} value={dept}>{dept}</option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n            \r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-1\">Nivel</label>\r\n              <select\r\n                value={filters.level}\r\n                onChange={(e) => handleFilterChange('level', e.target.value)}\r\n                className=\"w-full rounded-lg border-gray-300 shadow-sm focus:border-engage-blue focus:ring-engage-blue\"\r\n              >\r\n                <option value=\"\">Todos los niveles</option>\r\n                {uniqueLevels.map(level => (\r\n                  <option key={level} value={level}>{level}</option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n            \r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-1\">Modalidad</label>\r\n              <select\r\n                value={filters.workMode}\r\n                onChange={(e) => handleFilterChange('workMode', e.target.value)}\r\n                className=\"w-full rounded-lg border-gray-300 shadow-sm focus:border-engage-blue focus:ring-engage-blue\"\r\n              >\r\n                <option value=\"\">Todas las modalidades</option>\r\n                {uniqueWorkModes.map(mode => (\r\n                  <option key={mode} value={mode}>{mode}</option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n            \r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-1\">Tipo de Contrato</label>\r\n              <select\r\n                value={filters.contractType}\r\n                onChange={(e) => handleFilterChange('contractType', e.target.value)}\r\n                className=\"w-full rounded-lg border-gray-300 shadow-sm focus:border-engage-blue focus:ring-engage-blue\"\r\n              >\r\n                <option value=\"\">Todos los tipos</option>\r\n                {uniqueContractTypes.map(type => (\r\n                  <option key={type} value={type}>{type}</option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Lista de empleados */}\r\n        <div className=\"bg-white rounded-3xl shadow-2xl p-8 border border-gray-100 relative overflow-hidden\">\r\n          <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-engage-blue via-blue-500 to-engage-yellow\"></div>\r\n          <div className=\"flex flex-col lg:flex-row lg:justify-between lg:items-center mb-8\">\r\n            <div className=\"flex items-center mb-4 lg:mb-0\">\r\n              <div className=\"bg-gradient-to-r from-engage-blue to-blue-600 p-3 rounded-xl mr-4\">\r\n                <UserIcon className=\"h-6 w-6 text-white\" />\r\n              </div>\r\n              <div>\r\n                <h2 className=\"text-2xl font-bold text-gray-900\">Empleados Disponibles</h2>\r\n                <p className=\"text-sm text-gray-600\">{filteredEmployees.length} empleados encontrados</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex flex-col sm:flex-row items-start sm:items-center gap-4\">\r\n              <div className=\"flex items-center space-x-4\">\r\n                <div className=\"flex items-center bg-blue-50 px-3 py-1 rounded-full\">\r\n                  <div className=\"w-2 h-2 bg-blue-500 rounded-full mr-2\"></div>\r\n                  <span className=\"text-sm font-medium text-blue-700\">{selectedEmployees.size} seleccionados</span>\r\n                </div>\r\n                <button\r\n                  onClick={handleSelectAll}\r\n                  className=\"text-sm text-engage-blue hover:text-engage-yellow font-medium transition-colors duration-300\"\r\n                >\r\n                  {selectedEmployees.size === filteredEmployees.length ? 'Deseleccionar todos' : 'Seleccionar todos'}\r\n                </button>\r\n              </div>\r\n              <div className=\"text-sm text-gray-500 bg-gray-50 px-3 py-1 rounded-lg\">\r\n                P√°gina {currentPage} de {totalPages} ‚Ä¢ {startIndex + 1}-{Math.min(endIndex, filteredEmployees.length)} de {filteredEmployees.length}\r\n              </div>\r\n            </div>\r\n          </div>\r\n          \r\n          <div className=\"overflow-x-auto\">\r\n            <table className=\"min-w-full divide-y divide-gray-200\">\r\n              <thead className=\"bg-gray-50\">\r\n                <tr>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      checked={selectedEmployees.size === filteredEmployees.length && filteredEmployees.length > 0}\r\n                      onChange={handleSelectAll}\r\n                      className=\"h-4 w-4 text-engage-blue border-gray-300 rounded focus:ring-engage-blue\"\r\n                    />\r\n                  </th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    Nombre\r\n                  </th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    Empresa\r\n                  </th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    Departamento\r\n                  </th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    Email\r\n                  </th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    WhatsApp\r\n                  </th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    Telegram\r\n                  </th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    SMS\r\n                  </th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    Mailing\r\n                  </th>\r\n                </tr>\r\n              </thead>\r\n              <tbody className=\"bg-white divide-y divide-gray-100\">\r\n                {paginatedEmployees.map((employee) => (\r\n                  <tr\r\n                    key={employee.id}\r\n                    className={`hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer transition-all duration-300 transform hover:scale-[1.01] ${selectedEmployees.has(employee.id) ? 'bg-gradient-to-r from-blue-100 to-indigo-100 shadow-md' : ''}`}\r\n                    onClick={() => handleSelectEmployee(employee.id)}\r\n                  >\r\n                    <td className=\"px-6 py-5 whitespace-nowrap\">\r\n                      <div className=\"flex items-center\">\r\n                        <input\r\n                          type=\"checkbox\"\r\n                          checked={selectedEmployees.has(employee.id)}\r\n                          onChange={() => handleSelectEmployee(employee.id)}\r\n                          className=\"h-5 w-5 text-engage-blue border-gray-300 rounded focus:ring-engage-blue transition-all duration-300\"\r\n                        />\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"px-6 py-5 whitespace-nowrap\">\r\n                      <div className=\"flex items-center\">\r\n                        <div className=\"flex-shrink-0 h-12 w-12 rounded-full bg-gradient-to-r from-engage-blue to-blue-600 flex items-center justify-center shadow-lg\">\r\n                          <span className=\"text-white font-bold text-sm\">\r\n                            {employee.first_name ? employee.first_name.charAt(0) : '?'}\r\n                          </span>\r\n                        </div>\r\n                        <div className=\"ml-4\">\r\n                          <div className=\"text-sm font-semibold text-gray-900\">\r\n                            {employee.first_name && employee.last_name\r\n                              ? `${employee.first_name} ${employee.last_name}`\r\n                              : employee.first_name || employee.last_name || 'Sin nombre'}\r\n                          </div>\r\n                          <div className=\"text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full inline-block mt-1\">\r\n                            {employee.position || 'Sin posici√≥n'}\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"px-6 py-5 whitespace-nowrap\">\r\n                      <div className=\"text-sm font-medium text-gray-900 bg-gray-100 px-3 py-1 rounded-full inline-block\">\r\n                        {employee.companies?.name || 'N/A'}\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"px-6 py-5 whitespace-nowrap\">\r\n                      <div className=\"text-sm text-gray-900 bg-blue-50 text-blue-700 px-3 py-1 rounded-full inline-block font-medium\">\r\n                        {employee.department || 'Sin departamento'}\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"px-6 py-5 whitespace-nowrap\">\r\n                      <div className=\"flex items-center space-x-2\">\r\n                        <div className={`w-2 h-2 rounded-full ${employee.email ? 'bg-green-500' : 'bg-gray-300'}`}></div>\r\n                        <div className=\"text-sm text-gray-900 font-medium\">{employee.email || 'Sin email'}</div>\r\n                        {employee.email && (\r\n                          <span className=\"text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full\">Activo</span>\r\n                        )}\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"px-6 py-5 whitespace-nowrap\">\r\n                      <div className=\"flex items-center space-x-2\">\r\n                        <div className={`w-2 h-2 rounded-full ${getSimulatedWhatsApp(employee).enabled ? 'bg-green-500' : 'bg-gray-300'}`}></div>\r\n                        <div className=\"text-sm text-gray-900\">{getSimulatedWhatsApp(employee).phone}</div>\r\n                        {getSimulatedWhatsApp(employee).enabled && (\r\n                          <svg className=\"w-4 h-4 text-green-600\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path d=\"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.149-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414-.074-.123-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z\"/>\r\n                          </svg>\r\n                        )}\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"px-6 py-5 whitespace-nowrap\">\r\n                      <div className=\"flex items-center space-x-2\">\r\n                        <div className={`w-2 h-2 rounded-full ${getSimulatedTelegram(employee).enabled ? 'bg-green-500' : 'bg-gray-300'}`}></div>\r\n                        <div className=\"text-sm text-gray-900\">\r\n                          {getSimulatedTelegram(employee).username}\r\n                        </div>\r\n                        {getSimulatedTelegram(employee).enabled && (\r\n                          <svg className=\"w-4 h-4 text-blue-500\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path d=\"M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002 0-.003 0-.005 0l.213-3.054 5.56-5.022c.24-.213-.054-.334-.373-.121l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z\"/>\r\n                          </svg>\r\n                        )}\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"px-6 py-5 whitespace-nowrap\">\r\n                      <div className=\"flex items-center space-x-2\">\r\n                        <div className={`w-2 h-2 rounded-full ${getSimulatedSMS(employee).enabled ? 'bg-green-500' : 'bg-gray-300'}`}></div>\r\n                        <div className=\"text-sm text-gray-900\">{getSimulatedSMS(employee).phone}</div>\r\n                        {getSimulatedSMS(employee).enabled && (\r\n                          <svg className=\"w-4 h-4 text-orange-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z\" />\r\n                          </svg>\r\n                        )}\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"px-6 py-5 whitespace-nowrap\">\r\n                      <div className=\"flex items-center space-x-2\">\r\n                        <div className={`w-2 h-2 rounded-full ${getSimulatedMailing(employee).enabled ? 'bg-green-500' : 'bg-gray-300'}`}></div>\r\n                        <div className=\"text-sm text-gray-900\">\r\n                          {getSimulatedMailing(employee).status}\r\n                        </div>\r\n                        {getSimulatedMailing(employee).enabled && (\r\n                          <svg className=\"w-4 h-4 text-purple-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\" />\r\n                          </svg>\r\n                        )}\r\n                      </div>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n\r\n          {/* Paginaci√≥n Moderna */}\r\n          {totalPages > 1 && (\r\n            <div className=\"flex flex-col sm:flex-row items-center justify-between px-8 py-6 bg-gradient-to-r from-gray-50 to-blue-50 border-t border-gray-200\">\r\n              <div className=\"flex items-center space-x-3 mb-4 sm:mb-0\">\r\n                <button\r\n                  onClick={handlePrevPage}\r\n                  disabled={currentPage === 1}\r\n                  className=\"inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 shadow-sm hover:shadow-md\"\r\n                >\r\n                  <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\r\n                  </svg>\r\n                  Anterior\r\n                </button>\r\n\r\n                {/* N√∫meros de p√°gina */}\r\n                <div className=\"flex space-x-2\">\r\n                  {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {\r\n                    let pageNum;\r\n                    if (totalPages <= 5) {\r\n                      pageNum = i + 1;\r\n                    } else if (currentPage <= 3) {\r\n                      pageNum = i + 1;\r\n                    } else if (currentPage >= totalPages - 2) {\r\n                      pageNum = totalPages - 4 + i;\r\n                    } else {\r\n                      pageNum = currentPage - 2 + i;\r\n                    }\r\n\r\n                    return (\r\n                      <button\r\n                        key={pageNum}\r\n                        onClick={() => handlePageChange(pageNum)}\r\n                        className={`px-4 py-2 text-sm font-medium rounded-lg transition-all duration-300 ${\r\n                          currentPage === pageNum\r\n                            ? 'bg-gradient-to-r from-engage-blue to-blue-600 text-white shadow-lg transform scale-105'\r\n                            : 'text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 hover:shadow-md'\r\n                        }`}\r\n                      >\r\n                        {pageNum}\r\n                      </button>\r\n                    );\r\n                  })}\r\n                </div>\r\n\r\n                <button\r\n                  onClick={handleNextPage}\r\n                  disabled={currentPage === totalPages}\r\n                  className=\"inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 shadow-sm hover:shadow-md\"\r\n                >\r\n                  Siguiente\r\n                  <svg className=\"w-4 h-4 ml-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\r\n                  </svg>\r\n                </button>\r\n              </div>\r\n\r\n              <div className=\"bg-white px-4 py-2 rounded-lg shadow-sm border border-gray-200\">\r\n                <span className=\"text-sm font-medium text-gray-700\">\r\n                  P√°gina <span className=\"text-engage-blue font-bold\">{currentPage}</span> de <span className=\"font-bold\">{totalPages}</span>\r\n                </span>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {filteredEmployees.length === 0 && (\r\n            <div className=\"text-center py-12\">\r\n              <UserIcon className=\"mx-auto h-12 w-12 text-gray-400\" />\r\n              <h3 className=\"mt-2 text-sm font-medium text-gray-900\">No se encontraron empleados</h3>\r\n              <p className=\"mt-1 text-sm text-gray-500\">\r\n                Intente ajustar los filtros o sincronizar los empleados.\r\n              </p>\r\n              <div className=\"mt-6\">\r\n                <button\r\n                  onClick={handleSyncEmployees}\r\n                  className=\"inline-flex items-center px-4 py-2 bg-engage-blue hover:bg-engage-yellow text-white font-bold rounded-lg transition-all duration-300\"\r\n                >\r\n                  <ArrowPathIcon className=\"h-5 w-5 mr-2\" />\r\n                  Sincronizar Empleados\r\n                </button>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default EmployeeSelector;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\communication\\ReportsDashboard.js","messages":[{"ruleId":"no-use-before-define","severity":1,"message":"'loadReports' was used before it was defined.","line":187,"column":34,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":187,"endColumn":45},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'loadReports' function makes the dependencies of useEffect Hook (at line 187) change on every render. Move it inside the useEffect callback. Alternatively, wrap the definition of 'loadReports' in its own useCallback() Hook.","line":512,"column":9,"nodeType":"VariableDeclarator","endLine":531,"endColumn":4}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport {\r\n  ChartBarIcon,\r\n  ChatBubbleLeftRightIcon,\r\n  BuildingOfficeIcon,\r\n  UserGroupIcon,\r\n  CalendarIcon,\r\n  FunnelIcon,\r\n  ClockIcon,\r\n  EyeIcon,\r\n  HandThumbUpIcon,\r\n  ArrowPathIcon,\r\n  ArrowTrendingUpIcon,\r\n  XMarkIcon,\r\n  ChevronDownIcon,\r\n  PlusIcon,\r\n  ArrowDownTrayIcon\r\n} from '@heroicons/react/24/outline';\r\nimport {\r\n  Chart as ChartJS,\r\n  CategoryScale,\r\n  LinearScale,\r\n  PointElement,\r\n  LineElement,\r\n  BarElement,\r\n  Title,\r\n  Tooltip,\r\n  Legend,\r\n  ArcElement,\r\n} from 'chart.js';\r\nimport { Line, Bar } from 'react-chartjs-2';\r\nimport * as XLSX from 'xlsx';\r\nimport toast from 'react-hot-toast';\r\nimport enhancedCommunicationService from '../../services/enhancedCommunicationService.js';\r\nimport organizedDatabaseService from '../../services/organizedDatabaseService.js';\r\n\r\n// Register Chart.js components\r\nChartJS.register(\r\n  CategoryScale,\r\n  LinearScale,\r\n  PointElement,\r\n  LineElement,\r\n  BarElement,\r\n  Title,\r\n  Tooltip,\r\n  Legend,\r\n  ArcElement\r\n);\r\n\r\n// MultiSelect Component\r\nconst MultiSelect = ({ label, options, selectedValues, onChange, placeholder = \"Seleccionar...\" }) => {\r\n  const [isOpen, setIsOpen] = useState(false);\r\n\r\n  const handleToggle = (value) => {\r\n    const newSelected = selectedValues.includes(value)\r\n      ? selectedValues.filter(item => item !== value)\r\n      : [...selectedValues, value];\r\n    onChange(newSelected);\r\n  };\r\n\r\n  const handleSelectAll = () => {\r\n    onChange(options.map(option => option.value));\r\n  };\r\n\r\n  const handleClearAll = () => {\r\n    onChange([]);\r\n  };\r\n\r\n  const selectedCount = selectedValues.length;\r\n  const displayText = selectedCount === 0\r\n    ? placeholder\r\n    : selectedCount === 1\r\n      ? options.find(opt => opt.value === selectedValues[0])?.label || selectedValues[0]\r\n      : `${selectedCount} seleccionados`;\r\n\r\n  return (\r\n    <div className=\"relative\">\r\n      <label className=\"block text-sm font-medium text-gray-700 mb-2\">{label}</label>\r\n      <div className=\"relative\">\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => setIsOpen(!isOpen)}\r\n          className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-left flex items-center justify-between\"\r\n        >\r\n          <span className=\"truncate\">{displayText}</span>\r\n          <ChevronDownIcon className={`w-4 h-4 transition-transform ${isOpen ? 'rotate-180' : ''}`} />\r\n        </button>\r\n\r\n        {isOpen && (\r\n          <div className=\"absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto\">\r\n            <div className=\"p-2 border-b border-gray-200\">\r\n              <button\r\n                onClick={handleSelectAll}\r\n                className=\"text-xs text-indigo-600 hover:text-indigo-800 mr-4\"\r\n              >\r\n                Seleccionar todos\r\n              </button>\r\n              <button\r\n                onClick={handleClearAll}\r\n                className=\"text-xs text-gray-600 hover:text-gray-800\"\r\n              >\r\n                Limpiar\r\n              </button>\r\n            </div>\r\n            <div className=\"py-1\">\r\n              {options.map((option) => (\r\n                <label key={option.value} className=\"flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    checked={selectedValues.includes(option.value)}\r\n                    onChange={() => handleToggle(option.value)}\r\n                    className=\"h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded\"\r\n                  />\r\n                  <span className=\"ml-2 text-sm text-gray-700\">{option.label}</span>\r\n                </label>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst ReportsDashboard = () => {\r\n  const [reports, setReports] = useState(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [employees, setEmployees] = useState([]);\r\n  const [allCompanies, setAllCompanies] = useState([]);\r\n  const [allDepartments, setAllDepartments] = useState([]);\r\n  const [allRegions, setAllRegions] = useState([]);\r\n  const [allLevels, setAllLevels] = useState([]);\r\n  const [allWorkModes, setAllWorkModes] = useState([]);\r\n  const [allContractTypes, setAllContractTypes] = useState([]);\r\n  const [allPositions, setAllPositions] = useState([]);\r\n  const [dateFrom, setDateFrom] = useState('');\r\n  const [dateTo, setDateTo] = useState('');\r\n  const [showFilters, setShowFilters] = useState(false);\r\n  const [automatedReportSettings, setAutomatedReportSettings] = useState({\r\n    frequency: 'weekly',\r\n    recipients: [],\r\n    includeCharts: true\r\n  });\r\n  const [filters, setFilters] = useState({\r\n    channel: [],\r\n    company: [],\r\n    department: [],\r\n    region: [],\r\n    level: [],\r\n    workMode: [],\r\n    contractType: [],\r\n    position: [],\r\n    normalidad: [],\r\n    sentimentRange: [],\r\n    messageStatus: [],\r\n    engagementLevel: []\r\n  });\r\n\r\n  // Estados para modales de reportes\r\n  const [showCompanyReportModal, setShowCompanyReportModal] = useState(false);\r\n  const [showUserReportModal, setShowUserReportModal] = useState(false);\r\n\r\n\r\n  // Estados para filtros de reportes\r\n  const [companyReportFilters, setCompanyReportFilters] = useState({\r\n    dateFrom: '',\r\n    dateTo: '',\r\n    companies: [],\r\n    channels: []\r\n  });\r\n\r\n  const [userReportFilters, setUserReportFilters] = useState({\r\n    dateFrom: '',\r\n    dateTo: '',\r\n    companies: [],\r\n    departments: [],\r\n    regions: [],\r\n    channels: []\r\n  });\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\nuseEffect(() => {\r\n    loadReports();\r\n    loadEmployees();\r\n    loadAutomatedReportSettings();\r\n  }, [dateFrom, dateTo, filters, loadReports]);\r\n\r\n  // Cargar configuraciones de reportes autom√°ticos desde localStorage\r\n  const loadAutomatedReportSettings = () => {\r\n    try {\r\n      const savedSettings = localStorage.getItem('notificationSettings');\r\n      if (savedSettings) {\r\n        const settings = JSON.parse(savedSettings);\r\n        if (settings.reports) {\r\n          // Asegurar que recipients sea siempre un array\r\n          const reportsSettings = {\r\n            ...settings.reports,\r\n            recipients: Array.isArray(settings.reports.recipients)\r\n              ? settings.reports.recipients\r\n              : settings.reports.recipients\r\n                ? [settings.reports.recipients] // Convertir string a array\r\n                : [] // Valor por defecto si no existe\r\n          };\r\n          setAutomatedReportSettings(reportsSettings);\r\n          console.log('Configuraciones de reportes autom√°ticos cargadas:', reportsSettings);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading automated report settings:', error);\r\n    }\r\n  };\r\n\r\n  // Guardar configuraciones de reportes autom√°ticos\r\n  const saveAutomatedReportSettings = async (settings) => {\r\n    try {\r\n      const currentSettings = JSON.parse(localStorage.getItem('notificationSettings') || '{}');\r\n      currentSettings.reports = settings;\r\n      localStorage.setItem('notificationSettings', JSON.stringify(currentSettings));\r\n      setAutomatedReportSettings(settings);\r\n      console.log('Configuraciones de reportes autom√°ticos guardadas:', settings);\r\n    } catch (error) {\r\n      console.error('Error saving automated report settings:', error);\r\n    }\r\n  };\r\n\r\n  // Actualizar configuraci√≥n espec√≠fica\r\n  const updateReportSetting = (key, value) => {\r\n    const newSettings = { ...automatedReportSettings, [key]: value };\r\n    setAutomatedReportSettings(newSettings);\r\n  };\r\n\r\n  // Aplicar configuraciones\r\n  const applyReportSettings = () => {\r\n    saveAutomatedReportSettings(automatedReportSettings);\r\n    // Aqu√≠ podr√≠as aplicar filtros autom√°ticos basados en las configuraciones\r\n    console.log('Aplicando configuraciones de reportes:', automatedReportSettings);\r\n  };\r\n\r\n  // Funci√≥n para abrir modal de reporte por empresa\r\n  const openCompanyReportModal = () => {\r\n    setShowCompanyReportModal(true);\r\n  };\r\n\r\n  // Funci√≥n para abrir modal de reporte por usuario\r\n  const openUserReportModal = () => {\r\n    setShowUserReportModal(true);\r\n  };\r\n\r\n  // Funci√≥n para descargar reporte detallado por empresa con filtros\r\n  const downloadCompanyReport = async () => {\r\n    try {\r\n      // Aplicar filtros del modal\r\n      const filters = {};\r\n      if (companyReportFilters.dateFrom) filters.dateFrom = companyReportFilters.dateFrom;\r\n      if (companyReportFilters.dateTo) filters.dateTo = companyReportFilters.dateTo;\r\n      if (companyReportFilters.companies.length > 0) filters.company = companyReportFilters.companies;\r\n      if (companyReportFilters.channels.length > 0) filters.channel = companyReportFilters.channels;\r\n\r\n      // Obtener logs de comunicaci√≥n con filtros aplicados\r\n      const allReports = await enhancedCommunicationService.getCommunicationReports(\r\n        filters.dateFrom || null,\r\n        filters.dateTo || null,\r\n        filters\r\n      );\r\n\r\n      if (!allReports.recentActivity || allReports.recentActivity.length === 0) {\r\n        toast.error('No hay datos para generar el reporte con los filtros seleccionados');\r\n        return;\r\n      }\r\n\r\n      // Preparar datos para Excel\r\n      const excelData = allReports.recentActivity.map(log => {\r\n        const recipientCount = log.recipient_ids.length;\r\n        const firstRecipient = employees.find(emp => emp.id === log.recipient_ids[0]);\r\n        const companyName = firstRecipient?.company?.name || firstRecipient?.company || 'Sin empresa';\r\n\r\n        return {\r\n          'Fecha': new Date(log.timestamp).toLocaleDateString('es-ES'),\r\n          'Hora': new Date(log.timestamp).toLocaleTimeString('es-ES'),\r\n          'Empresa': companyName,\r\n          'Canal': log.channel === 'whatsapp' ? 'WhatsApp' : 'Telegram',\r\n          'Destinatarios': recipientCount,\r\n          'Mensaje': log.message,\r\n          'Estado': log.status || 'Enviado',\r\n          'ID Mensaje': log.id,\r\n          'Usuario Remitente': log.sender_name || 'Sistema',\r\n          'Tipo de Mensaje': log.message_type || 'Texto',\r\n          'Plantilla Usada': log.template_name || 'Sin plantilla',\r\n          'Tokens Usados': log.tokens_used || 0,\r\n          'Costo Estimado': log.estimated_cost || 0,\r\n          'Tiempo de Respuesta': log.response_time || 'N/A',\r\n          'Sentimiento': log.sentiment_score ? log.sentiment_score.toFixed(2) : 'N/A'\r\n        };\r\n      });\r\n\r\n      // Filtrar por empresas seleccionadas si se especificaron\r\n      let filteredData = excelData;\r\n      if (companyReportFilters.companies.length > 0) {\r\n        filteredData = excelData.filter(item => companyReportFilters.companies.includes(item.Empresa));\r\n      }\r\n\r\n      // Filtrar por canales seleccionados si se especificaron\r\n      if (companyReportFilters.channels.length > 0) {\r\n        const channelMap = { 'whatsapp': 'WhatsApp', 'telegram': 'Telegram' };\r\n        const selectedChannels = companyReportFilters.channels.map(c => channelMap[c]);\r\n        filteredData = filteredData.filter(item => selectedChannels.includes(item.Canal));\r\n      }\r\n\r\n      if (filteredData.length === 0) {\r\n        toast.error('No hay datos que coincidan con los filtros seleccionados');\r\n        return;\r\n      }\r\n\r\n      // Agrupar por empresa\r\n      const groupedByCompany = filteredData.reduce((acc, item) => {\r\n        if (!acc[item.Empresa]) {\r\n          acc[item.Empresa] = [];\r\n        }\r\n        acc[item.Empresa].push(item);\r\n        return acc;\r\n      }, {});\r\n\r\n      // Crear workbook con m√∫ltiples hojas\r\n      const wb = XLSX.utils.book_new();\r\n\r\n      // Hoja resumen\r\n      const summaryData = Object.keys(groupedByCompany).map(company => ({\r\n        'Empresa': company,\r\n        'Total Mensajes': groupedByCompany[company].length,\r\n        'Mensajes WhatsApp': groupedByCompany[company].filter(m => m.Canal === 'WhatsApp').length,\r\n        'Mensajes Telegram': groupedByCompany[company].filter(m => m.Canal === 'Telegram').length,\r\n        'Total Destinatarios': groupedByCompany[company].reduce((sum, m) => sum + m.Destinatarios, 0),\r\n        'Fecha Primer Mensaje': groupedByCompany[company].sort((a, b) => new Date(a.Fecha) - new Date(b.Fecha))[0]?.Fecha,\r\n        'Fecha √öltimo Mensaje': groupedByCompany[company].sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha))[0]?.Fecha\r\n      }));\r\n\r\n      const wsSummary = XLSX.utils.json_to_sheet(summaryData);\r\n      XLSX.utils.book_append_sheet(wb, wsSummary, 'Resumen por Empresa');\r\n\r\n      // Hoja detallada por empresa\r\n      Object.keys(groupedByCompany).forEach(company => {\r\n        const ws = XLSX.utils.json_to_sheet(groupedByCompany[company]);\r\n        XLSX.utils.book_append_sheet(wb, ws, company.substring(0, 31)); // Excel limita nombres de hoja a 31 caracteres\r\n      });\r\n\r\n      // Cerrar modal\r\n      setShowCompanyReportModal(false);\r\n\r\n      // Descargar archivo\r\n      const fileName = `reporte_comunicacion_por_empresa_${new Date().toISOString().split('T')[0]}.xlsx`;\r\n      XLSX.writeFile(wb, fileName);\r\n\r\n      toast.success('Reporte descargado exitosamente');\r\n\r\n    } catch (error) {\r\n      console.error('Error generando reporte por empresa:', error);\r\n      toast.error('Error al generar el reporte');\r\n    }\r\n  };\r\n\r\n  // Funci√≥n para descargar reporte detallado por usuario con filtros\r\n  const downloadUserReport = async () => {\r\n    try {\r\n      // Aplicar filtros del modal\r\n      const filters = {};\r\n      if (userReportFilters.dateFrom) filters.dateFrom = userReportFilters.dateFrom;\r\n      if (userReportFilters.dateTo) filters.dateTo = userReportFilters.dateTo;\r\n      if (userReportFilters.companies.length > 0) filters.company = userReportFilters.companies;\r\n      if (userReportFilters.departments.length > 0) filters.department = userReportFilters.departments;\r\n      if (userReportFilters.regions.length > 0) filters.region = userReportFilters.regions;\r\n      if (userReportFilters.channels.length > 0) filters.channel = userReportFilters.channels;\r\n\r\n      // Obtener logs de comunicaci√≥n con filtros aplicados\r\n      const allReports = await enhancedCommunicationService.getCommunicationReports(\r\n        filters.dateFrom || null,\r\n        filters.dateTo || null,\r\n        filters\r\n      );\r\n\r\n      if (!allReports.recentActivity || allReports.recentActivity.length === 0) {\r\n        toast.error('No hay datos para generar el reporte con los filtros seleccionados');\r\n        return;\r\n      }\r\n\r\n      // Preparar datos para Excel\r\n      const excelData = allReports.recentActivity.map(log => {\r\n        const firstRecipient = employees.find(emp => emp.id === log.recipient_ids[0]);\r\n\r\n        return {\r\n          'Fecha': new Date(log.timestamp).toLocaleDateString('es-ES'),\r\n          'Hora': new Date(log.timestamp).toLocaleTimeString('es-ES'),\r\n          'Usuario Destinatario': firstRecipient?.name || 'Desconocido',\r\n          'Email Destinatario': firstRecipient?.email || 'N/A',\r\n          'Empresa': firstRecipient?.company?.name || firstRecipient?.company || 'Sin empresa',\r\n          'Departamento': firstRecipient?.department || 'N/A',\r\n          'Regi√≥n': firstRecipient?.region || 'N/A',\r\n          'Nivel': firstRecipient?.level || 'N/A',\r\n          'Modalidad': firstRecipient?.work_mode || 'N/A',\r\n          'Tipo Contrato': firstRecipient?.contract_type || 'N/A',\r\n          'Posici√≥n': firstRecipient?.position || 'N/A',\r\n          'Canal': log.channel === 'whatsapp' ? 'WhatsApp' : 'Telegram',\r\n          'Mensaje': log.message,\r\n          'Estado': log.status || 'Enviado',\r\n          'ID Mensaje': log.id,\r\n          'Usuario Remitente': log.sender_name || 'Sistema',\r\n          'Tipo de Mensaje': log.message_type || 'Texto',\r\n          'Plantilla Usada': log.template_name || 'Sin plantilla',\r\n          'Tokens Usados': log.tokens_used || 0,\r\n          'Costo Estimado': log.estimated_cost || 0,\r\n          'Tiempo de Respuesta': log.response_time || 'N/A',\r\n          'Sentimiento': log.sentiment_score ? log.sentiment_score.toFixed(2) : 'N/A',\r\n          'Tel√©fono': firstRecipient?.phone || 'N/A'\r\n        };\r\n      });\r\n\r\n      // Aplicar filtros adicionales\r\n      let filteredData = excelData;\r\n\r\n      // Filtrar por empresas seleccionadas\r\n      if (userReportFilters.companies.length > 0) {\r\n        filteredData = filteredData.filter(item => userReportFilters.companies.includes(item.Empresa));\r\n      }\r\n\r\n      // Filtrar por departamentos seleccionados\r\n      if (userReportFilters.departments.length > 0) {\r\n        filteredData = filteredData.filter(item => userReportFilters.departments.includes(item.Departamento));\r\n      }\r\n\r\n      // Filtrar por regiones seleccionadas\r\n      if (userReportFilters.regions.length > 0) {\r\n        filteredData = filteredData.filter(item => userReportFilters.regions.includes(item.Regi√≥n));\r\n      }\r\n\r\n      // Filtrar por canales seleccionados\r\n      if (userReportFilters.channels.length > 0) {\r\n        const channelMap = { 'whatsapp': 'WhatsApp', 'telegram': 'Telegram' };\r\n        const selectedChannels = userReportFilters.channels.map(c => channelMap[c]);\r\n        filteredData = filteredData.filter(item => selectedChannels.includes(item.Canal));\r\n      }\r\n\r\n      if (filteredData.length === 0) {\r\n        toast.error('No hay datos que coincidan con los filtros seleccionados');\r\n        return;\r\n      }\r\n\r\n      // Agrupar por usuario\r\n      const groupedByUser = filteredData.reduce((acc, item) => {\r\n        const userKey = `${item['Usuario Destinatario']} (${item['Email Destinatario']})`;\r\n        if (!acc[userKey]) {\r\n          acc[userKey] = [];\r\n        }\r\n        acc[userKey].push(item);\r\n        return acc;\r\n      }, {});\r\n\r\n      // Crear workbook con m√∫ltiples hojas\r\n      const wb = XLSX.utils.book_new();\r\n\r\n      // Hoja resumen por usuario\r\n      const summaryData = Object.keys(groupedByUser).map(user => {\r\n        const userMessages = groupedByUser[user];\r\n        const firstMessage = userMessages[0];\r\n        return {\r\n          'Usuario': user,\r\n          'Empresa': firstMessage.Empresa,\r\n          'Departamento': firstMessage.Departamento,\r\n          'Regi√≥n': firstMessage.Regi√≥n,\r\n          'Total Mensajes': userMessages.length,\r\n          'Mensajes WhatsApp': userMessages.filter(m => m.Canal === 'WhatsApp').length,\r\n          'Mensajes Telegram': userMessages.filter(m => m.Canal === 'Telegram').length,\r\n          'Fecha Primer Mensaje': userMessages.sort((a, b) => new Date(a.Fecha) - new Date(b.Fecha))[0]?.Fecha,\r\n          'Fecha √öltimo Mensaje': userMessages.sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha))[0]?.Fecha,\r\n          'Sentimiento Promedio': userMessages.filter(m => m.Sentimiento !== 'N/A').length > 0\r\n            ? (userMessages.filter(m => m.Sentimiento !== 'N/A').reduce((sum, m) => sum + parseFloat(m.Sentimiento), 0) / userMessages.filter(m => m.Sentimiento !== 'N/A').length).toFixed(2)\r\n            : 'N/A'\r\n        };\r\n      });\r\n\r\n      const wsSummary = XLSX.utils.json_to_sheet(summaryData);\r\n      XLSX.utils.book_append_sheet(wb, wsSummary, 'Resumen por Usuario');\r\n\r\n      // Hoja detallada completa\r\n      const wsAll = XLSX.utils.json_to_sheet(filteredData);\r\n      XLSX.utils.book_append_sheet(wb, wsAll, 'Detalle Completo');\r\n\r\n      // Cerrar modal\r\n      setShowUserReportModal(false);\r\n\r\n      // Descargar archivo\r\n      const fileName = `reporte_comunicacion_por_usuario_${new Date().toISOString().split('T')[0]}.xlsx`;\r\n      XLSX.writeFile(wb, fileName);\r\n\r\n      toast.success('Reporte descargado exitosamente');\r\n\r\n    } catch (error) {\r\n      console.error('Error generando reporte por usuario:', error);\r\n      toast.error('Error al generar el reporte');\r\n    }\r\n  };\r\n\r\n  // Guardar datos de sentimiento en localStorage para sincronizaci√≥n con dashboard\r\n  const saveSentimentDataToLocalStorage = (sentimentData) => {\r\n    try {\r\n      localStorage.setItem('reportsSentimentData', JSON.stringify(sentimentData));\r\n      console.log('Datos de sentimiento guardados en localStorage para sincronizaci√≥n con dashboard');\r\n    } catch (error) {\r\n      console.error('Error guardando datos de sentimiento en localStorage:', error);\r\n    }\r\n  };\r\n\r\n  const loadReports = async () => {\r\n    try {\r\n      setLoading(true);\r\n      const reportData = await enhancedCommunicationService.getCommunicationReports(\r\n        dateFrom || null,\r\n        dateTo || null,\r\n        filters\r\n      );\r\n      setReports(reportData);\r\n\r\n      // Guardar datos de sentimiento en localStorage para sincronizaci√≥n con dashboard\r\n      if (reportData.sentimentMetrics) {\r\n        saveSentimentDataToLocalStorage(reportData.sentimentMetrics);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading reports:', error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const loadEmployees = async () => {\r\n    try {\r\n      const employeeData = await organizedDatabaseService.getEmployees();\r\n      setEmployees(employeeData);\r\n\r\n      // Extract unique values for filters\r\n      const companies = [...new Set(employeeData.map(emp => emp.company_name || emp.company).filter(Boolean))];\r\n      const departments = [...new Set(employeeData.map(emp => emp.department).filter(Boolean))];\r\n      const regions = [...new Set(employeeData.map(emp => emp.region).filter(Boolean))];\r\n      const levels = [...new Set(employeeData.map(emp => emp.level).filter(Boolean))];\r\n      const workModes = [...new Set(employeeData.map(emp => emp.work_mode).filter(Boolean))];\r\n      const contractTypes = [...new Set(employeeData.map(emp => emp.contract_type).filter(Boolean))];\r\n      const positions = [...new Set(employeeData.map(emp => emp.position).filter(Boolean))];\r\n\r\n      setAllCompanies(companies);\r\n      setAllDepartments(departments);\r\n      setAllRegions(regions);\r\n      setAllLevels(levels);\r\n      setAllWorkModes(workModes);\r\n      setAllContractTypes(contractTypes);\r\n      setAllPositions(positions);\r\n\r\n      console.log('Filter options loaded:', {\r\n        companies, departments, regions, levels, workModes, contractTypes, positions\r\n      });\r\n    } catch (error) {\r\n      console.error('Error loading employees:', error);\r\n    }\r\n  };\r\n\r\n  // Funciones para manejar cambios en filtros\r\n  const handleCompanyFilterChange = (field, value) => {\r\n    setCompanyReportFilters(prev => ({\r\n      ...prev,\r\n      [field]: value\r\n    }));\r\n  };\r\n\r\n  const handleUserFilterChange = (field, value) => {\r\n    setUserReportFilters(prev => ({\r\n      ...prev,\r\n      [field]: value\r\n    }));\r\n  };\r\n\r\n  // Funci√≥n para limpiar filtros\r\n  const clearCompanyFilters = () => {\r\n    setCompanyReportFilters({\r\n      dateFrom: '',\r\n      dateTo: '',\r\n      companies: [],\r\n      channels: []\r\n    });\r\n  };\r\n\r\n  const clearUserFilters = () => {\r\n    setUserReportFilters({\r\n      dateFrom: '',\r\n      dateTo: '',\r\n      companies: [],\r\n      departments: [],\r\n      regions: [],\r\n      channels: []\r\n    });\r\n  };\r\n\r\n  // Get company color\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-white flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <ChartBarIcon className=\"h-12 w-12 text-engage-blue animate-spin mx-auto\" />\r\n          <p className=\"mt-4 text-engage-black font-medium\">Cargando informes...</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-50 via-white to-indigo-50\">\r\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\r\n        {/* Header Moderno */}\r\n        <div className=\"bg-gradient-to-r from-indigo-500 via-purple-600 to-pink-600 rounded-3xl shadow-2xl p-8 mb-8 text-white relative overflow-hidden\">\r\n          <div className=\"absolute inset-0 bg-black/10\"></div>\r\n          <div className=\"relative z-10\">\r\n            <div className=\"flex items-center mb-3\">\r\n              <div className=\"bg-white/20 p-3 rounded-full mr-4\">\r\n                <ChartBarIcon className=\"h-8 w-8 text-white\" />\r\n              </div>\r\n              <div>\r\n                <h1 className=\"text-4xl font-bold mb-1\">\r\n                  Informes de Comunicaci√≥n\r\n                </h1>\r\n                <div className=\"h-1 w-20 bg-white/30 rounded-full\"></div>\r\n              </div>\r\n            </div>\r\n            <p className=\"text-indigo-100 text-lg font-medium\">\r\n              An√°lisis detallado y m√©tricas de la comunicaci√≥n interna\r\n            </p>\r\n            <div className=\"flex items-center mt-4 text-sm text-indigo-200\">\r\n              <div className=\"flex items-center mr-6\">\r\n                <div className=\"w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse\"></div>\r\n                Datos en tiempo real\r\n              </div>\r\n              <div className=\"flex items-center\">\r\n                <div className=\"w-2 h-2 bg-blue-400 rounded-full mr-2\"></div>\r\n                An√°lisis inteligente\r\n              </div>\r\n            </div>\r\n          </div>\r\n          {/* Elementos decorativos */}\r\n          <div className=\"absolute -top-10 -right-10 w-32 h-32 bg-white/10 rounded-full\"></div>\r\n          <div className=\"absolute -bottom-8 -left-8 w-24 h-24 bg-white/10 rounded-full\"></div>\r\n        </div>\r\n\r\n        {/* All Metrics Cards - 10 cajas individuales arriba (incluyendo m√©tricas de control de tasa) */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8\">\r\n           <div className=\"bg-gradient-to-br from-indigo-500 via-purple-600 to-pink-600 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden group hover:scale-105 transition-all duration-300\">\r\n             <div className=\"absolute inset-0 bg-black/10\"></div>\r\n             <div className=\"absolute -top-6 -right-6 w-16 h-16 bg-white/10 rounded-full\"></div>\r\n             <div className=\"relative z-10\">\r\n               <div className=\"flex justify-between items-start\">\r\n                 <div>\r\n                   <p className=\"text-indigo-100 text-sm font-medium mb-1\">Mensajes Totales</p>\r\n                   <p className=\"text-3xl font-bold\">{reports?.totalMessages || 0}</p>\r\n                   <div className=\"w-10 h-1 bg-white/30 rounded-full mt-2\"></div>\r\n                   <p className=\"text-xs text-indigo-200 mt-1\">En per√≠odo seleccionado</p>\r\n                 </div>\r\n                 <div className=\"bg-white/20 p-3 rounded-2xl group-hover:bg-white/30 transition-colors duration-300\">\r\n                   <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-white\" />\r\n                 </div>\r\n               </div>\r\n             </div>\r\n           </div>\r\n\r\n          <div className=\"bg-gradient-to-br from-green-500 via-emerald-600 to-teal-600 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden group hover:scale-105 transition-all duration-300\">\r\n            <div className=\"absolute inset-0 bg-black/10\"></div>\r\n            <div className=\"absolute -top-6 -right-6 w-16 h-16 bg-white/10 rounded-full\"></div>\r\n            <div className=\"relative z-10\">\r\n              <div className=\"flex justify-between items-start\">\r\n                <div>\r\n                  <p className=\"text-green-100 text-sm font-medium mb-1\">Tasa de Entrega</p>\r\n                  <p className=\"text-3xl font-bold\">{reports?.deliveryRate || 0}%</p>\r\n                  <div className=\"w-10 h-1 bg-white/30 rounded-full mt-2\"></div>\r\n                  <p className=\"text-xs text-green-200 mt-1\">Mensajes entregados</p>\r\n                </div>\r\n                <div className=\"bg-white/20 p-3 rounded-2xl group-hover:bg-white/30 transition-colors duration-300\">\r\n                  <svg className=\"h-6 w-6 text-white\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path d=\"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z\"/>\r\n                  </svg>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"bg-gradient-to-br from-blue-500 via-cyan-600 to-blue-600 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden group hover:scale-105 transition-all duration-300\">\r\n            <div className=\"absolute inset-0 bg-black/10\"></div>\r\n            <div className=\"absolute -top-6 -right-6 w-16 h-16 bg-white/10 rounded-full\"></div>\r\n            <div className=\"relative z-10\">\r\n              <div className=\"flex justify-between items-start\">\r\n                <div>\r\n                  <p className=\"text-blue-100 text-sm font-medium mb-1\">Tasa de Lectura</p>\r\n                  <p className=\"text-3xl font-bold\">{reports?.readRate || 0}%</p>\r\n                  <div className=\"w-10 h-1 bg-white/30 rounded-full mt-2\"></div>\r\n                  <p className=\"text-xs text-blue-200 mt-1\">Mensajes le√≠dos</p>\r\n                </div>\r\n                <div className=\"bg-white/20 p-3 rounded-2xl group-hover:bg-white/30 transition-colors duration-300\">\r\n                  <EyeIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"bg-gradient-to-br from-purple-500 via-violet-600 to-purple-600 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden group hover:scale-105 transition-all duration-300\">\r\n            <div className=\"absolute inset-0 bg-black/10\"></div>\r\n            <div className=\"absolute -top-6 -right-6 w-16 h-16 bg-white/10 rounded-full\"></div>\r\n            <div className=\"relative z-10\">\r\n              <div className=\"flex justify-between items-start\">\r\n                <div>\r\n                  <p className=\"text-purple-100 text-sm font-medium mb-1\">Tiempo Respuesta</p>\r\n                  <p className=\"text-3xl font-bold\">{reports?.avgResponseTime || 0}min</p>\r\n                  <div className=\"w-10 h-1 bg-white/30 rounded-full mt-2\"></div>\r\n                  <p className=\"text-xs text-purple-200 mt-1\">Promedio general</p>\r\n                </div>\r\n                <div className=\"bg-white/20 p-3 rounded-2xl group-hover:bg-white/30 transition-colors duration-300\">\r\n                  <ClockIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"bg-gradient-to-br from-orange-500 via-red-600 to-pink-600 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden group hover:scale-105 transition-all duration-300\">\r\n            <div className=\"absolute inset-0 bg-black/10\"></div>\r\n            <div className=\"absolute -top-6 -right-6 w-16 h-16 bg-white/10 rounded-full\"></div>\r\n            <div className=\"relative z-10\">\r\n              <div className=\"flex justify-between items-start\">\r\n                <div>\r\n                  <p className=\"text-orange-100 text-sm font-medium mb-1\">Tasa de Apertura</p>\r\n                  <p className=\"text-3xl font-bold\">{reports?.engagementMetrics?.avgOpenRate || 0}%</p>\r\n                  <div className=\"w-10 h-1 bg-white/30 rounded-full mt-2\"></div>\r\n                  <p className=\"text-xs text-orange-200 mt-1\">Mensajes abiertos</p>\r\n                </div>\r\n                <div className=\"bg-white/20 p-3 rounded-2xl group-hover:bg-white/30 transition-colors duration-300\">\r\n                  <EyeIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Nuevas m√©tricas de control de tasa */}\r\n          <div className=\"bg-gradient-to-br from-amber-500 via-orange-600 to-red-600 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden group hover:scale-105 transition-all duration-300\">\r\n            <div className=\"absolute inset-0 bg-black/10\"></div>\r\n            <div className=\"absolute -top-6 -right-6 w-16 h-16 bg-white/10 rounded-full\"></div>\r\n            <div className=\"relative z-10\">\r\n              <div className=\"flex justify-between items-start\">\r\n                <div>\r\n                  <p className=\"text-amber-100 text-sm font-medium mb-1\">Bloques Enviados</p>\r\n                  <p className=\"text-3xl font-bold\">{reports?.rateLimitMetrics?.totalBatches || 0}</p>\r\n                  <div className=\"w-10 h-1 bg-white/30 rounded-full mt-2\"></div>\r\n                  <p className=\"text-xs text-amber-200 mt-1\">Control de tasa</p>\r\n                </div>\r\n                <div className=\"bg-white/20 p-3 rounded-2xl group-hover:bg-white/30 transition-colors duration-300\">\r\n                  <ArrowPathIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"bg-gradient-to-br from-teal-500 via-cyan-600 to-blue-600 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden group hover:scale-105 transition-all duration-300\">\r\n            <div className=\"absolute inset-0 bg-black/10\"></div>\r\n            <div className=\"absolute -top-6 -right-6 w-16 h-16 bg-white/10 rounded-full\"></div>\r\n            <div className=\"relative z-10\">\r\n              <div className=\"flex justify-between items-start\">\r\n                <div>\r\n                  <p className=\"text-teal-100 text-sm font-medium mb-1\">Tiempo Total Env√≠o</p>\r\n                  <p className=\"text-3xl font-bold\">{reports?.rateLimitMetrics?.totalSendingTime || 0}s</p>\r\n                  <div className=\"w-10 h-1 bg-white/30 rounded-full mt-2\"></div>\r\n                  <p className=\"text-xs text-teal-200 mt-1\">Acumulado</p>\r\n                </div>\r\n                <div className=\"bg-white/20 p-3 rounded-2xl group-hover:bg-white/30 transition-colors duration-300\">\r\n                  <ClockIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"bg-gradient-to-br from-cyan-500 via-blue-600 to-indigo-600 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden group hover:scale-105 transition-all duration-300\">\r\n            <div className=\"absolute inset-0 bg-black/10\"></div>\r\n            <div className=\"absolute -top-6 -right-6 w-16 h-16 bg-white/10 rounded-full\"></div>\r\n            <div className=\"relative z-10\">\r\n              <div className=\"flex justify-between items-start\">\r\n                <div>\r\n                  <p className=\"text-cyan-100 text-sm font-medium mb-1\">Tasa de Clic</p>\r\n                  <p className=\"text-3xl font-bold\">{reports?.engagementMetrics?.avgClickRate || 0}%</p>\r\n                  <div className=\"w-10 h-1 bg-white/30 rounded-full mt-2\"></div>\r\n                  <p className=\"text-xs text-cyan-200 mt-1\">Interacciones</p>\r\n                </div>\r\n                <div className=\"bg-white/20 p-3 rounded-2xl group-hover:bg-white/30 transition-colors duration-300\">\r\n                  <HandThumbUpIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"bg-gradient-to-br from-emerald-500 via-green-600 to-teal-600 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden group hover:scale-105 transition-all duration-300\">\r\n            <div className=\"absolute inset-0 bg-black/10\"></div>\r\n            <div className=\"absolute -top-6 -right-6 w-16 h-16 bg-white/10 rounded-full\"></div>\r\n            <div className=\"relative z-10\">\r\n              <div className=\"flex justify-between items-start\">\r\n                <div>\r\n                  <p className=\"text-emerald-100 text-sm font-medium mb-1\">Tasa de Respuesta</p>\r\n                  <p className=\"text-3xl font-bold\">{reports?.engagementMetrics?.avgResponseRate || 0}%</p>\r\n                  <div className=\"w-10 h-1 bg-white/30 rounded-full mt-2\"></div>\r\n                  <p className=\"text-xs text-emerald-200 mt-1\">Respuestas recibidas</p>\r\n                </div>\r\n                <div className=\"bg-white/20 p-3 rounded-2xl group-hover:bg-white/30 transition-colors duration-300\">\r\n                  <ArrowPathIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"bg-gradient-to-br from-rose-500 via-pink-600 to-purple-600 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden group hover:scale-105 transition-all duration-300\">\r\n            <div className=\"absolute inset-0 bg-black/10\"></div>\r\n            <div className=\"absolute -top-6 -right-6 w-16 h-16 bg-white/10 rounded-full\"></div>\r\n            <div className=\"relative z-10\">\r\n              <div className=\"flex justify-between items-start\">\r\n                <div>\r\n                  <p className=\"text-rose-100 text-sm font-medium mb-1\">Tasa de Rebote</p>\r\n                  <p className=\"text-3xl font-bold\">{reports?.bounceRate || 0}%</p>\r\n                  <div className=\"w-10 h-1 bg-white/30 rounded-full mt-2\"></div>\r\n                  <p className=\"text-xs text-rose-200 mt-1\">Mensajes fallidos</p>\r\n                </div>\r\n                <div className=\"bg-white/20 p-3 rounded-2xl group-hover:bg-white/30 transition-colors duration-300\">\r\n                  <ArrowTrendingUpIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"bg-gradient-to-br from-violet-500 via-purple-600 to-indigo-600 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden group hover:scale-105 transition-all duration-300\">\r\n            <div className=\"absolute inset-0 bg-black/10\"></div>\r\n            <div className=\"absolute -top-6 -right-6 w-16 h-16 bg-white/10 rounded-full\"></div>\r\n            <div className=\"relative z-10\">\r\n              <div className=\"flex justify-between items-start\">\r\n                <div>\r\n                  <p className=\"text-violet-100 text-sm font-medium mb-1\">Eficiencia Env√≠o</p>\r\n                  <p className=\"text-3xl font-bold\">{reports?.rateLimitMetrics?.efficiency || 0}%</p>\r\n                  <div className=\"w-10 h-1 bg-white/30 rounded-full mt-2\"></div>\r\n                  <p className=\"text-xs text-violet-200 mt-1\">Optimizaci√≥n</p>\r\n                </div>\r\n                <div className=\"bg-white/20 p-3 rounded-2xl group-hover:bg-white/30 transition-colors duration-300\">\r\n                  <ArrowTrendingUpIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Selector de fechas y filtros avanzados */}\r\n        <div className=\"bg-white rounded-3xl shadow-xl p-6 mb-8 border border-gray-100\">\r\n          <div className=\"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6\">\r\n            {/* Selector de fechas */}\r\n            <div className=\"flex-1\">\r\n              <div className=\"flex items-center mb-4\">\r\n                <div className=\"bg-gradient-to-r from-indigo-500 to-purple-600 p-3 rounded-xl mr-4\">\r\n                  <CalendarIcon className=\"w-6 h-6 text-white\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-xl font-bold text-gray-900\">Per√≠odo de An√°lisis</h3>\r\n                  <p className=\"text-sm text-gray-600\">Selecciona el rango de fechas para filtrar los informes</p>\r\n                </div>\r\n              </div>\r\n              <div className=\"flex flex-col sm:flex-row gap-4\">\r\n                <div className=\"flex-1\">\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">Desde</label>\r\n                  <input\r\n                    type=\"date\"\r\n                    value={dateFrom}\r\n                    onChange={(e) => setDateFrom(e.target.value)}\r\n                    className=\"w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white font-medium transition-all duration-300 hover:border-indigo-300\"\r\n                  />\r\n                </div>\r\n                <div className=\"flex-1\">\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">Hasta</label>\r\n                  <input\r\n                    type=\"date\"\r\n                    value={dateTo}\r\n                    onChange={(e) => setDateTo(e.target.value)}\r\n                    className=\"w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white font-medium transition-all duration-300 hover:border-indigo-300\"\r\n                  />\r\n                </div>\r\n                <div className=\"flex items-end\">\r\n                  <button\r\n                    onClick={() => {\r\n                      setDateFrom('');\r\n                      setDateTo('');\r\n                      setFilters({\r\n                        channel: [],\r\n                        company: [],\r\n                        department: [],\r\n                        region: [],\r\n                        level: [],\r\n                        workMode: [],\r\n                        contractType: [],\r\n                        position: [],\r\n                        sentimentRange: [],\r\n                        messageStatus: [],\r\n                        engagementLevel: []\r\n                      });\r\n                    }}\r\n                    className=\"px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 font-medium transition-all duration-300\"\r\n                  >\r\n                    Limpiar\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Bot√≥n de filtros avanzados */}\r\n            <div className=\"lg:border-l lg:border-gray-200 lg:pl-6\">\r\n              <button\r\n                onClick={() => setShowFilters(!showFilters)}\r\n                className=\"w-full lg:w-auto flex items-center justify-center px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl hover:from-indigo-600 hover:to-purple-700 font-medium transition-all duration-300 shadow-lg hover:shadow-xl\"\r\n              >\r\n                <FunnelIcon className=\"w-5 h-5 mr-2\" />\r\n                Filtros Avanzados\r\n                <ChevronDownIcon className={`w-4 h-4 ml-2 transition-transform duration-300 ${showFilters ? 'rotate-180' : ''}`} />\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Panel de filtros avanzados */}\r\n          {showFilters && (\r\n            <div className=\"mt-6 pt-6 border-t border-gray-200\">\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\r\n                <MultiSelect\r\n                  label=\"Canal\"\r\n                  options={[\r\n                    { value: 'whatsapp', label: 'WhatsApp' },\r\n                    { value: 'telegram', label: 'Telegram' }\r\n                  ]}\r\n                  selectedValues={filters.channel}\r\n                  onChange={(values) => setFilters(prev => ({ ...prev, channel: values }))}\r\n                />\r\n\r\n                <MultiSelect\r\n                  label=\"Empresa\"\r\n                  options={allCompanies.map(company => ({\r\n                    value: company,\r\n                    label: company\r\n                  }))}\r\n                  selectedValues={filters.company}\r\n                  onChange={(values) => setFilters(prev => ({ ...prev, company: values }))}\r\n                />\r\n\r\n                <MultiSelect\r\n                  label=\"Departamento\"\r\n                  options={allDepartments.map(dept => ({\r\n                    value: dept,\r\n                    label: dept\r\n                  }))}\r\n                  selectedValues={filters.department}\r\n                  onChange={(values) => setFilters(prev => ({ ...prev, department: values }))}\r\n                />\r\n\r\n                <MultiSelect\r\n                  label=\"Regi√≥n\"\r\n                  options={allRegions.map(region => ({\r\n                    value: region,\r\n                    label: region\r\n                  }))}\r\n                  selectedValues={filters.region}\r\n                  onChange={(values) => setFilters(prev => ({ ...prev, region: values }))}\r\n                />\r\n\r\n                <MultiSelect\r\n                  label=\"Nivel\"\r\n                  options={allLevels.map(level => ({\r\n                    value: level,\r\n                    label: level\r\n                  }))}\r\n                  selectedValues={filters.level}\r\n                  onChange={(values) => setFilters(prev => ({ ...prev, level: values }))}\r\n                />\r\n\r\n                <MultiSelect\r\n                  label=\"Modalidad\"\r\n                  options={allWorkModes.map(workMode => ({\r\n                    value: workMode,\r\n                    label: workMode\r\n                  }))}\r\n                  selectedValues={filters.workMode}\r\n                  onChange={(values) => setFilters(prev => ({ ...prev, workMode: values }))}\r\n                />\r\n\r\n                <MultiSelect\r\n                  label=\"Tipo de Contrato\"\r\n                  options={allContractTypes.map(contractType => ({\r\n                    value: contractType,\r\n                    label: contractType\r\n                  }))}\r\n                  selectedValues={filters.contractType}\r\n                  onChange={(values) => setFilters(prev => ({ ...prev, contractType: values }))}\r\n                />\r\n\r\n                <MultiSelect\r\n                  label=\"Posici√≥n\"\r\n                  options={allPositions.map(position => ({\r\n                    value: position,\r\n                    label: position\r\n                  }))}\r\n                  selectedValues={filters.position}\r\n                  onChange={(values) => setFilters(prev => ({ ...prev, position: values }))}\r\n                />\r\n\r\n                <MultiSelect\r\n                  label=\"Rango de Sentimiento\"\r\n                  options={[\r\n                    { value: 'positive', label: 'Positivo (‚â• 0.5)' },\r\n                    { value: 'neutral', label: 'Neutral (-0.5 a 0.5)' },\r\n                    { value: 'negative', label: 'Negativo (‚â§ -0.5)' }\r\n                  ]}\r\n                  selectedValues={filters.sentimentRange}\r\n                  onChange={(values) => setFilters(prev => ({ ...prev, sentimentRange: values }))}\r\n                />\r\n\r\n                <MultiSelect\r\n                  label=\"Estado del Mensaje\"\r\n                  options={[\r\n                    { value: 'sent', label: 'Enviados' },\r\n                    { value: 'delivered', label: 'Entregados' },\r\n                    { value: 'read', label: 'Le√≠dos' },\r\n                    { value: 'failed', label: 'Fallidos' }\r\n                  ]}\r\n                  selectedValues={filters.messageStatus}\r\n                  onChange={(values) => setFilters(prev => ({ ...prev, messageStatus: values }))}\r\n                />\r\n\r\n                <MultiSelect\r\n                  label=\"Nivel de Engagement\"\r\n                  options={[\r\n                    { value: 'high', label: 'Alto (Respondieron)' },\r\n                    { value: 'medium', label: 'Medio (Clicaron)' },\r\n                    { value: 'low', label: 'Bajo (Solo leyeron)' },\r\n                    { value: 'none', label: 'Ninguno (No interactuaron)' }\r\n                  ]}\r\n                  selectedValues={filters.engagementLevel}\r\n                  onChange={(values) => setFilters(prev => ({ ...prev, engagementLevel: values }))}\r\n                />\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Configuraci√≥n de Reportes Autom√°ticos */}\r\n        <div className=\"bg-white rounded-3xl shadow-xl p-6 mb-8 border border-gray-100\">\r\n          <div className=\"flex items-center mb-6\">\r\n            <div className=\"bg-gradient-to-r from-green-500 to-emerald-600 p-3 rounded-xl mr-4\">\r\n              <svg className=\"h-6 w-6 text-white\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\r\n              </svg>\r\n            </div>\r\n            <div>\r\n              <h3 className=\"text-xl font-bold text-gray-900\">Reportes Autom√°ticos</h3>\r\n              <p className=\"text-sm text-gray-600\">Configura el env√≠o autom√°tico de informes</p>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">Frecuencia de Env√≠o</label>\r\n              <select\r\n                value={automatedReportSettings.frequency}\r\n                onChange={(e) => updateReportSetting('frequency', e.target.value)}\r\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500\"\r\n              >\r\n                <option value=\"daily\">Diario</option>\r\n                <option value=\"weekly\">Semanal</option>\r\n                <option value=\"monthly\">Mensual</option>\r\n                <option value=\"never\">Nunca</option>\r\n              </select>\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">Destinatarios</label>\r\n              <div className=\"space-y-2\">\r\n                {automatedReportSettings.recipients.map((email, index) => (\r\n                  <div key={index} className=\"flex items-center space-x-2\">\r\n                    <input\r\n                      type=\"email\"\r\n                      className=\"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500\"\r\n                      value={email}\r\n                      onChange={(e) => {\r\n                        const updatedRecipients = [...automatedReportSettings.recipients];\r\n                        updatedRecipients[index] = e.target.value;\r\n                        updateReportSetting('recipients', updatedRecipients);\r\n                      }}\r\n                      placeholder=\"email@empresa.com\"\r\n                    />\r\n                    <button\r\n                      onClick={() => {\r\n                        const updatedRecipients = automatedReportSettings.recipients.filter((_, i) => i !== index);\r\n                        updateReportSetting('recipients', updatedRecipients);\r\n                      }}\r\n                      className=\"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors\"\r\n                      title=\"Remover email\"\r\n                    >\r\n                      <XMarkIcon className=\"h-5 w-5\" />\r\n                    </button>\r\n                  </div>\r\n                ))}\r\n                <button\r\n                  onClick={() => {\r\n                    const newEmail = prompt('Ingresa el email del destinatario:');\r\n                    if (newEmail) {\r\n                      const emailRegex = /^[^s@]+@[^s@]+.[^s@]+$/;\r\n                      if (!emailRegex.test(newEmail)) {\r\n                        alert('Por favor ingresa un email v√°lido');\r\n                        return;\r\n                      }\r\n                      if (automatedReportSettings.recipients.includes(newEmail)) {\r\n                        alert('Este email ya est√° en la lista');\r\n                        return;\r\n                      }\r\n                      updateReportSetting('recipients', [...automatedReportSettings.recipients, newEmail]);\r\n                    }\r\n                  }}\r\n                  className=\"w-full px-3 py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-green-500 hover:text-green-600 transition-colors flex items-center justify-center\"\r\n                >\r\n                  <PlusIcon className=\"h-4 w-4 mr-2\" />\r\n                  Agregar Destinatario\r\n                </button>\r\n              </div>\r\n              <p className=\"text-xs text-gray-500 mt-1\">\r\n                {automatedReportSettings.recipients.length} destinatario{automatedReportSettings.recipients.length !== 1 ? 's' : ''} configurado{automatedReportSettings.recipients.length !== 1 ? 's' : ''}\r\n              </p>\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">Opciones de Reporte</label>\r\n              <div className=\"space-y-3\">\r\n                <div className=\"flex items-center\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    id=\"includeCharts\"\r\n                    checked={automatedReportSettings.includeCharts}\r\n                    onChange={(e) => updateReportSetting('includeCharts', e.target.checked)}\r\n                    className=\"h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded\"\r\n                  />\r\n                  <label htmlFor=\"includeCharts\" className=\"ml-2 block text-sm text-gray-900\">\r\n                    Incluir gr√°ficos en reportes\r\n                  </label>\r\n                </div>\r\n                <button\r\n                  onClick={applyReportSettings}\r\n                  className=\"w-full px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all duration-300 shadow-lg hover:shadow-xl\"\r\n                >\r\n                  üíæ Aplicar Configuraci√≥n\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-4 p-4 bg-green-50 border border-green-200 rounded-lg\">\r\n             <div className=\"flex items-center\">\r\n               <svg className=\"h-5 w-5 text-green-600 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                 <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n               </svg>\r\n               <div>\r\n                 <p className=\"text-sm font-medium text-green-800\">Configuraci√≥n sincronizada con Settings</p>\r\n                 <p className=\"text-xs text-green-600\">Los cambios aqu√≠ se reflejan autom√°ticamente en la configuraci√≥n general</p>\r\n               </div>\r\n             </div>\r\n           </div>\r\n         </div>\r\n\r\n         {/* Descarga de Reportes Detallados */}\r\n         <div className=\"bg-white rounded-3xl shadow-xl p-6 mb-8 border border-gray-100\">\r\n           <div className=\"flex items-center mb-6\">\r\n             <div className=\"bg-gradient-to-r from-blue-500 to-indigo-600 p-3 rounded-xl mr-4\">\r\n               <ArrowDownTrayIcon className=\"h-6 w-6 text-white\" />\r\n             </div>\r\n             <div>\r\n               <h3 className=\"text-xl font-bold text-gray-900\">Descarga de Reportes Detallados</h3>\r\n               <p className=\"text-sm text-gray-600\">Exporta reportes completos en formato Excel con toda la informaci√≥n disponible</p>\r\n             </div>\r\n           </div>\r\n\r\n           <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n             <div className=\"bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-200\">\r\n               <div className=\"flex items-center mb-4\">\r\n                 <BuildingOfficeIcon className=\"h-8 w-8 text-blue-600 mr-3\" />\r\n                 <div>\r\n                   <h4 className=\"text-lg font-bold text-gray-900\">Reporte por Empresa</h4>\r\n                   <p className=\"text-sm text-gray-600\">Mensajes agrupados por empresa con estad√≠sticas detalladas</p>\r\n                 </div>\r\n               </div>\r\n               <div className=\"space-y-3 mb-4\">\r\n                 <div className=\"flex items-center text-sm text-gray-700\">\r\n                   <span className=\"w-2 h-2 bg-blue-500 rounded-full mr-2\"></span>\r\n                   Hoja resumen con estad√≠sticas por empresa\r\n                 </div>\r\n                 <div className=\"flex items-center text-sm text-gray-700\">\r\n                   <span className=\"w-2 h-2 bg-blue-500 rounded-full mr-2\"></span>\r\n                   Hojas detalladas por cada empresa\r\n                 </div>\r\n                 <div className=\"flex items-center text-sm text-gray-700\">\r\n                   <span className=\"w-2 h-2 bg-blue-500 rounded-full mr-2\"></span>\r\n                   Incluye fecha, hora, canal, destinatarios y m√°s\r\n                 </div>\r\n               </div>\r\n               <button\r\n                 onClick={openCompanyReportModal}\r\n                 className=\"w-full flex items-center justify-center px-4 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-lg hover:from-blue-600 hover:to-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl\"\r\n               >\r\n                 <FunnelIcon className=\"h-5 w-5 mr-2\" />\r\n                 Configurar y Descargar Reporte por Empresa\r\n               </button>\r\n             </div>\r\n\r\n             <div className=\"bg-gradient-to-br from-green-50 to-emerald-50 p-6 rounded-xl border border-green-200\">\r\n               <div className=\"flex items-center mb-4\">\r\n                 <UserGroupIcon className=\"h-8 w-8 text-green-600 mr-3\" />\r\n                 <div>\r\n                   <h4 className=\"text-lg font-bold text-gray-900\">Reporte por Usuario</h4>\r\n                   <p className=\"text-sm text-gray-600\">Mensajes agrupados por usuario con informaci√≥n completa</p>\r\n                 </div>\r\n               </div>\r\n               <div className=\"space-y-3 mb-4\">\r\n                 <div className=\"flex items-center text-sm text-gray-700\">\r\n                   <span className=\"w-2 h-2 bg-green-500 rounded-full mr-2\"></span>\r\n                   Hoja resumen con estad√≠sticas por usuario\r\n                 </div>\r\n                 <div className=\"flex items-center text-sm text-gray-700\">\r\n                   <span className=\"w-2 h-2 bg-green-500 rounded-full mr-2\"></span>\r\n                   Hoja completa con todos los detalles\r\n                 </div>\r\n                 <div className=\"flex items-center text-sm text-gray-700\">\r\n                   <span className=\"w-2 h-2 bg-green-500 rounded-full mr-2\"></span>\r\n                   Incluye empresa, departamento, regi√≥n y m√°s\r\n                 </div>\r\n               </div>\r\n               <button\r\n                 onClick={openUserReportModal}\r\n                 className=\"w-full flex items-center justify-center px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all duration-300 shadow-lg hover:shadow-xl\"\r\n               >\r\n                 <FunnelIcon className=\"h-5 w-5 mr-2\" />\r\n                 Configurar y Descargar Reporte por Usuario\r\n               </button>\r\n             </div>\r\n           </div>\r\n\r\n           <div className=\"mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg\">\r\n             <div className=\"flex items-start\">\r\n               <svg className=\"h-5 w-5 text-gray-600 mr-2 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                 <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n               </svg>\r\n               <div>\r\n                 <p className=\"text-sm font-medium text-gray-800\">Informaci√≥n de los reportes</p>\r\n                 <ul className=\"text-xs text-gray-600 mt-1 space-y-1\">\r\n                   <li>‚Ä¢ Los reportes incluyen TODOS los mensajes enviados (sin filtros de fecha)</li>\r\n                   <li>‚Ä¢ Formato Excel (.xlsx) con m√∫ltiples hojas organizadas</li>\r\n                   <li>‚Ä¢ Informaci√≥n detallada: empresa, usuario, fecha, hora, canal, mensaje, estado, etc.</li>\r\n                   <li>‚Ä¢ Estad√≠sticas autom√°ticas y res√∫menes incluidos</li>\r\n                 </ul>\r\n               </div>\r\n             </div>\r\n           </div>\r\n         </div>\r\n\r\n        {/* Sentiment Charts */}\r\n        <div className=\"grid grid-cols-1 gap-8 mb-8\">\r\n          {/* Sentiment Trends Over Time */}\r\n          <div className=\"bg-white rounded-3xl shadow-2xl border border-gray-100 p-8 relative overflow-hidden\">\r\n            <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-green-500 via-emerald-500 to-teal-500\"></div>\r\n            <div className=\"flex items-center mb-6\">\r\n              <div className=\"bg-gradient-to-r from-green-500 to-emerald-600 p-3 rounded-xl mr-4\">\r\n                <ArrowTrendingUpIcon className=\"h-6 w-6 text-white\" />\r\n              </div>\r\n              <div>\r\n                <h3 className=\"text-2xl font-bold text-gray-900\">Tendencias de Sentimientos</h3>\r\n                <p className=\"text-sm text-gray-600\">Evoluci√≥n del sentimiento a lo largo del tiempo</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"h-80\">\r\n              <Line\r\n                data={{\r\n                  labels: Object.keys(reports?.sentimentMetrics?.sentimentTrends || {}).sort(),\r\n                  datasets: [{\r\n                    label: 'Sentimiento Promedio',\r\n                    data: Object.keys(reports?.sentimentMetrics?.sentimentTrends || {}).sort().map(date =>\r\n                      reports?.sentimentMetrics?.sentimentTrends[date]?.average || 0\r\n                    ),\r\n                    borderColor: 'rgb(34, 197, 94)',\r\n                    backgroundColor: 'rgba(34, 197, 94, 0.1)',\r\n                    tension: 0.4,\r\n                    fill: true,\r\n                  }]\r\n                }}\r\n                options={{\r\n                  responsive: true,\r\n                  maintainAspectRatio: false,\r\n                  plugins: {\r\n                    legend: {\r\n                      position: 'top',\r\n                    },\r\n                    title: {\r\n                      display: false,\r\n                    },\r\n                  },\r\n                  scales: {\r\n                    y: {\r\n                      beginAtZero: false,\r\n                      grid: {\r\n                        color: 'rgba(0, 0, 0, 0.1)',\r\n                      },\r\n                    },\r\n                    x: {\r\n                      grid: {\r\n                        color: 'rgba(0, 0, 0, 0.1)',\r\n                      },\r\n                    },\r\n                  },\r\n                }}\r\n              />\r\n            </div>\r\n    \r\n            {/* Rate Limit Analytics Section */}\r\n            <div className=\"grid grid-cols-1 gap-8 mb-8\">\r\n              {/* Rate Limit Overview */}\r\n              <div className=\"bg-white rounded-3xl shadow-2xl border border-gray-100 p-8 relative overflow-hidden\">\r\n                <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-amber-500 via-orange-600 to-red-600\"></div>\r\n                <div className=\"flex items-center mb-6\">\r\n                  <div className=\"bg-gradient-to-r from-amber-500 to-orange-600 p-3 rounded-xl mr-4\">\r\n                    <ArrowPathIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-2xl font-bold text-gray-900\">An√°lisis de Control de Tasa</h3>\r\n                    <p className=\"text-sm text-gray-600\">M√©tricas detalladas del env√≠o en bloques</p>\r\n                  </div>\r\n                </div>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n                  <div className=\"bg-gradient-to-br from-amber-50 to-orange-50 p-6 rounded-xl border border-amber-200\">\r\n                    <div className=\"flex items-center justify-between mb-4\">\r\n                      <div>\r\n                        <p className=\"text-amber-800 text-sm font-medium\">Promedio por Bloque</p>\r\n                        <p className=\"text-3xl font-bold text-amber-900\">{reports?.rateLimitMetrics?.avgBatchSize || 0}</p>\r\n                      </div>\r\n                      <div className=\"bg-amber-200 p-3 rounded-xl\">\r\n                        <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-amber-700\" />\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"text-xs text-amber-700\">\r\n                      Mensajes promedio por cada bloque de env√≠o\r\n                    </div>\r\n                  </div>\r\n    \r\n                  <div className=\"bg-gradient-to-br from-blue-50 to-cyan-50 p-6 rounded-xl border border-blue-200\">\r\n                    <div className=\"flex items-center justify-between mb-4\">\r\n                      <div>\r\n                        <p className=\"text-blue-800 text-sm font-medium\">Tiempo entre Bloques</p>\r\n                        <p className=\"text-3xl font-bold text-blue-900\">{reports?.rateLimitMetrics?.avgDelayTime || 0}s</p>\r\n                      </div>\r\n                      <div className=\"bg-blue-200 p-3 rounded-xl\">\r\n                        <ClockIcon className=\"h-6 w-6 text-blue-700\" />\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"text-xs text-blue-700\">\r\n                      Tiempo promedio de espera entre bloques\r\n                    </div>\r\n                  </div>\r\n    \r\n                  <div className=\"bg-gradient-to-br from-green-50 to-emerald-50 p-6 rounded-xl border border-green-200\">\r\n                    <div className=\"flex items-center justify-between mb-4\">\r\n                      <div>\r\n                        <p className=\"text-green-800 text-sm font-medium\">Optimizaci√≥n</p>\r\n                        <p className=\"text-3xl font-bold text-green-900\">{reports?.rateLimitMetrics?.optimizationRate || 0}%</p>\r\n                      </div>\r\n                      <div className=\"bg-green-200 p-3 rounded-xl\">\r\n                        <ArrowTrendingUpIcon className=\"h-6 w-6 text-green-700\" />\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"text-xs text-green-700\">\r\n                      Tasa de optimizaci√≥n del control de tasa\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n    \r\n              {/* Rate Limit by Channel */}\r\n              <div className=\"bg-white rounded-3xl shadow-2xl border border-gray-100 p-8 relative overflow-hidden\">\r\n                <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 via-pink-500 to-red-500\"></div>\r\n                <div className=\"flex items-center mb-6\">\r\n                  <div className=\"bg-gradient-to-r from-purple-500 to-pink-600 p-3 rounded-xl mr-4\">\r\n                    <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-2xl font-bold text-gray-900\">Control de Tasa por Canal</h3>\r\n                    <p className=\"text-sm text-gray-600\">An√°lisis detallado por cada canal de comunicaci√≥n</p>\r\n                  </div>\r\n                </div>\r\n                <div className=\"h-80\">\r\n                  <Bar\r\n                    data={{\r\n                      labels: ['WhatsApp', 'Telegram', 'SMS', 'Email'],\r\n                      datasets: [\r\n                        {\r\n                          label: 'Mensajes por Bloque',\r\n                          data: [\r\n                            reports?.rateLimitMetrics?.byChannel?.whatsapp?.batchSize || 50,\r\n                            reports?.rateLimitMetrics?.byChannel?.telegram?.batchSize || 30,\r\n                            reports?.rateLimitMetrics?.byChannel?.sms?.batchSize || 100,\r\n                            reports?.rateLimitMetrics?.byChannel?.email?.batchSize || 200\r\n                          ],\r\n                          backgroundColor: 'rgba(34, 197, 94, 0.8)',\r\n                          borderColor: 'rgb(34, 197, 94)',\r\n                          borderWidth: 1,\r\n                        },\r\n                        {\r\n                          label: 'Tiempo entre Bloques (s)',\r\n                          data: [\r\n                            reports?.rateLimitMetrics?.byChannel?.whatsapp?.delayTime || 5,\r\n                            reports?.rateLimitMetrics?.byChannel?.telegram?.delayTime || 3,\r\n                            reports?.rateLimitMetrics?.byChannel?.sms?.delayTime || 10,\r\n                            reports?.rateLimitMetrics?.byChannel?.email?.delayTime || 15\r\n                          ],\r\n                          backgroundColor: 'rgba(59, 130, 246, 0.8)',\r\n                          borderColor: 'rgb(59, 130, 246)',\r\n                          borderWidth: 1,\r\n                        }\r\n                      ]\r\n                    }}\r\n                    options={{\r\n                      responsive: true,\r\n                      maintainAspectRatio: false,\r\n                      plugins: {\r\n                        legend: {\r\n                          position: 'top',\r\n                        },\r\n                        title: {\r\n                          display: false,\r\n                        },\r\n                      },\r\n                      scales: {\r\n                        y: {\r\n                          beginAtZero: true,\r\n                          grid: {\r\n                            color: 'rgba(0, 0, 0, 0.1)',\r\n                          },\r\n                        },\r\n                        x: {\r\n                          grid: {\r\n                            color: 'rgba(0, 0, 0, 0.1)',\r\n                          },\r\n                        },\r\n                      },\r\n                    }}\r\n                  />\r\n                </div>\r\n              </div>\r\n    \r\n              {/* Rate Limit Trends */}\r\n              <div className=\"bg-white rounded-3xl shadow-2xl border border-gray-100 p-8 relative overflow-hidden\">\r\n                <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 via-blue-500 to-indigo-500\"></div>\r\n                <div className=\"flex items-center mb-6\">\r\n                  <div className=\"bg-gradient-to-r from-cyan-500 to-blue-600 p-3 rounded-xl mr-4\">\r\n                    <ArrowTrendingUpIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-2xl font-bold text-gray-900\">Tendencias de Control de Tasa</h3>\r\n                    <p className=\"text-sm text-gray-600\">Evoluci√≥n del rendimiento del sistema de control</p>\r\n                  </div>\r\n                </div>\r\n                <div className=\"h-80\">\r\n                  <Line\r\n                    data={{\r\n                      labels: Object.keys(reports?.rateLimitMetrics?.trends || {}).sort(),\r\n                      datasets: [\r\n                        {\r\n                          label: 'Bloques Procesados',\r\n                          data: Object.keys(reports?.rateLimitMetrics?.trends || {}).sort().map(date =>\r\n                            reports?.rateLimitMetrics?.trends[date]?.batches || 0\r\n                          ),\r\n                          borderColor: 'rgb(251, 146, 60)',\r\n                          backgroundColor: 'rgba(251, 146, 60, 0.1)',\r\n                          tension: 0.4,\r\n                          fill: true,\r\n                        },\r\n                        {\r\n                          label: 'Eficiencia (%)',\r\n                          data: Object.keys(reports?.rateLimitMetrics?.trends || {}).sort().map(date =>\r\n                            reports?.rateLimitMetrics?.trends[date]?.efficiency || 0\r\n                          ),\r\n                          borderColor: 'rgb(34, 197, 94)',\r\n                          backgroundColor: 'rgba(34, 197, 94, 0.1)',\r\n                          tension: 0.4,\r\n                          fill: true,\r\n                        }\r\n                      ]\r\n                    }}\r\n                    options={{\r\n                      responsive: true,\r\n                      maintainAspectRatio: false,\r\n                      plugins: {\r\n                        legend: {\r\n                          position: 'top',\r\n                        },\r\n                        title: {\r\n                          display: false,\r\n                        },\r\n                      },\r\n                      scales: {\r\n                        y: {\r\n                          beginAtZero: true,\r\n                          grid: {\r\n                            color: 'rgba(0, 0, 0, 0.1)',\r\n                          },\r\n                        },\r\n                        x: {\r\n                          grid: {\r\n                            color: 'rgba(0, 0, 0, 0.1)',\r\n                          },\r\n                        },\r\n                      },\r\n                    }}\r\n                  />\r\n                </div>\r\n              </div>\r\n            </div>\r\n    \r\n          </div>\r\n          {/* Sentiment by Company */}\r\n          <div className=\"bg-white rounded-3xl shadow-2xl border border-gray-100 p-8 relative overflow-hidden\">\r\n            <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-cyan-500 to-indigo-500\"></div>\r\n            <div className=\"flex items-center mb-6\">\r\n              <div className=\"bg-gradient-to-r from-blue-500 to-cyan-600 p-3 rounded-xl mr-4\">\r\n                <BuildingOfficeIcon className=\"h-6 w-6 text-white\" />\r\n              </div>\r\n              <div>\r\n                <h3 className=\"text-2xl font-bold text-gray-900\">Sentimientos por Empresa</h3>\r\n                <p className=\"text-sm text-gray-600\">Distribuci√≥n del sentimiento por organizaci√≥n</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"h-80\">\r\n              <Bar\r\n                data={{\r\n                  labels: Object.keys(reports?.sentimentMetrics?.sentimentByCompany || {}),\r\n                  datasets: [{\r\n                    label: 'Sentimiento Promedio',\r\n                    data: Object.values(reports?.sentimentMetrics?.sentimentByCompany || {}).map(company => company.average || 0),\r\n                    backgroundColor: 'rgba(59, 130, 246, 0.8)',\r\n                    borderColor: 'rgb(59, 130, 246)',\r\n                    borderWidth: 1,\r\n                  }]\r\n                }}\r\n                options={{\r\n                  responsive: true,\r\n                  maintainAspectRatio: false,\r\n                  plugins: {\r\n                    legend: {\r\n                      position: 'top',\r\n                    },\r\n                    title: {\r\n                      display: false,\r\n                    },\r\n                  },\r\n                  scales: {\r\n                    y: {\r\n                      beginAtZero: false,\r\n                      grid: {\r\n                        color: 'rgba(0, 0, 0, 0.1)',\r\n                      },\r\n                    },\r\n                    x: {\r\n                      grid: {\r\n                        color: 'rgba(0, 0, 0, 0.1)',\r\n                      },\r\n                    },\r\n                  },\r\n                }}\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n        </div>\r\n\r\n      </div>\r\n\r\n      {/* Modal para Reporte por Empresa */}\r\n      {showCompanyReportModal && (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\r\n          <div className=\"bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto\">\r\n            <div className=\"p-8\">\r\n              <div className=\"flex items-center justify-between mb-6\">\r\n                <div className=\"flex items-center space-x-3\">\r\n                  <div className=\"bg-gradient-to-r from-blue-500 to-indigo-600 p-3 rounded-xl\">\r\n                    <BuildingOfficeIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h2 className=\"text-2xl font-bold text-gray-900\">Configurar Reporte por Empresa</h2>\r\n                    <p className=\"text-gray-600\">Personaliza los filtros para tu reporte</p>\r\n                  </div>\r\n                </div>\r\n                <button\r\n                  onClick={() => setShowCompanyReportModal(false)}\r\n                  className=\"text-gray-400 hover:text-gray-600 transition-colors\"\r\n                >\r\n                  <XMarkIcon className=\"h-6 w-6\" />\r\n                </button>\r\n              </div>\r\n\r\n              <div className=\"space-y-6\">\r\n                {/* Filtros de Fecha */}\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">Fecha Desde</label>\r\n                    <input\r\n                      type=\"date\"\r\n                      value={companyReportFilters.dateFrom}\r\n                      onChange={(e) => handleCompanyFilterChange('dateFrom', e.target.value)}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                    />\r\n                  </div>\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">Fecha Hasta</label>\r\n                    <input\r\n                      type=\"date\"\r\n                      value={companyReportFilters.dateTo}\r\n                      onChange={(e) => handleCompanyFilterChange('dateTo', e.target.value)}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Filtros de Empresa */}\r\n                <MultiSelect\r\n                  label=\"Empresas\"\r\n                  options={allCompanies.map(company => ({\r\n                    value: company,\r\n                    label: company\r\n                  }))}\r\n                  selectedValues={companyReportFilters.companies}\r\n                  onChange={(values) => handleCompanyFilterChange('companies', values)}\r\n                  placeholder=\"Seleccionar empresas...\"\r\n                />\r\n\r\n                {/* Filtros de Canal */}\r\n                <MultiSelect\r\n                  label=\"Canales\"\r\n                  options={[\r\n                    { value: 'whatsapp', label: 'WhatsApp' },\r\n                    { value: 'telegram', label: 'Telegram' }\r\n                  ]}\r\n                  selectedValues={companyReportFilters.channels}\r\n                  onChange={(values) => handleCompanyFilterChange('channels', values)}\r\n                  placeholder=\"Seleccionar canales...\"\r\n                />\r\n\r\n                {/* Botones de Acci√≥n */}\r\n                <div className=\"flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200\">\r\n                  <button\r\n                    onClick={clearCompanyFilters}\r\n                    className=\"px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors\"\r\n                  >\r\n                    Limpiar Filtros\r\n                  </button>\r\n                  <div className=\"flex gap-3 ml-auto\">\r\n                    <button\r\n                      onClick={() => setShowCompanyReportModal(false)}\r\n                      className=\"px-6 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors\"\r\n                    >\r\n                      Cancelar\r\n                    </button>\r\n                    <button\r\n                      onClick={downloadCompanyReport}\r\n                      className=\"px-6 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg hover:from-blue-600 hover:to-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl\"\r\n                    >\r\n                      <ArrowDownTrayIcon className=\"h-5 w-5 mr-2 inline\" />\r\n                      Descargar Reporte\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Modal para Reporte por Usuario */}\r\n      {showUserReportModal && (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\r\n          <div className=\"bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto\">\r\n            <div className=\"p-8\">\r\n              <div className=\"flex items-center justify-between mb-6\">\r\n                <div className=\"flex items-center space-x-3\">\r\n                  <div className=\"bg-gradient-to-r from-green-500 to-emerald-600 p-3 rounded-xl\">\r\n                    <UserGroupIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h2 className=\"text-2xl font-bold text-gray-900\">Configurar Reporte por Usuario</h2>\r\n                    <p className=\"text-gray-600\">Personaliza los filtros para tu reporte</p>\r\n                  </div>\r\n                </div>\r\n                <button\r\n                  onClick={() => setShowUserReportModal(false)}\r\n                  className=\"text-gray-400 hover:text-gray-600 transition-colors\"\r\n                >\r\n                  <XMarkIcon className=\"h-6 w-6\" />\r\n                </button>\r\n              </div>\r\n\r\n              <div className=\"space-y-6\">\r\n                {/* Filtros de Fecha */}\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">Fecha Desde</label>\r\n                    <input\r\n                      type=\"date\"\r\n                      value={userReportFilters.dateFrom}\r\n                      onChange={(e) => handleUserFilterChange('dateFrom', e.target.value)}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500\"\r\n                    />\r\n                  </div>\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">Fecha Hasta</label>\r\n                    <input\r\n                      type=\"date\"\r\n                      value={userReportFilters.dateTo}\r\n                      onChange={(e) => handleUserFilterChange('dateTo', e.target.value)}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Filtros de Empresa */}\r\n                <MultiSelect\r\n                  label=\"Empresas\"\r\n                  options={allCompanies.map(company => ({\r\n                    value: company,\r\n                    label: company\r\n                  }))}\r\n                  selectedValues={userReportFilters.companies}\r\n                  onChange={(values) => handleUserFilterChange('companies', values)}\r\n                  placeholder=\"Seleccionar empresas...\"\r\n                />\r\n\r\n                {/* Filtros de Departamento */}\r\n                <MultiSelect\r\n                  label=\"Departamentos\"\r\n                  options={allDepartments.map(dept => ({\r\n                    value: dept,\r\n                    label: dept\r\n                  }))}\r\n                  selectedValues={userReportFilters.departments}\r\n                  onChange={(values) => handleUserFilterChange('departments', values)}\r\n                  placeholder=\"Seleccionar departamentos...\"\r\n                />\r\n\r\n                {/* Filtros de Regi√≥n */}\r\n                <MultiSelect\r\n                  label=\"Regiones\"\r\n                  options={allRegions.map(region => ({\r\n                    value: region,\r\n                    label: region\r\n                  }))}\r\n                  selectedValues={userReportFilters.regions}\r\n                  onChange={(values) => handleUserFilterChange('regions', values)}\r\n                  placeholder=\"Seleccionar regiones...\"\r\n                />\r\n\r\n                {/* Filtros de Canal */}\r\n                <MultiSelect\r\n                  label=\"Canales\"\r\n                  options={[\r\n                    { value: 'whatsapp', label: 'WhatsApp' },\r\n                    { value: 'telegram', label: 'Telegram' }\r\n                  ]}\r\n                  selectedValues={userReportFilters.channels}\r\n                  onChange={(values) => handleUserFilterChange('channels', values)}\r\n                  placeholder=\"Seleccionar canales...\"\r\n                />\r\n\r\n                {/* Botones de Acci√≥n */}\r\n                <div className=\"flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200\">\r\n                  <button\r\n                    onClick={clearUserFilters}\r\n                    className=\"px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors\"\r\n                  >\r\n                    Limpiar Filtros\r\n                  </button>\r\n                  <div className=\"flex gap-3 ml-auto\">\r\n                    <button\r\n                      onClick={() => setShowUserReportModal(false)}\r\n                      className=\"px-6 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors\"\r\n                    >\r\n                      Cancelar\r\n                    </button>\r\n                    <button\r\n                      onClick={downloadUserReport}\r\n                      className=\"px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all duration-300 shadow-lg hover:shadow-xl\"\r\n                    >\r\n                      <ArrowDownTrayIcon className=\"h-5 w-5 mr-2 inline\" />\r\n                      Descargar Reporte\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ReportsDashboard;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\communication\\SendMessages.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\communication\\SimpleDashboardFix.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\communication\\TemplatesDashboard.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\communication\\WebrifyCommunicationDashboard.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'useMemo' is defined but never used.","line":1,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":58},{"ruleId":"no-unused-vars","severity":1,"message":"'communicationService' is defined but never used.","line":27,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":28},{"ruleId":"no-unused-vars","severity":1,"message":"'FlipCard' is defined but never used.","line":32,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":16},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'companiesFromDB.length', 'loadCompaniesFromDB', and 'loadCompanyInsights'. Either include them or remove the dependency array.","line":342,"column":6,"nodeType":"ArrayExpression","endLine":342,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [companiesFromDB.length, loadCompaniesFromDB, loadCompanyInsights]","fix":{"range":[14388,14390],"text":"[companiesFromDB.length, loadCompaniesFromDB, loadCompanyInsights]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback, useMemo } from 'react';\r\nimport { useNavigate, useLocation } from 'react-router-dom';\r\nimport {\r\n  ChartBarIcon,\r\n  BuildingOfficeIcon,\r\n  PaperAirplaneIcon,\r\n  DocumentTextIcon as TemplateIcon,\r\n  DocumentChartBarIcon as DocumentReportIcon,\r\n  FolderIcon,\r\n  Bars3Icon,\r\n  XMarkIcon,\r\n  ArrowUpTrayIcon,\r\n  SparklesIcon,\r\n  BellIcon,\r\n  LightBulbIcon,\r\n  ChevronDownIcon,\r\n  ChevronUpIcon\r\n} from '@heroicons/react/24/outline';\r\nimport EmployeeSelector from './EmployeeSelector.js';\r\nimport SendMessages from './SendMessages.js';\r\nimport EmployeeFolders from './EmployeeFolders.js';\r\nimport TemplatesDashboard from './TemplatesDashboard.js';\r\nimport ReportsDashboard from './ReportsDashboard.js';\r\nimport EmployeeBulkUpload from './EmployeeBulkUpload.js'; // Importar el nuevo componente\r\nimport templateService from '../../services/templateService.js';\r\nimport databaseEmployeeService from '../../services/databaseEmployeeService.js';\r\nimport communicationService from '../../services/communicationService.js';\r\nimport organizedDatabaseService from '../../services/organizedDatabaseService.js';\r\nimport trendsAnalysisService from '../../services/trendsAnalysisService.js';\r\nimport Swal from 'sweetalert2';\r\nimport withReactContent from 'sweetalert2-react-content';\r\nimport FlipCard from '../common/FlipCard.js';\r\n\r\nconst MySwal = withReactContent(Swal);\r\n\r\nconst WebrifyCommunicationDashboard = ({ activeTab = 'dashboard' }) => {\r\n  const navigate = useNavigate();\r\n  const location = useLocation();\r\n  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);\r\n  \r\n  // Funci√≥n para determinar la pesta√±a activa basada en la URL actual\r\n  const getActiveTabFromUrl = useCallback(() => {\r\n    const currentPath = location.pathname;\r\n    \r\n    // Mapeo de URLs a pesta√±as\r\n    const urlToTabMap = {\r\n      '/base-de-datos': 'dashboard',\r\n      '/base-de-datos/database': 'database',\r\n      '/communication/send': 'send',\r\n      '/communication/folders': 'folders',\r\n      '/communication/templates': 'templates',\r\n      '/communication/reports': 'reports',\r\n      '/communication/bulk-upload': 'bulk-upload'\r\n    };\r\n    \r\n    return urlToTabMap[currentPath] || activeTab;\r\n  }, [location.pathname, activeTab]);\r\n  \r\n  const [currentTab, setCurrentTab] = useState(getActiveTabFromUrl());\r\n  \r\n  // Actualizar la pesta√±a activa cuando cambia la URL\r\n  useEffect(() => {\r\n    const newTab = getActiveTabFromUrl();\r\n    if (newTab !== currentTab) {\r\n      setCurrentTab(newTab);\r\n    }\r\n  }, [location.pathname, currentTab, getActiveTabFromUrl]);\r\n  \r\n  const [templatesCount, setTemplatesCount] = useState(0);\r\n  const [sentMessages, setSentMessages] = useState(0);\r\n  const [readRate, setReadRate] = useState(0);\r\n  const [companyInsights, setCompanyInsights] = useState({});\r\n  const [expandedSections, setExpandedSections] = useState({\r\n    insights: true,\r\n    recommendations: true\r\n  });\r\n  const [employees, setEmployees] = useState([]);\r\n\r\n  // Estados para el selector de empresas\r\n  const [companiesFromDB, setCompaniesFromDB] = useState([]);\r\n  const [selectedCompany, setSelectedCompany] = useState('all');\r\n  const [companyMetrics, setCompanyMetrics] = useState(null);\r\n  const [loadingCompanies, setLoadingCompanies] = useState(true);\r\n\r\n  // ‚ö†Ô∏è ELIMINADO: Lista est√°tica de empresas - ahora se usan solo datos de la BD\r\n  // const companies = useMemo(() => [\r\n  //   'Aguas Andinas', 'Andes Iron', 'Banco de Chile', 'Banco Santander', 'BHP',\r\n  //   'Cencosud', 'Codelco', 'Colb√∫n', 'Copec', 'Enel',\r\n  //   'Entel', 'Falabella', 'Latam Airlines', 'Lider', 'Movistar'\r\n  // ], []);\r\n\r\n  // Funci√≥n para cargar insights de IA para todas las compa√±√≠as usando SOLO datos reales de BD\r\n  const loadCompanyInsights = useCallback(async () => {\r\n    try {\r\n      console.log('üîç DEBUG: loadCompanyInsights() - INICIO');\r\n      console.log('üîç DEBUG: companiesFromDB.length:', companiesFromDB.length);\r\n      \r\n      // ‚úÖ CORRECCI√ìN: Usar √öNICAMENTE empresas de la base de datos\r\n      if (companiesFromDB.length === 0) {\r\n        console.log('üîç DEBUG: No hay empresas en BD, no se generan insights');\r\n        setCompanyInsights({});\r\n        return;\r\n      }\r\n      \r\n      const companiesForInsights = companiesFromDB.map(c => c.name);\r\n      \r\n      console.log('üîç DEBUG: Empresas para insights (SOLO BD):', {\r\n        cantidad: companiesForInsights.length,\r\n        nombres: companiesForInsights,\r\n        fuente: 'BD √∫nicamente'\r\n      });\r\n      console.log('üîç DEBUG: companiesFromDB actual:', {\r\n        cantidad: companiesFromDB.length,\r\n        datos: companiesFromDB.map(c => ({ id: c.id, name: c.name }))\r\n      });\r\n      \r\n      // Verificar duplicaciones en insights (no deber√≠a haber, pero por seguridad)\r\n      const uniqueInsights = [...new Set(companiesForInsights)];\r\n      if (uniqueInsights.length !== companiesForInsights.length) {\r\n        console.warn('‚ö†Ô∏è Se detectaron duplicados en companiesForInsights:', {\r\n          original: companiesForInsights.length,\r\n          unique: uniqueInsights.length,\r\n          duplicados: companiesForInsights.length - uniqueInsights.length,\r\n          originalList: companiesForInsights,\r\n          uniqueList: uniqueInsights\r\n        });\r\n      }\r\n      \r\n      console.log('üîç DEBUG: Generando insights para', uniqueInsights.length, 'empresas √∫nicas de BD');\r\n      \r\n      const insightsPromises = uniqueInsights.map(async (companyName) => {\r\n        try {\r\n          // Usar el nuevo servicio de an√°lisis de tendencias con datos reales\r\n          const insights = await trendsAnalysisService.generateCompanyInsights(companyName);\r\n          console.log(`‚úÖ Insights cargados para ${companyName}:`, insights);\r\n          return { companyName, insights };\r\n        } catch (error) {\r\n          console.warn(`Error loading insights for ${companyName}:`, error.message);\r\n          // Retornar insights por defecto cuando hay error\r\n          return {\r\n            companyName,\r\n            insights: {\r\n              frontInsights: [\r\n                {\r\n                  title: 'An√°lisis en Progreso',\r\n                  description: `Los datos de comunicaci√≥n para ${companyName} est√°n siendo procesados con IA. Los insights estar√°n disponibles pronto.`,\r\n                  type: 'info'\r\n                }\r\n              ],\r\n              backInsights: [\r\n                {\r\n                  title: 'Sistema Activo',\r\n                  description: 'El sistema est√° analizando patrones de comunicaci√≥n reales con Groq AI.',\r\n                  type: 'info'\r\n                }\r\n              ]\r\n            }\r\n          };\r\n        }\r\n      });\r\n\r\n      const results = await Promise.all(insightsPromises);\r\n      const insightsMap = {};\r\n      results.forEach(({ companyName, insights }) => {\r\n        insightsMap[companyName] = insights;\r\n      });\r\n\r\n      setCompanyInsights(insightsMap);\r\n      console.log('‚úÖ Todos los insights cargados:', Object.keys(insightsMap));\r\n    } catch (error) {\r\n      console.error('‚ùå Error en loadCompanyInsights:', error);\r\n    }\r\n  }, [companiesFromDB]); // ‚úÖ Depender SOLO de los datos reales de la BD\r\n\r\n  // Funci√≥n para cargar empresas y empleados desde la base de datos\r\n  const loadCompaniesFromDB = useCallback(async () => {\r\n    try {\r\n      setLoadingCompanies(true);\r\n      console.log('üîç DEBUG: loadCompaniesFromDB() - INICIO - Cargando empresas desde base de datos...');\r\n      console.log('üîç DEBUG: Estado actual de companiesFromDB antes de cargar:', companiesFromDB.length, 'empresas');\r\n      \r\n      // Limpiar estado anterior para evitar acumulaci√≥n\r\n      setCompaniesFromDB([]);\r\n      setEmployees([]);\r\n      \r\n      // Esperar un tick para asegurar que el estado se limpie\r\n      await new Promise(resolve => setTimeout(resolve, 0));\r\n      \r\n      // Intentar cargar desde la base de datos primero\r\n      console.log('üîç DEBUG: Llamando a organizedDatabaseService.getCompanies()...');\r\n      const companiesData = await organizedDatabaseService.getCompanies();\r\n      console.log('üîç DEBUG: organizedDatabaseService.getCompanies() retorn√≥:', {\r\n        cantidad: companiesData?.length || 0,\r\n        datos: companiesData,\r\n        tipos: companiesData?.map(c => ({ id: c.id, name: c.name, tipo: typeof c.id }))\r\n      });\r\n      \r\n      if (companiesData && companiesData.length > 0) {\r\n        // Si hay datos en la BD, usarlos\r\n        console.log('üîç DEBUG: Hay empresas en BD, cargando empleados...');\r\n        const employeesData = await organizedDatabaseService.getEmployees();\r\n        console.log('üîç DEBUG: organizedDatabaseService.getEmployees() retorn√≥:', employeesData?.length || 0, 'empleados');\r\n        \r\n        // Verificar si hay duplicados antes de establecer el estado\r\n        const uniqueCompanies = companiesData.filter((company, index, self) =>\r\n          index === self.findIndex((c) => c.id === company.id)\r\n        );\r\n        \r\n        if (uniqueCompanies.length !== companiesData.length) {\r\n          console.warn('‚ö†Ô∏è Se detectaron duplicados en companiesData:', {\r\n            original: companiesData.length,\r\n            unique: uniqueCompanies.length,\r\n            duplicados: companiesData.length - uniqueCompanies.length,\r\n            datosOriginales: companiesData,\r\n            datosUnicos: uniqueCompanies,\r\n            idsOriginales: companiesData.map(c => c.id),\r\n            idsUnicos: uniqueCompanies.map(c => c.id)\r\n          });\r\n        }\r\n        \r\n        console.log('üîç DEBUG: Estableciendo companiesFromDB con', uniqueCompanies.length, 'empresas √∫nicas');\r\n        setCompaniesFromDB(uniqueCompanies);\r\n        setEmployees(employeesData);\r\n        \r\n        // Verificar el estado despu√©s de establecerlo\r\n        setTimeout(() => {\r\n          console.log('üîç DEBUG: Estado de companiesFromDB despu√©s de establecer:', companiesFromDB.length, 'empresas');\r\n        }, 100);\r\n        \r\n        console.log('‚úÖ Empresas √∫nicas cargadas desde BD:', uniqueCompanies.length);\r\n        console.log('‚úÖ Empleados cargados desde BD:', employeesData.length);\r\n      } else {\r\n        // ‚úÖ CORRECCI√ìN: Si no hay datos en la BD, no usar fallback que causa duplicaci√≥n\r\n        console.log('üîç DEBUG: No hay empresas en BD, manteniendo lista vac√≠a para evitar duplicaciones');\r\n        setCompaniesFromDB([]);\r\n        setEmployees([]);\r\n        console.log('‚úÖ Lista de empresas vac√≠a - sin duplicaciones');\r\n      }\r\n    } catch (error) {\r\n      console.error('‚ùå Error cargando datos desde BD:', error);\r\n      // En caso de error, usar lista vac√≠a para evitar duplicaciones\r\n      setCompaniesFromDB([]);\r\n      setEmployees([]);\r\n    } finally {\r\n      setLoadingCompanies(false);\r\n    }\r\n  }, [companiesFromDB.length]); // A√±adir dependencia para tracking\r\n\r\n  // Funci√≥n para cargar m√©tricas espec√≠ficas de una empresa usando datos reales de Supabase\r\n  const loadCompanyMetrics = useCallback(async (companyId) => {\r\n    try {\r\n      if (!companyId || companyId === 'all') {\r\n        setCompanyMetrics(null);\r\n        return;\r\n      }\r\n\r\n      // Obtener el nombre de la empresa desde companiesFromDB\r\n      const company = companiesFromDB.find(c => c.id === companyId);\r\n      if (!company) {\r\n        console.warn(`No se encontr√≥ empresa con ID: ${companyId}`);\r\n        setCompanyMetrics(null);\r\n        return;\r\n      }\r\n\r\n      // Usar trendsAnalysisService para obtener datos reales de Supabase\r\n      // ‚úÖ CORRECCI√ìN: Pasar el ID y el flag isId=true para buscar por ID\r\n      const insights = await trendsAnalysisService.generateCompanyInsights(companyId, false, true);\r\n      \r\n      // Extraer m√©tricas reales del servicio\r\n      const communicationMetrics = insights.communicationMetrics || {};\r\n      const employeeData = insights.employeeData || {};\r\n      \r\n      setCompanyMetrics({\r\n        employeeCount: employeeData.totalEmployees || 0,\r\n        messageStats: {\r\n          total: communicationMetrics.totalMessages || 0,\r\n          read: communicationMetrics.readMessages || 0,\r\n          sent: communicationMetrics.sentMessages || 0,\r\n          scheduled: communicationMetrics.scheduledMessages || 0,\r\n          failed: communicationMetrics.failedMessages || 0\r\n        },\r\n        engagementRate: communicationMetrics.engagementRate || 0,\r\n        deliveryRate: communicationMetrics.deliveryRate || 0,\r\n        readRate: communicationMetrics.readRate || 0\r\n      });\r\n      \r\n      console.log(`‚úÖ M√©tricas reales cargadas para ${company.name}:`, {\r\n        employeeCount: employeeData.totalEmployees,\r\n        totalMessages: communicationMetrics.totalMessages,\r\n        engagementRate: communicationMetrics.engagementRate\r\n      });\r\n    } catch (error) {\r\n      console.error('Error cargando m√©tricas de empresa:', error);\r\n      // Fallback a m√©tricas vac√≠as en caso de error\r\n      setCompanyMetrics({\r\n        employeeCount: 0,\r\n        messageStats: { total: 0, read: 0, sent: 0, scheduled: 0, failed: 0 },\r\n        engagementRate: 0,\r\n        deliveryRate: 0,\r\n        readRate: 0\r\n      });\r\n    }\r\n  }, [companiesFromDB]);\r\n\r\n  // Cargar datos del dashboard al montar el componente\r\n  useEffect(() => {\r\n    const initializeDashboard = async () => {\r\n      try {\r\n        console.log('üîÑ Inicializando dashboard de comunicaci√≥n...');\r\n        \r\n        // PASO 1: Cargar empresas primero\r\n        await loadCompaniesFromDB();\r\n        \r\n        // PASO 2: Una vez cargadas las empresas, cargar insights\r\n        if (companiesFromDB.length > 0) {\r\n          await loadCompanyInsights();\r\n        }\r\n        \r\n        // PASO 3: Cargar datos auxiliares\r\n        try {\r\n          const [templatesCount, dashboardStats] = await Promise.all([\r\n            templateService.getTemplatesCount(),\r\n            databaseEmployeeService.getDashboardStats()\r\n          ]);\r\n          setTemplatesCount(templatesCount);\r\n          setSentMessages(dashboardStats.sentMessages);\r\n          setReadRate(dashboardStats.readRate);\r\n        } catch (error) {\r\n          console.warn('Error cargando datos auxiliares:', error);\r\n          setTemplatesCount(0);\r\n          setSentMessages(0);\r\n          setReadRate(0);\r\n        }\r\n        \r\n        console.log('‚úÖ Dashboard inicializado completamente');\r\n      } catch (error) {\r\n        console.error('‚ùå Error inicializando dashboard:', error);\r\n      }\r\n    };\r\n    \r\n    initializeDashboard();\r\n  }, []); // Solo al montar el componente\r\n\r\n  // Efecto para cargar m√©tricas cuando cambia la empresa seleccionada\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\r\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\r\nuseEffect(() => {\r\n    loadCompanyMetrics(selectedCompany);\r\n  }, [selectedCompany, loadCompanyMetrics]);\r\n\r\n  // ‚úÖ CORRECCI√ìN: Efecto para manejar compa√±√≠a seleccionada SIN lista est√°tica\r\n  useEffect(() => {\r\n    // Verificar si hay una compa√±√≠a seleccionada desde el estado de navegaci√≥n\r\n    console.log('üîç DEBUG: Verificando estado de navegaci√≥n...');\r\n    console.log('üîç DEBUG: location:', location);\r\n    console.log('üîç DEBUG: location.state:', location.state);\r\n\r\n    if (location.state && location.state.selectedCompany) {\r\n      const selectedCompanyFromNav = location.state.selectedCompany;\r\n      console.log('üîç DEBUG: Compa√±√≠a seleccionada desde navegaci√≥n:', selectedCompanyFromNav);\r\n      \r\n      // ‚úÖ CORRECCI√ìN: Usar empresas de la BD para comparaci√≥n, no lista est√°tica\r\n      const companiesList = companiesFromDB.map(c => c.name);\r\n      console.log('üîç DEBUG: Compa√±√≠as disponibles en BD:', companiesList);\r\n\r\n      // Buscar la compa√±√≠a que coincida exactamente en los datos de BD\r\n      const matchingCompany = companiesList.find(company => company === selectedCompanyFromNav);\r\n      console.log('üîç DEBUG: Compa√±√≠a encontrada en BD:', matchingCompany);\r\n\r\n      if (matchingCompany) {\r\n        // Encontrar el ID de la empresa coincidente\r\n        const companyObject = companiesFromDB.find(c => c.name === matchingCompany);\r\n        if (companyObject) {\r\n          console.log('üîç DEBUG: Estableciendo empresa seleccionada por ID:', companyObject.id);\r\n          setSelectedCompany(companyObject.id);\r\n        }\r\n      } else {\r\n        console.warn('‚ö†Ô∏è No se encontr√≥ coincidencia en BD para:', selectedCompanyFromNav);\r\n        // Si no hay coincidencia, mantener 'all'\r\n        setSelectedCompany('all');\r\n      }\r\n    } else {\r\n      console.log('üîç DEBUG: No hay compa√±√≠a seleccionada en el estado');\r\n    }\r\n  }, [location, companiesFromDB]); // ‚úÖ Depender de companiesFromDB, no de lista est√°tica\r\n\r\n\r\n\r\n\r\n  // Orden espec√≠fico para los insights (incluyendo variaciones)\r\n  const insightOrder = [\r\n    \"√âxito\",\r\n    \"Exito\",\r\n    \"Tendencia Positiva\",\r\n    \"Tendencia positiva\",\r\n    \"Oportunidad\",\r\n    \"Insight\",\r\n    \"Patr√≥n Identificado\",\r\n    \"Patr√≥n identificado\",\r\n    \"Tema Recurrente\",\r\n    \"Tema recurrente\",\r\n    \"√Årea de Mejora\",\r\n    \"√Årea de mejora\",\r\n    \"Tendencias negativas\",\r\n    \"Tendencias Negativas\",\r\n    \"Alerta\"\r\n  ];\r\n\r\n  // Funci√≥n para obtener el √≠ndice de orden basado en keywords\r\n  const getOrderIndex = (title) => {\r\n    for (let i = 0; i < insightOrder.length; i++) {\r\n      if (title.toLowerCase().includes(insightOrder[i].toLowerCase())) {\r\n        return i;\r\n      }\r\n    }\r\n    return insightOrder.length; // Si no coincide, va al final\r\n  };\r\n\r\n  // Funci√≥n para ordenar insights por t√≠tulo\r\n  const sortInsights = (insights) => {\r\n    return insights.sort((a, b) => getOrderIndex(a.title) - getOrderIndex(b.title));\r\n  };\r\n\r\n  // Funci√≥n para renderizar insights din√°micos\r\n  const renderCompanyInsights = (companyName, insights) => {\r\n    if (!insights) {\r\n      return (\r\n        <div className=\"space-y-4\">\r\n          <div className=\"bg-white/70 rounded-lg p-4\">\r\n            <div className=\"flex items-center mb-2\">\r\n              <div className=\"w-2 h-2 bg-gray-500 rounded-full mr-2\"></div>\r\n              <span className=\"text-sm font-medium text-gray-700\">Cargando insights...</span>\r\n            </div>\r\n            <p className=\"text-sm text-gray-600\">Los insights de IA se est√°n generando autom√°ticamente.</p>\r\n          </div>\r\n        </div>\r\n      );\r\n    }\r\n\r\n    const sortedFrontInsights = sortInsights([...(insights.frontInsights || [])]);\r\n\r\n    if (companyName === 'Corporaci√≥n Chilena') {\r\n      console.log('Corporaci√≥n Chilena front insights titles:', insights.frontInsights?.map(i => i.title));\r\n      console.log('Corporaci√≥n Chilena sorted front insights titles:', sortedFrontInsights.map(i => i.title));\r\n    }\r\n\r\n    return (\r\n      <div className=\"space-y-4\">\r\n        {sortedFrontInsights.map((insight, index) => (\r\n          <div key={index} className=\"bg-white/70 rounded-lg p-4\">\r\n            <div className=\"flex items-center mb-2\">\r\n              <div className={`w-2 h-2 rounded-full mr-2 ${\r\n                insight.type === 'positive' ? 'bg-green-500' :\r\n                insight.type === 'negative' ? 'bg-red-500' :\r\n                insight.type === 'warning' ? 'bg-orange-500' :\r\n                insight.type === 'info' ? 'bg-blue-500' :\r\n                'bg-gray-500'\r\n              }`}></div>\r\n              <span className=\"text-sm font-medium text-gray-700\">{insight.title}</span>\r\n            </div>\r\n            <p className=\"text-sm text-gray-600\">{insight.description}</p>\r\n          </div>\r\n        ))}\r\n      </div>\r\n    );\r\n  };\r\n\r\n  // Funci√≥n para renderizar insights del reverso\r\n  const renderBackInsights = (companyName, insights) => {\r\n    if (!insights) {\r\n      return (\r\n        <div className=\"space-y-4\">\r\n          <div className=\"bg-white/70 rounded-lg p-4\">\r\n            <div className=\"flex items-center mb-2\">\r\n              <div className=\"w-2 h-2 bg-gray-500 rounded-full mr-2\"></div>\r\n              <span className=\"text-sm font-medium text-gray-700\">M√°s insights pr√≥ximamente</span>\r\n            </div>\r\n            <p className=\"text-sm text-gray-600\">Se est√°n recopilando datos adicionales para insights m√°s detallados.</p>\r\n          </div>\r\n        </div>\r\n      );\r\n    }\r\n\r\n    const sortedBackInsights = sortInsights([...(insights.backInsights || [])]);\r\n\r\n    if (companyName === 'Corporaci√≥n Chilena') {\r\n      console.log('Corporaci√≥n Chilena back insights titles:', insights.backInsights?.map(i => i.title));\r\n      console.log('Corporaci√≥n Chilena sorted back insights titles:', sortedBackInsights.map(i => i.title));\r\n    }\r\n\r\n    return (\r\n      <div className=\"space-y-4\">\r\n        {sortedBackInsights.map((insight, index) => (\r\n          <div key={index} className=\"bg-white/70 rounded-lg p-4\">\r\n            <div className=\"flex items-center mb-2\">\r\n              <div className={`w-2 h-2 rounded-full mr-2 ${\r\n                insight.type === 'positive' ? 'bg-green-500' :\r\n                insight.type === 'negative' ? 'bg-red-500' :\r\n                insight.type === 'warning' ? 'bg-orange-500' :\r\n                insight.type === 'info' ? 'bg-blue-500' :\r\n                'bg-gray-500'\r\n              }`}></div>\r\n              <span className=\"text-sm font-medium text-gray-700\">{insight.title}</span>\r\n            </div>\r\n            <p className=\"text-sm text-gray-600\">{insight.description}</p>\r\n          </div>\r\n        ))}\r\n      </div>\r\n    );\r\n  };\r\n\r\n\r\n\r\n  const tabs = [\r\n    { id: 'dashboard', name: 'Tendencias', icon: ChartBarIcon, url: '/base-de-datos' },\r\n    { id: 'database', name: 'Datos', icon: BuildingOfficeIcon, url: '/base-de-datos/database' },\r\n    { id: 'send', name: 'Enviar', icon: PaperAirplaneIcon, url: '/communication/send' },\r\n    { id: 'folders', name: 'Carpetas', icon: FolderIcon, url: '/communication/folders' },\r\n    { id: 'templates', name: 'Plantillas', icon: TemplateIcon, url: '/communication/templates' },\r\n    { id: 'reports', name: 'Reportes', icon: DocumentReportIcon, url: '/communication/reports' },\r\n    { id: 'bulk-upload', name: 'Importar', icon: ArrowUpTrayIcon, url: '/communication/bulk-upload' },\r\n  ];\r\n\r\n  // Funci√≥n para navegar a una URL espec√≠fica\r\n  const handleNavigation = async (tab) => {\r\n    try {\r\n      console.log(`üöÄ Navegando a: ${tab.url}`);\r\n      navigate(tab.url);\r\n    } catch (error) {\r\n      console.error('‚ùå Error al navegar:', error);\r\n      // En caso de error, mostrar alerta\r\n      MySwal.fire({\r\n        title: 'Error',\r\n        text: 'Hubo un problema al navegar. Por favor, int√©ntelo de nuevo.',\r\n        icon: 'error',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    }\r\n  };\r\n\r\n  const renderActiveTab = () => {\r\n    switch (currentTab) {\r\n      case 'database':\r\n        return <EmployeeSelector />;\r\n      case 'send':\r\n        return <SendMessages />;\r\n      case 'folders':\r\n        return <EmployeeFolders />;\r\n      case 'templates':\r\n        return <TemplatesDashboard />;\r\n      case 'reports':\r\n        return <ReportsDashboard />;\r\n      case 'bulk-upload':\r\n        return <EmployeeBulkUpload />; // Agregar la nueva pesta√±a\r\n      default:\r\n        return (\r\n          <div className=\"bg-white rounded-2xl shadow-xl p-6 border border-gray-200\">\r\n            <h2 className=\"text-2xl font-bold text-gray-900 mb-6\">Dashboard de Comunicaci√≥n</h2>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\r\n              <div className=\"bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white\">\r\n                <div className=\"flex items-center\">\r\n                  <BuildingOfficeIcon className=\"h-8 w-8\" />\r\n                  <div className=\"ml-4\">\r\n                    <p className=\"text-sm opacity-80\">Total Empleados</p>\r\n                    <p className=\"text-2xl font-bold\">{employees.length}</p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-6 text-white\">\r\n                <div className=\"flex items-center\">\r\n                  <PaperAirplaneIcon className=\"h-8 w-8\" />\r\n                  <div className=\"ml-4\">\r\n                    <p className=\"text-sm opacity-80\">Mensajes Enviados</p>\r\n                    <p className=\"text-2xl font-bold\">{sentMessages.toLocaleString()}</p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-6 text-white\">\r\n                <div className=\"flex items-center\">\r\n                  <TemplateIcon className=\"h-8 w-8\" />\r\n                  <div className=\"ml-4\">\r\n                    <p className=\"text-sm opacity-80\">Plantillas</p>\r\n                    <p className=\"text-2xl font-bold\">{templatesCount}</p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-xl p-6 text-white\">\r\n                <div className=\"flex items-center\">\r\n                  <DocumentReportIcon className=\"h-8 w-8\" />\r\n                  <div className=\"ml-4\">\r\n                    <p className=\"text-sm opacity-80\">Tasa de Lectura</p>\r\n                    <p className=\"text-2xl font-bold\">{readRate}%</p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            \r\n            <div className=\"mt-8\">\r\n              {/* An√°lisis Inteligente de Tendencias - Dise√±o Moderno y Compacto */}\r\n              <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 rounded-2xl p-8 border border-gray-200 shadow-lg\">\r\n                {/* Header */}\r\n                <div className=\"flex items-center justify-between mb-8\">\r\n                  <div className=\"flex items-center\">\r\n                    <div className=\"bg-gradient-to-r from-blue-600 to-purple-600 p-3 rounded-xl mr-4 shadow-lg\">\r\n                      <SparklesIcon className=\"h-6 w-6 text-white\" />\r\n                    </div>\r\n                    <div>\r\n                      <h3 className=\"text-2xl font-bold text-gray-900 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent\">\r\n                        An√°lisis Inteligente de Tendencias\r\n                      </h3>\r\n                      <p className=\"text-gray-600 text-sm\">Insights generados por IA sobre comunicaci√≥n y engagement</p>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Selector de Empresas */}\r\n                <div className=\"bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-purple-200 mb-6\">\r\n                  <div className=\"flex items-center gap-4\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <BuildingOfficeIcon className=\"w-4 h-4 text-purple-600\" />\r\n                      <label className=\"text-sm font-medium text-gray-700\">\r\n                        Empresa:\r\n                      </label>\r\n                    </div>\r\n                    <div className=\"flex-1 max-w-xs\">\r\n                      {loadingCompanies ? (\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <div className=\"w-4 h-4 border-2 border-purple-500 border-t-transparent rounded-full animate-spin\"></div>\r\n                          <span className=\"text-sm text-gray-500\">Cargando empresas...</span>\r\n                        </div>\r\n                      ) : (\r\n                        <select\r\n                          value={selectedCompany}\r\n                          onChange={(e) => setSelectedCompany(e.target.value)}\r\n                          className=\"w-full px-3 py-2 text-sm border border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white text-gray-900\"\r\n                        >\r\n                          <option value=\"all\">Todas las empresas</option>\r\n                          {companiesFromDB.map((company) => {\r\n                            console.log('üîç DEBUG: Renderizando empresa en selector:', company);\r\n                            return (\r\n                              <option key={company.id} value={company.id}>\r\n                                {company.name}\r\n                              </option>\r\n                            );\r\n                          })}\r\n                        </select>\r\n                      )}\r\n                    </div>\r\n                    {companyMetrics && (\r\n                      <div className=\"flex items-center gap-4 text-xs\">\r\n                        <div className=\"flex items-center gap-1\">\r\n                          <span className=\"text-gray-500\">Empleados:</span>\r\n                          <span className=\"font-semibold text-purple-600\">{companyMetrics.employeeCount}</span>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-1\">\r\n                          <span className=\"text-gray-500\">Engagement:</span>\r\n                          <span className=\"font-semibold text-green-600\">{companyMetrics.engagementRate}%</span>\r\n                        </div>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n\r\n                {/* M√©tricas Principales - 100% Datos Reales de Supabase */}\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8\">\r\n                  <div className=\"bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-purple-100 hover:shadow-md transition-all duration-300 hover:scale-102\">\r\n                    <div className=\"flex items-center justify-between mb-2\">\r\n                      <div className=\"bg-purple-100 p-2 rounded-lg\">\r\n                        <ChartBarIcon className=\"h-5 w-5 text-purple-600\" />\r\n                      </div>\r\n                      <span className=\"text-xs font-medium text-green-600 bg-green-100 px-2 py-1 rounded-full\">\r\n                        {companyMetrics?.engagementRate > 0 ? `+${companyMetrics.engagementRate}%` : 'Sin datos'}\r\n                      </span>\r\n                    </div>\r\n                    <p className=\"text-2xl font-bold text-gray-900\">\r\n                      {companyMetrics?.engagementRate ?? 0}%\r\n                    </p>\r\n                    <p className=\"text-sm text-gray-600\">\r\n                      {selectedCompany !== 'all' ? 'Engagement Real' : 'Engagement Promedio Real'}\r\n                    </p>\r\n                  </div>\r\n\r\n                  <div className=\"bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-blue-100 hover:shadow-md transition-all duration-300 hover:scale-102\">\r\n                    <div className=\"flex items-center justify-between mb-2\">\r\n                      <div className=\"bg-blue-100 p-2 rounded-lg\">\r\n                        <BellIcon className=\"h-5 w-5 text-blue-600\" />\r\n                      </div>\r\n                      <span className=\"text-xs font-medium text-blue-600 bg-blue-100 px-2 py-1 rounded-full\">\r\n                        {companyMetrics?.messageStats?.total > 0 ? 'Activo' : 'Inactivo'}\r\n                      </span>\r\n                    </div>\r\n                    <p className=\"text-2xl font-bold text-gray-900\">\r\n                      {companyMetrics?.messageStats?.total > 0\r\n                        ? Math.round((companyMetrics.messageStats.read / companyMetrics.messageStats.total) * 100)\r\n                        : 0}%\r\n                    </p>\r\n                    <p className=\"text-sm text-gray-600\">Tasa de Lectura Real</p>\r\n                  </div>\r\n\r\n                  <div className=\"bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-cyan-100 hover:shadow-md transition-all duration-300 hover:scale-102\">\r\n                    <div className=\"flex items-center justify-between mb-2\">\r\n                      <div className=\"bg-cyan-100 p-2 rounded-lg\">\r\n                        <LightBulbIcon className=\"h-5 w-5 text-cyan-600\" />\r\n                      </div>\r\n                      <span className=\"text-xs font-medium text-orange-600 bg-orange-100 px-2 py-1 rounded-full\">\r\n                        {companyMetrics?.messageStats?.total > 0 ? 'Con datos' : 'Sin datos'}\r\n                      </span>\r\n                    </div>\r\n                    <p className=\"text-2xl font-bold text-gray-900\">\r\n                      {companyMetrics?.messageStats?.total ?? 0}\r\n                    </p>\r\n                    <p className=\"text-sm text-gray-600\">Mensajes Enviados Reales</p>\r\n                  </div>\r\n\r\n                  <div className=\"bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-rose-100 hover:shadow-md transition-all duration-300 hover:scale-102\">\r\n                    <div className=\"flex items-center justify-between mb-2\">\r\n                      <div className=\"bg-rose-100 p-2 rounded-lg\">\r\n                        <SparklesIcon className=\"h-5 w-5 text-rose-600\" />\r\n                      </div>\r\n                      <span className=\"text-xs font-medium text-rose-600 bg-rose-100 px-2 py-1 rounded-full\">Real</span>\r\n                    </div>\r\n                    <p className=\"text-2xl font-bold text-gray-900\">\r\n                      {companyMetrics?.employeeCount ?? employees.length}\r\n                    </p>\r\n                    <p className=\"text-sm text-gray-600\">\r\n                      {selectedCompany !== 'all' ? 'Empleados Reales' : 'Total Empleados Reales'}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Secciones Expandibles */}\r\n                <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n                  {/* Insights Clave */}\r\n                  <div className=\"bg-white/70 backdrop-blur-sm rounded-xl p-6 border border-purple-200\">\r\n                    <button\r\n                      onClick={() => setExpandedSections(prev => ({ ...prev, insights: !prev.insights }))}\r\n                      className=\"flex items-center justify-between w-full mb-4 hover:bg-purple-50 p-2 rounded-lg transition-colors\"\r\n                    >\r\n                      <div className=\"flex items-center\">\r\n                        <LightBulbIcon className=\"h-5 w-5 text-purple-600 mr-2\" />\r\n                        <h4 className=\"text-lg font-semibold text-gray-900\">Insights Clave</h4>\r\n                      </div>\r\n                      {expandedSections.insights ? (\r\n                        <ChevronUpIcon className=\"h-5 w-5 text-gray-500\" />\r\n                      ) : (\r\n                        <ChevronDownIcon className=\"h-5 w-5 text-gray-500\" />\r\n                      )}\r\n                    </button>\r\n                    \r\n                    {expandedSections.insights && (\r\n                      <div className=\"space-y-3 max-h-96 overflow-y-auto\">\r\n                        {selectedCompany !== 'all' && companyInsights[companiesFromDB.find(c => c.id === selectedCompany)?.name] ? (\r\n                          // Mostrar insights espec√≠ficos de la empresa seleccionada\r\n                          renderCompanyInsights(companiesFromDB.find(c => c.id === selectedCompany)?.name, companyInsights[companiesFromDB.find(c => c.id === selectedCompany)?.name])\r\n                        ) : (\r\n                          // Mostrar insights generales cuando no hay empresa seleccionada\r\n                          <>\r\n                            <div className=\"p-3 bg-gray-50 rounded-lg border border-gray-200\">\r\n                              <div className=\"flex items-center mb-1\">\r\n                                <div className=\"w-2 h-2 bg-gray-500 rounded-full mr-2\"></div>\r\n                                <span className=\"text-sm font-medium text-gray-800\">Sin Datos</span>\r\n                              </div>\r\n                              <p className=\"text-sm text-gray-700\">No hay mensajes enviados a√∫n. Los insights aparecer√°n cuando haya actividad de comunicaci√≥n real.</p>\r\n                            </div>\r\n                            <div className=\"p-3 bg-blue-50 rounded-lg border border-blue-200\">\r\n                              <div className=\"flex items-center mb-1\">\r\n                                <div className=\"w-2 h-2 bg-blue-500 rounded-full mr-2\"></div>\r\n                                <span className=\"text-sm font-medium text-blue-800\">Estado Actual</span>\r\n                              </div>\r\n                              <p className=\"text-sm text-gray-700\">Base de datos conectada. Esperando datos de comunicaci√≥n reales para generar insights.</p>\r\n                            </div>\r\n                          </>\r\n                        )}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n\r\n                  {/* Recomendaciones */}\r\n                  <div className=\"bg-white/70 backdrop-blur-sm rounded-xl p-6 border border-blue-200\">\r\n                    <button\r\n                      onClick={() => setExpandedSections(prev => ({ ...prev, recommendations: !prev.recommendations }))}\r\n                      className=\"flex items-center justify-between w-full mb-4 hover:bg-blue-50 p-2 rounded-lg transition-colors\"\r\n                    >\r\n                      <div className=\"flex items-center\">\r\n                        <ChartBarIcon className=\"h-5 w-5 text-blue-600 mr-2\" />\r\n                        <h4 className=\"text-lg font-semibold text-gray-900\">Recomendaciones</h4>\r\n                      </div>\r\n                      {expandedSections.recommendations ? (\r\n                        <ChevronUpIcon className=\"h-5 w-5 text-gray-500\" />\r\n                      ) : (\r\n                        <ChevronDownIcon className=\"h-5 w-5 text-gray-500\" />\r\n                      )}\r\n                    </button>\r\n                    \r\n                    {expandedSections.recommendations && (\r\n                      <div className=\"space-y-3 max-h-96 overflow-y-auto\">\r\n                        {selectedCompany !== 'all' && companyInsights[companiesFromDB.find(c => c.id === selectedCompany)?.name] ? (\r\n                          // Mostrar recomendaciones espec√≠ficas de la empresa seleccionada\r\n                          renderBackInsights(companiesFromDB.find(c => c.id === selectedCompany)?.name, companyInsights[companiesFromDB.find(c => c.id === selectedCompany)?.name])\r\n                        ) : (\r\n                          // Mostrar recomendaciones generales cuando no hay empresa seleccionada\r\n                          <>\r\n                            <div className=\"p-3 bg-gray-50 rounded-lg border border-gray-200\">\r\n                              <div className=\"flex items-center mb-1\">\r\n                                <div className=\"w-2 h-2 bg-gray-500 rounded-full mr-2\"></div>\r\n                                <span className=\"text-sm font-medium text-gray-800\">Sin Actividad</span>\r\n                              </div>\r\n                              <p className=\"text-sm text-gray-700\">Las recomendaciones se generar√°n autom√°ticamente cuando haya mensajes enviados.</p>\r\n                            </div>\r\n                            <div className=\"p-3 bg-blue-50 rounded-lg border border-blue-200\">\r\n                              <div className=\"flex items-center mb-1\">\r\n                                <div className=\"w-2 h-2 bg-blue-500 rounded-full mr-2\"></div>\r\n                                <span className=\"text-sm font-medium text-blue-800\">Sistema Listo</span>\r\n                              </div>\r\n                              <p className=\"text-sm text-gray-700\">El an√°lisis de IA est√° activo y esperando datos reales para generar recomendaciones.</p>\r\n                            </div>\r\n                          </>\r\n                        )}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n\r\n\r\n                {/* Footer */}\r\n                <div className=\"mt-6 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border border-indigo-200\">\r\n                  <div className=\"flex items-center\">\r\n                    <svg className=\"h-5 w-5 text-indigo-600 mr-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n                    </svg>\r\n                    <div>\r\n                      <p className=\"text-sm font-medium text-indigo-800\">An√°lisis Actualizado</p>\r\n                      <p className=\"text-xs text-indigo-600\">Los insights se generan autom√°ticamente cada 24 horas basados en patrones de comunicaci√≥n y consultas a la base de conocimiento.</p>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        );\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-50 to-blue-50\">\r\n      {/* Header simple sin men√∫ */}\r\n      <div className=\"bg-white shadow-lg border-b border-gray-200 sticky top-0 z-40\">\r\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\r\n          <div className=\"flex items-center justify-between py-4\">\r\n            {/* Mobile menu button */}\r\n            <div className=\"md:hidden\">\r\n              <button\r\n                onClick={() => setMobileMenuOpen(!mobileMenuOpen)}\r\n                className=\"text-gray-500 hover:text-gray-700 p-2 rounded-lg hover:bg-gray-100 transition-colors\"\r\n              >\r\n                {mobileMenuOpen ? (\r\n                  <XMarkIcon className=\"h-6 w-6\" />\r\n                ) : (\r\n                  <Bars3Icon className=\"h-6 w-6\" />\r\n                )}\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Mobile menu dropdown */}\r\n          {mobileMenuOpen && (\r\n            <div className=\"md:hidden border-t border-gray-200 bg-white\">\r\n              <nav className=\"px-4 py-4\">\r\n                <div className=\"grid grid-cols-2 gap-2\">\r\n                  {tabs.map((tab) => {\r\n                    const Icon = tab.icon;\r\n                    return (\r\n                      <div key={tab.id}>\r\n                        <button\r\n                          onClick={() => {\r\n                            handleNavigation(tab);\r\n                            setMobileMenuOpen(false);\r\n                          }}\r\n                          className={`flex items-center w-full px-3 py-3 rounded-lg text-sm font-medium transition-colors duration-200 text-left ${\r\n                            window.location.pathname === tab.url\r\n                              ? 'bg-gradient-to-r from-indigo-500 to-purple-600 text-white'\r\n                              : 'text-gray-700 hover:bg-gray-100'\r\n                          }`}\r\n                        >\r\n                          <Icon className=\"h-5 w-5 mr-3\" />\r\n                          {tab.name}\r\n                        </button>\r\n                      </div>\r\n                    );\r\n                  })}\r\n                </div>\r\n              </nav>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Main content - Ahora ocupa todo el ancho disponible */}\r\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4\">\r\n        {/* Desktop horizontal menu - redise√±o moderno */}\r\n        <div className=\"mb-4\">\r\n          <nav className=\"flex items-center justify-center gap-3 bg-gradient-to-r from-slate-50 to-gray-50 rounded-2xl p-4 shadow-lg border border-gray-200/50 backdrop-blur-sm overflow-x-auto\">\r\n            {tabs.map((tab) => {\r\n              const Icon = tab.icon;\r\n              const isActive = window.location.pathname === tab.url;\r\n\r\n              return (\r\n                <div key={tab.id} className=\"relative group\">\r\n                  <button\r\n                    onClick={() => handleNavigation(tab)}\r\n                    className={`relative flex items-center px-6 py-3 rounded-xl text-sm font-semibold transition-all duration-300 transform ${\r\n                      isActive\r\n                        ? 'bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-xl scale-105'\r\n                        : 'bg-white text-gray-700 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-700 hover:shadow-md hover:scale-102 border border-gray-200'\r\n                    }`}\r\n                  >\r\n                    <Icon className={`h-5 w-5 mr-3 transition-colors duration-300 ${\r\n                      isActive ? 'text-blue-100' : 'text-blue-500 group-hover:text-blue-600'\r\n                    }`} />\r\n                    <span className=\"tracking-wide\">{tab.name}</span>\r\n\r\n                    {/* Active glow effect */}\r\n                    {isActive && (\r\n                      <div className=\"absolute inset-0 bg-gradient-to-r from-blue-400 to-indigo-500 rounded-xl blur opacity-30 animate-pulse\"></div>\r\n                    )}\r\n                  </button>\r\n\r\n                  {/* Decorative elements */}\r\n                  {!isActive && (\r\n                    <div className=\"absolute -top-1 -right-1 w-2 h-2 bg-blue-400 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300\"></div>\r\n                  )}\r\n                </div>\r\n              );\r\n            })}\r\n          </nav>\r\n        </div>\r\n\r\n        <div className=\"w-full\">\r\n          {renderActiveTab()}\r\n        </div>\r\n\r\n        {/* Production Database Debugger - Only show in production or when there's an issue */}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default WebrifyCommunicationDashboard;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\communication\\WebrifyCommunicationDashboard_DEBUG.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'LightBulbIcon' is defined but never used.","line":18,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'ChevronDownIcon' is defined but never used.","line":19,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'ChevronUpIcon' is defined but never used.","line":20,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'MySwal' is assigned a value but never used.","line":37,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":37,"endColumn":13},{"ruleId":"no-unused-vars","severity":1,"message":"'setCurrentTab' is assigned a value but never used.","line":65,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":65,"endColumn":35},{"ruleId":"no-unused-vars","severity":1,"message":"'templatesCount' is assigned a value but never used.","line":66,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":66,"endColumn":24},{"ruleId":"no-unused-vars","severity":1,"message":"'sentMessages' is assigned a value but never used.","line":67,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":67,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'readRate' is assigned a value but never used.","line":68,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":68,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'companyInsights' is assigned a value but never used.","line":69,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":69,"endColumn":25},{"ruleId":"no-unused-vars","severity":1,"message":"'expandedSections' is assigned a value but never used.","line":70,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":70,"endColumn":26},{"ruleId":"no-unused-vars","severity":1,"message":"'setExpandedSections' is assigned a value but never used.","line":70,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":70,"endColumn":47},{"ruleId":"no-unused-vars","severity":1,"message":"'employees' is assigned a value but never used.","line":74,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":74,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'selectedCompany'. Either include it or remove the dependency array.","line":272,"column":6,"nodeType":"ArrayExpression","endLine":272,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [companiesFromDB, selectedCompany]","fix":{"range":[10372,10389],"text":"[companiesFromDB, selectedCompany]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'companiesFromDB.length', 'loadCompaniesFromDB', and 'loadCompanyInsights'. Either include them or remove the dependency array.","line":316,"column":6,"nodeType":"ArrayExpression","endLine":316,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [companiesFromDB.length, loadCompaniesFromDB, loadCompanyInsights]","fix":{"range":[11951,11953],"text":"[companiesFromDB.length, loadCompaniesFromDB, loadCompanyInsights]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'companiesFromDB.length'. Either include it or remove the dependency array.","line":328,"column":6,"nodeType":"ArrayExpression","endLine":328,"endColumn":43,"suggestions":[{"desc":"Update the dependencies array to be: [selectedCompany, loadCompanyMetrics, companiesFromDB.length]","fix":{"range":[12319,12356],"text":"[selectedCompany, loadCompanyMetrics, companiesFromDB.length]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":15,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// COPIA DEL COMPONENTE CON LOGS EXTREMOS EN CADA PASO\r\n// Usar este archivo temporalmente para debuggear\r\n\r\nimport React, { useState, useEffect, useCallback } from 'react';\r\nimport { useNavigate, useLocation } from 'react-router-dom';\r\nimport {\r\n  ChartBarIcon,\r\n  BuildingOfficeIcon,\r\n  PaperAirplaneIcon,\r\n  DocumentTextIcon as TemplateIcon,\r\n  DocumentChartBarIcon as DocumentReportIcon,\r\n  FolderIcon,\r\n  Bars3Icon,\r\n  XMarkIcon,\r\n  ArrowUpTrayIcon,\r\n  SparklesIcon,\r\n  BellIcon,\r\n  LightBulbIcon,\r\n  ChevronDownIcon,\r\n  ChevronUpIcon\r\n} from '@heroicons/react/24/outline';\r\nimport EmployeeSelector from './EmployeeSelector.js';\r\nimport SendMessages from './SendMessages.js';\r\nimport EmployeeFolders from './EmployeeFolders.js';\r\nimport TemplatesDashboard from './TemplatesDashboard.js';\r\nimport ReportsDashboard from './ReportsDashboard.js';\r\nimport EmployeeBulkUpload from './EmployeeBulkUpload.js';\r\nimport templateService from '../../services/templateService.js';\r\nimport databaseEmployeeService from '../../services/databaseEmployeeService.js';\r\nimport organizedDatabaseService from '../../services/organizedDatabaseService.js';\r\nimport trendsAnalysisService from '../../services/trendsAnalysisService.js';\r\nimport ProductionDatabaseDebugger from '../debug/ProductionDatabaseDebugger.js';\r\nimport ProductionEnvChecker from '../debug/ProductionEnvChecker.js';\r\nimport Swal from 'sweetalert2';\r\nimport withReactContent from 'sweetalert2-react-content';\r\n\r\nconst MySwal = withReactContent(Swal);\r\n\r\n// LOG EXTREMO - Funci√≥n para debuggear\r\nconst EXTREME_LOG = (label, data) => {\r\n  console.log(`üîç [EXTREME DEBUG] ${label}:`, JSON.parse(JSON.stringify(data)));\r\n};\r\n\r\nconst WebrifyCommunicationDashboard_DEBUG = ({ activeTab = 'dashboard' }) => {\r\n  const navigate = useNavigate();\r\n  const location = useLocation();\r\n  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);\r\n  \r\n  EXTREME_LOG('Componente montado', { activeTab, location: location.pathname });\r\n\r\n  const getActiveTabFromUrl = useCallback(() => {\r\n    const currentPath = location.pathname;\r\n    const urlToTabMap = {\r\n      '/base-de-datos': 'dashboard',\r\n      '/base-de-datos/database': 'database',\r\n      '/communication/send': 'send',\r\n      '/communication/folders': 'folders',\r\n      '/communication/templates': 'templates',\r\n      '/communication/reports': 'reports',\r\n      '/communication/bulk-upload': 'bulk-upload'\r\n    };\r\n    return urlToTabMap[currentPath] || activeTab;\r\n  }, [location.pathname, activeTab]);\r\n  \r\n  const [currentTab, setCurrentTab] = useState(getActiveTabFromUrl());\r\n  const [templatesCount, setTemplatesCount] = useState(0);\r\n  const [sentMessages, setSentMessages] = useState(0);\r\n  const [readRate, setReadRate] = useState(0);\r\n  const [companyInsights, setCompanyInsights] = useState({});\r\n  const [expandedSections, setExpandedSections] = useState({\r\n    insights: true,\r\n    recommendations: true\r\n  });\r\n  const [employees, setEmployees] = useState([]);\r\n\r\n  // Estados para el selector de empresas\r\n  const [companiesFromDB, setCompaniesFromDB] = useState([]);\r\n  const [selectedCompany, setSelectedCompany] = useState('all');\r\n  const [companyMetrics, setCompanyMetrics] = useState(null);\r\n  const [loadingCompanies, setLoadingCompanies] = useState(true);\r\n\r\n  EXTREME_LOG('Estado inicial', {\r\n    companiesFromDB: [],\r\n    selectedCompany: 'all',\r\n    companyMetrics: null,\r\n    loading: true\r\n  });\r\n\r\n  // Funci√≥n para cargar insights de IA para todas las compa√±√≠as usando SOLO datos reales de BD\r\n  const loadCompanyInsights = useCallback(async () => {\r\n    EXTREME_LOG('loadCompanyInsights() INICIO', { companiesFromDBLength: companiesFromDB.length });\r\n    \r\n    try {\r\n      if (companiesFromDB.length === 0) {\r\n        EXTREME_LOG('No hay empresas en BD', {});\r\n        setCompanyInsights({});\r\n        return;\r\n      }\r\n      \r\n      const companiesForInsights = companiesFromDB.map(c => c.name);\r\n      EXTREME_LOG('Empresas para insights', companiesForInsights);\r\n\r\n      const uniqueInsights = [...new Set(companiesForInsights)];\r\n      EXTREME_LOG('Empresas √∫nicas para insights', uniqueInsights);\r\n\r\n      const insightsPromises = uniqueInsights.map(async (companyName) => {\r\n        try {\r\n          EXTREME_LOG(`Generando insights para ${companyName}`, {});\r\n          const insights = await trendsAnalysisService.generateCompanyInsights(companyName);\r\n          EXTREME_LOG(`Insights generados para ${companyName}`, insights);\r\n          return { companyName, insights };\r\n        } catch (error) {\r\n          EXTREME_LOG(`Error en insights para ${companyName}`, error.message);\r\n          return {\r\n            companyName,\r\n            insights: {\r\n              frontInsights: [{\r\n                title: 'An√°lisis en Progreso',\r\n                description: `Los datos de comunicaci√≥n para ${companyName} est√°n siendo procesados con IA.`,\r\n                type: 'info'\r\n              }],\r\n              backInsights: [{\r\n                title: 'Sistema Activo',\r\n                description: 'El sistema est√° analizando patrones de comunicaci√≥n reales con Groq AI.',\r\n                type: 'info'\r\n              }]\r\n            }\r\n          };\r\n        }\r\n      });\r\n\r\n      const results = await Promise.all(insightsPromises);\r\n      const insightsMap = {};\r\n      results.forEach(({ companyName, insights }) => {\r\n        insightsMap[companyName] = insights;\r\n      });\r\n\r\n      EXTREME_LOG('Insights map construido', Object.keys(insightsMap));\r\n      setCompanyInsights(insightsMap);\r\n    } catch (error) {\r\n      EXTREME_LOG('Error en loadCompanyInsights', error.message);\r\n    }\r\n  }, [companiesFromDB]);\r\n\r\n  // Funci√≥n para cargar empresas y empleados desde la base de datos\r\n  const loadCompaniesFromDB = useCallback(async () => {\r\n    EXTREME_LOG('loadCompaniesFromDB() INICIO', {});\r\n    setLoadingCompanies(true);\r\n    \r\n    try {\r\n      EXTREME_LOG('Limpiando estado', {});\r\n      setCompaniesFromDB([]);\r\n      setEmployees([]);\r\n\r\n      EXTREME_LOG('Llamando a organizedDatabaseService.getCompanies()', {});\r\n      const companiesData = await organizedDatabaseService.getCompanies();\r\n      EXTREME_LOG('organizedDatabaseService.getCompanies() resultado', {\r\n        cantidad: companiesData?.length || 0,\r\n        datos: companiesData?.slice(0, 2)\r\n      });\r\n\r\n      if (companiesData && companiesData.length > 0) {\r\n        EXTREME_LOG('Cargando empleados', {});\r\n        const employeesData = await organizedDatabaseService.getEmployees();\r\n        EXTREME_LOG('organizedDatabaseService.getEmployees() resultado', employeesData?.length);\r\n\r\n        const uniqueCompanies = companiesData.filter((company, index, self) =>\r\n          index === self.findIndex((c) => c.id === company.id)\r\n        );\r\n        \r\n        EXTREME_LOG('Empresas √∫nicas', uniqueCompanies.length);\r\n        EXTREME_LOG('Estableciendo companiesFromDB', uniqueCompanies.map(c => ({ id: c.id, name: c.name })));\r\n        \r\n        setCompaniesFromDB(uniqueCompanies);\r\n        setEmployees(employeesData);\r\n\r\n        EXTREME_LOG('Estado despu√©s de setCompaniesFromDB', {\r\n          companiesFromDB: uniqueCompanies.length,\r\n          employees: employeesData.length\r\n        });\r\n      } else {\r\n        EXTREME_LOG('No hay empresas en BD', {});\r\n        setCompaniesFromDB([]);\r\n        setEmployees([]);\r\n      }\r\n    } catch (error) {\r\n      EXTREME_LOG('Error en loadCompaniesFromDB', error.message);\r\n      setCompaniesFromDB([]);\r\n      setEmployees([]);\r\n    } finally {\r\n      setLoadingCompanies(false);\r\n      EXTREME_LOG('loadCompaniesFromDB() FIN', { loading: false });\r\n    }\r\n  }, []);\r\n\r\n  // Funci√≥n para cargar m√©tricas espec√≠ficas de una empresa usando datos reales de Supabase\r\n  const loadCompanyMetrics = useCallback(async (companyId) => {\r\n    EXTREME_LOG('loadCompanyMetrics() INICIO', { companyId, selectedCompany });\r\n    \r\n    try {\r\n      if (!companyId || companyId === 'all') {\r\n        EXTREME_LOG('companyId es all o null', {});\r\n        setCompanyMetrics(null);\r\n        return;\r\n      }\r\n\r\n      EXTREME_LOG('Buscando empresa en companiesFromDB', {\r\n        companyId,\r\n        companiesCount: companiesFromDB.length,\r\n        companies: companiesFromDB.map(c => ({ id: c.id, name: c.name }))\r\n      });\r\n\r\n      const company = companiesFromDB.find(c => c.id === companyId);\r\n      \r\n      if (!company) {\r\n        EXTREME_LOG('Empresa no encontrada en companiesFromDB', { companyId });\r\n        setCompanyMetrics(null);\r\n        return;\r\n      }\r\n\r\n      EXTREME_LOG('Empresa encontrada', { name: company.name, id: company.id });\r\n\r\n      EXTREME_LOG('Llamando a trendsAnalysisService.generateCompanyInsights', {\r\n        companyId,\r\n        forceRegenerate: false,\r\n        isId: true\r\n      });\r\n\r\n      const insights = await trendsAnalysisService.generateCompanyInsights(companyId, false, true);\r\n      \r\n      EXTREME_LOG('Resultado de trendsAnalysisService', insights);\r\n\r\n      const communicationMetrics = insights.communicationMetrics || {};\r\n      const employeeData = insights.employeeData || {};\r\n      \r\n      EXTREME_LOG('communicationMetrics extra√≠do', communicationMetrics);\r\n      EXTREME_LOG('employeeData extra√≠do', employeeData);\r\n\r\n      const metrics = {\r\n        employeeCount: employeeData.totalEmployees || 0,\r\n        messageStats: {\r\n          total: communicationMetrics.totalMessages || 0,\r\n          read: communicationMetrics.readMessages || 0,\r\n          sent: communicationMetrics.sentMessages || 0,\r\n          scheduled: communicationMetrics.scheduledMessages || 0,\r\n          failed: communicationMetrics.failedMessages || 0\r\n        },\r\n        engagementRate: communicationMetrics.engagementRate || 0,\r\n        deliveryRate: communicationMetrics.deliveryRate || 0,\r\n        readRate: communicationMetrics.readRate || 0\r\n      };\r\n\r\n      EXTREME_LOG('Metrics construido', metrics);\r\n      setCompanyMetrics(metrics);\r\n      \r\n    } catch (error) {\r\n      EXTREME_LOG('Error en loadCompanyMetrics', {\r\n        message: error.message,\r\n        stack: error.stack\r\n      });\r\n      \r\n      setCompanyMetrics({\r\n        employeeCount: 0,\r\n        messageStats: { total: 0, read: 0, sent: 0, scheduled: 0, failed: 0 },\r\n        engagementRate: 0,\r\n        deliveryRate: 0,\r\n        readRate: 0\r\n      });\r\n    }\r\n    \r\n    EXTREME_LOG('loadCompanyMetrics() FIN', {});\r\n  }, [companiesFromDB]);\r\n\r\n  // Cargar datos del dashboard al montar el componente\r\n  useEffect(() => {\r\n    EXTREME_LOG('useEffect inicial [MONTAJE] INICIO', {});\r\n    \r\n    const initializeDashboard = async () => {\r\n      try {\r\n        EXTREME_LOG('Inicializando dashboard paso 1: loadCompaniesFromDB', {});\r\n        await loadCompaniesFromDB();\r\n        \r\n        EXTREME_LOG('Despu√©s de loadCompaniesFromDB', {\r\n          companiesFromDB: companiesFromDB.length\r\n        });\r\n        \r\n        if (companiesFromDB.length > 0) {\r\n          EXTREME_LOG('Inicializando dashboard paso 2: loadCompanyInsights', {});\r\n          await loadCompanyInsights();\r\n        }\r\n        \r\n        EXTREME_LOG('Inicializando dashboard paso 3: datos auxiliares', {});\r\n        const [templatesCount, dashboardStats] = await Promise.all([\r\n          templateService.getTemplatesCount(),\r\n          databaseEmployeeService.getDashboardStats()\r\n        ]);\r\n        \r\n        EXTREME_LOG('Datos auxiliares cargados', {\r\n          templatesCount,\r\n          sentMessages: dashboardStats.sentMessages,\r\n          readRate: dashboardStats.readRate\r\n        });\r\n        \r\n        setTemplatesCount(templatesCount);\r\n        setSentMessages(dashboardStats.sentMessages);\r\n        setReadRate(dashboardStats.readRate);\r\n        \r\n        EXTREME_LOG('Dashboard inicializado completamente', {});\r\n      } catch (error) {\r\n        EXTREME_LOG('Error inicializando dashboard', error.message);\r\n      }\r\n    };\r\n    \r\n    initializeDashboard();\r\n    EXTREME_LOG('useEffect inicial [MONTAJE] FIN', {});\r\n  }, []); // Solo al montar\r\n\r\n  // Efecto para cargar m√©tricas cuando cambia la empresa seleccionada\r\n  useEffect(() => {\r\n    EXTREME_LOG('useEffect selectedCompany INICIO', {\r\n      selectedCompany,\r\n      companiesFromDB: companiesFromDB.length\r\n    });\r\n    \r\n    loadCompanyMetrics(selectedCompany);\r\n    \r\n    EXTREME_LOG('useEffect selectedCompany FIN', {});\r\n  }, [selectedCompany, loadCompanyMetrics]);\r\n\r\n  // Resto del componente...\r\n  // (El renderizado es el mismo, solo con logs extremos en el estado)\r\n\r\n  const renderActiveTab = () => {\r\n    EXTREME_LOG('renderActiveTab() llamado', { currentTab });\r\n    \r\n    switch (currentTab) {\r\n      case 'database':\r\n        return <EmployeeSelector />;\r\n      case 'send':\r\n        return <SendMessages />;\r\n      case 'folders':\r\n        return <EmployeeFolders />;\r\n      case 'templates':\r\n        return <TemplatesDashboard />;\r\n      case 'reports':\r\n        return <ReportsDashboard />;\r\n      case 'bulk-upload':\r\n        return <EmployeeBulkUpload />;\r\n      default:\r\n        EXTREME_LOG('Renderizando dashboard default', {\r\n          selectedCompany,\r\n          companyMetrics,\r\n          companiesFromDB: companiesFromDB.length\r\n        });\r\n        \r\n        return (\r\n          <div className=\"bg-white rounded-2xl shadow-xl p-6 border border-gray-200\">\r\n            <h2 className=\"text-2xl font-bold text-gray-900 mb-6\">Dashboard de Comunicaci√≥n - DEBUG</h2>\r\n            \r\n            {/* DEBUG INFO */}\r\n            <div className=\"bg-yellow-100 border border-yellow-400 rounded-lg p-4 mb-6\">\r\n              <h3 className=\"font-bold text-yellow-800\">üîç INFORMACI√ìN DE DEBUG</h3>\r\n              <pre className=\"text-sm text-yellow-700 mt-2\">\r\n{JSON.stringify({\r\n  selectedCompany,\r\n  companyMetrics,\r\n  companiesCount: companiesFromDB.length,\r\n  timestamp: new Date().toISOString()\r\n}, null, 2)}\r\n              </pre>\r\n            </div>\r\n            \r\n            {/* Selector de Empresas */}\r\n            <div className=\"bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-purple-200 mb-6\">\r\n              <div className=\"flex items-center gap-4\">\r\n                <div className=\"flex items-center gap-2\">\r\n                  <BuildingOfficeIcon className=\"w-4 h-4 text-purple-600\" />\r\n                  <label className=\"text-sm font-medium text-gray-700\">Empresa:</label>\r\n                </div>\r\n                <div className=\"flex-1 max-w-xs\">\r\n                  {loadingCompanies ? (\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <div className=\"w-4 h-4 border-2 border-purple-500 border-t-transparent rounded-full animate-spin\"></div>\r\n                      <span className=\"text-sm text-gray-500\">Cargando empresas...</span>\r\n                    </div>\r\n                  ) : (\r\n                    <select\r\n                      value={selectedCompany}\r\n                      onChange={(e) => {\r\n                        EXTREME_LOG('onChange select empresa', { \r\n                          oldValue: selectedCompany, \r\n                          newValue: e.target.value \r\n                        });\r\n                        setSelectedCompany(e.target.value);\r\n                      }}\r\n                      className=\"w-full px-3 py-2 text-sm border border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white text-gray-900\"\r\n                    >\r\n                      <option value=\"all\">Todas las empresas</option>\r\n                      {companiesFromDB.map((company) => {\r\n                        EXTREME_LOG('Renderizando opci√≥n empresa', company);\r\n                        return (\r\n                          <option key={company.id} value={company.id}>\r\n                            {company.name}\r\n                          </option>\r\n                        );\r\n                      })}\r\n                    </select>\r\n                  )}\r\n                </div>\r\n                \r\n                {/* M√âTRICAS REALES */}\r\n                {companyMetrics && (\r\n                  <div className=\"flex items-center gap-4 text-xs bg-green-100 p-2 rounded-lg\">\r\n                    <div className=\"flex items-center gap-1\">\r\n                      <span className=\"text-gray-600 font-bold\">Empleados:</span>\r\n                      <span className=\"font-bold text-green-600 text-lg\">{companyMetrics.employeeCount}</span>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-1\">\r\n                      <span className=\"text-gray-600 font-bold\">Engagement:</span>\r\n                      <span className=\"font-bold text-blue-600\">{companyMetrics.engagementRate}%</span>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-1\">\r\n                      <span className=\"text-gray-600 font-bold\">Mensajes:</span>\r\n                      <span className=\"font-bold text-purple-600\">{companyMetrics.messageStats.total}</span>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n\r\n            {/* M√©tricas Principales */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8\">\r\n              {/* Tarjeta de Empleados */}\r\n              <div className=\"bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-purple-100 hover:shadow-md transition-all duration-300\">\r\n                <div className=\"flex items-center justify-between mb-2\">\r\n                  <div className=\"bg-purple-100 p-2 rounded-lg\">\r\n                    <BuildingOfficeIcon className=\"h-5 w-5 text-purple-600\" />\r\n                  </div>\r\n                  <span className=\"text-xs font-medium text-green-600 bg-green-100 px-2 py-1 rounded-full\">\r\n                    {companyMetrics?.employeeCount > 0 ? 'Con datos' : 'Sin datos'}\r\n                  </span>\r\n                </div>\r\n                <p className=\"text-2xl font-bold text-gray-900\">\r\n                  {companyMetrics?.employeeCount ?? 0}\r\n                </p>\r\n                <p className=\"text-sm text-gray-600\">\r\n                  Empleados {selectedCompany !== 'all' ? 'Reales' : 'Totales'}\r\n                </p>\r\n                {companyMetrics && (\r\n                  <div className=\"mt-2 text-xs text-green-600 bg-green-50 p-1 rounded\">\r\n                    ‚úÖ Datos cargados correctamente\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              {/* Tarjeta de Engagement */}\r\n              <div className=\"bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-blue-100 hover:shadow-md transition-all duration-300\">\r\n                <div className=\"flex items-center justify-between mb-2\">\r\n                  <div className=\"bg-blue-100 p-2 rounded-lg\">\r\n                    <ChartBarIcon className=\"h-5 w-5 text-blue-600\" />\r\n                  </div>\r\n                  <span className=\"text-xs font-medium text-blue-600 bg-blue-100 px-2 py-1 rounded-full\">\r\n                    {companyMetrics?.messageStats?.total > 0 ? 'Activo' : 'Inactivo'}\r\n                  </span>\r\n                </div>\r\n                <p className=\"text-2xl font-bold text-gray-900\">\r\n                  {companyMetrics?.engagementRate ?? 0}%\r\n                </p>\r\n                <p className=\"text-sm text-gray-600\">Engagement Real</p>\r\n              </div>\r\n\r\n              {/* Tarjeta de Mensajes */}\r\n              <div className=\"bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-cyan-100 hover:shadow-md transition-all duration-300\">\r\n                <div className=\"flex items-center justify-between mb-2\">\r\n                  <div className=\"bg-cyan-100 p-2 rounded-lg\">\r\n                    <BellIcon className=\"h-5 w-5 text-cyan-600\" />\r\n                  </div>\r\n                  <span className=\"text-xs font-medium text-orange-600 bg-orange-100 px-2 py-1 rounded-full\">\r\n                    {companyMetrics?.messageStats?.total > 0 ? 'Con datos' : 'Sin datos'}\r\n                  </span>\r\n                </div>\r\n                <p className=\"text-2xl font-bold text-gray-900\">\r\n                  {companyMetrics?.messageStats?.total ?? 0}\r\n                </p>\r\n                <p className=\"text-sm text-gray-600\">Mensajes Enviados</p>\r\n              </div>\r\n\r\n              {/* Tarjeta de Tasa de Lectura */}\r\n              <div className=\"bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-rose-100 hover:shadow-md transition-all duration-300\">\r\n                <div className=\"flex items-center justify-between mb-2\">\r\n                  <div className=\"bg-rose-100 p-2 rounded-lg\">\r\n                    <SparklesIcon className=\"h-5 w-5 text-rose-600\" />\r\n                  </div>\r\n                  <span className=\"text-xs font-medium text-rose-600 bg-rose-100 px-2 py-1 rounded-full\">Real</span>\r\n                </div>\r\n                <p className=\"text-2xl font-bold text-gray-900\">\r\n                  {companyMetrics?.readRate ?? 0}%\r\n                </p>\r\n                <p className=\"text-sm text-gray-600\">Tasa de Lectura</p>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Mensaje de estado */}\r\n            <div className=\"mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200\">\r\n              <p className=\"text-sm text-blue-800\">\r\n                <strong>Modo Debug Activo:</strong> Revisa la consola del navegador (F12) para ver logs detallados.\r\n              </p>\r\n            </div>\r\n          </div>\r\n        );\r\n    }\r\n  };\r\n\r\n  EXTREME_LOG('Render principal', { currentTab });\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-50 to-blue-50\">\r\n      {/* Header */}\r\n      <div className=\"bg-white shadow-lg border-b border-gray-200 sticky top-0 z-40\">\r\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\r\n          <div className=\"flex items-center justify-between py-4\">\r\n            <div className=\"md:hidden\">\r\n              <button\r\n                onClick={() => setMobileMenuOpen(!mobileMenuOpen)}\r\n                className=\"text-gray-500 hover:text-gray-700 p-2 rounded-lg hover:bg-gray-100 transition-colors\"\r\n              >\r\n                {mobileMenuOpen ? (\r\n                  <XMarkIcon className=\"h-6 w-6\" />\r\n                ) : (\r\n                  <Bars3Icon className=\"h-6 w-6\" />\r\n                )}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Main content */}\r\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4\">\r\n        {/* Desktop horizontal menu */}\r\n        <div className=\"mb-4\">\r\n          <nav className=\"flex items-center justify-center gap-3 bg-gradient-to-r from-slate-50 to-gray-50 rounded-2xl p-4 shadow-lg border border-gray-200/50 backdrop-blur-sm overflow-x-auto\">\r\n            {[\r\n              { id: 'dashboard', name: 'Tendencias', icon: ChartBarIcon, url: '/base-de-datos' },\r\n              { id: 'database', name: 'Datos', icon: BuildingOfficeIcon, url: '/base-de-datos/database' },\r\n              { id: 'send', name: 'Enviar', icon: PaperAirplaneIcon, url: '/communication/send' },\r\n              { id: 'folders', name: 'Carpetas', icon: FolderIcon, url: '/communication/folders' },\r\n              { id: 'templates', name: 'Plantillas', icon: TemplateIcon, url: '/communication/templates' },\r\n              { id: 'reports', name: 'Reportes', icon: DocumentReportIcon, url: '/communication/reports' },\r\n              { id: 'bulk-upload', name: 'Importar', icon: ArrowUpTrayIcon, url: '/communication/bulk-upload' },\r\n            ].map((tab) => {\r\n              const Icon = tab.icon;\r\n              const isActive = window.location.pathname === tab.url;\r\n\r\n              return (\r\n                <div key={tab.id} className=\"relative group\">\r\n                  <button\r\n                    onClick={() => {\r\n                      EXTREME_LOG('Navegando a', tab.url);\r\n                      navigate(tab.url);\r\n                    }}\r\n                    className={`relative flex items-center px-6 py-3 rounded-xl text-sm font-semibold transition-all duration-300 transform ${\r\n                      isActive\r\n                        ? 'bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-xl scale-105'\r\n                        : 'bg-white text-gray-700 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-700 hover:shadow-md hover:scale-102 border border-gray-200'\r\n                    }`}\r\n                  >\r\n                    <Icon className={`h-5 w-5 mr-3 transition-colors duration-300 ${\r\n                      isActive ? 'text-blue-100' : 'text-blue-500 group-hover:text-blue-600'\r\n                    }`} />\r\n                    <span className=\"tracking-wide\">{tab.name}</span>\r\n                  </button>\r\n                </div>\r\n              );\r\n            })}\r\n          </nav>\r\n        </div>\r\n\r\n        <div className=\"w-full\">\r\n          {renderActiveTab()}\r\n        </div>\r\n\r\n        {/* Debuggers */}\r\n        {process.env.NODE_ENV === 'production' && (\r\n          <>\r\n            <ProductionDatabaseDebugger />\r\n            <ProductionEnvChecker />\r\n          </>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default WebrifyCommunicationDashboard_DEBUG;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\communication\\employeeData.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\dashboard\\AIRecommendations.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadRecommendations'. Either include it or remove the dependency array.","line":23,"column":6,"nodeType":"ArrayExpression","endLine":23,"endColumn":22,"suggestions":[{"desc":"Update the dependencies array to be: [dashboardStats, loadRecommendations]","fix":{"range":[747,763],"text":"[dashboardStats, loadRecommendations]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { motion, AnimatePresence } from 'framer-motion';\r\nimport { \r\n  SparklesIcon, \r\n  LightBulbIcon, \r\n  ChartBarIcon, \r\n  ExclamationTriangleIcon,\r\n  CheckCircleIcon,\r\n  XMarkIcon\r\n} from '@heroicons/react/24/outline';\r\nimport aiRecommendationsService from '../../services/aiRecommendationsService.js';\r\n\r\nconst AIRecommendations = ({ dashboardStats, onRecommendationClick }) => {\r\n  const [recommendations, setRecommendations] = useState([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState(null);\r\n  const [dismissed, setDismissed] = useState(new Set());\r\n\r\n  useEffect(() => {\r\n    if (dashboardStats) {\r\n      loadRecommendations();\r\n    }\r\n  }, [dashboardStats]);\r\n\r\n  const loadRecommendations = async () => {\r\n    setLoading(true);\r\n    setError(null);\r\n    \r\n    try {\r\n      const recs = await aiRecommendationsService.getDashboardRecommendations(dashboardStats);\r\n      setRecommendations(recs);\r\n    } catch (err) {\r\n      console.error('Error loading AI recommendations:', err);\r\n      setError('No se pudieron cargar las recomendaciones de IA');\r\n      \r\n      // Recomendaciones de respaldo si falla la API\r\n      setRecommendations(getFallbackRecommendations());\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const getFallbackRecommendations = () => {\r\n    if (!dashboardStats) return [];\r\n    \r\n    const recs = [];\r\n    \r\n    // Recomendaciones basadas en estad√≠sticas simples\r\n    if (dashboardStats.folders > 500) {\r\n      recs.push({\r\n        type: 'optimization',\r\n        title: 'Optimizaci√≥n de Carpetas',\r\n        description: 'Tienes muchas carpetas. Considera organizarlas por departamentos para mejorar la eficiencia.',\r\n        priority: 'medium',\r\n        action: 'organize_folders'\r\n      });\r\n    }\r\n    \r\n    if (dashboardStats.documents > 1000) {\r\n      recs.push({\r\n        type: 'storage',\r\n        title: 'Gesti√≥n de Almacenamiento',\r\n        description: 'Tu almacenamiento est√° creciendo r√°pidamente. Revisa archivos antiguos para liberar espacio.',\r\n        priority: 'high',\r\n        action: 'cleanup_storage'\r\n      });\r\n    }\r\n    \r\n    if (dashboardStats.tokensUsed > 50000) {\r\n      recs.push({\r\n        type: 'usage',\r\n        title: 'Uso de Tokens',\r\n        description: 'Est√°s usando muchos tokens. Considera optimizar las consultas o actualizar tu plan.',\r\n        priority: 'medium',\r\n        action: 'optimize_tokens'\r\n      });\r\n    }\r\n    \r\n    return recs;\r\n  };\r\n\r\n  const dismissRecommendation = (id) => {\r\n    setDismissed(prev => new Set(prev).add(id));\r\n  };\r\n\r\n  const getRecommendationIcon = (type) => {\r\n    switch (type) {\r\n      case 'optimization':\r\n        return <ChartBarIcon className=\"w-5 h-5 text-blue-500\" />;\r\n      case 'storage':\r\n        return <ExclamationTriangleIcon className=\"w-5 h-5 text-yellow-500\" />;\r\n      case 'usage':\r\n        return <LightBulbIcon className=\"w-5 h-5 text-purple-500\" />;\r\n      case 'insight':\r\n        return <SparklesIcon className=\"w-5 h-5 text-green-500\" />;\r\n      default:\r\n        return <LightBulbIcon className=\"w-5 h-5 text-gray-500\" />;\r\n    }\r\n  };\r\n\r\n  const getPriorityColor = (priority) => {\r\n    switch (priority) {\r\n      case 'high':\r\n        return 'border-red-200 bg-red-50';\r\n      case 'medium':\r\n        return 'border-yellow-200 bg-yellow-50';\r\n      case 'low':\r\n        return 'border-green-200 bg-green-50';\r\n      default:\r\n        return 'border-gray-200 bg-gray-50';\r\n    }\r\n  };\r\n\r\n  const handleRecommendationClick = (recommendation) => {\r\n    if (onRecommendationClick) {\r\n      onRecommendationClick(recommendation);\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"bg-white rounded-xl shadow-lg border border-gray-200 p-6\">\r\n        <div className=\"flex items-center space-x-3\">\r\n          <div className=\"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600\"></div>\r\n          <span className=\"text-gray-600\">Generando recomendaciones con IA...</span>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"bg-white rounded-xl shadow-lg border border-gray-200 p-6\">\r\n        <div className=\"flex items-center space-x-3 text-red-600\">\r\n          <ExclamationTriangleIcon className=\"w-5 h-5\" />\r\n          <span>{error}</span>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const visibleRecommendations = recommendations.filter(rec => !dismissed.has(rec.id));\r\n\r\n  if (visibleRecommendations.length === 0) {\r\n    return (\r\n      <div className=\"bg-white rounded-xl shadow-lg border border-gray-200 p-6\">\r\n        <div className=\"flex items-center space-x-3 text-gray-500\">\r\n          <CheckCircleIcon className=\"w-5 h-5\" />\r\n          <span>No hay recomendaciones nuevas en este momento</span>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"flex items-center space-x-2 mb-4\">\r\n        <SparklesIcon className=\"w-6 h-6 text-purple-600\" />\r\n        <h3 className=\"text-lg font-semibold text-gray-900\">Recomendaciones de IA</h3>\r\n        <span className=\"bg-purple-100 text-purple-800 text-xs font-medium px-2.5 py-0.5 rounded-full\">\r\n          {visibleRecommendations.length}\r\n        </span>\r\n      </div>\r\n      \r\n      <AnimatePresence>\r\n        {visibleRecommendations.map((recommendation, index) => (\r\n          <motion.div\r\n            key={recommendation.id || index}\r\n            initial={{ opacity: 0, x: -20 }}\r\n            animate={{ opacity: 1, x: 0 }}\r\n            exit={{ opacity: 0, x: 20 }}\r\n            transition={{ duration: 0.3, delay: index * 0.1 }}\r\n            className={`border rounded-lg p-4 cursor-pointer transition-all hover:shadow-md ${getPriorityColor(recommendation.priority)}`}\r\n            onClick={() => handleRecommendationClick(recommendation)}\r\n          >\r\n            <div className=\"flex items-start justify-between\">\r\n              <div className=\"flex items-start space-x-3 flex-1\">\r\n                <div className=\"flex-shrink-0 mt-0.5\">\r\n                  {getRecommendationIcon(recommendation.type)}\r\n                </div>\r\n                <div className=\"flex-1\">\r\n                  <h4 className=\"font-medium text-gray-900 mb-1\">\r\n                    {recommendation.title}\r\n                  </h4>\r\n                  <p className=\"text-sm text-gray-600\">\r\n                    {recommendation.description}\r\n                  </p>\r\n                  {recommendation.action && (\r\n                    <button className=\"mt-2 text-sm text-blue-600 hover:text-blue-800 font-medium\">\r\n                      Ver detalles ‚Üí\r\n                    </button>\r\n                  )}\r\n                </div>\r\n              </div>\r\n              \r\n              <button\r\n                onClick={(e) => {\r\n                  e.stopPropagation();\r\n                  dismissRecommendation(recommendation.id || index);\r\n                }}\r\n                className=\"flex-shrink-0 ml-2 text-gray-400 hover:text-gray-600 transition-colors\"\r\n              >\r\n                <XMarkIcon className=\"w-4 h-4\" />\r\n              </button>\r\n            </div>\r\n          </motion.div>\r\n        ))}\r\n      </AnimatePresence>\r\n      \r\n      {recommendations.length > 0 && (\r\n        <div className=\"flex justify-center mt-4\">\r\n          <button\r\n            onClick={loadRecommendations}\r\n            className=\"text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center space-x-1\"\r\n          >\r\n            <SparklesIcon className=\"w-4 h-4\" />\r\n            <span>Actualizar recomendaciones</span>\r\n          </button>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default AIRecommendations;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\dashboard\\CommunicationStats.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\dashboard\\CompanyCard.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\dashboard\\CompanyEmployeeTest.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\dashboard\\CompanySummary.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\dashboard\\CustomizableDashboard.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'useRef' is defined but never used.","line":10,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":57},{"ruleId":"no-unused-vars","severity":1,"message":"'ChartBarIcon' is defined but never used.","line":12,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":15},{"ruleId":"no-unused-vars","severity":1,"message":"'UserGroupIcon' is defined but never used.","line":13,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'EnvelopeIcon' is defined but never used.","line":14,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":15},{"ruleId":"no-unused-vars","severity":1,"message":"'PhoneIcon' is defined but never used.","line":15,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'draggedWidget' is assigned a value but never used.","line":136,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":136,"endColumn":23},{"ruleId":"no-unused-vars","severity":1,"message":"'setDraggedWidget' is assigned a value but never used.","line":136,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":136,"endColumn":41},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadDashboardConfig', 'setupKeyboardShortcuts', and 'setupThemeDetection'. Either include them or remove the dependency array.","line":143,"column":6,"nodeType":"ArrayExpression","endLine":143,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [loadDashboardConfig, setupKeyboardShortcuts, setupThemeDetection, userId]","fix":{"range":[3678,3686],"text":"[loadDashboardConfig, setupKeyboardShortcuts, setupThemeDetection, userId]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'saveCurrentLayout' and 'toggleTheme'. Either include them or remove the dependency array.","line":208,"column":6,"nodeType":"ArrayExpression","endLine":208,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [isEditMode, saveCurrentLayout, toggleTheme]","fix":{"range":[5773,5785],"text":"[isEditMode, saveCurrentLayout, toggleTheme]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'applyTheme'. Either include it or remove the dependency array.","line":221,"column":6,"nodeType":"ArrayExpression","endLine":221,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [applyTheme, theme]","fix":{"range":[6138,6145],"text":"[applyTheme, theme]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'updateWidgetConfig' is assigned a value but never used.","line":285,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":285,"endColumn":27},{"ruleId":"no-restricted-globals","severity":2,"message":"Unexpected use of 'confirm'.","line":331,"column":10,"nodeType":"Identifier","messageId":"defaultMessage","endLine":331,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Customizable Dashboard\r\n * Dashboard personalizable con widgets arrastrables y temas\r\n * \r\n * ‚úÖ NO MODIFICA c√≥digo existente\r\n * ‚úÖ Completamente independiente\r\n * ‚úÖ Puede ser desactivado sin afectar el sistema\r\n */\r\n\r\nimport React, { useState, useEffect, useCallback, useRef } from 'react'\r\nimport { \r\n  ChartBarIcon, \r\n  UserGroupIcon, \r\n  EnvelopeIcon, \r\n  PhoneIcon,\r\n  CogIcon,\r\n  PlusIcon,\r\n  MinusIcon,\r\n  ArrowsPointingOutIcon,\r\n  ArrowsPointingInIcon,\r\n  SunIcon,\r\n  MoonIcon,\r\n  ComputerDesktopIcon\r\n} from '@heroicons/react/24/outline'\r\nimport { DragDropContext, Droppable, Draggable } from 'react-beautiful-dnd'\r\n\r\n// Configuraci√≥n de widgets por defecto\r\nconst DEFAULT_WIDGETS = [\r\n  {\r\n    id: 'stats-overview',\r\n    type: 'stats',\r\n    title: 'Resumen de Estad√≠sticas',\r\n    size: 'large',\r\n    position: { x: 0, y: 0, w: 2, h: 1 },\r\n    config: {\r\n      showTrends: true,\r\n      metrics: ['users', 'messages', 'engagement']\r\n    }\r\n  },\r\n  {\r\n    id: 'recent-activity',\r\n    type: 'activity',\r\n    title: 'Actividad Reciente',\r\n    size: 'medium',\r\n    position: { x: 2, y: 0, w: 1, h: 2 },\r\n    config: {\r\n      maxItems: 10,\r\n      showTimestamp: true\r\n    }\r\n  },\r\n  {\r\n    id: 'quick-actions',\r\n    type: 'actions',\r\n    title: 'Acciones R√°pidas',\r\n    size: 'small',\r\n    position: { x: 3, y: 0, w: 1, h: 1 },\r\n    config: {\r\n      actions: ['new-message', 'add-user', 'view-reports']\r\n    }\r\n  },\r\n  {\r\n    id: 'chart-performance',\r\n    type: 'chart',\r\n    title: 'Rendimiento',\r\n    size: 'large',\r\n    position: { x: 0, y: 1, w: 2, h: 2 },\r\n    config: {\r\n      chartType: 'line',\r\n      timeRange: '7d'\r\n    }\r\n  },\r\n  {\r\n    id: 'notifications',\r\n    type: 'notifications',\r\n    title: 'Notificaciones',\r\n    size: 'medium',\r\n    position: { x: 2, y: 2, w: 1, h: 1 },\r\n    config: {\r\n      maxItems: 5,\r\n      showUnreadOnly: true\r\n    }\r\n  }\r\n]\r\n\r\n// Temos disponibles\r\nconst THEMES = {\r\n  light: {\r\n    name: 'Claro',\r\n    icon: SunIcon,\r\n    colors: {\r\n      background: 'bg-gray-50',\r\n      card: 'bg-white',\r\n      text: 'text-gray-900',\r\n      textSecondary: 'text-gray-600',\r\n      border: 'border-gray-200',\r\n      primary: 'bg-blue-500',\r\n      secondary: 'bg-gray-100'\r\n    }\r\n  },\r\n  dark: {\r\n    name: 'Oscuro',\r\n    icon: MoonIcon,\r\n    colors: {\r\n      background: 'bg-gray-900',\r\n      card: 'bg-gray-800',\r\n      text: 'text-gray-100',\r\n      textSecondary: 'text-gray-400',\r\n      border: 'border-gray-700',\r\n      primary: 'bg-blue-600',\r\n      secondary: 'bg-gray-700'\r\n    }\r\n  },\r\n  auto: {\r\n    name: 'Autom√°tico',\r\n    icon: ComputerDesktopIcon,\r\n    colors: {\r\n      background: 'bg-gray-50 dark:bg-gray-900',\r\n      card: 'bg-white dark:bg-gray-800',\r\n      text: 'text-gray-900 dark:text-gray-100',\r\n      textSecondary: 'text-gray-600 dark:text-gray-400',\r\n      border: 'border-gray-200 dark:border-gray-700',\r\n      primary: 'bg-blue-500 dark:bg-blue-600',\r\n      secondary: 'bg-gray-100 dark:bg-gray-700'\r\n    }\r\n  }\r\n}\r\n\r\nconst CustomizableDashboard = ({ userId = 'default' }) => {\r\n  const [widgets, setWidgets] = useState(DEFAULT_WIDGETS)\r\n  const [theme, setTheme] = useState('auto')\r\n  const [isEditMode, setIsEditMode] = useState(false)\r\n  const [isCompactMode, setIsCompactMode] = useState(false)\r\n  const [savedLayouts, setSavedLayouts] = useState([])\r\n  const [currentLayoutName, setCurrentLayoutName] = useState('Por Defecto')\r\n  const [showLayoutDialog, setShowLayoutDialog] = useState(false)\r\n  const [draggedWidget, setDraggedWidget] = useState(null)\r\n  \r\n  // Cargar configuraci√≥n guardada\r\n  useEffect(() => {\r\n    loadDashboardConfig()\r\n    setupKeyboardShortcuts()\r\n    setupThemeDetection()\r\n  }, [userId])\r\n\r\n  const loadDashboardConfig = useCallback(() => {\r\n    try {\r\n      const savedConfig = localStorage.getItem(`dashboard_config_${userId}`)\r\n      if (savedConfig) {\r\n        const config = JSON.parse(savedConfig)\r\n        setWidgets(config.widgets || DEFAULT_WIDGETS)\r\n        setTheme(config.theme || 'auto')\r\n        setIsCompactMode(config.compactMode || false)\r\n        setCurrentLayoutName(config.layoutName || 'Por Defecto')\r\n      }\r\n\r\n      const savedLayoutsData = localStorage.getItem(`dashboard_layouts_${userId}`)\r\n      if (savedLayoutsData) {\r\n        setSavedLayouts(JSON.parse(savedLayoutsData))\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading dashboard config:', error)\r\n    }\r\n  }, [userId])\r\n\r\n  const saveDashboardConfig = useCallback(() => {\r\n    try {\r\n      const config = {\r\n        widgets,\r\n        theme,\r\n        compactMode: isCompactMode,\r\n        layoutName: currentLayoutName,\r\n        lastUpdated: new Date().toISOString()\r\n      }\r\n      localStorage.setItem(`dashboard_config_${userId}`, JSON.stringify(config))\r\n    } catch (error) {\r\n      console.error('Error saving dashboard config:', error)\r\n    }\r\n  }, [widgets, theme, isCompactMode, currentLayoutName, userId])\r\n\r\n  const setupKeyboardShortcuts = useCallback(() => {\r\n    const handleKeyPress = (e) => {\r\n      // Ctrl/Cmd + E: Edit mode\r\n      if ((e.ctrlKey || e.metaKey) && e.key === 'e') {\r\n        e.preventDefault()\r\n        setIsEditMode(!isEditMode)\r\n      }\r\n      \r\n      // Ctrl/Cmd + S: Save layout\r\n      if ((e.ctrlKey || e.metaKey) && e.key === 's') {\r\n        e.preventDefault()\r\n        saveCurrentLayout()\r\n      }\r\n      \r\n      // Ctrl/Cmd + D: Toggle theme\r\n      if ((e.ctrlKey || e.metaKey) && e.key === 'd') {\r\n        e.preventDefault()\r\n        toggleTheme()\r\n      }\r\n      \r\n      // Escape: Exit edit mode\r\n      if (e.key === 'Escape' && isEditMode) {\r\n        setIsEditMode(false)\r\n      }\r\n    }\r\n\r\n    document.addEventListener('keydown', handleKeyPress)\r\n    return () => document.removeEventListener('keydown', handleKeyPress)\r\n  }, [isEditMode])\r\n\r\n  const setupThemeDetection = useCallback(() => {\r\n    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)')\r\n    \r\n    const handleChange = (e) => {\r\n      if (theme === 'auto') {\r\n        applyTheme('auto')\r\n      }\r\n    }\r\n\r\n    mediaQuery.addListener(handleChange)\r\n    return () => mediaQuery.removeListener(handleChange)\r\n  }, [theme])\r\n\r\n  const applyTheme = useCallback((newTheme) => {\r\n    const root = document.documentElement\r\n    \r\n    if (newTheme === 'dark') {\r\n      root.classList.add('dark')\r\n    } else if (newTheme === 'light') {\r\n      root.classList.remove('dark')\r\n    } else {\r\n      // Auto theme\r\n      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches\r\n      if (prefersDark) {\r\n        root.classList.add('dark')\r\n      } else {\r\n        root.classList.remove('dark')\r\n      }\r\n    }\r\n  }, [])\r\n\r\n  const toggleTheme = useCallback(() => {\r\n    const themes = Object.keys(THEMES)\r\n    const currentIndex = themes.indexOf(theme)\r\n    const nextTheme = themes[(currentIndex + 1) % themes.length]\r\n    setTheme(nextTheme)\r\n    applyTheme(nextTheme)\r\n  }, [theme, applyTheme])\r\n\r\n  // Guardar configuraci√≥n cuando cambia\r\n  useEffect(() => {\r\n    saveDashboardConfig()\r\n  }, [saveDashboardConfig])\r\n\r\n  // Aplicar tema cuando cambia\r\n  useEffect(() => {\r\n    applyTheme(theme)\r\n  }, [theme, applyTheme])\r\n\r\n  const handleDragEnd = useCallback((result) => {\r\n    if (!result.destination) return\r\n\r\n    const items = Array.from(widgets)\r\n    const [reorderedItem] = items.splice(result.source.index, 1)\r\n    items.splice(result.destination.index, 0, reorderedItem)\r\n\r\n    setWidgets(items)\r\n  }, [widgets])\r\n\r\n  const removeWidget = useCallback((widgetId) => {\r\n    setWidgets(prev => prev.filter(w => w.id !== widgetId))\r\n  }, [])\r\n\r\n  const addWidget = useCallback((widgetType) => {\r\n    const newWidget = {\r\n      id: `widget-${Date.now()}`,\r\n      type: widgetType,\r\n      title: `Nuevo ${widgetType}`,\r\n      size: 'medium',\r\n      position: { x: 0, y: 0, w: 1, h: 1 },\r\n      config: {}\r\n    }\r\n    setWidgets(prev => [...prev, newWidget])\r\n  }, [])\r\n\r\n  const updateWidgetConfig = useCallback((widgetId, newConfig) => {\r\n    setWidgets(prev => prev.map(widget => \r\n      widget.id === widgetId \r\n        ? { ...widget, config: { ...widget.config, ...newConfig } }\r\n        : widget\r\n    ))\r\n  }, [])\r\n\r\n  const saveCurrentLayout = useCallback(() => {\r\n    const layoutName = prompt('Nombre del layout:', currentLayoutName)\r\n    if (!layoutName) return\r\n\r\n    const layout = {\r\n      name: layoutName,\r\n      widgets,\r\n      theme,\r\n      compactMode: isCompactMode,\r\n      createdAt: new Date().toISOString()\r\n    }\r\n\r\n    const existingLayoutIndex = savedLayouts.findIndex(l => l.name === layoutName)\r\n    let newLayouts\r\n    \r\n    if (existingLayoutIndex >= 0) {\r\n      newLayouts = [...savedLayouts]\r\n      newLayouts[existingLayoutIndex] = layout\r\n    } else {\r\n      newLayouts = [...savedLayouts, layout]\r\n    }\r\n\r\n    setSavedLayouts(newLayouts)\r\n    setCurrentLayoutName(layoutName)\r\n    localStorage.setItem(`dashboard_layouts_${userId}`, JSON.stringify(newLayouts))\r\n  }, [widgets, theme, isCompactMode, currentLayoutName, savedLayouts, userId])\r\n\r\n  const loadLayout = useCallback((layoutName) => {\r\n    const layout = savedLayouts.find(l => l.name === layoutName)\r\n    if (!layout) return\r\n\r\n    setWidgets(layout.widgets)\r\n    setTheme(layout.theme)\r\n    setIsCompactMode(layout.compactMode)\r\n    setCurrentLayoutName(layoutName)\r\n  }, [savedLayouts])\r\n\r\n  const deleteLayout = useCallback((layoutName) => {\r\n    if (!confirm(`¬øEliminar el layout \"${layoutName}\"?`)) return\r\n\r\n    const newLayouts = savedLayouts.filter(l => l.name !== layoutName)\r\n    setSavedLayouts(newLayouts)\r\n    localStorage.setItem(`dashboard_layouts_${userId}`, JSON.stringify(newLayouts))\r\n\r\n    if (currentLayoutName === layoutName) {\r\n      // Cargar layout por defecto\r\n      setWidgets(DEFAULT_WIDGETS)\r\n      setCurrentLayoutName('Por Defecto')\r\n    }\r\n  }, [savedLayouts, currentLayoutName, userId])\r\n\r\n  const getWidgetSize = useCallback((size) => {\r\n    const baseClass = isCompactMode ? 'p-3' : 'p-6'\r\n    const sizeClasses = {\r\n      small: `col-span-1 row-span-1 ${baseClass}`,\r\n      medium: `col-span-1 row-span-2 ${baseClass}`,\r\n      large: `col-span-2 row-span-2 ${baseClass}`,\r\n      full: `col-span-4 row-span-2 ${baseClass}`\r\n    }\r\n    return sizeClasses[size] || sizeClasses.medium\r\n  }, [isCompactMode])\r\n\r\n  const currentTheme = THEMES[theme]\r\n\r\n  // Componente Widget\r\n  const Widget = ({ widget, index }) => {\r\n    const [isExpanded, setIsExpanded] = useState(false)\r\n\r\n    const renderWidgetContent = () => {\r\n      switch (widget.type) {\r\n        case 'stats':\r\n          return <StatsWidget config={widget.config} isCompact={isCompactMode} />\r\n        case 'activity':\r\n          return <ActivityWidget config={widget.config} isCompact={isCompactMode} />\r\n        case 'actions':\r\n          return <ActionsWidget config={widget.config} isCompact={isCompactMode} />\r\n        case 'chart':\r\n          return <ChartWidget config={widget.config} isCompact={isCompactMode} />\r\n        case 'notifications':\r\n          return <NotificationsWidget config={widget.config} isCompact={isCompactMode} />\r\n        default:\r\n          return <div>Widget no encontrado</div>\r\n      }\r\n    }\r\n\r\n    return (\r\n      <Draggable draggableId={widget.id} index={index} isDragDisabled={!isEditMode}>\r\n        {(provided, snapshot) => (\r\n          <div\r\n            ref={provided.innerRef}\r\n            {...provided.draggableProps}\r\n            {...provided.dragHandleProps}\r\n            className={`\r\n              ${getWidgetSize(widget.size)}\r\n              ${currentTheme.colors.card} \r\n              ${currentTheme.colors.border} \r\n              border rounded-lg shadow-sm hover:shadow-md transition-all duration-200\r\n              ${snapshot.isDragging ? 'opacity-50 scale-105' : ''}\r\n              ${isEditMode ? 'ring-2 ring-blue-500 ring-opacity-50' : ''}\r\n              relative group\r\n            `}\r\n          >\r\n            {/* Header del widget */}\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <h3 className={`font-semibold ${currentTheme.colors.text}`}>\r\n                {widget.title}\r\n              </h3>\r\n              \r\n              <div className=\"flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n                {isEditMode && (\r\n                  <>\r\n                    <button\r\n                      onClick={() => removeWidget(widget.id)}\r\n                      className={`p-1 rounded ${currentTheme.colors.secondary} ${currentTheme.colors.textSecondary} hover:bg-red-100 hover:text-red-600`}\r\n                      title=\"Eliminar widget\"\r\n                    >\r\n                      <MinusIcon className=\"w-4 h-4\" />\r\n                    </button>\r\n                    <div {...provided.dragHandleProps} className=\"cursor-move\">\r\n                      <ArrowsPointingOutIcon className={`w-4 h-4 ${currentTheme.colors.textSecondary}`} />\r\n                    </div>\r\n                  </>\r\n                )}\r\n                \r\n                <button\r\n                  onClick={() => setIsExpanded(!isExpanded)}\r\n                  className={`p-1 rounded ${currentTheme.colors.secondary} ${currentTheme.colors.textSecondary}`}\r\n                  title={isExpanded ? \"Comprimir\" : \"Expandir\"}\r\n                >\r\n                  {isExpanded ? (\r\n                    <ArrowsPointingInIcon className=\"w-4 h-4\" />\r\n                  ) : (\r\n                    <ArrowsPointingOutIcon className=\"w-4 h-4\" />\r\n                  )}\r\n                </button>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Contenido del widget */}\r\n            <div className={isExpanded ? 'max-h-96 overflow-y-auto' : 'overflow-hidden'}>\r\n              {renderWidgetContent()}\r\n            </div>\r\n          </div>\r\n        )}\r\n      </Draggable>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className={`min-h-screen ${currentTheme.colors.background} ${currentTheme.colors.text}`}>\r\n      {/* Header de control */}\r\n      <div className={`${currentTheme.colors.card} ${currentTheme.colors.border} border-b sticky top-0 z-10`}>\r\n        <div className=\"px-6 py-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center space-x-4\">\r\n              <h1 className={`text-2xl font-bold ${currentTheme.colors.text}`}>\r\n                Dashboard Personalizable\r\n              </h1>\r\n              \r\n              <div className=\"flex items-center space-x-2\">\r\n                <span className={`text-sm ${currentTheme.colors.textSecondary}`}>\r\n                  Layout: {currentLayoutName}\r\n                </span>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex items-center space-x-4\">\r\n              {/* Selector de tema */}\r\n              <div className=\"flex items-center space-x-2\">\r\n                <button\r\n                  onClick={toggleTheme}\r\n                  className={`p-2 rounded-lg ${currentTheme.colors.secondary} ${currentTheme.colors.text} hover:opacity-80`}\r\n                  title={`Tema: ${currentTheme.name}`}\r\n                >\r\n                  <currentTheme.icon className=\"w-5 h-5\" />\r\n                </button>\r\n              </div>\r\n\r\n              {/* Modo compacto */}\r\n              <button\r\n                onClick={() => setIsCompactMode(!isCompactMode)}\r\n                className={`p-2 rounded-lg ${currentTheme.colors.secondary} ${currentTheme.colors.text} hover:opacity-80`}\r\n                title=\"Modo compacto\"\r\n              >\r\n                <ArrowsPointingInIcon className=\"w-5 h-5\" />\r\n              </button>\r\n\r\n              {/* Edit mode */}\r\n              <button\r\n                onClick={() => setIsEditMode(!isEditMode)}\r\n                className={`px-4 py-2 rounded-lg font-medium transition-colors ${\r\n                  isEditMode \r\n                    ? 'bg-blue-500 text-white hover:bg-blue-600' \r\n                    : `${currentTheme.colors.secondary} ${currentTheme.colors.text}`\r\n                }`}\r\n              >\r\n                {isEditMode ? 'Guardar' : 'Editar'}\r\n              </button>\r\n\r\n              {/* Layouts */}\r\n              <div className=\"relative\">\r\n                <button\r\n                  onClick={() => setShowLayoutDialog(!showLayoutDialog)}\r\n                  className={`p-2 rounded-lg ${currentTheme.colors.secondary} ${currentTheme.colors.text} hover:opacity-80`}\r\n                  title=\"Gestionar layouts\"\r\n                >\r\n                  <CogIcon className=\"w-5 h-5\" />\r\n                </button>\r\n\r\n                {showLayoutDialog && (\r\n                  <div className={`absolute right-0 mt-2 w-64 ${currentTheme.colors.card} ${currentTheme.colors.border} border rounded-lg shadow-lg z-20`}>\r\n                    <div className=\"p-4\">\r\n                      <h4 className={`font-semibold ${currentTheme.colors.text} mb-3`}>\r\n                        Layouts Guardados\r\n                      </h4>\r\n                      \r\n                      <div className=\"space-y-2\">\r\n                        {savedLayouts.map(layout => (\r\n                          <div key={layout.name} className=\"flex items-center justify-between\">\r\n                            <button\r\n                              onClick={() => {\r\n                                loadLayout(layout.name)\r\n                                setShowLayoutDialog(false)\r\n                              }}\r\n                              className={`text-left ${currentTheme.colors.textSecondary} hover:${currentTheme.colors.text}`}\r\n                            >\r\n                              {layout.name}\r\n                            </button>\r\n                            <button\r\n                              onClick={() => deleteLayout(layout.name)}\r\n                              className=\"text-red-500 hover:text-red-700\"\r\n                            >\r\n                              <MinusIcon className=\"w-4 h-4\" />\r\n                            </button>\r\n                          </div>\r\n                        ))}\r\n                      </div>\r\n\r\n                      <div className=\"mt-4 pt-3 border-t border-gray-200 dark:border-gray-700\">\r\n                        <button\r\n                          onClick={saveCurrentLayout}\r\n                          className={`w-full px-3 py-2 ${currentTheme.colors.primary} text-white rounded-lg hover:opacity-90`}\r\n                        >\r\n                          Guardar Layout Actual\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Atajos de teclado */}\r\n          {isEditMode && (\r\n            <div className={`mt-3 text-sm ${currentTheme.colors.textSecondary}`}>\r\n              Atajos: <kbd className=\"px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded\">Ctrl+E</kbd> Editar ‚Ä¢ \r\n              <kbd className=\"px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded\">Ctrl+S</kbd> Guardar ‚Ä¢ \r\n              <kbd className=\"px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded\">Ctrl+D</kbd> Tema ‚Ä¢ \r\n              <kbd className=\"px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded\">Esc</kbd> Salir\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Contenido principal */}\r\n      <div className=\"p-6\">\r\n        <DragDropContext onDragEnd={handleDragEnd}>\r\n          <Droppable droppableId=\"dashboard\" direction=\"horizontal\">\r\n            {(provided) => (\r\n              <div\r\n                {...provided.droppableProps}\r\n                ref={provided.innerRef}\r\n                className=\"grid grid-cols-4 gap-4 auto-rows-min\"\r\n              >\r\n                {widgets.map((widget, index) => (\r\n                  <Widget key={widget.id} widget={widget} index={index} />\r\n                ))}\r\n                {provided.placeholder}\r\n              </div>\r\n            )}\r\n          </Droppable>\r\n        </DragDropContext>\r\n\r\n        {/* Bot√≥n para agregar widget (solo en modo edici√≥n) */}\r\n        {isEditMode && (\r\n          <div className=\"fixed bottom-6 right-6\">\r\n            <button\r\n              onClick={() => {\r\n                const widgetTypes = ['stats', 'activity', 'actions', 'chart', 'notifications']\r\n                const type = prompt(`Tipo de widget (${widgetTypes.join(', ')}):`)\r\n                if (type && widgetTypes.includes(type)) {\r\n                  addWidget(type)\r\n                }\r\n              }}\r\n              className=\"bg-blue-500 text-white p-4 rounded-full shadow-lg hover:bg-blue-600 transition-colors\"\r\n              title=\"Agregar widget\"\r\n            >\r\n              <PlusIcon className=\"w-6 h-6\" />\r\n            </button>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n// Widgets componentes (simplificados para ejemplo)\r\nconst StatsWidget = ({ config, isCompact }) => (\r\n  <div className=\"space-y-4\">\r\n    <div className=\"grid grid-cols-2 gap-4\">\r\n      <div className=\"text-center\">\r\n        <div className=\"text-2xl font-bold text-blue-600\">1,234</div>\r\n        <div className={`text-xs ${isCompact ? 'text-gray-500' : 'text-gray-600'}`}>Usuarios</div>\r\n      </div>\r\n      <div className=\"text-center\">\r\n        <div className=\"text-2xl font-bold text-green-600\">5,678</div>\r\n        <div className={`text-xs ${isCompact ? 'text-gray-500' : 'text-gray-600'}`}>Mensajes</div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n)\r\n\r\nconst ActivityWidget = ({ config, isCompact }) => (\r\n  <div className=\"space-y-2\">\r\n    <div className=\"flex items-center justify-between\">\r\n      <span className={`text-sm ${isCompact ? 'text-gray-700' : 'text-gray-600'}`}>Nuevo usuario registrado</span>\r\n      <span className=\"text-xs text-gray-400\">hace 5 min</span>\r\n    </div>\r\n    <div className=\"flex items-center justify-between\">\r\n      <span className={`text-sm ${isCompact ? 'text-gray-700' : 'text-gray-600'}`}>Mensaje enviado</span>\r\n      <span className=\"text-xs text-gray-400\">hace 15 min</span>\r\n    </div>\r\n  </div>\r\n)\r\n\r\nconst ActionsWidget = ({ config, isCompact }) => (\r\n  <div className=\"grid grid-cols-2 gap-2\">\r\n    <button className={`p-2 ${isCompact ? 'text-xs' : 'text-sm'} bg-blue-500 text-white rounded hover:bg-blue-600`}>\r\n      Nuevo Mensaje\r\n    </button>\r\n    <button className={`p-2 ${isCompact ? 'text-xs' : 'text-sm'} bg-green-500 text-white rounded hover:bg-green-600`}>\r\n      Agregar Usuario\r\n    </button>\r\n  </div>\r\n)\r\n\r\nconst ChartWidget = ({ config, isCompact }) => (\r\n  <div className=\"h-32 bg-gray-100 dark:bg-gray-700 rounded flex items-center justify-center\">\r\n    <span className=\"text-gray-500\">Gr√°fico de rendimiento</span>\r\n  </div>\r\n)\r\n\r\nconst NotificationsWidget = ({ config, isCompact }) => (\r\n  <div className=\"space-y-2\">\r\n    <div className={`p-2 ${isCompact ? 'text-xs' : 'text-sm'} bg-blue-50 dark:bg-blue-900/20 rounded`}>\r\n      <div className=\"font-medium\">Nueva notificaci√≥n</div>\r\n      <div className=\"text-gray-600 dark:text-gray-400\">Sistema actualizado</div>\r\n    </div>\r\n  </div>\r\n)\r\n\r\nexport default CustomizableDashboard","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\dashboard\\Dashboard.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'embeddingsService' is defined but never used.","line":6,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":25},{"ruleId":"no-unused-vars","severity":1,"message":"'ExclamationTriangleIcon' is defined but never used.","line":12,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":26},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadDashboardData'. Either include it or remove the dependency array.","line":62,"column":6,"nodeType":"ArrayExpression","endLine":62,"endColumn":25,"suggestions":[{"desc":"Update the dependencies array to be: [loadDashboardData, user, userProfile]","fix":{"range":[1986,2005],"text":"[loadDashboardData, user, userProfile]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'checkGoogleDriveConnection'. Either include it or remove the dependency array.","line":69,"column":6,"nodeType":"ArrayExpression","endLine":69,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [checkGoogleDriveConnection, userProfile]","fix":{"range":[2179,2192],"text":"[checkGoogleDriveConnection, userProfile]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { Link } from 'react-router-dom'\r\nimport { useAuth } from '../../contexts/AuthContext.js'\r\nimport { db, supabase } from '../../lib/supabase.js'\r\nimport googleDriveService from '../../lib/googleDrive.js'\r\nimport embeddingsService from '../../lib/embeddings.js'\r\nimport {\r\n  FolderIcon,\r\n  DocumentIcon,\r\n  CloudIcon,\r\n  ChartBarIcon,\r\n  ExclamationTriangleIcon,\r\n  PlusIcon\r\n} from '@heroicons/react/24/outline'\r\nimport LoadingSpinner from '../common/LoadingSpinner.js'\r\nimport TokenUsage from '../embeddings/TokenUsage.js'\r\nimport TemplateDownload from '../templates/TemplateDownload.js'\r\nimport toast from 'react-hot-toast'\r\n\r\nconst Dashboard = () => {\r\n  const { user, userProfile } = useAuth()\r\n  const [isGoogleDriveConnected, setIsGoogleDriveConnected] = useState(false)\r\n  const [loading, setLoading] = useState(true)\r\n  const [stats, setStats] = useState({\r\n    totalFolders: 0,\r\n    totalFiles: 0,\r\n    storageUsed: 0,\r\n    tokensUsed: 0\r\n  })\r\n\r\n  // Timeout de seguridad para evitar loading infinito\r\n  useEffect(() => {\r\n    const maxLoadingTimeout = setTimeout(() => {\r\n      console.log('Dashboard: Max loading timeout reached, forcing loading to false')\r\n      setLoading(false)\r\n    }, 10000) // 10 segundos m√°ximo\r\n\r\n    return () => clearTimeout(maxLoadingTimeout)\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    let loadTimeout = null\r\n    \r\n    if (user && userProfile) {\r\n      // Debounce para evitar llamadas excesivas\r\n      loadTimeout = setTimeout(() => {\r\n        loadDashboardData()\r\n      }, 300)\r\n    } else if (user && !userProfile) {\r\n      // Usuario existe pero userProfile a√∫n no se ha cargado, mantener loading\r\n      console.log('Dashboard: User exists but userProfile not loaded yet')\r\n    } else {\r\n      // Si no hay usuario, asegurar que loading sea false\r\n      setLoading(false)\r\n    }\r\n    \r\n    return () => {\r\n      if (loadTimeout) {\r\n        clearTimeout(loadTimeout)\r\n      }\r\n    }\r\n  }, [user, userProfile])\r\n\r\n  // Efecto separado para verificar Google Drive cuando userProfile cambie\r\n  useEffect(() => {\r\n    if (userProfile) {\r\n      checkGoogleDriveConnection()\r\n    }\r\n  }, [userProfile])\r\n\r\n  const loadDashboardData = async () => {\r\n    if (!user) {\r\n      console.log('Dashboard: No user found, skipping load')\r\n      setLoading(false)\r\n      return\r\n    }\r\n    \r\n    if (!userProfile) {\r\n      console.log('Dashboard: UserProfile not available yet, skipping load')\r\n      return\r\n    }\r\n    \r\n    console.log('Dashboard: Starting to load data for user:', user.id, 'with plan:', userProfile.current_plan_id)\r\n    \r\n    try {\r\n      setLoading(true)\r\n      \r\n      // Cargar estad√≠sticas reales desde las tablas correspondientes\r\n      console.log('Dashboard: Loading real stats from database')\r\n      \r\n      let realStats = {\r\n        totalFolders: 0,\r\n        totalFiles: 0,\r\n        storageUsed: 0,\r\n        tokensUsed: 0,\r\n        tokenLimit: 0\r\n      }\r\n      \r\n      // Obtener carpetas desde carpetas_usuario usando columna administrador\r\n      try {\r\n        const { data: foldersData, error: foldersError } = await db.userFolders.getByAdministrador(user.email)\r\n        if (!foldersError && foldersData) {\r\n          realStats.totalFolders = foldersData.length\r\n          console.log('Dashboard: Folders loaded:', realStats.totalFolders)\r\n        }\r\n      } catch (folderError) {\r\n        console.error('Error loading folders:', folderError)\r\n      }\r\n      \r\n      // Obtener archivos contando carpetas_usuario donde administrador = user.email\r\n      try {\r\n        const { data: userFoldersData, error: userFoldersError } = await supabase\r\n          .from('carpetas_usuario')\r\n          .select('*')\r\n          .eq('administrador', user.email)\r\n        \r\n        if (!userFoldersError && userFoldersData) {\r\n          realStats.totalFiles = userFoldersData.length\r\n          console.log('Dashboard: Total files (carpetas_usuario) loaded:', realStats.totalFiles)\r\n        }\r\n      } catch (fileError) {\r\n        console.error('Error loading files:', fileError)\r\n      }\r\n      \r\n      // Calcular almacenamiento desde documentos_entrenador (sin cargar embeddings)\r\n      try {\r\n        const { data: chunksData, error: chunksError } = await supabase\r\n          .from('documentos_entrenador')\r\n          .select('id')\r\n          .eq('entrenador', user.email)\r\n\r\n        if (!chunksError && chunksData) {\r\n          // Estimaci√≥n simple basada en n√∫mero de documentos\r\n          realStats.storageUsed = chunksData.length * 1024 // 1KB por documento estimado\r\n          console.log('Dashboard: Storage estimated:', realStats.storageUsed, 'bytes for', chunksData.length, 'documents')\r\n        }\r\n      } catch (storageError) {\r\n        console.error('Error calculating storage:', storageError)\r\n      }\r\n      \r\n      // Obtener l√≠mite de tokens del plan actual PRIMERO\r\n      let planTokenLimit = 1000 // valor por defecto para plan gratuito\r\n      console.log('Dashboard: UserProfile current_plan_id:', userProfile.current_plan_id)\r\n      \r\n      if (userProfile.current_plan_id) {\r\n        try {\r\n          console.log('Dashboard: Fetching plan data for plan ID:', userProfile.current_plan_id)\r\n          const { data: planData, error: planError } = await supabase\r\n            .from('plans')\r\n            .select('token_limit_usage')\r\n            .eq('id', userProfile.current_plan_id)\r\n            .maybeSingle()\r\n          \r\n          console.log('Dashboard: Plan query result:', { planData, planError })\r\n          \r\n          if (!planError && planData) {\r\n            planTokenLimit = planData.token_limit_usage || 1000\r\n            console.log('Dashboard: Plan token limit loaded:', planTokenLimit)\r\n          } else {\r\n            console.warn('Dashboard: No plan data found or error occurred, using default limit')\r\n          }\r\n        } catch (planError) {\r\n          console.error('Error loading plan token limit:', planError)\r\n        }\r\n      } else {\r\n        console.log('Dashboard: No current_plan_id found, using default token limit:', planTokenLimit)\r\n      }\r\n      \r\n      // Obtener tokens usados y establecer el l√≠mite correcto\r\n      try {\r\n        const { data: tokenData, error: tokenError } = await supabase\r\n          .from('user_tokens_usage')\r\n          .select('tokens_used')\r\n          .eq('user_id', user.id)\r\n          .maybeSingle()\r\n        if (!tokenError && tokenData) {\r\n          realStats.tokensUsed = tokenData.tokens_used || 0\r\n          console.log('Dashboard: Tokens used loaded:', realStats.tokensUsed)\r\n        }\r\n        // Usar SIEMPRE el l√≠mite del plan, no el de user_tokens_usage\r\n        realStats.tokenLimit = planTokenLimit\r\n        console.log('Dashboard: Using plan token limit:', realStats.tokenLimit)\r\n      } catch (tokenError) {\r\n        console.error('Error loading tokens:', tokenError)\r\n        realStats.tokenLimit = planTokenLimit\r\n      }\r\n      \r\n      setStats(realStats)\r\n      \r\n      // La verificaci√≥n de Google Drive se maneja autom√°ticamente en useEffect\r\n      \r\n      \r\n      console.log('Dashboard: Data loading completed successfully')\r\n      \r\n    } catch (error) {\r\n      console.error('Error loading dashboard data:', error)\r\n      // No mostrar toast de error para evitar spam al usuario\r\n      console.log('Dashboard cargado con datos b√°sicos debido a errores de conectividad')\r\n    } finally {\r\n      console.log('Dashboard: Setting loading to false')\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const checkGoogleDriveConnection = () => {\r\n    // Usar la informaci√≥n ya disponible en userProfile desde AuthContext\r\n    // que incluye las credenciales de Google Drive\r\n    const isConnected = !!(userProfile?.google_refresh_token && userProfile.google_refresh_token.trim() !== '')\r\n    setIsGoogleDriveConnected(isConnected)\r\n    console.log('Dashboard: Google Drive connection status:', isConnected)\r\n  }\r\n\r\n  const handleConnectGoogleDrive = () => {\r\n    try {\r\n      const authUrl = googleDriveService.generateAuthUrl()\r\n      window.location.href = authUrl\r\n    } catch (error) {\r\n      console.error('Error getting auth URL:', error)\r\n      toast.error('Error al conectar con Google Drive')\r\n    }\r\n  }\r\n\r\n  const formatBytes = (bytes) => {\r\n    if (bytes === 0) return '0 Bytes'\r\n    const k = 1024\r\n    const sizes = ['Bytes', 'KB', 'MB', 'GB']\r\n    const i = Math.floor(Math.log(bytes) / Math.log(k))\r\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]\r\n  }\r\n\r\n  const getStoragePercentage = () => {\r\n    // Usar un l√≠mite fijo de 1GB ya que no se cargan los planes\r\n    const limit = 1024 * 1024 * 1024 // 1GB por defecto\r\n    return Math.min((stats.storageUsed / limit) * 100, 100)\r\n  }\r\n\r\n  if (loading) {\r\n    return <LoadingSpinner text=\"Cargando dashboard...\" />\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"bg-white rounded-lg shadow-md p-6\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold text-engage-black mb-2\">\r\n              ¬°Bienvenido, {userProfile?.name || user?.email}!\r\n            </h1>\r\n            <p className=\"text-gray-600\">\r\n              Gestiona tus planes, carpetas y archivos desde tu dashboard personal.\r\n            </p>\r\n          </div>\r\n          <div className=\"ml-6\">\r\n            <a\r\n              href=\"https://t.me/staffhubbeta_bot\"\r\n              target=\"_blank\"\r\n              rel=\"noopener noreferrer\"\r\n              className=\"inline-flex items-center px-4 py-2 bg-engage-blue hover:bg-engage-yellow text-white font-medium rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg\"\r\n            >\r\n              <svg\r\n                className=\"w-5 h-5 mr-2\"\r\n                viewBox=\"0 0 24 24\"\r\n                fill=\"currentColor\"\r\n              >\r\n                <path d=\"M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z\"/>\r\n              </svg>\r\n              Ir al Bot\r\n            </a>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n\r\n      {!isGoogleDriveConnected && (\r\n        <div className=\"bg-engage-blue/10 border border-engage-blue/20 rounded-lg p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center\">\r\n              <CloudIcon className=\"h-5 w-5 text-engage-blue mr-3\" />\r\n              <div>\r\n                <h3 className=\"text-sm font-medium text-engage-blue\">\r\n                  Google Drive no conectado\r\n                </h3>\r\n                <p className=\"text-sm text-engage-blue mt-1\">\r\n                  Conecta tu cuenta de Google Drive para gestionar archivos.\r\n                </p>\r\n              </div>\r\n            </div>\r\n            <button\r\n              onClick={handleConnectGoogleDrive}\r\n              className=\"btn-primary text-sm\"\r\n            >\r\n              Conectar Drive\r\n            </button>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Estad√≠sticas principales */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\r\n        <div className=\"bg-white rounded-lg shadow-md p-6\">\r\n          <div className=\"flex items-center\">\r\n            <div className=\"p-3 rounded-full bg-engage-blue/10\">\r\n              <FolderIcon className=\"h-6 w-6 text-engage-blue\" />\r\n            </div>\r\n            <div className=\"ml-4\">\r\n              <p className=\"text-sm font-medium text-gray-600\">Carpetas</p>\r\n              <p className=\"text-2xl font-bold text-engage-black\">{stats.totalFolders}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow-md p-6\">\r\n          <div className=\"flex items-center\">\r\n            <div className=\"p-3 rounded-full bg-engage-yellow/10\">\r\n              <DocumentIcon className=\"h-6 w-6 text-engage-yellow\" />\r\n            </div>\r\n            <div className=\"ml-4\">\r\n              <p className=\"text-sm font-medium text-gray-600\">Archivos</p>\r\n              <p className=\"text-2xl font-bold text-engage-black\">{stats.totalFiles}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow-md p-6\">\r\n          <div className=\"flex items-center\">\r\n            <div className=\"p-3 rounded-full bg-purple-100\">\r\n              <ChartBarIcon className=\"h-6 w-6 text-purple-600\" />\r\n            </div>\r\n            <div className=\"ml-4 flex-1\">\r\n              <p className=\"text-sm font-medium text-gray-600\">Almacenamiento</p>\r\n              <p className=\"text-2xl font-bold text-engage-black\">{formatBytes(stats.storageUsed)}</p>\r\n              <div className=\"mt-2\">\r\n                <div className=\"flex justify-between text-xs text-gray-500 mb-1\">\r\n                  <span>Usado: {formatBytes(stats.storageUsed)}</span>\r\n                  <span>L√≠mite: {formatBytes(1024 * 1024 * 1024)}</span>\r\n                </div>\r\n                <div className=\"w-full bg-gray-200 rounded-full h-1.5\">\r\n                  <div\r\n                    className={`h-1.5 rounded-full transition-all duration-300 ${\r\n                      getStoragePercentage() >= 90 ? 'bg-red-500' :\r\n                      getStoragePercentage() >= 70 ? 'bg-yellow-500' : 'bg-engage-blue'\r\n                    }`}\r\n                    style={{ width: `${Math.min(getStoragePercentage(), 100)}%` }}\r\n                  ></div>\r\n                </div>\r\n                <p className=\"text-xs text-gray-500 mt-1\">{getStoragePercentage().toFixed(1)}% usado</p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow-md p-6\">\r\n          <div className=\"flex items-center\">\r\n            <div className=\"p-3 rounded-full bg-engage-yellow/10\">\r\n              <ChartBarIcon className=\"h-6 w-6 text-engage-yellow\" />\r\n            </div>\r\n            <div className=\"ml-4 flex-1\">\r\n              <p className=\"text-sm font-medium text-gray-600\">Tokens Usados</p>\r\n              <p className=\"text-2xl font-bold text-engage-black\">{stats.tokensUsed.toLocaleString()}</p>\r\n              <div className=\"mt-2\">\r\n                <div className=\"flex justify-between text-xs text-gray-500 mb-1\">\r\n                  <span>Usados: {stats.tokensUsed.toLocaleString()}</span>\r\n                  <span>L√≠mite: 1,000</span>\r\n                </div>\r\n                <div className=\"w-full bg-gray-200 rounded-full h-1.5\">\r\n                  <div\r\n                    className={`h-1.5 rounded-full transition-all duration-300 ${\r\n                      (stats.tokensUsed / 1000) * 100 >= 90 ? 'bg-red-500' :\r\n                      (stats.tokensUsed / 1000) * 100 >= 70 ? 'bg-yellow-500' : 'bg-engage-yellow'\r\n                    }`}\r\n                    style={{ width: `${Math.min((stats.tokensUsed / 1000) * 100, 100)}%` }}\r\n                  ></div>\r\n                </div>\r\n                <p className=\"text-xs text-gray-500 mt-1\">\r\n                  {((stats.tokensUsed / 1000) * 100).toFixed(1)}% usado ‚Ä¢\r\n                  {Math.max(0, 1000 - stats.tokensUsed).toLocaleString()} disponibles\r\n                </p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-1 gap-6\">\r\n        {/* Panel de Acciones R√°pidas */}\r\n        <div className=\"bg-white rounded-lg shadow-md p-6\">\r\n          <h2 className=\"text-lg font-semibold text-engage-black mb-4\">\r\n            Acciones R√°pidas\r\n          </h2>\r\n          <div className=\"space-y-3\">\r\n            <Link\r\n              to=\"/folders\"\r\n              className=\"flex items-center p-3 rounded-lg border border-gray-200 hover:bg-engage-blue/5 transition-colors duration-200\"\r\n            >\r\n              <PlusIcon className=\"h-5 w-5 text-engage-blue mr-3\" />\r\n              <span className=\"text-sm font-medium text-engage-black\">Crear Carpeta</span>\r\n            </Link>\r\n            \r\n            <Link\r\n              to=\"/folders\"\r\n              className=\"flex items-center p-3 rounded-lg border border-gray-200 hover:bg-engage-blue/5 transition-colors duration-200\"\r\n            >\r\n              <FolderIcon className=\"h-5 w-5 text-engage-blue mr-3\" />\r\n              <span className=\"text-sm font-medium text-engage-black\">Ver Carpetas</span>\r\n            </Link>\r\n            \r\n            <Link\r\n              to=\"/files\"\r\n              className=\"flex items-center p-3 rounded-lg border border-gray-200 hover:bg-engage-blue/5 transition-colors duration-200\"\r\n            >\r\n              <DocumentIcon className=\"h-5 w-5 text-engage-blue mr-3\" />\r\n              <span className=\"text-sm font-medium text-engage-black\">Subir Archivos</span>\r\n            </Link>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Plantilla de Rutina */}\r\n      <div className=\"mt-8\">\r\n        <TemplateDownload />\r\n      </div>\r\n\r\n\r\n      {/* Secci√≥n de Uso de Tokens */}\r\n      <div className=\"mt-8\">\r\n        <TokenUsage />\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default Dashboard","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\dashboard\\DashboardResumen.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'PaperAirplaneIcon' is defined but never used.","line":2,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":47},{"ruleId":"no-unused-vars","severity":1,"message":"'EyeIcon' is defined but never used.","line":2,"column":49,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":56},{"ruleId":"no-unused-vars","severity":1,"message":"'CheckCircleIcon' is defined but never used.","line":2,"column":58,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":73},{"ruleId":"no-unused-vars","severity":1,"message":"'communicationService' is defined but never used.","line":4,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":28},{"ruleId":"no-unused-vars","severity":1,"message":"'companies' is assigned a value but never used.","line":7,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { BuildingOfficeIcon, PaperAirplaneIcon, EyeIcon, CheckCircleIcon } from '@heroicons/react/24/outline'\r\nimport { supabase } from '../../lib/supabase.js'\r\nimport communicationService from '../../services/communicationService.js'\r\n\r\nconst DashboardResumen = () => {\r\n  const [companies, setCompanies] = useState([])\r\n  const [employeesByCompany, setEmployeesByCompany] = useState([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [error, setError] = useState(null)\r\n\r\n  // ELIMINADO: Datos mock - ahora siempre usamos datos reales de Supabase\r\n\r\n  useEffect(() => {\r\n    const loadCompanyData = async () => {\r\n      try {\r\n        setLoading(true)\r\n        setError(null)\r\n        \r\n        // SIEMPRE usar datos reales de Supabase - eliminado modo mock\r\n        console.log('DashboardResumen: Loading companies from Supabase...')\r\n        const { data: companiesData, error: companiesError } = await supabase\r\n          .from('companies')\r\n          .select('id, name')\r\n          .order('name', { ascending: true })\r\n        \r\n        if (companiesError) {\r\n          throw new Error(`Error loading companies: ${companiesError.message}`)\r\n        }\r\n        \r\n        console.log('DashboardResumen: Companies loaded:', companiesData)\r\n        setCompanies(companiesData)\r\n        \r\n        if (!companiesData || companiesData.length === 0) {\r\n          setEmployeesByCompany([])\r\n          setLoading(false)\r\n          return\r\n        }\r\n        \r\n        // Para cada empresa, obtener el conteo de empleados\r\n        console.log('DashboardResumen: Loading employee counts...')\r\n        const employeesCountPromises = companiesData.map(async (company) => {\r\n          const { count, error: countError } = await supabase\r\n            .from('employees')\r\n            .select('*', { count: 'exact', head: true })\r\n            .eq('company_id', company.id)\r\n            .eq('is_active', true)\r\n          \r\n          console.log(`DashboardResumen: Employee count for ${company.name}:`, { count, countError })\r\n          \r\n          return {\r\n            companyId: company.id,\r\n            companyName: company.name,\r\n            employeeCount: countError ? 0 : count || 0\r\n          }\r\n        })\r\n        \r\n        const employeesCountData = await Promise.all(employeesCountPromises)\r\n        console.log('DashboardResumen: Employee counts loaded:', employeesCountData)\r\n        setEmployeesByCompany(employeesCountData)\r\n      } catch (err) {\r\n        console.error('DashboardResumen: Error loading data:', err)\r\n        setError(err.message)\r\n      } finally {\r\n        setLoading(false)\r\n      }\r\n    }\r\n    \r\n    loadCompanyData()\r\n  }, [])\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"bg-white rounded-2xl shadow-xl p-6 border border-gray-200\">\r\n        <h2 className=\"text-xl font-bold text-gray-900 mb-6 flex items-center\">\r\n          <BuildingOfficeIcon className=\"h-6 w-6 mr-3 text-blue-600\" />\r\n          Resumen por Empresa\r\n        </h2>\r\n        <p className=\"text-gray-500 text-center py-4\">Cargando datos de empresas...</p>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"bg-white rounded-2xl shadow-xl p-6 border border-gray-200\">\r\n        <h2 className=\"text-xl font-bold text-gray-900 mb-6 flex items-center\">\r\n          <BuildingOfficeIcon className=\"h-6 w-6 mr-3 text-blue-600\" />\r\n          Resumen por Empresa\r\n        </h2>\r\n        <div className=\"text-red-500 text-center py-4\">\r\n          <p>Error al cargar datos: {error}</p>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"bg-white rounded-2xl shadow-xl p-6 border border-gray-200\">\r\n      <h2 className=\"text-xl font-bold text-gray-900 mb-6 flex items-center\">\r\n        <BuildingOfficeIcon className=\"h-6 w-6 mr-3 text-blue-600\" />\r\n        Resumen por Empresa\r\n      </h2>\r\n      <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n        {employeesByCompany && employeesByCompany.length > 0 ? (\r\n          employeesByCompany.map((companyData) => (\r\n            <div \r\n              key={companyData.companyId} \r\n              className=\"bg-gradient-to-r from-blue-50 to-gray-50 rounded-xl p-4 border border-blue-200 hover:shadow-md transition-all duration-300 hover:scale-[1.02]\"\r\n            >\r\n              <h3 className=\"font-bold text-gray-900 truncate text-lg\">{companyData.companyName}</h3>\r\n              <div className=\"mt-3 space-y-2\">\r\n                <div className=\"flex justify-between items-center\">\r\n                  <span className=\"text-sm text-gray-600\">Empleados</span>\r\n                  <span className=\"font-bold text-blue-600\">{companyData.employeeCount}</span>\r\n                </div>\r\n                <div className=\"flex justify-between items-center\">\r\n                  <span className=\"text-sm text-gray-600\">Mensajes enviados</span>\r\n                  <span className=\"font-bold text-green-600\">0</span>\r\n                </div>\r\n                <div className=\"flex justify-between items-center\">\r\n                  <span className=\"text-sm text-gray-600\">Mensajes le√≠dos</span>\r\n                  <span className=\"font-bold text-purple-600\">0</span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          ))\r\n        ) : (\r\n          <div className=\"text-gray-500 text-center py-4 col-span-full\">\r\n            <p>No se encontraron empresas</p>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default DashboardResumen","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\dashboard\\DatabaseCompanySummary.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'supabase' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":18},{"ruleId":"no-use-before-define","severity":1,"message":"'loadCompanyData' was used before it was defined.","line":19,"column":7,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":19,"endColumn":22},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'loadCompanyData' function makes the dependencies of useEffect Hook (at line 19) change on every render. To fix this, wrap the definition of 'loadCompanyData' in its own useCallback() Hook.","line":21,"column":9,"nodeType":"VariableDeclarator","endLine":114,"endColumn":4,"suggestions":[{"desc":"Wrap the definition of 'loadCompanyData' in its own useCallback() Hook.","fix":{"range":[863,5524],"text":"useCallback(async () => {\r\n    console.log('üöÄ DatabaseCompanySummary: Cargando datos desde base de datos organizada')\r\n    try {\r\n      setLoading(true)\r\n      setError(null)\r\n      const startTime = performance.now()\r\n\r\n      // ‚úÖ SOLUCI√ìN AGRESIVA: Forzar limpieza de cach√© m√∫ltiple veces\r\n      organizedDatabaseService.forceClearCache()\r\n      console.log('üßπ DatabaseCompanySummary: Cach√© limpiado forzosamente (1/3)')\r\n      \r\n      // Esperar un momento para asegurar que la cach√© se limpie\r\n      await new Promise(resolve => setTimeout(resolve, 100))\r\n      \r\n      organizedDatabaseService.forceClearCache()\r\n      console.log('üßπ DatabaseCompanySummary: Cach√© limpiado forzosamente (2/3)')\r\n      \r\n      await new Promise(resolve => setTimeout(resolve, 100))\r\n      \r\n      organizedDatabaseService.forceClearCache()\r\n      console.log('üßπ DatabaseCompanySummary: Cach√© limpiado forzosamente (3/3)')\r\n\r\n      // Usar el servicio organizado para obtener empresas con estad√≠sticas\r\n      const companiesWithStats = await organizedDatabaseService.getCompaniesWithStats()\r\n      \r\n      console.log(`üìä DatabaseCompanySummary: ${companiesWithStats.length} empresas cargadas con estad√≠sticas`)\r\n      \r\n      // ‚úÖ DUPLICACI√ìN DE SEGURIDAD: Filtrar duplicados a nivel de componente tambi√©n\r\n      const uniqueCompanies = companiesWithStats.filter((company, index, self) =>\r\n        index === self.findIndex((c) => c.id === company.id)\r\n      );\r\n      \r\n      if (uniqueCompanies.length !== companiesWithStats.length) {\r\n        console.warn('‚ö†Ô∏è DatabaseCompanySummary: Duplicados detectados a nivel de componente:', {\r\n          original: companiesWithStats.length,\r\n          unique: uniqueCompanies.length,\r\n          duplicados: companiesWithStats.length - uniqueCompanies.length,\r\n          idsDuplicados: companiesWithStats.map(c => c.id).filter((id, index) =>\r\n            companiesWithStats.findIndex(c => c.id === id) !== index\r\n          )\r\n        });\r\n      }\r\n      \r\n      // Logging detallado para identificar datos mock vs reales\r\n      companiesWithStats.forEach((company, index) => {\r\n        console.log(`üîç Empresa ${index + 1}: ${company.name}`)\r\n        console.log(`   - ID: ${company.id}`)\r\n        console.log(`   - Empleados: ${company.employeeCount}`)\r\n        console.log(`   - Mensajes enviados: ${company.sentMessages}`)\r\n        console.log(`   - Mensajes le√≠dos: ${company.readMessages}`)\r\n        console.log(`   - Sentimiento: ${company.sentimentScore}`)\r\n        console.log(`   - Engagement: ${company.engagementRate}%`)\r\n        \r\n        // Verificar si los datos parecen mock\r\n        if (company.sentimentScore && (company.sentimentScore > 1 || company.sentimentScore < -1)) {\r\n          console.warn(`‚ö†Ô∏è POSIBLE DATO MOCK - Sentimiento inv√°lido (${company.sentimentScore}) para ${company.name}`)\r\n        }\r\n        \r\n        if (company.employeeCount && (company.employeeCount < 0 || company.employeeCount > 1000)) {\r\n          console.warn(`‚ö†Ô∏è POSIBLE DATO MOCK - N√∫mero de empleados inv√°lido (${company.employeeCount}) para ${company.name}`)\r\n        }\r\n      })\r\n\r\n      if (companiesWithStats.length === 0) {\r\n        console.log('‚ö†Ô∏è No se encontraron empresas, mostrando mensaje de depuraci√≥n')\r\n        setError('No se encontraron empresas en la base de datos. Por favor, crea algunas empresas desde la secci√≥n de Configuraci√≥n.')\r\n        setCompanies([])\r\n        setLoading(false)\r\n        return\r\n      }\r\n\r\n      // Ordenar alfab√©ticamente las empresas √∫nicas\r\n      const sortedCompanies = uniqueCompanies.sort((a, b) => a.name.localeCompare(b.name))\r\n      setCompanies(sortedCompanies)\r\n\r\n      const loadTime = performance.now() - startTime\r\n      console.log(`‚úÖ DatabaseCompanySummary: Carga completada en ${loadTime.toFixed(2)}ms`)\r\n      console.log('üìã RESUMEN FINAL DE DATOS CARGADOS:')\r\n      console.log(`   - Total empresas √∫nicas: ${sortedCompanies.length}`)\r\n      console.log(`   - Total empleados: ${sortedCompanies.reduce((sum, c) => sum + c.employeeCount, 0)}`)\r\n      console.log(`   - Total mensajes enviados: ${sortedCompanies.reduce((sum, c) => sum + c.sentMessages, 0)}`)\r\n      console.log(`   - Total mensajes le√≠dos: ${sortedCompanies.reduce((sum, c) => sum + c.readMessages, 0)}`)\r\n      console.log('üìã LISTA FINAL DE EMPRESAS √öNICAS:')\r\n      sortedCompanies.forEach((company, index) => {\r\n        console.log(`   ${index + 1}. ${company.name} (ID: ${company.id})`)\r\n      });\r\n       \r\n    } catch (error) {\r\n      console.error('‚ùå Error loading company data:', error)\r\n      setError('Error al cargar los datos de las empresas')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  })"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { BuildingOfficeIcon, ArrowPathIcon } from '@heroicons/react/24/outline'\r\nimport { supabase } from '../../lib/supabase.js'\r\nimport CompanyCard from './CompanyCard.js'\r\nimport organizedDatabaseService from '../../services/organizedDatabaseService.js'\r\n\r\nconst DatabaseCompanySummary = () => {\r\n  const [companies, setCompanies] = useState([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [syncing, setSyncing] = useState(false)\r\n  const [error, setError] = useState(null)\r\n  const [flippedCards, setFlippedCards] = useState(new Set())\r\n\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\nuseEffect(() => {\r\n    loadCompanyData()\r\n  }, [loadCompanyData])\r\n\r\n  const loadCompanyData = async () => {\r\n    console.log('üöÄ DatabaseCompanySummary: Cargando datos desde base de datos organizada')\r\n    try {\r\n      setLoading(true)\r\n      setError(null)\r\n      const startTime = performance.now()\r\n\r\n      // ‚úÖ SOLUCI√ìN AGRESIVA: Forzar limpieza de cach√© m√∫ltiple veces\r\n      organizedDatabaseService.forceClearCache()\r\n      console.log('üßπ DatabaseCompanySummary: Cach√© limpiado forzosamente (1/3)')\r\n      \r\n      // Esperar un momento para asegurar que la cach√© se limpie\r\n      await new Promise(resolve => setTimeout(resolve, 100))\r\n      \r\n      organizedDatabaseService.forceClearCache()\r\n      console.log('üßπ DatabaseCompanySummary: Cach√© limpiado forzosamente (2/3)')\r\n      \r\n      await new Promise(resolve => setTimeout(resolve, 100))\r\n      \r\n      organizedDatabaseService.forceClearCache()\r\n      console.log('üßπ DatabaseCompanySummary: Cach√© limpiado forzosamente (3/3)')\r\n\r\n      // Usar el servicio organizado para obtener empresas con estad√≠sticas\r\n      const companiesWithStats = await organizedDatabaseService.getCompaniesWithStats()\r\n      \r\n      console.log(`üìä DatabaseCompanySummary: ${companiesWithStats.length} empresas cargadas con estad√≠sticas`)\r\n      \r\n      // ‚úÖ DUPLICACI√ìN DE SEGURIDAD: Filtrar duplicados a nivel de componente tambi√©n\r\n      const uniqueCompanies = companiesWithStats.filter((company, index, self) =>\r\n        index === self.findIndex((c) => c.id === company.id)\r\n      );\r\n      \r\n      if (uniqueCompanies.length !== companiesWithStats.length) {\r\n        console.warn('‚ö†Ô∏è DatabaseCompanySummary: Duplicados detectados a nivel de componente:', {\r\n          original: companiesWithStats.length,\r\n          unique: uniqueCompanies.length,\r\n          duplicados: companiesWithStats.length - uniqueCompanies.length,\r\n          idsDuplicados: companiesWithStats.map(c => c.id).filter((id, index) =>\r\n            companiesWithStats.findIndex(c => c.id === id) !== index\r\n          )\r\n        });\r\n      }\r\n      \r\n      // Logging detallado para identificar datos mock vs reales\r\n      companiesWithStats.forEach((company, index) => {\r\n        console.log(`üîç Empresa ${index + 1}: ${company.name}`)\r\n        console.log(`   - ID: ${company.id}`)\r\n        console.log(`   - Empleados: ${company.employeeCount}`)\r\n        console.log(`   - Mensajes enviados: ${company.sentMessages}`)\r\n        console.log(`   - Mensajes le√≠dos: ${company.readMessages}`)\r\n        console.log(`   - Sentimiento: ${company.sentimentScore}`)\r\n        console.log(`   - Engagement: ${company.engagementRate}%`)\r\n        \r\n        // Verificar si los datos parecen mock\r\n        if (company.sentimentScore && (company.sentimentScore > 1 || company.sentimentScore < -1)) {\r\n          console.warn(`‚ö†Ô∏è POSIBLE DATO MOCK - Sentimiento inv√°lido (${company.sentimentScore}) para ${company.name}`)\r\n        }\r\n        \r\n        if (company.employeeCount && (company.employeeCount < 0 || company.employeeCount > 1000)) {\r\n          console.warn(`‚ö†Ô∏è POSIBLE DATO MOCK - N√∫mero de empleados inv√°lido (${company.employeeCount}) para ${company.name}`)\r\n        }\r\n      })\r\n\r\n      if (companiesWithStats.length === 0) {\r\n        console.log('‚ö†Ô∏è No se encontraron empresas, mostrando mensaje de depuraci√≥n')\r\n        setError('No se encontraron empresas en la base de datos. Por favor, crea algunas empresas desde la secci√≥n de Configuraci√≥n.')\r\n        setCompanies([])\r\n        setLoading(false)\r\n        return\r\n      }\r\n\r\n      // Ordenar alfab√©ticamente las empresas √∫nicas\r\n      const sortedCompanies = uniqueCompanies.sort((a, b) => a.name.localeCompare(b.name))\r\n      setCompanies(sortedCompanies)\r\n\r\n      const loadTime = performance.now() - startTime\r\n      console.log(`‚úÖ DatabaseCompanySummary: Carga completada en ${loadTime.toFixed(2)}ms`)\r\n      console.log('üìã RESUMEN FINAL DE DATOS CARGADOS:')\r\n      console.log(`   - Total empresas √∫nicas: ${sortedCompanies.length}`)\r\n      console.log(`   - Total empleados: ${sortedCompanies.reduce((sum, c) => sum + c.employeeCount, 0)}`)\r\n      console.log(`   - Total mensajes enviados: ${sortedCompanies.reduce((sum, c) => sum + c.sentMessages, 0)}`)\r\n      console.log(`   - Total mensajes le√≠dos: ${sortedCompanies.reduce((sum, c) => sum + c.readMessages, 0)}`)\r\n      console.log('üìã LISTA FINAL DE EMPRESAS √öNICAS:')\r\n      sortedCompanies.forEach((company, index) => {\r\n        console.log(`   ${index + 1}. ${company.name} (ID: ${company.id})`)\r\n      });\r\n       \r\n    } catch (error) {\r\n      console.error('‚ùå Error loading company data:', error)\r\n      setError('Error al cargar los datos de las empresas')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const syncWithDashboard = async () => {\r\n    try {\r\n      setSyncing(true)\r\n      setError(null)\r\n      // Forzar limpieza completa de cach√© y recargar datos\r\n      organizedDatabaseService.forceClearCache()\r\n      console.log('üîÑ DatabaseCompanySummary: Cach√© limpiado, recargando datos reales...')\r\n      await loadCompanyData()\r\n    } catch (error) {\r\n      console.error('Error syncing with dashboard:', error)\r\n      setError('Error al sincronizar con el dashboard')\r\n    } finally {\r\n      setSyncing(false)\r\n    }\r\n  }\r\n\r\n\r\n  // Funci√≥n para voltear tarjetas\r\n  const toggleFlip = (companyId) => {\r\n    setFlippedCards(prev => {\r\n      const newSet = new Set(prev)\r\n      if (newSet.has(companyId)) {\r\n        newSet.delete(companyId)\r\n      } else {\r\n        newSet.add(companyId)\r\n      }\r\n      return newSet\r\n    })\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex justify-center items-center h-32\">\r\n        <div className=\"flex items-center space-x-4\">\r\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500\"></div>\r\n          <span className=\"text-gray-600 font-medium\">Cargando datos empresariales...</span>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"text-center py-12\">\r\n        <div className=\"text-red-500 mb-4 text-lg font-medium\">{error}</div>\r\n        <div className=\"flex justify-center space-x-4\">\r\n          <button\r\n            onClick={loadCompanyData}\r\n            className=\"px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5\"\r\n          >\r\n            Reintentar\r\n          </button>\r\n          <button\r\n            onClick={syncWithDashboard}\r\n            disabled={syncing}\r\n            className=\"px-6 py-3 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 disabled:opacity-50\"\r\n          >\r\n            {syncing ? 'Sincronizando...' : 'Sincronizar con Dashboard'}\r\n          </button>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div>\r\n      <div className=\"space-y-8\">\r\n      {/* Header con bot√≥n de sincronizaci√≥n */}\r\n      <div className=\"flex justify-between items-center\">\r\n        <div className=\"flex items-center space-x-4\">\r\n          <div className=\"p-3 rounded-2xl bg-gradient-to-br from-violet-500 to-purple-600 shadow-lg\">\r\n            <BuildingOfficeIcon className=\"h-8 w-8 text-white\" />\r\n          </div>\r\n          <div>\r\n            <h3 className=\"text-2xl font-bold text-gray-900\">\r\n              Empresas Activas\r\n            </h3>\r\n            <p className=\"text-gray-600\">\r\n              Resumen detallado por organizaci√≥n\r\n            </p>\r\n          </div>\r\n        </div>\r\n        <button\r\n          onClick={syncWithDashboard}\r\n          disabled={syncing}\r\n          className=\"flex items-center px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 disabled:opacity-50\"\r\n        >\r\n          <ArrowPathIcon className={`h-5 w-5 mr-2 ${syncing ? 'animate-spin' : ''}`} />\r\n          {syncing ? 'Sincronizando...' : 'Sincronizar'}\r\n        </button>\r\n      </div>\r\n\r\n      {/* Footer con estad√≠sticas globales - movido aqu√≠ */}\r\n      <div className=\"bg-gradient-to-r from-gray-50 to-blue-50 rounded-3xl p-6 border border-gray-200\">\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-center\">\r\n          <div>\r\n            <div className=\"text-3xl font-bold text-blue-600 mb-1\">\r\n              {companies.reduce((sum, company) => sum + company.employeeCount, 0)}\r\n            </div>\r\n            <div className=\"text-sm text-gray-600\">Empleados Totales</div>\r\n          </div>\r\n          <div>\r\n            <div className=\"text-3xl font-bold text-emerald-600 mb-1\">\r\n              {companies.reduce((sum, company) => sum + company.sentMessages, 0).toLocaleString()}\r\n            </div>\r\n            <div className=\"text-sm text-gray-600\">Mensajes Enviados</div>\r\n          </div>\r\n          <div>\r\n            <div className=\"text-3xl font-bold text-purple-600 mb-1\">\r\n              {(() => {\r\n                const totalSent = companies.reduce((sum, company) => sum + company.sentMessages, 0);\r\n                const totalRead = companies.reduce((sum, company) => sum + company.readMessages, 0);\r\n                return totalSent > 0 ? Math.round((totalRead / totalSent) * 100) : 0;\r\n              })()}%\r\n            </div>\r\n            <div className=\"text-sm text-gray-600\">Tasa de Lectura Global</div>\r\n          </div>\r\n          <div>\r\n            <div className=\"text-3xl font-bold text-orange-600 mb-1\">\r\n              {(() => {\r\n                // Calcular sentimiento promedio global desde localStorage\r\n                try {\r\n                  const storedSentimentData = localStorage.getItem('reportsSentimentData');\r\n                  if (storedSentimentData) {\r\n                    const sentimentData = JSON.parse(storedSentimentData);\r\n                    if (sentimentData && sentimentData.sentimentByCompany) {\r\n                      const sentiments = Object.values(sentimentData.sentimentByCompany)\r\n                        .map(company => company.average || 0)\r\n                        .filter(sentiment => sentiment !== 0);\r\n\r\n                      if (sentiments.length > 0) {\r\n                        const avgSentiment = sentiments.reduce((sum, sentiment) => sum + sentiment, 0) / sentiments.length;\r\n                        return avgSentiment.toFixed(2);\r\n                      }\r\n                    }\r\n                  }\r\n                } catch (error) {\r\n                  console.log('Error calculating global sentiment:', error);\r\n                }\r\n                return '0.00';\r\n              })()}\r\n            </div>\r\n            <div className=\"text-sm text-gray-600\">Sentimiento Global</div>\r\n          </div>\r\n        </div>\r\n        <div className=\"mt-4 text-center text-xs text-gray-500\">\r\n          Todas las empresas ‚Ä¢ √öltima actualizaci√≥n: {new Date().toLocaleTimeString('es-ES')}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Grid de empresas */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6\">\r\n        {companies.map((company, index) => {\r\n          const isFlipped = flippedCards.has(company.id);\r\n          return <CompanyCard key={company.id} company={company} isFlipped={isFlipped} onToggleFlip={toggleFlip} />;\r\n        })}\r\n      </div>\r\n    </div>\r\n   </div>\r\n  );\r\n};\r\n\r\nexport default DatabaseCompanySummary;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\dashboard\\InitializeEmployees.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\dashboard\\InnovativeDashboard.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'UserIcon' is defined but never used.","line":7,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":11},{"ruleId":"no-unused-vars","severity":1,"message":"'CreditCardIcon' is defined but never used.","line":8,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":17},{"ruleId":"no-unused-vars","severity":1,"message":"'ExclamationTriangleIcon' is defined but never used.","line":14,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":26},{"ruleId":"no-unused-vars","severity":1,"message":"'CheckCircleIcon' is defined but never used.","line":15,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'TemplateDownload' is defined but never used.","line":20,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":24},{"ruleId":"no-unused-vars","severity":1,"message":"'getDaysRemaining' is assigned a value but never used.","line":26,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":26,"endColumn":46},{"ruleId":"no-unused-vars","severity":1,"message":"'userExtensions' is assigned a value but never used.","line":36,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":36,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback } from 'react'\r\nimport { Link } from 'react-router-dom'\r\nimport { useAuth } from '../../contexts/AuthContext.js'\r\nimport { db, supabase } from '../../lib/supabase.js'\r\nimport googleDriveService from '../../lib/googleDrive.js'\r\nimport {\r\n  UserIcon,\r\n  CreditCardIcon,\r\n  FolderIcon,\r\n  DocumentIcon,\r\n  CloudIcon,\r\n  CalendarIcon,\r\n  ChartBarIcon,\r\n  ExclamationTriangleIcon,\r\n  CheckCircleIcon,\r\n  PlusIcon,\r\n  CpuChipIcon\r\n} from '@heroicons/react/24/outline'\r\nimport LoadingSpinner from '../common/LoadingSpinner.js'\r\nimport TemplateDownload from '../templates/TemplateDownload.js'\r\nimport DashboardResumen from './DashboardResumen.js'\r\nimport CommunicationStats from './CommunicationStats.js'\r\nimport toast from 'react-hot-toast'\r\n\r\nconst InnovativeDashboard = () => {\r\n  const { user, userProfile, getDaysRemaining } = useAuth()\r\n  const [payments, setPayments] = useState([])\r\n  const [isGoogleDriveConnected, setIsGoogleDriveConnected] = useState(false)\r\n  const [loading, setLoading] = useState(true)\r\n  const [stats, setStats] = useState({\r\n    totalFolders: 0,\r\n    totalFiles: 0,\r\n    storageUsed: 0,\r\n    tokensUsed: 0\r\n  })\r\n  const [userExtensions, setUserExtensions] = useState([])\r\n  const [plans, setPlans] = useState([])\r\n\r\n  const loadDashboardData = useCallback(async () => {\r\n    if (!user) {\r\n      console.log('Dashboard: No user found, skipping load')\r\n      setLoading(false)\r\n      return\r\n    }\r\n    \r\n    if (!userProfile) {\r\n      console.log('Dashboard: UserProfile not available yet, skipping load')\r\n      return\r\n    }\r\n    \r\n    console.log('Dashboard: Starting to load data for user:', user.id, 'with plan:', userProfile.current_plan_id)\r\n    \r\n    try {\r\n      setLoading(true)\r\n      \r\n      // Cargar estad√≠sticas reales desde las tablas correspondientes\r\n      console.log('Dashboard: Loading real stats from database')\r\n      \r\n      let realStats = {\r\n        totalFolders: 0,\r\n        totalFiles: 0,\r\n        storageUsed: 0,\r\n        tokensUsed: 0,\r\n        tokenLimit: 0\r\n      }\r\n      \r\n      // Obtener carpetas desde carpetas_usuario usando columna administrador\r\n      try {\r\n        const { data: foldersData, error: foldersError } = await db.userFolders.getByAdministrador(user.email)\r\n        if (!foldersError && foldersData) {\r\n          realStats.totalFolders = foldersData.length\r\n          console.log('Dashboard: Folders loaded:', realStats.totalFolders)\r\n        }\r\n      } catch (folderError) {\r\n        console.error('Error loading folders:', folderError)\r\n      }\r\n      \r\n      // Obtener archivos contando carpetas_usuario donde administrador = user.email\r\n      try {\r\n        const { data: userFoldersData, error: userFoldersError } = await supabase\r\n          .from('carpetas_usuario')\r\n          .select('*')\r\n          .eq('administrador', user.email)\r\n        \r\n        if (!userFoldersError && userFoldersData) {\r\n          realStats.totalFiles = userFoldersData.length\r\n          console.log('Dashboard: Total files (carpetas_usuario) loaded:', realStats.totalFiles)\r\n        }\r\n      } catch (fileError) {\r\n        console.error('Error loading files:', fileError)\r\n      }\r\n      \r\n      // Calcular almacenamiento desde documentos_entrenador (sin cargar embeddings)\r\n      try {\r\n        const { data: chunksData, error: chunksError } = await supabase\r\n          .from('documentos_entrenador')\r\n          .select('id')\r\n          .eq('entrenador', user.email)\r\n\r\n        if (!chunksError && chunksData) {\r\n          // Estimaci√≥n simple basada en n√∫mero de documentos\r\n          realStats.storageUsed = chunksData.length * 1024 // 1KB por documento estimado\r\n          console.log('Dashboard: Storage estimated:', realStats.storageUsed, 'bytes for', chunksData.length, 'documents')\r\n        }\r\n      } catch (storageError) {\r\n        console.error('Error calculating storage:', storageError)\r\n      }\r\n      \r\n      // Obtener l√≠mite de tokens del plan actual PRIMERO\r\n      let planTokenLimit = 1000 // valor por defecto para plan gratuito\r\n      console.log('Dashboard: UserProfile current_plan_id:', userProfile.current_plan_id)\r\n      \r\n      if (userProfile.current_plan_id) {\r\n        try {\r\n          console.log('Dashboard: Fetching plan data for plan ID:', userProfile.current_plan_id)\r\n          const { data: planData, error: planError } = await supabase\r\n            .from('plans')\r\n            .select('token_limit_usage')\r\n            .eq('id', userProfile.current_plan_id)\r\n            .maybeSingle()\r\n          \r\n          console.log('Dashboard: Plan query result:', { planData, planError })\r\n          \r\n          if (!planError && planData) {\r\n            planTokenLimit = planData.token_limit_usage || 1000\r\n            console.log('Dashboard: Plan token limit loaded:', planTokenLimit)\r\n          } else {\r\n            console.warn('Dashboard: No plan data found or error occurred, using default limit')\r\n          }\r\n        } catch (planError) {\r\n          console.error('Error loading plan token limit:', planError)\r\n        }\r\n      } else {\r\n        console.log('Dashboard: No current_plan_id found, using default token limit:', planTokenLimit)\r\n      }\r\n      \r\n      // Obtener tokens usados y establecer el l√≠mite correcto\r\n      try {\r\n        const { data: tokenData, error: tokenError } = await supabase\r\n          .from('user_tokens_usage')\r\n          .select('tokens_used')\r\n          .eq('user_id', user.id)\r\n          .maybeSingle()\r\n        if (!tokenError && tokenData) {\r\n          realStats.tokensUsed = tokenData.tokens_used || 0\r\n          console.log('Dashboard: Tokens used loaded:', realStats.tokensUsed)\r\n        }\r\n        // Usar SIEMPRE el l√≠mite del plan, no el de user_tokens_usage\r\n        realStats.tokenLimit = planTokenLimit\r\n        console.log('Dashboard: Using plan token limit:', realStats.tokenLimit)\r\n      } catch (tokenError) {\r\n        console.error('Error loading tokens:', tokenError)\r\n        realStats.tokenLimit = planTokenLimit\r\n      }\r\n      \r\n      setStats(realStats)\r\n      \r\n      // Cargar planes disponibles\r\n      console.log('Dashboard: Loading plans')\r\n      try {\r\n        const { data: plansData, error: plansError } = await supabase\r\n          .from('plans')\r\n          .select('*')\r\n        if (!plansError && plansData) {\r\n          console.log('Dashboard: Plans loaded successfully:', plansData.length)\r\n          setPlans(plansData)\r\n        }\r\n      } catch (planError) {\r\n        console.error('Network error loading plans:', planError)\r\n      }\r\n      \r\n      // Cargar extensiones del usuario\r\n      console.log('Dashboard: Loading user extensions')\r\n      try {\r\n        const { data: extensionsData, error: extensionsError } = await supabase\r\n          .from('plan_extensiones')\r\n          .select(`\r\n            *,\r\n            extensiones (\r\n              id,\r\n              name,\r\n              name_es,\r\n              description,\r\n              description_es,\r\n              price\r\n            )\r\n          `)\r\n          .eq('user_id', user.id)\r\n        \r\n        if (!extensionsError && extensionsData) {\r\n          setUserExtensions(extensionsData)\r\n        }\r\n      } catch (extensionError) {\r\n        console.error('Network error loading user extensions:', extensionError)\r\n      }\r\n      \r\n      // Cargar historial de pagos con manejo de errores mejorado\r\n      console.log('Dashboard: Loading payment history')\r\n      try {\r\n        const { data: paymentsData, error: paymentsError } = await db.payments.getByUserId(user.id)\r\n        if (!paymentsError && paymentsData) {\r\n          console.log('Dashboard: Payments loaded successfully:', paymentsData.length)\r\n          setPayments(paymentsData)\r\n        } else if (paymentsError) {\r\n          console.error('Error loading payments:', paymentsError)\r\n          setPayments([]) // Establecer array vac√≠o en caso de error\r\n        }\r\n      } catch (paymentError) {\r\n        console.error('Network error loading payments:', paymentError)\r\n        setPayments([]) // Establecer array vac√≠o en caso de error de red\r\n      }\r\n      \r\n      console.log('Dashboard: Data loading completed successfully')\r\n      \r\n    } catch (error) {\r\n      console.error('Error loading dashboard data:', error)\r\n      // No mostrar toast de error para evitar spam al usuario\r\n      console.log('Dashboard cargado con datos b√°sicos debido a errores de conectividad')\r\n    } finally {\r\n      console.log('Dashboard: Setting loading to false')\r\n      setLoading(false)\r\n    }\r\n  }, [user, userProfile])\r\n\r\n  const checkGoogleDriveConnection = useCallback(() => {\r\n    // Usar la informaci√≥n ya disponible en userProfile desde AuthContext\r\n    // que incluye las credenciales de Google Drive\r\n    const isConnected = !!(userProfile?.google_refresh_token && userProfile.google_refresh_token.trim() !== '')\r\n    setIsGoogleDriveConnected(isConnected)\r\n    console.log('Dashboard: Google Drive connection status:', isConnected)\r\n  }, [userProfile])\r\n\r\n  // Timeout de seguridad para evitar loading infinito\r\n  useEffect(() => {\r\n    const maxLoadingTimeout = setTimeout(() => {\r\n      console.log('Dashboard: Max loading timeout reached, forcing loading to false')\r\n      setLoading(false)\r\n    }, 10000) // 10 segundos m√°ximo\r\n\r\n    return () => clearTimeout(maxLoadingTimeout)\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    let loadTimeout = null\r\n    \r\n    if (user && userProfile) {\r\n      // Debounce para evitar llamadas excesivas\r\n      loadTimeout = setTimeout(() => {\r\n        loadDashboardData()\r\n      }, 300)\r\n    } else if (user && !userProfile) {\r\n      // Usuario existe pero userProfile a√∫n no se ha cargado, mantener loading\r\n      console.log('Dashboard: User exists but userProfile not loaded yet')\r\n    } else {\r\n      // Si no hay usuario, asegurar que loading sea false\r\n      setLoading(false)\r\n    }\r\n    \r\n    return () => {\r\n      if (loadTimeout) {\r\n        clearTimeout(loadTimeout)\r\n      }\r\n    }\r\n  }, [user, userProfile, loadDashboardData])\r\n\r\n  // Efecto separado para verificar Google Drive cuando userProfile cambie\r\n  useEffect(() => {\r\n    if (userProfile) {\r\n      checkGoogleDriveConnection()\r\n    }\r\n  }, [userProfile, checkGoogleDriveConnection])\r\n\r\n  const handleConnectGoogleDrive = () => {\r\n    try {\r\n      const authUrl = googleDriveService.generateAuthUrl()\r\n      window.location.href = authUrl\r\n    } catch (error) {\r\n      console.error('Error getting auth URL:', error)\r\n      toast.error('Error al conectar con Google Drive')\r\n    }\r\n  }\r\n\r\n  const formatBytes = (bytes) => {\r\n    if (bytes === 0) return '0 Bytes'\r\n    const k = 1024\r\n    const sizes = ['Bytes', 'KB', 'MB', 'GB']\r\n    const i = Math.floor(Math.log(bytes) / Math.log(k))\r\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]\r\n  }\r\n\r\n  const formatDate = (dateString) => {\r\n    return new Date(dateString).toLocaleDateString('es-ES', {\r\n      year: 'numeric',\r\n      month: 'long',\r\n      day: 'numeric'\r\n    })\r\n  }\r\n\r\n  const getPlanName = () => {\r\n    if (!userProfile?.current_plan_id) return 'Sin plan'\r\n    const plan = plans.find(p => p.id === userProfile.current_plan_id)\r\n    return plan?.name || 'Plan desconocido'\r\n  }\r\n\r\n  const getStoragePercentage = () => {\r\n    if (!userProfile?.current_plan_id) return 0\r\n    const plan = plans.find(p => p.id === userProfile.current_plan_id)\r\n    const limit = plan?.storage_limit_bytes || 1024 * 1024 * 1024 // 1GB por defecto\r\n    return Math.min((stats.storageUsed / limit) * 100, 100)\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 flex items-center justify-center\">\r\n        <LoadingSpinner text=\"Cargando\" inline={true} />\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-50 to-blue-50\">\r\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\r\n        {/* Encabezado con informaci√≥n del usuario */}\r\n        <div className=\"flex flex-col md:flex-row md:items-center md:justify-between mb-8\">\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold text-gray-900 mb-2\">\r\n              Dashboard de {userProfile?.name || user?.email}\r\n            </h1>\r\n            <p className=\"text-blue-600 font-medium\">\r\n              Panel de control personalizado\r\n            </p>\r\n          </div>\r\n          <div className=\"mt-4 md:mt-0 flex flex-col sm:flex-row gap-3\">\r\n            <a\r\n              href=\"https://t.me/staffhubbeta_bot\"\r\n              target=\"_blank\"\r\n              rel=\"noopener noreferrer\"\r\n              className=\"inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-green-500 text-white font-bold rounded-lg transition-all duration-300 shadow-md hover:shadow-lg\"\r\n            >\r\n              <svg\r\n                className=\"w-4 h-4 mr-2\"\r\n                viewBox=\"0 0 24 24\"\r\n                fill=\"currentColor\"\r\n              >\r\n                <path d=\"M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.788-1.48-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z\"/>\r\n              </svg>\r\n              Chat Telegram\r\n            </a>\r\n            <a\r\n              href=\"https://wa.me/56987654321\"\r\n              target=\"_blank\"\r\n              rel=\"noopener noreferrer\"\r\n              className=\"inline-flex items-center px-4 py-2 bg-green-500 hover:bg-blue-600 text-white font-bold rounded-lg transition-all duration-300 shadow-md hover:shadow-lg\"\r\n            >\r\n              <svg\r\n                className=\"w-4 h-4 mr-2\"\r\n                viewBox=\"0 0 24 24\"\r\n                fill=\"currentColor\"\r\n              >\r\n                <path d=\"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z\"/>\r\n              </svg>\r\n              Chat WhatsApp\r\n            </a>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Alertas */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 mb-8\">\r\n\r\n          {!isGoogleDriveConnected && (\r\n            <div className=\"bg-gradient-to-r from-blue-100 to-gray-100 border border-blue-300 rounded-xl p-5 shadow-md\">\r\n              <div className=\"flex items-start\">\r\n                <div className=\"flex-shrink-0\">\r\n                  <CloudIcon className=\"h-6 w-6 text-blue-600\" />\r\n                </div>\r\n                <div className=\"ml-4 flex-1\">\r\n                  <h3 className=\"text-lg font-bold text-blue-600\">\r\n                    Google Drive\r\n                  </h3>\r\n                  <p className=\"text-blue-600 mt-1\">\r\n                    No conectado\r\n                  </p>\r\n                  <button\r\n                    onClick={handleConnectGoogleDrive}\r\n                    className=\"mt-3 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors duration-200\"\r\n                  >\r\n                    Conectar\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Estad√≠sticas principales en cards innovadoras */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8\">\r\n          <div className=\"bg-white rounded-2xl shadow-lg p-6 border-l-4 border-blue-500 hover:shadow-xl transition-shadow duration-300\">\r\n            <div className=\"flex items-center\">\r\n              <div className=\"p-3 rounded-full bg-blue-100\">\r\n                <FolderIcon className=\"h-6 w-6 text-blue-600\" />\r\n              </div>\r\n              <div className=\"ml-4\">\r\n                <p className=\"text-sm font-medium text-gray-600\">Carpetas</p>\r\n                <p className=\"text-2xl font-bold text-gray-900\">{stats.totalFolders}</p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"bg-white rounded-2xl shadow-lg p-6 border-l-4 border-green-500 hover:shadow-xl transition-shadow duration-300\">\r\n            <div className=\"flex items-center\">\r\n              <div className=\"p-3 rounded-full bg-green-100\">\r\n                <DocumentIcon className=\"h-6 w-6 text-green-600\" />\r\n              </div>\r\n              <div className=\"ml-4\">\r\n                <p className=\"text-sm font-medium text-gray-600\">Archivos</p>\r\n                <p className=\"text-2xl font-bold text-gray-900\">{stats.totalFiles}</p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"bg-white rounded-2xl shadow-lg p-6 border-l-4 border-purple-500 hover:shadow-xl transition-shadow duration-300\">\r\n            <div className=\"flex items-center\">\r\n              <div className=\"p-3 rounded-full bg-purple-100\">\r\n                <CpuChipIcon className=\"h-6 w-6 text-purple-600\" />\r\n              </div>\r\n              <div className=\"ml-4\">\r\n                <p className=\"text-sm font-medium text-gray-600\">Tokens Usados</p>\r\n                <p className=\"text-2xl font-bold text-gray-900\">{stats.tokensUsed.toLocaleString()}</p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"bg-white rounded-2xl shadow-lg p-6 border-l-4 border-yellow-500 hover:shadow-xl transition-shadow duration-300\">\r\n            <div className=\"flex items-center\">\r\n              <div className=\"p-3 rounded-full bg-yellow-100\">\r\n                <ChartBarIcon className=\"h-6 w-6 text-yellow-600\" />\r\n              </div>\r\n              <div className=\"ml-4\">\r\n                <p className=\"text-sm font-medium text-gray-600\">Almacenamiento</p>\r\n                <p className=\"text-2xl font-bold text-gray-900\">{formatBytes(stats.storageUsed)}</p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Resumen por Empresa con m√©tricas de comunicaci√≥n */}\r\n        <div className=\"mb-8\">\r\n          <DashboardResumen />\r\n        </div>\r\n\r\n        {/* Estad√≠sticas de comunicaci√≥n y progreso de almacenamiento */}\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8\">\r\n          {/* Estad√≠sticas de comunicaci√≥n */}\r\n          <CommunicationStats />\r\n          \r\n          {/* Progreso de almacenamiento */}\r\n          <div className=\"bg-white rounded-2xl shadow-xl p-6 border border-gray-200\">\r\n            <h2 className=\"text-xl font-bold text-gray-900 mb-6 flex items-center\">\r\n              <ChartBarIcon className=\"h-6 w-6 mr-3 text-blue-600\" />\r\n              Uso de Almacenamiento\r\n            </h2>\r\n            <div className=\"space-y-4\">\r\n              <div>\r\n                <div className=\"flex justify-between text-sm font-medium text-gray-900 mb-1\">\r\n                  <span>Almacenamiento</span>\r\n                  <span>{getStoragePercentage().toFixed(1)}%</span>\r\n                </div>\r\n                <div className=\"w-full bg-gray-200 rounded-full h-3\">\r\n                  <div \r\n                    className={`h-3 rounded-full transition-all duration-500 ${\r\n                      getStoragePercentage() >= 90 ? 'bg-red-500' : \r\n                      getStoragePercentage() >= 70 ? 'bg-yellow-500' : 'bg-blue-600'\r\n                    }`}\r\n                    style={{ width: `${Math.min(getStoragePercentage(), 100)}%` }}\r\n                  ></div>\r\n                </div>\r\n                <div className=\"flex justify-between text-xs text-gray-500 mt-1\">\r\n                  <span>{formatBytes(stats.storageUsed)}</span>\r\n                  <span>{formatBytes(1024 * 1024 * 1024)}</span>\r\n                </div>\r\n              </div>\r\n              \r\n              <div>\r\n                <div className=\"flex justify-between text-sm font-medium text-gray-900 mb-1\">\r\n                  <span>Tokens Usados</span>\r\n                  <span>\r\n                    {stats.tokenLimit > 0 ? `${((stats.tokensUsed / stats.tokenLimit) * 100).toFixed(1)}%` : 'N/A'}\r\n                  </span>\r\n                </div>\r\n                <div className=\"w-full bg-gray-200 rounded-full h-3\">\r\n                  <div \r\n                    className={`h-3 rounded-full transition-all duration-500 ${\r\n                      (stats.tokensUsed / (stats.tokenLimit || 1000)) * 100 >= 90 ? 'bg-red-500' : \r\n                      (stats.tokensUsed / (stats.tokenLimit || 1000)) * 100 >= 70 ? 'bg-yellow-500' : 'bg-green-500'\r\n                    }`}\r\n                    style={{ width: `${Math.min((stats.tokensUsed / (stats.tokenLimit || 1000)) * 100, 100)}%` }}\r\n                  ></div>\r\n                </div>\r\n                <div className=\"flex justify-between text-xs text-gray-500 mt-1\">\r\n                  <span>{stats.tokensUsed.toLocaleString()} tokens</span>\r\n                  <span>{stats.tokenLimit.toLocaleString()} tokens</span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            \r\n            <div className=\"mt-6 pt-4 border-t border-gray-200\">\r\n              <h3 className=\"font-medium text-gray-900 mb-3\">Plan Actual</h3>\r\n              <div className=\"flex items-center justify-between\">\r\n                <span className=\"text-gray-600\">{getPlanName()}</span>\r\n                <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800\">\r\n                  Activo\r\n                </span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        \r\n        {/* Historial de Compras y Acciones R√°pidas */}\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\r\n          {/* Historial de Compras */}\r\n          {payments.length > 0 && (\r\n            <div className=\"lg:col-span-2 bg-white rounded-2xl shadow-xl p-6 border border-gray-200\">\r\n              <h2 className=\"text-xl font-bold text-gray-900 mb-6 flex items-center\">\r\n                <CalendarIcon className=\"h-6 w-6 mr-3 text-blue-600\" />\r\n                Historial de Compras\r\n              </h2>\r\n              <div className=\"overflow-x-auto\">\r\n                <table className=\"min-w-full divide-y divide-gray-200\">\r\n                  <thead className=\"bg-gray-50\">\r\n                    <tr>\r\n                      <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Plan</th>\r\n                      <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Monto</th>\r\n                      <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Estado</th>\r\n                      <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Fecha</th>\r\n                    </tr>\r\n                  </thead>\r\n                  <tbody className=\"bg-white divide-y divide-gray-200\">\r\n                    {payments.slice(0, 3).map((payment) => (\r\n                      <tr key={payment.id} className=\"hover:bg-gray-50\">\r\n                        <td className=\"px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900\">\r\n                          {payment.plans?.name || 'Plan desconocido'}\r\n                        </td>\r\n                        <td className=\"px-4 py-3 whitespace-nowrap text-sm text-gray-900\">\r\n                          ${payment.amount_usd}\r\n                        </td>\r\n                        <td className=\"px-4 py-3 whitespace-nowrap\">\r\n                          <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${\r\n                            payment.payment_status === 'paid' \r\n                              ? 'bg-green-100 text-green-800'\r\n                              : payment.payment_status === 'pending'\r\n                              ? 'bg-yellow-100 text-yellow-800'\r\n                              : 'bg-red-100 text-red-800'\r\n                          }`}>\r\n                            {payment.payment_status === 'paid' ? 'Completado' : \r\n                             payment.payment_status === 'pending' ? 'Pendiente' : 'Fallido'}\r\n                          </span>\r\n                        </td>\r\n                        <td className=\"px-4 py-3 whitespace-nowrap text-sm text-gray-900\">\r\n                          {payment.paid_at ? formatDate(payment.paid_at) : 'N/A'}\r\n                        </td>\r\n                      </tr>\r\n                    ))}\r\n                  </tbody>\r\n                </table>\r\n              </div>\r\n              {payments.length > 3 && (\r\n                <div className=\"mt-4 text-center\">\r\n                  <Link\r\n                    to=\"/perfil\"\r\n                    className=\"text-sm font-bold text-blue-600 hover:text-green-600\"\r\n                  >\r\n                    Ver historial completo\r\n                  </Link>\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n          \r\n          {/* Acciones R√°pidas */}\r\n          <div className=\"space-y-8\">\r\n            <div className=\"bg-white rounded-2xl shadow-xl p-6 border border-gray-200\">\r\n              <h2 className=\"text-xl font-bold text-gray-900 mb-6\">Acciones R√°pidas</h2>\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <Link\r\n                  to=\"/folders\"\r\n                  className=\"flex flex-col items-center justify-center p-4 rounded-xl bg-blue-50 border border-blue-200 hover:bg-blue-100 transition-all duration-300 group\"\r\n                >\r\n                  <PlusIcon className=\"h-8 w-8 text-blue-600 group-hover:scale-110 transition-transform\" />\r\n                  <span className=\"mt-2 text-sm font-bold text-blue-600 text-center\">Crear Carpeta</span>\r\n                </Link>\r\n                \r\n                <Link\r\n                  to=\"/folders\"\r\n                  className=\"flex flex-col items-center justify-center p-4 rounded-xl bg-blue-50 border border-blue-200 hover:bg-blue-100 transition-all duration-300 group\"\r\n                >\r\n                  <FolderIcon className=\"h-8 w-8 text-blue-600 group-hover:scale-110 transition-transform\" />\r\n                  <span className=\"mt-2 text-sm font-bold text-blue-600 text-center\">Ver Carpetas</span>\r\n                </Link>\r\n                \r\n                <Link\r\n                  to=\"/files\"\r\n                  className=\"flex flex-col items-center justify-center p-4 rounded-xl bg-green-50 border border-green-200 hover:bg-green-100 transition-all duration-300 group\"\r\n                >\r\n                  <DocumentIcon className=\"h-8 w-8 text-green-600 group-hover:scale-110 transition-transform\" />\r\n                  <span className=\"mt-2 text-sm font-bold text-green-600 text-center\">Subir Archivos</span>\r\n                </Link>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default InnovativeDashboard\r\n                \r\n","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\dashboard\\MicroservicesDashboard.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'handleInsightsReceived'. Either include it or remove the dependency array.","line":41,"column":6,"nodeType":"ArrayExpression","endLine":41,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [handleInsightsReceived]","fix":{"range":[1268,1270],"text":"[handleInsightsReceived]"}}]},{"ruleId":"react/jsx-no-undef","severity":2,"message":"'JobStatusBadge' is not defined.","line":355,"column":20,"nodeType":"JSXIdentifier","messageId":"undefined","endLine":355,"endColumn":34},{"ruleId":"no-undef","severity":2,"message":"'processSingleCompany' is not defined.","line":429,"column":34,"nodeType":"Identifier","messageId":"undef","endLine":429,"endColumn":54},{"ruleId":"no-unused-vars","severity":1,"message":"'StatusBadge' is assigned a value but never used.","line":483,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":483,"endColumn":18}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback } from 'react';\r\nimport { supabase } from '../../lib/supabase.js';\r\n\r\n/**\r\n * Dashboard con Microservicios\r\n * \r\n * Este componente demuestra c√≥mo usar microservicios para procesar\r\n * m√∫ltiples empresas sin bloquear la UI\r\n */\r\n\r\nconst MicroservicesDashboard = () => {\r\n  const [companies, setCompanies] = useState([]);\r\n  const [jobs, setJobs] = useState({});\r\n  const [insights, setInsights] = useState({});\r\n  const [isProcessing, setIsProcessing] = useState(false);\r\n  const [webhookUrl] = useState(`${window.location.origin}/api/webhook/insights-ready`);\r\n\r\n  // 1. CARGAR EMPRESAS AL MONTAR\r\n  useEffect(() => {\r\n    loadCompanies();\r\n  }, []);\r\n\r\n  // 2. SUSCRIBIRSE A NOTIFICACIONES EN TIEMPO REAL\r\n  useEffect(() => {\r\n    const subscription = supabase\r\n      .channel('insights-notifications')\r\n      .on('postgres_changes', {\r\n        event: 'INSERT',\r\n        schema: 'public',\r\n        table: 'realtime_notifications',\r\n        filter: `event_type=eq.insights_ready`\r\n      }, (payload) => {\r\n        const { company_id, payload: data } = payload.new;\r\n        handleInsightsReceived(company_id, data);\r\n      })\r\n      .subscribe();\r\n\r\n    return () => {\r\n      subscription.unsubscribe();\r\n    };\r\n  }, []);\r\n\r\n  /**\r\n   * Carga las empresas desde Supabase\r\n   */\r\n  const loadCompanies = async () => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('companies')\r\n        .select('*')\r\n        .order('name', { ascending: true });\r\n\r\n      if (error) throw error;\r\n      \r\n      setCompanies(data || []);\r\n    } catch (error) {\r\n      console.error('Error cargando empresas:', error);\r\n    }\r\n  };\r\n\r\n  /**\r\n   * 3. INICIAR PROCESAMIENTO VIA MICROSERVICIO\r\n   */\r\n  const processCompanies = async () => {\r\n    if (companies.length === 0) return;\r\n\r\n    setIsProcessing(true);\r\n    \r\n    // Crear estado inicial de jobs\r\n    const initialJobs = {};\r\n    companies.forEach(company => {\r\n      initialJobs[company.id] = {\r\n        status: 'queued',\r\n        companyName: company.name,\r\n        startTime: Date.now(),\r\n        progress: 0\r\n      };\r\n    });\r\n    setJobs(initialJobs);\r\n\r\n    // Llamar al microservicio para cada empresa\r\n    for (let i = 0; i < companies.length; i++) {\r\n      const company = companies[i];\r\n      \r\n      try {\r\n        // ACTIVAR MICROSERVICIO\r\n        const response = await callMicroservice(company);\r\n        \r\n        setJobs(prev => ({\r\n          ...prev,\r\n          [company.id]: {\r\n            ...prev[company.id],\r\n            status: 'processing',\r\n            jobId: response.jobId,\r\n            estimatedTime: response.estimatedTime\r\n          }\r\n        }));\r\n\r\n        // Notificar progreso\r\n        showNotification(`Iniciado an√°lisis para ${company.name}`);\r\n\r\n      } catch (error) {\r\n        setJobs(prev => ({\r\n          ...prev,\r\n          [company.id]: {\r\n            ...prev[company.id],\r\n            status: 'error',\r\n            error: error.message\r\n          }\r\n        }));\r\n      }\r\n    }\r\n  };\r\n\r\n  /**\r\n   * 4. LLAMADA AL MICROSERVICIO\r\n   */\r\n  const callMicroservice = async (company) => {\r\n    const response = await fetch('/.netlify/functions/analyze-company', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Authorization': `Bearer ${localStorage.getItem('token') || 'anonymous'}`\r\n      },\r\n      body: JSON.stringify({\r\n        companyId: company.id,\r\n        companyName: company.name,\r\n        webhookUrl: webhookUrl,\r\n        userId: 'current-user-id'\r\n      })\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const errorData = await response.json().catch(() => ({}));\r\n      throw new Error(`HTTP ${response.status}: ${errorData.error || response.statusText}`);\r\n    }\r\n\r\n    return await response.json();\r\n  };\r\n\r\n  /**\r\n   * 5. MANEJAR RESULTADO DEL WEBHOOK\r\n   */\r\n  const handleInsightsReceived = useCallback((companyId, data) => {\r\n    console.log(`[DASHBOARD] Insights recibidos para empresa ${companyId}`);\r\n\r\n    // Actualizar insights en estado\r\n    setInsights(prev => ({\r\n      ...prev,\r\n      [companyId]: data.insights\r\n    }));\r\n\r\n    // Actualizar job a completado\r\n    setJobs(prev => {\r\n      const job = prev[companyId];\r\n      if (!job) return prev;\r\n      \r\n      return {\r\n        ...prev,\r\n        [companyId]: {\r\n          ...job,\r\n          status: 'completed',\r\n          endTime: Date.now(),\r\n          duration: Date.now() - job.startTime\r\n        }\r\n      };\r\n    });\r\n\r\n    // Mostrar notificaci√≥n\r\n    showNotification(`‚úÖ An√°lisis completado para ${data.companyName}`);\r\n  }, []);\r\n\r\n  /**\r\n   * 6. CANCELAR PROCESAMIENTO\r\n   */\r\n  const cancelProcessing = () => {\r\n    setIsProcessing(false);\r\n    \r\n    // Actualizar todos los jobs a cancelado\r\n    setJobs(prev => {\r\n      const updated = { ...prev };\r\n      Object.keys(updated).forEach(id => {\r\n        if (updated[id].status === 'processing' || updated[id].status === 'queued') {\r\n          updated[id].status = 'cancelled';\r\n        }\r\n      });\r\n      return updated;\r\n    });\r\n\r\n    showNotification('Procesamiento cancelado');\r\n  };\r\n\r\n  /**\r\n   * 7. REINTENTAR EMPRESA FALLIDA\r\n   */\r\n  const retryCompany = async (company) => {\r\n    setJobs(prev => ({\r\n      ...prev,\r\n      [company.id]: {\r\n        ...prev[company.id],\r\n        status: 'queued',\r\n        error: null,\r\n        startTime: Date.now()\r\n      }\r\n    }));\r\n\r\n    try {\r\n      const response = await callMicroservice(company);\r\n      \r\n      setJobs(prev => ({\r\n        ...prev,\r\n        [company.id]: {\r\n          ...prev[company.id],\r\n          status: 'processing',\r\n          jobId: response.jobId\r\n        }\r\n      }));\r\n    } catch (error) {\r\n      setJobs(prev => ({\r\n        ...prev,\r\n        [company.id]: {\r\n          ...prev[company.id],\r\n          status: 'error',\r\n          error: error.message\r\n        }\r\n      }));\r\n    }\r\n  };\r\n\r\n  // Funci√≥n auxiliar para mostrar notificaciones\r\n  const showNotification = (message) => {\r\n    // Puedes integrar con tu sistema de notificaciones\r\n    console.log(`[NOTIFICATION] ${message}`);\r\n    // O usar una librer√≠a como react-hot-toast\r\n    // toast.success(message);\r\n  };\r\n\r\n  // Verificar si todos los jobs est√°n completados\r\n  const allCompleted = Object.values(jobs).every(job => job.status === 'completed' || job.status === 'error' || job.status === 'cancelled');\r\n  \r\n  useEffect(() => {\r\n    if (allCompleted && isProcessing) {\r\n      setIsProcessing(false);\r\n      showNotification('üéâ Procesamiento finalizado');\r\n    }\r\n  }, [allCompleted, isProcessing]);\r\n\r\n  return (\r\n    <div className=\"p-6 max-w-7xl mx-auto\">\r\n      {/* HEADER */}\r\n      <div className=\"mb-8\">\r\n        <h1 className=\"text-3xl font-bold text-gray-900 mb-2\">\r\n          Dashboard con Microservicios\r\n        </h1>\r\n        <p className=\"text-gray-600\">\r\n          Procesa m√∫ltiples empresas sin bloquear la interfaz usando arquitectura serverless\r\n        </p>\r\n      </div>\r\n\r\n      {/* CONTROLES */}\r\n      <div className=\"mb-6 p-6 bg-white rounded-lg shadow-md\">\r\n        <div className=\"flex flex-wrap items-center justify-between gap-4\">\r\n          <div>\r\n            <h2 className=\"text-xl font-semibold mb-2\">Control de Procesamiento</h2>\r\n            <p className=\"text-sm text-gray-600\">\r\n              Empresas cargadas: <span className=\"font-bold\">{companies.length}</span>\r\n            </p>\r\n          </div>\r\n\r\n          <div className=\"flex gap-3\">\r\n            <button\r\n              onClick={processCompanies}\r\n              disabled={isProcessing || companies.length === 0}\r\n              className=\"px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors\"\r\n            >\r\n              {isProcessing ? (\r\n                <span className=\"flex items-center\">\r\n                  <svg className=\"animate-spin -ml-1 mr-3 h-5 w-5 text-white\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n                    <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\r\n                    <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\r\n                  </svg>\r\n                  Procesando...\r\n                </span>\r\n              ) : (\r\n                'Procesar Todas las Empresas'\r\n              )}\r\n            </button>\r\n            \r\n            <button\r\n              onClick={cancelProcessing}\r\n              disabled={!isProcessing}\r\n              className=\"px-6 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors\"\r\n            >\r\n              Cancelar\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"mt-4 p-3 bg-blue-50 rounded-lg\">\r\n          <p className=\"text-sm text-blue-800\">\r\n            <strong>Webhook configurado:</strong> <code className=\"bg-blue-100 px-2 py-1 rounded\">{webhookUrl}</code>\r\n          </p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* RESUMEN DE PROGRESO */}\r\n      {Object.keys(jobs).length > 0 && (\r\n        <div className=\"mb-6 p-6 bg-white rounded-lg shadow-md\">\r\n          <h3 className=\"text-lg font-semibold mb-4\">Resumen de Progreso</h3>\r\n          \r\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\r\n            <div className=\"text-center p-3 bg-gray-50 rounded\">\r\n              <div className=\"text-2xl font-bold text-gray-700\">\r\n                {Object.values(jobs).filter(j => j.status === 'queued').length}\r\n              </div>\r\n              <div className=\"text-sm text-gray-600\">En Cola</div>\r\n            </div>\r\n            \r\n            <div className=\"text-center p-3 bg-blue-50 rounded\">\r\n              <div className=\"text-2xl font-bold text-blue-700\">\r\n                {Object.values(jobs).filter(j => j.status === 'processing').length}\r\n              </div>\r\n              <div className=\"text-sm text-blue-600\">Procesando</div>\r\n            </div>\r\n            \r\n            <div className=\"text-center p-3 bg-green-50 rounded\">\r\n              <div className=\"text-2xl font-bold text-green-700\">\r\n                {Object.values(jobs).filter(j => j.status === 'completed').length}\r\n              </div>\r\n              <div className=\"text-sm text-green-600\">Completadas</div>\r\n            </div>\r\n            \r\n            <div className=\"text-center p-3 bg-red-50 rounded\">\r\n              <div className=\"text-2xl font-bold text-red-700\">\r\n                {Object.values(jobs).filter(j => j.status === 'error').length}\r\n              </div>\r\n              <div className=\"text-sm text-red-600\">Con Error</div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* GRID DE EMPRESAS */}\r\n      <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\r\n        {companies.map(company => {\r\n          const job = jobs[company.id];\r\n          const insight = insights[company.id];\r\n\r\n          return (\r\n            <div key={company.id} className=\"bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow\">\r\n              {/* Header */}\r\n              <div className=\"p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-200\">\r\n                <div className=\"flex justify-between items-start\">\r\n                  <h3 className=\"font-bold text-lg text-gray-900 truncate\">{company.name}</h3>\r\n                  <JobStatusBadge status={job?.status} />\r\n                </div>\r\n              </div>\r\n\r\n              {/* Body */}\r\n              <div className=\"p-4\">\r\n                {/* Barra de progreso */}\r\n                {job?.status === 'processing' && (\r\n                  <div className=\"mb-4\">\r\n                    <div className=\"flex justify-between text-sm text-gray-600 mb-1\">\r\n                      <span>Procesando...</span>\r\n                      <span>{job.progress || 0}%</span>\r\n                    </div>\r\n                    <div className=\"w-full bg-gray-200 rounded-full h-2\">\r\n                      <div \r\n                        className=\"bg-blue-600 h-2 rounded-full animate-pulse transition-all duration-300\"\r\n                        style={{ width: `${job.progress || 0}%` }}\r\n                      />\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {/* Tiempo estimado */}\r\n                {job?.status === 'processing' && job.estimatedTime && (\r\n                  <p className=\"text-xs text-gray-500 mb-3\">\r\n                    ‚è±Ô∏è Estimado: {job.estimatedTime}\r\n                  </p>\r\n                )}\r\n\r\n                {/* Insights */}\r\n                {insight && (\r\n                  <div className=\"mb-4 p-3 bg-green-50 rounded-lg border border-green-200\">\r\n                    <h4 className=\"font-semibold text-sm text-green-800 mb-2\">‚úÖ Insights Generados:</h4>\r\n                    <div className=\"space-y-1\">\r\n                      {insight.frontInsights?.map((item, idx) => (\r\n                        <div key={idx} className=\"text-sm text-green-700\">‚Ä¢ {item.title}</div>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {/* Error */}\r\n                {job?.status === 'error' && (\r\n                  <div className=\"mb-4 p-3 bg-red-50 rounded-lg border border-red-200\">\r\n                    <p className=\"text-sm text-red-700 mb-2\">\r\n                      ‚ùå {job.error || 'Error desconocido'}\r\n                    </p>\r\n                    <button\r\n                      onClick={() => retryCompany(company)}\r\n                      className=\"w-full px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors\"\r\n                    >\r\n                      Reintentar\r\n                    </button>\r\n                  </div>\r\n                )}\r\n\r\n                {/* Duraci√≥n */}\r\n                {job?.duration && (\r\n                  <p className=\"text-xs text-gray-500 mb-3\">\r\n                    ‚è±Ô∏è Completado en {job.duration}ms\r\n                  </p>\r\n                )}\r\n\r\n                {/* ID de trabajo */}\r\n                {job?.jobId && (\r\n                  <p className=\"text-xs text-gray-400\">\r\n                    Job ID: {job.jobId.substring(0, 8)}...\r\n                  </p>\r\n                )}\r\n              </div>\r\n\r\n              {/* Footer */}\r\n              <div className=\"p-4 bg-gray-50 border-t border-gray-200\">\r\n                <button\r\n                  onClick={() => processSingleCompany(company)}\r\n                  disabled={job?.status === 'processing'}\r\n                  className=\"w-full px-4 py-2 bg-green-600 text-white text-sm font-medium rounded hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors\"\r\n                >\r\n                  {job?.status === 'processing' ? 'Procesando...' : 'Procesar Individualmente'}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          );\r\n        })}\r\n      </div>\r\n\r\n      {/* MENSAJE SI NO HAY EMPRESAS */}\r\n      {companies.length === 0 && (\r\n        <div className=\"text-center py-12\">\r\n          <div className=\"text-gray-400 mb-4\">\r\n            <svg className=\"mx-auto h-12 w-12\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\r\n            </svg>\r\n          </div>\r\n          <p className=\"text-gray-500\">No hay empresas para procesar</p>\r\n        </div>\r\n      )}\r\n\r\n      {/* DEBUG INFO */}\r\n      {Object.keys(jobs).length > 0 && (\r\n        <div className=\"mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200\">\r\n          <h3 className=\"font-bold text-lg mb-4 text-gray-800\">üîç Informaci√≥n de Debug</h3>\r\n          \r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm\">\r\n            <div>\r\n              <strong className=\"text-gray-700\">Jobs Activos:</strong>\r\n              <pre className=\"mt-2 p-3 bg-white rounded text-xs overflow-auto\">\r\n                {JSON.stringify(workerTrendsService.getActiveJobs?.() || 'No disponible', null, 2)}\r\n              </pre>\r\n            </div>\r\n            \r\n            <div>\r\n              <strong className=\"text-gray-700\">Estad√≠sticas:</strong>\r\n              <ul className=\"mt-2 space-y-1\">\r\n                <li>Total: {Object.keys(jobs).length} empresas</li>\r\n                <li>Completadas: {Object.values(jobs).filter(j => j.status === 'completed').length}</li>\r\n                <li>Con errores: {Object.values(jobs).filter(j => j.status === 'error').length}</li>\r\n                <li>Webhook: {webhookUrl ? '‚úÖ Activo' : '‚ùå Inactivo'}</li>\r\n              </ul>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\n// Componente auxiliar para mostrar estado\r\nconst StatusBadge = ({ status }) => {\r\n  const styles = {\r\n    queued: 'bg-gray-200 text-gray-700',\r\n    processing: 'bg-blue-200 text-blue-700 animate-pulse',\r\n    completed: 'bg-green-200 text-green-700',\r\n    error: 'bg-red-200 text-red-700',\r\n    cancelled: 'bg-yellow-200 text-yellow-700'\r\n  };\r\n\r\n  const labels = {\r\n    queued: 'En Cola',\r\n    processing: 'Procesando',\r\n    completed: 'Completado',\r\n    error: 'Error',\r\n    cancelled: 'Cancelado'\r\n  };\r\n\r\n  return (\r\n    <span className={`px-3 py-1 rounded-full text-xs font-medium ${styles[status] || styles.queued}`}>\r\n      {labels[status] || 'Pendiente'}\r\n    </span>\r\n  );\r\n};\r\n\r\n// Servicio wrapper para el worker (placeholder para futura implementaci√≥n)\r\nconst workerTrendsService = {\r\n  getActiveJobs: () => {\r\n    // En una implementaci√≥n real, esto conectar√≠a con el microservicio\r\n    return { message: 'Worker service no implementado en esta demo' };\r\n  }\r\n};\r\n\r\nexport default MicroservicesDashboard;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\dashboard\\ModernAIEnhancedDashboard.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'organizedDatabaseService' is defined but never used.","line":15,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useMemo, useCallback } from 'react';\r\nimport { motion } from 'framer-motion';\r\nimport {\r\n  FolderIcon,\r\n  DocumentTextIcon,\r\n  CpuChipIcon,\r\n  CloudArrowUpIcon,\r\n  ChartBarIcon,\r\n  SparklesIcon,\r\n  ArrowTrendingUpIcon\r\n} from '@heroicons/react/24/outline';\r\nimport DashboardChart from '../charts/DashboardChart.js';\r\nimport AIRecommendations from './AIRecommendations.js';\r\nimport aiRecommendationsService from '../../services/aiRecommendationsService.js';\r\nimport organizedDatabaseService from '../../services/organizedDatabaseService.js';\r\n\r\nconst ModernAIEnhancedDashboard = ({ dashboardStats, loading = false }) => {\r\n  const [trendData, setTrendData] = useState(null);\r\n  const [predictions, setPredictions] = useState(null);\r\n  const [selectedTimeRange, setSelectedTimeRange] = useState('7d');\r\n\r\n  const generateMockTrendData = useCallback(() => {\r\n    const days = selectedTimeRange === '7d' ? 7 : selectedTimeRange === '30d' ? 30 : 90;\r\n    const labels = Array.from({ length: days }, (_, i) => {\r\n      const date = new Date();\r\n      date.setDate(date.getDate() - (days - i - 1));\r\n      return date.toLocaleDateString('es', { month: 'short', day: 'numeric' });\r\n    });\r\n\r\n    return {\r\n      labels,\r\n      datasets: [\r\n        {\r\n          label: 'Carpetas',\r\n          data: Array.from({ length: days }, () => Math.floor(Math.random() * 50) + 750),\r\n          borderColor: 'rgb(59, 130, 246)',\r\n          backgroundColor: 'rgba(59, 130, 246, 0.1)',\r\n          tension: 0.4\r\n        },\r\n        {\r\n          label: 'Documentos',\r\n          data: Array.from({ length: days }, () => Math.floor(Math.random() * 200) + 800),\r\n          borderColor: 'rgb(16, 185, 129)',\r\n          backgroundColor: 'rgba(16, 185, 129, 0.1)',\r\n          tension: 0.4\r\n        },\r\n        {\r\n          label: 'Tokens Usados',\r\n          data: Array.from({ length: days }, () => Math.floor(Math.random() * 1000) + 40000),\r\n          borderColor: 'rgb(251, 146, 60)',\r\n          backgroundColor: 'rgba(251, 146, 60, 0.1)',\r\n          tension: 0.4\r\n        }\r\n      ]\r\n    };\r\n  }, [selectedTimeRange]);\r\n\r\n  const generateMockPredictions = useCallback(() => {\r\n    // Validaci√≥n segura de dashboardStats\r\n    const safeFolders = dashboardStats?.folders || 800;\r\n    const safeDocuments = dashboardStats?.documents || 1000;\r\n    const safeTokens = dashboardStats?.tokensUsed || 50000;\r\n    const safeStorage = dashboardStats?.storageUsed || 10000;\r\n\r\n    return {\r\n      nextMonth: {\r\n        folders: Math.floor(safeFolders * 1.1),\r\n        documents: Math.floor(safeDocuments * 1.15),\r\n        tokens: Math.floor(safeTokens * 1.2),\r\n        storage: Math.floor(safeStorage * 1.25)\r\n      },\r\n      insights: [\r\n        'El crecimiento de carpetas se mantendr√° estable (+10%)',\r\n        'El uso de documentos aumentar√° significativamente (+15%)',\r\n        'Se recomienda optimizar el uso de tokens para el pr√≥ximo mes'\r\n      ]\r\n    };\r\n  }, [dashboardStats]);\r\n\r\n  const loadTrendData = useCallback(async () => {\r\n    if (!dashboardStats) return;\r\n    \r\n    try {\r\n      const data = await aiRecommendationsService.getTrendPredictions(dashboardStats, selectedTimeRange);\r\n      setTrendData(data);\r\n    } catch (error) {\r\n      console.error('Error loading trend data:', error);\r\n      // Datos de respaldo\r\n      setTrendData(generateMockTrendData());\r\n    }\r\n  }, [dashboardStats, selectedTimeRange, generateMockTrendData]);\r\n\r\n  const loadPredictions = useCallback(async () => {\r\n    if (!dashboardStats) return;\r\n    \r\n    try {\r\n      const data = await aiRecommendationsService.getProductivityRecommendations(dashboardStats);\r\n      setPredictions(data);\r\n    } catch (error) {\r\n      console.error('Error loading predictions:', error);\r\n      // Predicciones de respaldo\r\n      setPredictions(generateMockPredictions());\r\n    }\r\n  }, [dashboardStats, generateMockPredictions]);\r\n\r\n  useEffect(() => {\r\n    if (dashboardStats) {\r\n      loadTrendData();\r\n      loadPredictions();\r\n    }\r\n  }, [dashboardStats, selectedTimeRange, loadTrendData, loadPredictions]);\r\n\r\n\r\n  const chartData = useMemo(() => {\r\n    if (!trendData) return null;\r\n\r\n    return {\r\n      labels: trendData.labels,\r\n      datasets: trendData.datasets\r\n    };\r\n  }, [trendData]);\r\n\r\n  const pieData = useMemo(() => {\r\n    // Validaci√≥n segura de dashboardStats\r\n    if (!dashboardStats || typeof dashboardStats !== 'object') {\r\n      return null;\r\n    }\r\n\r\n    // Valores seguros con fallbacks\r\n    const safeFolders = dashboardStats.folders || 800;\r\n    const safeDocuments = dashboardStats.documents || 1000;\r\n    const safeTokens = dashboardStats.tokensUsed || 50000;\r\n    const safeStorage = dashboardStats.storageUsed || 10000;\r\n\r\n    return {\r\n      labels: ['Carpetas', 'Documentos', 'Tokens Usados', 'Almacenamiento'],\r\n      datasets: [\r\n        {\r\n          data: [\r\n            safeFolders,\r\n            safeDocuments,\r\n            Math.floor(safeTokens / 100), // Escalar para visualizaci√≥n\r\n            Math.floor(safeStorage / 10) // Escalar para visualizaci√≥n\r\n          ],\r\n          backgroundColor: [\r\n            'rgba(59, 130, 246, 0.8)',\r\n            'rgba(16, 185, 129, 0.8)',\r\n            'rgba(251, 146, 60, 0.8)',\r\n            'rgba(147, 51, 234, 0.8)'\r\n          ],\r\n          borderColor: [\r\n            'rgb(59, 130, 246)',\r\n            'rgb(16, 185, 129)',\r\n            'rgb(251, 146, 60)',\r\n            'rgb(147, 51, 234)'\r\n          ],\r\n          borderWidth: 2\r\n        }\r\n      ]\r\n    };\r\n  }, [dashboardStats]);\r\n\r\n  const radarData = useMemo(() => {\r\n    // Validaci√≥n segura de dashboardStats y predictions\r\n    if (!dashboardStats || typeof dashboardStats !== 'object' ||\r\n        !predictions || typeof predictions !== 'object' || !predictions.nextMonth) {\r\n      return null;\r\n    }\r\n\r\n    // Valores seguros con fallbacks\r\n    const currentFolders = dashboardStats.folders || 800;\r\n    const currentDocuments = dashboardStats.documents || 1000;\r\n    const currentTokens = dashboardStats.tokensUsed || 50000;\r\n    const currentStorage = dashboardStats.storageUsed || 10000;\r\n\r\n    const predictedFolders = predictions.nextMonth.folders || currentFolders * 1.1;\r\n    const predictedDocuments = predictions.nextMonth.documents || currentDocuments * 1.15;\r\n    const predictedTokens = predictions.nextMonth.tokens || currentTokens * 1.2;\r\n    const predictedStorage = predictions.nextMonth.storage || currentStorage * 1.25;\r\n\r\n    return {\r\n      labels: ['Carpetas', 'Documentos', 'Tokens', 'Almacenamiento', 'Eficiencia'],\r\n      datasets: [\r\n        {\r\n          label: 'Actual',\r\n          data: [\r\n            currentFolders / 10,\r\n            currentDocuments / 20,\r\n            currentTokens / 1000,\r\n            currentStorage / 200,\r\n            75\r\n          ],\r\n          borderColor: 'rgb(59, 130, 246)',\r\n          backgroundColor: 'rgba(59, 130, 246, 0.2)',\r\n        },\r\n        {\r\n          label: 'Predicci√≥n',\r\n          data: [\r\n            predictedFolders / 10,\r\n            predictedDocuments / 20,\r\n            predictedTokens / 1000,\r\n            predictedStorage / 200,\r\n            85\r\n          ],\r\n          borderColor: 'rgb(16, 185, 129)',\r\n          backgroundColor: 'rgba(16, 185, 129, 0.2)',\r\n        }\r\n      ]\r\n    };\r\n  }, [dashboardStats, predictions]);\r\n\r\n  const handleRecommendationClick = (recommendation) => {\r\n    console.log('Recomendaci√≥n seleccionada:', recommendation);\r\n    // Aqu√≠ puedes implementar la l√≥gica para manejar las recomendaciones\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gray-50 flex items-center justify-center\">\r\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600\"></div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gray-50 p-6\">\r\n      <motion.div\r\n        initial={{ opacity: 0, y: 20 }}\r\n        animate={{ opacity: 1, y: 0 }}\r\n        transition={{ duration: 0.5 }}\r\n        className=\"max-w-7xl mx-auto\"\r\n      >\r\n        {/* Header */}\r\n        <div className=\"mb-8\">\r\n          <h1 className=\"text-3xl font-bold text-gray-900 mb-2\">\r\n            Panel Principal Mejorado con IA\r\n          </h1>\r\n          <p className=\"text-gray-600\">\r\n            An√°lisis inteligente y recomendaciones personalizadas para tu negocio\r\n          </p>\r\n        </div>\r\n\r\n        {/* Stats Cards */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8\">\r\n          <motion.div\r\n            initial={{ opacity: 0, scale: 0.9 }}\r\n            animate={{ opacity: 1, scale: 1 }}\r\n            transition={{ duration: 0.3, delay: 0.1 }}\r\n            className=\"bg-white rounded-xl shadow-lg border border-gray-200 p-6 hover:shadow-xl transition-shadow\"\r\n          >\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm font-medium text-gray-600\">Carpetas</p>\r\n                <p className=\"text-2xl font-bold text-gray-900\">\r\n                  {dashboardStats?.folders?.toLocaleString() || '800'}\r\n                </p>\r\n                <p className=\"text-xs text-green-600 mt-1\">\r\n                  <ArrowTrendingUpIcon className=\"w-3 h-3 inline mr-1\" />\r\n                  +{predictions && predictions.nextMonth && dashboardStats?.folders && dashboardStats.folders > 0 ? Math.round(((predictions.nextMonth.folders - dashboardStats.folders) / dashboardStats.folders) * 100) : 10}% pronosticado\r\n                </p>\r\n              </div>\r\n              <div className=\"bg-blue-100 p-3 rounded-lg\">\r\n                <FolderIcon className=\"w-6 h-6 text-blue-600\" />\r\n              </div>\r\n            </div>\r\n          </motion.div>\r\n\r\n          <motion.div\r\n            initial={{ opacity: 0, scale: 0.9 }}\r\n            animate={{ opacity: 1, scale: 1 }}\r\n            transition={{ duration: 0.3, delay: 0.2 }}\r\n            className=\"bg-white rounded-xl shadow-lg border border-gray-200 p-6 hover:shadow-xl transition-shadow\"\r\n          >\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm font-medium text-gray-600\">Documentos</p>\r\n                <p className=\"text-2xl font-bold text-gray-900\">\r\n                  {dashboardStats?.documents?.toLocaleString() || '0'}\r\n                </p>\r\n                <p className=\"text-xs text-green-600 mt-1\">\r\n                  <ArrowTrendingUpIcon className=\"w-3 h-3 inline mr-1\" />\r\n                  +{predictions && predictions.nextMonth && dashboardStats?.documents && dashboardStats.documents > 0 ? Math.round(((predictions.nextMonth.documents - dashboardStats.documents) / dashboardStats.documents) * 100) : 15}% pronosticado\r\n                </p>\r\n              </div>\r\n              <div className=\"bg-green-100 p-3 rounded-lg\">\r\n                <DocumentTextIcon className=\"w-6 h-6 text-green-600\" />\r\n              </div>\r\n            </div>\r\n          </motion.div>\r\n\r\n          <motion.div\r\n            initial={{ opacity: 0, scale: 0.9 }}\r\n            animate={{ opacity: 1, scale: 1 }}\r\n            transition={{ duration: 0.3, delay: 0.3 }}\r\n            className=\"bg-white rounded-xl shadow-lg border border-gray-200 p-6 hover:shadow-xl transition-shadow\"\r\n          >\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm font-medium text-gray-600\">Tokens Usados</p>\r\n                <p className=\"text-2xl font-bold text-gray-900\">\r\n                  {dashboardStats?.tokensUsed?.toLocaleString() || '0'}\r\n                </p>\r\n                <p className=\"text-xs text-yellow-600 mt-1\">\r\n                  <ArrowTrendingUpIcon className=\"w-3 h-3 inline mr-1\" />\r\n                  +{predictions && predictions.nextMonth && dashboardStats?.tokensUsed && dashboardStats.tokensUsed > 0 ? Math.round(((predictions.nextMonth.tokens - dashboardStats.tokensUsed) / dashboardStats.tokensUsed) * 100) : 20}% pronosticado\r\n                </p>\r\n              </div>\r\n              <div className=\"bg-orange-100 p-3 rounded-lg\">\r\n                <CpuChipIcon className=\"w-6 h-6 text-orange-600\" />\r\n              </div>\r\n            </div>\r\n          </motion.div>\r\n\r\n          <motion.div\r\n            initial={{ opacity: 0, scale: 0.9 }}\r\n            animate={{ opacity: 1, scale: 1 }}\r\n            transition={{ duration: 0.3, delay: 0.4 }}\r\n            className=\"bg-white rounded-xl shadow-lg border border-gray-200 p-6 hover:shadow-xl transition-shadow\"\r\n          >\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm font-medium text-gray-600\">Almacenamiento</p>\r\n                <p className=\"text-2xl font-bold text-gray-900\">\r\n                  {dashboardStats?.storageUsed?.toLocaleString() || '0'} MB\r\n                </p>\r\n                <p className=\"text-xs text-purple-600 mt-1\">\r\n                  <CloudArrowUpIcon className=\"w-3 h-3 inline mr-1\" />\r\n                  {Math.round((dashboardStats?.storageUsed || 0) / 1024)} GB usados\r\n                </p>\r\n              </div>\r\n              <div className=\"bg-purple-100 p-3 rounded-lg\">\r\n                <CloudArrowUpIcon className=\"w-6 h-6 text-purple-600\" />\r\n              </div>\r\n            </div>\r\n          </motion.div>\r\n        </div>\r\n\r\n        {/* Charts and Recommendations */}\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8\">\r\n          {/* Trend Chart */}\r\n          <div className=\"lg:col-span-2\">\r\n            <div className=\"bg-white rounded-xl shadow-lg border border-gray-200 p-6\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <h3 className=\"text-lg font-semibold text-gray-900\">Tendencias y Pron√≥sticos</h3>\r\n                <select\r\n                  value={selectedTimeRange}\r\n                  onChange={(e) => setSelectedTimeRange(e.target.value)}\r\n                  className=\"text-sm border border-gray-300 rounded-md px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                >\r\n                  <option value=\"7d\">√öltimos 7 d√≠as</option>\r\n                  <option value=\"30d\">√öltimos 30 d√≠as</option>\r\n                  <option value=\"90d\">√öltimos 90 d√≠as</option>\r\n                </select>\r\n              </div>\r\n              {chartData && (\r\n                <DashboardChart\r\n                  type=\"line\"\r\n                  data={chartData}\r\n                  height={300}\r\n                />\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Pie Chart */}\r\n          <div>\r\n            <div className=\"bg-white rounded-xl shadow-lg border border-gray-200 p-6\">\r\n              <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Distribuci√≥n de Recursos</h3>\r\n              {pieData && (\r\n                <DashboardChart\r\n                  type=\"doughnut\"\r\n                  data={pieData}\r\n                  height={300}\r\n                />\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Radar Chart and AI Recommendations */}\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n          {/* Radar Chart */}\r\n          <div>\r\n            <div className=\"bg-white rounded-xl shadow-lg border border-gray-200 p-6\">\r\n              <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">An√°lisis Comparativo</h3>\r\n              {radarData && (\r\n                <DashboardChart\r\n                  type=\"radar\"\r\n                  data={radarData}\r\n                  height={350}\r\n                />\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {/* AI Recommendations */}\r\n          <div>\r\n            <AIRecommendations\r\n              dashboardStats={dashboardStats}\r\n              onRecommendationClick={handleRecommendationClick}\r\n            />\r\n          </div>\r\n        </div>\r\n\r\n        {/* Predictions Summary */}\r\n        {predictions && (\r\n          <motion.div\r\n            initial={{ opacity: 0, y: 20 }}\r\n            animate={{ opacity: 1, y: 0 }}\r\n            transition={{ duration: 0.5, delay: 0.6 }}\r\n            className=\"mt-8 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border border-blue-200 p-6\"\r\n          >\r\n            <div className=\"flex items-center mb-4\">\r\n              <SparklesIcon className=\"w-6 h-6 text-blue-600 mr-2\" />\r\n              <h3 className=\"text-lg font-semibold text-gray-900\">Pron√≥sticos Inteligentes</h3>\r\n            </div>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4\">\r\n              <div className=\"bg-white rounded-lg p-4\">\r\n                <p className=\"text-sm text-gray-600\">Carpetas pr√≥ximas</p>\r\n                <p className=\"text-xl font-bold text-blue-600\">\r\n                  {(predictions.nextMonth?.folders || 0).toLocaleString()}\r\n                </p>\r\n              </div>\r\n              <div className=\"bg-white rounded-lg p-4\">\r\n                <p className=\"text-sm text-gray-600\">Documentos pr√≥ximas</p>\r\n                <p className=\"text-xl font-bold text-green-600\">\r\n                  {(predictions.nextMonth?.documents || 0).toLocaleString()}\r\n                </p>\r\n              </div>\r\n              <div className=\"bg-white rounded-lg p-4\">\r\n                <p className=\"text-sm text-gray-600\">Tokens pr√≥ximas</p>\r\n                <p className=\"text-xl font-bold text-orange-600\">\r\n                  {(predictions.nextMonth?.tokens || 0).toLocaleString()}\r\n                </p>\r\n              </div>\r\n              <div className=\"bg-white rounded-lg p-4\">\r\n                <p className=\"text-sm text-gray-600\">Almacenamiento pr√≥ximas</p>\r\n                <p className=\"text-xl font-bold text-purple-600\">\r\n                  {(predictions.nextMonth?.storage || 0).toLocaleString()} MB\r\n                </p>\r\n              </div>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              {predictions.insights && Array.isArray(predictions.insights) && predictions.insights.map((insight, index) => (\r\n                <div key={index} className=\"flex items-center text-sm text-gray-700\">\r\n                  <ChartBarIcon className=\"w-4 h-4 text-blue-500 mr-2\" />\r\n                  {insight}\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </motion.div>\r\n        )}\r\n      </motion.div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ModernAIEnhancedDashboard;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\dashboard\\ModernDashboardRedesigned.js","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadDashboardData'. Either include it or remove the dependency array.","line":335,"column":6,"nodeType":"ArrayExpression","endLine":335,"endColumn":25,"suggestions":[{"desc":"Update the dependencies array to be: [loadDashboardData, user, userProfile]","fix":{"range":[11021,11040],"text":"[loadDashboardData, user, userProfile]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\dashboard\\SimulatedCompanySummary.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\debug\\ProductionDatabaseDebugger.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\debug\\ProductionEnvChecker.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\embeddings\\AIChat.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'LoadingSpinner' is defined but never used.","line":6,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'ExclamationTriangleIcon' is defined but never used.","line":15,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":26},{"ruleId":"no-unused-vars","severity":1,"message":"'BuildingOfficeIcon' is defined but never used.","line":17,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":21},{"ruleId":"no-unused-vars","severity":1,"message":"'XMarkIcon' is defined but never used.","line":18,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":12}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useRef, useEffect } from 'react'\r\nimport { useAuth } from '../../contexts/AuthContext.js'\r\nimport embeddingsService from '../../lib/embeddings.js'\r\nimport groqService from '../../services/groqService.js'\r\nimport organizedDatabaseService from '../../services/organizedDatabaseService.js'\r\nimport LoadingSpinner from '../common/LoadingSpinner.js'\r\nimport SubtleSpinner from '../common/SubtleSpinner.js'\r\nimport {\r\n  ChatBubbleLeftRightIcon,\r\n  PaperAirplaneIcon,\r\n  SparklesIcon,\r\n  DocumentIcon,\r\n  UserIcon,\r\n  CpuChipIcon,\r\n  ExclamationTriangleIcon,\r\n  FunnelIcon,\r\n  BuildingOfficeIcon,\r\n  XMarkIcon\r\n} from '@heroicons/react/24/outline'\r\nimport toast from 'react-hot-toast'\r\n\r\nconst AIChat = () => {\r\n  const { user } = useAuth()\r\n  const [messages, setMessages] = useState([])\r\n  const [inputMessage, setInputMessage] = useState('')\r\n  const [loading, setLoading] = useState(false)\r\n  const [isTyping, setIsTyping] = useState(false)\r\n  const messagesEndRef = useRef(null)\r\n  const inputRef = useRef(null)\r\n\r\n  // Estado para filtros avanzados\r\n  const [showFilters, setShowFilters] = useState(false)\r\n  const [companies, setCompanies] = useState([])\r\n  const [filters, setFilters] = useState({\r\n    company: '',\r\n    file_type: '',\r\n    date_from: '',\r\n    date_to: '',\r\n    user_email: '',\r\n    file_name: '',\r\n    min_file_size: '',\r\n    max_file_size: '',\r\n    keywords: '',\r\n    min_relevance: '0.1'\r\n  })\r\n\r\n  const scrollToBottom = () => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })\r\n  }\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\r\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\r\nuseEffect(() => {\r\n    scrollToBottom()\r\n  }, [messages, isTyping])\r\n\r\n  // Cargar empresas al montar el componente\r\n  useEffect(() => {\r\n    const loadCompanies = async () => {\r\n      try {\r\n        const companyData = await organizedDatabaseService.getCompanies()\r\n        setCompanies(companyData)\r\n      } catch (error) {\r\n        console.error('Error loading companies:', error)\r\n      }\r\n    }\r\n\r\n    loadCompanies()\r\n  }, [])\r\n\r\n  const handleSendMessage = async (e) => {\r\n    e.preventDefault()\r\n    \r\n    if (!inputMessage.trim() || loading) {\r\n      return\r\n    }\r\n\r\n    const userMessage = inputMessage.trim()\r\n    setInputMessage('')\r\n    setLoading(true)\r\n    setIsTyping(true)\r\n\r\n    // Agregar mensaje del usuario\r\n    const newUserMessage = {\r\n      id: Date.now(),\r\n      role: 'user',\r\n      content: userMessage,\r\n      timestamp: new Date()\r\n    }\r\n    setMessages(prev => [...prev, newUserMessage])\r\n\r\n    try {\r\n      // Buscar contenido relevante usando embeddings con filtros aplicados\r\n      const searchResults = await embeddingsService.searchSimilarContent(userMessage, user.id, 5, filters)\r\n      \r\n      // Preparar contexto de documentos\r\n      const context = searchResults?.map(result => ({\r\n        content: result.content,\r\n        file_name: result.file_name,\r\n        similarity: result.similarity\r\n      })) || []\r\n\r\n      // Preparar historial de chat (√∫ltimos 6 mensajes para contexto)\r\n      const chatHistory = messages.slice(-6).map(msg => ({\r\n        role: msg.role,\r\n        content: msg.content\r\n      }))\r\n\r\n      // Generar respuesta con GROQ\r\n      const groqResult = await groqService.generateChatResponse(\r\n        userMessage,\r\n        context,\r\n        chatHistory,\r\n        user.id // Pasar userId para tracking de tokens\r\n      )\r\n\r\n      // Agregar respuesta de la IA\r\n      const aiMessage = {\r\n        id: Date.now() + 1,\r\n        role: 'assistant',\r\n        content: groqResult.response,\r\n        timestamp: new Date(),\r\n        context: context.length > 0 ? context : null,\r\n        searchResults: searchResults?.length || 0,\r\n        tokensUsed: groqResult.tokensUsed\r\n      }\r\n      \r\n      setMessages(prev => [...prev, aiMessage])\r\n      \r\n      if (context.length > 0) {\r\n        toast.success(`Respuesta generada usando ${context.length} documentos relevantes (${groqResult.tokensUsed} tokens)`)\r\n      } else {\r\n        toast.success(`Respuesta generada (${groqResult.tokensUsed} tokens utilizados)`)\r\n      }\r\n    } catch (error) {\r\n      console.error('Error in AI chat:', error)\r\n      toast.error('Error al generar respuesta: ' + error.message)\r\n      \r\n      // Agregar mensaje de error\r\n      const errorMessage = {\r\n        id: Date.now() + 1,\r\n        role: 'assistant',\r\n        content: 'Lo siento, ocurri√≥ un error al procesar tu mensaje. Por favor intenta nuevamente.',\r\n        timestamp: new Date(),\r\n        isError: true\r\n      }\r\n      setMessages(prev => [...prev, errorMessage])\r\n    } finally {\r\n      setLoading(false)\r\n      setIsTyping(false)\r\n      inputRef.current?.focus()\r\n    }\r\n  }\r\n\r\n  const clearChat = () => {\r\n    setMessages([])\r\n    toast.success('Chat limpiado')\r\n  }\r\n\r\n  const handleFilterChange = (filterName, value) => {\r\n    setFilters(prev => ({\r\n      ...prev,\r\n      [filterName]: value\r\n    }))\r\n  }\r\n\r\n  const clearFilters = () => {\r\n    setFilters({\r\n      company: '',\r\n      file_type: '',\r\n      date_from: '',\r\n      date_to: '',\r\n      user_email: '',\r\n      file_name: '',\r\n      min_file_size: '',\r\n      max_file_size: '',\r\n      keywords: '',\r\n      min_relevance: '0.1'\r\n    })\r\n    toast.success('Filtros limpiados')\r\n  }\r\n\r\n  const toggleFilters = () => {\r\n    setShowFilters(!showFilters)\r\n  }\r\n\r\n  const formatTimestamp = (timestamp) => {\r\n    return new Intl.DateTimeFormat('es-ES', {\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    }).format(timestamp)\r\n  }\r\n\r\n  return (\r\n    <div className=\"max-w-4xl mx-auto p-6\">\r\n      {/* Header */}\r\n      <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 mb-6\">\r\n        <div className=\"p-6 border-b border-gray-200\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center space-x-3\">\r\n              <div className=\"p-2 bg-blue-100 rounded-lg\">\r\n                <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-blue-600\" />\r\n              </div>\r\n              <div>\r\n                <h1 className=\"text-2xl font-bold text-gray-900\">Chat IA</h1>\r\n                <p className=\"text-gray-600\">Conversa con tus documentos usando inteligencia artificial</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex items-center space-x-3\">\r\n              <button\r\n                onClick={toggleFilters}\r\n                className={`px-4 py-2 text-sm font-medium rounded-lg transition-colors flex items-center space-x-2 ${\r\n                  showFilters\r\n                    ? 'bg-blue-600 text-white'\r\n                    : 'text-gray-700 bg-gray-100 hover:bg-gray-200'\r\n                }`}\r\n              >\r\n                <FunnelIcon className=\"h-4 w-4\" />\r\n                <span>Filtros</span>\r\n              </button>\r\n              {messages.length > 0 && (\r\n                <button\r\n                  onClick={clearChat}\r\n                  className=\"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors\"\r\n                >\r\n                  Limpiar Chat\r\n                </button>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Filtros Expandidos */}\r\n        {showFilters && (\r\n          <div className=\"p-6 border-b border-gray-200 bg-gray-50\">\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <h3 className=\"text-lg font-medium text-gray-900\">Filtros Avanzados</h3>\r\n              <button\r\n                onClick={clearFilters}\r\n                className=\"px-3 py-1 text-sm font-medium text-gray-600 hover:text-gray-800 transition-colors\"\r\n              >\r\n                Limpiar todos\r\n              </button>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Empresa</label>\r\n                <select\r\n                  value={filters.company}\r\n                  onChange={(e) => handleFilterChange('company', e.target.value)}\r\n                  className=\"w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm\"\r\n                >\r\n                  <option value=\"\">Todas las empresas</option>\r\n                  {companies.map((company) => (\r\n                    <option key={company.id} value={company.name}>\r\n                      {company.name}\r\n                    </option>\r\n                  ))}\r\n                </select>\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Tipo de Archivo</label>\r\n                <select\r\n                  value={filters.file_type}\r\n                  onChange={(e) => handleFilterChange('file_type', e.target.value)}\r\n                  className=\"w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm\"\r\n                >\r\n                  <option value=\"\">Todos los tipos</option>\r\n                  <option value=\"application/pdf\">PDF</option>\r\n                  <option value=\"application/vnd.openxmlformats-officedocument.wordprocessingml.document\">Word</option>\r\n                  <option value=\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\">Excel</option>\r\n                  <option value=\"text/plain\">Texto</option>\r\n                </select>\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Usuario</label>\r\n                <input\r\n                  type=\"email\"\r\n                  value={filters.user_email}\r\n                  onChange={(e) => handleFilterChange('user_email', e.target.value)}\r\n                  placeholder=\"correo@empresa.com\"\r\n                  className=\"w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm\"\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Nombre Archivo</label>\r\n                <input\r\n                  type=\"text\"\r\n                  value={filters.file_name}\r\n                  onChange={(e) => handleFilterChange('file_name', e.target.value)}\r\n                  placeholder=\"Buscar en nombres...\"\r\n                  className=\"w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm\"\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Fecha Desde</label>\r\n                <input\r\n                  type=\"date\"\r\n                  value={filters.date_from}\r\n                  onChange={(e) => handleFilterChange('date_from', e.target.value)}\r\n                  className=\"w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm\"\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Fecha Hasta</label>\r\n                <input\r\n                  type=\"date\"\r\n                  value={filters.date_to}\r\n                  onChange={(e) => handleFilterChange('date_to', e.target.value)}\r\n                  className=\"w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm\"\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Tama√±o M√≠n (KB)</label>\r\n                <input\r\n                  type=\"number\"\r\n                  value={filters.min_file_size}\r\n                  onChange={(e) => handleFilterChange('min_file_size', e.target.value)}\r\n                  placeholder=\"0\"\r\n                  min=\"0\"\r\n                  className=\"w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm\"\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Tama√±o M√°x (KB)</label>\r\n                <input\r\n                  type=\"number\"\r\n                  value={filters.max_file_size}\r\n                  onChange={(e) => handleFilterChange('max_file_size', e.target.value)}\r\n                  placeholder=\"Sin l√≠mite\"\r\n                  min=\"0\"\r\n                  className=\"w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm\"\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Palabras Clave</label>\r\n                <input\r\n                  type=\"text\"\r\n                  value={filters.keywords}\r\n                  onChange={(e) => handleFilterChange('keywords', e.target.value)}\r\n                  placeholder=\"t√©rminos separados por coma\"\r\n                  className=\"w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm\"\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">Relevancia M√≠n (%)</label>\r\n                <input\r\n                  type=\"range\"\r\n                  min=\"0\"\r\n                  max=\"1\"\r\n                  step=\"0.1\"\r\n                  value={filters.min_relevance}\r\n                  onChange={(e) => handleFilterChange('min_relevance', e.target.value)}\r\n                  className=\"w-full\"\r\n                />\r\n                <div className=\"text-xs text-gray-500 mt-1\">\r\n                  {(parseFloat(filters.min_relevance) * 100).toFixed(0)}%\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"mt-4 text-sm text-gray-600\">\r\n              <p>üí° Los filtros se aplican autom√°ticamente a las b√∫squedas de documentos para el contexto del chat.</p>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Chat Container */}\r\n      <div className=\"bg-white rounded-lg shadow-sm border border-gray-200\">\r\n        {/* Messages Area */}\r\n        <div className=\"h-96 overflow-y-auto p-4 space-y-4\">\r\n          {messages.length === 0 ? (\r\n            <div className=\"flex flex-col items-center justify-center h-full text-center\">\r\n              <div className=\"p-4 bg-blue-50 rounded-full mb-4\">\r\n                <SparklesIcon className=\"h-8 w-8 text-blue-600\" />\r\n              </div>\r\n              <h3 className=\"text-lg font-medium text-gray-900 mb-2\">\r\n                ¬°Hola! Soy tu asistente IA\r\n              </h3>\r\n              <p className=\"text-gray-600 max-w-md\">\r\n                Puedes hacerme preguntas sobre tus documentos. Buscar√© informaci√≥n relevante y te dar√© respuestas precisas.\r\n              </p>\r\n              <div className=\"mt-4 text-sm text-gray-500\">\r\n                <p>üí° Ejemplos de preguntas:</p>\r\n                <ul className=\"mt-2 space-y-1\">\r\n                  <li>‚Ä¢ \"¬øQu√© dice el documento sobre...?\"</li>\r\n                  <li>‚Ä¢ \"Resume los puntos principales\"</li>\r\n                  <li>‚Ä¢ \"Busca informaci√≥n sobre...\"</li>\r\n                </ul>\r\n              </div>\r\n            </div>\r\n          ) : (\r\n            messages.map((message) => (\r\n              <div\r\n                key={message.id}\r\n                className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}\r\n              >\r\n                <div className={`max-w-3xl ${message.role === 'user' ? 'order-2' : 'order-1'}`}>\r\n                  <div className=\"flex items-start space-x-3\">\r\n                    {message.role === 'assistant' && (\r\n                      <div className=\"flex-shrink-0\">\r\n                        <div className=\"p-2 bg-blue-100 rounded-full\">\r\n                          <CpuChipIcon className=\"h-4 w-4 text-blue-600\" />\r\n                        </div>\r\n                      </div>\r\n                    )}\r\n                    \r\n                    <div className={`flex-1 ${message.role === 'user' ? 'text-right' : ''}`}>\r\n                      <div\r\n                        className={`inline-block p-3 rounded-lg ${\r\n                          message.role === 'user'\r\n                            ? 'bg-blue-600 text-white'\r\n                            : message.isError\r\n                            ? 'bg-red-50 text-red-800 border border-red-200'\r\n                            : 'bg-gray-100 text-gray-900'\r\n                        }`}\r\n                      >\r\n                        <p className=\"whitespace-pre-wrap\">{message.content}</p>\r\n                      </div>\r\n                      \r\n                      {/* Context info for AI messages */}\r\n                      {message.role === 'assistant' && (\r\n                        <div className=\"mt-2 text-xs text-gray-500 space-y-1\">\r\n                          {message.context && message.context.length > 0 && (\r\n                            <div className=\"flex items-center space-x-1\">\r\n                              <DocumentIcon className=\"h-3 w-3\" />\r\n                              <span>Basado en {message.context.length} documento(s) relevante(s)</span>\r\n                            </div>\r\n                          )}\r\n                          {message.tokensUsed && (\r\n                            <div className=\"flex items-center space-x-1\">\r\n                              <CpuChipIcon className=\"h-3 w-3\" />\r\n                              <span>{message.tokensUsed} tokens utilizados</span>\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                      )}\r\n                      \r\n                      <div className=\"mt-1 text-xs text-gray-500\">\r\n                        {formatTimestamp(message.timestamp)}\r\n                      </div>\r\n                    </div>\r\n                    \r\n                    {message.role === 'user' && (\r\n                      <div className=\"flex-shrink-0\">\r\n                        <div className=\"p-2 bg-blue-600 rounded-full\">\r\n                          <UserIcon className=\"h-4 w-4 text-white\" />\r\n                        </div>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            ))\r\n          )}\r\n          \r\n          {/* Typing indicator */}\r\n          {isTyping && (\r\n            <div className=\"flex justify-start\">\r\n              <div className=\"flex items-start space-x-3\">\r\n                <div className=\"p-2 bg-blue-100 rounded-full\">\r\n                  <CpuChipIcon className=\"h-4 w-4 text-blue-600\" />\r\n                </div>\r\n                <div className=\"bg-gray-100 rounded-lg p-3\">\r\n                  <div className=\"flex space-x-1\">\r\n                    <div className=\"w-2 h-2 bg-gray-400 rounded-full animate-bounce\"></div>\r\n                    <div className=\"w-2 h-2 bg-gray-400 rounded-full animate-bounce\" style={{ animationDelay: '0.1s' }}></div>\r\n                    <div className=\"w-2 h-2 bg-gray-400 rounded-full animate-bounce\" style={{ animationDelay: '0.2s' }}></div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n          \r\n          <div ref={messagesEndRef} />\r\n        </div>\r\n\r\n        {/* Input Area */}\r\n        <div className=\"border-t border-gray-200 p-4\">\r\n          <form onSubmit={handleSendMessage} className=\"flex space-x-3\">\r\n            <div className=\"flex-1\">\r\n              <input\r\n                ref={inputRef}\r\n                type=\"text\"\r\n                value={inputMessage}\r\n                onChange={(e) => setInputMessage(e.target.value)}\r\n                placeholder=\"Escribe tu pregunta aqu√≠...\"\r\n                disabled={loading}\r\n                className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                autoFocus\r\n              />\r\n            </div>\r\n            <button\r\n              type=\"submit\"\r\n              disabled={loading || !inputMessage.trim()}\r\n              className=\"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center space-x-2\"\r\n            >\r\n              {loading ? (\r\n                <SubtleSpinner size=\"sm\" />\r\n              ) : (\r\n                <PaperAirplaneIcon className=\"h-5 w-5\" />\r\n              )}\r\n              <span className=\"hidden sm:inline\">Enviar</span>\r\n            </button>\r\n          </form>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Info Panel */}\r\n      <div className=\"mt-6 bg-blue-50 rounded-lg p-4\">\r\n        <div className=\"flex items-start space-x-3\">\r\n          <SparklesIcon className=\"h-5 w-5 text-blue-600 mt-0.5 flex-shrink-0\" />\r\n          <div className=\"text-sm text-blue-800\">\r\n            <p className=\"font-medium mb-1\">¬øC√≥mo funciona el Chat IA?</p>\r\n            <ul className=\"space-y-1 text-blue-700\">\r\n              <li>‚Ä¢ Busca autom√°ticamente en tus documentos informaci√≥n relevante</li>\r\n              <li>‚Ä¢ Usa IA avanzada (GROQ GEMMA 2-9b-it) para generar respuestas precisas</li>\r\n              <li>‚Ä¢ Mantiene el contexto de la conversaci√≥n para respuestas coherentes</li>\r\n              <li>‚Ä¢ Te indica qu√© documentos us√≥ para generar cada respuesta</li>\r\n            </ul>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default AIChat","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\embeddings\\SemanticSearch.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'LoadingSpinner' is defined but never used.","line":5,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'FunnelIcon' is defined but never used.","line":16,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":13},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'selectedCompany'. Either include it or remove the dependency array.","line":47,"column":6,"nodeType":"ArrayExpression","endLine":47,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [selectedCompany]","fix":{"range":[1735,1737],"text":"[selectedCompany]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useAuth } from '../../contexts/AuthContext.js';\r\nimport embeddingsService from '../../lib/embeddings.js';\r\nimport organizedDatabaseService from '../../services/organizedDatabaseService.js';\r\nimport LoadingSpinner from '../common/LoadingSpinner.js';\r\nimport SubtleSpinner from '../common/SubtleSpinner.js';\r\nimport AIChat from './AIChat.js';\r\nimport {\r\n  MagnifyingGlassIcon,\r\n  DocumentIcon,\r\n  SparklesIcon,\r\n  ExclamationTriangleIcon,\r\n  ChatBubbleLeftRightIcon,\r\n  ArrowDownTrayIcon,\r\n  BuildingOfficeIcon,\r\n  FunnelIcon\r\n} from '@heroicons/react/24/outline';\r\nimport { toast } from 'react-hot-toast';\r\n\r\nconst SemanticSearch = () => {\r\n  const { user } = useAuth();\r\n  const [activeTab, setActiveTab] = useState('search'); // 'search' o 'chat'\r\n  const [query, setQuery] = useState('');\r\n  const [results, setResults] = useState([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [hasSearched, setHasSearched] = useState(false);\r\n  const [companies, setCompanies] = useState([]);\r\n  const [selectedCompany, setSelectedCompany] = useState('');\r\n  const [expandedResults, setExpandedResults] = useState(new Set());\r\n\r\n  // Cargar empresas al montar el componente\r\n  useEffect(() => {\r\n    const loadCompanies = async () => {\r\n      try {\r\n        const companyData = await organizedDatabaseService.getCompanies();\r\n        setCompanies(companyData);\r\n        // Seleccionar la primera empresa por defecto\r\n        if (companyData.length > 0 && !selectedCompany) {\r\n          setSelectedCompany(companyData[0].name);\r\n        }\r\n      } catch (error) {\r\n        console.error('Error loading companies:', error);\r\n      }\r\n    };\r\n\r\n    loadCompanies();\r\n  }, []);\r\n\r\n  const toggleExpansion = (resultId) => {\r\n    setExpandedResults(prev => {\r\n      const newSet = new Set(prev);\r\n      if (newSet.has(resultId)) {\r\n        newSet.delete(resultId);\r\n      } else {\r\n        newSet.add(resultId);\r\n      }\r\n      return newSet;\r\n    });\r\n  };\r\n\r\n  const handleSearch = async (e) => {\r\n    e.preventDefault();\r\n\r\n    if (!query.trim()) {\r\n      toast.error('Por favor ingresa una consulta de b√∫squeda');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setLoading(true);\r\n      setHasSearched(true);\r\n\r\n      const searchResults = await embeddingsService.searchSimilarContent(query, user.id, 10, { company: selectedCompany });\r\n      setResults(searchResults || []);\r\n\r\n      if (searchResults && searchResults.length > 0) {\r\n        toast.success(`Se encontraron ${searchResults.length} resultados`);\r\n      } else {\r\n        toast.info('No se encontraron resultados para tu b√∫squeda');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error in semantic search:', error);\r\n      toast.error('Error al realizar la b√∫squeda sem√°ntica');\r\n      setResults([]);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const highlightText = (text, query) => {\r\n    if (!query) return text;\r\n    \r\n    const words = query.toLowerCase().split(' ');\r\n    let highlightedText = text;\r\n    \r\n    words.forEach(word => {\r\n      if (word.length > 2) {\r\n        const regex = new RegExp(`(${word})`, 'gi');\r\n        highlightedText = highlightedText.replace(regex, '<mark class=\"bg-yellow-200\">$1</mark>');\r\n      }\r\n    });\r\n    \r\n    return highlightedText;\r\n  };\r\n\r\n  const truncateText = (text, maxLength = 200) => {\r\n    if (text.length <= maxLength) return text;\r\n    return text.substring(0, maxLength) + '...';\r\n  };\r\n\r\n  return (\r\n    <div className=\"max-w-4xl mx-auto p-6\">\r\n      <div className=\"bg-white rounded-lg shadow-lg\">\r\n        {/* Pesta√±as */}\r\n        <div className=\"flex border-b border-gray-200\">\r\n          <button\r\n            onClick={() => setActiveTab('search')}\r\n            className={`flex items-center gap-2 px-4 py-2 font-medium text-sm border-b-2 transition-colors ${\r\n              activeTab === 'search'\r\n                ? 'border-purple-600 text-purple-600'\r\n                : 'border-transparent text-gray-500 hover:text-gray-700'\r\n            }`}\r\n          >\r\n            <MagnifyingGlassIcon className=\"h-5 w-5\" />\r\n            B√∫squeda Sem√°ntica\r\n          </button>\r\n          <button\r\n            onClick={() => setActiveTab('chat')}\r\n            className={`flex items-center gap-2 px-4 py-2 font-medium text-sm border-b-2 transition-colors ${\r\n              activeTab === 'chat'\r\n                ? 'border-purple-600 text-purple-600'\r\n                : 'border-transparent text-gray-500 hover:text-gray-700'\r\n            }`}\r\n          >\r\n            <ChatBubbleLeftRightIcon className=\"h-5 w-5\" />\r\n            Chat IA\r\n          </button>\r\n        </div>\r\n\r\n        {/* Contenido de la pesta√±a activa */}\r\n        {activeTab === 'search' ? (\r\n          <div>\r\n            {/* Header */}\r\n            <div className=\"p-6 border-b border-gray-200\">\r\n              <div className=\"flex items-center mb-2\">\r\n                <SparklesIcon className=\"h-6 w-6 text-blue-600 mr-2\" />\r\n                <h2 className=\"text-2xl font-bold text-gray-900\">B√∫squeda Sem√°ntica</h2>\r\n              </div>\r\n              <p className=\"text-gray-600\">\r\n                Busca contenido en tus archivos usando inteligencia artificial. \r\n                Encuentra informaci√≥n relevante incluso si no coinciden las palabras exactas.\r\n              </p>\r\n            </div>\r\n\r\n            {/* Search Form */}\r\n            <div className=\"p-6\">\r\n           <form onSubmit={handleSearch} className=\"space-y-4\">\r\n             <div className=\"relative\">\r\n               <div className=\"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none\">\r\n                 <MagnifyingGlassIcon className=\"h-5 w-5 text-gray-400\" />\r\n               </div>\r\n               <input\r\n                 type=\"text\"\r\n                 value={query}\r\n                 onChange={(e) => setQuery(e.target.value)}\r\n                 placeholder=\"Describe lo que est√°s buscando... (ej: 'Reglamento interno')\"\r\n                 className=\"block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg\"\r\n                 disabled={loading}\r\n               />\r\n             </div>\r\n\r\n             {/* Company Filter */}\r\n             <div className=\"relative\">\r\n               <div className=\"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none\">\r\n                 <BuildingOfficeIcon className=\"h-5 w-5 text-gray-400\" />\r\n               </div>\r\n               <select\r\n                 value={selectedCompany}\r\n                 onChange={(e) => setSelectedCompany(e.target.value)}\r\n                 className=\"block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white\"\r\n                 disabled={loading}\r\n               >\r\n                 {companies\r\n                   .sort((a, b) => a.name.localeCompare(b.name))\r\n                   .map((company) => (\r\n                     <option key={company.id} value={company.name}>\r\n                       {company.name}\r\n                     </option>\r\n                   ))}\r\n               </select>\r\n             </div>\r\n            \r\n            <button\r\n              type=\"submit\"\r\n              disabled={loading || !query.trim()}\r\n              className=\"w-full flex items-center justify-center px-4 py-3 border border-transparent text-lg font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\r\n            >\r\n              {loading ? (\r\n                <>\r\n                  <SubtleSpinner size=\"sm\" />\r\n                  <span className=\"ml-2\">Buscando...</span>\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <MagnifyingGlassIcon className=\"h-5 w-5 mr-2\" />\r\n                  Buscar con IA\r\n                </>\r\n              )}\r\n            </button>\r\n          </form>\r\n        </div>\r\n\r\n        {/* Results */}\r\n        {hasSearched && (\r\n          <div className=\"border-t border-gray-200\">\r\n            {loading ? (\r\n              <div className=\"p-6 flex justify-center\">\r\n                <SubtleSpinner size=\"md\" text=\"Analizando contenido...\" />\r\n              </div>\r\n            ) : results.length > 0 ? (\r\n              <div className=\"p-6\">\r\n                <h3 className=\"text-lg font-medium text-gray-900 mb-4\">\r\n                  Resultados encontrados ({results.length})\r\n                </h3>\r\n                \r\n                <div className=\"space-y-4\">\r\n                  {results.map((result, index) => (\r\n                    <div key={result.id || index} className=\"border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow bg-white cursor-pointer\" onClick={() => toggleExpansion(result.id || index)}>\r\n                      <div className=\"flex items-start space-x-3\">\r\n                        <DocumentIcon className=\"h-5 w-5 text-blue-600 mt-1 flex-shrink-0\" />\r\n\r\n                        <div className=\"flex-1 min-w-0\">\r\n                          <div className=\"flex items-center justify-between mb-2\">\r\n                            <h4 className=\"text-sm font-medium text-gray-900 truncate\">\r\n                              {result.metadata?.name || result.metadata?.file_name || `Documento ${result.id}`}\r\n                            </h4>\r\n                            <div className=\"flex items-center space-x-2\">\r\n                              {result.metadata?.file_id && (\r\n                                <button\r\n                                  onClick={(e) => {\r\n                                    e.stopPropagation(); // Prevent card click\r\n                                    if (result.metadata.file_id) {\r\n                                      window.open(`https://drive.google.com/file/d/${result.metadata.file_id}/view`, '_blank');\r\n                                    }\r\n                                  }}\r\n                                  className=\"p-1 text-gray-400 hover:text-blue-600 transition-colors\"\r\n                                  title=\"Ver documento original\"\r\n                                >\r\n                                  <ArrowDownTrayIcon className=\"h-4 w-4\" />\r\n                                </button>\r\n                              )}\r\n                              <span className=\"text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded\">\r\n                                Relevancia: {(result.similarity * 100).toFixed(1)}%\r\n                              </span>\r\n                            </div>\r\n                          </div>\r\n\r\n                          <div className=\"text-sm text-gray-700 mb-2\">\r\n                            <div\r\n                              className=\"leading-relaxed\"\r\n                              dangerouslySetInnerHTML={{\r\n                                __html: highlightText(expandedResults.has(result.id || index) ? (result.content || 'Contenido no disponible') : truncateText(result.content || 'Contenido no disponible'), query)\r\n                              }}\r\n                            />\r\n                          </div>\r\n\r\n                          <div className=\"flex items-center justify-between text-xs text-gray-500\">\r\n                            <div className=\"flex items-center space-x-4\">\r\n                              <span className=\"bg-gray-50 px-2 py-1 rounded\">ID: {result.id}</span>\r\n                              {result.created_at && (\r\n                                <span className=\"flex items-center\">\r\n                                  üìÖ {new Date(result.created_at).toLocaleDateString('es-ES')}\r\n                                </span>\r\n                              )}\r\n                              {result.metadata?.correo && (\r\n                                <span className=\"flex items-center\">\r\n                                  üë§ {result.metadata.correo}\r\n                                </span>\r\n                              )}\r\n                            </div>\r\n                            {result.metadata?.file_type && (\r\n                              <span className=\"bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs\">\r\n                                {result.metadata.file_type.split('/').pop().toUpperCase()}\r\n                              </span>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            ) : (\r\n              <div className=\"p-8 text-center\">\r\n                <ExclamationTriangleIcon className=\"h-12 w-12 text-gray-400 mx-auto mb-4\" />\r\n                <h3 className=\"text-lg font-medium text-gray-900 mb-2\">\r\n                  No se encontraron resultados\r\n                </h3>\r\n                <p className=\"text-gray-600 mb-4\">\r\n                  No se encontr√≥ contenido relacionado con tu b√∫squeda.\r\n                </p>\r\n                <div className=\"text-sm text-gray-500 space-y-1\">\r\n                  <p>‚Ä¢ Intenta con t√©rminos m√°s generales</p>\r\n                  <p>‚Ä¢ Verifica que tengas archivos procesados</p>\r\n                  <p>‚Ä¢ Aseg√∫rate de que los archivos contengan texto</p>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n            {/* Info */}\r\n            {!hasSearched && (\r\n              <div className=\"p-6 bg-blue-50 border-t border-gray-200\">\r\n                <div className=\"flex items-start space-x-3\">\r\n                  <SparklesIcon className=\"h-5 w-5 text-blue-600 mt-0.5 flex-shrink-0\" />\r\n                  <div className=\"text-sm text-blue-800\">\r\n                    <p className=\"font-medium mb-1\">¬øC√≥mo funciona la b√∫squeda sem√°ntica?</p>\r\n                    <ul className=\"space-y-1 text-blue-700\">\r\n                      <li>‚Ä¢ Utiliza IA para entender el significado de tu consulta</li>\r\n                      <li>‚Ä¢ Encuentra contenido relevante aunque no coincidan las palabras exactas</li>\r\n                      <li>‚Ä¢ Busca en todos tus archivos procesados autom√°ticamente</li>\r\n                      <li>‚Ä¢ Ordena los resultados por relevancia sem√°ntica</li>\r\n                    </ul>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        ) : (\r\n          <AIChat />\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default SemanticSearch;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\embeddings\\TokenUsage.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadTokenData'. Either include it or remove the dependency array.","line":72,"column":6,"nodeType":"ArrayExpression","endLine":72,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [loadTokenData, user]","fix":{"range":[2030,2036],"text":"[loadTokenData, user]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef, useCallback } from 'react';\r\nimport { useAuth } from '../../contexts/AuthContext.js';\r\nimport embeddingsService from '../../lib/embeddings.js';\r\nimport {\r\n  ChartBarIcon,\r\n  CpuChipIcon,\r\n  ExclamationTriangleIcon,\r\n  CheckCircleIcon\r\n} from '@heroicons/react/24/outline';\r\n\r\nconst TokenUsage = () => {\r\n  const { user } = useAuth();\r\n  const [tokenStats, setTokenStats] = useState(null);\r\n  const [tokenLimits, setTokenLimits] = useState(null);\r\n  const [error, setError] = useState(null);\r\n  const loadingRef = useRef(false);\r\n\r\n  const loadTokenData = useCallback(async () => {\r\n    if (loadingRef.current) {\r\n      return; // Evitar m√∫ltiples llamadas simult√°neas\r\n    }\r\n    \r\n    try {\r\n      loadingRef.current = true;\r\n      setError(null);\r\n      \r\n      const [stats, limits] = await Promise.all([\r\n        embeddingsService.getTokenUsageStats(user.id),\r\n        embeddingsService.checkTokenLimits(user.id)\r\n      ]);\r\n\r\n      setTokenStats(stats || {\r\n        total_tokens: 0,\r\n        by_operation: {},\r\n        records: []\r\n      });\r\n      setTokenLimits(limits || {\r\n        tokens_used: 0,\r\n        token_limit: 1000,\r\n        remaining_tokens: 1000,\r\n        usage_percentage: 0\r\n      });\r\n    } catch (err) {\r\n      console.error('TokenUsage: Error loading token data:', err);\r\n      setError('Error al cargar datos de tokens');\r\n      \r\n      // Establecer datos por defecto en caso de error\r\n      setTokenStats({\r\n        total_tokens: 0,\r\n        by_operation: {},\r\n        records: []\r\n      });\r\n      setTokenLimits({\r\n        tokens_used: 0,\r\n        token_limit: 1000,\r\n        remaining_tokens: 1000,\r\n        usage_percentage: 0\r\n      });\r\n    } finally {\r\n      loadingRef.current = false;\r\n    }\r\n  }, [user]);\r\n\r\n  useEffect(() => {\r\n    if (user && !loadingRef.current) {\r\n      loadTokenData();\r\n    } else if (!user) {\r\n      // Si no hay usuario, establecer estado por defecto\r\n      setTokenStats(null);\r\n      setTokenLimits(null);\r\n    }\r\n  }, [user]); // Removida dependencia loadTokenData para evitar loop infinito\r\n\r\n  const getUsageColor = (percentage) => {\r\n    if (percentage >= 90) return 'text-red-600';\r\n    if (percentage >= 70) return 'text-yellow-600';\r\n    return 'text-green-600';\r\n  };\r\n\r\n  const getUsageIcon = (percentage) => {\r\n    if (percentage >= 90) return <ExclamationTriangleIcon className=\"h-5 w-5 text-red-500\" />;\r\n    if (percentage >= 70) return <ExclamationTriangleIcon className=\"h-5 w-5 text-yellow-500\" />;\r\n    return <CheckCircleIcon className=\"h-5 w-5 text-green-500\" />;\r\n  };\r\n\r\n  const formatNumber = (num) => {\r\n    if (num >= 1000000) {\r\n      return (num / 1000000).toFixed(1) + 'M';\r\n    }\r\n    if (num >= 1000) {\r\n      return (num / 1000).toFixed(1) + 'K';\r\n    }\r\n    return num?.toString() || '0';\r\n  };\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"bg-white rounded-lg shadow p-6\">\r\n        <div className=\"flex items-center justify-center h-32\">\r\n          <ExclamationTriangleIcon className=\"h-8 w-8 text-red-500 mr-2\" />\r\n          <span className=\"text-red-600\">{error}</span>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const usagePercentage = tokenLimits?.usage_percentage || 0;\r\n\r\n  return (\r\n    <div className=\"bg-white rounded-lg shadow\">\r\n      <div className=\"p-6\">\r\n        <div className=\"flex items-center justify-between mb-6\">\r\n          <h3 className=\"text-lg font-medium text-gray-900 flex items-center\">\r\n            <CpuChipIcon className=\"h-5 w-5 mr-2\" />\r\n            Uso de Tokens\r\n          </h3>\r\n          <button\r\n            onClick={loadTokenData}\r\n            className=\"text-sm text-blue-600 hover:text-blue-800\"\r\n            disabled={loadingRef.current}\r\n          >\r\n            Actualizar\r\n          </button>\r\n        </div>\r\n\r\n        {/* Resumen de uso */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6\">\r\n          <div className=\"bg-gray-50 rounded-lg p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm font-medium text-gray-600\">Tokens Usados</p>\r\n                <p className=\"text-2xl font-bold text-gray-900\">\r\n                  {formatNumber(tokenLimits?.tokens_used || 0)}\r\n                </p>\r\n              </div>\r\n              <CpuChipIcon className=\"h-8 w-8 text-blue-500\" />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"bg-gray-50 rounded-lg p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm font-medium text-gray-600\">L√≠mite</p>\r\n                <p className=\"text-2xl font-bold text-gray-900\">\r\n                  {formatNumber(tokenLimits?.token_limit || 1000)}\r\n                </p>\r\n              </div>\r\n              <ChartBarIcon className=\"h-8 w-8 text-green-500\" />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"bg-gray-50 rounded-lg p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm font-medium text-gray-600\">Disponibles</p>\r\n                <p className=\"text-2xl font-bold text-gray-900\">\r\n                  {formatNumber(tokenLimits?.remaining_tokens || 1000)}\r\n                </p>\r\n              </div>\r\n              {getUsageIcon(usagePercentage)}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Barra de progreso */}\r\n        <div className=\"mb-6\">\r\n          <div className=\"flex items-center justify-between mb-2\">\r\n            <span className=\"text-sm font-medium text-gray-700\">Uso actual</span>\r\n            <span className={`text-sm font-medium ${getUsageColor(usagePercentage)}`}>\r\n              {usagePercentage.toFixed(1)}%\r\n            </span>\r\n          </div>\r\n          <div className=\"w-full bg-gray-200 rounded-full h-2\">\r\n            <div\r\n              className={`h-2 rounded-full transition-all duration-300 ${\r\n                usagePercentage >= 90\r\n                  ? 'bg-red-600'\r\n                  : usagePercentage >= 70\r\n                  ? 'bg-yellow-600'\r\n                  : 'bg-green-600'\r\n              }`}\r\n              style={{ width: `${Math.min(usagePercentage, 100)}%` }}\r\n            ></div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Estad√≠sticas por operaci√≥n */}\r\n        {tokenStats?.by_operation && Object.keys(tokenStats.by_operation).length > 0 && (\r\n          <div className=\"mb-6\">\r\n            <h4 className=\"text-md font-medium text-gray-900 mb-3\">Uso por Operaci√≥n</h4>\r\n            <div className=\"space-y-2\">\r\n              {Object.entries(tokenStats.by_operation).map(([operation, count]) => (\r\n                <div key={operation} className=\"flex items-center justify-between py-2 px-3 bg-gray-50 rounded\">\r\n                  <span className=\"text-sm text-gray-700 capitalize\">{operation}</span>\r\n                  <span className=\"text-sm font-medium text-gray-900\">{formatNumber(count)} tokens</span>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Historial reciente */}\r\n        {tokenStats?.records && tokenStats.records.length > 0 && (\r\n          <div>\r\n            <h4 className=\"text-md font-medium text-gray-900 mb-3\">Actividad Reciente</h4>\r\n            <div className=\"space-y-2 max-h-40 overflow-y-auto\">\r\n              {tokenStats.records.slice(0, 5).map((record, index) => (\r\n                <div key={index} className=\"flex items-center justify-between py-2 px-3 bg-gray-50 rounded text-sm\">\r\n                  <div className=\"flex items-center space-x-2\">\r\n                    <span className=\"text-gray-600 capitalize\">{record.operation}</span>\r\n                    <span className=\"text-gray-400\">‚Ä¢</span>\r\n                    <span className=\"text-gray-500\">\r\n                      {new Date(record.created_at).toLocaleDateString()}\r\n                    </span>\r\n                  </div>\r\n                  <span className=\"font-medium text-gray-900\">{formatNumber(record.tokens_used)} tokens</span>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default TokenUsage;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\employees\\EmployeeCard.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'UserIcon' is defined but never used.","line":4,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":11},{"ruleId":"no-unused-vars","severity":1,"message":"'CheckCircleIcon' is defined but never used.","line":5,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'EyeIcon' is defined but never used.","line":6,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":10}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport {\r\n  DocumentIcon,\r\n  UserIcon,\r\n  CheckCircleIcon,\r\n  EyeIcon\r\n} from '@heroicons/react/24/outline';\r\n\r\n/**\r\n * Componente at√≥mico para mostrar la tarjeta de un empleado\r\n * Extra√≠do del componente EmployeeFolders monol√≠tico\r\n */\r\nconst EmployeeCard = ({\r\n  folder,\r\n  isSelected,\r\n  onSelect,\r\n  onView,\r\n  onDragOver,\r\n  onDrop\r\n}) => {\r\n  const handleDragOver = (e) => {\r\n    e.preventDefault();\r\n    onDragOver?.(e);\r\n  };\r\n\r\n  const handleDrop = (e) => {\r\n    e.preventDefault();\r\n    onDrop?.(e, folder.email);\r\n  };\r\n\r\n  const handleSelect = (e) => {\r\n    e.stopPropagation();\r\n    onSelect?.(folder.email);\r\n  };\r\n\r\n  const handleView = (e) => {\r\n    e.stopPropagation();\r\n    onView?.(folder.email);\r\n  };\r\n\r\n  return (\r\n    <div\r\n      className={`employee-card p-8 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 transition-all duration-300 cursor-pointer transform hover:scale-[1.01] ${\r\n        isSelected ? 'bg-gradient-to-r from-indigo-100 to-purple-100 border-l-4 border-indigo-500 shadow-lg' : 'hover:shadow-md'\r\n      }`}\r\n      onClick={handleSelect}\r\n      onDragOver={handleDragOver}\r\n      onDrop={handleDrop}\r\n    >\r\n      <div className=\"flex items-start\">\r\n        <div className=\"flex items-center h-6 mr-6\">\r\n          <input\r\n            type=\"checkbox\"\r\n            checked={isSelected}\r\n            onChange={handleSelect}\r\n            className=\"h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 transition-all duration-300\"\r\n          />\r\n        </div>\r\n\r\n        <div className=\"flex-1 min-w-0\">\r\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n            <div className=\"flex items-center\">\r\n              <div className=\"flex-shrink-0 h-14 w-14 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg mr-4\">\r\n                <span className=\"text-white font-bold text-lg\">\r\n                  {(folder.employeeName || folder.email).charAt(0).toUpperCase()}\r\n                </span>\r\n              </div>\r\n              <div className=\"employee-info\">\r\n                <h3 className=\"text-xl font-bold text-gray-900 truncate max-w-xs md:max-w-md\">\r\n                  {folder.employeeName || folder.email}\r\n                </h3>\r\n                <p className=\"text-sm text-gray-600 truncate max-w-xs md:max-w-md flex items-center\">\r\n                  <svg className=\"w-4 h-4 mr-1 text-gray-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\" />\r\n                  </svg>\r\n                  {folder.email}\r\n                </p>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"employee-actions action-buttons\">\r\n              <button\r\n                onClick={handleView}\r\n                className=\"inline-flex items-center px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-medium rounded-lg transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105\"\r\n              >\r\n                <DocumentIcon className=\"h-5 w-5 mr-2\" />\r\n                Ver Carpeta\r\n              </button>\r\n            </div>\r\n          </div>\r\n          \r\n          <EmployeeInfoGrid folder={folder} />\r\n          <EmployeeBadges folder={folder} />\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\n/**\r\n * Grid de informaci√≥n del empleado\r\n */\r\nconst EmployeeInfoGrid = ({ folder }) => (\r\n  <div className=\"mt-6 info-card-grid\">\r\n    <div className=\"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100\">\r\n      <div className=\"flex items-center mb-2\">\r\n        <div className=\"w-2 h-2 bg-blue-500 rounded-full mr-2\"></div>\r\n        <p className=\"text-xs font-semibold text-blue-700 uppercase tracking-wide\">Empresa</p>\r\n      </div>\r\n      <p className=\"text-sm font-bold text-gray-900 truncate\">{folder.companyName}</p>\r\n    </div>\r\n\r\n    <div className=\"bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-xl border border-green-100\">\r\n      <div className=\"flex items-center mb-2\">\r\n        <div className=\"w-2 h-2 bg-green-500 rounded-full mr-2\"></div>\r\n        <p className=\"text-xs font-semibold text-green-700 uppercase tracking-wide\">Departamento</p>\r\n      </div>\r\n      <p className=\"text-sm font-bold text-gray-900 truncate\">{folder.employeeDepartment || 'No especificado'}</p>\r\n    </div>\r\n\r\n    <div className=\"bg-gradient-to-r from-purple-50 to-violet-50 p-4 rounded-xl border border-purple-100\">\r\n      <div className=\"flex items-center mb-2\">\r\n        <div className=\"w-2 h-2 bg-purple-500 rounded-full mr-2\"></div>\r\n        <p className=\"text-xs font-semibold text-purple-700 uppercase tracking-wide\">Cargo</p>\r\n      </div>\r\n      <p className=\"text-sm font-bold text-gray-900 truncate\">{folder.employeePosition || 'No especificado'}</p>\r\n    </div>\r\n\r\n    <div className=\"bg-gradient-to-r from-orange-50 to-red-50 p-4 rounded-xl border border-orange-100\">\r\n      <div className=\"flex items-center mb-2\">\r\n        <div className=\"w-2 h-2 bg-orange-500 rounded-full mr-2\"></div>\r\n        <p className=\"text-xs font-semibold text-orange-700 uppercase tracking-wide\">Tel√©fono</p>\r\n      </div>\r\n      <p className=\"text-sm font-bold text-gray-900 truncate\">{folder.employeePhone || 'No especificado'}</p>\r\n    </div>\r\n  </div>\r\n);\r\n\r\n/**\r\n * Badges de conocimiento del empleado\r\n */\r\nconst EmployeeBadges = ({ folder }) => (\r\n  <div className=\"mt-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\r\n    <div className=\"badge-container\">\r\n      <div className=\"inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-blue-100 to-blue-200 text-blue-800 border border-blue-300\">\r\n        <svg className=\"w-3 h-3 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n        </svg>\r\n        FAQs: {folder.knowledgeBase?.faqs?.length || 0}\r\n      </div>\r\n      <div className=\"inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-green-100 to-green-200 text-green-800 border border-green-300\">\r\n        <svg className=\"w-3 h-3 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\r\n        </svg>\r\n        Documentos: {folder.knowledgeBase?.documents?.length || 0}\r\n      </div>\r\n      <div className=\"inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-purple-100 to-purple-200 text-purple-800 border border-purple-300\">\r\n        <svg className=\"w-3 h-3 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z\" />\r\n        </svg>\r\n        Pol√≠ticas: {folder.knowledgeBase?.policies?.length || 0}\r\n      </div>\r\n      <div className=\"inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-orange-100 to-orange-200 text-orange-800 border border-orange-300\">\r\n        <svg className=\"w-3 h-3 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\r\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\r\n        </svg>\r\n        Procedimientos: {folder.knowledgeBase?.procedures?.length || 0}\r\n      </div>\r\n    </div>\r\n\r\n    <div className=\"bg-gray-100 px-3 py-2 rounded-lg\">\r\n      <div className=\"flex items-center text-xs text-gray-600\">\r\n        <svg className=\"w-4 h-4 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n        </svg>\r\n        √öltima actualizaci√≥n: {new Date(folder.lastUpdated).toLocaleDateString()}\r\n      </div>\r\n    </div>\r\n  </div>\r\n);\r\n\r\nexport default EmployeeCard;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\employees\\EmployeeFolderManager.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'DocumentIcon' is defined but never used.","line":4,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":15},{"ruleId":"no-unused-vars","severity":1,"message":"'QuestionMarkCircleIcon' is defined but never used.","line":5,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":25},{"ruleId":"no-unused-vars","severity":1,"message":"'ChatBubbleLeftRightIcon' is defined but never used.","line":6,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":26},{"ruleId":"no-unused-vars","severity":1,"message":"'Cog6ToothIcon' is defined but never used.","line":7,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'PencilIcon' is defined but never used.","line":10,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":13},{"ruleId":"no-unused-vars","severity":1,"message":"'TrashIcon' is defined but never used.","line":11,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":12},{"ruleId":"no-undef","severity":2,"message":"'enhancedEmployeeFolderService' is not defined.","line":67,"column":28,"nodeType":"Identifier","messageId":"undef","endLine":67,"endColumn":57},{"ruleId":"no-undef","severity":2,"message":"'enhancedEmployeeFolderService' is not defined.","line":97,"column":27,"nodeType":"Identifier","messageId":"undef","endLine":97,"endColumn":56},{"ruleId":"no-undef","severity":2,"message":"'enhancedEmployeeFolderService' is not defined.","line":111,"column":13,"nodeType":"Identifier","messageId":"undef","endLine":111,"endColumn":42}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { \r\n  FolderIcon, \r\n  DocumentIcon, \r\n  QuestionMarkCircleIcon,\r\n  ChatBubbleLeftRightIcon,\r\n  Cog6ToothIcon,\r\n  MagnifyingGlassIcon,\r\n  PlusIcon,\r\n  PencilIcon,\r\n  TrashIcon,\r\n  EyeIcon,\r\n  ArrowDownTrayIcon,\r\n  CloudArrowUpIcon\r\n} from '@heroicons/react/24/outline';\r\nimport unifiedEmployeeFolderService from '../../services/unifiedEmployeeFolderService.js';\r\nimport toast from 'react-hot-toast';\r\n\r\nconst EmployeeFolderManager = () => {\r\n  const [folders, setFolders] = useState([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [selectedFolder, setSelectedFolder] = useState(null);\r\n  const [showDetails, setShowDetails] = useState(false);\r\n  const [stats, setStats] = useState({ total: 0, active: 0, withDrive: 0 });\r\n  const [creatingFolders, setCreatingFolders] = useState(false);\r\n\r\n  // Cargar carpetas al montar el componente\r\n  useEffect(() => {\r\n    loadFolders();\r\n  }, []);\r\n\r\n  const loadFolders = async () => {\r\n    try {\r\n      setLoading(true);\r\n      \r\n      // Obtener todas las carpetas\r\n      const { data, error } = await unifiedEmployeeFolderService.supabase\r\n        .from('employee_folders')\r\n        .select('*')\r\n        .order('employee_name', { ascending: true });\r\n\r\n      if (error) throw error;\r\n\r\n      setFolders(data || []);\r\n      \r\n      // Calcular estad√≠sticas\r\n      const total = data?.length || 0;\r\n      const active = data?.filter(f => f.folder_status === 'active').length || 0;\r\n      const withDrive = data?.filter(f => f.drive_folder_id).length || 0;\r\n      \r\n      setStats({ total, active, withDrive });\r\n    } catch (error) {\r\n      console.error('Error cargando carpetas:', error);\r\n      toast.error('Error al cargar las carpetas de empleados');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  // Crear carpetas para todos los empleados\r\n  const createAllFolders = async () => {\r\n    try {\r\n      setCreatingFolders(true);\r\n      toast.loading('Creando carpetas para todos los empleados...');\r\n      \r\n      const result = await enhancedEmployeeFolderService.createFoldersForAllEmployees();\r\n      \r\n      toast.dismiss();\r\n      \r\n      if (result.createdCount > 0) {\r\n        toast.success(`${result.createdCount} carpetas creadas exitosamente`);\r\n      }\r\n      \r\n      if (result.updatedCount > 0) {\r\n        toast.success(`${result.updatedCount} carpetas actualizadas`);\r\n      }\r\n      \r\n      if (result.errorCount > 0) {\r\n        toast.error(`${result.errorCount} carpetas con errores`);\r\n      }\r\n      \r\n      // Recargar carpetas\r\n      await loadFolders();\r\n    } catch (error) {\r\n      toast.dismiss();\r\n      console.error('Error creando carpetas:', error);\r\n      toast.error('Error al crear las carpetas');\r\n    } finally {\r\n      setCreatingFolders(false);\r\n    }\r\n  };\r\n\r\n  // Obtener estad√≠sticas de una carpeta\r\n  const getFolderStats = async (employeeEmail) => {\r\n    try {\r\n      const stats = await enhancedEmployeeFolderService.getEmployeeFolderStats(employeeEmail);\r\n      setSelectedFolder(stats);\r\n      setShowDetails(true);\r\n    } catch (error) {\r\n      console.error('Error obteniendo estad√≠sticas:', error);\r\n      toast.error('Error al obtener estad√≠sticas de la carpeta');\r\n    }\r\n  };\r\n\r\n  // Sincronizar carpeta con Google Drive\r\n  const syncFolderWithDrive = async (employeeEmail) => {\r\n    try {\r\n      toast.loading('Sincronizando con Google Drive...');\r\n      \r\n      await enhancedEmployeeFolderService.syncFolderWithDrive(employeeEmail);\r\n      \r\n      toast.dismiss();\r\n      toast.success('Carpeta sincronizada con Google Drive');\r\n      \r\n      // Recargar carpetas\r\n      await loadFolders();\r\n    } catch (error) {\r\n      toast.dismiss();\r\n      console.error('Error sincronizando carpeta:', error);\r\n      toast.error('Error al sincronizar con Google Drive');\r\n    }\r\n  };\r\n\r\n  // Filtrar carpetas por t√©rmino de b√∫squeda\r\n  const filteredFolders = folders.filter(folder => \r\n    folder.employee_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    folder.employee_email?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    folder.company_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    folder.employee_position?.toLowerCase().includes(searchTerm.toLowerCase())\r\n  );\r\n\r\n  // Formatear fecha\r\n  const formatDate = (dateString) => {\r\n    if (!dateString) return 'N/A';\r\n    return new Date(dateString).toLocaleDateString('es-CL', {\r\n      year: 'numeric',\r\n      month: 'short',\r\n      day: 'numeric',\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    });\r\n  };\r\n\r\n  // Obtener color de estado\r\n  const getStatusColor = (status) => {\r\n    switch (status) {\r\n      case 'active': return 'bg-green-100 text-green-800';\r\n      case 'syncing': return 'bg-yellow-100 text-yellow-800';\r\n      case 'error': return 'bg-red-100 text-red-800';\r\n      default: return 'bg-gray-100 text-gray-800';\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center h-64\">\r\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600\"></div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\r\n      {/* Header */}\r\n      <div className=\"mb-8\">\r\n        <h1 className=\"text-3xl font-bold text-gray-900 mb-2\">\r\n          Gesti√≥n de Carpetas de Empleados\r\n        </h1>\r\n        <p className=\"text-gray-600\">\r\n          Administra las carpetas personales de cada empleado con vinculaci√≥n a Supabase y Google Drive\r\n        </p>\r\n      </div>\r\n\r\n      {/* Estad√≠sticas */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8\">\r\n        <div className=\"bg-white rounded-lg shadow p-6\">\r\n          <div className=\"flex items-center\">\r\n            <div className=\"flex-shrink-0\">\r\n              <FolderIcon className=\"h-8 w-8 text-blue-600\" />\r\n            </div>\r\n            <div className=\"ml-4\">\r\n              <p className=\"text-sm font-medium text-gray-500\">Total de Carpetas</p>\r\n              <p className=\"text-2xl font-semibold text-gray-900\">{stats.total}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow p-6\">\r\n          <div className=\"flex items-center\">\r\n            <div className=\"flex-shrink-0\">\r\n              <div className=\"h-8 w-8 bg-green-100 rounded-full flex items-center justify-center\">\r\n                <div className=\"h-4 w-4 bg-green-600 rounded-full\"></div>\r\n              </div>\r\n            </div>\r\n            <div className=\"ml-4\">\r\n              <p className=\"text-sm font-medium text-gray-500\">Carpetas Activas</p>\r\n              <p className=\"text-2xl font-semibold text-gray-900\">{stats.active}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow p-6\">\r\n          <div className=\"flex items-center\">\r\n            <div className=\"flex-shrink-0\">\r\n              <CloudArrowUpIcon className=\"h-8 w-8 text-green-600\" />\r\n            </div>\r\n            <div className=\"ml-4\">\r\n              <p className=\"text-sm font-medium text-gray-500\">Con Google Drive</p>\r\n              <p className=\"text-2xl font-semibold text-gray-900\">{stats.withDrive}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Acciones */}\r\n      <div className=\"bg-white rounded-lg shadow mb-6 p-6\">\r\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between\">\r\n          <div className=\"flex-1 min-w-0\">\r\n            <div className=\"relative\">\r\n              <div className=\"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none\">\r\n                <MagnifyingGlassIcon className=\"h-5 w-5 text-gray-400\" />\r\n              </div>\r\n              <input\r\n                type=\"text\"\r\n                className=\"block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm\"\r\n                placeholder=\"Buscar por nombre, email, empresa o cargo...\"\r\n                value={searchTerm}\r\n                onChange={(e) => setSearchTerm(e.target.value)}\r\n              />\r\n            </div>\r\n          </div>\r\n          \r\n          <div className=\"mt-4 sm:mt-0 sm:ml-4\">\r\n            <button\r\n              onClick={createAllFolders}\r\n              disabled={creatingFolders}\r\n              className=\"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              {creatingFolders ? (\r\n                <>\r\n                  <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2\"></div>\r\n                  Creando...\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <PlusIcon className=\"h-4 w-4 mr-2\" />\r\n                  Crear Todas las Carpetas\r\n                </>\r\n              )}\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Lista de Carpetas */}\r\n      <div className=\"bg-white shadow overflow-hidden sm:rounded-md\">\r\n        <ul className=\"divide-y divide-gray-200\">\r\n          {filteredFolders.length === 0 ? (\r\n            <li className=\"px-6 py-4 text-center text-gray-500\">\r\n              {searchTerm ? 'No se encontraron carpetas que coincidan con la b√∫squeda' : 'No hay carpetas registradas'}\r\n            </li>\r\n          ) : (\r\n            filteredFolders.map((folder) => (\r\n              <li key={folder.id} className=\"hover:bg-gray-50\">\r\n                <div className=\"px-6 py-4\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <div className=\"flex-1 min-w-0\">\r\n                      <div className=\"flex items-center\">\r\n                        <FolderIcon className=\"h-8 w-8 text-blue-600 mr-3\" />\r\n                        <div>\r\n                          <p className=\"text-sm font-medium text-gray-900 truncate\">\r\n                            {folder.employee_name}\r\n                          </p>\r\n                          <p className=\"text-sm text-gray-500\">\r\n                            {folder.employee_email} ‚Ä¢ {folder.company_name}\r\n                          </p>\r\n                          <div className=\"flex items-center mt-1 space-x-4\">\r\n                            <span className=\"text-xs text-gray-500\">\r\n                              {folder.employee_position}\r\n                            </span>\r\n                            <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(folder.folder_status)}`}>\r\n                              {folder.folder_status}\r\n                            </span>\r\n                            {folder.drive_folder_id && (\r\n                              <span className=\"inline-flex items-center text-xs text-green-600\">\r\n                                <CloudArrowUpIcon className=\"h-3 w-3 mr-1\" />\r\n                                Google Drive\r\n                              </span>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                    \r\n                    <div className=\"flex items-center space-x-2 ml-4\">\r\n                      <button\r\n                        onClick={() => getFolderStats(folder.employee_email)}\r\n                        className=\"p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full\"\r\n                        title=\"Ver detalles\"\r\n                      >\r\n                        <EyeIcon className=\"h-4 w-4\" />\r\n                      </button>\r\n                      \r\n                      {folder.drive_folder_id && (\r\n                        <a\r\n                          href={folder.drive_folder_url}\r\n                          target=\"_blank\"\r\n                          rel=\"noopener noreferrer\"\r\n                          className=\"p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-full\"\r\n                          title=\"Abrir en Google Drive\"\r\n                        >\r\n                          <ArrowDownTrayIcon className=\"h-4 w-4\" />\r\n                        </a>\r\n                      )}\r\n                      \r\n                      <button\r\n                        onClick={() => syncFolderWithDrive(folder.employee_email)}\r\n                        className=\"p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full\"\r\n                        title=\"Sincronizar con Google Drive\"\r\n                      >\r\n                        <CloudArrowUpIcon className=\"h-4 w-4\" />\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                  \r\n                  <div className=\"mt-2 text-xs text-gray-500\">\r\n                    Creada: {formatDate(folder.created_at)} ‚Ä¢ \r\n                    Actualizada: {formatDate(folder.updated_at)}\r\n                  </div>\r\n                </div>\r\n              </li>\r\n            ))\r\n          )}\r\n        </ul>\r\n      </div>\r\n\r\n      {/* Modal de Detalles */}\r\n      {showDetails && selectedFolder && (\r\n        <div className=\"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50\">\r\n          <div className=\"relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white\">\r\n            <div className=\"mt-3\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <h3 className=\"text-lg font-medium text-gray-900\">\r\n                  Detalles de Carpeta\r\n                </h3>\r\n                <button\r\n                  onClick={() => setShowDetails(false)}\r\n                  className=\"text-gray-400 hover:text-gray-600\"\r\n                >\r\n                  <span className=\"sr-only\">Cerrar</span>\r\n                  <svg className=\"h-6 w-6\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\r\n                  </svg>\r\n                </button>\r\n              </div>\r\n              \r\n              <div className=\"space-y-4\">\r\n                <div>\r\n                  <p className=\"text-sm font-medium text-gray-500\">Empleado</p>\r\n                  <p className=\"text-sm text-gray-900\">{selectedFolder.folder?.employee_name}</p>\r\n                  <p className=\"text-xs text-gray-500\">{selectedFolder.folder?.employee_email}</p>\r\n                </div>\r\n                \r\n                <div>\r\n                  <p className=\"text-sm font-medium text-gray-500\">Empresa</p>\r\n                  <p className=\"text-sm text-gray-900\">{selectedFolder.folder?.company_name}</p>\r\n                </div>\r\n                \r\n                <div className=\"grid grid-cols-3 gap-4\">\r\n                  <div className=\"text-center\">\r\n                    <p className=\"text-2xl font-semibold text-blue-600\">\r\n                      {selectedFolder.stats?.documents || 0}\r\n                    </p>\r\n                    <p className=\"text-xs text-gray-500\">Documentos</p>\r\n                  </div>\r\n                  <div className=\"text-center\">\r\n                    <p className=\"text-2xl font-semibold text-green-600\">\r\n                      {selectedFolder.stats?.faqs || 0}\r\n                    </p>\r\n                    <p className=\"text-xs text-gray-500\">FAQs</p>\r\n                  </div>\r\n                  <div className=\"text-center\">\r\n                    <p className=\"text-2xl font-semibold text-purple-600\">\r\n                      {selectedFolder.stats?.conversations || 0}\r\n                    </p>\r\n                    <p className=\"text-xs text-gray-500\">Conversaciones</p>\r\n                  </div>\r\n                </div>\r\n                \r\n                {selectedFolder.folder?.drive_folder_url && (\r\n                  <div>\r\n                    <a\r\n                      href={selectedFolder.folder.drive_folder_url}\r\n                      target=\"_blank\"\r\n                      rel=\"noopener noreferrer\"\r\n                      className=\"w-full inline-flex justify-center items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500\"\r\n                    >\r\n                      <ArrowDownTrayIcon className=\"h-4 w-4 mr-2\" />\r\n                      Abrir en Google Drive\r\n                    </a>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default EmployeeFolderManager;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\error\\ErrorBoundary.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\error\\ReactErrorBoundary.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\files\\Files.js","messages":[{"ruleId":"no-use-before-define","severity":1,"message":"'loadFolders' was used before it was defined.","line":54,"column":7,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":54,"endColumn":18},{"ruleId":"no-use-before-define","severity":1,"message":"'loadFiles' was used before it was defined.","line":54,"column":20,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":54,"endColumn":29},{"ruleId":"no-use-before-define","severity":1,"message":"'loadFiles' was used before it was defined.","line":60,"column":23,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":60,"endColumn":32},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has an unnecessary dependency: 'user'. Either exclude it or remove the dependency array.","line":182,"column":6,"nodeType":"ArrayExpression","endLine":182,"endColumn":25,"suggestions":[{"desc":"Update the dependencies array to be: [userProfile]","fix":{"range":[6667,6686],"text":"[userProfile]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef, useCallback } from 'react'\r\nimport { useLocation } from 'react-router-dom'\r\nimport { useAuth } from '../../contexts/AuthContext.js'\r\nimport { db, supabase } from '../../lib/supabase.js'\r\nimport googleDriveService from '../../lib/googleDrive.js'\r\nimport fileContentExtractor from '../../services/fileContentExtractor.js'\r\nimport embeddingService from '../../services/embeddingService.js'\r\nimport { useUserExtensions } from '../../hooks/useUserExtensions.js'\r\nimport {\r\n  DocumentIcon,\r\n  PhotoIcon,\r\n  FilmIcon,\r\n  MusicalNoteIcon,\r\n  ArchiveBoxIcon,\r\n  CloudArrowUpIcon,\r\n  TrashIcon,\r\n  EyeIcon,\r\n  ArrowDownTrayIcon,\r\n  MagnifyingGlassIcon,\r\n  DocumentTextIcon\r\n} from '@heroicons/react/24/outline'\r\nimport LoadingSpinner from '../common/LoadingSpinner.js'\r\nimport RoutineUpload from '../routines/RoutineUpload.js'\r\nimport DragDropUpload from '../common/DragDropUpload.js'\r\nimport toast from 'react-hot-toast'\r\nimport '../../styles/responsive-tables.css'\r\n\r\nconst Files = () => {\r\n  const { user, userProfile } = useAuth()\r\n  const { hasExtension } = useUserExtensions()\r\n  const location = useLocation()\r\n  const [files, setFiles] = useState([])\r\n  const [folders, setFolders] = useState([])\r\n  const [selectedFolder, setSelectedFolder] = useState('')\r\n  const [loading, setLoading] = useState(true)\r\n  const [uploading, setUploading] = useState(false)\r\n  const [uploadProgress, setUploadProgress] = useState({})\r\n  const [showRoutineUpload, setShowRoutineUpload] = useState(false)\r\n  const [searchTerm, setSearchTerm] = useState('')\r\n  const [fileTypeFilter, setFileTypeFilter] = useState('all')\r\n  const [sortBy, setSortBy] = useState('date')\r\n  const [sortOrder, setSortOrder] = useState('desc')\r\n  const [showUploadModal, setShowUploadModal] = useState(false)\r\n  const [showDragDropUpload, setShowDragDropUpload] = useState(true)\r\n  const [selectedFiles, setSelectedFiles] = useState([])\r\n  // Usar la instancia por defecto de googleDriveService\r\n  const fileInputRef = useRef(null)\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\nuseEffect(() => {\r\n    loadFolders()\r\n    loadFiles()\r\n  }, [loadFolders, loadFiles])\r\n\r\n  useEffect(() => {\r\n    if (selectedFolder) {\r\n      loadFiles(selectedFolder)\r\n    }\r\n  }, [selectedFolder, loadFiles])\r\n\r\n  // Manejar carpeta preseleccionada desde navegaci√≥n\r\n  useEffect(() => {\r\n    if (location.state?.selectedFolder) {\r\n      const folder = location.state.selectedFolder\r\n      setSelectedFolder(folder.id.toString())\r\n      toast.success(`Carpeta \"${folder.folder_name}\" seleccionada`)\r\n    }\r\n  }, [location.state])\r\n\r\n  const loadFolders = useCallback(async () => {\r\n    try {\r\n      // Cargar carpetas del usuario\r\n      const { data: adminFolders, error: adminError } = await db.adminFolders.getByUser(user.id)\r\n      if (adminError) throw adminError\r\n      \r\n      const { data: userFolders, error: userError } = await db.userFolders.getByUser(user.id)\r\n      if (userError) throw userError\r\n      \r\n      console.log('Admin folders:', adminFolders)\r\n      console.log('User folders:', userFolders)\r\n      console.log('Current user:', user)\r\n      \r\n      const allFolders = [\r\n        ...(adminFolders || []).map(f => ({\r\n          ...f,\r\n          type: 'admin',\r\n          google_folder_id: f.id_drive_carpeta\r\n        })),\r\n        ...(userFolders || []).map(f => ({\r\n          ...f,\r\n          type: 'user',\r\n          google_folder_id: f.id_carpeta_drive\r\n        }))\r\n      ]\r\n      \r\n      console.log('All folders combined:', allFolders)\r\n      setFolders(allFolders)\r\n    } catch (error) {\r\n      console.error('Error loading folders:', error)\r\n      toast.error('Error cargando las carpetas')\r\n    }\r\n  }, [user])\r\n\r\n  const loadFiles = useCallback(async (folderId = null) => {\r\n    try {\r\n      setLoading(true)\r\n      \r\n      let dbFiles = []\r\n      \r\n      // Cargar archivos principales desde documentos_usuario_entrenador\r\n      // Esto evita mostrar los chunks individuales y solo muestra el archivo principal\r\n      const { data, error } = await supabase\r\n        .from('documentos_usuario_entrenador')\r\n        .select('*')\r\n        .order('created_at', { ascending: false })\r\n      \r\n      if (error) throw error\r\n      \r\n      // Transformar los datos para que sean compatibles con la interfaz existente\r\n      dbFiles = (data || []).map(file => ({\r\n        id: file.id,\r\n        created_at: file.created_at,\r\n        metadata: {\r\n          name: file.file_name,\r\n          file_name: file.file_name,\r\n          file_type: file.file_type,\r\n          file_id: file.file_id, // ID de Google Drive\r\n          source: 'documentos_usuario_entrenador',\r\n          correo: file.usuario\r\n        },\r\n        // Agregar campos adicionales para compatibilidad\r\n        entrenador: file.entrenador,\r\n        usuario: file.usuario,\r\n        google_file_id: file.file_id\r\n      }))\r\n      \r\n      // Si el usuario tiene Google Drive conectado, obtener informaci√≥n adicional\r\n      if (userProfile?.google_refresh_token) {\r\n        try {\r\n          await googleDriveService.setTokens({\r\n            refresh_token: userProfile.google_refresh_token\r\n          })\r\n          \r\n          // Enriquecer archivos con informaci√≥n de Google Drive\r\n          const enrichedFiles = await Promise.all(\r\n            dbFiles.map(async (file) => {\r\n              if (file.google_file_id) {\r\n                try {\r\n                  const driveInfo = await googleDriveService.getFileInfo(file.google_file_id)\r\n                  return {\r\n                    ...file,\r\n                    driveInfo,\r\n                    synced: true,\r\n                    size: driveInfo.size,\r\n                    downloadUrl: driveInfo.webContentLink\r\n                  }\r\n                } catch (error) {\r\n                  console.error(`Error getting info for file ${file.google_file_id}:`, error)\r\n                  return { ...file, synced: false }\r\n                }\r\n              }\r\n              return { ...file, synced: false }\r\n            })\r\n          )\r\n          \r\n          setFiles(enrichedFiles)\r\n        } catch (error) {\r\n          console.error('Error syncing with Google Drive:', error)\r\n          setFiles(dbFiles.map(file => ({ ...file, synced: false })))\r\n        }\r\n      } else {\r\n        setFiles(dbFiles.map(file => ({ ...file, synced: false })))\r\n      }\r\n      \r\n    } catch (error) {\r\n      console.error('Error loading files:', error)\r\n      toast.error('Error cargando los archivos')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [user, userProfile])\r\n\r\n  // Tipos de archivo permitidos\r\n  const allowedFileTypes = {\r\n    // Documentos PDF\r\n    'application/pdf': '.pdf',\r\n    // Documentos Word\r\n    'application/msword': '.doc',\r\n    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': '.docx',\r\n    // Documentos Excel\r\n    'application/vnd.ms-excel': '.xls',\r\n    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': '.xlsx',\r\n    // Documentos PowerPoint (opcional)\r\n    'application/vnd.ms-powerpoint': '.ppt',\r\n    'application/vnd.openxmlformats-officedocument.presentationml.presentation': '.pptx',\r\n    // Documentos de texto\r\n    'text/plain': '.txt'\r\n  }\r\n\r\n  // Extensiones bloqueadas\r\n  const blockedExtensions = [\r\n    '.exe', '.bat', '.cmd', '.com', '.scr', '.msi', '.dll',\r\n    '.zip', '.rar', '.7z', '.tar', '.gz', '.bz2',\r\n    '.js', '.vbs', '.ps1', '.sh'\r\n  ]\r\n\r\n  const validateFileType = (file) => {\r\n    const fileName = file.name.toLowerCase()\r\n    const fileType = file.type\r\n    \r\n    // Verificar extensiones bloqueadas\r\n    const hasBlockedExtension = blockedExtensions.some(ext => fileName.endsWith(ext))\r\n    if (hasBlockedExtension) {\r\n      return {\r\n        valid: false,\r\n        reason: `Archivo ${file.name}: Tipo de archivo no permitido por seguridad`\r\n      }\r\n    }\r\n    \r\n    // Verificar tipos MIME permitidos\r\n    if (fileType && allowedFileTypes[fileType]) {\r\n      return { valid: true }\r\n    }\r\n    \r\n    // Verificar por extensi√≥n si el MIME type no est√° disponible\r\n    const allowedExtensions = Object.values(allowedFileTypes)\r\n    const hasAllowedExtension = allowedExtensions.some(ext => fileName.endsWith(ext))\r\n    \r\n    if (hasAllowedExtension) {\r\n      return { valid: true }\r\n    }\r\n    \r\n    return {\r\n      valid: false,\r\n      reason: `Archivo ${file.name}: Solo se permiten documentos PDF, Word, Excel, PowerPoint y archivos de texto`\r\n    }\r\n  }\r\n\r\n  const handleFileSelect = (event) => {\r\n    // Manejar tanto eventos de input como arrays de archivos directos\r\n    const files = Array.isArray(event) ? event : Array.from(event.target.files)\r\n    \r\n    // Validar cada archivo\r\n    const validationResults = files.map(validateFileType)\r\n    const invalidFiles = validationResults.filter(result => !result.valid)\r\n    \r\n    if (invalidFiles.length > 0) {\r\n      // Mostrar errores para archivos no v√°lidos\r\n      invalidFiles.forEach(result => {\r\n        toast.error(result.reason)\r\n      })\r\n      \r\n      // Solo mantener archivos v√°lidos\r\n      const validFiles = files.filter((file, index) => validationResults[index].valid)\r\n      \r\n      if (validFiles.length === 0) {\r\n        // Si no hay archivos v√°lidos, limpiar la selecci√≥n\r\n        event.target.value = ''\r\n        return\r\n      }\r\n      \r\n      setSelectedFiles(validFiles)\r\n      toast.success(`${validFiles.length} archivo(s) v√°lido(s) seleccionado(s)`)\r\n    } else {\r\n      setSelectedFiles(files)\r\n      toast.success(`${files.length} archivo(s) seleccionado(s)`)\r\n    }\r\n    \r\n    setShowUploadModal(true)\r\n  }\r\n\r\n  const handleUpload = async () => {\r\n    if (!selectedFolder) {\r\n      toast.error('Selecciona una carpeta para subir los archivos')\r\n      return\r\n    }\r\n    \r\n    if (selectedFiles.length === 0) {\r\n      toast.error('Selecciona al menos un archivo')\r\n      return\r\n    }\r\n\r\n    setUploading(true)\r\n    const newUploadProgress = {}\r\n    \r\n    try {\r\n      // Verificar si tiene Google Drive conectado\r\n      if (userProfile?.google_refresh_token) {\r\n        await googleDriveService.setTokens({\r\n          refresh_token: userProfile.google_refresh_token\r\n        })\r\n      }\r\n      \r\n      // Obtener informaci√≥n de la carpeta seleccionada\r\n      console.log('üîç Buscando carpeta:', {\r\n        selectedFolder,\r\n        selectedFolderType: typeof selectedFolder,\r\n        availableFolders: folders.map(f => ({ id: f.id, type: typeof f.id, name: f.folder_name || f.correo }))\r\n      })\r\n      \r\n      const folder = folders.find(f => f.id === selectedFolder) // Usar === para comparaci√≥n estricta\r\n      console.log('üìÅ Carpeta encontrada:', folder)\r\n      \r\n      if (!folder) {\r\n        toast.error('Carpeta no encontrada')\r\n        return\r\n      }\r\n      \r\n      for (let i = 0; i < selectedFiles.length; i++) {\r\n        const file = selectedFiles[i]\r\n        const fileId = `file-${i}`\r\n        \r\n        try {\r\n          newUploadProgress[fileId] = 0\r\n          setUploadProgress({ ...newUploadProgress })\r\n          \r\n          let googleFileId = null\r\n          let fileSize = file.size\r\n          \r\n          // Subir a Google Drive si est√° conectado\r\n          if (userProfile?.google_refresh_token && folder.google_folder_id) {\r\n            console.log('üîÑ Subiendo archivo a Google Drive...')\r\n            const driveFile = await googleDriveService.uploadFile(\r\n              file,\r\n              folder.google_folder_id,\r\n              (progress) => {\r\n                newUploadProgress[fileId] = progress\r\n                setUploadProgress({ ...newUploadProgress })\r\n              }\r\n            )\r\n            googleFileId = driveFile.id\r\n            console.log('‚úÖ Archivo subido a Google Drive con ID:', googleFileId)\r\n          } else {\r\n            // Generar un ID √∫nico para el archivo cuando no se sube a Google Drive\r\n            googleFileId = `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n            console.log('üìÅ Generado ID local para archivo:', googleFileId)\r\n          }\r\n          \r\n          console.log('üîç googleFileId antes del procesamiento:', googleFileId)\r\n          \r\n          // Extraer contenido y procesar con chunking inteligente\r\n          let content = ''\r\n          let embedding = []\r\n          let tokensUsed = 0\r\n          \r\n          console.log('üîç googleFileId antes del try-catch de extracci√≥n:', googleFileId)\r\n          \r\n          try {\r\n            if (fileContentExtractor.isSupported(file)) {\r\n              const processed = await embeddingService.processFile(file, fileContentExtractor)\r\n              content = processed.content\r\n              embedding = processed.embedding\r\n              console.log(`‚úÖ Contenido extra√≠do: ${content.length} caracteres`)\r\n              \r\n              // Actualizar progreso despu√©s de extraer contenido\r\n              newUploadProgress[fileId] = 20\r\n              setUploadProgress({ ...newUploadProgress })\r\n              \r\n              // Calcular tokens reales basados en el contenido\r\n              tokensUsed = Math.ceil(content.length / 4) // Aproximaci√≥n est√°ndar para tokens\r\n              \r\n              // Registrar uso de tokens usando el sistema correcto\r\n              const embeddingsServiceLib = await import('../../lib/embeddings.js')\r\n              await embeddingsServiceLib.default.trackTokenUsage(user.id, tokensUsed, 'file_embedding')\r\n              \r\n            } else {\r\n              console.warn(`‚ö†Ô∏è Tipo de archivo no soportado: ${file.type}`)\r\n              // Abortar el proceso para archivos no soportados\r\n              throw new Error(`Formato de archivo no compatible: ${file.type}. Solo se permiten documentos de texto, PDF, Word y Excel.`)\r\n            }\r\n          } catch (extractError) {\r\n            console.error('Error extrayendo contenido:', extractError)\r\n            // Abortar completamente el proceso si no se puede extraer contenido\r\n            throw new Error(`No se pudo procesar el archivo ${file.name}: ${extractError.message}`)\r\n          }\r\n          \r\n          console.log('üîç googleFileId despu√©s del try-catch de extracci√≥n:', googleFileId)\r\n          \r\n          // Verificar si el contenido excede el l√≠mite de caracteres (10,240)\r\n          const MAX_CONTENT_LENGTH = 10240\r\n          let contentToStore = content\r\n          \r\n          if (content.length > MAX_CONTENT_LENGTH) {\r\n            console.log(`‚ö†Ô∏è Contenido muy largo (${content.length} caracteres), creando chunks en documentos_entrenador...`)\r\n            \r\n            // Importar embeddings service para chunking\r\n            const embeddingsServiceLib = await import('../../lib/embeddings.js')\r\n            \r\n            // Dividir contenido en chunks\r\n            const chunks = embeddingsServiceLib.default.splitTextIntoChunks(content, 8000)\r\n            console.log(`‚úÇÔ∏è Creando ${chunks.length} chunks en documentos_entrenador`)\r\n            \r\n            // Crear documento principal (truncado)\r\n            contentToStore = content.substring(0, MAX_CONTENT_LENGTH - 200) + \r\n              `\\n\\n[DOCUMENTO DIVIDIDO EN CHUNKS: Este documento fue dividido en ${chunks.length} partes para optimizar la b√∫squeda. Contenido total: ${content.length} caracteres]`\r\n            \r\n            // Metadata del documento principal\r\n            const baseMetadata = {\r\n              name: file.name,\r\n              correo: folder.correo || folder.folder_name,\r\n              source: 'web_upload',\r\n              file_id: googleFileId, // ID del archivo en Google Drive o local\r\n              file_type: file.type,\r\n              file_size: fileSize,\r\n              upload_date: new Date().toISOString(),\r\n              blobType: file.type,\r\n              is_chunked: true,\r\n              original_length: content.length,\r\n              chunks_count: chunks.length,\r\n              chunk_type: 'main'\r\n            }\r\n            \r\n            // Guardar documento principal primero\r\n            const mainFileData = {\r\n              entrenador: user.email,\r\n              folder_id: selectedFolder,\r\n              content: contentToStore,\r\n              metadata: baseMetadata,\r\n              embedding: embedding\r\n            }\r\n            \r\n            const { data: mainDoc, error: mainError } = await db.trainerDocuments.create(mainFileData)\r\n            if (mainError) {\r\n              console.error('Error guardando documento principal:', mainError)\r\n              throw mainError\r\n            }\r\n            \r\n            console.log('‚úÖ Documento principal guardado, creando chunks...')\r\n            \r\n            // Actualizar progreso despu√©s de guardar documento principal\r\n            newUploadProgress[fileId] = 30\r\n            setUploadProgress({ ...newUploadProgress })\r\n            \r\n            // Crear chunks como registros separados\r\n            let successfulChunks = 0\r\n            for (let i = 0; i < chunks.length; i++) {\r\n              try {\r\n                // Generar embedding para el chunk\r\n                const chunkEmbeddingResult = await embeddingsServiceLib.default.generateEmbedding(chunks[i], user.id)\r\n                \r\n                const chunkData = {\r\n                  entrenador: user.email,\r\n                  folder_id: selectedFolder,\r\n                  content: chunks[i],\r\n                  metadata: {\r\n                    ...baseMetadata,\r\n                    chunk_type: 'chunk',\r\n                    chunk_index: i + 1,\r\n                    parent_file_id: googleFileId,\r\n                    chunk_of_total: `${i + 1}/${chunks.length}`,\r\n                    name: `${file.name} - Parte ${i + 1}`,\r\n                    source: 'chunk_from_web_upload'\r\n                  },\r\n                  embedding: chunkEmbeddingResult.embedding\r\n                }\r\n                \r\n                const { error: chunkError } = await db.trainerDocuments.create(chunkData)\r\n                if (chunkError) {\r\n                  console.error(`Error guardando chunk ${i + 1}:`, chunkError)\r\n                } else {\r\n                  successfulChunks++\r\n                  console.log(`‚úÖ Chunk ${i + 1}/${chunks.length} guardado`)\r\n                  \r\n                  // Actualizar progreso basado en chunks procesados\r\n                  // Progreso base del archivo (30%) + progreso de chunks (70%)\r\n                  const baseProgress = 30\r\n                  const chunkProgress = Math.round((successfulChunks / chunks.length) * 70)\r\n                  const totalProgress = Math.min(baseProgress + chunkProgress, 99) // M√°ximo 99% hasta completar\r\n                  \r\n                  newUploadProgress[fileId] = totalProgress\r\n                  setUploadProgress({ ...newUploadProgress })\r\n                }\r\n                \r\n                // Registrar tokens del chunk\r\n                await embeddingsServiceLib.default.trackTokenUsage(user.id, chunkEmbeddingResult.tokens_used, 'file_embedding')\r\n                \r\n              } catch (chunkError) {\r\n                console.error(`Error procesando chunk ${i + 1}:`, chunkError)\r\n              }\r\n            }\r\n            \r\n            console.log(`‚úÖ ${successfulChunks}/${chunks.length} chunks guardados exitosamente`)\r\n            \r\n            // Actualizar metadata del documento principal\r\n            await supabase\r\n              .from('documentos_entrenador')\r\n              .update({\r\n                metadata: {\r\n                  ...baseMetadata,\r\n                  chunks_created: successfulChunks,\r\n                  chunks_failed: chunks.length - successfulChunks\r\n                }\r\n              })\r\n              .eq('id', mainDoc.id)\r\n            \r\n            // Continuar con el flujo normal para el documento principal\r\n            // No necesitamos crear otro registro ya que el principal ya se guard√≥\r\n            \r\n            // Registrar en documentos_usuario_entrenador (flujo de chunks)\r\n            console.log('üîç googleFileId en flujo de chunks antes de registro:', googleFileId)\r\n            const userTrainerDocData = {\r\n              file_id: googleFileId,\r\n              file_type: file.type,\r\n              file_name: file.name,\r\n              usuario: folder.correo || folder.folder_name,\r\n              entrenador: user.email // Agregar el email del entrenador\r\n            }\r\n            \r\n            console.log('üìù Intentando registrar en documentos_usuario_entrenador:', userTrainerDocData)\r\n            const { data: userTrainerData, error: userTrainerError } = await db.userTrainerDocuments.create(userTrainerDocData)\r\n            if (userTrainerError) {\r\n              console.error('‚ùå Error registrando en documentos_usuario_entrenador:', userTrainerError)\r\n              console.error('‚ùå Datos que se intentaron insertar:', userTrainerDocData)\r\n            } else {\r\n              console.log('‚úÖ Registro exitoso en documentos_usuario_entrenador:', userTrainerData)\r\n            }\r\n            \r\n            // Actualizar estad√≠sticas del usuario\r\n            const embeddingSize = embedding.length * 4\r\n            await db.users.update(user.id, {\r\n              used_storage_bytes: (userProfile.used_storage_bytes || 0) + embeddingSize\r\n            })\r\n            \r\n            console.log(`‚úÖ Tokens registrados correctamente: ${tokensUsed} tokens para ${file.name}`)\r\n            \r\n            newUploadProgress[fileId] = 100\r\n            setUploadProgress({ ...newUploadProgress })\r\n            \r\n            // Salir del bucle ya que el archivo se proces√≥ completamente\r\n            continue\r\n          }\r\n          \r\n          // Guardar en la base de datos con estructura JSONB correcta (flujo normal)\r\n          console.log('üîç googleFileId en flujo normal antes de crear fileData:', googleFileId)\r\n          const fileData = {\r\n            entrenador: user.email, // Email del entrenador\r\n            folder_id: selectedFolder,\r\n            content: contentToStore, // Contenido limitado o completo seg√∫n el tama√±o\r\n            metadata: {\r\n              name: file.name,\r\n              correo: folder.correo || folder.folder_name, // Email de la carpeta (usuario)\r\n              source: 'web_upload',\r\n              file_id: googleFileId, // ID del archivo en Google Drive o local\r\n              file_type: file.type,\r\n              file_size: fileSize,\r\n              upload_date: new Date().toISOString(),\r\n              blobType: file.type,\r\n              is_chunked: content.length > MAX_CONTENT_LENGTH,\r\n              original_length: content.length,\r\n              chunks_count: content.length > MAX_CONTENT_LENGTH ? Math.ceil(content.length / 8000) : 1\r\n            },\r\n            embedding: embedding\r\n          }\r\n          \r\n          const { error } = await db.trainerDocuments.create(fileData)\r\n          if (error) throw error\r\n          \r\n          // Registrar tambi√©n en documentos_usuario_entrenador\r\n          console.log('üîç googleFileId antes de crear userTrainerDocData:', googleFileId)\r\n          const userTrainerDocData = {\r\n            file_id: googleFileId, // ID del archivo en Google Drive\r\n            file_type: file.type,\r\n            file_name: file.name,\r\n            usuario: folder.correo || folder.folder_name, // Email de la carpeta (usuario)\r\n            entrenador: user.email // Email del entrenador que sube el archivo\r\n          }\r\n          \r\n          console.log('üìù Intentando registrar en documentos_usuario_entrenador:', userTrainerDocData)\r\n          console.log('üîç Verificando file_id en userTrainerDocData:', userTrainerDocData.file_id)\r\n          const { data: userTrainerData, error: userTrainerError } = await db.userTrainerDocuments.create(userTrainerDocData)\r\n          if (userTrainerError) {\r\n            console.error('‚ùå Error registrando en documentos_usuario_entrenador:', userTrainerError)\r\n            console.error('‚ùå Datos que se intentaron insertar:', userTrainerDocData)\r\n            // No lanzamos error para no interrumpir el flujo principal\r\n          } else {\r\n            console.log('‚úÖ Registro exitoso en documentos_usuario_entrenador:', userTrainerData)\r\n          }\r\n          \r\n          // Actualizar estad√≠sticas del usuario\r\n          const embeddingSize = embedding.length * 4 // 4 bytes por float\r\n          \r\n          // Actualizar almacenamiento usado\r\n          await db.users.update(user.id, {\r\n            used_storage_bytes: (userProfile.used_storage_bytes || 0) + embeddingSize\r\n          })\r\n          \r\n          // Los tokens ya se registraron correctamente usando embeddingsService.trackTokenUsage\r\n          console.log(`‚úÖ Tokens registrados correctamente: ${tokensUsed} tokens para ${file.name}`)\r\n          \r\n          newUploadProgress[fileId] = 100\r\n          setUploadProgress({ ...newUploadProgress })\r\n          \r\n        } catch (error) {\r\n          console.error(`Error uploading file ${file.name}:`, error)\r\n          \r\n          // Mostrar mensaje espec√≠fico seg√∫n el tipo de error\r\n          if (error.message.includes('No se pudo procesar el archivo') || \r\n              error.message.includes('Formato de archivo no compatible')) {\r\n            toast.error(`${file.name}: ${error.message}`)\r\n          } else {\r\n            toast.error(`Error subiendo ${file.name}: ${error.message}`)\r\n          }\r\n          \r\n          // Marcar el progreso como fallido\r\n          newUploadProgress[fileId] = -1 // -1 indica error\r\n          setUploadProgress({ ...newUploadProgress })\r\n        }\r\n      }\r\n      \r\n      // Contar archivos exitosos y fallidos\r\n      const successfulFiles = Object.values(newUploadProgress).filter(progress => progress === 100).length\r\n      const failedFiles = Object.values(newUploadProgress).filter(progress => progress === -1).length\r\n      \r\n      if (successfulFiles > 0 && failedFiles === 0) {\r\n        toast.success(`${successfulFiles} archivo(s) subido(s) exitosamente`)\r\n      } else if (successfulFiles > 0 && failedFiles > 0) {\r\n        toast.success(`${successfulFiles} archivo(s) subido(s) exitosamente. ${failedFiles} archivo(s) fallaron.`)\r\n      } else if (failedFiles > 0) {\r\n        toast.error(`Todos los archivos fallaron al subirse`)\r\n      }\r\n      \r\n      // Recargar archivos\r\n      await loadFiles(selectedFolder)\r\n      \r\n      // Limpiar estado\r\n      setSelectedFiles([])\r\n      setShowUploadModal(false)\r\n      setShowDragDropUpload(false)\r\n      setUploadProgress({})\r\n      \r\n      // Mostrar el DragDropUpload nuevamente despu√©s de 2 segundos\r\n      setTimeout(() => {\r\n        setShowDragDropUpload(true)\r\n      }, 2000)\r\n      \r\n    } catch (error) {\r\n      console.error('Error uploading files:', error)\r\n      toast.error('Error subiendo los archivos')\r\n    } finally {\r\n      setUploading(false)\r\n    }\r\n  }\r\n\r\n  const handleDeleteFile = async (file) => {\r\n    if (!window.confirm(`¬øEst√°s seguro de que quieres eliminar \"${file.metadata?.name || file.metadata?.file_name || 'este archivo'}\"?`)) {\r\n      return\r\n    }\r\n    \r\n    try {\r\n      // Eliminar de Google Drive si existe\r\n      if (file.google_file_id && userProfile?.google_refresh_token) {\r\n        try {\r\n          await googleDriveService.setTokens({\r\n            refresh_token: userProfile.google_refresh_token\r\n          })\r\n          await googleDriveService.deleteFile(file.google_file_id)\r\n          console.log('Archivo eliminado de Google Drive:', file.google_file_id)\r\n        } catch (error) {\r\n          console.error('Error deleting from Google Drive:', error)\r\n        }\r\n      }\r\n      \r\n      // Eliminar de documentos_usuario_entrenador\r\n      const { error: userTrainerDeleteError } = await supabase\r\n        .from('documentos_usuario_entrenador')\r\n        .delete()\r\n        .eq('id', file.id)\r\n      \r\n      if (userTrainerDeleteError) throw userTrainerDeleteError\r\n      \r\n      // Tambi√©n eliminar todos los chunks relacionados de documentos_entrenador\r\n      if (file.google_file_id) {\r\n        const { error: chunksDeleteError } = await supabase\r\n          .from('documentos_entrenador')\r\n          .delete()\r\n          .eq('metadata->>file_id', file.google_file_id)\r\n        \r\n        if (chunksDeleteError) {\r\n          console.error('Error eliminando chunks de documentos_entrenador:', chunksDeleteError)\r\n          // No lanzamos error para no interrumpir el flujo principal\r\n        }\r\n      }\r\n      \r\n      // Las estad√≠sticas de almacenamiento se actualizar√°n autom√°ticamente\r\n      // ya que se calculan desde documentos_entrenador en el dashboard\r\n      \r\n      // Recargar archivos\r\n      await loadFiles(selectedFolder)\r\n      toast.success('Archivo eliminado exitosamente')\r\n      \r\n    } catch (error) {\r\n      console.error('Error deleting file:', error)\r\n      toast.error('Error eliminando el archivo')\r\n    }\r\n  }\r\n\r\n  const getFileIcon = (fileType) => {\r\n    if (fileType?.startsWith('image/')) return PhotoIcon\r\n    if (fileType?.startsWith('video/')) return FilmIcon\r\n    if (fileType?.startsWith('audio/')) return MusicalNoteIcon\r\n    if (fileType?.includes('pdf') || fileType?.includes('document')) return DocumentTextIcon\r\n    if (fileType?.includes('zip') || fileType?.includes('rar')) return ArchiveBoxIcon\r\n    return DocumentIcon\r\n  }\r\n\r\n  const formatFileSize = (bytes) => {\r\n    if (!bytes) return '0 B'\r\n    const k = 1024\r\n    const sizes = ['B', 'KB', 'MB', 'GB']\r\n    const i = Math.floor(Math.log(bytes) / Math.log(k))\r\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]\r\n  }\r\n\r\n  const formatDate = (dateString) => {\r\n    if (!dateString) return 'N/A'\r\n    return new Date(dateString).toLocaleDateString('es-ES', {\r\n      year: 'numeric',\r\n      month: 'short',\r\n      day: 'numeric',\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    })\r\n  }\r\n\r\n  const filteredAndSortedFiles = files\r\n    .filter(file => {\r\n      const fileName = file.metadata?.name || file.metadata?.file_name || ''\r\n      const fileType = file.metadata?.file_type || ''\r\n      const matchesSearch = fileName.toLowerCase().includes(searchTerm.toLowerCase())\r\n      const matchesType = fileTypeFilter === 'all' || \r\n        (fileTypeFilter === 'pdf' && (fileType?.includes('pdf') || fileName.toLowerCase().endsWith('.pdf'))) ||\r\n        (fileTypeFilter === 'excel' && (fileType?.includes('spreadsheet') || fileType?.includes('excel') || fileName.toLowerCase().match(/.(xlsx?|xls)$/))) ||\r\n        (fileTypeFilter === 'word' && (fileType?.includes('document') || fileType?.includes('word') || fileName.toLowerCase().match(/.(docx?|doc)$/)))\r\n      return matchesSearch && matchesType\r\n    })\r\n    .sort((a, b) => {\r\n      let aValue, bValue\r\n      \r\n      switch (sortBy) {\r\n        case 'name':\r\n          aValue = (a.metadata?.name || a.metadata?.file_name || '').toLowerCase()\r\n        bValue = (b.metadata?.name || b.metadata?.file_name || '').toLowerCase()\r\n          break\r\n        case 'size':\r\n          aValue = a.metadata?.file_size || 0\r\n          bValue = b.metadata?.file_size || 0\r\n          break\r\n        case 'type':\r\n          aValue = a.metadata?.file_type || ''\r\n          bValue = b.metadata?.file_type || ''\r\n          break\r\n        default: // date\r\n          aValue = new Date(a.created_at || 0)\r\n        bValue = new Date(b.created_at || 0)\r\n      }\r\n      \r\n      if (sortOrder === 'asc') {\r\n        return aValue > bValue ? 1 : -1\r\n      } else {\r\n        return aValue < bValue ? 1 : -1\r\n      }\r\n    })\r\n\r\n\r\n  return (\r\n    <div className=\"space-y-6 responsive-layout\">\r\n      {/* Header */}\r\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold text-gray-900\">Gesti√≥n de Archivos</h1>\r\n          <p className=\"text-gray-600 mt-1\">\r\n            Sube y organiza tus documentos\r\n          </p>\r\n        </div>\r\n        \r\n        <div className=\"action-buttons mt-4 sm:mt-0\">\r\n          <button\r\n            onClick={() => fileInputRef.current?.click()}\r\n            className=\"bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition-colors flex items-center\"\r\n          >\r\n            <CloudArrowUpIcon className=\"h-5 w-5 mr-2\" />\r\n            Subir Archivos\r\n          </button>\r\n          \r\n          {hasExtension('Entrenador') && (\r\n            <button\r\n              onClick={() => setShowRoutineUpload(true)}\r\n              className=\"bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center\"\r\n            >\r\n              <DocumentTextIcon className=\"h-5 w-5 mr-2\" />\r\n              Subir Rutina\r\n            </button>\r\n          )}\r\n        </div>\r\n        \r\n        <input\r\n          ref={fileInputRef}\r\n          type=\"file\"\r\n          multiple\r\n          accept=\".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,text/plain\"\r\n          onChange={handleFileSelect}\r\n          className=\"hidden\"\r\n        />\r\n      </div>\r\n\r\n      {/* Filters */}\r\n      <div className=\"filters-grid\">\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n            Carpeta\r\n          </label>\r\n          <select\r\n            value={selectedFolder}\r\n            onChange={(e) => setSelectedFolder(e.target.value)}\r\n            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\r\n          >\r\n            <option value=\"\">Todas las carpetas</option>\r\n            {folders.map((folder) => (\r\n              <option key={folder.id} value={folder.id}>\r\n                {folder.type === 'admin' ? folder.folder_name : folder.correo || 'Carpeta sin nombre'} ({folder.type === 'admin' ? 'Principal' : 'Usuario'})\r\n              </option>\r\n            ))}\r\n          </select>\r\n        </div>\r\n        \r\n        <div>\r\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n            Tipo de archivo\r\n          </label>\r\n          <select\r\n            value={fileTypeFilter}\r\n            onChange={(e) => setFileTypeFilter(e.target.value)}\r\n            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\r\n          >\r\n            <option value=\"all\">Todos</option>\r\n            <option value=\"pdf\">PDF</option>\r\n            <option value=\"excel\">Excel</option>\r\n            <option value=\"word\">Word</option>\r\n          </select>\r\n        </div>\r\n        \r\n        <div>\r\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n            Ordenar por\r\n          </label>\r\n          <select\r\n            value={sortBy}\r\n            onChange={(e) => setSortBy(e.target.value)}\r\n            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\r\n          >\r\n            <option value=\"date\">Fecha</option>\r\n            <option value=\"name\">Nombre</option>\r\n            <option value=\"size\">Tama√±o</option>\r\n            <option value=\"type\">Tipo</option>\r\n          </select>\r\n        </div>\r\n        \r\n        <div>\r\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n            Orden\r\n          </label>\r\n          <select\r\n            value={sortOrder}\r\n            onChange={(e) => setSortOrder(e.target.value)}\r\n            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\r\n          >\r\n            <option value=\"desc\">Descendente</option>\r\n            <option value=\"asc\">Ascendente</option>\r\n          </select>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Search */}\r\n      <div className=\"search-container\">\r\n        <MagnifyingGlassIcon className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400\" />\r\n        <input\r\n          type=\"text\"\r\n          placeholder=\"Buscar archivos...\"\r\n          value={searchTerm}\r\n          onChange={(e) => setSearchTerm(e.target.value)}\r\n          className=\"pl-10 pr-4 py-2 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\r\n        />\r\n      </div>\r\n\r\n      {/* Drag & Drop Upload */}\r\n      {showDragDropUpload ? (\r\n        <DragDropUpload\r\n          onFilesSelected={handleFileSelect}\r\n          onUpload={handleUpload}\r\n          selectedFolder={selectedFolder}\r\n          folders={folders}\r\n          onFolderChange={setSelectedFolder}\r\n          uploading={uploading}\r\n          uploadProgress={uploadProgress}\r\n          acceptedTypes=\".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt\"\r\n        />\r\n      ) : (\r\n        <div className=\"bg-green-50 border border-green-200 rounded-lg p-6 text-center\">\r\n          <div className=\"flex items-center justify-center mb-3\">\r\n            <div className=\"w-8 h-8 bg-green-500 rounded-full flex items-center justify-center\">\r\n              <svg className=\"w-5 h-5 text-white\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\r\n              </svg>\r\n            </div>\r\n          </div>\r\n          <h3 className=\"text-lg font-medium text-green-800 mb-2\">\r\n            ¬°Archivos subidos exitosamente!\r\n          </h3>\r\n          <p className=\"text-green-600\">\r\n            El √°rea de subida se mostrar√° nuevamente en unos segundos...\r\n          </p>\r\n        </div>\r\n      )}\r\n\r\n      {/* Files List */}\r\n      {loading ? (\r\n        <LoadingSpinner text=\"Cargando archivos...\" />\r\n      ) : filteredAndSortedFiles.length === 0 ? (\r\n        <div className=\"empty-state\">\r\n          <DocumentIcon className=\"mx-auto h-12 w-12 text-gray-400 mb-4\" />\r\n          <h3 className=\"text-lg font-medium text-gray-900 mb-2\">\r\n            {searchTerm || fileTypeFilter !== 'all' ? 'No se encontraron archivos' : 'No hay archivos'}\r\n          </h3>\r\n          <p className=\"text-gray-600 mb-6\">\r\n            {searchTerm || fileTypeFilter !== 'all'\r\n              ? 'Intenta con otros filtros de b√∫squeda'\r\n              : 'Sube tu primer archivo para comenzar'\r\n            }\r\n          </p>\r\n          {!searchTerm && fileTypeFilter === 'all' && (\r\n            <button\r\n              onClick={() => fileInputRef.current?.click()}\r\n              className=\"bg-primary-600 text-white px-6 py-2 rounded-lg hover:bg-primary-700 transition-colors\"\r\n            >\r\n              Subir Primer Archivo\r\n            </button>\r\n          )}\r\n        </div>\r\n      ) : (\r\n        <div className=\"bg-white shadow-sm rounded-lg overflow-hidden card-with-table\">\r\n          {/* Indicador de scroll para m√≥viles */}\r\n          <div className=\"table-scroll-hint\">\r\n            <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 8l4 4m0 0l-4 4m4-4H3\" />\r\n            </svg>\r\n            Desliza horizontalmente para ver m√°s informaci√≥n\r\n          </div>\r\n          \r\n          <div className=\"table-responsive-container scroll-horizontal\">\r\n            <table className=\"min-w-full divide-y divide-gray-200 files-table responsive-table\">\r\n              <thead className=\"bg-gray-50\">\r\n                <tr>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    Archivo\r\n                  </th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    Fecha\r\n                  </th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    Estado\r\n                  </th>\r\n                  <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                    Acciones\r\n                  </th>\r\n                </tr>\r\n              </thead>\r\n              <tbody className=\"bg-white divide-y divide-gray-200\">\r\n                {filteredAndSortedFiles.map((file) => {\r\n                  const FileIcon = getFileIcon(file.metadata?.file_type)\r\n                  \r\n                  return (\r\n                    <tr key={file.id} className=\"hover:bg-gray-50\">\r\n                      <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                        <div className=\"flex items-center\">\r\n                          <FileIcon className=\"h-8 w-8 text-gray-400 mr-3 flex-shrink-0\" />\r\n                          <div className=\"min-w-0 flex-1\">\r\n                            <div className=\"text-sm font-medium text-gray-900 truncate\">\r\n                              {file.metadata?.name || file.metadata?.file_name || 'Sin nombre'}\r\n                            </div>\r\n                            <div className=\"text-sm text-gray-500 truncate\">\r\n                              {file.metadata?.file_type || 'Tipo desconocido'}\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                      </td>\r\n                      <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-900\">\r\n                        {formatDate(file.created_at)}\r\n                      </td>\r\n                      <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                        <div className=\"flex items-center\">\r\n                          <div className={`w-2 h-2 rounded-full mr-2 ${\r\n                            file.synced ? 'bg-green-400' : 'bg-yellow-400'\r\n                          }`} />\r\n                          <span className=\"text-sm text-gray-600\">\r\n                            {file.synced ? 'Sincronizado' : 'Solo local'}\r\n                          </span>\r\n                        </div>\r\n                      </td>\r\n                      <td className=\"px-6 py-4 whitespace-nowrap text-right text-sm font-medium\">\r\n                        <div className=\"flex items-center justify-end space-x-2 action-buttons\">\r\n                          {file.google_file_id && (\r\n                            <a\r\n                              href={`https://drive.google.com/file/d/${file.google_file_id}/view`}\r\n                              target=\"_blank\"\r\n                              rel=\"noopener noreferrer\"\r\n                              className=\"text-blue-600 hover:text-blue-700 p-1\"\r\n                              title=\"Ver documento\"\r\n                            >\r\n                              <EyeIcon className=\"h-4 w-4\" />\r\n                            </a>\r\n                          )}\r\n                          {file.downloadUrl && (\r\n                            <a\r\n                              href={file.downloadUrl}\r\n                              target=\"_blank\"\r\n                              rel=\"noopener noreferrer\"\r\n                              className=\"text-primary-600 hover:text-primary-700 p-1\"\r\n                              title=\"Descargar\"\r\n                            >\r\n                              <ArrowDownTrayIcon className=\"h-4 w-4\" />\r\n                            </a>\r\n                          )}\r\n                          <button\r\n                            onClick={() => handleDeleteFile(file)}\r\n                            className=\"text-red-600 hover:text-red-700 p-1\"\r\n                            title=\"Eliminar\"\r\n                          >\r\n                            <TrashIcon className=\"h-4 w-4\" />\r\n                          </button>\r\n                        </div>\r\n                      </td>\r\n                    </tr>\r\n                  )\r\n                })}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Routine Upload Modal */}\r\n      {showRoutineUpload && (\r\n        <RoutineUpload\r\n          onUploadComplete={() => {\r\n            setShowRoutineUpload(false)\r\n            loadFiles(selectedFolder) // Recargar archivos\r\n          }}\r\n          onClose={() => setShowRoutineUpload(false)}\r\n        />\r\n      )}\r\n\r\n      {/* Upload Modal */}\r\n      {showUploadModal && (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50\">\r\n          <div className=\"bg-white rounded-lg max-w-md w-full p-6 upload-modal\">\r\n            <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">\r\n              Subir Archivos\r\n            </h3>\r\n            \r\n            <div className=\"space-y-4\">\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                  Carpeta de destino\r\n                </label>\r\n                <select\r\n                  value={selectedFolder}\r\n                  onChange={(e) => {\r\n                    console.log('üìÇ Carpeta seleccionada:', e.target.value, typeof e.target.value)\r\n                    setSelectedFolder(e.target.value)\r\n                  }}\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\r\n                >\r\n                  {!selectedFolder && <option value=\"\">Seleccionar carpeta</option>}\r\n                  {folders\r\n                    .filter(folder => {\r\n                      // Filtrar carpetas que tienen nombre v√°lido\r\n                      const name = folder.type === 'admin' ? folder.folder_name : folder.correo\r\n                      return name && name.trim() !== ''\r\n                    })\r\n                    .map((folder) => {\r\n                      const displayName = folder.type === 'admin' \r\n                        ? folder.folder_name \r\n                        : `${folder.correo} (Usuario)`\r\n                      return (\r\n                        <option key={folder.id} value={folder.id}>\r\n                          {displayName}\r\n                        </option>\r\n                      )\r\n                    })}\r\n                </select>\r\n              </div>\r\n              \r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                  Archivos seleccionados ({selectedFiles.length})\r\n                </label>\r\n                <div className=\"max-h-32 overflow-y-auto space-y-1\">\r\n                  {selectedFiles.map((file, index) => (\r\n                    <div key={index} className=\"text-sm text-gray-600 flex items-center justify-between\">\r\n                      <span className=\"truncate\">{file.name}</span>\r\n                      <span className=\"text-xs\">{formatFileSize(file.size)}</span>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n              \r\n              {uploading && (\r\n                <div className=\"space-y-2\">\r\n                  {Object.entries(uploadProgress).map(([fileId, progress]) => (\r\n                    <div key={fileId}>\r\n                      <div className=\"flex justify-between text-sm\">\r\n                        <span>Subiendo...</span>\r\n                        <span>{progress}%</span>\r\n                      </div>\r\n                      <div className=\"w-full bg-gray-200 rounded-full h-2\">\r\n                        <div\r\n                          className=\"bg-primary-600 h-2 rounded-full transition-all duration-300\"\r\n                          style={{ width: `${progress}%` }}\r\n                        />\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </div>\r\n            \r\n            <div className=\"flex space-x-3 mt-6\">\r\n              <button\r\n                onClick={() => {\r\n                  setShowUploadModal(false)\r\n                  setSelectedFiles([])\r\n                  setUploadProgress({})\r\n                }}\r\n                className=\"flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors\"\r\n                disabled={uploading}\r\n              >\r\n                Cancelar\r\n              </button>\r\n              <button\r\n                onClick={handleUpload}\r\n                disabled={uploading || !selectedFolder || selectedFiles.length === 0}\r\n                className=\"flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n              >\r\n                {uploading ? 'Subiendo...' : 'Subir Archivos'}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default Files","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\folders\\Folders.js","messages":[{"ruleId":"no-use-before-define","severity":1,"message":"'loadAdminFolderByDefault' was used before it was defined.","line":39,"column":7,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":39,"endColumn":31},{"ruleId":"no-use-before-define","severity":1,"message":"'loadAvailableSubFolders' was used before it was defined.","line":39,"column":33,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":39,"endColumn":56},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'loadAvailableSubFolders' function makes the dependencies of useEffect Hook (at line 39) change on every render. To fix this, wrap the definition of 'loadAvailableSubFolders' in its own useCallback() Hook.","line":42,"column":9,"nodeType":"VariableDeclarator","endLine":132,"endColumn":4,"suggestions":[{"desc":"Wrap the definition of 'loadAvailableSubFolders' in its own useCallback() Hook.","fix":{"range":[1695,5409],"text":"useCallback(async () => {\r\n    try {\r\n      console.log('üîÑ Iniciando carga de subcarpetas...')\r\n      \r\n      // Realizar ambas consultas en paralelo para mejorar rendimiento\r\n      const [subFoldersResult, userExtensionsResult] = await Promise.all([\r\n        // Consulta de subcarpetas\r\n        supabase\r\n          .from('sub_carpetas_administrador')\r\n          .select('*')\r\n          .eq('administrador_email', user.email),\r\n        // Consulta de extensiones del usuario\r\n        supabase\r\n          .from('plan_extensiones')\r\n          .select(`\r\n            *,\r\n            extensiones (\r\n              id,\r\n              name,\r\n              name_es,\r\n              description,\r\n              description_es,\r\n              price,\r\n              disponible\r\n            )\r\n          `)\r\n          .eq('user_id', user.id)\r\n      ])\r\n      \r\n      let subFolders = subFoldersResult.data\r\n      let error = subFoldersResult.error\r\n      \r\n      // Si no encuentra subcarpetas, intentar con el email del administrador de carpeta_administrador\r\n      if ((!subFolders || subFolders.length === 0) && !error) {\r\n        console.log('üîç No se encontraron subcarpetas, buscando con administrador...')\r\n        const { data: adminData } = await db.adminFolders.getByUser(user.id)\r\n        if (adminData && adminData.length > 0) {\r\n          const adminEmail = adminData[0].administrador\r\n          const result = await supabase\r\n            .from('sub_carpetas_administrador')\r\n            .select('*')\r\n            .eq('administrador_email', adminEmail)\r\n          subFolders = result.data\r\n          error = result.error\r\n        }\r\n      }\r\n      \r\n      if (error) {\r\n        console.error('‚ùå Error loading subfolders:', error)\r\n        return\r\n      }\r\n      \r\n      const userExtensions = userExtensionsResult.data\r\n      if (userExtensionsResult.error) {\r\n        console.error('‚ùå Error loading user extensions:', userExtensionsResult.error)\r\n        return\r\n      }\r\n      \r\n      console.log('üìä Extensiones del usuario:', userExtensions)\r\n      console.log('üìÅ Subcarpetas encontradas:', subFolders)\r\n      \r\n      // Crear mapeo de extensiones activas para mejor rendimiento\r\n      const activeExtensionTypes = new Set(['staffhub']) // StaffHub siempre disponible\r\n      \r\n      userExtensions?.forEach(ext => {\r\n        const extensionName = ext.extensiones?.name_es || ext.extensiones?.name\r\n        if (extensionName === 'Entrenador') activeExtensionTypes.add('entrenador')\r\n        if (extensionName === 'Abogados') activeExtensionTypes.add('abogados')\r\n        if (extensionName === 'Veterinarios') activeExtensionTypes.add('veterinarios')\r\n      })\r\n      \r\n      console.log('üéØ Tipos de extensi√≥n activos:', Array.from(activeExtensionTypes))\r\n      \r\n      // Filtrar subcarpetas seg√∫n extensiones activas del usuario\r\n      const availableSubFolders = (subFolders || []).filter(subfolder => {\r\n        const isAvailable = activeExtensionTypes.has(subfolder.tipo_extension)\r\n        console.log(`üìã Subcarpeta ${subfolder.nombre_subcarpeta} (${subfolder.tipo_extension}): ${isAvailable ? 'DISPONIBLE' : 'NO DISPONIBLE'}`)\r\n        return isAvailable\r\n      })\r\n      \r\n      console.log('‚úÖ Subcarpetas disponibles finales:', availableSubFolders)\r\n      setAvailableSubFolders(availableSubFolders)\r\n      \r\n      // Seleccionar StaffHub por defecto si est√° disponible\r\n      const defaultFolder = availableSubFolders.find(f => f.tipo_extension === 'staffhub') || availableSubFolders[0]\r\n      console.log('üéØ Carpeta por defecto seleccionada:', defaultFolder)\r\n      setSelectedParentFolder(defaultFolder)\r\n    } catch (error) {\r\n      console.error('‚ùå Error loading available subfolders:', error)\r\n    }\r\n  })"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'loadAdminFolderByDefault' function makes the dependencies of useEffect Hook (at line 39) change on every render. To fix this, wrap the definition of 'loadAdminFolderByDefault' in its own useCallback() Hook.","line":135,"column":9,"nodeType":"VariableDeclarator","endLine":168,"endColumn":4,"suggestions":[{"desc":"Wrap the definition of 'loadAdminFolderByDefault' in its own useCallback() Hook.","fix":{"range":[5514,6705],"text":"useCallback(async () => {\r\n    try {\r\n      setLoading(true)\r\n      \r\n      // Obtener la carpeta administrador del usuario\r\n      const { data: adminData, error: adminError } = await db.adminFolders.getByUser(user.id)\r\n      if (adminError) throw adminError\r\n      \r\n      if (adminData && adminData.length > 0) {\r\n        const adminFolder = adminData[0]\r\n        // Establecer la carpeta administrador como carpeta actual\r\n        setCurrentFolder({\r\n          ...adminFolder,\r\n          folder_name: 'Master - StaffHub',\r\n          google_folder_id: adminFolder.id_drive_carpeta,\r\n          type: 'admin'\r\n        })\r\n        setBreadcrumb([\r\n          { name: 'Inicio', id: null },\r\n          { name: 'Master - StaffHub', id: adminFolder.id }\r\n        ])\r\n        \r\n        // Cargar las carpetas de usuario dentro de la carpeta administrador\r\n        await loadFolders(adminFolder.id_drive_carpeta)\r\n      } else {\r\n        // Si no hay carpeta administrador, cargar vista normal\r\n        await loadFolders()\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading admin folder by default:', error)\r\n      // En caso de error, cargar vista normal\r\n      await loadFolders()\r\n    }\r\n  })"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { useAuth } from '../../contexts/AuthContext.js'\r\nimport { db, supabase } from '../../lib/supabase.js'\r\nimport googleDriveService from '../../lib/googleDrive.js'\r\nimport emailService from '../../lib/emailService.js'\r\nimport {\r\n  FolderIcon,\r\n  DocumentIcon,\r\n  PlusIcon,\r\n  TrashIcon,\r\n  MagnifyingGlassIcon,\r\n  UserIcon,\r\n  CalendarIcon\r\n} from '@heroicons/react/24/outline'\r\nimport LoadingSpinner from '../common/LoadingSpinner.js'\r\nimport toast from 'react-hot-toast'\r\n\r\nconst Folders = () => {\r\n  const { user, userProfile } = useAuth()\r\n  const navigate = useNavigate()\r\n  const [folders, setFolders] = useState([])\r\n  const [currentFolder, setCurrentFolder] = useState(null)\r\n  const [breadcrumb, setBreadcrumb] = useState([{ name: 'Inicio', id: null }])\r\n  const [loading, setLoading] = useState(true)\r\n  const [creating, setCreating] = useState(false)\r\n  const [showCreateModal, setShowCreateModal] = useState(false)\r\n  const [newFolderName, setNewFolderName] = useState('')\r\n  const [selectedParentFolder, setSelectedParentFolder] = useState(null)\r\n  const [availableSubFolders, setAvailableSubFolders] = useState([])\r\n\r\n  const [searchTerm, setSearchTerm] = useState('')\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\nuseEffect(() => {\r\n    loadAdminFolderByDefault()\r\n    loadAvailableSubFolders()\r\n  }, [loadAdminFolderByDefault, loadAvailableSubFolders])\r\n\r\n  // Cargar subcarpetas disponibles para selecci√≥n de carpeta padre\r\n  const loadAvailableSubFolders = async () => {\r\n    try {\r\n      console.log('üîÑ Iniciando carga de subcarpetas...')\r\n      \r\n      // Realizar ambas consultas en paralelo para mejorar rendimiento\r\n      const [subFoldersResult, userExtensionsResult] = await Promise.all([\r\n        // Consulta de subcarpetas\r\n        supabase\r\n          .from('sub_carpetas_administrador')\r\n          .select('*')\r\n          .eq('administrador_email', user.email),\r\n        // Consulta de extensiones del usuario\r\n        supabase\r\n          .from('plan_extensiones')\r\n          .select(`\r\n            *,\r\n            extensiones (\r\n              id,\r\n              name,\r\n              name_es,\r\n              description,\r\n              description_es,\r\n              price,\r\n              disponible\r\n            )\r\n          `)\r\n          .eq('user_id', user.id)\r\n      ])\r\n      \r\n      let subFolders = subFoldersResult.data\r\n      let error = subFoldersResult.error\r\n      \r\n      // Si no encuentra subcarpetas, intentar con el email del administrador de carpeta_administrador\r\n      if ((!subFolders || subFolders.length === 0) && !error) {\r\n        console.log('üîç No se encontraron subcarpetas, buscando con administrador...')\r\n        const { data: adminData } = await db.adminFolders.getByUser(user.id)\r\n        if (adminData && adminData.length > 0) {\r\n          const adminEmail = adminData[0].administrador\r\n          const result = await supabase\r\n            .from('sub_carpetas_administrador')\r\n            .select('*')\r\n            .eq('administrador_email', adminEmail)\r\n          subFolders = result.data\r\n          error = result.error\r\n        }\r\n      }\r\n      \r\n      if (error) {\r\n        console.error('‚ùå Error loading subfolders:', error)\r\n        return\r\n      }\r\n      \r\n      const userExtensions = userExtensionsResult.data\r\n      if (userExtensionsResult.error) {\r\n        console.error('‚ùå Error loading user extensions:', userExtensionsResult.error)\r\n        return\r\n      }\r\n      \r\n      console.log('üìä Extensiones del usuario:', userExtensions)\r\n      console.log('üìÅ Subcarpetas encontradas:', subFolders)\r\n      \r\n      // Crear mapeo de extensiones activas para mejor rendimiento\r\n      const activeExtensionTypes = new Set(['staffhub']) // StaffHub siempre disponible\r\n      \r\n      userExtensions?.forEach(ext => {\r\n        const extensionName = ext.extensiones?.name_es || ext.extensiones?.name\r\n        if (extensionName === 'Entrenador') activeExtensionTypes.add('entrenador')\r\n        if (extensionName === 'Abogados') activeExtensionTypes.add('abogados')\r\n        if (extensionName === 'Veterinarios') activeExtensionTypes.add('veterinarios')\r\n      })\r\n      \r\n      console.log('üéØ Tipos de extensi√≥n activos:', Array.from(activeExtensionTypes))\r\n      \r\n      // Filtrar subcarpetas seg√∫n extensiones activas del usuario\r\n      const availableSubFolders = (subFolders || []).filter(subfolder => {\r\n        const isAvailable = activeExtensionTypes.has(subfolder.tipo_extension)\r\n        console.log(`üìã Subcarpeta ${subfolder.nombre_subcarpeta} (${subfolder.tipo_extension}): ${isAvailable ? 'DISPONIBLE' : 'NO DISPONIBLE'}`)\r\n        return isAvailable\r\n      })\r\n      \r\n      console.log('‚úÖ Subcarpetas disponibles finales:', availableSubFolders)\r\n      setAvailableSubFolders(availableSubFolders)\r\n      \r\n      // Seleccionar StaffHub por defecto si est√° disponible\r\n      const defaultFolder = availableSubFolders.find(f => f.tipo_extension === 'staffhub') || availableSubFolders[0]\r\n      console.log('üéØ Carpeta por defecto seleccionada:', defaultFolder)\r\n      setSelectedParentFolder(defaultFolder)\r\n    } catch (error) {\r\n      console.error('‚ùå Error loading available subfolders:', error)\r\n    }\r\n  }\r\n\r\n  // Cargar autom√°ticamente la carpeta administrador por defecto\r\n  const loadAdminFolderByDefault = async () => {\r\n    try {\r\n      setLoading(true)\r\n      \r\n      // Obtener la carpeta administrador del usuario\r\n      const { data: adminData, error: adminError } = await db.adminFolders.getByUser(user.id)\r\n      if (adminError) throw adminError\r\n      \r\n      if (adminData && adminData.length > 0) {\r\n        const adminFolder = adminData[0]\r\n        // Establecer la carpeta administrador como carpeta actual\r\n        setCurrentFolder({\r\n          ...adminFolder,\r\n          folder_name: 'Master - StaffHub',\r\n          google_folder_id: adminFolder.id_drive_carpeta,\r\n          type: 'admin'\r\n        })\r\n        setBreadcrumb([\r\n          { name: 'Inicio', id: null },\r\n          { name: 'Master - StaffHub', id: adminFolder.id }\r\n        ])\r\n        \r\n        // Cargar las carpetas de usuario dentro de la carpeta administrador\r\n        await loadFolders(adminFolder.id_drive_carpeta)\r\n      } else {\r\n        // Si no hay carpeta administrador, cargar vista normal\r\n        await loadFolders()\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading admin folder by default:', error)\r\n      // En caso de error, cargar vista normal\r\n      await loadFolders()\r\n    }\r\n  }\r\n\r\n  const loadFolders = async (parentId = null) => {\r\n    try {\r\n      setLoading(true)\r\n      \r\n      let dbFolders = []\r\n      \r\n      if (parentId) {\r\n        // Si estamos dentro de una carpeta, cargar subcarpetas (carpetas de usuario)\r\n        const { data, error } = await db.userFolders.getByAdministrador(user.email)\r\n        if (error) throw error\r\n        dbFolders = (data || []).map(folder => ({\r\n          ...folder,\r\n          folder_name: folder.correo, // El nombre de la carpeta es el correo\r\n          google_folder_id: folder.id_carpeta_drive,\r\n          type: 'user'\r\n        }))\r\n      } else {\r\n        // Cargar carpeta administrador y carpetas de usuario\r\n        const { data: adminData, error: adminError } = await db.adminFolders.getByUser(user.id)\r\n        if (adminError) throw adminError\r\n        \r\n        const { data: userData, error: userError } = await db.userFolders.getByAdministrador(user.email)\r\n        if (userError) throw userError\r\n        \r\n        // Combinar carpetas admin y de usuario\r\n        const adminFolders = (adminData || []).map(folder => ({\r\n          ...folder,\r\n          folder_name: 'Master - StaffHub',\r\n          google_folder_id: folder.id_drive_carpeta,\r\n          type: 'admin'\r\n        }))\r\n        \r\n        const userFolders = (userData || []).map(folder => ({\r\n          ...folder,\r\n          folder_name: folder.correo,\r\n          google_folder_id: folder.id_carpeta_drive,\r\n          type: 'user'\r\n        }))\r\n        \r\n        dbFolders = [...adminFolders, ...userFolders]\r\n      }\r\n      \r\n      // Si el usuario tiene Google Drive conectado, sincronizar con Drive\r\n      if (userProfile?.google_refresh_token) {\r\n        try {\r\n          const tokenSet = await googleDriveService.setTokens({\r\n            refresh_token: userProfile.google_refresh_token\r\n          })\r\n          \r\n          if (!tokenSet) {\r\n            console.error('Failed to set Google Drive tokens')\r\n            setFolders(dbFolders)\r\n            return\r\n          }\r\n          \r\n          // Obtener carpetas de Google Drive\r\n          const driveFolders = await googleDriveService.listFiles(parentId, 'folder')\r\n          \r\n          // Combinar informaci√≥n de DB y Drive\r\n          const combinedFolders = dbFolders.map(dbFolder => {\r\n            const driveFolder = (driveFolders && Array.isArray(driveFolders)) \r\n              ? driveFolders.find(df => df.id === dbFolder.google_folder_id)\r\n              : null\r\n            return {\r\n              ...dbFolder,\r\n              driveInfo: driveFolder,\r\n              synced: !!driveFolder\r\n            }\r\n          })\r\n          \r\n          setFolders(combinedFolders)\r\n        } catch (error) {\r\n          console.error('Error syncing with Google Drive:', error)\r\n          setFolders(dbFolders.map(folder => ({ ...folder, synced: false })))\r\n        }\r\n      } else {\r\n        setFolders(dbFolders.map(folder => ({ ...folder, synced: false })))\r\n      }\r\n      \r\n    } catch (error) {\r\n      console.error('Error loading folders:', error)\r\n      toast.error('Error cargando las carpetas')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleCreateFolder = async () => {\r\n    if (!newFolderName.trim()) {\r\n      toast.error('El email del cliente es requerido')\r\n      return\r\n    }\r\n    \r\n    if (!isValidEmail(newFolderName)) {\r\n      toast.error('Debes ingresar un email v√°lido')\r\n      return\r\n    }\r\n\r\n    // Evitar crear subcarpetas - solo permitir creaci√≥n en el nivel principal\r\n    if (currentFolder && currentFolder.type === 'user') {\r\n      toast.error('No se pueden crear subcarpetas dentro de carpetas de usuario')\r\n      return\r\n    }\r\n\r\n    setCreating(true)\r\n    \r\n    try {\r\n      // Obtener la carpeta administrador del usuario\r\n      const { data: adminFolder, error: adminError } = await db.adminFolders.getByEmail(user.email)\r\n      \r\n      if (adminError || !adminFolder || adminFolder.length === 0) {\r\n        toast.error('No se encontr√≥ la carpeta administrador. Debes tener un plan activo.')\r\n        setCreating(false)\r\n        return\r\n      }\r\n      \r\n      const adminFolderData = adminFolder[0]\r\n      let googleFolderId = null\r\n      \r\n      // Si tiene Google Drive conectado, crear la carpeta en Drive\r\n      if (userProfile?.google_refresh_token) {\r\n        try {\r\n          const tokenSet = await googleDriveService.setTokens({\r\n            refresh_token: userProfile.google_refresh_token\r\n          })\r\n          \r\n          if (!tokenSet) {\r\n            toast.error('Error inicializando Google Drive')\r\n            setCreating(false)\r\n            return\r\n          }\r\n          \r\n          // Determinar la carpeta padre seg√∫n la selecci√≥n\r\n          let parentFolderId = adminFolderData.id_drive_carpeta // Por defecto, carpeta Master - StaffHub\r\n          \r\n          if (selectedParentFolder && selectedParentFolder.file_id_subcarpeta) {\r\n            parentFolderId = selectedParentFolder.file_id_subcarpeta // Usar subcarpeta seleccionada\r\n          }\r\n          \r\n          // Crear carpeta en Google Drive dentro de la carpeta padre seleccionada\r\n          const driveFolder = await googleDriveService.createFolder(\r\n            newFolderName,\r\n            parentFolderId\r\n          )\r\n          \r\n          googleFolderId = driveFolder.id\r\n          \r\n          // Compartir la carpeta con el email especificado\r\n          await googleDriveService.shareFolder(googleFolderId, newFolderName)\r\n          \r\n          toast.success(`Carpeta creada y compartida con ${newFolderName}`)\r\n        } catch (error) {\r\n          console.error('Error creating folder in Google Drive:', error)\r\n          toast.error('Error creando la carpeta en Google Drive')\r\n          return\r\n        }\r\n      }\r\n      \r\n      // Determinar la extensi√≥n basada en la carpeta padre seleccionada\r\n      let extension = 'StaffHub' // Por defecto\r\n      console.log('üéØ Carpeta padre seleccionada para determinar extensi√≥n:', selectedParentFolder)\r\n      \r\n      if (selectedParentFolder) {\r\n        if (selectedParentFolder.tipo_extension) {\r\n          // Mapear tipo_extension a nombre de extensi√≥n correcto\r\n          const extensionMapping = {\r\n            'staffhub': 'StaffHub',\r\n            'entrenador': 'Entrenador',\r\n            'abogados': 'Abogados',\r\n            'veterinarios': 'Veterinarios'\r\n          }\r\n          extension = extensionMapping[selectedParentFolder.tipo_extension] || selectedParentFolder.tipo_extension\r\n          console.log(`üìã Extensi√≥n determinada por tipo_extension: ${selectedParentFolder.tipo_extension} -> ${extension}`)\r\n        } else if (selectedParentFolder.nombre_subcarpeta) {\r\n          // Extraer extensi√≥n del nombre de la subcarpeta como fallback\r\n          const nombreLower = selectedParentFolder.nombre_subcarpeta.toLowerCase()\r\n          if (nombreLower.includes('entrenador')) {\r\n            extension = 'Entrenador'\r\n          } else if (nombreLower.includes('abogado')) {\r\n            extension = 'Abogados'\r\n          } else if (nombreLower.includes('veterinario')) {\r\n            extension = 'Veterinarios'\r\n          } else if (nombreLower.includes('staffhub')) {\r\n            extension = 'StaffHub'\r\n          }\r\n          console.log(`üìã Extensi√≥n determinada por nombre_subcarpeta: ${selectedParentFolder.nombre_subcarpeta} -> ${extension}`)\r\n        }\r\n      }\r\n      \r\n      console.log(`‚úÖ Extensi√≥n final asignada: ${extension}`)\r\n      \r\n      // Guardar en la tabla carpetas_usuario\r\n      const folderData = {\r\n        telegram_id: userProfile?.telegram_id || null,\r\n        correo: newFolderName, // El nombre de la carpeta ser√° el correo\r\n        id_carpeta_drive: googleFolderId,\r\n        administrador: user.email, // Email del administrador que crea la carpeta\r\n        extension: extension // Campo para identificar la extensi√≥n\r\n      }\r\n      \r\n      console.log('üíæ Datos de carpeta a guardar:', folderData)\r\n      \r\n      const { error } = await db.userFolders.create(folderData)\r\n      \r\n      if (error) {\r\n        console.error('Error saving folder to database:', error)\r\n        toast.error('Error guardando la carpeta')\r\n        return\r\n      }\r\n      \r\n      // Crear usuario autom√°ticamente en la tabla users\r\n      try {\r\n        // Verificar si el usuario ya existe\r\n        const { data: existingUser, error: checkError } = await supabase\r\n          .from('users')\r\n          .select('id')\r\n          .eq('email', newFolderName)\r\n          .single()\r\n        \r\n        if (checkError && checkError.code !== 'PGRST116') {\r\n          console.error('Error checking existing user:', checkError)\r\n        }\r\n        \r\n        // Si el usuario no existe, crearlo\r\n        if (!existingUser) {\r\n          // Extraer el nombre del email (parte antes del @)\r\n          const nameFromEmail = newFolderName.split('@')[0]\r\n          \r\n          const userData = {\r\n            email: newFolderName,\r\n            name: nameFromEmail,\r\n            cliente: true, // Marcar como cliente\r\n            is_active: true,\r\n            registered_via: 'folder_creation',\r\n            used_storage_bytes: 0,\r\n            admin: false,\r\n            onboarding_status: 'completed'\r\n          }\r\n          \r\n          const { error: userError } = await supabase\r\n            .from('users')\r\n            .insert([userData])\r\n          \r\n          if (userError) {\r\n            console.error('Error creating user:', userError)\r\n            // No fallar la creaci√≥n de carpeta si falla la creaci√≥n del usuario\r\n            toast.error('Carpeta creada pero error creando usuario autom√°tico')\r\n          } else {\r\n            console.log('Usuario creado autom√°ticamente:', newFolderName)\r\n            \r\n            // Enviar correo de bienvenida\r\n            try {\r\n              const result = await emailService.sendWelcomeEmail(newFolderName, nameFromEmail, user.id, extension)\r\n              if (result.success) {\r\n                console.log('Correo de bienvenida enviado exitosamente')\r\n                toast.success(`Carpeta creada, usuario registrado y correo de bienvenida enviado a ${newFolderName}`)\r\n              } else {\r\n                console.error('Error enviando correo de bienvenida:', result.error)\r\n                toast.success(`Carpeta creada y usuario registrado. Error enviando correo de bienvenida.`)\r\n              }\r\n            } catch (emailError) {\r\n              console.error('Error en servicio de email:', emailError)\r\n              toast.success(`Carpeta creada y usuario registrado. Error enviando correo de bienvenida.`)\r\n            }\r\n          }\r\n        } else {\r\n          console.log('Usuario ya existe:', newFolderName)\r\n          // Enviar correo de bienvenida tambi√©n para usuarios existentes\r\n          try {\r\n            const nameFromEmail = newFolderName.split('@')[0]\r\n            const result = await emailService.sendWelcomeEmail(newFolderName, nameFromEmail, user.id, extension)\r\n            if (result.success) {\r\n              console.log('Correo de bienvenida enviado a usuario existente')\r\n              toast.success(`Carpeta creada y correo de bienvenida enviado a ${newFolderName}`)\r\n            } else {\r\n              console.error('Error enviando correo de bienvenida:', result.error)\r\n              toast.success(`Carpeta creada exitosamente`)\r\n            }\r\n          } catch (emailError) {\r\n            console.error('Error en servicio de email:', emailError)\r\n            toast.success(`Carpeta creada exitosamente`)\r\n          }\r\n        }\r\n      } catch (userCreationError) {\r\n        console.error('Error in user creation process:', userCreationError)\r\n        // No fallar la creaci√≥n de carpeta si falla la creaci√≥n del usuario\r\n        toast.success('Carpeta creada exitosamente')\r\n      }\r\n      \r\n      // Recargar carpetas\r\n      await loadFolders(currentFolder?.id)\r\n      \r\n      // Limpiar formulario\r\n      setNewFolderName('')\r\n\r\n      setShowCreateModal(false)\r\n      \r\n      // No mostrar mensaje gen√©rico ya que se muestran mensajes espec√≠ficos arriba\r\n      \r\n    } catch (error) {\r\n      console.error('Error creating folder:', error)\r\n      toast.error('Error creando la carpeta')\r\n    } finally {\r\n      setCreating(false)\r\n    }\r\n  }\r\n\r\n  const handleDeleteFolder = async (folder) => {\r\n    if (!window.confirm(`¬øEst√°s seguro de que quieres eliminar la carpeta \"${folder.name}\"?`)) {\r\n      return\r\n    }\r\n    \r\n    try {\r\n      // Eliminar de Google Drive si existe\r\n      if (folder.google_folder_id && userProfile?.google_refresh_token) {\r\n        try {\r\n          await googleDriveService.setTokens({\r\n            refresh_token: userProfile.google_refresh_token\r\n          })\r\n          await googleDriveService.deleteFile(folder.google_folder_id)\r\n        } catch (error) {\r\n          console.error('Error deleting from Google Drive:', error)\r\n        }\r\n      }\r\n      \r\n      // Eliminar de la base de datos\r\n      const { error } = currentFolder\r\n        ? await db.userFolders.delete(folder.id)\r\n        : await db.adminFolders.delete(folder.id)\r\n      \r\n      if (error) {\r\n        console.error('Error deleting folder from database:', error)\r\n        toast.error('Error eliminando la carpeta')\r\n        return\r\n      }\r\n      \r\n      // Eliminar usuario correspondiente de la tabla users si es una carpeta de usuario\r\n      if (currentFolder && folder.type === 'user') {\r\n        try {\r\n          // Buscar el usuario por email (que corresponde al nombre de la carpeta)\r\n          const folderEmail = folder.folder_name || folder.correo\r\n          \r\n          if (folderEmail) {\r\n            const { error: deleteUserError } = await supabase\r\n              .from('users')\r\n              .delete()\r\n              .eq('email', folderEmail)\r\n              .eq('cliente', true) // Solo eliminar usuarios marcados como cliente\r\n            \r\n            if (deleteUserError) {\r\n              console.error('Error deleting user:', deleteUserError)\r\n              // No fallar la eliminaci√≥n de carpeta si falla la eliminaci√≥n del usuario\r\n              toast.error('Carpeta eliminada pero error eliminando usuario autom√°tico')\r\n            } else {\r\n              console.log('Usuario eliminado autom√°ticamente:', folderEmail)\r\n            }\r\n          }\r\n        } catch (userDeletionError) {\r\n          console.error('Error in user deletion process:', userDeletionError)\r\n          // No fallar la eliminaci√≥n de carpeta si falla la eliminaci√≥n del usuario\r\n        }\r\n      }\r\n      \r\n      // Recargar carpetas\r\n      await loadFolders(currentFolder?.id)\r\n      toast.success('Carpeta eliminada exitosamente')\r\n      \r\n    } catch (error) {\r\n      console.error('Error deleting folder:', error)\r\n      toast.error('Error eliminando la carpeta')\r\n    }\r\n  }\r\n\r\n  const handleFolderClick = (folder) => {\r\n    // Redirigir a la pesta√±a de archivos con la carpeta seleccionada\r\n    if (folder.type === 'user') {\r\n      // Navegar a la pesta√±a de archivos con la carpeta preseleccionada\r\n      navigate('/files', { \r\n        state: { \r\n          selectedFolder: folder,\r\n          folderId: folder.google_folder_id,\r\n          folderName: folder.folder_name\r\n        } \r\n      })\r\n    }\r\n  }\r\n\r\n\r\n\r\n  const handleBreadcrumbClick = (index) => {\r\n    // Prevenir navegaci√≥n fuera de la carpeta administrador (√≠ndice 0 es \"Inicio\", √≠ndice 1 es \"Entrenador - StaffHub\")\r\n    if (index < 1) {\r\n      return // No permitir ir m√°s atr√°s que la carpeta administrador\r\n    }\r\n    \r\n    const newBreadcrumb = breadcrumb.slice(0, index + 1)\r\n    const targetFolder = newBreadcrumb[newBreadcrumb.length - 1]\r\n    \r\n    setBreadcrumb(newBreadcrumb)\r\n    \r\n    if (index === 1) {\r\n      // Volver a la carpeta administrador - recargar la vista completa\r\n      loadAdminFolderByDefault()\r\n    } else {\r\n      // Navegar a una subcarpeta espec√≠fica - mostrar vista vac√≠a\r\n      setFolders([])\r\n      const folder = { google_folder_id: targetFolder.id, folder_name: targetFolder.name, type: 'user' }\r\n      setCurrentFolder(folder)\r\n    }\r\n  }\r\n\r\n  const isValidEmail = (email) => {\r\n    const emailRegex = /^[^s@]+@[^s@]+.[^s@]+$/\r\n    return emailRegex.test(email)\r\n  }\r\n\r\n  const filteredFolders = folders.filter(folder =>\r\n    folder.folder_name.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    folder.shared_email?.toLowerCase().includes(searchTerm.toLowerCase())\r\n  )\r\n\r\n  const formatDate = (dateString) => {\r\n    if (!dateString) return 'N/A'\r\n    return new Date(dateString).toLocaleDateString('es-ES', {\r\n      year: 'numeric',\r\n      month: 'short',\r\n      day: 'numeric'\r\n    })\r\n  }\r\n\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold text-gray-900\">Gesti√≥n de Carpetas</h1>\r\n          <p className=\"text-gray-600 mt-1\">\r\n            Organiza y comparte tus carpetas con clientes\r\n          </p>\r\n        </div>\r\n        \r\n        {/* Solo mostrar bot√≥n de Nueva Carpeta en el nivel principal */}\r\n        {(!currentFolder || currentFolder.type !== 'user') && (\r\n          <button\r\n            onClick={() => {\r\n                  loadAvailableSubFolders()\r\n                  setShowCreateModal(true)\r\n                }}\r\n            className=\"mt-4 sm:mt-0 bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition-colors flex items-center\"\r\n          >\r\n            <PlusIcon className=\"h-5 w-5 mr-2\" />\r\n            Nueva Carpeta\r\n          </button>\r\n        )}\r\n      </div>\r\n\r\n      {/* Breadcrumb */}\r\n      <nav className=\"flex\" aria-label=\"Breadcrumb\">\r\n        <ol className=\"flex items-center space-x-2\">\r\n          {breadcrumb.map((item, index) => (\r\n            <li key={index} className=\"flex items-center\">\r\n              {index > 0 && (\r\n                <svg className=\"flex-shrink-0 h-4 w-4 text-gray-400 mx-2\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\r\n                  <path fillRule=\"evenodd\" d=\"M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z\" clipRule=\"evenodd\" />\r\n                </svg>\r\n              )}\r\n              <button\r\n                onClick={() => handleBreadcrumbClick(index)}\r\n                className={`text-sm font-medium ${\r\n                  index === breadcrumb.length - 1\r\n                    ? 'text-gray-500 cursor-default'\r\n                    : 'text-primary-600 hover:text-primary-700'\r\n                }`}\r\n                disabled={index === breadcrumb.length - 1}\r\n              >\r\n                {item.name}\r\n              </button>\r\n            </li>\r\n          ))}\r\n        </ol>\r\n      </nav>\r\n\r\n      {/* Subcarpetas disponibles */}\r\n      {availableSubFolders.length > 0 && (\r\n        <div className=\"bg-gray-50 rounded-lg p-4 mb-6\">\r\n          <h3 className=\"text-sm font-medium text-gray-900 mb-3\">Subcarpetas disponibles</h3>\r\n          <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2\">\r\n            {availableSubFolders.map((subfolder) => (\r\n              <div\r\n                key={subfolder.id}\r\n                className=\"flex items-center p-2 bg-white rounded border border-gray-200 hover:border-primary-300 transition-colors\"\r\n              >\r\n                <FolderIcon className=\"h-4 w-4 text-primary-600 mr-2\" />\r\n                <span className=\"text-sm text-gray-700 truncate\">\r\n                  {subfolder.nombre_subcarpeta}\r\n                </span>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Search */}\r\n      <div className=\"relative mb-6\">\r\n        <MagnifyingGlassIcon className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400\" />\r\n        <input\r\n          type=\"text\"\r\n          placeholder=\"Buscar carpetas...\"\r\n          value={searchTerm}\r\n          onChange={(e) => setSearchTerm(e.target.value)}\r\n          className=\"pl-10 pr-4 py-2 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\r\n        />\r\n      </div>\r\n\r\n\r\n\r\n      {/* Folders Grid */}\r\n      {loading ? (\r\n        <LoadingSpinner text=\"Cargando carpetas...\" />\r\n      ) : filteredFolders.length === 0 ? (\r\n        <div className=\"text-center py-12\">\r\n          <FolderIcon className=\"mx-auto h-12 w-12 text-gray-400 mb-4\" />\r\n          <h3 className=\"text-lg font-medium text-gray-900 mb-2\">\r\n            {searchTerm ? 'No se encontraron carpetas' : 'No hay carpetas'}\r\n          </h3>\r\n          <p className=\"text-gray-600 mb-6\">\r\n            {searchTerm \r\n              ? 'Intenta con otros t√©rminos de b√∫squeda'\r\n              : 'Crea tu primera carpeta para comenzar'\r\n            }\r\n          </p>\r\n          {!searchTerm && (\r\n            <button\r\n              onClick={() => {\r\n                loadAvailableSubFolders()\r\n                setShowCreateModal(true)\r\n              }}\r\n              className=\"bg-primary-600 text-white px-6 py-2 rounded-lg hover:bg-primary-700 transition-colors\"\r\n            >\r\n              Crear Primera Carpeta\r\n            </button>\r\n          )}\r\n        </div>\r\n      ) : (\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n          {filteredFolders.map((folder) => {\r\n            \r\n            return (\r\n            <div\r\n              key={folder.id}\r\n              className=\"bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-all p-6 cursor-pointer\"\r\n            >\r\n              <div className=\"flex items-start justify-between mb-4\">\r\n                <div className=\"flex items-center\">\r\n                  <FolderIcon className=\"h-8 w-8 text-primary-600 mr-3\" />\r\n                  <div>\r\n                    <h3 className=\"font-medium text-gray-900 truncate\">\r\n                      {folder.folder_name}\r\n                    </h3>\r\n                    <div className=\"flex items-center mt-1\">\r\n                      <div className={`w-2 h-2 rounded-full mr-2 ${\r\n                        folder.synced ? 'bg-green-400' : 'bg-yellow-400'\r\n                      }`} />\r\n                      <span className=\"text-xs text-gray-500\">\r\n                        {folder.synced ? 'Sincronizado' : 'Solo local'}\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n                \r\n                <div className=\"flex space-x-2\">\r\n                  <button\r\n                    onClick={() => handleDeleteFolder(folder)}\r\n                    className=\"text-red-600 hover:text-red-700 p-1\"\r\n                    title=\"Eliminar carpeta\"\r\n                  >\r\n                    <TrashIcon className=\"h-4 w-4\" />\r\n                  </button>\r\n                </div>\r\n              </div>\r\n              \r\n              <div className=\"space-y-2 text-sm text-gray-600 mb-4\">\r\n                <div className=\"flex items-center\">\r\n                  <UserIcon className=\"h-4 w-4 mr-2\" />\r\n                  <span className=\"truncate\">{folder.shared_email}</span>\r\n                </div>\r\n                <div className=\"flex items-center\">\r\n                  <CalendarIcon className=\"h-4 w-4 mr-2\" />\r\n                  <span>Creada: {formatDate(folder.created_at)}</span>\r\n                </div>\r\n                {folder.extension && (\r\n                  <div className=\"flex items-center\">\r\n                    <div className={`w-3 h-3 rounded-full mr-2 ${\r\n                      folder.extension === 'Abogados' ? 'bg-blue-500' :\r\n                      folder.extension === 'Entrenador' ? 'bg-green-500' :\r\n                      'bg-purple-500'\r\n                    }`} />\r\n                    <span className=\"text-xs font-medium\">\r\n                      Extensi√≥n: {folder.extension}\r\n                    </span>\r\n                  </div>\r\n                )}\r\n              </div>\r\n              \r\n              <button\r\n                onClick={() => handleFolderClick(folder)}\r\n                className=\"w-full bg-gray-50 hover:bg-gray-100 text-gray-700 py-2 px-4 rounded-lg transition-colors flex items-center justify-center\"\r\n              >\r\n                <DocumentIcon className=\"h-4 w-4 mr-2\" />\r\n                Ver archivos\r\n              </button>\r\n\r\n            </div>\r\n            )\r\n          })}\r\n        </div>\r\n      )}\r\n\r\n      {/* Create Folder Modal */}\r\n      {showCreateModal && (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50\">\r\n          <div className=\"bg-white rounded-lg max-w-md w-full p-6\">\r\n            <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">\r\n              Crear Nueva Carpeta\r\n            </h3>\r\n            \r\n            <div className=\"space-y-4\">\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                  Carpeta padre\r\n                </label>\r\n                <select\r\n                  value={selectedParentFolder?.id || ''}\r\n                  onChange={(e) => {\r\n                    console.log('üîÑ Cambiando carpeta padre a:', e.target.value)\r\n                    if (e.target.value === '') {\r\n                      console.log('üìÅ Carpeta seleccionada: null (ninguna)')\r\n                      setSelectedParentFolder(null)\r\n                    } else {\r\n                      const selectedId = parseInt(e.target.value)\r\n                      const selected = availableSubFolders.find(folder => folder.id === selectedId)\r\n                      console.log('üìÅ Carpeta seleccionada:', selected)\r\n                      setSelectedParentFolder(selected)\r\n                    }\r\n                  }}\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\r\n                >\r\n                  <option value=\"\">Selecciona una carpeta padre</option>\r\n                  {availableSubFolders.map((folder) => {\r\n                    console.log('üéØ Renderizando opci√≥n:', folder)\r\n                    return (\r\n                      <option key={folder.id} value={folder.id}>\r\n                        {folder.nombre_subcarpeta}\r\n                      </option>\r\n                    )\r\n                  })}\r\n                </select>\r\n                <p className=\"text-xs text-gray-500 mt-1\">\r\n                  Selecciona donde crear la nueva carpeta\r\n                </p>\r\n              </div>\r\n              \r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                  Email del cliente\r\n                </label>\r\n                <input\r\n                  type=\"email\"\r\n                  value={newFolderName}\r\n                  onChange={(e) => setNewFolderName(e.target.value)}\r\n                  placeholder=\"cliente@ejemplo.com\"\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\r\n                />\r\n                <p className=\"text-xs text-gray-500 mt-1\">\r\n                  El email ser√° usado como nombre de carpeta y se compartir√° autom√°ticamente\r\n                </p>\r\n              </div>\r\n            </div>\r\n            \r\n            <div className=\"flex space-x-3 mt-6\">\r\n              <button\r\n                onClick={() => {\r\n                  setShowCreateModal(false)\r\n                  setNewFolderName('')\r\n          \r\n                }}\r\n                className=\"flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors\"\r\n                disabled={creating}\r\n              >\r\n                Cancelar\r\n              </button>\r\n              <button\r\n                onClick={handleCreateFolder}\r\n                disabled={creating || !newFolderName.trim() || !isValidEmail(newFolderName)}\r\n                className=\"flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n              >\r\n                {creating ? 'Creando...' : 'Crear Carpeta'}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default Folders","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\gamification\\AchievementNotification.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadUnreadEvents'. Either include it or remove the dependency array.","line":26,"column":6,"nodeType":"ArrayExpression","endLine":26,"endColumn":24,"suggestions":[{"desc":"Update the dependencies array to be: [user, employeeId, loadUnreadEvents]","fix":{"range":[785,803],"text":"[user, employeeId, loadUnreadEvents]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport {\r\n  TrophyIcon,\r\n  XMarkIcon,\r\n  SparklesIcon,\r\n  FireIcon,\r\n  RocketLaunchIcon,\r\n  StarIcon,\r\n  CheckCircleIcon,\r\n  GiftIcon\r\n} from '@heroicons/react/24/outline';\r\nimport gamificationService from '../../services/gamificationService.js';\r\n\r\nconst AchievementNotification = ({ user, employeeId, onDismiss }) => {\r\n  const [events, setEvents] = useState([]);\r\n  const [currentEvent, setCurrentEvent] = useState(null);\r\n  const [isVisible, setIsVisible] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (user && employeeId) {\r\n      loadUnreadEvents();\r\n      // Verificar eventos nuevos cada 30 segundos\r\n      const interval = setInterval(loadUnreadEvents, 30000);\r\n      return () => clearInterval(interval);\r\n    }\r\n  }, [user, employeeId]);\r\n\r\n  const loadUnreadEvents = async () => {\r\n    try {\r\n      const result = await gamificationService.getGamificationEvents(user.id, employeeId, 10);\r\n      if (result.success) {\r\n        const unreadEvents = result.data.filter(event => !event.notification_sent);\r\n        if (unreadEvents.length > 0) {\r\n          setEvents(unreadEvents);\r\n          setCurrentEvent(unreadEvents[0]);\r\n          setIsVisible(true);\r\n          \r\n          // Marcar como le√≠do despu√©s de mostrar\r\n          setTimeout(() => {\r\n            markEventAsRead(unreadEvents[0].id);\r\n          }, 1000);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading unread events:', error);\r\n    }\r\n  };\r\n\r\n  const markEventAsRead = async (eventId) => {\r\n    try {\r\n      await gamificationService.markEventNotified(eventId);\r\n      setEvents(prev => prev.filter(e => e.id !== eventId));\r\n      \r\n      // Mostrar siguiente evento si hay\r\n      const remainingEvents = events.filter(e => e.id !== eventId);\r\n      if (remainingEvents.length > 0) {\r\n        setCurrentEvent(remainingEvents[0]);\r\n        setTimeout(() => {\r\n          markEventAsRead(remainingEvents[0].id);\r\n        }, 1000);\r\n      } else {\r\n        setIsVisible(false);\r\n        setCurrentEvent(null);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error marking event as read:', error);\r\n    }\r\n  };\r\n\r\n  const handleDismiss = () => {\r\n    if (currentEvent) {\r\n      markEventAsRead(currentEvent.id);\r\n    } else {\r\n      setIsVisible(false);\r\n      onDismiss?.();\r\n    }\r\n  };\r\n\r\n  const getEventIcon = (eventType) => {\r\n    switch (eventType) {\r\n      case 'level_up':\r\n        return <RocketLaunchIcon className=\"h-8 w-8 text-white\" />;\r\n      case 'achievement_unlocked':\r\n        return <TrophyIcon className=\"h-8 w-8 text-white\" />;\r\n      case 'streak_milestone':\r\n        return <FireIcon className=\"h-8 w-8 text-white\" />;\r\n      default:\r\n        return <StarIcon className=\"h-8 w-8 text-white\" />;\r\n    }\r\n  };\r\n\r\n  const getEventTitle = (eventType, eventData) => {\r\n    switch (eventType) {\r\n      case 'level_up':\r\n        return `¬°Nivel ${eventData?.new_level || 'Nuevo'} Alcanzado!`;\r\n      case 'achievement_unlocked':\r\n        return `¬°Logro Desbloqueado!`;\r\n      case 'streak_milestone':\r\n        return `¬°Hito de Racha Alcanzado!`;\r\n      default:\r\n        return '¬°Felicidades!';\r\n    }\r\n  };\r\n\r\n  const getEventDescription = (eventType, eventData) => {\r\n    switch (eventType) {\r\n      case 'level_up':\r\n        return `Has alcanzado el nivel ${eventData?.new_level || 'superior'} con ${eventData?.total_points || 0} puntos totales.`;\r\n      case 'achievement_unlocked':\r\n        return `Has desbloqueado: ${eventData?.achievement_name || 'Nuevo logro'} y ganado ${eventData?.points_reward || 0} puntos.`;\r\n      case 'streak_milestone':\r\n        return `¬°Incre√≠ble racha de actividad! Sigue as√≠.`;\r\n      default:\r\n        return 'Sigue as√≠, vas por excelente camino.';\r\n    }\r\n  };\r\n\r\n  const getEventColor = (eventType) => {\r\n    switch (eventType) {\r\n      case 'level_up':\r\n        return 'from-purple-600 to-indigo-600';\r\n      case 'achievement_unlocked':\r\n        return 'from-yellow-500 to-orange-600';\r\n      case 'streak_milestone':\r\n        return 'from-red-500 to-pink-600';\r\n      default:\r\n        return 'from-blue-500 to-cyan-600';\r\n    }\r\n  };\r\n\r\n  if (!isVisible || !currentEvent) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div className=\"fixed top-4 right-4 z-50 max-w-sm animate-pulse\">\r\n      <div className={`bg-gradient-to-r ${getEventColor(currentEvent.event_type)} rounded-2xl shadow-2xl p-6 text-white relative overflow-hidden`}>\r\n        {/* Background decoration */}\r\n        <div className=\"absolute inset-0 bg-white/10\"></div>\r\n        <div className=\"absolute -top-4 -right-4 w-20 h-20 bg-white/10 rounded-full\"></div>\r\n        <div className=\"absolute -bottom-2 -left-2 w-16 h-16 bg-white/10 rounded-full\"></div>\r\n        \r\n        {/* Content */}\r\n        <div className=\"relative z-10\">\r\n          <div className=\"flex items-start justify-between mb-4\">\r\n            <div className=\"flex items-center space-x-3\">\r\n              <div className=\"bg-white/20 p-3 rounded-xl\">\r\n                {getEventIcon(currentEvent.event_type)}\r\n              </div>\r\n              <div>\r\n                <h3 className=\"text-lg font-bold\">\r\n                  {getEventTitle(currentEvent.event_type, currentEvent.event_data)}\r\n                </h3>\r\n                <p className=\"text-sm text-white/90\">\r\n                  {new Date(currentEvent.created_at).toLocaleDateString('es-ES', {\r\n                    hour: '2-digit',\r\n                    minute: '2-digit'\r\n                  })}\r\n                </p>\r\n              </div>\r\n            </div>\r\n            <button\r\n              onClick={handleDismiss}\r\n              className=\"text-white/70 hover:text-white transition-colors p-1\"\r\n            >\r\n              <XMarkIcon className=\"h-5 w-5\" />\r\n            </button>\r\n          </div>\r\n          \r\n          <p className=\"text-white/95 mb-4\">\r\n            {getEventDescription(currentEvent.event_type, currentEvent.event_data)}\r\n          </p>\r\n          \r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center space-x-2\">\r\n              <SparklesIcon className=\"h-4 w-4 text-yellow-300\" />\r\n              <span className=\"text-sm font-medium\">\r\n                {currentEvent.event_type === 'achievement_unlocked' && \r\n                  `+${currentEvent.event_data?.points_reward || 0} puntos`}\r\n                {currentEvent.event_type === 'level_up' && \r\n                  `Nivel ${currentEvent.event_data?.new_level || 'Superior'}`}\r\n                {currentEvent.event_type === 'streak_milestone' && \r\n                  '¬°Racha mantenido!'}\r\n              </span>\r\n            </div>\r\n            <button\r\n              onClick={handleDismiss}\r\n              className=\"bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg text-sm font-medium transition-colors\"\r\n            >\r\n              ¬°Genial!\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\n// Componente para mostrar notificaciones de puntos\r\nexport const PointsNotification = ({ points, activity, isVisible, onDismiss }) => {\r\n  if (!isVisible) return null;\r\n\r\n  const getActivityIcon = (activityType) => {\r\n    switch (activityType) {\r\n      case 'message_sent':\r\n        return <GiftIcon className=\"h-5 w-5 text-green-600\" />;\r\n      case 'message_read':\r\n        return <CheckCircleIcon className=\"h-5 w-5 text-blue-600\" />;\r\n      case 'file_uploaded':\r\n        return <StarIcon className=\"h-5 w-5 text-purple-600\" />;\r\n      case 'daily_login':\r\n        return <FireIcon className=\"h-5 w-5 text-orange-600\" />;\r\n      default:\r\n        return <SparklesIcon className=\"h-5 w-5 text-indigo-600\" />;\r\n    }\r\n  };\r\n\r\n  const getActivityText = (activityType) => {\r\n    switch (activityType) {\r\n      case 'message_sent':\r\n        return 'Mensaje enviado';\r\n      case 'message_read':\r\n        return 'Mensaje le√≠do';\r\n      case 'file_uploaded':\r\n        return 'Archivo subido';\r\n      case 'daily_login':\r\n        return 'Inicio de sesi√≥n diario';\r\n      default:\r\n        return 'Actividad completada';\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"fixed bottom-4 right-4 z-40 animate-bounce\">\r\n      <div className=\"bg-white rounded-2xl shadow-2xl p-4 border-2 border-green-200 flex items-center space-x-3\">\r\n        <div className=\"bg-green-100 p-2 rounded-xl\">\r\n          {getActivityIcon(activity)}\r\n        </div>\r\n        <div className=\"flex-1\">\r\n          <p className=\"text-sm font-medium text-gray-900\">\r\n            +{points} puntos - {getActivityText(activity)}\r\n          </p>\r\n        </div>\r\n        <button\r\n          onClick={onDismiss}\r\n          className=\"text-gray-400 hover:text-gray-600 transition-colors\"\r\n        >\r\n          <XMarkIcon className=\"h-4 w-4\" />\r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\n// Hook personalizado para manejar notificaciones de gamificaci√≥n\r\nexport const useGamificationNotifications = (user, employeeId) => {\r\n  const [pointsNotification, setPointsNotification] = useState({\r\n    isVisible: false,\r\n    points: 0,\r\n    activity: ''\r\n  });\r\n\r\n  const showPointsNotification = (points, activity) => {\r\n    setPointsNotification({\r\n      isVisible: true,\r\n      points,\r\n      activity\r\n    });\r\n\r\n    // Auto ocultar despu√©s de 3 segundos\r\n    setTimeout(() => {\r\n      setPointsNotification(prev => ({ ...prev, isVisible: false }));\r\n    }, 3000);\r\n  };\r\n\r\n  const hidePointsNotification = () => {\r\n    setPointsNotification(prev => ({ ...prev, isVisible: false }));\r\n  };\r\n\r\n  return {\r\n    pointsNotification,\r\n    showPointsNotification,\r\n    hidePointsNotification\r\n  };\r\n};\r\n\r\nexport default AchievementNotification;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\gamification\\GamificationDashboard.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'StarIcon' is defined but never used.","line":4,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":11},{"ruleId":"no-unused-vars","severity":1,"message":"'ClockIcon' is defined but never used.","line":9,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'BellIcon' is defined but never used.","line":14,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":11},{"ruleId":"no-unused-vars","severity":1,"message":"'CurrencyDollarIcon' is defined but never used.","line":15,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":21},{"ruleId":"no-unused-vars","severity":1,"message":"'AcademicCapIcon' is defined but never used.","line":16,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'Bar' is defined but never used.","line":32,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadGamificationData'. Either include it or remove the dependency array.","line":67,"column":6,"nodeType":"ArrayExpression","endLine":67,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [loadGamificationData, user]","fix":{"range":[1682,1688],"text":"[loadGamificationData, user]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport {\r\n  TrophyIcon,\r\n  StarIcon,\r\n  FireIcon,\r\n  ChartBarIcon,\r\n  GiftIcon,\r\n  UserGroupIcon,\r\n  ClockIcon,\r\n  ArrowTrendingUpIcon,\r\n  SparklesIcon,\r\n  CheckCircleIcon,\r\n  XMarkIcon,\r\n  BellIcon,\r\n  CurrencyDollarIcon,\r\n  AcademicCapIcon,\r\n  RocketLaunchIcon,\r\n  HeartIcon\r\n} from '@heroicons/react/24/outline';\r\nimport {\r\n  Chart as ChartJS,\r\n  CategoryScale,\r\n  LinearScale,\r\n  PointElement,\r\n  LineElement,\r\n  BarElement,\r\n  Title,\r\n  Tooltip,\r\n  Legend,\r\n  ArcElement,\r\n} from 'chart.js';\r\nimport { Line, Bar, Doughnut } from 'react-chartjs-2';\r\nimport toast from 'react-hot-toast';\r\nimport gamificationService from '../../services/gamificationService.js';\r\nimport { useAuth } from '../../contexts/AuthContext.js';\r\n\r\n// Register Chart.js components\r\nChartJS.register(\r\n  CategoryScale,\r\n  LinearScale,\r\n  PointElement,\r\n  LineElement,\r\n  BarElement,\r\n  Title,\r\n  Tooltip,\r\n  Legend,\r\n  ArcElement\r\n);\r\n\r\nconst GamificationDashboard = () => {\r\n  const { user } = useAuth();\r\n  const [loading, setLoading] = useState(true);\r\n  const [gamificationData, setGamificationData] = useState(null);\r\n  const [achievements, setAchievements] = useState([]);\r\n  const [leaderboard, setLeaderboard] = useState([]);\r\n  const [rewards, setRewards] = useState([]);\r\n  const [predictions, setPredictions] = useState([]);\r\n  const [events, setEvents] = useState([]);\r\n  const [activeTab, setActiveTab] = useState('overview');\r\n  const [showRewardModal, setShowRewardModal] = useState(false);\r\n  const [selectedReward, setSelectedReward] = useState(null);\r\n\r\n  useEffect(() => {\r\n    if (user) {\r\n      loadGamificationData();\r\n    }\r\n  }, [user]);\r\n\r\n  const loadGamificationData = async () => {\r\n    try {\r\n      setLoading(true);\r\n      \r\n      // Cargar datos principales de gamificaci√≥n\r\n      const gamificationResult = await gamificationService.getEmployeeGamification(\r\n        user.id, \r\n        user.employee_id\r\n      );\r\n      \r\n      if (gamificationResult.success) {\r\n        setGamificationData(gamificationResult.data);\r\n        setAchievements(gamificationResult.data.achievements || []);\r\n      }\r\n\r\n      // Cargar datos adicionales en paralelo\r\n      const [leaderboardResult, rewardsResult, predictionsResult, eventsResult] = await Promise.all([\r\n        gamificationService.getLeaderboard('weekly', 'points', 10),\r\n        gamificationService.getAvailableRewards(),\r\n        gamificationService.getEngagementPredictions(user.id, user.employee_id, 7),\r\n        gamificationService.getGamificationEvents(user.id, user.employee_id, 10)\r\n      ]);\r\n\r\n      if (leaderboardResult.success) setLeaderboard(leaderboardResult.data);\r\n      if (rewardsResult.success) setRewards(rewardsResult.data);\r\n      if (predictionsResult.success) setPredictions(predictionsResult.data);\r\n      if (eventsResult.success) setEvents(eventsResult.data);\r\n\r\n    } catch (error) {\r\n      console.error('Error loading gamification data:', error);\r\n      toast.error('Error al cargar datos de gamificaci√≥n');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleRedeemReward = async (reward) => {\r\n    try {\r\n      setSelectedReward(reward);\r\n      setShowRewardModal(true);\r\n    } catch (error) {\r\n      console.error('Error preparing reward redemption:', error);\r\n      toast.error('Error al preparar canje de recompensa');\r\n    }\r\n  };\r\n\r\n  const confirmRedeemReward = async () => {\r\n    try {\r\n      const result = await gamificationService.redeemReward(\r\n        user.id,\r\n        user.employee_id,\r\n        selectedReward.id\r\n      );\r\n\r\n      if (result.success) {\r\n        toast.success(`¬°Has canjeado ${selectedReward.name}!`);\r\n        setShowRewardModal(false);\r\n        setSelectedReward(null);\r\n        loadGamificationData(); // Recargar datos\r\n      } else {\r\n        toast.error(result.error || 'Error al canjear recompensa');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error redeeming reward:', error);\r\n      toast.error('Error al canjear recompensa');\r\n    }\r\n  };\r\n\r\n  const generateEngagementPrediction = async () => {\r\n    try {\r\n      const result = await gamificationService.generateEngagementPrediction(\r\n        user.id,\r\n        user.employee_id\r\n      );\r\n\r\n      if (result.success) {\r\n        toast.success('Predicci√≥n de engagement generada');\r\n        setPredictions(prev => [result.data, ...prev]);\r\n      } else {\r\n        toast.error('Error al generar predicci√≥n');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error generating prediction:', error);\r\n      toast.error('Error al generar predicci√≥n');\r\n    }\r\n  };\r\n\r\n  const getRiskLevelColor = (riskLevel) => {\r\n    switch (riskLevel) {\r\n      case 'low': return 'text-green-600 bg-green-100';\r\n      case 'medium': return 'text-yellow-600 bg-yellow-100';\r\n      case 'high': return 'text-orange-600 bg-orange-100';\r\n      case 'critical': return 'text-red-600 bg-red-100';\r\n      default: return 'text-gray-600 bg-gray-100';\r\n    }\r\n  };\r\n\r\n  const getBadgeColor = (badgeType) => {\r\n    switch (badgeType) {\r\n      case 'bronze': return 'bg-amber-100 text-amber-800 border-amber-300';\r\n      case 'silver': return 'bg-gray-100 text-gray-800 border-gray-300';\r\n      case 'gold': return 'bg-yellow-100 text-yellow-800 border-yellow-300';\r\n      case 'platinum': return 'bg-purple-100 text-purple-800 border-purple-300';\r\n      case 'diamond': return 'bg-blue-100 text-blue-800 border-blue-300';\r\n      default: return 'bg-gray-100 text-gray-800 border-gray-300';\r\n    }\r\n  };\r\n\r\n  // Datos para gr√°ficos\r\n  const engagementChartData = {\r\n    labels: predictions.slice(0, 7).map(p => new Date(p.prediction_date).toLocaleDateString('es-ES', { day: 'short', month: 'short' })),\r\n    datasets: [{\r\n      label: 'Score de Engagement',\r\n      data: predictions.slice(0, 7).map(p => p.predicted_engagement_score),\r\n      borderColor: 'rgb(59, 130, 246)',\r\n      backgroundColor: 'rgba(59, 130, 246, 0.1)',\r\n      tension: 0.4,\r\n      fill: true,\r\n    }]\r\n  };\r\n\r\n  const achievementsByCategory = {\r\n    communication: achievements.filter(a => a.category === 'communication').length,\r\n    engagement: achievements.filter(a => a.category === 'engagement').length,\r\n    learning: achievements.filter(a => a.category === 'learning').length,\r\n    collaboration: achievements.filter(a => a.category === 'collaboration').length,\r\n  };\r\n\r\n  const categoryChartData = {\r\n    labels: ['Comunicaci√≥n', 'Engagement', 'Aprendizaje', 'Colaboraci√≥n'],\r\n    datasets: [{\r\n      data: [\r\n        achievementsByCategory.communication,\r\n        achievementsByCategory.engagement,\r\n        achievementsByCategory.learning,\r\n        achievementsByCategory.collaboration\r\n      ],\r\n      backgroundColor: [\r\n        'rgba(59, 130, 246, 0.8)',\r\n        'rgba(16, 185, 129, 0.8)',\r\n        'rgba(251, 146, 60, 0.8)',\r\n        'rgba(139, 92, 246, 0.8)'\r\n      ],\r\n      borderWidth: 0,\r\n    }]\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-white flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <SparklesIcon className=\"h-12 w-12 text-indigo-600 animate-spin mx-auto\" />\r\n          <p className=\"mt-4 text-gray-600 font-medium\">Cargando gamificaci√≥n...</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!gamificationData) {\r\n    return (\r\n      <div className=\"min-h-screen bg-white flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <TrophyIcon className=\"h-16 w-16 text-gray-400 mx-auto mb-4\" />\r\n          <p className=\"text-gray-600\">No hay datos de gamificaci√≥n disponibles</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50\">\r\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\r\n        {/* Header */}\r\n        <div className=\"bg-gradient-to-r from-indigo-600 to-purple-600 rounded-3xl shadow-2xl p-8 mb-8 text-white relative overflow-hidden\">\r\n          <div className=\"absolute inset-0 bg-black/10\"></div>\r\n          <div className=\"relative z-10\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <h1 className=\"text-4xl font-bold mb-2\">Centro de Gamificaci√≥n</h1>\r\n                <p className=\"text-indigo-100 text-lg\">Tu progreso y logros en la plataforma</p>\r\n              </div>\r\n              <div className=\"text-right\">\r\n                <div className=\"text-3xl font-bold\">{gamificationData.total_points || 0}</div>\r\n                <div className=\"text-indigo-100\">Puntos Totales</div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Tabs Navigation */}\r\n        <div className=\"bg-white rounded-2xl shadow-lg p-2 mb-8 flex space-x-2\">\r\n          {[\r\n            { id: 'overview', label: 'Resumen', icon: ChartBarIcon },\r\n            { id: 'achievements', label: 'Logros', icon: TrophyIcon },\r\n            { id: 'leaderboard', label: 'Clasificaci√≥n', icon: UserGroupIcon },\r\n            { id: 'rewards', label: 'Recompensas', icon: GiftIcon },\r\n            { id: 'predictions', label: 'Predicciones', icon: ArrowTrendingUpIcon }\r\n          ].map(tab => (\r\n            <button\r\n              key={tab.id}\r\n              onClick={() => setActiveTab(tab.id)}\r\n              className={`flex-1 flex items-center justify-center px-4 py-3 rounded-xl font-medium transition-all duration-200 ${\r\n                activeTab === tab.id\r\n                  ? 'bg-indigo-600 text-white shadow-lg'\r\n                  : 'text-gray-600 hover:bg-gray-100'\r\n              }`}\r\n            >\r\n              <tab.icon className=\"h-5 w-5 mr-2\" />\r\n              {tab.label}\r\n            </button>\r\n          ))}\r\n        </div>\r\n\r\n        {/* Overview Tab */}\r\n        {activeTab === 'overview' && (\r\n          <div className=\"space-y-8\">\r\n            {/* Stats Cards */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\r\n              <div className=\"bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-6 text-white\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <p className=\"text-blue-100 text-sm\">Nivel Actual</p>\r\n                    <p className=\"text-3xl font-bold\">{gamificationData.current_level || 1}</p>\r\n                    <p className=\"text-blue-100 text-xs mt-1\">{gamificationData.gamification_levels?.name || 'Novato'}</p>\r\n                  </div>\r\n                  <div className=\"bg-white/20 p-3 rounded-xl\">\r\n                    <RocketLaunchIcon className=\"h-8 w-8 text-white\" />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-6 text-white\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <p className=\"text-green-100 text-sm\">Racha Actual</p>\r\n                    <p className=\"text-3xl font-bold\">{gamificationData.streak_days || 0}</p>\r\n                    <p className=\"text-green-100 text-xs mt-1\">d√≠as consecutivos</p>\r\n                  </div>\r\n                  <div className=\"bg-white/20 p-3 rounded-xl\">\r\n                    <FireIcon className=\"h-8 w-8 text-white\" />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"bg-gradient-to-br from-purple-500 to-violet-600 rounded-2xl p-6 text-white\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <p className=\"text-purple-100 text-sm\">Logros</p>\r\n                    <p className=\"text-3xl font-bold\">{achievements.length}</p>\r\n                    <p className=\"text-purple-100 text-xs mt-1\">desbloqueados</p>\r\n                  </div>\r\n                  <div className=\"bg-white/20 p-3 rounded-xl\">\r\n                    <TrophyIcon className=\"h-8 w-8 text-white\" />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"bg-gradient-to-br from-orange-500 to-red-600 rounded-2xl p-6 text-white\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <p className=\"text-orange-100 text-sm\">Engagement</p>\r\n                    <p className=\"text-3xl font-bold\">{Math.round(gamificationData.engagement_score || 0)}%</p>\r\n                    <p className=\"text-orange-100 text-xs mt-1\">score actual</p>\r\n                  </div>\r\n                  <div className=\"bg-white/20 p-3 rounded-xl\">\r\n                    <HeartIcon className=\"h-8 w-8 text-white\" />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Progress and Charts */}\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8\">\r\n              {/* Level Progress */}\r\n              <div className=\"bg-white rounded-2xl shadow-lg p-6\">\r\n                <h3 className=\"text-xl font-bold text-gray-900 mb-4\">Progreso al Siguiente Nivel</h3>\r\n                <div className=\"space-y-4\">\r\n                  <div>\r\n                    <div className=\"flex justify-between text-sm text-gray-600 mb-2\">\r\n                      <span>Nivel {gamificationData.current_level || 1}</span>\r\n                      <span>Nivel {(gamificationData.current_level || 1) + 1}</span>\r\n                    </div>\r\n                    <div className=\"w-full bg-gray-200 rounded-full h-4\">\r\n                      <div \r\n                        className=\"bg-gradient-to-r from-indigo-500 to-purple-600 h-4 rounded-full transition-all duration-500\"\r\n                        style={{ \r\n                          width: `${Math.min(100, ((gamificationData.current_level_points || 0) / 100) * 100)}%` \r\n                        }}\r\n                      ></div>\r\n                    </div>\r\n                    <p className=\"text-sm text-gray-600 mt-2\">\r\n                      {gamificationData.current_level_points || 0} / 100 puntos para el siguiente nivel\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Achievement Categories */}\r\n              <div className=\"bg-white rounded-2xl shadow-lg p-6\">\r\n                <h3 className=\"text-xl font-bold text-gray-900 mb-4\">Logros por Categor√≠a</h3>\r\n                <div className=\"h-64\">\r\n                  <Doughnut\r\n                    data={categoryChartData}\r\n                    options={{\r\n                      responsive: true,\r\n                      maintainAspectRatio: false,\r\n                      plugins: {\r\n                        legend: {\r\n                          position: 'bottom',\r\n                        },\r\n                      },\r\n                    }}\r\n                  />\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Recent Events */}\r\n            <div className=\"bg-white rounded-2xl shadow-lg p-6\">\r\n              <h3 className=\"text-xl font-bold text-gray-900 mb-4\">Eventos Recientes</h3>\r\n              <div className=\"space-y-3\">\r\n                {events.length > 0 ? (\r\n                  events.slice(0, 5).map(event => (\r\n                    <div key={event.id} className=\"flex items-center justify-between p-3 bg-gray-50 rounded-lg\">\r\n                      <div className=\"flex items-center space-x-3\">\r\n                        <div className=\"bg-indigo-100 p-2 rounded-lg\">\r\n                          {event.event_type === 'level_up' && <RocketLaunchIcon className=\"h-5 w-5 text-indigo-600\" />}\r\n                          {event.event_type === 'achievement_unlocked' && <TrophyIcon className=\"h-5 w-5 text-indigo-600\" />}\r\n                          {event.event_type === 'streak_milestone' && <FireIcon className=\"h-5 w-5 text-indigo-600\" />}\r\n                        </div>\r\n                        <div>\r\n                          <p className=\"font-medium text-gray-900\">\r\n                            {event.event_type === 'level_up' && '¬°Nuevo nivel alcanzado!'}\r\n                            {event.event_type === 'achievement_unlocked' && '¬°Logro desbloqueado!'}\r\n                            {event.event_type === 'streak_milestone' && '¬°Hito de racha alcanzado!'}\r\n                          </p>\r\n                          <p className=\"text-sm text-gray-600\">\r\n                            {new Date(event.created_at).toLocaleDateString('es-ES', { \r\n                              day: 'numeric', \r\n                              month: 'short', \r\n                              hour: '2-digit', \r\n                              minute: '2-digit' \r\n                            })}\r\n                          </p>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  ))\r\n                ) : (\r\n                  <p className=\"text-gray-500 text-center py-8\">No hay eventos recientes</p>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Achievements Tab */}\r\n        {activeTab === 'achievements' && (\r\n          <div className=\"space-y-8\">\r\n            <div className=\"bg-white rounded-2xl shadow-lg p-6\">\r\n              <h3 className=\"text-2xl font-bold text-gray-900 mb-6\">Tus Logros</h3>\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n                {achievements.length > 0 ? (\r\n                  achievements.map(achievement => (\r\n                    <div key={achievement.id} className=\"border-2 border-gray-200 rounded-xl p-6 hover:shadow-lg transition-shadow\">\r\n                      <div className=\"flex items-center justify-between mb-4\">\r\n                        <span className=\"text-3xl\">{achievement.icon}</span>\r\n                        <span className={`px-3 py-1 rounded-full text-xs font-medium border ${getBadgeColor(achievement.badge_type)}`}>\r\n                          {achievement.badge_type}\r\n                        </span>\r\n                      </div>\r\n                      <h4 className=\"font-bold text-gray-900 mb-2\">{achievement.name}</h4>\r\n                      <p className=\"text-sm text-gray-600 mb-3\">{achievement.description}</p>\r\n                      <div className=\"flex items-center justify-between\">\r\n                        <span className=\"text-sm font-medium text-indigo-600\">+{achievement.points_reward} pts</span>\r\n                        <CheckCircleIcon className=\"h-5 w-5 text-green-500\" />\r\n                      </div>\r\n                    </div>\r\n                  ))\r\n                ) : (\r\n                  <div className=\"col-span-full text-center py-12\">\r\n                    <TrophyIcon className=\"h-16 w-16 text-gray-300 mx-auto mb-4\" />\r\n                    <p className=\"text-gray-500\">No tienes logros desbloqueados a√∫n</p>\r\n                    <p className=\"text-sm text-gray-400 mt-2\">¬°Sigue participando para desbloquear tu primer logro!</p>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Leaderboard Tab */}\r\n        {activeTab === 'leaderboard' && (\r\n          <div className=\"space-y-8\">\r\n            <div className=\"bg-white rounded-2xl shadow-lg p-6\">\r\n              <h3 className=\"text-2xl font-bold text-gray-900 mb-6\">Tabla de Clasificaci√≥n Semanal</h3>\r\n              <div className=\"space-y-4\">\r\n                {leaderboard.length > 0 ? (\r\n                  leaderboard.map((entry, index) => {\r\n                    const isCurrentUser = entry.user_id === user.id;\r\n                    return (\r\n                      <div \r\n                        key={entry.id} \r\n                        className={`flex items-center justify-between p-4 rounded-xl border-2 ${\r\n                          isCurrentUser \r\n                            ? 'border-indigo-500 bg-indigo-50' \r\n                            : 'border-gray-200 hover:border-gray-300'\r\n                        }`}\r\n                      >\r\n                        <div className=\"flex items-center space-x-4\">\r\n                          <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${\r\n                            index === 0 ? 'bg-yellow-500 text-white' :\r\n                            index === 1 ? 'bg-gray-400 text-white' :\r\n                            index === 2 ? 'bg-amber-600 text-white' :\r\n                            'bg-gray-200 text-gray-700'\r\n                          }`}>\r\n                            {index + 1}\r\n                          </div>\r\n                          <div>\r\n                            <p className=\"font-bold text-gray-900\">\r\n                              {entry.companies?.name || 'Usuario'}\r\n                              {isCurrentUser && ' (T√∫)'}\r\n                            </p>\r\n                            <p className=\"text-sm text-gray-600\">\r\n                              {entry.companies?.department} ‚Ä¢ {entry.companies?.position}\r\n                            </p>\r\n                          </div>\r\n                        </div>\r\n                        <div className=\"text-right\">\r\n                          <p className=\"text-2xl font-bold text-indigo-600\">{entry.score}</p>\r\n                          <p className=\"text-sm text-gray-600\">puntos</p>\r\n                        </div>\r\n                      </div>\r\n                    );\r\n                  })\r\n                ) : (\r\n                  <p className=\"text-gray-500 text-center py-8\">No hay datos de clasificaci√≥n disponibles</p>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Rewards Tab */}\r\n        {activeTab === 'rewards' && (\r\n          <div className=\"space-y-8\">\r\n            <div className=\"bg-white rounded-2xl shadow-lg p-6\">\r\n              <div className=\"flex items-center justify-between mb-6\">\r\n                <h3 className=\"text-2xl font-bold text-gray-900\">Recompensas Disponibles</h3>\r\n                <div className=\"text-right\">\r\n                  <p className=\"text-sm text-gray-600\">Tus puntos</p>\r\n                  <p className=\"text-2xl font-bold text-indigo-600\">{gamificationData.total_points || 0}</p>\r\n                </div>\r\n              </div>\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n                {rewards.map(reward => (\r\n                  <div key={reward.id} className=\"border-2 border-gray-200 rounded-xl p-6 hover:shadow-lg transition-shadow\">\r\n                    <div className=\"text-4xl mb-4 text-center\">{reward.icon}</div>\r\n                    <h4 className=\"font-bold text-gray-900 mb-2\">{reward.name}</h4>\r\n                    <p className=\"text-sm text-gray-600 mb-4\">{reward.description}</p>\r\n                    <div className=\"flex items-center justify-between mb-4\">\r\n                      <span className=\"text-lg font-bold text-indigo-600\">{reward.cost_points} pts</span>\r\n                      {reward.availability_limit !== null && (\r\n                        <span className=\"text-sm text-gray-500\">\r\n                          {reward.availability_limit} disponibles\r\n                        </span>\r\n                      )}\r\n                    </div>\r\n                    <button\r\n                      onClick={() => handleRedeemReward(reward)}\r\n                      disabled={(gamificationData.total_points || 0) < reward.cost_points}\r\n                      className={`w-full py-2 px-4 rounded-lg font-medium transition-colors ${\r\n                        (gamificationData.total_points || 0) >= reward.cost_points\r\n                          ? 'bg-indigo-600 text-white hover:bg-indigo-700'\r\n                          : 'bg-gray-200 text-gray-400 cursor-not-allowed'\r\n                      }`}\r\n                    >\r\n                      Canjear\r\n                    </button>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Predictions Tab */}\r\n        {activeTab === 'predictions' && (\r\n          <div className=\"space-y-8\">\r\n            <div className=\"bg-white rounded-2xl shadow-lg p-6\">\r\n              <div className=\"flex items-center justify-between mb-6\">\r\n                <h3 className=\"text-2xl font-bold text-gray-900\">An√°lisis Predictivo de Engagement</h3>\r\n                <button\r\n                  onClick={generateEngagementPrediction}\r\n                  className=\"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors\"\r\n                >\r\n                  Generar Nueva Predicci√≥n\r\n                </button>\r\n              </div>\r\n\r\n              {/* Engagement Chart */}\r\n              {predictions.length > 0 && (\r\n                <div className=\"mb-8\">\r\n                  <h4 className=\"text-lg font-semibold text-gray-900 mb-4\">Tendencia de Engagement</h4>\r\n                  <div className=\"h-64\">\r\n                    <Line\r\n                      data={engagementChartData}\r\n                      options={{\r\n                        responsive: true,\r\n                        maintainAspectRatio: false,\r\n                        plugins: {\r\n                          legend: {\r\n                            display: false,\r\n                          },\r\n                        },\r\n                        scales: {\r\n                          y: {\r\n                            beginAtZero: true,\r\n                            max: 100,\r\n                            grid: {\r\n                              color: 'rgba(0, 0, 0, 0.1)',\r\n                            },\r\n                          },\r\n                          x: {\r\n                            grid: {\r\n                              color: 'rgba(0, 0, 0, 0.1)',\r\n                            },\r\n                          },\r\n                        },\r\n                      }}\r\n                    />\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              {/* Predictions List */}\r\n              <div className=\"space-y-4\">\r\n                {predictions.length > 0 ? (\r\n                  predictions.map(prediction => (\r\n                    <div key={prediction.id} className=\"border-2 border-gray-200 rounded-xl p-6\">\r\n                      <div className=\"flex items-center justify-between mb-4\">\r\n                        <div>\r\n                          <h4 className=\"font-bold text-gray-900\">\r\n                            Predicci√≥n del {new Date(prediction.prediction_date).toLocaleDateString('es-ES')}\r\n                          </h4>\r\n                          <p className=\"text-sm text-gray-600\">\r\n                            Nivel de confianza: {prediction.confidence_level}%\r\n                          </p>\r\n                        </div>\r\n                        <div className=\"text-right\">\r\n                          <p className=\"text-2xl font-bold text-indigo-600\">\r\n                            {Math.round(prediction.predicted_engagement_score)}%\r\n                          </p>\r\n                          <span className={`px-3 py-1 rounded-full text-xs font-medium ${getRiskLevelColor(prediction.risk_level)}`}>\r\n                            {prediction.risk_level === 'low' && 'Bajo riesgo'}\r\n                            {prediction.risk_level === 'medium' && 'Riesgo medio'}\r\n                            {prediction.risk_level === 'high' && 'Alto riesgo'}\r\n                            {prediction.risk_level === 'critical' && 'Riesgo cr√≠tico'}\r\n                          </span>\r\n                        </div>\r\n                      </div>\r\n\r\n                      {prediction.recommendations && prediction.recommendations.length > 0 && (\r\n                        <div className=\"mt-4\">\r\n                          <h5 className=\"font-semibold text-gray-900 mb-2\">Recomendaciones:</h5>\r\n                          <ul className=\"space-y-1\">\r\n                            {prediction.recommendations.map((rec, index) => (\r\n                              <li key={index} className=\"flex items-start space-x-2\">\r\n                                <CheckCircleIcon className=\"h-4 w-4 text-green-500 mt-0.5 flex-shrink-0\" />\r\n                                <span className=\"text-sm text-gray-600\">{rec}</span>\r\n                              </li>\r\n                            ))}\r\n                          </ul>\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  ))\r\n                ) : (\r\n                  <div className=\"text-center py-12\">\r\n                    <ArrowTrendingUpIcon className=\"h-16 w-16 text-gray-300 mx-auto mb-4\" />\r\n                    <p className=\"text-gray-500\">No hay predicciones disponibles</p>\r\n                    <p className=\"text-sm text-gray-400 mt-2\">Genera tu primera predicci√≥n para ver an√°lisis de engagement</p>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Reward Redemption Modal */}\r\n      {showRewardModal && selectedReward && (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\r\n          <div className=\"bg-white rounded-2xl shadow-2xl max-w-md w-full p-6\">\r\n            <div className=\"flex items-center justify-between mb-6\">\r\n              <h3 className=\"text-xl font-bold text-gray-900\">Confirmar Canje</h3>\r\n              <button\r\n                onClick={() => setShowRewardModal(false)}\r\n                className=\"text-gray-400 hover:text-gray-600\"\r\n              >\r\n                <XMarkIcon className=\"h-6 w-6\" />\r\n              </button>\r\n            </div>\r\n\r\n            <div className=\"text-center mb-6\">\r\n              <div className=\"text-5xl mb-4\">{selectedReward.icon}</div>\r\n              <h4 className=\"text-lg font-bold text-gray-900 mb-2\">{selectedReward.name}</h4>\r\n              <p className=\"text-gray-600 mb-4\">{selectedReward.description}</p>\r\n              <div className=\"text-2xl font-bold text-indigo-600\">{selectedReward.cost_points} puntos</div>\r\n            </div>\r\n\r\n            <div className=\"bg-gray-50 rounded-lg p-4 mb-6\">\r\n              <div className=\"flex justify-between items-center\">\r\n                <span className=\"text-gray-600\">Tus puntos actuales:</span>\r\n                <span className=\"font-bold text-gray-900\">{gamificationData.total_points || 0}</span>\r\n              </div>\r\n              <div className=\"flex justify-between items-center mt-2\">\r\n                <span className=\"text-gray-600\">Puntos despu√©s del canje:</span>\r\n                <span className=\"font-bold text-indigo-600\">\r\n                  {(gamificationData.total_points || 0) - selectedReward.cost_points}\r\n                </span>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex space-x-3\">\r\n              <button\r\n                onClick={() => setShowRewardModal(false)}\r\n                className=\"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50\"\r\n              >\r\n                Cancelar\r\n              </button>\r\n              <button\r\n                onClick={confirmRedeemReward}\r\n                className=\"flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700\"\r\n              >\r\n                Confirmar Canje\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default GamificationDashboard;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\hoc\\WithErrorHandling.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useCallback has an unnecessary dependency: 'retryFunction'. Either exclude it or remove the dependency array. Outer scope values like 'retryFunction' aren't valid dependencies because mutating them doesn't re-render the component.","line":144,"column":10,"nodeType":"ArrayExpression","endLine":144,"endColumn":39,"suggestions":[{"desc":"Update the dependencies array to be: [executeAsync]","fix":{"range":[4480,4509],"text":"[executeAsync]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'errors' is assigned a value but never used.","line":197,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":197,"endColumn":23},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useCallback has an unnecessary dependency: 'validationSchema'. Either exclude it or remove the dependency array. Outer scope values like 'validationSchema' aren't valid dependencies because mutating them doesn't re-render the component.","line":211,"column":10,"nodeType":"ArrayExpression","endLine":211,"endColumn":28,"suggestions":[{"desc":"Update the dependencies array to be: []","fix":{"range":[6335,6353],"text":"[]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useCallback has unnecessary dependencies: 'onSubmit' and 'resetOnSubmit'. Either exclude them or remove the dependency array. Outer scope values like 'onSubmit' aren't valid dependencies because mutating them doesn't re-render the component.","line":248,"column":10,"nodeType":"ArrayExpression","endLine":248,"endColumn":63,"suggestions":[{"desc":"Update the dependencies array to be: [validateForm, errorHandler]","fix":{"range":[7470,7523],"text":"[validateForm, errorHandler]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { useErrorHandler } from '../../hooks/useErrorHandler.js';\r\nimport ErrorBoundary from '../common/ErrorBoundary.js';\r\n\r\n/**\r\n * Higher-Order Component que a√±ade manejo de errores a un componente\r\n * @param {React.Component} WrappedComponent - Componente a envolver\r\n * @param {Object} options - Opciones de configuraci√≥n\r\n * @returns {React.Component} Componente envuelto con manejo de errores\r\n */\r\nconst withErrorHandling = (WrappedComponent, options = {}) => {\r\n  const {\r\n    errorBoundaryOptions = {},\r\n    errorHandlerOptions = {},\r\n    showErrorNotifications = true,\r\n    fallbackComponent = null\r\n  } = options;\r\n\r\n  // Componente envoltorio con manejo de errores\r\n  const WithErrorHandlingComponent = (props) => {\r\n    const errorHandlerHook = useErrorHandler({\r\n      enableNotifications: showErrorNotifications,\r\n      ...errorHandlerOptions\r\n    });\r\n\r\n    // Manejador de errores para el ErrorBoundary\r\n    const handleError = (error, errorInfo, errorId) => {\r\n      errorHandlerHook.handleError(error, {\r\n        component: WrappedComponent.displayName || WrappedComponent.name || 'UnknownComponent',\r\n        errorInfo,\r\n        errorId,\r\n        ...props\r\n      });\r\n    };\r\n\r\n    // Renderizar componente con manejo de errores\r\n    return (\r\n      <ErrorBoundary\r\n        onError={handleError}\r\n        fallback={fallbackComponent}\r\n        {...errorBoundaryOptions}\r\n      >\r\n        <WrappedComponent\r\n          {...props}\r\n          errorHandler={errorHandlerHook}\r\n        />\r\n      </ErrorBoundary>\r\n    );\r\n  };\r\n\r\n  // Establecer displayName para mejor debugging\r\n  const wrappedComponentName = WrappedComponent.displayName || WrappedComponent.name || 'Component';\r\n  WithErrorHandlingComponent.displayName = `withErrorHandling(${wrappedComponentName})`;\r\n\r\n  return WithErrorHandlingComponent;\r\n};\r\n\r\n/**\r\n * HOC simplificado para manejo b√°sico de errores\r\n */\r\nconst withSimpleErrorHandling = (WrappedComponent, options = {}) => {\r\n  return withErrorHandling(WrappedComponent, {\r\n    errorHandlerOptions: {\r\n      enableNotifications: true,\r\n      maxErrors: 3,\r\n      autoHideDelay: 3000\r\n    },\r\n    errorBoundaryOptions: {\r\n      fallback: (error, errorInfo, errorId) => (\r\n        <div style={{\r\n          padding: '20px',\r\n          textAlign: 'center',\r\n          color: '#dc3545',\r\n          border: '1px solid #dc3545',\r\n          borderRadius: '4px',\r\n          backgroundColor: '#f8d7da'\r\n        }}>\r\n          <h4>‚ö†Ô∏è Error en {WrappedComponent.displayName || WrappedComponent.name}</h4>\r\n          <p>{error?.message || 'Ha ocurrido un error inesperado'}</p>\r\n          <button\r\n            onClick={() => window.location.reload()}\r\n            style={{\r\n              padding: '8px 16px',\r\n              backgroundColor: '#dc3545',\r\n              color: 'white',\r\n              border: 'none',\r\n              borderRadius: '4px',\r\n              cursor: 'pointer'\r\n            }}\r\n          >\r\n            Recargar\r\n          </button>\r\n        </div>\r\n      )\r\n    },\r\n    ...options\r\n  });\r\n};\r\n\r\n/**\r\n * HOC para componentes as√≠ncronos con manejo de errores\r\n */\r\nconst withAsyncErrorHandling = (WrappedComponent, options = {}) => {\r\n  const {\r\n    loadingComponent = null,\r\n    errorComponent = null,\r\n    retryFunction = null\r\n  } = options;\r\n\r\n  return withErrorHandling(\r\n    (props) => {\r\n      const { errorHandler } = props;\r\n      const [isLoading, setIsLoading] = React.useState(false);\r\n      const [asyncError, setAsyncError] = React.useState(null);\r\n\r\n      // Funci√≥n para ejecutar operaciones as√≠ncronas con manejo de errores\r\n      const executeAsync = React.useCallback(async (asyncFn, context = {}) => {\r\n        setIsLoading(true);\r\n        setAsyncError(null);\r\n        \r\n        try {\r\n          const result = await errorHandler.handleAsyncError(asyncFn, {\r\n            operation: 'async_operation',\r\n            ...context\r\n          });\r\n          setIsLoading(false);\r\n          return result;\r\n        } catch (error) {\r\n          setAsyncError(error);\r\n          setIsLoading(false);\r\n          throw error;\r\n        }\r\n      }, [errorHandler]);\r\n\r\n      // Funci√≥n de reintentar\r\n      const handleRetry = React.useCallback(async () => {\r\n        if (retryFunction) {\r\n          try {\r\n            await executeAsync(retryFunction, { operation: 'retry' });\r\n          } catch (error) {\r\n            // El error ya fue manejado por executeAsync\r\n          }\r\n        }\r\n      }, [executeAsync, retryFunction]);\r\n\r\n      // Mostrar componente de carga\r\n      if (isLoading && loadingComponent) {\r\n        return loadingComponent;\r\n      }\r\n\r\n      // Mostrar componente de error as√≠ncrono\r\n      if (asyncError && errorComponent) {\r\n        return errorComponent({\r\n          error: asyncError,\r\n          onRetry: retryFunction ? handleRetry : null\r\n        });\r\n      }\r\n\r\n      // Renderizar componente original con props adicionales\r\n      return (\r\n        <WrappedComponent\r\n          {...props}\r\n          executeAsync={executeAsync}\r\n          isAsyncLoading={isLoading}\r\n          asyncError={asyncError}\r\n          onRetry={handleRetry}\r\n        />\r\n      );\r\n    },\r\n    options\r\n  );\r\n};\r\n\r\n/**\r\n * HOC para componentes de formulario con validaci√≥n y manejo de errores\r\n */\r\nconst withFormErrorHandling = (WrappedComponent, options = {}) => {\r\n  const {\r\n    validationSchema = null,\r\n    onSubmit = null,\r\n    resetOnSubmit = true\r\n  } = options;\r\n\r\n  return withErrorHandling(\r\n    (props) => {\r\n      const { errorHandler } = props;\r\n      const [formErrors, setFormErrors] = React.useState({});\r\n      const [isSubmitting, setIsSubmitting] = React.useState(false);\r\n\r\n      // Validar formulario\r\n      const validateForm = React.useCallback((data) => {\r\n        if (!validationSchema) {\r\n          return {};\r\n        }\r\n\r\n        try {\r\n          const errors = validationSchema.validateSync(data, { \r\n            abortEarly: false \r\n          });\r\n          return {};\r\n        } catch (validationError) {\r\n          if (validationError.inner) {\r\n            const errors = {};\r\n            validationError.inner.forEach(error => {\r\n              errors[error.path] = error.message;\r\n            });\r\n            return errors;\r\n          }\r\n          return { _form: validationError.message };\r\n        }\r\n      }, [validationSchema]);\r\n\r\n      // Manejar env√≠o de formulario\r\n      const handleFormSubmit = React.useCallback(async (data) => {\r\n        // Validar datos\r\n        const validationErrors = validateForm(data);\r\n        if (Object.keys(validationErrors).length > 0) {\r\n          setFormErrors(validationErrors);\r\n          errorHandler.handleError(new Error('Error de validaci√≥n'), {\r\n            type: 'VALIDATION',\r\n            context: { validationErrors }\r\n          });\r\n          return;\r\n        }\r\n\r\n        setIsSubmitting(true);\r\n        setFormErrors({});\r\n\r\n        try {\r\n          await errorHandler.handleAsyncError(async () => {\r\n            if (onSubmit) {\r\n              return await onSubmit(data);\r\n            }\r\n            throw new Error('No se defini√≥ funci√≥n onSubmit');\r\n          }, {\r\n            operation: 'form_submit',\r\n            formData: data\r\n          });\r\n\r\n          if (resetOnSubmit) {\r\n            setFormErrors({});\r\n          }\r\n        } catch (error) {\r\n          // El error ya fue manejado por el errorHandler\r\n        } finally {\r\n          setIsSubmitting(false);\r\n        }\r\n      }, [validateForm, errorHandler, onSubmit, resetOnSubmit]);\r\n\r\n      // Limpiar error espec√≠fico\r\n      const clearFieldError = React.useCallback((fieldName) => {\r\n        setFormErrors(prev => {\r\n          const newErrors = { ...prev };\r\n          delete newErrors[fieldName];\r\n          return newErrors;\r\n        });\r\n      }, []);\r\n\r\n      // Limpiar todos los errores\r\n      const clearFormErrors = React.useCallback(() => {\r\n        setFormErrors({});\r\n      }, []);\r\n\r\n      return (\r\n        <WrappedComponent\r\n          {...props}\r\n          formErrors={formErrors}\r\n          isSubmitting={isSubmitting}\r\n          onFormSubmit={handleFormSubmit}\r\n          clearFieldError={clearFieldError}\r\n          clearFormErrors={clearFormErrors}\r\n          validateForm={validateForm}\r\n        />\r\n      );\r\n    },\r\n    {\r\n      errorHandlerOptions: {\r\n        enableNotifications: true\r\n      },\r\n      ...options\r\n    }\r\n  );\r\n};\r\n\r\nexport default withErrorHandling;\r\nexport { withSimpleErrorHandling, withAsyncErrorHandling, withFormErrorHandling };","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\home\\HomeStaffHubSEO.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\home\\HomeUltraModern.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\home\\HomeValueFocused.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\integrations\\GoogleDriveAutoSetup.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\integrations\\GoogleDriveIntegrationSelector.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\integrations\\GoogleDrivePermissionsConfig.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'user' is assigned a value but never used.","line":14,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":15},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadCompanyData'. Either include it or remove the dependency array.","line":33,"column":6,"nodeType":"ArrayExpression","endLine":33,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadCompanyData]","fix":{"range":[1108,1110],"text":"[loadCompanyData]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadPermissions'. Either include it or remove the dependency array.","line":39,"column":6,"nodeType":"ArrayExpression","endLine":39,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [loadPermissions, selectedCompany]","fix":{"range":[1201,1218],"text":"[loadPermissions, selectedCompany]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { useAuth } from '../../contexts/AuthContext.js'\r\nimport googleDrivePermissionsService from '../../services/googleDrivePermissionsService.js'\r\nimport {\r\n  UserGroupIcon,\r\n  ShieldCheckIcon,\r\n  PlusIcon,\r\n  TrashIcon,\r\n  CheckIcon,\r\n  XMarkIcon\r\n} from '@heroicons/react/24/outline'\r\n\r\nconst GoogleDrivePermissionsConfig = () => {\r\n  const { user, supabase } = useAuth()\r\n  const [companies, setCompanies] = useState([])\r\n  const [selectedCompany, setSelectedCompany] = useState('')\r\n  const [permissions, setPermissions] = useState([])\r\n  const [loading, setLoading] = useState(false)\r\n  const [saving, setSaving] = useState(false)\r\n  const [applying, setApplying] = useState(false)\r\n  const [error, setError] = useState('')\r\n  const [success, setSuccess] = useState('')\r\n  const [newPermission, setNewPermission] = useState({\r\n    employeeEmail: '',\r\n    permissionLevel: 'viewer',\r\n    folderPath: ''\r\n  })\r\n\r\n  const permissionTemplates = googleDrivePermissionsService.getPermissionTemplates()\r\n\r\n  useEffect(() => {\r\n    loadCompanyData()\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    if (selectedCompany) {\r\n      loadPermissions()\r\n    }\r\n  }, [selectedCompany])\r\n\r\n  const loadCompanyData = async () => {\r\n    try {\r\n      setLoading(true)\r\n      const { data, error } = await supabase\r\n        .from('companies')\r\n        .select('id, name')\r\n        .order('name')\r\n\r\n      if (error) throw error\r\n      setCompanies(data || [])\r\n    } catch (error) {\r\n      console.error('Error loading companies:', error)\r\n      setError('Error al cargar las empresas')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const loadPermissions = async () => {\r\n    try {\r\n      setLoading(true)\r\n      const permissionsData = await googleDrivePermissionsService.getCompanyPermissions(selectedCompany)\r\n      setPermissions(permissionsData)\r\n    } catch (error) {\r\n      console.error('Error loading permissions:', error)\r\n      setError('Error al cargar los permisos')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const addPermission = () => {\r\n    if (!newPermission.employeeEmail || !newPermission.permissionLevel) {\r\n      setError('Email y nivel de permiso son requeridos')\r\n      return\r\n    }\r\n\r\n    const validationErrors = googleDrivePermissionsService.validatePermissions([newPermission])\r\n    if (validationErrors.length > 0) {\r\n      setError(validationErrors[0])\r\n      return\r\n    }\r\n\r\n    setPermissions([...permissions, { ...newPermission, id: Date.now() }])\r\n    setNewPermission({\r\n      employeeEmail: '',\r\n      permissionLevel: 'viewer',\r\n      folderPath: ''\r\n    })\r\n    setError('')\r\n  }\r\n\r\n  const removePermission = (index) => {\r\n    setPermissions(permissions.filter((_, i) => i !== index))\r\n  }\r\n\r\n  const savePermissions = async () => {\r\n    try {\r\n      setSaving(true)\r\n      setError('')\r\n      \r\n      const validationErrors = googleDrivePermissionsService.validatePermissions(permissions)\r\n      if (validationErrors.length > 0) {\r\n        setError(validationErrors[0])\r\n        return\r\n      }\r\n\r\n      await googleDrivePermissionsService.saveCompanyPermissions(selectedCompany, permissions)\r\n      setSuccess('Permisos guardados correctamente')\r\n      setTimeout(() => setSuccess(''), 3000)\r\n    } catch (error) {\r\n      console.error('Error saving permissions:', error)\r\n      setError('Error al guardar los permisos')\r\n    } finally {\r\n      setSaving(false)\r\n    }\r\n  }\r\n\r\n  const applyPermissionsToGoogleDrive = async () => {\r\n    try {\r\n      setApplying(true)\r\n      setError('')\r\n      \r\n      // Obtener token de acceso del usuario (esto deber√≠a venir del contexto de autenticaci√≥n)\r\n      const accessToken = localStorage.getItem('google_drive_access_token')\r\n      if (!accessToken) {\r\n        setError('No se encontr√≥ token de acceso de Google Drive')\r\n        return\r\n      }\r\n\r\n      const folderId = 'root' // ID de la carpeta ra√≠z o carpeta espec√≠fica\r\n      const results = await googleDrivePermissionsService.applyPermissionsToGoogleDrive(\r\n        accessToken, \r\n        folderId, \r\n        permissions\r\n      )\r\n\r\n      const successful = results.filter(r => r.success).length\r\n      const failed = results.filter(r => !r.success).length\r\n\r\n      if (failed > 0) {\r\n        setError(`${failed} permisos fallaron al aplicarse`)\r\n      }\r\n      \r\n      setSuccess(`${successful} permisos aplicados correctamente`)\r\n      setTimeout(() => setSuccess(''), 5000)\r\n    } catch (error) {\r\n      console.error('Error applying permissions:', error)\r\n      setError('Error al aplicar permisos a Google Drive')\r\n    } finally {\r\n      setApplying(false)\r\n    }\r\n  }\r\n\r\n  if (loading && companies.length === 0) {\r\n    return (\r\n      <div className=\"flex items-center justify-center p-8\">\r\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600\"></div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"max-w-4xl mx-auto p-6\">\r\n      <div className=\"bg-white rounded-lg shadow-lg\">\r\n        <div className=\"px-6 py-4 border-b border-gray-200\">\r\n          <div className=\"flex items-center\">\r\n            <ShieldCheckIcon className=\"h-6 w-6 text-blue-600 mr-3\" />\r\n            <h2 className=\"text-xl font-semibold text-gray-900\">\r\n              Configuraci√≥n de Permisos Google Drive\r\n            </h2>\r\n          </div>\r\n          <p className=\"mt-2 text-sm text-gray-600\">\r\n            Configura los permisos de acceso para empleados en Google Drive\r\n          </p>\r\n        </div>\r\n\r\n        <div className=\"p-6\">\r\n          {/* Selecci√≥n de empresa */}\r\n          <div className=\"mb-6\">\r\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n              Empresa\r\n            </label>\r\n            <select\r\n              value={selectedCompany}\r\n              onChange={(e) => setSelectedCompany(e.target.value)}\r\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n            >\r\n              <option value=\"\">Seleccionar empresa...</option>\r\n              {companies.map((company) => (\r\n                <option key={company.id} value={company.id}>\r\n                  {company.name}\r\n                </option>\r\n              ))}\r\n            </select>\r\n          </div>\r\n\r\n          {selectedCompany && (\r\n            <>\r\n              {/* Agregar nuevo permiso */}\r\n              <div className=\"mb-6 p-4 bg-gray-50 rounded-lg\">\r\n                <h3 className=\"text-lg font-medium text-gray-900 mb-4\">Agregar Permiso</h3>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                      Email del empleado\r\n                    </label>\r\n                    <input\r\n                      type=\"email\"\r\n                      value={newPermission.employeeEmail}\r\n                      onChange={(e) => setNewPermission({\r\n                        ...newPermission,\r\n                        employeeEmail: e.target.value\r\n                      })}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                      placeholder=\"empleado@empresa.com\"\r\n                    />\r\n                  </div>\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                      Nivel de permiso\r\n                    </label>\r\n                    <select\r\n                      value={newPermission.permissionLevel}\r\n                      onChange={(e) => setNewPermission({\r\n                        ...newPermission,\r\n                        permissionLevel: e.target.value\r\n                      })}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                    >\r\n                      {Object.entries(permissionTemplates).map(([key, template]) => (\r\n                        <option key={key} value={key}>\r\n                          {template.name}\r\n                        </option>\r\n                      ))}\r\n                    </select>\r\n                  </div>\r\n                  <div className=\"flex items-end\">\r\n                    <button\r\n                      onClick={addPermission}\r\n                      className=\"w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center justify-center\"\r\n                    >\r\n                      <PlusIcon className=\"h-4 w-4 mr-2\" />\r\n                      Agregar\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n                <div className=\"mt-4\">\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                    Ruta de carpeta (opcional)\r\n                  </label>\r\n                  <input\r\n                    type=\"text\"\r\n                    value={newPermission.folderPath}\r\n                    onChange={(e) => setNewPermission({\r\n                      ...newPermission,\r\n                      folderPath: e.target.value\r\n                    })}\r\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                    placeholder=\"/Carpeta/Subcarpeta\"\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              {/* Lista de permisos */}\r\n              <div className=\"mb-6\">\r\n                <h3 className=\"text-lg font-medium text-gray-900 mb-4\">\r\n                  Permisos Configurados ({permissions.length})\r\n                </h3>\r\n                {permissions.length === 0 ? (\r\n                  <div className=\"text-center py-8 text-gray-500\">\r\n                    <UserGroupIcon className=\"h-12 w-12 mx-auto mb-4 text-gray-300\" />\r\n                    <p>No hay permisos configurados</p>\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"space-y-3\">\r\n                    {permissions.map((permission, index) => (\r\n                      <div key={permission.id || index} className=\"flex items-center justify-between p-4 bg-white border border-gray-200 rounded-lg\">\r\n                        <div className=\"flex-1\">\r\n                          <div className=\"flex items-center\">\r\n                            <span className=\"font-medium text-gray-900\">{permission.employeeEmail}</span>\r\n                            <span className=\"ml-3 px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full\">\r\n                              {permissionTemplates[permission.permissionLevel]?.name || permission.permissionLevel}\r\n                            </span>\r\n                          </div>\r\n                          {permission.folderPath && (\r\n                            <p className=\"text-sm text-gray-500 mt-1\">\r\n                              Carpeta: {permission.folderPath}\r\n                            </p>\r\n                          )}\r\n                        </div>\r\n                        <button\r\n                          onClick={() => removePermission(index)}\r\n                          className=\"ml-4 p-2 text-red-600 hover:text-red-800 focus:outline-none\"\r\n                        >\r\n                          <TrashIcon className=\"h-4 w-4\" />\r\n                        </button>\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              {/* Botones de acci√≥n */}\r\n              <div className=\"flex flex-col sm:flex-row gap-4\">\r\n                <button\r\n                  onClick={savePermissions}\r\n                  disabled={saving || permissions.length === 0}\r\n                  className=\"flex-1 bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center\"\r\n                >\r\n                  {saving ? (\r\n                    <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2\"></div>\r\n                  ) : (\r\n                    <CheckIcon className=\"h-4 w-4 mr-2\" />\r\n                  )}\r\n                  {saving ? 'Guardando...' : 'Guardar Permisos'}\r\n                </button>\r\n\r\n                <button\r\n                  onClick={applyPermissionsToGoogleDrive}\r\n                  disabled={applying || permissions.length === 0}\r\n                  className=\"flex-1 bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center\"\r\n                >\r\n                  {applying ? (\r\n                    <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2\"></div>\r\n                  ) : (\r\n                    <ShieldCheckIcon className=\"h-4 w-4 mr-2\" />\r\n                  )}\r\n                  {applying ? 'Aplicando...' : 'Aplicar a Google Drive'}\r\n                </button>\r\n              </div>\r\n            </>\r\n          )}\r\n\r\n          {/* Mensajes de estado */}\r\n          {error && (\r\n            <div className=\"mt-4 p-4 bg-red-50 border border-red-200 rounded-md\">\r\n              <div className=\"flex\">\r\n                <XMarkIcon className=\"h-5 w-5 text-red-400 mr-2\" />\r\n                <p className=\"text-sm text-red-700\">{error}</p>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {success && (\r\n            <div className=\"mt-4 p-4 bg-green-50 border border-green-200 rounded-md\">\r\n              <div className=\"flex\">\r\n                <CheckIcon className=\"h-5 w-5 text-green-400 mr-2\" />\r\n                <p className=\"text-sm text-green-700\">{success}</p>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default GoogleDrivePermissionsConfig","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\integrations\\GoogleDriveSetupWizard.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\integrations\\GoogleDriveSimplePage.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\integrations\\GoogleDriveTestPage.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\integrations\\Integrations.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\integrations\\UserGoogleDriveConnector.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\knowledge\\CompanyKnowledgeManager.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'EyeIcon' is defined but never used.","line":25,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":10},{"ruleId":"no-unused-vars","severity":1,"message":"'PencilIcon' is defined but never used.","line":26,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":26,"endColumn":13},{"ruleId":"no-unused-vars","severity":1,"message":"'TrashIcon' is defined but never used.","line":27,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":12},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadKnowledgeData'. Either include it or remove the dependency array.","line":58,"column":6,"nodeType":"ArrayExpression","endLine":58,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [companyId, loadKnowledgeData]","fix":{"range":[1669,1680],"text":"[companyId, loadKnowledgeData]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Componente de Gesti√≥n de Base de Conocimiento Empresarial\r\n * \r\n * Este componente permite:\r\n * - Ver el estado de la base de conocimiento\r\n * - Sincronizar documentos con Google Drive\r\n * - Buscar en la base de conocimiento vectorizada\r\n * - Gestionar categor√≠as y FAQs\r\n * - Ver estad√≠sticas de uso\r\n */\r\n\r\nimport React, { useState, useEffect } from 'react';\r\nimport {\r\n  BookOpenIcon,\r\n  DocumentTextIcon,\r\n  FolderIcon,\r\n  CloudArrowUpIcon,\r\n  MagnifyingGlassIcon,\r\n  ChartBarIcon,\r\n  Cog6ToothIcon,\r\n  RefreshIcon,\r\n  CheckCircleIcon,\r\n  ExclamationTriangleIcon,\r\n  ClockIcon,\r\n  EyeIcon,\r\n  PencilIcon,\r\n  TrashIcon,\r\n  PlusIcon\r\n} from '@heroicons/react/24/outline';\r\nimport { supabase } from '../../lib/supabaseClient.js';\r\nimport companyKnowledgeService from '../../services/companyKnowledgeService.js';\r\nimport toast from 'react-hot-toast';\r\n\r\nconst CompanyKnowledgeManager = ({ companyId, companyName }) => {\r\n  const [loading, setLoading] = useState(true);\r\n  const [activeTab, setActiveTab] = useState('overview');\r\n  const [syncing, setSyncing] = useState(false);\r\n  const [searchQuery, setSearchQuery] = useState('');\r\n  const [searchResults, setSearchResults] = useState([]);\r\n  \r\n  // Estados de la base de conocimiento\r\n  const [knowledgeBase, setKnowledgeBase] = useState(null);\r\n  const [stats, setStats] = useState({\r\n    documents: 0,\r\n    faqs: 0,\r\n    categories: 0,\r\n    chunks: 0,\r\n    lastSync: null\r\n  });\r\n  const [recentDocuments, setRecentDocuments] = useState([]);\r\n  const [syncLogs, setSyncLogs] = useState([]);\r\n\r\n  // Cargar datos iniciales\r\n  useEffect(() => {\r\n    if (companyId) {\r\n      loadKnowledgeData();\r\n    }\r\n  }, [companyId]);\r\n\r\n  const loadKnowledgeData = async () => {\r\n    try {\r\n      setLoading(true);\r\n      \r\n      const [\r\n        kbData,\r\n        statsData,\r\n        recentDocs,\r\n        logsData\r\n      ] = await Promise.all([\r\n        loadKnowledgeBase(),\r\n        loadStats(),\r\n        loadRecentDocuments(),\r\n        loadSyncLogs()\r\n      ]);\r\n\r\n      setKnowledgeBase(kbData);\r\n      setStats(statsData);\r\n      setRecentDocuments(recentDocs);\r\n      setSyncLogs(logsData);\r\n\r\n    } catch (error) {\r\n      console.error('Error cargando datos de conocimiento:', error);\r\n      toast.error('Error al cargar datos de la base de conocimiento');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const loadKnowledgeBase = async () => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('company_knowledge_bases')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .single();\r\n\r\n      if (error && error.code !== 'PGRST116') {\r\n        throw error;\r\n      }\r\n\r\n      return data;\r\n    } catch (error) {\r\n      console.error('Error cargando base de conocimiento:', error);\r\n      return null;\r\n    }\r\n  };\r\n\r\n  const loadStats = async () => {\r\n    try {\r\n      return await companyKnowledgeService.getKnowledgeStats(companyId);\r\n    } catch (error) {\r\n      console.error('Error cargando estad√≠sticas:', error);\r\n      return {\r\n        documents: 0,\r\n        faqs: 0,\r\n        categories: 0,\r\n        chunks: 0,\r\n        lastUpdated: null\r\n      };\r\n    }\r\n  };\r\n\r\n  const loadRecentDocuments = async () => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('knowledge_documents')\r\n        .select(`\r\n          id,\r\n          title,\r\n          description,\r\n          file_type,\r\n          folder_type,\r\n          created_at,\r\n          knowledge_categories(name)\r\n        `)\r\n        .eq('company_id', companyId)\r\n        .eq('status', 'active')\r\n        .order('created_at', { ascending: false })\r\n        .limit(10);\r\n\r\n      if (error) throw error;\r\n      return data || [];\r\n    } catch (error) {\r\n      console.error('Error cargando documentos recientes:', error);\r\n      return [];\r\n    }\r\n  };\r\n\r\n  const loadSyncLogs = async () => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('drive_sync_logs')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .order('started_at', { ascending: false })\r\n        .limit(5);\r\n\r\n      if (error) throw error;\r\n      return data || [];\r\n    } catch (error) {\r\n      console.error('Error cargando logs de sincronizaci√≥n:', error);\r\n      return [];\r\n    }\r\n  };\r\n\r\n  const handleSyncWithDrive = async () => {\r\n    try {\r\n      setSyncing(true);\r\n      toast.loading('Iniciando sincronizaci√≥n con Google Drive...');\r\n\r\n      // Obtener el ID del usuario actual\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      \r\n      const result = await companyKnowledgeService.syncAndVectorizeDocuments(\r\n        companyId,\r\n        user.id\r\n      );\r\n\r\n      toast.dismiss();\r\n      \r\n      if (result.success) {\r\n        toast.success(`Sincronizaci√≥n completada: ${result.totalVectorized}/${result.totalProcessed} documentos procesados`);\r\n        \r\n        // Recargar datos\r\n        await loadKnowledgeData();\r\n      } else {\r\n        toast.error('Error en la sincronizaci√≥n');\r\n      }\r\n\r\n    } catch (error) {\r\n      toast.dismiss();\r\n      console.error('Error en sincronizaci√≥n:', error);\r\n      toast.error('Error al sincronizar con Google Drive');\r\n    } finally {\r\n      setSyncing(false);\r\n    }\r\n  };\r\n\r\n  const handleSearch = async () => {\r\n    if (!searchQuery.trim()) {\r\n      setSearchResults([]);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const results = await companyKnowledgeService.searchKnowledge(companyId, searchQuery, {\r\n        limit: 20,\r\n        includeFAQs: true,\r\n        includeDocuments: true\r\n      });\r\n\r\n      setSearchResults(results);\r\n    } catch (error) {\r\n      console.error('Error en b√∫squeda:', error);\r\n      toast.error('Error al buscar en la base de conocimiento');\r\n    }\r\n  };\r\n\r\n  const getStatusIcon = (status) => {\r\n    switch (status) {\r\n      case 'active':\r\n        return <CheckCircleIcon className=\"h-5 w-5 text-green-500\" />;\r\n      case 'syncing':\r\n        return <ClockIcon className=\"h-5 w-5 text-yellow-500\" />;\r\n      case 'error':\r\n        return <ExclamationTriangleIcon className=\"h-5 w-5 text-red-500\" />;\r\n      default:\r\n        return <ExclamationTriangleIcon className=\"h-5 w-5 text-gray-500\" />;\r\n    }\r\n  };\r\n\r\n  const getStatusColor = (status) => {\r\n    switch (status) {\r\n      case 'active':\r\n        return 'bg-green-100 text-green-800';\r\n      case 'syncing':\r\n        return 'bg-yellow-100 text-yellow-800';\r\n      case 'error':\r\n        return 'bg-red-100 text-red-800';\r\n      default:\r\n        return 'bg-gray-100 text-gray-800';\r\n    }\r\n  };\r\n\r\n  const formatDate = (dateString) => {\r\n    if (!dateString) return 'N/A';\r\n    return new Date(dateString).toLocaleDateString('es-CL', {\r\n      day: '2-digit',\r\n      month: '2-digit',\r\n      year: 'numeric',\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    });\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center p-8\">\r\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600\"></div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-6\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center space-x-3\">\r\n            <BookOpenIcon className=\"h-8 w-8 text-blue-600\" />\r\n            <div>\r\n              <h1 className=\"text-2xl font-bold text-gray-900\">\r\n                Base de Conocimiento - {companyName}\r\n              </h1>\r\n              <p className=\"text-gray-600\">\r\n                Gestiona documentos, FAQs y b√∫squeda sem√°ntica\r\n              </p>\r\n            </div>\r\n          </div>\r\n          \r\n          <div className=\"flex items-center space-x-3\">\r\n            {knowledgeBase && (\r\n              <div className=\"flex items-center space-x-2\">\r\n                {getStatusIcon(knowledgeBase.status)}\r\n                <span className={`px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(knowledgeBase.status)}`}>\r\n                  {knowledgeBase.status === 'active' ? 'Activa' : \r\n                   knowledgeBase.status === 'syncing' ? 'Sincronizando' : 'Error'}\r\n                </span>\r\n              </div>\r\n            )}\r\n            \r\n            <button\r\n              onClick={handleSyncWithDrive}\r\n              disabled={syncing}\r\n              className=\"flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50\"\r\n            >\r\n              <CloudArrowUpIcon className=\"h-5 w-5\" />\r\n              <span>{syncing ? 'Sincronizando...' : 'Sincronizar con Drive'}</span>\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Stats Cards */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\r\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-sm text-gray-600\">Documentos</p>\r\n              <p className=\"text-2xl font-bold text-blue-600\">{stats.documents}</p>\r\n            </div>\r\n            <DocumentTextIcon className=\"h-8 w-8 text-blue-600\" />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-sm text-gray-600\">FAQs</p>\r\n              <p className=\"text-2xl font-bold text-green-600\">{stats.faqs}</p>\r\n            </div>\r\n            <BookOpenIcon className=\"h-8 w-8 text-green-600\" />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-sm text-gray-600\">Categor√≠as</p>\r\n              <p className=\"text-2xl font-bold text-purple-600\">{stats.categories}</p>\r\n            </div>\r\n            <FolderIcon className=\"h-8 w-8 text-purple-600\" />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-sm text-gray-600\">Chunks</p>\r\n              <p className=\"text-2xl font-bold text-orange-600\">{stats.chunks}</p>\r\n            </div>\r\n            <ChartBarIcon className=\"h-8 w-8 text-orange-600\" />\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Search Bar */}\r\n      <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-4\">\r\n        <div className=\"flex items-center space-x-4\">\r\n          <div className=\"flex-1 relative\">\r\n            <MagnifyingGlassIcon className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400\" />\r\n            <input\r\n              type=\"text\"\r\n              placeholder=\"Buscar en documentos y FAQs...\"\r\n              value={searchQuery}\r\n              onChange={(e) => setSearchQuery(e.target.value)}\r\n              onKeyPress={(e) => e.key === 'Enter' && handleSearch()}\r\n              className=\"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n            />\r\n          </div>\r\n          <button\r\n            onClick={handleSearch}\r\n            className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700\"\r\n          >\r\n            Buscar\r\n          </button>\r\n        </div>\r\n\r\n        {/* Search Results */}\r\n        {searchResults.length > 0 && (\r\n          <div className=\"mt-4 border-t pt-4\">\r\n            <h3 className=\"text-sm font-medium text-gray-900 mb-3\">\r\n              Resultados ({searchResults.length})\r\n            </h3>\r\n            <div className=\"space-y-3 max-h-64 overflow-y-auto\">\r\n              {searchResults.map((result, index) => (\r\n                <div key={index} className=\"p-3 bg-gray-50 rounded-lg\">\r\n                  <div className=\"flex items-start justify-between\">\r\n                    <div className=\"flex-1\">\r\n                      <div className=\"flex items-center space-x-2\">\r\n                        <span className={`px-2 py-1 text-xs rounded ${\r\n                          result.type === 'document' \r\n                            ? 'bg-blue-100 text-blue-800' \r\n                            : 'bg-green-100 text-green-800'\r\n                        }`}>\r\n                          {result.type === 'document' ? 'Documento' : 'FAQ'}\r\n                        </span>\r\n                        <span className=\"text-xs text-gray-500\">\r\n                          Relevancia: {(result.relevance * 100).toFixed(1)}%\r\n                        </span>\r\n                      </div>\r\n                      <h4 className=\"font-medium text-gray-900 mt-1\">\r\n                        {result.type === 'document' ? result.title : result.question}\r\n                      </h4>\r\n                      <p className=\"text-sm text-gray-600 mt-1 line-clamp-2\">\r\n                        {result.type === 'document' ? result.description : result.answer}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Tabs */}\r\n      <div className=\"bg-white rounded-lg shadow-sm border border-gray-200\">\r\n        <div className=\"border-b border-gray-200\">\r\n          <nav className=\"flex space-x-8 px-6\" aria-label=\"Tabs\">\r\n            {[\r\n              { id: 'overview', name: 'Resumen', icon: ChartBarIcon },\r\n              { id: 'documents', name: 'Documentos', icon: DocumentTextIcon },\r\n              { id: 'sync', name: 'Sincronizaci√≥n', icon: RefreshIcon },\r\n              { id: 'settings', name: 'Configuraci√≥n', icon: Cog6ToothIcon }\r\n            ].map((tab) => (\r\n              <button\r\n                key={tab.id}\r\n                onClick={() => setActiveTab(tab.id)}\r\n                className={`py-4 px-1 border-b-2 font-medium text-sm ${\r\n                  activeTab === tab.id\r\n                    ? 'border-blue-500 text-blue-600'\r\n                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'\r\n                }`}\r\n              >\r\n                <div className=\"flex items-center space-x-2\">\r\n                  <tab.icon className=\"h-5 w-5\" />\r\n                  <span>{tab.name}</span>\r\n                </div>\r\n              </button>\r\n            ))}\r\n          </nav>\r\n        </div>\r\n\r\n        <div className=\"p-6\">\r\n          {/* Tab Content */}\r\n          {activeTab === 'overview' && (\r\n            <div className=\"space-y-6\">\r\n              <div>\r\n                <h3 className=\"text-lg font-medium text-gray-900 mb-4\">Informaci√≥n General</h3>\r\n                {knowledgeBase ? (\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                    <div>\r\n                      <label className=\"block text-sm font-medium text-gray-700\">Estado</label>\r\n                      <div className=\"flex items-center space-x-2 mt-1\">\r\n                        {getStatusIcon(knowledgeBase.status)}\r\n                        <span className=\"text-sm text-gray-900\">\r\n                          {knowledgeBase.status === 'active' ? 'Activa' : \r\n                           knowledgeBase.status === 'syncing' ? 'Sincronizando' : 'Con errores'}\r\n                        </span>\r\n                      </div>\r\n                    </div>\r\n                    <div>\r\n                      <label className=\"block text-sm font-medium text-gray-700\">√öltima sincronizaci√≥n</label>\r\n                      <p className=\"text-sm text-gray-900 mt-1\">\r\n                        {formatDate(knowledgeBase.last_sync_at)}\r\n                      </p>\r\n                    </div>\r\n                    <div>\r\n                      <label className=\"block text-sm font-medium text-gray-700\">Carpeta de Drive</label>\r\n                      <a \r\n                        href={knowledgeBase.drive_folder_url}\r\n                        target=\"_blank\"\r\n                        rel=\"noopener noreferrer\"\r\n                        className=\"text-sm text-blue-600 hover:text-blue-800 mt-1 block\"\r\n                      >\r\n                        Abrir en Google Drive\r\n                      </a>\r\n                    </div>\r\n                    <div>\r\n                      <label className=\"block text-sm font-medium text-gray-700\">ID de Carpeta</label>\r\n                      <p className=\"text-sm text-gray-900 mt-1 font-mono\">\r\n                        {knowledgeBase.drive_folder_id}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"text-center py-8 text-gray-500\">\r\n                    <BookOpenIcon className=\"h-12 w-12 mx-auto mb-4 text-gray-400\" />\r\n                    <p>No hay una base de conocimiento configurada para esta empresa.</p>\r\n                    <p className=\"text-sm mt-2\">La base de conocimiento se crea autom√°ticamente al registrar una empresa con Google Drive configurado.</p>\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              <div>\r\n                <h3 className=\"text-lg font-medium text-gray-900 mb-4\">Documentos Recientes</h3>\r\n                {recentDocuments.length > 0 ? (\r\n                  <div className=\"space-y-3\">\r\n                    {recentDocuments.map((doc) => (\r\n                      <div key={doc.id} className=\"flex items-center justify-between p-3 bg-gray-50 rounded-lg\">\r\n                        <div className=\"flex items-center space-x-3\">\r\n                          <DocumentTextIcon className=\"h-5 w-5 text-gray-400\" />\r\n                          <div>\r\n                            <p className=\"font-medium text-gray-900\">{doc.title}</p>\r\n                            <p className=\"text-sm text-gray-500\">\r\n                              {doc.knowledge_categories?.name || 'Sin categor√≠a'} ‚Ä¢ {doc.file_type}\r\n                            </p>\r\n                          </div>\r\n                        </div>\r\n                        <div className=\"text-sm text-gray-500\">\r\n                          {formatDate(doc.created_at)}\r\n                        </div>\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                ) : (\r\n                  <p className=\"text-center text-gray-500 py-4\">No hay documentos recientes</p>\r\n                )}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {activeTab === 'documents' && (\r\n            <div className=\"space-y-4\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <h3 className=\"text-lg font-medium text-gray-900\">Todos los Documentos</h3>\r\n                <button className=\"flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700\">\r\n                  <PlusIcon className=\"h-5 w-5\" />\r\n                  <span>Subir Documento</span>\r\n                </button>\r\n              </div>\r\n              \r\n              <div className=\"text-center py-8 text-gray-500\">\r\n                <DocumentTextIcon className=\"h-12 w-12 mx-auto mb-4 text-gray-400\" />\r\n                <p>La gesti√≥n completa de documentos estar√° disponible pr√≥ximamente.</p>\r\n                <p className=\"text-sm mt-2\">Puedes sincronizar documentos desde Google Drive usando el bot√≥n \"Sincronizar con Drive\".</p>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {activeTab === 'sync' && (\r\n            <div className=\"space-y-6\">\r\n              <div>\r\n                <h3 className=\"text-lg font-medium text-gray-900 mb-4\">Historial de Sincronizaci√≥n</h3>\r\n                {syncLogs.length > 0 ? (\r\n                  <div className=\"space-y-3\">\r\n                    {syncLogs.map((log) => (\r\n                      <div key={log.id} className=\"border border-gray-200 rounded-lg p-4\">\r\n                        <div className=\"flex items-center justify-between mb-2\">\r\n                          <div className=\"flex items-center space-x-2\">\r\n                            {getStatusIcon(log.status)}\r\n                            <span className=\"font-medium text-gray-900\">\r\n                              {log.status === 'completed' ? 'Completada' :\r\n                               log.status === 'running' ? 'En progreso' :\r\n                               log.status === 'failed' ? 'Fallida' : 'Cancelada'}\r\n                            </span>\r\n                            <span className=\"text-sm text-gray-500\">\r\n                              {log.sync_type === 'full' ? 'Completa' : 'Incremental'}\r\n                            </span>\r\n                          </div>\r\n                          <span className=\"text-sm text-gray-500\">\r\n                            {formatDate(log.started_at)}\r\n                          </span>\r\n                        </div>\r\n                        \r\n                        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\r\n                          <div>\r\n                            <span className=\"text-gray-500\">Procesados:</span>\r\n                            <span className=\"ml-2 font-medium\">{log.files_processed}</span>\r\n                          </div>\r\n                          <div>\r\n                            <span className=\"text-gray-500\">Creados:</span>\r\n                            <span className=\"ml-2 font-medium text-green-600\">{log.files_created}</span>\r\n                          </div>\r\n                          <div>\r\n                            <span className=\"text-gray-500\">Actualizados:</span>\r\n                            <span className=\"ml-2 font-medium text-blue-600\">{log.files_updated}</span>\r\n                          </div>\r\n                          <div>\r\n                            <span className=\"text-gray-500\">Errores:</span>\r\n                            <span className=\"ml-2 font-medium text-red-600\">{log.errors_count}</span>\r\n                          </div>\r\n                        </div>\r\n\r\n                        {log.duration_seconds && (\r\n                          <div className=\"mt-2 text-sm text-gray-500\">\r\n                            Duraci√≥n: {log.duration_seconds} segundos\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                ) : (\r\n                  <p className=\"text-center text-gray-500 py-4\">No hay historial de sincronizaci√≥n</p>\r\n                )}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {activeTab === 'settings' && (\r\n            <div className=\"space-y-6\">\r\n              <div>\r\n                <h3 className=\"text-lg font-medium text-gray-900 mb-4\">Configuraci√≥n de IA</h3>\r\n                <div className=\"text-center py-8 text-gray-500\">\r\n                  <Cog6ToothIcon className=\"h-12 w-12 mx-auto mb-4 text-gray-400\" />\r\n                  <p>La configuraci√≥n avanzada de IA estar√° disponible pr√≥ximamente.</p>\r\n                  <p className=\"text-sm mt-2\">Podr√°s configurar modelos de embeddings, umbrales de similitud y m√°s.</p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default CompanyKnowledgeManager;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\knowledge\\KnowledgeBaseManager.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'ExclamationTriangleIcon' is defined but never used.","line":12,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":26},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadKnowledgeBaseData'. Either include it or remove the dependency array.","line":61,"column":6,"nodeType":"ArrayExpression","endLine":61,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [companyId, loadKnowledgeBaseData]","fix":{"range":[1740,1751],"text":"[companyId, loadKnowledgeBaseData]"}}]},{"ruleId":"no-restricted-globals","severity":2,"message":"Unexpected use of 'confirm'.","line":215,"column":10,"nodeType":"Identifier","messageId":"defaultMessage","endLine":215,"endColumn":17},{"ruleId":"no-unused-vars","severity":1,"message":"'uploadData' is assigned a value but never used.","line":239,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":239,"endColumn":31},{"ruleId":"no-restricted-globals","severity":2,"message":"Unexpected use of 'confirm'.","line":285,"column":10,"nodeType":"Identifier","messageId":"defaultMessage","endLine":285,"endColumn":17},{"ruleId":"no-restricted-globals","severity":2,"message":"Unexpected use of 'confirm'.","line":368,"column":10,"nodeType":"Identifier","messageId":"defaultMessage","endLine":368,"endColumn":17}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { \r\n  BookOpenIcon, \r\n  PlusIcon,\r\n  PencilIcon,\r\n  TrashIcon,\r\n  DocumentTextIcon,\r\n  FolderIcon,\r\n  SearchIcon,\r\n  UploadIcon,\r\n  CheckCircleIcon,\r\n  ExclamationTriangleIcon,\r\n  ChartBarIcon\r\n} from '@heroicons/react/24/outline';\r\nimport { supabase } from '../../lib/supabase.js';\r\n\r\n/**\r\n * Gestor de Base de Conocimiento para WhatsApp Business\r\n * \r\n * Este componente permite:\r\n * - Crear y gestionar FAQs\r\n * - Subir documentos de conocimiento\r\n * - Organizar informaci√≥n por categor√≠as\r\n * - Integrar con WhatsApp de forma cumplida\r\n * - Buscar y consultar conocimiento\r\n */\r\n\r\nconst KnowledgeBaseManager = ({ companyId }) => {\r\n  const [loading, setLoading] = useState(true);\r\n  const [activeTab, setActiveTab] = useState('faq');\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [selectedCategory, setSelectedCategory] = useState('all');\r\n  \r\n  // Estados para FAQs\r\n  const [faqs, setFaqs] = useState([]);\r\n  const [editingFaq, setEditingFaq] = useState(null);\r\n  const [showFaqForm, setShowFaqForm] = useState(false);\r\n  \r\n  // Estados para documentos\r\n  const [documents, setDocuments] = useState([]);\r\n  const [uploading, setUploading] = useState(false);\r\n  \r\n  // Estados para categor√≠as\r\n  const [categories, setCategories] = useState([]);\r\n  const [showCategoryForm, setShowCategoryForm] = useState(false);\r\n  const [editingCategory, setEditingCategory] = useState(null);\r\n  \r\n  // Estad√≠sticas\r\n  const [stats, setStats] = useState({\r\n    totalFaqs: 0,\r\n    totalDocuments: 0,\r\n    totalCategories: 0,\r\n    lastUpdated: null\r\n  });\r\n\r\n  // Cargar datos iniciales\r\n  useEffect(() => {\r\n    if (companyId) {\r\n      loadKnowledgeBaseData();\r\n    }\r\n  }, [companyId]);\r\n\r\n  const loadKnowledgeBaseData = async () => {\r\n    try {\r\n      setLoading(true);\r\n      \r\n      const [\r\n        faqsData,\r\n        documentsData,\r\n        categoriesData,\r\n        statsData\r\n      ] = await Promise.all([\r\n        loadFAQs(),\r\n        loadDocuments(),\r\n        loadCategories(),\r\n        loadStats()\r\n      ]);\r\n\r\n      setFaqs(faqsData);\r\n      setDocuments(documentsData);\r\n      setCategories(categoriesData);\r\n      setStats(statsData);\r\n\r\n    } catch (error) {\r\n      console.error('Error cargando base de conocimiento:', error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const loadFAQs = async () => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('faq_entries')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (error) throw error;\r\n      return data || [];\r\n    } catch (error) {\r\n      console.error('Error cargando FAQs:', error);\r\n      return [];\r\n    }\r\n  };\r\n\r\n  const loadDocuments = async () => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('knowledge_documents')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (error) throw error;\r\n      return data || [];\r\n    } catch (error) {\r\n      console.error('Error cargando documentos:', error);\r\n      return [];\r\n    }\r\n  };\r\n\r\n  const loadCategories = async () => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('knowledge_categories')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .order('name', { ascending: true });\r\n\r\n      if (error) throw error;\r\n      return data || [];\r\n    } catch (error) {\r\n      console.error('Error cargando categor√≠as:', error);\r\n      return [];\r\n    }\r\n  };\r\n\r\n  const loadStats = async () => {\r\n    try {\r\n      const [faqsCount, documentsCount, categoriesCount] = await Promise.all([\r\n        supabase.from('faq_entries').select('id', { count: 'exact' }).eq('company_id', companyId),\r\n        supabase.from('knowledge_documents').select('id', { count: 'exact' }).eq('company_id', companyId),\r\n        supabase.from('knowledge_categories').select('id', { count: 'exact' }).eq('company_id', companyId)\r\n      ]);\r\n\r\n      const lastUpdated = new Date().toISOString();\r\n\r\n      return {\r\n        totalFaqs: faqsCount.count || 0,\r\n        totalDocuments: documentsCount.count || 0,\r\n        totalCategories: categoriesCount.count || 0,\r\n        lastUpdated\r\n      };\r\n    } catch (error) {\r\n      console.error('Error cargando estad√≠sticas:', error);\r\n      return {\r\n        totalFaqs: 0,\r\n        totalDocuments: 0,\r\n        totalCategories: 0,\r\n        lastUpdated: null\r\n      };\r\n    }\r\n  };\r\n\r\n  const handleSaveFAQ = async (faqData) => {\r\n    try {\r\n      const faqToSave = {\r\n        ...faqData,\r\n        company_id: companyId,\r\n        status: 'active',\r\n        updated_at: new Date().toISOString()\r\n      };\r\n\r\n      let result;\r\n      if (editingFaq) {\r\n        // Actualizar FAQ existente\r\n        const { data, error } = await supabase\r\n          .from('faq_entries')\r\n          .update(faqToSave)\r\n          .eq('id', editingFaq.id)\r\n          .select()\r\n          .single();\r\n\r\n        if (error) throw error;\r\n        result = data;\r\n      } else {\r\n        // Crear nueva FAQ\r\n        const { data, error } = await supabase\r\n          .from('faq_entries')\r\n          .insert({ ...faqToSave, created_at: new Date().toISOString() })\r\n          .select()\r\n          .single();\r\n\r\n        if (error) throw error;\r\n        result = data;\r\n      }\r\n\r\n      // Recargar datos\r\n      await loadKnowledgeBaseData();\r\n      \r\n      // Resetear formulario\r\n      setEditingFaq(null);\r\n      setShowFaqForm(false);\r\n\r\n      return { success: true, data: result };\r\n\r\n    } catch (error) {\r\n      console.error('Error guardando FAQ:', error);\r\n      return { success: false, error: error.message };\r\n    }\r\n  };\r\n\r\n  const handleDeleteFAQ = async (faqId) => {\r\n    if (!confirm('¬øEst√°s seguro de eliminar esta FAQ?')) return;\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from('faq_entries')\r\n        .delete()\r\n        .eq('id', faqId);\r\n\r\n      if (error) throw error;\r\n\r\n      // Recargar datos\r\n      await loadKnowledgeBaseData();\r\n\r\n    } catch (error) {\r\n      console.error('Error eliminando FAQ:', error);\r\n    }\r\n  };\r\n\r\n  const handleDocumentUpload = async (file, categoryId, description) => {\r\n    try {\r\n      setUploading(true);\r\n\r\n      // 1. Subir archivo a storage\r\n      const fileName = `${companyId}/${Date.now()}-${file.name}`;\r\n      const { data: uploadData, error: uploadError } = await supabase.storage\r\n        .from('knowledge-documents')\r\n        .upload(fileName, file);\r\n\r\n      if (uploadError) throw uploadError;\r\n\r\n      // 2. Obtener URL p√∫blica\r\n      const { data: urlData } = supabase.storage\r\n        .from('knowledge-documents')\r\n        .getPublicUrl(fileName);\r\n\r\n      // 3. Guardar metadata en base de datos\r\n      const { data: docData, error: dbError } = await supabase\r\n        .from('knowledge_documents')\r\n        .insert({\r\n          company_id: companyId,\r\n          title: file.name,\r\n          description: description || '',\r\n          file_name: file.name,\r\n          file_path: fileName,\r\n          file_url: urlData.publicUrl,\r\n          file_size: file.size,\r\n          file_type: file.type,\r\n          category_id: categoryId,\r\n          status: 'active',\r\n          created_at: new Date().toISOString()\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (dbError) throw dbError;\r\n\r\n      // Recargar datos\r\n      await loadKnowledgeBaseData();\r\n\r\n      return { success: true, data: docData };\r\n\r\n    } catch (error) {\r\n      console.error('Error subiendo documento:', error);\r\n      return { success: false, error: error.message };\r\n    } finally {\r\n      setUploading(false);\r\n    }\r\n  };\r\n\r\n  const handleDeleteDocument = async (docId) => {\r\n    if (!confirm('¬øEst√°s seguro de eliminar este documento?')) return;\r\n\r\n    try {\r\n      // Obtener informaci√≥n del documento\r\n      const { data: doc, error: fetchError } = await supabase\r\n        .from('knowledge_documents')\r\n        .select('*')\r\n        .eq('id', docId)\r\n        .single();\r\n\r\n      if (fetchError) throw fetchError;\r\n\r\n      // Eliminar archivo del storage\r\n      const { error: storageError } = await supabase.storage\r\n        .from('knowledge-documents')\r\n        .remove([doc.file_path]);\r\n\r\n      if (storageError) throw storageError;\r\n\r\n      // Eliminar registro de la base de datos\r\n      const { error: dbError } = await supabase\r\n        .from('knowledge_documents')\r\n        .delete()\r\n        .eq('id', docId);\r\n\r\n      if (dbError) throw dbError;\r\n\r\n      // Recargar datos\r\n      await loadKnowledgeBaseData();\r\n\r\n    } catch (error) {\r\n      console.error('Error eliminando documento:', error);\r\n    }\r\n  };\r\n\r\n  const handleSaveCategory = async (categoryData) => {\r\n    try {\r\n      const categoryToSave = {\r\n        ...categoryData,\r\n        company_id: companyId,\r\n        updated_at: new Date().toISOString()\r\n      };\r\n\r\n      let result;\r\n      if (editingCategory) {\r\n        // Actualizar categor√≠a existente\r\n        const { data, error } = await supabase\r\n          .from('knowledge_categories')\r\n          .update(categoryToSave)\r\n          .eq('id', editingCategory.id)\r\n          .select()\r\n          .single();\r\n\r\n        if (error) throw error;\r\n        result = data;\r\n      } else {\r\n        // Crear nueva categor√≠a\r\n        const { data, error } = await supabase\r\n          .from('knowledge_categories')\r\n          .insert({ ...categoryToSave, created_at: new Date().toISOString() })\r\n          .select()\r\n          .single();\r\n\r\n        if (error) throw error;\r\n        result = data;\r\n      }\r\n\r\n      // Recargar datos\r\n      await loadKnowledgeBaseData();\r\n      \r\n      // Resetear formulario\r\n      setEditingCategory(null);\r\n      setShowCategoryForm(false);\r\n\r\n      return { success: true, data: result };\r\n\r\n    } catch (error) {\r\n      console.error('Error guardando categor√≠a:', error);\r\n      return { success: false, error: error.message };\r\n    }\r\n  };\r\n\r\n  const handleDeleteCategory = async (categoryId) => {\r\n    if (!confirm('¬øEst√°s seguro de eliminar esta categor√≠a?')) return;\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from('knowledge_categories')\r\n        .delete()\r\n        .eq('id', categoryId);\r\n\r\n      if (error) throw error;\r\n\r\n      // Recargar datos\r\n      await loadKnowledgeBaseData();\r\n\r\n    } catch (error) {\r\n      console.error('Error eliminando categor√≠a:', error);\r\n    }\r\n  };\r\n\r\n  // Filtrar FAQs seg√∫n b√∫squeda y categor√≠a\r\n  const filteredFaqs = faqs.filter(faq => {\r\n    const matchesSearch = !searchTerm || \r\n      faq.question.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n      faq.answer.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n      faq.keywords?.toLowerCase().includes(searchTerm.toLowerCase());\r\n    \r\n    const matchesCategory = selectedCategory === 'all' || faq.category_id === selectedCategory;\r\n    \r\n    return matchesSearch && matchesCategory;\r\n  });\r\n\r\n  // Filtrar documentos seg√∫n b√∫squeda y categor√≠a\r\n  const filteredDocuments = documents.filter(doc => {\r\n    const matchesSearch = !searchTerm || \r\n      doc.title.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n      doc.description?.toLowerCase().includes(searchTerm.toLowerCase());\r\n    \r\n    const matchesCategory = selectedCategory === 'all' || doc.category_id === selectedCategory;\r\n    \r\n    return matchesSearch && matchesCategory;\r\n  });\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center p-8\">\r\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600\"></div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-6\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center space-x-3\">\r\n            <BookOpenIcon className=\"h-8 w-8 text-blue-600\" />\r\n            <div>\r\n              <h1 className=\"text-2xl font-bold text-gray-900\">Base de Conocimiento</h1>\r\n              <p className=\"text-gray-600\">Gestiona FAQs y documentos para WhatsApp Business</p>\r\n            </div>\r\n          </div>\r\n          \r\n          <div className=\"flex items-center space-x-4\">\r\n            <div className=\"text-sm text-gray-500\">\r\n              <span className=\"font-medium\">{stats.totalFaqs}</span> FAQs ‚Ä¢ \r\n              <span className=\"font-medium ml-1\">{stats.totalDocuments}</span> Docs\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Stats Cards */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\r\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-sm text-gray-600\">Total FAQs</p>\r\n              <p className=\"text-2xl font-bold text-blue-600\">{stats.totalFaqs}</p>\r\n            </div>\r\n            <DocumentTextIcon className=\"h-8 w-8 text-blue-600\" />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-sm text-gray-600\">Documentos</p>\r\n              <p className=\"text-2xl font-bold text-green-600\">{stats.totalDocuments}</p>\r\n            </div>\r\n            <FolderIcon className=\"h-8 w-8 text-green-600\" />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-sm text-gray-600\">Categor√≠as</p>\r\n              <p className=\"text-2xl font-bold text-purple-600\">{stats.totalCategories}</p>\r\n            </div>\r\n            <ChartBarIcon className=\"h-8 w-8 text-purple-600\" />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-sm text-gray-600\">Estado</p>\r\n              <p className=\"text-lg font-bold text-green-600\">Activo</p>\r\n            </div>\r\n            <CheckCircleIcon className=\"h-8 w-8 text-green-600\" />\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Search and Filters */}\r\n      <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-4\">\r\n        <div className=\"flex flex-col md:flex-row gap-4\">\r\n          <div className=\"flex-1\">\r\n            <div className=\"relative\">\r\n              <SearchIcon className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400\" />\r\n              <input\r\n                type=\"text\"\r\n                placeholder=\"Buscar FAQs y documentos...\"\r\n                value={searchTerm}\r\n                onChange={(e) => setSearchTerm(e.target.value)}\r\n                className=\"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n              />\r\n            </div>\r\n          </div>\r\n          \r\n          <div className=\"flex items-center space-x-2\">\r\n            <label className=\"text-sm font-medium text-gray-700\">Categor√≠a:</label>\r\n            <select\r\n              value={selectedCategory}\r\n              onChange={(e) => setSelectedCategory(e.target.value)}\r\n              className=\"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n            >\r\n              <option value=\"all\">Todas</option>\r\n              {categories.map(category => (\r\n                <option key={category.id} value={category.id}>\r\n                  {category.name}\r\n                </option>\r\n              ))}\r\n            </select>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Tabs */}\r\n      <div className=\"bg-white rounded-lg shadow-sm border border-gray-200\">\r\n        <div className=\"border-b border-gray-200\">\r\n          <nav className=\"flex space-x-8 px-6\" aria-label=\"Tabs\">\r\n            {[\r\n              { id: 'faq', name: 'FAQs', icon: DocumentTextIcon },\r\n              { id: 'documents', name: 'Documentos', icon: FolderIcon },\r\n              { id: 'categories', name: 'Categor√≠as', icon: ChartBarIcon }\r\n            ].map((tab) => (\r\n              <button\r\n                key={tab.id}\r\n                onClick={() => setActiveTab(tab.id)}\r\n                className={`py-4 px-1 border-b-2 font-medium text-sm ${\r\n                  activeTab === tab.id\r\n                    ? 'border-blue-500 text-blue-600'\r\n                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'\r\n                }`}\r\n              >\r\n                <div className=\"flex items-center space-x-2\">\r\n                  <tab.icon className=\"h-5 w-5\" />\r\n                  <span>{tab.name}</span>\r\n                </div>\r\n              </button>\r\n            ))}\r\n          </nav>\r\n        </div>\r\n\r\n        <div className=\"p-6\">\r\n          {/* Tab Content */}\r\n          {activeTab === 'faq' && (\r\n            <div className=\"space-y-4\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <h3 className=\"text-lg font-medium text-gray-900\">Preguntas Frecuentes</h3>\r\n                <button\r\n                  onClick={() => setShowFaqForm(true)}\r\n                  className=\"flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700\"\r\n                >\r\n                  <PlusIcon className=\"h-5 w-5\" />\r\n                  <span>Nueva FAQ</span>\r\n                </button>\r\n              </div>\r\n\r\n              {showFaqForm && (\r\n                <FAQForm\r\n                  faq={editingFaq}\r\n                  categories={categories}\r\n                  onSave={handleSaveFAQ}\r\n                  onCancel={() => {\r\n                    setShowFaqForm(false);\r\n                    setEditingFaq(null);\r\n                  }}\r\n                />\r\n              )}\r\n\r\n              {filteredFaqs.length === 0 ? (\r\n                <div className=\"text-center py-8 text-gray-500\">\r\n                  {searchTerm || selectedCategory !== 'all' \r\n                    ? 'No hay FAQs que coincidan con los filtros' \r\n                    : 'No hay FAQs registradas'}\r\n                </div>\r\n              ) : (\r\n                <div className=\"space-y-3\">\r\n                  {filteredFaqs.map((faq) => (\r\n                    <div key={faq.id} className=\"border border-gray-200 rounded-lg p-4\">\r\n                      <div className=\"flex items-start justify-between\">\r\n                        <div className=\"flex-1\">\r\n                          <h4 className=\"font-medium text-gray-900\">{faq.question}</h4>\r\n                          <p className=\"mt-2 text-gray-600\">{faq.answer}</p>\r\n                          {faq.keywords && (\r\n                            <div className=\"mt-2 flex flex-wrap gap-1\">\r\n                              {faq.keywords.split(',').map((keyword, index) => (\r\n                                <span key={index} className=\"px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full\">\r\n                                  {keyword.trim()}\r\n                                </span>\r\n                              ))}\r\n                            </div>\r\n                          )}\r\n                          <div className=\"mt-2 flex items-center space-x-4 text-sm text-gray-500\">\r\n                            <span>Categor√≠a: {categories.find(c => c.id === faq.category_id)?.name || 'Sin categor√≠a'}</span>\r\n                            <span>Prioridad: {faq.priority}</span>\r\n                          </div>\r\n                        </div>\r\n                        <div className=\"flex items-center space-x-2 ml-4\">\r\n                          <button\r\n                            onClick={() => {\r\n                              setEditingFaq(faq);\r\n                              setShowFaqForm(true);\r\n                            }}\r\n                            className=\"p-2 text-blue-600 hover:bg-blue-50 rounded-lg\"\r\n                          >\r\n                            <PencilIcon className=\"h-4 w-4\" />\r\n                          </button>\r\n                          <button\r\n                            onClick={() => handleDeleteFAQ(faq.id)}\r\n                            className=\"p-2 text-red-600 hover:bg-red-50 rounded-lg\"\r\n                          >\r\n                            <TrashIcon className=\"h-4 w-4\" />\r\n                          </button>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {activeTab === 'documents' && (\r\n            <div className=\"space-y-4\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <h3 className=\"text-lg font-medium text-gray-900\">Documentos</h3>\r\n                <DocumentUpload\r\n                  onUpload={handleDocumentUpload}\r\n                  categories={categories}\r\n                  uploading={uploading}\r\n                />\r\n              </div>\r\n\r\n              {filteredDocuments.length === 0 ? (\r\n                <div className=\"text-center py-8 text-gray-500\">\r\n                  {searchTerm || selectedCategory !== 'all' \r\n                    ? 'No hay documentos que coincidan con los filtros' \r\n                    : 'No hay documentos registrados'}\r\n                </div>\r\n              ) : (\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                  {filteredDocuments.map((doc) => (\r\n                    <div key={doc.id} className=\"border border-gray-200 rounded-lg p-4\">\r\n                      <div className=\"flex items-start justify-between\">\r\n                        <div className=\"flex-1\">\r\n                          <h4 className=\"font-medium text-gray-900 truncate\">{doc.title}</h4>\r\n                          {doc.description && (\r\n                            <p className=\"mt-1 text-sm text-gray-600 line-clamp-2\">{doc.description}</p>\r\n                          )}\r\n                          <div className=\"mt-2 text-xs text-gray-500\">\r\n                            <div>Tama√±o: {(doc.file_size / 1024).toFixed(1)} KB</div>\r\n                            <div>Tipo: {doc.file_type}</div>\r\n                            <div>Categor√≠a: {categories.find(c => c.id === doc.category_id)?.name || 'Sin categor√≠a'}</div>\r\n                          </div>\r\n                        </div>\r\n                        <div className=\"flex items-center space-x-1 ml-2\">\r\n                          <a\r\n                            href={doc.file_url}\r\n                            target=\"_blank\"\r\n                            rel=\"noopener noreferrer\"\r\n                            className=\"p-2 text-blue-600 hover:bg-blue-50 rounded-lg\"\r\n                            title=\"Ver documento\"\r\n                          >\r\n                            <DocumentTextIcon className=\"h-4 w-4\" />\r\n                          </a>\r\n                          <button\r\n                            onClick={() => handleDeleteDocument(doc.id)}\r\n                            className=\"p-2 text-red-600 hover:bg-red-50 rounded-lg\"\r\n                            title=\"Eliminar documento\"\r\n                          >\r\n                            <TrashIcon className=\"h-4 w-4\" />\r\n                          </button>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {activeTab === 'categories' && (\r\n            <div className=\"space-y-4\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <h3 className=\"text-lg font-medium text-gray-900\">Categor√≠as</h3>\r\n                <button\r\n                  onClick={() => setShowCategoryForm(true)}\r\n                  className=\"flex items-center space-x-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700\"\r\n                >\r\n                  <PlusIcon className=\"h-5 w-5\" />\r\n                  <span>Nueva Categor√≠a</span>\r\n                </button>\r\n              </div>\r\n\r\n              {showCategoryForm && (\r\n                <CategoryForm\r\n                  category={editingCategory}\r\n                  onSave={handleSaveCategory}\r\n                  onCancel={() => {\r\n                    setShowCategoryForm(false);\r\n                    setEditingCategory(null);\r\n                  }}\r\n                />\r\n              )}\r\n\r\n              {categories.length === 0 ? (\r\n                <div className=\"text-center py-8 text-gray-500\">\r\n                  No hay categor√≠as registradas\r\n                </div>\r\n              ) : (\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                  {categories.map((category) => (\r\n                    <div key={category.id} className=\"border border-gray-200 rounded-lg p-4\">\r\n                      <div className=\"flex items-start justify-between\">\r\n                        <div className=\"flex-1\">\r\n                          <h4 className=\"font-medium text-gray-900\">{category.name}</h4>\r\n                          {category.description && (\r\n                            <p className=\"mt-1 text-sm text-gray-600\">{category.description}</p>\r\n                          )}\r\n                          <div className=\"mt-2 text-xs text-gray-500\">\r\n                            <div>Color: {category.color}</div>\r\n                            <div>FAQs: {faqs.filter(f => f.category_id === category.id).length}</div>\r\n                            <div>Documentos: {documents.filter(d => d.category_id === category.id).length}</div>\r\n                          </div>\r\n                        </div>\r\n                        <div className=\"flex items-center space-x-2 ml-4\">\r\n                          <button\r\n                            onClick={() => {\r\n                              setEditingCategory(category);\r\n                              setShowCategoryForm(true);\r\n                            }}\r\n                            className=\"p-2 text-purple-600 hover:bg-purple-50 rounded-lg\"\r\n                          >\r\n                            <PencilIcon className=\"h-4 w-4\" />\r\n                          </button>\r\n                          <button\r\n                            onClick={() => handleDeleteCategory(category.id)}\r\n                            className=\"p-2 text-red-600 hover:bg-red-50 rounded-lg\"\r\n                          >\r\n                            <TrashIcon className=\"h-4 w-4\" />\r\n                          </button>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\n// Componente para formulario de FAQ\r\nconst FAQForm = ({ faq, categories, onSave, onCancel }) => {\r\n  const [formData, setFormData] = useState({\r\n    question: faq?.question || '',\r\n    answer: faq?.answer || '',\r\n    keywords: faq?.keywords || '',\r\n    category_id: faq?.category_id || '',\r\n    priority: faq?.priority || 1\r\n  });\r\n\r\n  const handleSubmit = (e) => {\r\n    e.preventDefault();\r\n    onSave(formData);\r\n  };\r\n\r\n  return (\r\n    <div className=\"border border-gray-200 rounded-lg p-6 bg-gray-50\">\r\n      <h4 className=\"text-lg font-medium text-gray-900 mb-4\">\r\n        {faq ? 'Editar FAQ' : 'Nueva FAQ'}\r\n      </h4>\r\n      \r\n      <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n            Pregunta\r\n          </label>\r\n          <input\r\n            type=\"text\"\r\n            value={formData.question}\r\n            onChange={(e) => setFormData({ ...formData, question: e.target.value })}\r\n            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n            required\r\n          />\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n            Respuesta\r\n          </label>\r\n          <textarea\r\n            value={formData.answer}\r\n            onChange={(e) => setFormData({ ...formData, answer: e.target.value })}\r\n            rows={4}\r\n            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n            required\r\n          />\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n            Palabras clave (separadas por comas)\r\n          </label>\r\n          <input\r\n            type=\"text\"\r\n            value={formData.keywords}\r\n            onChange={(e) => setFormData({ ...formData, keywords: e.target.value })}\r\n            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n            placeholder=\"palabra1, palabra2, palabra3\"\r\n          />\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-2 gap-4\">\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n              Categor√≠a\r\n            </label>\r\n            <select\r\n              value={formData.category_id}\r\n              onChange={(e) => setFormData({ ...formData, category_id: e.target.value })}\r\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n            >\r\n              <option value=\"\">Seleccionar categor√≠a</option>\r\n              {categories.map(category => (\r\n                <option key={category.id} value={category.id}>\r\n                  {category.name}\r\n                </option>\r\n              ))}\r\n            </select>\r\n          </div>\r\n\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n              Prioridad\r\n            </label>\r\n            <select\r\n              value={formData.priority}\r\n              onChange={(e) => setFormData({ ...formData, priority: parseInt(e.target.value) })}\r\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n            >\r\n              <option value={1}>Alta</option>\r\n              <option value={2}>Media</option>\r\n              <option value={3}>Baja</option>\r\n            </select>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"flex justify-end space-x-3\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={onCancel}\r\n            className=\"px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50\"\r\n          >\r\n            Cancelar\r\n          </button>\r\n          <button\r\n            type=\"submit\"\r\n            className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700\"\r\n          >\r\n            {faq ? 'Actualizar' : 'Guardar'}\r\n          </button>\r\n        </div>\r\n      </form>\r\n    </div>\r\n  );\r\n};\r\n\r\n// Componente para subir documentos\r\nconst DocumentUpload = ({ onUpload, categories, uploading }) => {\r\n  const [file, setFile] = useState(null);\r\n  const [categoryId, setCategoryId] = useState('');\r\n  const [description, setDescription] = useState('');\r\n\r\n  const handleSubmit = (e) => {\r\n    e.preventDefault();\r\n    if (file && categoryId) {\r\n      onUpload(file, categoryId, description);\r\n      // Resetear formulario\r\n      setFile(null);\r\n      setCategoryId('');\r\n      setDescription('');\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"flex items-center space-x-3\">\r\n      <input\r\n        type=\"file\"\r\n        onChange={(e) => setFile(e.target.files[0])}\r\n        className=\"hidden\"\r\n        id=\"document-upload\"\r\n        accept=\".pdf,.doc,.docx,.txt,.md\"\r\n      />\r\n      <label\r\n        htmlFor=\"document-upload\"\r\n        className=\"flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 cursor-pointer\"\r\n      >\r\n        <UploadIcon className=\"h-5 w-5\" />\r\n        <span>Subir Documento</span>\r\n      </label>\r\n\r\n      {file && (\r\n        <form onSubmit={handleSubmit} className=\"flex items-center space-x-3\">\r\n          <select\r\n            value={categoryId}\r\n            onChange={(e) => setCategoryId(e.target.value)}\r\n            className=\"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\r\n            required\r\n          >\r\n            <option value=\"\">Categor√≠a</option>\r\n            {categories.map(category => (\r\n              <option key={category.id} value={category.id}>\r\n                {category.name}\r\n              </option>\r\n            ))}\r\n          </select>\r\n\r\n          <input\r\n            type=\"text\"\r\n            value={description}\r\n            onChange={(e) => setDescription(e.target.value)}\r\n            placeholder=\"Descripci√≥n (opcional)\"\r\n            className=\"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\r\n          />\r\n\r\n          <button\r\n            type=\"submit\"\r\n            disabled={uploading}\r\n            className=\"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50\"\r\n          >\r\n            {uploading ? 'Subiendo...' : 'Subir'}\r\n          </button>\r\n\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => setFile(null)}\r\n            className=\"px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50\"\r\n          >\r\n            Cancelar\r\n          </button>\r\n        </form>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\n// Componente para formulario de categor√≠as\r\nconst CategoryForm = ({ category, onSave, onCancel }) => {\r\n  const [formData, setFormData] = useState({\r\n    name: category?.name || '',\r\n    description: category?.description || '',\r\n    color: category?.color || '#3B82F6'\r\n  });\r\n\r\n  const handleSubmit = (e) => {\r\n    e.preventDefault();\r\n    onSave(formData);\r\n  };\r\n\r\n  return (\r\n    <div className=\"border border-gray-200 rounded-lg p-6 bg-gray-50\">\r\n      <h4 className=\"text-lg font-medium text-gray-900 mb-4\">\r\n        {category ? 'Editar Categor√≠a' : 'Nueva Categor√≠a'}\r\n      </h4>\r\n      \r\n      <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n            Nombre\r\n          </label>\r\n          <input\r\n            type=\"text\"\r\n            value={formData.name}\r\n            onChange={(e) => setFormData({ ...formData, name: e.target.value })}\r\n            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent\"\r\n            required\r\n          />\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n            Descripci√≥n\r\n          </label>\r\n          <textarea\r\n            value={formData.description}\r\n            onChange={(e) => setFormData({ ...formData, description: e.target.value })}\r\n            rows={3}\r\n            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent\"\r\n          />\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n            Color\r\n          </label>\r\n          <input\r\n            type=\"color\"\r\n            value={formData.color}\r\n            onChange={(e) => setFormData({ ...formData, color: e.target.value })}\r\n            className=\"w-full h-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent\"\r\n          />\r\n        </div>\r\n\r\n        <div className=\"flex justify-end space-x-3\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={onCancel}\r\n            className=\"px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50\"\r\n          >\r\n            Cancelar\r\n          </button>\r\n          <button\r\n            type=\"submit\"\r\n            className=\"px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700\"\r\n          >\r\n            {category ? 'Actualizar' : 'Guardar'}\r\n          </button>\r\n        </div>\r\n      </form>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default KnowledgeBaseManager;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\layout\\DebugRutas.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\layout\\Navbar.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\layout\\SelectorInicio.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\legal\\Abogado.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\legal\\BusquedaLeyes.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'formatDate' is assigned a value but never used.","line":51,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":51,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react'\r\nimport { MagnifyingGlassIcon, DocumentTextIcon, CalendarIcon, LinkIcon } from '@heroicons/react/24/outline'\r\n\r\nconst BusquedaLeyes = () => {\r\n  const [searchTerm, setSearchTerm] = useState('')\r\n  const [results, setResults] = useState([])\r\n  const [loading, setLoading] = useState(false)\r\n  const [error, setError] = useState('')\r\n  const [expandedContent, setExpandedContent] = useState(new Set())\r\n\r\n  const searchLaws = async () => {\r\n    if (!searchTerm.trim()) {\r\n      setError('Por favor ingresa un t√©rmino de b√∫squeda')\r\n      return\r\n    }\r\n\r\n    setLoading(true)\r\n    setError('')\r\n    \r\n    try {\r\n      const response = await fetch(\r\n        `${process.env.REACT_APP_SUPABASE_URL}/rest/v1/leyes_con_contenido?select=*&or=(${encodeURIComponent('T√≠tulo de la Norma')}.ilike.*${encodeURIComponent(searchTerm)}*,${encodeURIComponent('Contenido')}.ilike.*${encodeURIComponent(searchTerm)}*)`,\r\n        {\r\n          headers: {\r\n            'apikey': process.env.REACT_APP_SUPABASE_ANON_KEY,\r\n            'Authorization': `Bearer ${process.env.REACT_APP_SUPABASE_ANON_KEY}`,\r\n            'Content-Type': 'application/json'\r\n          }\r\n        }\r\n      )\r\n\r\n      if (!response.ok) {\r\n        throw new Error('Error al buscar leyes')\r\n      }\r\n\r\n      const data = await response.json()\r\n      setResults(data)\r\n    } catch (err) {\r\n      setError('Error al realizar la b√∫squeda. Intenta nuevamente.')\r\n      console.error('Error searching laws:', err)\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleSubmit = (e) => {\r\n    e.preventDefault()\r\n    searchLaws()\r\n  }\r\n\r\n  const formatDate = (dateString) => {\r\n    if (!dateString) return 'No disponible'\r\n    return new Date(dateString).toLocaleDateString('es-CL')\r\n  }\r\n\r\n  const truncateContent = (content, maxLength = 300) => {\r\n    if (!content) return 'Contenido no disponible'\r\n    return content.length > maxLength ? content.substring(0, maxLength) + '...' : content\r\n  }\r\n\r\n  const toggleContentExpansion = (index) => {\r\n    const newExpanded = new Set(expandedContent)\r\n    if (newExpanded.has(index)) {\r\n      newExpanded.delete(index)\r\n    } else {\r\n      newExpanded.add(index)\r\n    }\r\n    setExpandedContent(newExpanded)\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-6\">\r\n      {/* Search Form */}\r\n      <form onSubmit={handleSubmit} className=\"mb-6\">\r\n        <div className=\"flex gap-4\">\r\n          <div className=\"flex-1\">\r\n            <div className=\"relative\">\r\n              <MagnifyingGlassIcon className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400\" />\r\n              <input\r\n                type=\"text\"\r\n                value={searchTerm}\r\n                onChange={(e) => setSearchTerm(e.target.value)}\r\n                placeholder=\"Buscar leyes por t√≠tulo o contenido...\"\r\n                className=\"w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n              />\r\n            </div>\r\n          </div>\r\n          <button\r\n            type=\"submit\"\r\n            disabled={loading}\r\n            className=\"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\r\n          >\r\n            {loading ? 'Buscando...' : 'Buscar'}\r\n          </button>\r\n        </div>\r\n      </form>\r\n\r\n      {/* Error Message */}\r\n      {error && (\r\n        <div className=\"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg\">\r\n          <p className=\"text-red-700\">{error}</p>\r\n        </div>\r\n      )}\r\n\r\n      {/* Results */}\r\n      {results.length > 0 && (\r\n        <div className=\"space-y-4\">\r\n          <h3 className=\"text-lg font-semibold text-gray-900\">\r\n            {results.length} resultado{results.length !== 1 ? 's' : ''} encontrado{results.length !== 1 ? 's' : ''}\r\n          </h3>\r\n          \r\n          {results.map((law, index) => (\r\n            <div key={index} className=\"bg-gray-50 rounded-lg p-6 border border-gray-200\">\r\n              <div className=\"flex items-start justify-between mb-4\">\r\n                <div className=\"flex-1\">\r\n                  <h4 className=\"text-xl font-semibold text-gray-900 mb-2\">\r\n                    {law['T√≠tulo de la Norma'] || 'T√≠tulo no disponible'}\r\n                  </h4>\r\n                  \r\n                  <div className=\"flex flex-wrap gap-4 text-sm text-gray-600 mb-3\">\r\n                    {law['Fecha de Publicaci√≥n'] && (\r\n                      <div className=\"flex items-center\">\r\n                        <CalendarIcon className=\"h-4 w-4 mr-1\" />\r\n                        <span>Publicaci√≥n: {law['Fecha de Publicaci√≥n']}</span>\r\n                      </div>\r\n                    )}\r\n                    \r\n                    {law['A√±o de Publicaci√≥n'] && (\r\n                      <div className=\"flex items-center\">\r\n                        <DocumentTextIcon className=\"h-4 w-4 mr-1\" />\r\n                        <span>A√±o: {law['A√±o de Publicaci√≥n']}</span>\r\n                      </div>\r\n                    )}\r\n                    \r\n                    {law['Es modificatoria'] === 'S√≠' && (\r\n                      <span className=\"bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs\">\r\n                        Modificatoria\r\n                      </span>\r\n                    )}\r\n                    \r\n                    {law['Derogado'] && (\r\n                      <span className=\"bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs\">\r\n                        Derogada\r\n                      </span>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n                \r\n                {law['Url'] && (\r\n                  <a\r\n                    href={law['Url']}\r\n                    target=\"_blank\"\r\n                    rel=\"noopener noreferrer\"\r\n                    className=\"flex items-center text-blue-600 hover:text-blue-800 transition-colors\"\r\n                  >\r\n                    <LinkIcon className=\"h-4 w-4 mr-1\" />\r\n                    <span className=\"text-sm\">Ver en BCN</span>\r\n                  </a>\r\n                )}\r\n              </div>\r\n              \r\n              <div className=\"bg-white rounded-lg p-4 border border-gray-200\">\r\n                <h5 className=\"font-medium text-gray-900 mb-2\">Contenido:</h5>\r\n                <p className=\"text-gray-700 text-sm leading-relaxed whitespace-pre-line\">\r\n                  {expandedContent.has(index) ? law['Contenido'] || 'Contenido no disponible' : truncateContent(law['Contenido'])}\r\n                </p>\r\n                \r\n                {law['Contenido'] && law['Contenido'].length > 300 && (\r\n                  <button \r\n                    onClick={() => toggleContentExpansion(index)}\r\n                    className=\"mt-2 text-blue-600 hover:text-blue-800 text-sm font-medium transition-colors\"\r\n                  >\r\n                    {expandedContent.has(index) ? 'Ver menos' : 'Ver contenido completo'}\r\n                  </button>\r\n                )}\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      )}\r\n\r\n      {/* No Results */}\r\n      {!loading && results.length === 0 && searchTerm && (\r\n        <div className=\"text-center py-8\">\r\n          <DocumentTextIcon className=\"h-16 w-16 text-gray-400 mx-auto mb-4\" />\r\n          <h3 className=\"text-lg font-medium text-gray-900 mb-2\">No se encontraron resultados</h3>\r\n          <p className=\"text-gray-600\">Intenta con otros t√©rminos de b√∫squeda</p>\r\n        </div>\r\n      )}\r\n\r\n      {/* Initial State */}\r\n      {!searchTerm && results.length === 0 && (\r\n        <div className=\"text-center py-12\">\r\n          <MagnifyingGlassIcon className=\"h-16 w-16 text-gray-400 mx-auto mb-4\" />\r\n          <h3 className=\"text-lg font-medium text-gray-900 mb-2\">B√∫squeda de Leyes Chilenas</h3>\r\n          <p className=\"text-gray-600 max-w-md mx-auto\">\r\n            Busca en la base de datos de leyes chilenas del BCN. Puedes buscar por t√≠tulo o contenido de la ley.\r\n          </p>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default BusquedaLeyes","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\legal\\ChatLegal.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\legal\\LawSearch.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\legal\\LegalChat.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\notifications\\EnhancedNotificationCenter.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'ArrowPathIcon' is defined but never used.","line":15,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'Cog6ToothIcon' is defined but never used.","line":16,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'FunnelIcon' is defined but never used.","line":17,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":13},{"ruleId":"no-unused-vars","severity":1,"message":"'ChevronDownIcon' is defined but never used.","line":21,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'StarIcon' is defined but never used.","line":28,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":11},{"ruleId":"no-unused-vars","severity":1,"message":"'ClockIcon' is defined but never used.","line":29,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":29,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'addNotification' is assigned a value but never used.","line":191,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":191,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Enhanced Notification Center\r\n * Centro de notificaciones unificado con agrupaci√≥n, acciones r√°pidas y gesti√≥n inteligente\r\n * \r\n * ‚úÖ NO MODIFICA c√≥digo existente\r\n * ‚úÖ Completamente independiente\r\n * ‚úÖ Puede ser desactivado sin afectar el sistema\r\n */\r\n\r\nimport React, { useState, useEffect, useRef, useCallback, useMemo } from 'react'\r\nimport { \r\n  BellIcon,\r\n  XMarkIcon,\r\n  CheckIcon,\r\n  ArrowPathIcon,\r\n  Cog6ToothIcon,\r\n  FunnelIcon,\r\n  ArchiveBoxIcon,\r\n  TrashIcon,\r\n  MagnifyingGlassIcon,\r\n  ChevronDownIcon,\r\n  UserIcon,\r\n  DocumentTextIcon,\r\n  ChatBubbleLeftRightIcon,\r\n  ExclamationTriangleIcon,\r\n  CheckCircleIcon,\r\n  InformationCircleIcon,\r\n  StarIcon,\r\n  ClockIcon,\r\n  EyeIcon,\r\n  EyeSlashIcon\r\n} from '@heroicons/react/24/outline'\r\n\r\nconst EnhancedNotificationCenter = ({ \r\n  maxNotifications = 50,\r\n  enableSounds = true,\r\n  enableDesktop = true,\r\n  autoMarkAsRead = false,\r\n  groupSimilar = true,\r\n  persistToStorage = true\r\n}) => {\r\n  const [isOpen, setIsOpen] = useState(false)\r\n  const [notifications, setNotifications] = useState([])\r\n  const [filter, setFilter] = useState('all')\r\n  const [searchTerm, setSearchTerm] = useState('')\r\n  const [showUnreadOnly, setShowUnreadOnly] = useState(false)\r\n  const [selectedNotifications, setSelectedNotifications] = useState(new Set())\r\n  const [settings, setSettings] = useState({\r\n    enableSounds,\r\n    enableDesktop,\r\n    autoMarkAsRead,\r\n    groupSimilar\r\n  })\r\n  \r\n  const notificationRef = useRef(null)\r\n  const soundRef = useRef(null)\r\n\r\n  // Tipos de notificaciones\r\n  const notificationTypes = useMemo(() => ({\r\n    info: { icon: InformationCircleIcon, color: 'blue', bgColor: 'bg-blue-50 dark:bg-blue-900/20', textColor: 'text-blue-700 dark:text-blue-400' },\r\n    success: { icon: CheckCircleIcon, color: 'green', bgColor: 'bg-green-50 dark:bg-green-900/20', textColor: 'text-green-700 dark:text-green-400' },\r\n    warning: { icon: ExclamationTriangleIcon, color: 'yellow', bgColor: 'bg-yellow-50 dark:bg-yellow-900/20', textColor: 'text-yellow-700 dark:text-yellow-400' },\r\n    error: { icon: ExclamationTriangleIcon, color: 'red', bgColor: 'bg-red-50 dark:bg-red-900/20', textColor: 'text-red-700 dark:text-red-400' },\r\n    message: { icon: ChatBubbleLeftRightIcon, color: 'purple', bgColor: 'bg-purple-50 dark:bg-purple-900/20', textColor: 'text-purple-700 dark:text-purple-400' },\r\n    document: { icon: DocumentTextIcon, color: 'indigo', bgColor: 'bg-indigo-50 dark:bg-indigo-900/20', textColor: 'text-indigo-700 dark:text-indigo-400' },\r\n    user: { icon: UserIcon, color: 'gray', bgColor: 'bg-gray-50 dark:bg-gray-900/20', textColor: 'text-gray-700 dark:text-gray-400' }\r\n  }), [])\r\n\r\n  // Cargar notificaciones desde localStorage\r\n  useEffect(() => {\r\n    if (persistToStorage) {\r\n      const savedNotifications = localStorage.getItem('notifications')\r\n      const savedSettings = localStorage.getItem('notificationSettings')\r\n      \r\n      if (savedNotifications) {\r\n        try {\r\n          setNotifications(JSON.parse(savedNotifications))\r\n        } catch (error) {\r\n          console.error('Error loading notifications:', error)\r\n        }\r\n      }\r\n      \r\n      if (savedSettings) {\r\n        try {\r\n          setSettings(JSON.parse(savedSettings))\r\n        } catch (error) {\r\n          console.error('Error loading settings:', error)\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Solicitar permisos para notificaciones de escritorio\r\n    if (settings.enableDesktop && 'Notification' in window) {\r\n      Notification.requestPermission()\r\n    }\r\n  }, [persistToStorage, settings.enableDesktop])\r\n\r\n  // Guardar notificaciones en localStorage\r\n  useEffect(() => {\r\n    if (persistToStorage && notifications.length > 0) {\r\n      localStorage.setItem('notifications', JSON.stringify(notifications.slice(-maxNotifications)))\r\n    }\r\n  }, [notifications, persistToStorage, maxNotifications])\r\n\r\n  // Guardar configuraci√≥n en localStorage\r\n  useEffect(() => {\r\n    if (persistToStorage) {\r\n      localStorage.setItem('notificationSettings', JSON.stringify(settings))\r\n    }\r\n  }, [settings, persistToStorage])\r\n\r\n  // Generar notificaciones de ejemplo\r\n  const generateSampleNotifications = useCallback(() => {\r\n    const samples = [\r\n      {\r\n        id: `notif-${Date.now()}-1`,\r\n        type: 'info',\r\n        title: 'Bienvenido al Centro de Notificaciones',\r\n        message: 'Aqu√≠ encontrar√°s todas tus notificaciones organizadas',\r\n        timestamp: new Date().toISOString(),\r\n        read: false,\r\n        priority: 'normal',\r\n        source: 'system',\r\n        actions: [\r\n          { label: 'Ver Tutorial', action: 'tutorial' },\r\n          { label: 'Configurar', action: 'settings' }\r\n        ]\r\n      },\r\n      {\r\n        id: `notif-${Date.now()}-2`,\r\n        type: 'success',\r\n        title: 'Empleado Actualizado',\r\n        message: 'Juan P√©rez ha sido actualizado exitosamente',\r\n        timestamp: new Date(Date.now() - 300000).toISOString(),\r\n        read: false,\r\n        priority: 'normal',\r\n        source: 'employees',\r\n        actions: [\r\n          { label: 'Ver Perfil', action: 'view' },\r\n          { label: 'Editar', action: 'edit' }\r\n        ]\r\n      },\r\n      {\r\n        id: `notif-${Date.now()}-3`,\r\n        type: 'warning',\r\n        title: 'Licencia por Vencer',\r\n        message: 'La licencia de Mar√≠a Gonz√°lez vence en 3 d√≠as',\r\n        timestamp: new Date(Date.now() - 600000).toISOString(),\r\n        read: false,\r\n        priority: 'high',\r\n        source: 'hr',\r\n        actions: [\r\n          { label: 'Renovar', action: 'renew' },\r\n          { label: 'Ver Detalles', action: 'details' }\r\n        ]\r\n      },\r\n      {\r\n        id: `notif-${Date.now()}-4`,\r\n        type: 'message',\r\n        title: 'Nuevo Mensaje',\r\n        message: 'Tienes un nuevo mensaje de soporte',\r\n        timestamp: new Date(Date.now() - 900000).toISOString(),\r\n        read: true,\r\n        priority: 'normal',\r\n        source: 'chat',\r\n        actions: [\r\n          { label: 'Responder', action: 'reply' },\r\n          { label: 'Archivar', action: 'archive' }\r\n        ]\r\n      },\r\n      {\r\n        id: `notif-${Date.now()}-5`,\r\n        type: 'document',\r\n        title: 'Documento Compartido',\r\n        message: 'Carlos Rodr√≠guez comparti√≥ \"Reporte Mensual.pdf\"',\r\n        timestamp: new Date(Date.now() - 1200000).toISOString(),\r\n        read: true,\r\n        priority: 'low',\r\n        source: 'documents',\r\n        actions: [\r\n          { label: 'Descargar', action: 'download' },\r\n          { label: 'Ver', action: 'view' }\r\n        ]\r\n      }\r\n    ]\r\n    \r\n    setNotifications(prev => [...samples, ...prev].slice(0, maxNotifications))\r\n  }, [maxNotifications])\r\n\r\n  // Agregar nueva notificaci√≥n\r\n  const addNotification = useCallback((notification) => {\r\n    const newNotification = {\r\n      id: `notif-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      timestamp: new Date().toISOString(),\r\n      read: false,\r\n      priority: 'normal',\r\n      ...notification\r\n    }\r\n    \r\n    setNotifications(prev => [newNotification, ...prev].slice(0, maxNotifications))\r\n    \r\n    // Reproducir sonido\r\n    if (settings.enableSounds && soundRef.current) {\r\n      soundRef.current.play().catch(() => {})\r\n    }\r\n    \r\n    // Notificaci√≥n de escritorio\r\n    if (settings.enableDesktop && 'Notification' in window && Notification.permission === 'granted') {\r\n      new Notification(notification.title, {\r\n        body: notification.message,\r\n        icon: '/favicon.ico',\r\n        tag: newNotification.id\r\n      })\r\n    }\r\n  }, [maxNotifications, settings.enableSounds, settings.enableDesktop])\r\n\r\n  // Marcar como le√≠do\r\n  const markAsRead = useCallback((notificationIds) => {\r\n    const ids = Array.isArray(notificationIds) ? notificationIds : [notificationIds]\r\n    setNotifications(prev => prev.map(notif => \r\n      ids.includes(notif.id) ? { ...notif, read: true } : notif\r\n    ))\r\n  }, [])\r\n\r\n  // Marcar todo como le√≠do\r\n  const markAllAsRead = useCallback(() => {\r\n    setNotifications(prev => prev.map(notif => ({ ...notif, read: true })))\r\n  }, [])\r\n\r\n  // Eliminar notificaci√≥n\r\n  const deleteNotification = useCallback((notificationIds) => {\r\n    const ids = Array.isArray(notificationIds) ? notificationIds : [notificationIds]\r\n    setNotifications(prev => prev.filter(notif => !ids.includes(notif.id)))\r\n    setSelectedNotifications(prev => {\r\n      const newSet = new Set(prev)\r\n      ids.forEach(id => newSet.delete(id))\r\n      return newSet\r\n    })\r\n  }, [])\r\n\r\n  // Archivar notificaci√≥n\r\n  const archiveNotification = useCallback((notificationIds) => {\r\n    const ids = Array.isArray(notificationIds) ? notificationIds : [notificationIds]\r\n    setNotifications(prev => prev.map(notif => \r\n      ids.includes(notif.id) ? { ...notif, archived: true } : notif\r\n    ))\r\n    markAsRead(ids)\r\n  }, [markAsRead])\r\n\r\n  // Agrupar notificaciones similares\r\n  const groupedNotifications = useMemo(() => {\r\n    if (!settings.groupSimilar) return notifications\r\n    \r\n    const groups = {}\r\n    \r\n    notifications.forEach(notif => {\r\n      const key = `${notif.type}-${notif.source}-${notif.title}`\r\n      if (!groups[key]) {\r\n        groups[key] = {\r\n          ...notif,\r\n          count: 0,\r\n          notifications: []\r\n        }\r\n      }\r\n      groups[key].count++\r\n      groups[key].notifications.push(notif)\r\n      groups[key].timestamp = notif.timestamp // Mantener la m√°s reciente\r\n    })\r\n    \r\n    return Object.values(groups)\r\n  }, [notifications, settings.groupSimilar])\r\n\r\n  // Filtrar notificaciones\r\n  const filteredNotifications = useMemo(() => {\r\n    let filtered = groupedNotifications\r\n    \r\n    // Aplicar filtro de tipo\r\n    if (filter !== 'all') {\r\n      filtered = filtered.filter(notif => notif.type === filter)\r\n    }\r\n    \r\n    // Aplicar filtro de b√∫squeda\r\n    if (searchTerm) {\r\n      filtered = filtered.filter(notif => \r\n        notif.title.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n        notif.message.toLowerCase().includes(searchTerm.toLowerCase())\r\n      )\r\n    }\r\n    \r\n    // Aplicar filtro de no le√≠dos\r\n    if (showUnreadOnly) {\r\n      filtered = filtered.filter(notif => !notif.read)\r\n    }\r\n    \r\n    return filtered\r\n  }, [groupedNotifications, filter, searchTerm, showUnreadOnly])\r\n\r\n  // Estad√≠sticas\r\n  const stats = useMemo(() => {\r\n    const total = notifications.length\r\n    const unread = notifications.filter(n => !n.read).length\r\n    const byType = Object.keys(notificationTypes).reduce((acc, type) => {\r\n      acc[type] = notifications.filter(n => n.type === type).length\r\n      return acc\r\n    }, {})\r\n    \r\n    return { total, unread, byType }\r\n  }, [notifications, notificationTypes])\r\n\r\n  // Manejar acci√≥n de notificaci√≥n\r\n  const handleNotificationAction = useCallback((notification, action) => {\r\n    console.log(`Action ${action} for notification ${notification.id}`)\r\n    // Aqu√≠ se implementar√≠an las acciones espec√≠ficas\r\n    markAsRead(notification.id)\r\n  }, [markAsRead])\r\n\r\n  // Toggle selecci√≥n\r\n  const toggleSelection = useCallback((notificationId) => {\r\n    setSelectedNotifications(prev => {\r\n      const newSet = new Set(prev)\r\n      if (newSet.has(notificationId)) {\r\n        newSet.delete(notificationId)\r\n      } else {\r\n        newSet.add(notificationId)\r\n      }\r\n      return newSet\r\n    })\r\n  }, [])\r\n\r\n  // Seleccionar todo\r\n  const selectAll = useCallback(() => {\r\n    const allIds = filteredNotifications.map(n => n.id)\r\n    setSelectedNotifications(new Set(allIds))\r\n  }, [filteredNotifications])\r\n\r\n  // Limpiar selecci√≥n\r\n  const clearSelection = useCallback(() => {\r\n    setSelectedNotifications(new Set())\r\n  }, [])\r\n\r\n  // Renderizar notificaci√≥n individual\r\n  const renderNotification = useCallback((notification) => {\r\n    const typeConfig = notificationTypes[notification.type] || notificationTypes.info\r\n    const Icon = typeConfig.icon\r\n    const isGrouped = notification.count > 1\r\n    const isSelected = selectedNotifications.has(notification.id)\r\n    \r\n    return (\r\n      <div\r\n        key={notification.id}\r\n        className={`p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors ${\r\n          !notification.read ? 'bg-blue-50 dark:bg-blue-900/10' : ''\r\n        } ${isSelected ? 'ring-2 ring-blue-500' : ''}`}\r\n      >\r\n        <div className=\"flex items-start gap-3\">\r\n          {/* Checkbox de selecci√≥n */}\r\n          <input\r\n            type=\"checkbox\"\r\n            checked={isSelected}\r\n            onChange={() => toggleSelection(notification.id)}\r\n            className=\"mt-1 rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500\"\r\n          />\r\n          \r\n          {/* Icono */}\r\n          <div className={`p-2 rounded-lg ${typeConfig.bgColor}`}>\r\n            <Icon className={`w-5 h-5 ${typeConfig.textColor}`} />\r\n          </div>\r\n          \r\n          {/* Contenido */}\r\n          <div className=\"flex-1 min-w-0\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <h3 className={`text-sm font-medium text-gray-900 dark:text-gray-100 truncate ${\r\n                !notification.read ? 'font-semibold' : ''\r\n              }`}>\r\n                {notification.title}\r\n                {isGrouped && (\r\n                  <span className=\"ml-2 px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded-full text-xs\">\r\n                    {notification.count}\r\n                  </span>\r\n                )}\r\n              </h3>\r\n              \r\n              <div className=\"flex items-center gap-2\">\r\n                {/* Prioridad */}\r\n                {notification.priority === 'high' && (\r\n                  <span className=\"w-2 h-2 bg-red-500 rounded-full\"></span>\r\n                )}\r\n                \r\n                {/* Timestamp */}\r\n                <span className=\"text-xs text-gray-500 dark:text-gray-400\">\r\n                  {new Date(notification.timestamp).toLocaleTimeString()}\r\n                </span>\r\n                \r\n                {/* Estado de lectura */}\r\n                <button\r\n                  onClick={() => markAsRead(notification.id)}\r\n                  className=\"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300\"\r\n                  title={notification.read ? 'Marcar como no le√≠do' : 'Marcar como le√≠do'}\r\n                >\r\n                  {notification.read ? <EyeSlashIcon className=\"w-4 h-4\" /> : <EyeIcon className=\"w-4 h-4\" />}\r\n                </button>\r\n              </div>\r\n            </div>\r\n            \r\n            <p className=\"text-sm text-gray-600 dark:text-gray-400 mt-1\">\r\n              {notification.message}\r\n            </p>\r\n            \r\n            {/* Acciones */}\r\n            {notification.actions && notification.actions.length > 0 && (\r\n              <div className=\"flex items-center gap-2 mt-2\">\r\n                {notification.actions.map((action, index) => (\r\n                  <button\r\n                    key={index}\r\n                    onClick={() => handleNotificationAction(notification, action.action)}\r\n                    className=\"px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors\"\r\n                  >\r\n                    {action.label}\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            )}\r\n            \r\n            {/* Metadatos */}\r\n            <div className=\"flex items-center gap-4 mt-2 text-xs text-gray-500 dark:text-gray-400\">\r\n              <span className=\"flex items-center gap-1\">\r\n                <UserIcon className=\"w-3 h-3\" />\r\n                {notification.source}\r\n              </span>\r\n              {isGrouped && (\r\n                <span className=\"flex items-center gap-1\">\r\n                  <ChatBubbleLeftRightIcon className=\"w-3 h-3\" />\r\n                  {notification.count} notificaciones\r\n                </span>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }, [notificationTypes, selectedNotifications, toggleSelection, markAsRead, handleNotificationAction])\r\n\r\n  // Renderizar lista vac√≠a\r\n  const renderEmptyState = () => (\r\n    <div className=\"flex flex-col items-center justify-center py-12 text-gray-500 dark:text-gray-400\">\r\n      <BellIcon className=\"w-12 h-12 mb-4\" />\r\n      <h3 className=\"text-lg font-medium mb-2\">No hay notificaciones</h3>\r\n      <p className=\"text-sm text-center\">\r\n        {showUnreadOnly ? 'No tienes notificaciones no le√≠das' : 'Tu bandeja de notificaciones est√° vac√≠a'}\r\n      </p>\r\n      <button\r\n        onClick={generateSampleNotifications}\r\n        className=\"mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors\"\r\n      >\r\n        Generar Notificaciones de Ejemplo\r\n      </button>\r\n    </div>\r\n  )\r\n\r\n  return (\r\n    <div className=\"relative\" ref={notificationRef}>\r\n      {/* Audio para notificaciones */}\r\n      <audio ref={soundRef} preload=\"auto\">\r\n        <source src=\"/notification-sound.mp3\" type=\"audio/mpeg\" />\r\n      </audio>\r\n      \r\n      {/* Bot√≥n de notificaciones */}\r\n      <button\r\n        onClick={() => setIsOpen(!isOpen)}\r\n        className=\"relative p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition-colors\"\r\n      >\r\n        <BellIcon className=\"w-6 h-6\" />\r\n        \r\n        {/* Indicador de notificaciones no le√≠das */}\r\n        {stats.unread > 0 && (\r\n          <span className=\"absolute top-0 right-0 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center\">\r\n            {stats.unread > 99 ? '99+' : stats.unread}\r\n          </span>\r\n        )}\r\n      </button>\r\n      \r\n      {/* Panel de notificaciones */}\r\n      {isOpen && (\r\n        <div className=\"absolute top-full right-0 mt-2 w-96 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50 max-h-[600px] flex flex-col\">\r\n          {/* Header */}\r\n          <div className=\"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700\">\r\n            <h2 className=\"text-lg font-semibold text-gray-900 dark:text-gray-100\">\r\n              Notificaciones\r\n            </h2>\r\n            \r\n            <div className=\"flex items-center gap-2\">\r\n              {/* Configuraci√≥n */}\r\n              <button\r\n                onClick={() => setSettings(prev => ({ ...prev, enableSounds: !prev.enableSounds }))}\r\n                className={`p-1 rounded ${settings.enableSounds ? 'text-blue-600' : 'text-gray-400'}`}\r\n                title=\"Sonido\"\r\n              >\r\n                üì¢\r\n              </button>\r\n              \r\n              <button\r\n                onClick={() => setIsOpen(false)}\r\n                className=\"p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300\"\r\n              >\r\n                <XMarkIcon className=\"w-5 h-5\" />\r\n              </button>\r\n            </div>\r\n          </div>\r\n          \r\n          {/* Controles */}\r\n          <div className=\"p-4 border-b border-gray-200 dark:border-gray-700 space-y-3\">\r\n            {/* B√∫squeda */}\r\n            <div className=\"relative\">\r\n              <MagnifyingGlassIcon className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400\" />\r\n              <input\r\n                type=\"text\"\r\n                value={searchTerm}\r\n                onChange={(e) => setSearchTerm(e.target.value)}\r\n                placeholder=\"Buscar notificaciones...\"\r\n                className=\"w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100\"\r\n              />\r\n            </div>\r\n            \r\n            {/* Filtros y acciones */}\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className=\"flex items-center gap-2\">\r\n                {/* Filtro por tipo */}\r\n                <select\r\n                  value={filter}\r\n                  onChange={(e) => setFilter(e.target.value)}\r\n                  className=\"px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100\"\r\n                >\r\n                  <option value=\"all\">Todos</option>\r\n                  {Object.keys(notificationTypes).map(type => (\r\n                    <option key={type} value={type}>\r\n                      {type.charAt(0).toUpperCase() + type.slice(1)}\r\n                    </option>\r\n                  ))}\r\n                </select>\r\n                \r\n                {/* Solo no le√≠dos */}\r\n                <button\r\n                  onClick={() => setShowUnreadOnly(!showUnreadOnly)}\r\n                  className={`px-2 py-1 border rounded text-sm transition-colors ${\r\n                    showUnreadOnly \r\n                      ? 'bg-blue-500 text-white border-blue-500' \r\n                      : 'border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300'\r\n                  }`}\r\n                >\r\n                  Solo no le√≠dos\r\n                </button>\r\n              </div>\r\n              \r\n              {/* Acciones r√°pidas */}\r\n              <div className=\"flex items-center gap-1\">\r\n                {stats.unread > 0 && (\r\n                  <button\r\n                    onClick={markAllAsRead}\r\n                    className=\"p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300\"\r\n                    title=\"Marcar todo como le√≠do\"\r\n                  >\r\n                    <CheckIcon className=\"w-4 h-4\" />\r\n                  </button>\r\n                )}\r\n                \r\n                {selectedNotifications.size > 0 && (\r\n                  <>\r\n                    <button\r\n                      onClick={() => markAsRead(Array.from(selectedNotifications))}\r\n                      className=\"p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300\"\r\n                      title=\"Marcar seleccionados como le√≠dos\"\r\n                    >\r\n                      <EyeIcon className=\"w-4 h-4\" />\r\n                    </button>\r\n                    \r\n                    <button\r\n                      onClick={() => archiveNotification(Array.from(selectedNotifications))}\r\n                      className=\"p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300\"\r\n                      title=\"Archivar seleccionados\"\r\n                    >\r\n                      <ArchiveBoxIcon className=\"w-4 h-4\" />\r\n                    </button>\r\n                    \r\n                    <button\r\n                      onClick={() => deleteNotification(Array.from(selectedNotifications))}\r\n                      className=\"p-1 text-red-400 hover:text-red-600 dark:hover:text-red-300\"\r\n                      title=\"Eliminar seleccionados\"\r\n                    >\r\n                      <TrashIcon className=\"w-4 h-4\" />\r\n                    </button>\r\n                  </>\r\n                )}\r\n              </div>\r\n            </div>\r\n            \r\n            {/* Selecci√≥n masiva */}\r\n            {selectedNotifications.size > 0 && (\r\n              <div className=\"flex items-center justify-between text-sm\">\r\n                <span className=\"text-gray-600 dark:text-gray-400\">\r\n                  {selectedNotifications.size} seleccionados\r\n                </span>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <button\r\n                    onClick={selectAll}\r\n                    className=\"text-blue-600 hover:text-blue-700 dark:text-blue-400\"\r\n                  >\r\n                    Seleccionar todo\r\n                  </button>\r\n                  <button\r\n                    onClick={clearSelection}\r\n                    className=\"text-gray-600 hover:text-gray-700 dark:text-gray-400\"\r\n                  >\r\n                    Limpiar selecci√≥n\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n          \r\n          {/* Lista de notificaciones */}\r\n          <div className=\"flex-1 overflow-y-auto\">\r\n            {filteredNotifications.length === 0 ? (\r\n              renderEmptyState()\r\n            ) : (\r\n              filteredNotifications.map(renderNotification)\r\n            )}\r\n          </div>\r\n          \r\n          {/* Footer con estad√≠sticas */}\r\n          <div className=\"p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900\">\r\n            <div className=\"flex items-center justify-between text-sm text-gray-600 dark:text-gray-400\">\r\n              <span>\r\n                {stats.unread} de {stats.total} no le√≠das\r\n              </span>\r\n              <button\r\n                onClick={generateSampleNotifications}\r\n                className=\"text-blue-600 hover:text-blue-700 dark:text-blue-400\"\r\n              >\r\n                Generar ejemplo\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n      \r\n      {/* Overlay */}\r\n      {isOpen && (\r\n        <div\r\n          className=\"fixed inset-0 z-40\"\r\n          onClick={() => setIsOpen(false)}\r\n        />\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default EnhancedNotificationCenter","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\plans\\Plans.js","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadUserExtensions'. Either include it or remove the dependency array.","line":41,"column":6,"nodeType":"ArrayExpression","endLine":41,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [loadUserExtensions, user]","fix":{"range":[1596,1602],"text":"[loadUserExtensions, user]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'checkGoogleDriveConnection'. Either include it or remove the dependency array.","line":48,"column":6,"nodeType":"ArrayExpression","endLine":48,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [checkGoogleDriveConnection, userProfile]","fix":{"range":[1818,1831],"text":"[checkGoogleDriveConnection, userProfile]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\plans\\UpgradePlan.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'CheckIcon' is defined but never used.","line":6,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'PlusIcon' is defined but never used.","line":8,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":11},{"ruleId":"no-unused-vars","severity":1,"message":"'userProfile' is assigned a value but never used.","line":16,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":28},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadAvailableExtensions'. Either include it or remove the dependency array.","line":26,"column":6,"nodeType":"ArrayExpression","endLine":26,"endColumn":30,"suggestions":[{"desc":"Update the dependencies array to be: [isOpen, loadAvailableExtensions, userExtensions]","fix":{"range":[849,873],"text":"[isOpen, loadAvailableExtensions, userExtensions]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { useAuth } from '../../contexts/AuthContext.js'\r\nimport { db, supabase } from '../../lib/supabase.js'\r\nimport { toast } from 'react-hot-toast'\r\nimport {\r\n  CheckIcon,\r\n  CreditCardIcon,\r\n  PlusIcon,\r\n  XMarkIcon,\r\n  StarIcon,\r\n  ArrowUpIcon\r\n} from '@heroicons/react/24/outline'\r\nimport LoadingSpinner from '../common/LoadingSpinner.js'\r\n\r\nconst UpgradePlan = ({ isOpen, onClose, currentPlan, userExtensions, onUpgradeComplete }) => {\r\n  const { user, userProfile } = useAuth()\r\n  const [extensions, setExtensions] = useState([])\r\n  const [selectedExtensions, setSelectedExtensions] = useState([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [processing, setProcessing] = useState(false)\r\n\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      loadAvailableExtensions()\r\n    }\r\n  }, [isOpen, userExtensions])\r\n\r\n  const loadAvailableExtensions = async () => {\r\n    try {\r\n      setLoading(true)\r\n      \r\n      // Cargar todas las extensiones disponibles\r\n      const { data: allExtensions, error } = await supabase\r\n        .from('extensiones')\r\n        .select('*')\r\n        .eq('disponible', true)\r\n        .order('price', { ascending: true })\r\n\r\n      if (error) {\r\n        console.error('Error loading extensions:', error)\r\n        toast.error('Error cargando las extensiones')\r\n        return\r\n      }\r\n\r\n      // Filtrar extensiones que el usuario NO tiene\r\n      const userExtensionIds = userExtensions.map(ue => ue.extension_id)\r\n      const availableForUpgrade = allExtensions.filter(ext => \r\n        !userExtensionIds.includes(ext.id)\r\n      )\r\n\r\n      setExtensions(availableForUpgrade)\r\n    } catch (error) {\r\n      console.error('Error loading extensions:', error)\r\n      toast.error('Error cargando las extensiones')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleExtensionToggle = (extensionId) => {\r\n    setSelectedExtensions(prev => {\r\n      const isSelected = prev.includes(extensionId)\r\n      if (isSelected) {\r\n        return prev.filter(id => id !== extensionId)\r\n      } else {\r\n        return [...prev, extensionId]\r\n      }\r\n    })\r\n  }\r\n\r\n  const calculateUpgradePrice = () => {\r\n    return selectedExtensions.reduce((total, extensionId) => {\r\n      const extension = extensions.find(ext => ext.id === extensionId)\r\n      return total + (extension ? parseInt(extension.price) : 0)\r\n    }, 0)\r\n  }\r\n\r\n  const formatPrice = (price) => {\r\n    if (price === 0) {\r\n      return '$0 CLP'\r\n    }\r\n    // Formatear precio en CLP con separadores de miles\r\n    return `$${parseInt(price).toLocaleString()} CLP`\r\n  }\r\n\r\n  const handleUpgrade = async () => {\r\n    if (selectedExtensions.length === 0) {\r\n      toast.error('Selecciona al menos una extensi√≥n para hacer el upgrade')\r\n      return\r\n    }\r\n\r\n    if (!user || !currentPlan) {\r\n      toast.error('Error: No se pudo identificar el usuario o plan actual')\r\n      return\r\n    }\r\n\r\n    setProcessing(true)\r\n\r\n    try {\r\n      // Crear registro de pago para el upgrade\r\n      const upgradePrice = calculateUpgradePrice()\r\n      const paymentData = {\r\n        user_id: user.id,\r\n        plan_id: currentPlan.id,\r\n        amount_usd: upgradePrice,\r\n        payment_status: 'paid', // Para prueba, marcar como pagado\r\n        payment_provider: 'mercadopago_upgrade',\r\n        payment_ref: `upgrade_${Date.now()}`,\r\n        paid_at: new Date().toISOString(),\r\n        description: `Upgrade - Extensiones agregadas al plan ${currentPlan.name_es || currentPlan.name}`\r\n      }\r\n\r\n      const { error: paymentError } = await db.payments.create(paymentData)\r\n\r\n      if (paymentError) {\r\n        console.error('Error creating upgrade payment record:', paymentError)\r\n        toast.error('Error procesando el pago del upgrade')\r\n        return\r\n      }\r\n\r\n      // Agregar las nuevas extensiones al plan del usuario\r\n      const extensionsToInsert = selectedExtensions.map(extensionId => ({\r\n        user_id: user.id,\r\n        plan_id: currentPlan.id,\r\n        extension_id: extensionId,\r\n        created_at: new Date().toISOString()\r\n      }))\r\n\r\n      const { error: extensionsError } = await supabase\r\n        .from('plan_extensiones')\r\n        .insert(extensionsToInsert)\r\n\r\n      if (extensionsError) {\r\n        console.error('Error adding extensions to plan:', extensionsError)\r\n        toast.error('Error agregando las extensiones al plan')\r\n        return\r\n      }\r\n\r\n      // √âxito\r\n      toast.success(`¬°Upgrade completado! Se agregaron ${selectedExtensions.length} extensiones a tu plan.`)\r\n      \r\n      // Llamar callback para actualizar la UI padre\r\n      if (onUpgradeComplete) {\r\n        onUpgradeComplete()\r\n      }\r\n\r\n      // Cerrar modal\r\n      onClose()\r\n\r\n    } catch (error) {\r\n      console.error('Error processing upgrade:', error)\r\n      toast.error('Error procesando el upgrade')\r\n    } finally {\r\n      setProcessing(false)\r\n    }\r\n  }\r\n\r\n  if (!isOpen) return null\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\r\n      <div className=\"bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between p-6 border-b\">\r\n          <div className=\"flex items-center\">\r\n            <ArrowUpIcon className=\"h-6 w-6 text-blue-600 mr-3\" />\r\n            <div>\r\n              <h2 className=\"text-xl font-bold text-gray-900\">Upgrade de Plan</h2>\r\n              <p className=\"text-sm text-gray-600\">\r\n                Agrega extensiones a tu plan: {currentPlan?.name_es || currentPlan?.name}\r\n              </p>\r\n            </div>\r\n          </div>\r\n          <button\r\n            onClick={onClose}\r\n            className=\"text-gray-400 hover:text-gray-600 transition-colors\"\r\n          >\r\n            <XMarkIcon className=\"h-6 w-6\" />\r\n          </button>\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <div className=\"p-6\">\r\n          {loading ? (\r\n            <div className=\"flex justify-center py-8\">\r\n              <LoadingSpinner />\r\n            </div>\r\n          ) : extensions.length === 0 ? (\r\n            <div className=\"text-center py-8\">\r\n              <StarIcon className=\"h-12 w-12 text-green-500 mx-auto mb-4\" />\r\n              <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">\r\n                ¬°Ya tienes todas las extensiones!\r\n              </h3>\r\n              <p className=\"text-gray-600\">\r\n                Tu plan actual incluye todas las extensiones disponibles.\r\n              </p>\r\n            </div>\r\n          ) : (\r\n            <>\r\n              {/* Extensiones disponibles */}\r\n              <div className=\"mb-6\">\r\n                <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">\r\n                  Extensiones Disponibles para Agregar\r\n                </h3>\r\n                <div className=\"space-y-3\">\r\n                  {extensions.map((extension) => {\r\n                    const isSelected = selectedExtensions.includes(extension.id)\r\n                    \r\n                    return (\r\n                      <div\r\n                        key={extension.id}\r\n                        className={`border rounded-lg p-4 cursor-pointer transition-all ${\r\n                          isSelected\r\n                            ? 'border-blue-500 bg-blue-50'\r\n                            : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'\r\n                        }`}\r\n                        onClick={() => handleExtensionToggle(extension.id)}\r\n                      >\r\n                        <div className=\"flex items-center justify-between\">\r\n                          <div className=\"flex items-center flex-1\">\r\n                            <input\r\n                              type=\"checkbox\"\r\n                              checked={isSelected}\r\n                              onChange={() => handleExtensionToggle(extension.id)}\r\n                              className=\"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded\"\r\n                            />\r\n                            <div className=\"ml-3 flex-1\">\r\n                              <div className=\"flex items-center justify-between\">\r\n                                <h4 className=\"text-sm font-medium text-gray-900\">\r\n                                  {extension.name_es || extension.name}\r\n                                </h4>\r\n                                <span className=\"text-sm font-bold text-blue-600\">\r\n                                  {formatPrice(parseInt(extension.price))}\r\n                                </span>\r\n                              </div>\r\n                              {extension.description_es && (\r\n                                <p className=\"text-xs text-gray-600 mt-1\">\r\n                                  {extension.description_es}\r\n                                </p>\r\n                              )}\r\n                              <div className=\"flex items-center mt-2 text-xs text-gray-500\">\r\n                                <span>Tipo: {extension.type}</span>\r\n                                {extension.storage && (\r\n                                  <span className=\"ml-4\">\r\n                                    Almacenamiento: {extension.storage}\r\n                                  </span>\r\n                                )}\r\n                                {extension.tokens && (\r\n                                  <span className=\"ml-4\">\r\n                                    Tokens: {extension.tokens}\r\n                                  </span>\r\n                                )}\r\n                              </div>\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    )\r\n                  })}\r\n                </div>\r\n              </div>\r\n\r\n              {/* Resumen del upgrade */}\r\n              {selectedExtensions.length > 0 && (\r\n                <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6\">\r\n                  <h4 className=\"text-sm font-semibold text-blue-900 mb-2\">\r\n                    Resumen del Upgrade\r\n                  </h4>\r\n                  <div className=\"space-y-1 text-sm text-blue-800\">\r\n                    <div className=\"flex justify-between\">\r\n                      <span>Extensiones seleccionadas:</span>\r\n                      <span>{selectedExtensions.length}</span>\r\n                    </div>\r\n                    <div className=\"flex justify-between font-semibold\">\r\n                      <span>Precio total del upgrade:</span>\r\n                      <span>{formatPrice(calculateUpgradePrice())}</span>\r\n                    </div>\r\n                  </div>\r\n                  <p className=\"text-xs text-blue-700 mt-2\">\r\n                    * Este costo se agregar√° a tu pr√≥xima renovaci√≥n de plan\r\n                  </p>\r\n                </div>\r\n              )}\r\n\r\n              {/* Botones de acci√≥n */}\r\n              <div className=\"flex space-x-3\">\r\n                <button\r\n                  onClick={onClose}\r\n                  className=\"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors\"\r\n                >\r\n                  Cancelar\r\n                </button>\r\n                <button\r\n                  onClick={handleUpgrade}\r\n                  disabled={selectedExtensions.length === 0 || processing}\r\n                  className={`flex-1 px-4 py-2 rounded-lg font-semibold transition-all ${\r\n                    selectedExtensions.length === 0 || processing\r\n                      ? 'bg-gray-300 text-gray-500 cursor-not-allowed'\r\n                      : 'bg-blue-600 text-white hover:bg-blue-700'\r\n                  }`}\r\n                >\r\n                  {processing ? (\r\n                    <div className=\"flex items-center justify-center\">\r\n                      <div className=\"animate-spin -ml-1 mr-2 h-4 w-4 text-white\">\r\n                        <svg className=\"w-full h-full\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n                          <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\r\n                          <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\r\n                        </svg>\r\n                      </div>\r\n                      Procesando...\r\n                    </div>\r\n                  ) : (\r\n                    <div className=\"flex items-center justify-center\">\r\n                      <CreditCardIcon className=\"h-4 w-4 mr-2\" />\r\n                      Confirmar Upgrade ({formatPrice(calculateUpgradePrice())})\r\n                    </div>\r\n                  )}\r\n                </button>\r\n              </div>\r\n            </>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default UpgradePlan","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\profile\\Profile.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadPaymentHistory'. Either include it or remove the dependency array.","line":59,"column":6,"nodeType":"ArrayExpression","endLine":59,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [loadPaymentHistory, userProfile]","fix":{"range":[1765,1778],"text":"[loadPaymentHistory, userProfile]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { useAuth } from '../../contexts/AuthContext.js'\r\nimport { db, supabase } from '../../lib/supabase.js'\r\nimport {\r\n  UserIcon,\r\n  KeyIcon,\r\n  EyeIcon,\r\n  EyeSlashIcon,\r\n  CreditCardIcon,\r\n  CalendarIcon\r\n} from '@heroicons/react/24/outline'\r\nimport toast from 'react-hot-toast'\r\n\r\nconst Profile = () => {\r\n  const { user, userProfile, updateUserProfile, signOut } = useAuth()\r\n  const [saving, setSaving] = useState(false)\r\n  const [showPasswordForm, setShowPasswordForm] = useState(false)\r\n  const [showCurrentPassword, setShowCurrentPassword] = useState(false)\r\n  const [showNewPassword, setShowNewPassword] = useState(false)\r\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false)\r\n  const [payments, setPayments] = useState([])\r\n  \r\n  const [formData, setFormData] = useState({\r\n    name: '',\r\n    telegram_id: ''\r\n  })\r\n  \r\n  const [passwordData, setPasswordData] = useState({\r\n    currentPassword: '',\r\n    newPassword: '',\r\n    confirmPassword: ''\r\n  })\r\n\r\n\r\n  const loadPaymentHistory = async () => {\r\n    try {\r\n      const { data, error } = await db.payments.getByUserId(user.id)\r\n      if (error) {\r\n        console.error('Error loading payment history:', error)\r\n        // En caso de error, establecer array vac√≠o para evitar bloqueos\r\n        setPayments([])\r\n        return\r\n      }\r\n      setPayments(data || [])\r\n    } catch (error) {\r\n      console.error('Network error loading payment history:', error)\r\n      setPayments([])\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (userProfile) {\r\n      setFormData({\r\n        name: userProfile.full_name || userProfile.name || '',\r\n        telegram_id: userProfile.telegram_id || ''\r\n      })\r\n    }\r\n    loadPaymentHistory()\r\n  }, [userProfile])\r\n\r\n\r\n  const handleProfileUpdate = async (e) => {\r\n    e.preventDefault()\r\n    setSaving(true)\r\n    \r\n    try {\r\n      await updateUserProfile(formData)\r\n      toast.success('Perfil actualizado exitosamente')\r\n      \r\n      // Forzar recarga de la p√°gina para que el dashboard refleje los cambios\r\n      setTimeout(() => {\r\n        window.location.reload()\r\n      }, 1000)\r\n    } catch (error) {\r\n      console.error('Error updating profile:', error)\r\n      toast.error('Error actualizando el perfil')\r\n    } finally {\r\n      setSaving(false)\r\n    }\r\n  }\r\n\r\n  const handlePasswordChange = async (e) => {\r\n    e.preventDefault()\r\n    \r\n    if (passwordData.newPassword !== passwordData.confirmPassword) {\r\n      toast.error('Las contrase√±as no coinciden')\r\n      return\r\n    }\r\n    \r\n    if (passwordData.newPassword.length < 6) {\r\n      toast.error('La nueva contrase√±a debe tener al menos 6 caracteres')\r\n      return\r\n    }\r\n    \r\n    setSaving(true)\r\n    \r\n    try {\r\n      // Primero verificar la contrase√±a actual\r\n      const { error: signInError } = await supabase.auth.signInWithPassword({\r\n        email: user.email,\r\n        password: passwordData.currentPassword\r\n      })\r\n      \r\n      if (signInError) {\r\n        toast.error('La contrase√±a actual es incorrecta')\r\n        setSaving(false)\r\n        return\r\n      }\r\n      \r\n      // Cambiar contrase√±a con Supabase\r\n      const { error } = await supabase.auth.updateUser({\r\n        password: passwordData.newPassword\r\n      })\r\n      \r\n      if (error) {\r\n        console.error('Error:', error)\r\n        \r\n        // Manejar errores espec√≠ficos de Supabase\r\n        if (error.message && error.message.includes('New password should be different from the old password')) {\r\n          toast.error('La nueva contrase√±a debe ser diferente a la anterior')\r\n        } else if (error.message && error.message.includes('Password should be at least')) {\r\n          toast.error('La contrase√±a debe cumplir con los requisitos m√≠nimos')\r\n        } else {\r\n          toast.error('Error al actualizar la contrase√±a: ' + error.message)\r\n        }\r\n        return\r\n      }\r\n      \r\n      toast.success('Contrase√±a actualizada exitosamente')\r\n      setPasswordData({\r\n        currentPassword: '',\r\n        newPassword: '',\r\n        confirmPassword: ''\r\n      })\r\n      setShowPasswordForm(false)\r\n    } catch (error) {\r\n      console.error('Error changing password:', error)\r\n      toast.error('Error cambiando la contrase√±a: ' + error.message)\r\n    } finally {\r\n      setSaving(false)\r\n    }\r\n  }\r\n\r\n\r\n\r\n  const formatDate = (dateString) => {\r\n    if (!dateString) return 'N/A'\r\n    return new Date(dateString).toLocaleDateString('es-ES', {\r\n      year: 'numeric',\r\n      month: 'long',\r\n      day: 'numeric'\r\n    })\r\n  }\r\n\r\n  const formatCurrency = (amount) => {\r\n    return new Intl.NumberFormat('es-ES', {\r\n      style: 'currency',\r\n      currency: 'USD'\r\n    }).format(amount)\r\n  }\r\n\r\n  const getPaymentStatusBadge = (status) => {\r\n    const statusConfig = {\r\n      'paid': { color: 'bg-green-100 text-green-800', text: 'Completado' },\r\n      'pending': { color: 'bg-yellow-100 text-yellow-800', text: 'Pendiente' },\r\n      'failed': { color: 'bg-red-100 text-red-800', text: 'Fallido' },\r\n      'cancelled': { color: 'bg-gray-100 text-gray-800', text: 'Cancelado' }\r\n    }\r\n    \r\n    const config = statusConfig[status] || statusConfig['pending']\r\n    \r\n    return (\r\n      <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${config.color}`}>\r\n        {config.text}\r\n      </span>\r\n    )\r\n  }\r\n\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div>\r\n        <h1 className=\"text-2xl font-bold text-gray-900\">Mi Perfil</h1>\r\n        <p className=\"text-gray-600 mt-1\">\r\n          Gestiona tu informaci√≥n personal y configuraci√≥n de cuenta\r\n        </p>\r\n      </div>\r\n\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n        {/* Informaci√≥n Personal */}\r\n        <div className=\"lg:col-span-2 space-y-6\">\r\n          {/* Datos del Usuario */}\r\n          <div className=\"bg-white shadow-sm rounded-lg p-6\">\r\n            <h2 className=\"text-lg font-semibold text-gray-900 mb-4 flex items-center\">\r\n              <UserIcon className=\"h-5 w-5 mr-2\" />\r\n              Informaci√≥n Personal\r\n            </h2>\r\n            \r\n            <form onSubmit={handleProfileUpdate} className=\"space-y-4\">\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                  Nombre Completo\r\n                </label>\r\n                <input\r\n                  type=\"text\"\r\n                  value={formData.name}\r\n                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\r\n                  placeholder=\"Tu nombre completo\"\r\n                />\r\n              </div>\r\n              \r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                  Email\r\n                </label>\r\n                <input\r\n                  type=\"email\"\r\n                  value={user?.email || ''}\r\n                  disabled\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 cursor-not-allowed\"\r\n                />\r\n                <p className=\"text-xs text-gray-500 mt-1\">\r\n                  El email no se puede modificar\r\n                </p>\r\n              </div>\r\n              \r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                  ID de Telegram (Opcional)\r\n                </label>\r\n                <input\r\n                  type=\"text\"\r\n                  value={formData.telegram_id}\r\n                  onChange={(e) => setFormData({ ...formData, telegram_id: e.target.value })}\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\r\n                  placeholder=\"@tu_usuario_telegram\"\r\n                />\r\n              </div>\r\n              \r\n              <button\r\n                type=\"submit\"\r\n                disabled={saving}\r\n                className=\"w-full bg-primary-600 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n              >\r\n                {saving ? 'Guardando...' : 'Guardar Cambios'}\r\n              </button>\r\n            </form>\r\n          </div>\r\n\r\n          {/* Cambiar Contrase√±a */}\r\n          <div className=\"bg-white shadow-sm rounded-lg p-6\">\r\n            <h2 className=\"text-lg font-semibold text-gray-900 mb-4 flex items-center\">\r\n              <KeyIcon className=\"h-5 w-5 mr-2\" />\r\n              Seguridad\r\n            </h2>\r\n            \r\n            {!showPasswordForm ? (\r\n              <div>\r\n                <p className=\"text-gray-600 mb-4\">\r\n                  Cambia tu contrase√±a para mantener tu cuenta segura\r\n                </p>\r\n                <button\r\n                  onClick={() => setShowPasswordForm(true)}\r\n                  className=\"bg-gray-100 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-200 transition-colors\"\r\n                >\r\n                  Cambiar Contrase√±a\r\n                </button>\r\n              </div>\r\n            ) : (\r\n              <form onSubmit={handlePasswordChange} className=\"space-y-4\">\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                    Contrase√±a Actual\r\n                  </label>\r\n                  <div className=\"relative\">\r\n                    <input\r\n                      type={showCurrentPassword ? 'text' : 'password'}\r\n                      value={passwordData.currentPassword}\r\n                      onChange={(e) => setPasswordData({ ...passwordData, currentPassword: e.target.value })}\r\n                      className=\"w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\r\n                      required\r\n                    />\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => setShowCurrentPassword(!showCurrentPassword)}\r\n                      className=\"absolute inset-y-0 right-0 pr-3 flex items-center\"\r\n                    >\r\n                      {showCurrentPassword ? (\r\n                        <EyeSlashIcon className=\"h-5 w-5 text-gray-400\" />\r\n                      ) : (\r\n                        <EyeIcon className=\"h-5 w-5 text-gray-400\" />\r\n                      )}\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n                \r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                    Nueva Contrase√±a\r\n                  </label>\r\n                  <div className=\"relative\">\r\n                    <input\r\n                      type={showNewPassword ? 'text' : 'password'}\r\n                      value={passwordData.newPassword}\r\n                      onChange={(e) => setPasswordData({ ...passwordData, newPassword: e.target.value })}\r\n                      className=\"w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\r\n                      required\r\n                      minLength={6}\r\n                    />\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => setShowNewPassword(!showNewPassword)}\r\n                      className=\"absolute inset-y-0 right-0 pr-3 flex items-center\"\r\n                    >\r\n                      {showNewPassword ? (\r\n                        <EyeSlashIcon className=\"h-5 w-5 text-gray-400\" />\r\n                      ) : (\r\n                        <EyeIcon className=\"h-5 w-5 text-gray-400\" />\r\n                      )}\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n                \r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                    Confirmar Nueva Contrase√±a\r\n                  </label>\r\n                  <div className=\"relative\">\r\n                    <input\r\n                      type={showConfirmPassword ? 'text' : 'password'}\r\n                      value={passwordData.confirmPassword}\r\n                      onChange={(e) => setPasswordData({ ...passwordData, confirmPassword: e.target.value })}\r\n                      className=\"w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\r\n                      required\r\n                      minLength={6}\r\n                    />\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => setShowConfirmPassword(!showConfirmPassword)}\r\n                      className=\"absolute inset-y-0 right-0 pr-3 flex items-center\"\r\n                    >\r\n                      {showConfirmPassword ? (\r\n                        <EyeSlashIcon className=\"h-5 w-5 text-gray-400\" />\r\n                      ) : (\r\n                        <EyeIcon className=\"h-5 w-5 text-gray-400\" />\r\n                      )}\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n                \r\n                <div className=\"flex space-x-3\">\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => {\r\n                      setShowPasswordForm(false)\r\n                      setPasswordData({\r\n                        currentPassword: '',\r\n                        newPassword: '',\r\n                        confirmPassword: ''\r\n                      })\r\n                    }}\r\n                    className=\"flex-1 bg-gray-100 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-200 transition-colors\"\r\n                  >\r\n                    Cancelar\r\n                  </button>\r\n                  <button\r\n                    type=\"submit\"\r\n                    disabled={saving}\r\n                    className=\"flex-1 bg-primary-600 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                  >\r\n                    {saving ? 'Cambiando...' : 'Cambiar Contrase√±a'}\r\n                  </button>\r\n                </div>\r\n              </form>\r\n            )}\r\n          </div>\r\n\r\n          {/* Historial de Pagos */}\r\n          <div className=\"bg-white shadow-sm rounded-lg p-6\">\r\n            <h2 className=\"text-lg font-semibold text-gray-900 mb-4 flex items-center\">\r\n              <CreditCardIcon className=\"h-5 w-5 mr-2\" />\r\n              Historial de Pagos\r\n            </h2>\r\n            \r\n            {payments.length === 0 ? (\r\n              <p className=\"text-gray-600 text-center py-4\">\r\n                No tienes pagos registrados\r\n              </p>\r\n            ) : (\r\n              <div className=\"overflow-x-auto\">\r\n                <table className=\"min-w-full divide-y divide-gray-200\">\r\n                  <thead className=\"bg-gray-50\">\r\n                    <tr>\r\n                      <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                        Fecha\r\n                      </th>\r\n                      <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                        Monto\r\n                      </th>\r\n                      <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                        Estado\r\n                      </th>\r\n                      <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                        Referencia\r\n                      </th>\r\n                    </tr>\r\n                  </thead>\r\n                  <tbody className=\"bg-white divide-y divide-gray-200\">\r\n                    {payments.map((payment) => (\r\n                      <tr key={payment.id}>\r\n                        <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-900\">\r\n                          {formatDate(payment.created_at)}\r\n                        </td>\r\n                        <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-900\">\r\n                          {formatCurrency(payment.amount_usd)}\r\n                        </td>\r\n                        <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                          {getPaymentStatusBadge(payment.payment_status)}\r\n                        </td>\r\n                        <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\r\n                          {payment.payment_ref}\r\n                        </td>\r\n                      </tr>\r\n                    ))}\r\n                  </tbody>\r\n                </table>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Sidebar */}\r\n        <div className=\"space-y-6\">\r\n\r\n          {/* Informaci√≥n de la Cuenta */}\r\n          <div className=\"bg-white shadow-sm rounded-lg p-6\">\r\n            <h3 className=\"text-lg font-semibold text-gray-900 mb-4 flex items-center\">\r\n              <CalendarIcon className=\"h-5 w-5 mr-2\" />\r\n              Informaci√≥n de Cuenta\r\n            </h3>\r\n            \r\n            <div className=\"space-y-4\">\r\n              <div>\r\n                <span className=\"text-sm text-gray-600\">Miembro desde</span>\r\n                <p className=\"text-sm font-medium text-gray-900\">\r\n                  {formatDate(userProfile?.created_at)}\r\n                </p>\r\n              </div>\r\n              \r\n              <div>\r\n                <span className=\"text-sm text-gray-600\">Plan actual</span>\r\n                <p className=\"text-sm font-medium text-gray-900\">\r\n                  {userProfile?.current_plan_id || 'Sin plan'}\r\n                </p>\r\n              </div>\r\n              \r\n              <div>\r\n                <span className=\"text-sm text-gray-600\">Estado</span>\r\n                <p className=\"text-sm font-medium text-gray-900\">\r\n                  {userProfile?.is_active ? 'Activo' : 'Inactivo'}\r\n                </p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Cerrar Sesi√≥n */}\r\n          <div className=\"bg-white shadow-sm rounded-lg p-6\">\r\n            <button\r\n              onClick={signOut}\r\n              className=\"w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors\"\r\n            >\r\n              Cerrar Sesi√≥n\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default Profile","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\routines\\RoutineUpload.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'CheckCircleIcon' is defined but never used.","line":9,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'user' is assigned a value but never used.","line":16,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":15},{"ruleId":"no-use-before-define","severity":1,"message":"'loadFolders' was used before it was defined.","line":28,"column":7,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":28,"endColumn":18},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'loadFolders' function makes the dependencies of useEffect Hook (at line 28) change on every render. Move it inside the useEffect callback. Alternatively, wrap the definition of 'loadFolders' in its own useCallback() Hook.","line":30,"column":9,"nodeType":"VariableDeclarator","endLine":46,"endColumn":4}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { useAuth } from '../../contexts/AuthContext.js'\r\nimport { supabase } from '../../lib/supabase.js'\r\nimport googleDriveService from '../../lib/googleDrive.js'\r\nimport * as XLSX from 'xlsx'\r\nimport {\r\n  CloudArrowUpIcon,\r\n  DocumentTextIcon,\r\n  CheckCircleIcon,\r\n  ExclamationTriangleIcon\r\n} from '@heroicons/react/24/outline'\r\nimport LoadingSpinner from '../common/LoadingSpinner.js'\r\nimport toast from 'react-hot-toast'\r\n\r\nconst RoutineUpload = ({ onUploadComplete, onClose }) => {\r\n  const { user, userProfile } = useAuth()\r\n  const [selectedFile, setSelectedFile] = useState(null)\r\n  const [uploading, setUploading] = useState(false)\r\n  const [uploadProgress, setUploadProgress] = useState(0)\r\n  const [folders, setFolders] = useState([])\r\n  const [loadingFolders, setLoadingFolders] = useState(true)\r\n  const [selectedFolder, setSelectedFolder] = useState('')\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\r\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\r\nuseEffect(() => {\r\n    loadFolders()\r\n  }, [loadFolders])\r\n\r\n  const loadFolders = async () => {\r\n    try {\r\n      setLoadingFolders(true)\r\n      const { data, error } = await supabase\r\n        .from('carpetas_usuario')\r\n        .select('*')\r\n        .order('created_at', { ascending: false })\r\n      \r\n      if (error) throw error\r\n      setFolders(data || [])\r\n    } catch (error) {\r\n      console.error('Error loading folders:', error)\r\n      toast.error('Error cargando carpetas')\r\n    } finally {\r\n      setLoadingFolders(false)\r\n    }\r\n  }\r\n\r\n  // Funci√≥n para procesar el Excel y convertirlo al formato requerido\r\n  const processExcelFile = async (file) => {\r\n    return new Promise((resolve, reject) => {\r\n      const reader = new FileReader()\r\n      \r\n      reader.onload = (e) => {\r\n        try {\r\n          const data = new Uint8Array(e.target.result)\r\n          const workbook = XLSX.read(data, { type: 'array' })\r\n          \r\n          // Verificar que existan las hojas requeridas\r\n          const requiredSheets = ['Rutina de Ejercicios', 'Alimentaci√≥n']\r\n          const availableSheets = workbook.SheetNames\r\n          \r\n          const missingSheets = requiredSheets.filter(sheet => !availableSheets.includes(sheet))\r\n          if (missingSheets.length > 0) {\r\n            reject(new Error(`Faltan las siguientes hojas en el Excel: ${missingSheets.join(', ')}`))\r\n            return\r\n          }\r\n\r\n          // Leer datos de ambas hojas\r\n          const rutinaSheet = workbook.Sheets['Rutina de Ejercicios']\r\n          const alimentacionSheet = workbook.Sheets['Alimentaci√≥n']\r\n          \r\n          const rutinaData = XLSX.utils.sheet_to_json(rutinaSheet)\r\n          const alimentacionData = XLSX.utils.sheet_to_json(alimentacionSheet)\r\n          \r\n          // Procesar datos usando la l√≥gica de codejemplos.js\r\n          const planSemanal = processRoutineData(rutinaData, alimentacionData)\r\n          \r\n          resolve(planSemanal)\r\n        } catch (error) {\r\n          reject(new Error(`Error procesando el archivo Excel: ${error.message}`))\r\n        }\r\n      }\r\n      \r\n      reader.onerror = () => reject(new Error('Error leyendo el archivo'))\r\n      reader.readAsArrayBuffer(file)\r\n    })\r\n  }\r\n\r\n  // Funci√≥n para procesar los datos de rutina y alimentaci√≥n\r\n  const processRoutineData = (rutinaData, alimentacionData) => {\r\n    const planSemanal = {\r\n      lunes: { ejercicios: [], alimentacion: [] },\r\n      martes: { ejercicios: [], alimentacion: [] },\r\n      miercoles: { ejercicios: [], alimentacion: [] },\r\n      jueves: { ejercicios: [], alimentacion: [] },\r\n      viernes: { ejercicios: [], alimentacion: [] },\r\n      sabado: { ejercicios: [], alimentacion: [] },\r\n      domingo: { ejercicios: [], alimentacion: [] }\r\n    }\r\n\r\n    // Procesar datos de rutina\r\n    rutinaData.forEach(row => {\r\n      const dia = row['D√≠a']?.toLowerCase()\r\n      if (dia && planSemanal[dia]) {\r\n        planSemanal[dia].ejercicios.push({\r\n          ejercicio: row['Ejercicio'] || '',\r\n          series: row['Series'] || '',\r\n          repeticiones: row['Repeticiones'] || '',\r\n          peso: row['Peso'] || '',\r\n          descanso: row['Descanso'] || '',\r\n          notas: row['Notas'] || ''\r\n        })\r\n      }\r\n    })\r\n\r\n    // Procesar datos de alimentaci√≥n\r\n    alimentacionData.forEach(row => {\r\n      const dia = row['D√≠a']?.toLowerCase()\r\n      if (dia && planSemanal[dia]) {\r\n        planSemanal[dia].alimentacion.push({\r\n          comida: row['Comida'] || '',\r\n          alimento: row['Alimento'] || '',\r\n          cantidad: row['Cantidad'] || '',\r\n          calorias: row['Calor√≠as'] || '',\r\n          proteinas: row['Prote√≠nas'] || '',\r\n          carbohidratos: row['Carbohidratos'] || '',\r\n          grasas: row['Grasas'] || ''\r\n        })\r\n      }\r\n    })\r\n\r\n    return planSemanal\r\n  }\r\n\r\n  const handleFileSelect = (event) => {\r\n    const file = event.target.files[0]\r\n    if (file) {\r\n      // Validar que sea un archivo Excel\r\n      const validTypes = [\r\n        'application/vnd.ms-excel',\r\n        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'\r\n      ]\r\n      \r\n      if (!validTypes.includes(file.type)) {\r\n        toast.error('Por favor selecciona un archivo Excel (.xls o .xlsx)')\r\n        return\r\n      }\r\n      \r\n      setSelectedFile(file)\r\n    }\r\n  }\r\n\r\n  // Manejar subida de rutina\r\n  const handleUpload = async () => {\r\n    if (!selectedFile) {\r\n      toast.error('Por favor selecciona un archivo')\r\n      return\r\n    }\r\n\r\n    if (!selectedFolder) {\r\n      toast.error('Por favor selecciona una carpeta')\r\n      return\r\n    }\r\n\r\n    try {\r\n      setUploading(true)\r\n      setUploadProgress(10)\r\n\r\n      // Procesar el archivo Excel\r\n      const planSemanal = await processExcelFile(selectedFile)\r\n      setUploadProgress(30)\r\n\r\n      // Obtener informaci√≥n de la carpeta seleccionada\r\n      const { data: folderData, error: folderError } = await supabase\r\n        .from('carpetas_usuario')\r\n        .select('*')\r\n        .eq('id', selectedFolder)\r\n        .single()\r\n\r\n      if (folderError) throw folderError\r\n      \r\n      const folderName = folderData.folder_name || folderData.correo\r\n      setUploadProgress(50)\r\n\r\n      // Subir archivo a Google Drive\r\n      await googleDriveService.setTokens({\r\n        refresh_token: userProfile.google_refresh_token\r\n      })\r\n\r\n      const googleFileId = await googleDriveService.uploadFile(\r\n        selectedFile,\r\n        folderData.google_folder_id\r\n      )\r\n      setUploadProgress(70)\r\n\r\n      // Verificar si ya existe una rutina para este usuario\r\n      const { data: existingRoutine } = await supabase\r\n        .from('rutinas')\r\n        .select('*')\r\n        .eq('user_email', folderName)\r\n        .single()\r\n\r\n      let result\r\n      if (existingRoutine) {\r\n        // Actualizar rutina existente\r\n        result = await supabase\r\n          .from('rutinas')\r\n          .update({\r\n            plan_semanal: planSemanal,\r\n            updated_at: new Date().toISOString()\r\n          })\r\n          .eq('user_email', folderName)\r\n      } else {\r\n        // Crear nueva rutina\r\n        result = await supabase\r\n          .from('rutinas')\r\n          .insert({\r\n            user_email: folderName,\r\n            plan_semanal: planSemanal\r\n          })\r\n      }\r\n      \r\n      if (result.error) throw result.error\r\n      \r\n      setUploadProgress(90)\r\n      \r\n      // Registrar en documentos_usuario_entrenador\r\n      const { error: docError } = await supabase\r\n        .from('documentos_usuario_entrenador')\r\n        .insert({\r\n          usuario: folderName,\r\n          file_name: selectedFile.name,\r\n          file_type: 'routine',\r\n          file_id: googleFileId\r\n        })\r\n      \r\n      if (docError) {\r\n        console.warn('Error registrando en documentos_usuario_entrenador:', docError)\r\n      }\r\n      \r\n      setUploadProgress(100)\r\n      \r\n      toast.success(existingRoutine ? 'Rutina actualizada exitosamente' : 'Rutina subida exitosamente')\r\n      \r\n      // Limpiar estado\r\n      setSelectedFile(null)\r\n      setUploadProgress(0)\r\n      \r\n      // Llamar callback\r\n      if (onUploadComplete) {\r\n        onUploadComplete()\r\n      }\r\n      \r\n    } catch (error) {\r\n      console.error('Error uploading routine:', error)\r\n      toast.error(`Error subiendo rutina: ${error.message}`)\r\n    } finally {\r\n      setUploading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50\">\r\n      <div className=\"bg-white rounded-lg max-w-md w-full p-6\">\r\n        <div className=\"flex justify-between items-center mb-6\">\r\n          <h3 className=\"text-lg font-semibold text-gray-900\">\r\n            Subir Rutina de Entrenamiento\r\n          </h3>\r\n          <button\r\n            onClick={onClose}\r\n            className=\"text-gray-400 hover:text-gray-600\"\r\n          >\r\n            ‚úï\r\n          </button>\r\n        </div>\r\n        \r\n        <div className=\"space-y-4\">\r\n          {/* Selector de carpeta */}\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n              Carpeta de destino\r\n            </label>\r\n            {loadingFolders ? (\r\n              <LoadingSpinner size=\"sm\" />\r\n            ) : (\r\n              <select\r\n                value={selectedFolder}\r\n                onChange={(e) => setSelectedFolder(e.target.value)}\r\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\r\n                disabled={uploading}\r\n              >\r\n                <option value=\"\">Seleccionar carpeta</option>\r\n                {folders.map((folder) => (\r\n                  <option key={folder.id} value={folder.id}>\r\n                    {folder.folder_name || folder.correo}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n            )}\r\n          </div>\r\n          \r\n          {/* Selector de archivo */}\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n              Archivo Excel de Rutina\r\n            </label>\r\n            <input\r\n              type=\"file\"\r\n              accept=\".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\"\r\n              onChange={handleFileSelect}\r\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent\"\r\n              disabled={uploading}\r\n            />\r\n            {selectedFile && (\r\n              <div className=\"mt-2 text-sm text-gray-600 flex items-center\">\r\n                <DocumentTextIcon className=\"h-4 w-4 mr-1\" />\r\n                {selectedFile.name} ({(selectedFile.size / 1024).toFixed(1)} KB)\r\n              </div>\r\n            )}\r\n          </div>\r\n          \r\n          {/* Progreso de subida */}\r\n          {uploading && (\r\n            <div className=\"space-y-2\">\r\n              <div className=\"flex justify-between text-sm\">\r\n                <span>Subiendo rutina...</span>\r\n                <span>{uploadProgress}%</span>\r\n              </div>\r\n              <div className=\"w-full bg-gray-200 rounded-full h-2\">\r\n                <div \r\n                  className=\"bg-primary-600 h-2 rounded-full transition-all duration-300\"\r\n                  style={{ width: `${uploadProgress}%` }}\r\n                ></div>\r\n              </div>\r\n            </div>\r\n          )}\r\n          \r\n          {/* Informaci√≥n */}\r\n          <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-3\">\r\n            <div className=\"flex items-start\">\r\n              <ExclamationTriangleIcon className=\"h-5 w-5 text-blue-600 mt-0.5 mr-2 flex-shrink-0\" />\r\n              <div className=\"text-sm text-blue-800\">\r\n                <p className=\"font-medium mb-1\">Formato requerido:</p>\r\n                <ul className=\"list-disc list-inside space-y-1\">\r\n                  <li>Archivo Excel (.xls o .xlsx)</li>\r\n                  <li>Hoja \"Rutina de Ejercicios\"</li>\r\n                  <li>Hoja \"Alimentaci√≥n\"</li>\r\n                </ul>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        \r\n        {/* Botones */}\r\n        <div className=\"flex justify-end space-x-3 mt-6\">\r\n          <button\r\n            onClick={onClose}\r\n            className=\"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors\"\r\n            disabled={uploading}\r\n          >\r\n            Cancelar\r\n          </button>\r\n          <button\r\n            onClick={handleUpload}\r\n            disabled={!selectedFile || !selectedFolder || uploading}\r\n            className=\"px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors flex items-center\"\r\n          >\r\n            {uploading ? (\r\n              <>\r\n                <div className=\"w-3 h-3 mr-2 animate-spin\">\r\n                  <svg className=\"w-full h-full text-white\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n                    <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"/>\r\n                    <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"/>\r\n                  </svg>\r\n                </div>\r\n                Subiendo...\r\n              </>\r\n            ) : (\r\n              <>\r\n                <CloudArrowUpIcon className=\"h-4 w-4 mr-2\" />\r\n                Subir Rutina\r\n              </>\r\n            )}\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default RoutineUpload","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\search\\AdvancedSearchSystem.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'AdjustmentsHorizontalIcon' is defined but never used.","line":18,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":28},{"ruleId":"no-unused-vars","severity":1,"message":"'ArrowPathIcon' is defined but never used.","line":25,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'PrinterIcon' is defined but never used.","line":27,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Advanced Search System\r\n * Sistema de b√∫squeda global con filtros avanzados, historial y sugerencias\r\n * \r\n * ‚úÖ NO MODIFICA c√≥digo existente\r\n * ‚úÖ Completamente independiente\r\n * ‚úÖ Puede ser desactivado sin afectar el sistema\r\n */\r\n\r\nimport React, { useState, useEffect, useRef, useCallback, useMemo } from 'react'\r\nimport { \r\n  MagnifyingGlassIcon,\r\n  FunnelIcon,\r\n  ClockIcon,\r\n  BookmarkIcon,\r\n  XMarkIcon,\r\n  ChevronDownIcon,\r\n  AdjustmentsHorizontalIcon,\r\n  DocumentTextIcon,\r\n  UserIcon,\r\n  BuildingOfficeIcon,\r\n  CalendarIcon,\r\n  TagIcon,\r\n  StarIcon,\r\n  ArrowPathIcon,\r\n  ShareIcon,\r\n  PrinterIcon\r\n} from '@heroicons/react/24/outline'\r\n\r\nconst AdvancedSearchSystem = ({ \r\n  onSearch,\r\n  placeholder = \"Buscar global...\",\r\n  enableFilters = true,\r\n  enableHistory = true,\r\n  enableSuggestions = true,\r\n  enableBookmarks = true,\r\n  maxResults = 50,\r\n  searchScope = \"all\"\r\n}) => {\r\n  const [query, setQuery] = useState('')\r\n  const [isOpen, setIsOpen] = useState(false)\r\n  const [filters, setFilters] = useState({})\r\n  const [searchHistory, setSearchHistory] = useState([])\r\n  const [bookmarks, setBookmarks] = useState([])\r\n  const [suggestions, setSuggestions] = useState([])\r\n  const [results, setResults] = useState([])\r\n  const [isSearching, setIsSearching] = useState(false)\r\n  const [selectedCategory, setSelectedCategory] = useState('all')\r\n  const [showFilters, setShowFilters] = useState(false)\r\n  const [sortBy, setSortBy] = useState('relevance')\r\n  const [searchTime, setSearchTime] = useState(0)\r\n  \r\n  const searchRef = useRef(null)\r\n  const inputRef = useRef(null)\r\n  const debounceRef = useRef(null)\r\n\r\n  // Cargar historial y bookmarks desde localStorage\r\n  useEffect(() => {\r\n    if (enableHistory) {\r\n      const savedHistory = localStorage.getItem('searchHistory')\r\n      if (savedHistory) {\r\n        setSearchHistory(JSON.parse(savedHistory))\r\n      }\r\n    }\r\n    \r\n    if (enableBookmarks) {\r\n      const savedBookmarks = localStorage.getItem('searchBookmarks')\r\n      if (savedBookmarks) {\r\n        setBookmarks(JSON.parse(savedBookmarks))\r\n      }\r\n    }\r\n  }, [enableHistory, enableBookmarks])\r\n\r\n  // Guardar historial en localStorage\r\n  useEffect(() => {\r\n    if (enableHistory && searchHistory.length > 0) {\r\n      localStorage.setItem('searchHistory', JSON.stringify(searchHistory.slice(0, 20)))\r\n    }\r\n  }, [searchHistory, enableHistory])\r\n\r\n  // Guardar bookmarks en localStorage\r\n  useEffect(() => {\r\n    if (enableBookmarks && bookmarks.length > 0) {\r\n      localStorage.setItem('searchBookmarks', JSON.stringify(bookmarks))\r\n    }\r\n  }, [bookmarks, enableBookmarks])\r\n\r\n  // Categor√≠as de b√∫squeda\r\n  const searchCategories = useMemo(() => [\r\n    { id: 'all', name: 'Todo', icon: MagnifyingGlassIcon, color: 'blue' },\r\n    { id: 'employees', name: 'Empleados', icon: UserIcon, color: 'green' },\r\n    { id: 'companies', name: 'Empresas', icon: BuildingOfficeIcon, color: 'purple' },\r\n    { id: 'documents', name: 'Documentos', icon: DocumentTextIcon, color: 'yellow' },\r\n    { id: 'communications', name: 'Comunicaciones', icon: TagIcon, color: 'pink' },\r\n    { id: 'reports', name: 'Reportes', icon: StarIcon, color: 'indigo' }\r\n  ], [])\r\n\r\n  // Opciones de filtros\r\n  const filterOptions = useMemo(() => ({\r\n    dateRange: {\r\n      label: 'Rango de fechas',\r\n      type: 'daterange',\r\n      options: [\r\n        { value: 'today', label: 'Hoy' },\r\n        { value: 'week', label: 'Esta semana' },\r\n        { value: 'month', label: 'Este mes' },\r\n        { value: 'year', label: 'Este a√±o' },\r\n        { value: 'custom', label: 'Personalizado' }\r\n      ]\r\n    },\r\n    fileType: {\r\n      label: 'Tipo de archivo',\r\n      type: 'select',\r\n      options: [\r\n        { value: 'pdf', label: 'PDF' },\r\n        { value: 'doc', label: 'Word' },\r\n        { value: 'xls', label: 'Excel' },\r\n        { value: 'ppt', label: 'PowerPoint' },\r\n        { value: 'txt', label: 'Texto' }\r\n      ]\r\n    },\r\n    status: {\r\n      label: 'Estado',\r\n      type: 'multiselect',\r\n      options: [\r\n        { value: 'active', label: 'Activo' },\r\n        { value: 'inactive', label: 'Inactivo' },\r\n        { value: 'pending', label: 'Pendiente' },\r\n        { value: 'completed', label: 'Completado' }\r\n      ]\r\n    },\r\n    priority: {\r\n      label: 'Prioridad',\r\n      type: 'select',\r\n      options: [\r\n        { value: 'high', label: 'Alta' },\r\n        { value: 'medium', label: 'Media' },\r\n        { value: 'low', label: 'Baja' }\r\n      ]\r\n    }\r\n  }), [])\r\n\r\n  // Generar sugerencias basadas en la consulta\r\n  const generateSuggestions = useCallback(async (searchQuery) => {\r\n    if (!enableSuggestions || searchQuery.length < 2) {\r\n      setSuggestions([])\r\n      return\r\n    }\r\n\r\n    // Simular sugerencias (en producci√≥n, esto vendr√≠a de una API)\r\n    const mockSuggestions = [\r\n      { text: `${searchQuery} en empleados`, type: 'employees', count: 12 },\r\n      { text: `${searchQuery} en documentos`, type: 'documents', count: 8 },\r\n      { text: `${searchQuery} en empresas`, type: 'companies', count: 5 },\r\n      { text: `${searchQuery} en comunicaciones`, type: 'communications', count: 3 }\r\n    ]\r\n\r\n    setSuggestions(mockSuggestions.slice(0, 5))\r\n  }, [enableSuggestions])\r\n\r\n  // Realizar b√∫squeda con debounce\r\n  const performSearch = useCallback(async (searchQuery, searchFilters = {}) => {\r\n    if (!searchQuery.trim()) {\r\n      setResults([])\r\n      setSearchTime(0)\r\n      return\r\n    }\r\n\r\n    setIsSearching(true)\r\n    const startTime = performance.now()\r\n\r\n    try {\r\n      // Simular b√∫squeda (en producci√≥n, esto llamar√≠a a una API real)\r\n      await new Promise(resolve => setTimeout(resolve, 300))\r\n\r\n      // Generar resultados mock\r\n      const mockResults = Array.from({ length: Math.min(Math.floor(Math.random() * 20) + 5, maxResults) }, (_, index) => ({\r\n        id: `result-${index}`,\r\n        title: `Resultado ${index + 1} para \"${searchQuery}\"`,\r\n        description: `Descripci√≥n del resultado ${index + 1} que coincide con la b√∫squeda`,\r\n        type: searchCategories[Math.floor(Math.random() * searchCategories.length)].id,\r\n        category: searchCategories[Math.floor(Math.random() * searchCategories.length)].name,\r\n        score: Math.random() * 100,\r\n        date: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),\r\n        author: `Usuario ${Math.floor(Math.random() * 10) + 1}`,\r\n        tags: [`tag${index}`, `search${searchQuery.length}`, 'important'],\r\n        url: `/result/${index}`\r\n      }))\r\n\r\n      // Aplicar filtros\r\n      let filteredResults = mockResults\r\n      \r\n      if (selectedCategory !== 'all') {\r\n        filteredResults = filteredResults.filter(result => result.type === selectedCategory)\r\n      }\r\n\r\n      // Ordenar resultados\r\n      filteredResults.sort((a, b) => {\r\n        switch (sortBy) {\r\n          case 'relevance':\r\n            return b.score - a.score\r\n          case 'date':\r\n            return new Date(b.date) - new Date(a.date)\r\n          case 'title':\r\n            return a.title.localeCompare(b.title)\r\n          default:\r\n            return b.score - a.score\r\n        }\r\n      })\r\n\r\n      setResults(filteredResults)\r\n      \r\n      // Agregar al historial\r\n      if (enableHistory && searchQuery.trim()) {\r\n        setSearchHistory(prev => {\r\n          const newHistory = [\r\n            { query: searchQuery, timestamp: new Date().toISOString(), results: filteredResults.length },\r\n            ...prev.filter(item => item.query !== searchQuery)\r\n          ].slice(0, 20)\r\n          return newHistory\r\n        })\r\n      }\r\n\r\n      const endTime = performance.now()\r\n      setSearchTime(Math.round(endTime - startTime))\r\n\r\n      // Llamar al callback externo\r\n      if (onSearch) {\r\n        onSearch(searchQuery, filteredResults, searchFilters)\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('Error en b√∫squeda:', error)\r\n      setResults([])\r\n    } finally {\r\n      setIsSearching(false)\r\n    }\r\n  }, [selectedCategory, sortBy, maxResults, searchCategories, enableHistory, onSearch])\r\n\r\n  // Manejar cambios en la consulta con debounce\r\n  useEffect(() => {\r\n    if (debounceRef.current) {\r\n      clearTimeout(debounceRef.current)\r\n    }\r\n\r\n    debounceRef.current = setTimeout(() => {\r\n      performSearch(query, filters)\r\n      generateSuggestions(query)\r\n    }, 300)\r\n\r\n    return () => {\r\n      if (debounceRef.current) {\r\n        clearTimeout(debounceRef.current)\r\n      }\r\n    }\r\n  }, [query, filters, performSearch, generateSuggestions])\r\n\r\n  // Manejar submit del formulario\r\n  const handleSubmit = useCallback((e) => {\r\n    e.preventDefault()\r\n    performSearch(query, filters)\r\n    setIsOpen(false)\r\n  }, [query, filters, performSearch])\r\n\r\n  // Agregar o quitar bookmark\r\n  const toggleBookmark = useCallback((result) => {\r\n    setBookmarks(prev => {\r\n      const exists = prev.find(bookmark => bookmark.id === result.id)\r\n      if (exists) {\r\n        return prev.filter(bookmark => bookmark.id !== result.id)\r\n      } else {\r\n        return [...prev, { ...result, bookmarkedAt: new Date().toISOString() }]\r\n      }\r\n    })\r\n  }, [])\r\n\r\n  // Limpiar b√∫squeda\r\n  const clearSearch = useCallback(() => {\r\n    setQuery('')\r\n    setResults([])\r\n    setSuggestions([])\r\n    setFilters({})\r\n    setSelectedCategory('all')\r\n    inputRef.current?.focus()\r\n  }, [])\r\n\r\n  // Aplicar sugerencia\r\n  const applySuggestion = useCallback((suggestion) => {\r\n    setQuery(suggestion.text)\r\n    setSelectedCategory(suggestion.type)\r\n    setSuggestions([])\r\n    inputRef.current?.focus()\r\n  }, [])\r\n\r\n  // Aplicar b√∫squeda del historial\r\n  const applyHistoryItem = useCallback((historyItem) => {\r\n    setQuery(historyItem.query)\r\n    performSearch(historyItem.query, filters)\r\n    setIsOpen(false)\r\n  }, [filters, performSearch])\r\n\r\n  // Exportar resultados\r\n  const exportResults = useCallback(() => {\r\n    const exportData = {\r\n      query,\r\n      filters,\r\n      results,\r\n      timestamp: new Date().toISOString(),\r\n      totalResults: results.length\r\n    }\r\n\r\n    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' })\r\n    const url = URL.createObjectURL(blob)\r\n    const link = document.createElement('a')\r\n    link.href = url\r\n    link.download = `search-results-${Date.now()}.json`\r\n    link.click()\r\n    URL.revokeObjectURL(url)\r\n  }, [query, filters, results])\r\n\r\n  // Compartir resultados\r\n  const shareResults = useCallback(async () => {\r\n    const shareData = {\r\n      title: `Resultados de b√∫squeda: ${query}`,\r\n      text: `Se encontraron ${results.length} resultados para \"${query}\"`,\r\n      url: window.location.href\r\n    }\r\n\r\n    try {\r\n      if (navigator.share) {\r\n        await navigator.share(shareData)\r\n      } else {\r\n        await navigator.clipboard.writeText(`${shareData.title}\\n${shareData.text}\\n${shareData.url}`)\r\n      }\r\n    } catch (error) {\r\n      console.error('Error al compartir:', error)\r\n    }\r\n  }, [query, results])\r\n\r\n  // Renderizar filtros\r\n  const renderFilters = () => (\r\n    <div className=\"p-4 border-t border-gray-200 dark:border-gray-700\">\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n        {Object.entries(filterOptions).map(([key, filter]) => (\r\n          <div key={key} className=\"space-y-2\">\r\n            <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">\r\n              {filter.label}\r\n            </label>\r\n            \r\n            {filter.type === 'select' && (\r\n              <select\r\n                value={filters[key] || ''}\r\n                onChange={(e) => setFilters(prev => ({ ...prev, [key]: e.target.value }))}\r\n                className=\"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100\"\r\n              >\r\n                <option value=\"\">Todos</option>\r\n                {filter.options.map(option => (\r\n                  <option key={option.value} value={option.value}>\r\n                    {option.label}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n            )}\r\n            \r\n            {filter.type === 'multiselect' && (\r\n              <div className=\"space-y-1\">\r\n                {filter.options.map(option => (\r\n                  <label key={option.value} className=\"flex items-center\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      checked={filters[key]?.includes(option.value) || false}\r\n                      onChange={(e) => {\r\n                        const currentValues = filters[key] || []\r\n                        if (e.target.checked) {\r\n                          setFilters(prev => ({ ...prev, [key]: [...currentValues, option.value] }))\r\n                        } else {\r\n                          setFilters(prev => ({ ...prev, [key]: currentValues.filter(v => v !== option.value) }))\r\n                        }\r\n                      }}\r\n                      className=\"mr-2\"\r\n                    />\r\n                    <span className=\"text-sm text-gray-700 dark:text-gray-300\">{option.label}</span>\r\n                  </label>\r\n                ))}\r\n              </div>\r\n            )}\r\n            \r\n            {filter.type === 'daterange' && (\r\n              <select\r\n                value={filters[key] || ''}\r\n                onChange={(e) => setFilters(prev => ({ ...prev, [key]: e.target.value }))}\r\n                className=\"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100\"\r\n              >\r\n                <option value=\"\">Cualquier fecha</option>\r\n                {filter.options.map(option => (\r\n                  <option key={option.value} value={option.value}>\r\n                    {option.label}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n            )}\r\n          </div>\r\n        ))}\r\n      </div>\r\n      \r\n      <div className=\"mt-4 flex items-center justify-between\">\r\n        <button\r\n          onClick={() => setFilters({})}\r\n          className=\"text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100\"\r\n        >\r\n          Limpiar filtros\r\n        </button>\r\n        \r\n        <div className=\"flex items-center gap-2\">\r\n          <label className=\"text-sm text-gray-600 dark:text-gray-400\">Ordenar por:</label>\r\n          <select\r\n            value={sortBy}\r\n            onChange={(e) => setSortBy(e.target.value)}\r\n            className=\"px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100\"\r\n          >\r\n            <option value=\"relevance\">Relevancia</option>\r\n            <option value=\"date\">Fecha</option>\r\n            <option value=\"title\">T√≠tulo</option>\r\n          </select>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n\r\n  // Renderizar resultados\r\n  const renderResults = () => (\r\n    <div className=\"max-h-96 overflow-y-auto\">\r\n      {results.length === 0 ? (\r\n        <div className=\"p-8 text-center text-gray-500 dark:text-gray-400\">\r\n          {isSearching ? 'Buscando...' : 'No se encontraron resultados'}\r\n        </div>\r\n      ) : (\r\n        <div className=\"divide-y divide-gray-200 dark:divide-gray-700\">\r\n          {results.map(result => (\r\n            <div key={result.id} className=\"p-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors\">\r\n              <div className=\"flex items-start justify-between\">\r\n                <div className=\"flex-1 min-w-0\">\r\n                  <h3 className=\"text-sm font-medium text-gray-900 dark:text-gray-100 truncate\">\r\n                    {result.title}\r\n                  </h3>\r\n                  <p className=\"text-sm text-gray-600 dark:text-gray-400 mt-1\">\r\n                    {result.description}\r\n                  </p>\r\n                  <div className=\"flex items-center gap-4 mt-2 text-xs text-gray-500 dark:text-gray-400\">\r\n                    <span className=\"flex items-center gap-1\">\r\n                      <TagIcon className=\"w-3 h-3\" />\r\n                      {result.category}\r\n                    </span>\r\n                    <span className=\"flex items-center gap-1\">\r\n                      <CalendarIcon className=\"w-3 h-3\" />\r\n                      {new Date(result.date).toLocaleDateString()}\r\n                    </span>\r\n                    <span className=\"flex items-center gap-1\">\r\n                      <UserIcon className=\"w-3 h-3\" />\r\n                      {result.author}\r\n                    </span>\r\n                    <span>\r\n                      Relevancia: {Math.round(result.score)}%\r\n                    </span>\r\n                  </div>\r\n                </div>\r\n                \r\n                <div className=\"flex items-center gap-1 ml-4\">\r\n                  <button\r\n                    onClick={() => toggleBookmark(result)}\r\n                    className=\"p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded\"\r\n                    title={bookmarks.find(b => b.id === result.id) ? 'Quitar bookmark' : 'Agregar bookmark'}\r\n                  >\r\n                    <BookmarkIcon \r\n                      className={`w-4 h-4 ${bookmarks.find(b => b.id === result.id) ? 'fill-current text-yellow-500' : 'text-gray-400'}`} \r\n                    />\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      )}\r\n      \r\n      {results.length > 0 && (\r\n        <div className=\"p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800\">\r\n          <div className=\"flex items-center justify-between text-sm text-gray-600 dark:text-gray-400\">\r\n            <span>{results.length} resultados ({searchTime}ms)</span>\r\n            <div className=\"flex items-center gap-2\">\r\n              <button\r\n                onClick={exportResults}\r\n                className=\"flex items-center gap-1 hover:text-gray-900 dark:hover:text-gray-100\"\r\n                title=\"Exportar resultados\"\r\n              >\r\n                <DocumentTextIcon className=\"w-4 h-4\" />\r\n                Exportar\r\n              </button>\r\n              <button\r\n                onClick={shareResults}\r\n                className=\"flex items-center gap-1 hover:text-gray-900 dark:hover:text-gray-100\"\r\n                title=\"Compartir resultados\"\r\n              >\r\n                <ShareIcon className=\"w-4 h-4\" />\r\n                Compartir\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n\r\n  return (\r\n    <div className=\"relative\" ref={searchRef}>\r\n      {/* Input de b√∫squeda */}\r\n      <form onSubmit={handleSubmit} className=\"relative\">\r\n        <div className=\"relative\">\r\n          <div className=\"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none\">\r\n            <MagnifyingGlassIcon className=\"h-5 w-5 text-gray-400\" />\r\n          </div>\r\n          \r\n          <input\r\n            ref={inputRef}\r\n            type=\"text\"\r\n            value={query}\r\n            onChange={(e) => setQuery(e.target.value)}\r\n            onFocus={() => setIsOpen(true)}\r\n            placeholder={placeholder}\r\n            className=\"block w-full pl-10 pr-12 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n          />\r\n          \r\n          <div className=\"absolute inset-y-0 right-0 flex items-center\">\r\n            {query && (\r\n              <button\r\n                type=\"button\"\r\n                onClick={clearSearch}\r\n                className=\"p-1 mr-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300\"\r\n              >\r\n                <XMarkIcon className=\"h-5 w-5\" />\r\n              </button>\r\n            )}\r\n            \r\n            {enableFilters && (\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setShowFilters(!showFilters)}\r\n                className=\"p-1 mr-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300\"\r\n                title=\"Filtros\"\r\n              >\r\n                <FunnelIcon className=\"h-5 w-5\" />\r\n              </button>\r\n            )}\r\n            \r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setIsOpen(!isOpen)}\r\n              className=\"p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300\"\r\n            >\r\n              <ChevronDownIcon className={`h-5 w-5 transform transition-transform ${isOpen ? 'rotate-180' : ''}`} />\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </form>\r\n\r\n      {/* Panel desplegable */}\r\n      {isOpen && (\r\n        <div className=\"absolute top-full left-0 right-0 mt-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50\">\r\n          {/* Categor√≠as */}\r\n          <div className=\"flex items-center gap-2 p-4 border-b border-gray-200 dark:border-gray-700\">\r\n            <span className=\"text-sm text-gray-600 dark:text-gray-400\">Categor√≠a:</span>\r\n            <div className=\"flex items-center gap-1\">\r\n              {searchCategories.map(category => {\r\n                const Icon = category.icon\r\n                return (\r\n                  <button\r\n                    key={category.id}\r\n                    onClick={() => setSelectedCategory(category.id)}\r\n                    className={`flex items-center gap-1 px-3 py-1 rounded-full text-sm transition-colors ${\r\n                      selectedCategory === category.id\r\n                        ? `bg-${category.color}-100 dark:bg-${category.color}-900/20 text-${category.color}-700 dark:text-${category.color}-400`\r\n                        : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600'\r\n                    }`}\r\n                  >\r\n                    <Icon className=\"w-4 h-4\" />\r\n                    {category.name}\r\n                  </button>\r\n                )\r\n              })}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Filtros */}\r\n          {showFilters && enableFilters && renderFilters()}\r\n\r\n          {/* Historial */}\r\n          {enableHistory && searchHistory.length > 0 && query.length === 0 && (\r\n            <div className=\"p-4 border-b border-gray-200 dark:border-gray-700\">\r\n              <div className=\"flex items-center justify-between mb-2\">\r\n                <h3 className=\"text-sm font-medium text-gray-700 dark:text-gray-300 flex items-center gap-1\">\r\n                  <ClockIcon className=\"w-4 h-4\" />\r\n                  B√∫squedas recientes\r\n                </h3>\r\n                <button\r\n                  onClick={() => setSearchHistory([])}\r\n                  className=\"text-xs text-gray-500 hover:text-gray-700 dark:hover:text-gray-300\"\r\n                >\r\n                  Limpiar\r\n                </button>\r\n              </div>\r\n              <div className=\"space-y-1\">\r\n                {searchHistory.slice(0, 5).map((item, index) => (\r\n                  <button\r\n                    key={index}\r\n                    onClick={() => applyHistoryItem(item)}\r\n                    className=\"w-full text-left px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center justify-between\"\r\n                  >\r\n                    <span>{item.query}</span>\r\n                    <span className=\"text-xs text-gray-400\">\r\n                      {item.results} resultados\r\n                    </span>\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Sugerencias */}\r\n          {suggestions.length > 0 && (\r\n            <div className=\"p-4 border-b border-gray-200 dark:border-gray-700\">\r\n              <h3 className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">Sugerencias</h3>\r\n              <div className=\"space-y-1\">\r\n                {suggestions.map((suggestion, index) => (\r\n                  <button\r\n                    key={index}\r\n                    onClick={() => applySuggestion(suggestion)}\r\n                    className=\"w-full text-left px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center justify-between\"\r\n                  >\r\n                    <span>{suggestion.text}</span>\r\n                    <span className=\"text-xs text-gray-400\">\r\n                      {suggestion.count} resultados\r\n                    </span>\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Resultados */}\r\n          {renderResults()}\r\n        </div>\r\n      )}\r\n\r\n      {/* Overlay para cerrar */}\r\n      {isOpen && (\r\n        <div\r\n          className=\"fixed inset-0 z-40\"\r\n          onClick={() => setIsOpen(false)}\r\n        />\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default AdvancedSearchSystem","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\settings\\CompanyForm.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'companyKnowledgeService' is defined but never used.","line":5,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":31},{"ruleId":"no-unused-vars","severity":1,"message":"'DocumentTextIcon' is defined but never used.","line":19,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'KeyIcon' is defined but never used.","line":21,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":10},{"ruleId":"no-unused-vars","severity":1,"message":"'ServerIcon' is defined but never used.","line":23,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":13},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadEmployees'. Either include it or remove the dependency array.","line":199,"column":6,"nodeType":"ArrayExpression","endLine":199,"endColumn":15,"suggestions":[{"desc":"Update the dependencies array to be: [company, loadEmployees]","fix":{"range":[7838,7847],"text":"[company, loadEmployees]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { useAuth } from '../../contexts/AuthContext.js'\r\nimport { supabase } from '../../lib/supabaseClient.js'\r\nimport organizedDatabaseService from '../../services/organizedDatabaseService.js'\r\nimport companyKnowledgeService from '../../services/companyKnowledgeService.js'\r\nimport {\r\n  BuildingOfficeIcon,\r\n  UserGroupIcon,\r\n  PhoneIcon,\r\n  ChatBubbleLeftRightIcon,\r\n  PlusIcon,\r\n  TrashIcon,\r\n  ArrowLeftIcon,\r\n  CheckIcon,\r\n  ArrowUpIcon,\r\n  ArrowDownIcon,\r\n  ArrowsUpDownIcon,\r\n  EnvelopeIcon,\r\n  DocumentTextIcon,\r\n  Cog6ToothIcon,\r\n  KeyIcon,\r\n  GlobeAltIcon,\r\n  ServerIcon,\r\n  ChatBubbleLeftIcon,\r\n  DevicePhoneMobileIcon,\r\n  ComputerDesktopIcon,\r\n  BriefcaseIcon,\r\n  CubeIcon\r\n} from '@heroicons/react/24/outline'\r\nimport toast from 'react-hot-toast'\r\n\r\nconst CompanyForm = ({ company, onSuccess, onCancel, companyId, isCompanySpecificMode }) => {\r\n  const { user } = useAuth()\r\n  const [formData, setFormData] = useState({\r\n    name: '',\r\n    description: '',\r\n    telegram_bot: '',\r\n    whatsapp_number: '',\r\n    status: 'active',\r\n    fallback_config: { order: ['WhatsApp', 'Telegram', 'SMS', 'Email'] },\r\n    // Configuraci√≥n de Email\r\n    email_enabled: false,\r\n    email_sender_name: '',\r\n    email_sender_email: '',\r\n    email_reply_to: '',\r\n    email_config: {},\r\n    // Configuraci√≥n de SMS\r\n    sms_enabled: false,\r\n    sms_sender_name: '',\r\n    sms_sender_phone: '',\r\n    sms_config: {},\r\n    // Configuraci√≥n de Telegram (mejorada)\r\n    telegram_enabled: false,\r\n    telegram_bot_token: '',\r\n    telegram_bot_username: '',\r\n    telegram_webhook_url: '',\r\n    telegram_config: {},\r\n    // Configuraci√≥n de WhatsApp (mejorada)\r\n    whatsapp_enabled: false,\r\n    whatsapp_access_token: '',\r\n    whatsapp_phone_number_id: '',\r\n    whatsapp_webhook_verify_token: '',\r\n    whatsapp_config: {},\r\n    // Configuraci√≥n de Groq AI\r\n    groq_enabled: false,\r\n    groq_api_key: '',\r\n    groq_model: 'gemma2-9b-it',\r\n    groq_temperature: 0.7,\r\n    groq_max_tokens: 800,\r\n    groq_config: {},\r\n    // Configuraci√≥n de Google Workspace\r\n    google_enabled: false,\r\n    google_api_key: '',\r\n    google_client_id: '',\r\n    google_client_secret: '',\r\n    google_config: {},\r\n    // Configuraci√≥n de Microsoft 365\r\n    microsoft_enabled: false,\r\n    microsoft_client_id: '',\r\n    microsoft_client_secret: '',\r\n    microsoft_tenant_id: '',\r\n    microsoft_config: {},\r\n    // Configuraci√≥n de Slack\r\n    slack_enabled: false,\r\n    slack_bot_token: '',\r\n    slack_signing_secret: '',\r\n    slack_default_channel: '',\r\n    slack_config: {},\r\n    // Configuraci√≥n de Teams\r\n    teams_enabled: false,\r\n    teams_app_id: '',\r\n    teams_client_secret: '',\r\n    teams_tenant_id: '',\r\n    teams_config: {},\r\n    // Configuraci√≥n de HubSpot\r\n    hubspot_enabled: false,\r\n    hubspot_api_key: '',\r\n    hubspot_portal_id: '',\r\n    hubspot_config: {},\r\n    // Configuraci√≥n de Salesforce\r\n    salesforce_enabled: false,\r\n    salesforce_consumer_key: '',\r\n    salesforce_consumer_secret: '',\r\n    salesforce_username: '',\r\n    salesforce_password: '',\r\n    salesforce_config: {}\r\n  })\r\n  const [employees, setEmployees] = useState([])\r\n  const [loading, setLoading] = useState(false)\r\n  const [currentPage, setCurrentPage] = useState(1)\r\n  const [employeesPerPage] = useState(10)\r\n  const [fallbackOrder, setFallbackOrder] = useState(['WhatsApp', 'Telegram', 'SMS', 'Email'])\r\n  const [activeChannelTab, setActiveChannelTab] = useState('email')\r\n  \r\n  // Estado para manejar debounce de guardado autom√°tico\r\n  const [debounceTimers, setDebounceTimers] = useState({})\r\n\r\n  useEffect(() => {\r\n    if (company) {\r\n      const fallbackConfig = company.fallback_config || { order: ['WhatsApp', 'Telegram', 'SMS', 'Email'] }\r\n      setFormData({\r\n        name: company.name || '',\r\n        description: company.description || '',\r\n        telegram_bot: company.telegram_bot || '',\r\n        whatsapp_number: company.whatsapp_number || '',\r\n        status: company.status || 'active',\r\n        fallback_config: fallbackConfig,\r\n        // Configuraci√≥n de canales\r\n        email_enabled: company.email_enabled || false,\r\n        email_sender_name: company.email_sender_name || '',\r\n        email_sender_email: company.email_sender_email || '',\r\n        email_reply_to: company.email_reply_to || '',\r\n        email_config: company.email_config || {},\r\n        sms_enabled: company.sms_enabled || false,\r\n        sms_sender_name: company.sms_sender_name || '',\r\n        sms_sender_phone: company.sms_sender_phone || '',\r\n        sms_config: company.sms_config || {},\r\n        telegram_enabled: company.telegram_enabled || false,\r\n        telegram_bot_token: company.telegram_bot_token || '',\r\n        telegram_bot_username: company.telegram_bot_username || '',\r\n        telegram_webhook_url: company.telegram_webhook_url || '',\r\n        telegram_config: company.telegram_config || {},\r\n        whatsapp_enabled: company.whatsapp_enabled || false,\r\n        whatsapp_access_token: company.whatsapp_access_token || '',\r\n        whatsapp_phone_number_id: company.whatsapp_phone_number_id || '',\r\n        whatsapp_webhook_verify_token: company.whatsapp_webhook_verify_token || '',\r\n        whatsapp_config: company.whatsapp_config || {},\r\n        groq_enabled: company.groq_enabled || false,\r\n        groq_api_key: company.groq_api_key || '',\r\n        groq_model: company.groq_model || 'gemma2-9b-it',\r\n        groq_temperature: company.groq_temperature || 0.7,\r\n        groq_max_tokens: company.groq_max_tokens || 800,\r\n        groq_config: company.groq_config || {},\r\n        google_enabled: company.google_enabled || false,\r\n        google_api_key: company.google_api_key || '',\r\n        google_client_id: company.google_client_id || '',\r\n        google_client_secret: company.google_client_secret || '',\r\n        google_config: company.google_config || {},\r\n        microsoft_enabled: company.microsoft_enabled || false,\r\n        microsoft_client_id: company.microsoft_client_id || '',\r\n        microsoft_client_secret: company.microsoft_client_secret || '',\r\n        microsoft_tenant_id: company.microsoft_tenant_id || '',\r\n        microsoft_config: company.microsoft_config || {},\r\n        slack_enabled: company.slack_enabled || false,\r\n        slack_bot_token: company.slack_bot_token || '',\r\n        slack_signing_secret: company.slack_signing_secret || '',\r\n        slack_default_channel: company.slack_default_channel || '',\r\n        slack_config: company.slack_config || {},\r\n        teams_enabled: company.teams_enabled || false,\r\n        teams_app_id: company.teams_app_id || '',\r\n        teams_client_secret: company.teams_client_secret || '',\r\n        teams_tenant_id: company.teams_tenant_id || '',\r\n        teams_config: company.teams_config || {},\r\n        hubspot_enabled: company.hubspot_enabled || false,\r\n        hubspot_api_key: company.hubspot_api_key || '',\r\n        hubspot_portal_id: company.hubspot_portal_id || '',\r\n        hubspot_config: company.hubspot_config || {},\r\n        salesforce_enabled: company.salesforce_enabled || false,\r\n        salesforce_consumer_key: company.salesforce_consumer_key || '',\r\n        salesforce_consumer_secret: company.salesforce_consumer_secret || '',\r\n        salesforce_username: company.salesforce_username || '',\r\n        salesforce_password: company.salesforce_password || '',\r\n        salesforce_config: company.salesforce_config || {}\r\n      })\r\n      setFallbackOrder(fallbackConfig.order || ['WhatsApp', 'Telegram', 'SMS', 'Email'])\r\n      loadEmployees()\r\n    } else {\r\n      // Nueva empresa - agregar un empleado por defecto\r\n      setEmployees([{\r\n        id: 'temp-' + Date.now(),\r\n        name: '',\r\n        email: '',\r\n        phone: '',\r\n        department: '',\r\n        position: '',\r\n        isNew: true\r\n      }])\r\n    }\r\n  }, [company])\r\n\r\n  const loadEmployees = async () => {\r\n    if (!company) return\r\n\r\n    try {\r\n      // Usar el servicio de base de datos organizada para cargar empleados reales\r\n      const allEmployees = await organizedDatabaseService.getEmployees()\r\n      const companyEmployees = allEmployees.filter(emp => emp.company_id === company.id)\r\n      setEmployees(companyEmployees)\r\n\r\n    } catch (error) {\r\n      console.error('Error loading employees:', error)\r\n      toast.error('Error al cargar empleados')\r\n    }\r\n  }\r\n\r\n  const handleInputChange = (field, value) => {\r\n    setFormData(prev => ({\r\n      ...prev,\r\n      [field]: value\r\n    }))\r\n  }\r\n\r\n  const addEmployee = () => {\r\n    setEmployees(prev => [...prev, {\r\n      id: 'temp-' + Date.now(),\r\n      name: '',\r\n      email: '',\r\n      phone: '',\r\n      department: '',\r\n      position: '',\r\n      isNew: true\r\n    }])\r\n  }\r\n\r\n  const updateEmployee = (index, field, value) => {\r\n    // Calcular el √≠ndice global basado en la p√°gina actual\r\n    const globalIndex = indexOfFirstEmployee + index\r\n    setEmployees(prev => prev.map((emp, i) =>\r\n      i === globalIndex ? { ...emp, [field]: value } : emp\r\n    ))\r\n  }\r\n\r\n  const removeEmployee = (index) => {\r\n    // Calcular el √≠ndice global basado en la p√°gina actual\r\n    const globalIndex = indexOfFirstEmployee + index\r\n    setEmployees(prev => prev.filter((_, i) => i !== globalIndex))\r\n  }\r\n\r\n  // Funciones para reordenar el fallback\r\n  const moveChannelUp = (index) => {\r\n    if (index > 0) {\r\n      const newOrder = [...fallbackOrder]\r\n      ;[newOrder[index - 1], newOrder[index]] = [newOrder[index], newOrder[index - 1]]\r\n      setFallbackOrder(newOrder)\r\n      setFormData(prev => ({\r\n        ...prev,\r\n        fallback_config: { ...prev.fallback_config, order: newOrder }\r\n      }))\r\n    }\r\n  }\r\n\r\n  const moveChannelDown = (index) => {\r\n    if (index < fallbackOrder.length - 1) {\r\n      const newOrder = [...fallbackOrder]\r\n      ;[newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]]\r\n      setFallbackOrder(newOrder)\r\n      setFormData(prev => ({\r\n        ...prev,\r\n        fallback_config: { ...prev.fallback_config, order: newOrder }\r\n      }))\r\n    }\r\n  }\r\n\r\n  const resetFallbackOrder = () => {\r\n    const defaultOrder = ['WhatsApp', 'Telegram', 'SMS', 'Email']\r\n    setFallbackOrder(defaultOrder)\r\n    setFormData(prev => ({\r\n      ...prev,\r\n      fallback_config: { ...prev.fallback_config, order: defaultOrder }\r\n    }))\r\n  }\r\n\r\n  // Calcular empleados de la p√°gina actual\r\n  const indexOfLastEmployee = currentPage * employeesPerPage\r\n  const indexOfFirstEmployee = indexOfLastEmployee - employeesPerPage\r\n  const currentEmployees = employees.slice(indexOfFirstEmployee, indexOfLastEmployee)\r\n\r\n  // Calcular total de p√°ginas\r\n  const totalPages = Math.ceil(employees.length / employeesPerPage)\r\n\r\n  // Funciones de paginaci√≥n\r\n  const paginate = (pageNumber) => setCurrentPage(pageNumber)\r\n  const nextPage = () => setCurrentPage(prev => Math.min(prev + 1, totalPages))\r\n  const prevPage = () => setCurrentPage(prev => Math.max(prev - 1, 1))\r\n\r\n  const validateForm = () => {\r\n    if (!formData.name?.trim()) {\r\n      toast.error('El nombre de la empresa es obligatorio')\r\n      return false\r\n    }\r\n\r\n    // Validar empleados solo si no est√° en modo espec√≠fico\r\n    if (!isCompanySpecificMode) {\r\n      for (let i = 0; i < employees.length; i++) {\r\n        const emp = employees[i]\r\n        if (!emp.name?.trim() || !emp.email?.trim()) {\r\n          toast.error(`El empleado ${i + 1} debe tener nombre y email`)\r\n          return false\r\n        }\r\n      }\r\n    }\r\n\r\n    return true\r\n  }\r\n\r\n  // Funci√≥n para guardar autom√°ticamente un canal espec√≠fico\r\n  const saveChannelConfig = async (channelType, channelData) => {\r\n    if (!company?.id || !isCompanySpecificMode) return\r\n\r\n    try {\r\n      const updateData = {\r\n        [`${channelType}_enabled`]: channelData[`${channelType}_enabled`],\r\n        updated_at: new Date().toISOString()\r\n      }\r\n\r\n      // Agregar campos espec√≠ficos del canal\r\n      Object.keys(channelData).forEach(key => {\r\n        if (key.startsWith(`${channelType}_`) && key !== `${channelType}_enabled`) {\r\n          updateData[key] = channelData[key]\r\n        }\r\n      })\r\n\r\n      console.log(`Guardando autom√°ticamente configuraci√≥n ${channelType}:`, updateData)\r\n      \r\n      const { error } = await supabase\r\n        .from('companies')\r\n        .update(updateData)\r\n        .eq('id', company.id)\r\n\r\n      if (error) {\r\n        console.error(`Error guardando ${channelType}:`, error)\r\n        // Mostrar error sutil sin cerrar la p√°gina\r\n        toast.error(`Error al guardar ${channelType}: ${error.message}`, {\r\n          duration: 3000,\r\n          position: 'bottom-right'\r\n        })\r\n      } else {\r\n        console.log(`Configuraci√≥n ${channelType} guardada autom√°ticamente`)\r\n        // Mostrar √©xito sutil\r\n        toast.success(`${channelType} guardado autom√°ticamente`, {\r\n          duration: 2000,\r\n          position: 'bottom-right'\r\n        })\r\n      }\r\n    } catch (error) {\r\n      console.error(`Error en guardado autom√°tico de ${channelType}:`, error)\r\n      // Mostrar error sin cerrar la p√°gina\r\n      toast.error(`Error inesperado guardando ${channelType}`, {\r\n        duration: 3000,\r\n        position: 'bottom-right'\r\n      })\r\n    }\r\n  }\r\n\r\n  // Funci√≥n para manejar cambios en los campos de canales con guardado autom√°tico\r\n  const handleChannelChange = (field, value) => {\r\n    handleInputChange(field, value)\r\n    \r\n    // Extraer el tipo de canal del nombre del campo\r\n    const channelType = field.split('_')[0]\r\n    \r\n    // Cancelar el timer existente para este canal\r\n    if (debounceTimers[channelType]) {\r\n      clearTimeout(debounceTimers[channelType])\r\n    }\r\n    \r\n    // Crear un nuevo timer para guardar despu√©s de 1.5 segundos\r\n    const newTimer = setTimeout(() => {\r\n      // Obtener todos los datos del canal actual\r\n      const channelData = {}\r\n      Object.keys(formData).forEach(key => {\r\n        if (key.startsWith(`${channelType}_`)) {\r\n          channelData[key] = formData[key]\r\n        }\r\n      })\r\n      \r\n      // Guardar autom√°ticamente solo si estamos en modo espec√≠fico\r\n      if (isCompanySpecificMode && company?.id) {\r\n        saveChannelConfig(channelType, channelData)\r\n      }\r\n      \r\n      // Limpiar el timer despu√©s de ejecutar\r\n      setDebounceTimers(prev => {\r\n        const newTimers = { ...prev };\r\n        delete newTimers[channelType];\r\n        return newTimers;\r\n      })\r\n    }, 1500) // Aumentado a 1.5 segundos para evitar guardados frecuentes\r\n    \r\n    // Guardar el nuevo timer\r\n    setDebounceTimers(prev => ({\r\n      ...prev,\r\n      [channelType]: newTimer\r\n    }))\r\n  }\r\n\r\n  const handleSubmit = async (e) => {\r\n    e.preventDefault()\r\n\r\n    // En modo espec√≠fico, solo validar que el nombre de la empresa exista\r\n    if (isCompanySpecificMode) {\r\n      if (!formData.name?.trim()) {\r\n        toast.error('El nombre de la empresa es obligatorio')\r\n        return\r\n      }\r\n    } else {\r\n      if (!validateForm()) return\r\n    }\r\n\r\n    setLoading(true)\r\n\r\n    try {\r\n      let companyId = company?.id\r\n\r\n      // En modo espec√≠fico, guardar toda la configuraci√≥n de canales\r\n      if (isCompanySpecificMode) {\r\n        const updateData = {\r\n          // Configuraci√≥n completa de Email\r\n          email_enabled: formData.email_enabled,\r\n          email_sender_name: formData.email_sender_name,\r\n          email_sender_email: formData.email_sender_email,\r\n          email_reply_to: formData.email_reply_to,\r\n          email_config: formData.email_config,\r\n          // Configuraci√≥n completa de SMS\r\n          sms_enabled: formData.sms_enabled,\r\n          sms_sender_name: formData.sms_sender_name,\r\n          sms_sender_phone: formData.sms_sender_phone,\r\n          sms_config: formData.sms_config,\r\n          // Configuraci√≥n completa de Telegram\r\n          telegram_enabled: formData.telegram_enabled,\r\n          telegram_bot_token: formData.telegram_bot_token,\r\n          telegram_bot_username: formData.telegram_bot_username,\r\n          telegram_webhook_url: formData.telegram_webhook_url,\r\n          telegram_config: formData.telegram_config,\r\n          // Configuraci√≥n completa de WhatsApp\r\n          whatsapp_enabled: formData.whatsapp_enabled,\r\n          whatsapp_access_token: formData.whatsapp_access_token,\r\n          whatsapp_phone_number_id: formData.whatsapp_phone_number_id,\r\n          whatsapp_webhook_verify_token: formData.whatsapp_webhook_verify_token,\r\n          whatsapp_config: formData.whatsapp_config,\r\n          // Configuraci√≥n completa de Groq AI\r\n          groq_enabled: formData.groq_enabled,\r\n          groq_api_key: formData.groq_api_key,\r\n          groq_model: formData.groq_model,\r\n          groq_temperature: formData.groq_temperature,\r\n          groq_max_tokens: formData.groq_max_tokens,\r\n          groq_config: formData.groq_config,\r\n          // Configuraci√≥n completa de Google Workspace\r\n          google_enabled: formData.google_enabled,\r\n          google_api_key: formData.google_api_key,\r\n          google_client_id: formData.google_client_id,\r\n          google_client_secret: formData.google_client_secret,\r\n          google_config: formData.google_config,\r\n          // Configuraci√≥n completa de Microsoft 365\r\n          microsoft_enabled: formData.microsoft_enabled,\r\n          microsoft_client_id: formData.microsoft_client_id,\r\n          microsoft_client_secret: formData.microsoft_client_secret,\r\n          microsoft_tenant_id: formData.microsoft_tenant_id,\r\n          microsoft_config: formData.microsoft_config,\r\n          // Configuraci√≥n completa de Slack\r\n          slack_enabled: formData.slack_enabled,\r\n          slack_bot_token: formData.slack_bot_token,\r\n          slack_signing_secret: formData.slack_signing_secret,\r\n          slack_default_channel: formData.slack_default_channel,\r\n          slack_config: formData.slack_config,\r\n          // Configuraci√≥n completa de Teams\r\n          teams_enabled: formData.teams_enabled,\r\n          teams_app_id: formData.teams_app_id,\r\n          teams_client_secret: formData.teams_client_secret,\r\n          teams_tenant_id: formData.teams_tenant_id,\r\n          teams_config: formData.teams_config,\r\n          // Configuraci√≥n completa de HubSpot\r\n          hubspot_enabled: formData.hubspot_enabled,\r\n          hubspot_api_key: formData.hubspot_api_key,\r\n          hubspot_portal_id: formData.hubspot_portal_id,\r\n          hubspot_config: formData.hubspot_config,\r\n          // Configuraci√≥n completa de Salesforce\r\n          salesforce_enabled: formData.salesforce_enabled,\r\n          salesforce_consumer_key: formData.salesforce_consumer_key,\r\n          salesforce_consumer_secret: formData.salesforce_consumer_secret,\r\n          salesforce_username: formData.salesforce_username,\r\n          salesforce_password: formData.salesforce_password,\r\n          salesforce_config: formData.salesforce_config,\r\n          updated_at: new Date().toISOString()\r\n        }\r\n\r\n        console.log('Guardando configuraci√≥n completa de canales:', updateData)\r\n        const { error } = await supabase\r\n          .from('companies')\r\n          .update(updateData)\r\n          .eq('id', company.id)\r\n\r\n        if (error) {\r\n          console.error('Error espec√≠fico de Supabase:', error)\r\n          throw error\r\n        }\r\n\r\n        toast.success('Configuraci√≥n de canales guardada exitosamente')\r\n        // En modo espec√≠fico, no llamar a onSuccess() para evitar redirecci√≥n infinita\r\n        // El usuario permanece en la p√°gina de configuraci√≥n\r\n        return\r\n      }\r\n\r\n      // Crear o actualizar empresa (modo normal)\r\n      if (company) {\r\n        // Actualizar empresa existente\r\n        const { error } = await supabase\r\n          .from('companies')\r\n          .update({\r\n            name: formData.name,\r\n            description: formData.description,\r\n            telegram_bot: formData.telegram_bot,\r\n            whatsapp_number: formData.whatsapp_number,\r\n            status: formData.status,\r\n            fallback_config: formData.fallback_config,\r\n            // Configuraci√≥n de Email\r\n            email_enabled: formData.email_enabled,\r\n            email_sender_name: formData.email_sender_name,\r\n            email_sender_email: formData.email_sender_email,\r\n            email_reply_to: formData.email_reply_to,\r\n            email_config: formData.email_config,\r\n            // Configuraci√≥n de SMS\r\n            sms_enabled: formData.sms_enabled,\r\n            sms_sender_name: formData.sms_sender_name,\r\n            sms_sender_phone: formData.sms_sender_phone,\r\n            sms_config: formData.sms_config,\r\n            // Configuraci√≥n de Telegram\r\n            telegram_enabled: formData.telegram_enabled,\r\n            telegram_bot_token: formData.telegram_bot_token,\r\n            telegram_bot_username: formData.telegram_bot_username,\r\n            telegram_webhook_url: formData.telegram_webhook_url,\r\n            telegram_config: formData.telegram_config,\r\n            // Configuraci√≥n de WhatsApp\r\n            whatsapp_enabled: formData.whatsapp_enabled,\r\n            whatsapp_access_token: formData.whatsapp_access_token,\r\n            whatsapp_phone_number_id: formData.whatsapp_phone_number_id,\r\n            whatsapp_webhook_verify_token: formData.whatsapp_webhook_verify_token,\r\n            whatsapp_config: formData.whatsapp_config,\r\n            // Configuraci√≥n de Groq AI\r\n            groq_enabled: formData.groq_enabled,\r\n            groq_api_key: formData.groq_api_key,\r\n            groq_model: formData.groq_model,\r\n            groq_temperature: formData.groq_temperature,\r\n            groq_max_tokens: formData.groq_max_tokens,\r\n            groq_config: formData.groq_config,\r\n            // Configuraci√≥n de Google Workspace\r\n            google_enabled: formData.google_enabled,\r\n            google_api_key: formData.google_api_key,\r\n            google_client_id: formData.google_client_id,\r\n            google_client_secret: formData.google_client_secret,\r\n            google_config: formData.google_config,\r\n            // Configuraci√≥n de Microsoft 365\r\n            microsoft_enabled: formData.microsoft_enabled,\r\n            microsoft_client_id: formData.microsoft_client_id,\r\n            microsoft_client_secret: formData.microsoft_client_secret,\r\n            microsoft_tenant_id: formData.microsoft_tenant_id,\r\n            microsoft_config: formData.microsoft_config,\r\n            // Configuraci√≥n de Slack\r\n            slack_enabled: formData.slack_enabled,\r\n            slack_bot_token: formData.slack_bot_token,\r\n            slack_signing_secret: formData.slack_signing_secret,\r\n            slack_default_channel: formData.slack_default_channel,\r\n            slack_config: formData.slack_config,\r\n            // Configuraci√≥n de Teams\r\n            teams_enabled: formData.teams_enabled,\r\n            teams_app_id: formData.teams_app_id,\r\n            teams_client_secret: formData.teams_client_secret,\r\n            teams_tenant_id: formData.teams_tenant_id,\r\n            teams_config: formData.teams_config,\r\n            // Configuraci√≥n de HubSpot\r\n            hubspot_enabled: formData.hubspot_enabled,\r\n            hubspot_api_key: formData.hubspot_api_key,\r\n            hubspot_portal_id: formData.hubspot_portal_id,\r\n            hubspot_config: formData.hubspot_config,\r\n            // Configuraci√≥n de Salesforce\r\n            salesforce_enabled: formData.salesforce_enabled,\r\n            salesforce_consumer_key: formData.salesforce_consumer_key,\r\n            salesforce_consumer_secret: formData.salesforce_consumer_secret,\r\n            salesforce_username: formData.salesforce_username,\r\n            salesforce_password: formData.salesforce_password,\r\n            salesforce_config: formData.salesforce_config,\r\n            updated_at: new Date().toISOString()\r\n          })\r\n          .eq('id', company.id)\r\n\r\n        if (error) throw error\r\n      } else {\r\n        // Crear nueva empresa\r\n        const { data, error } = await supabase\r\n          .from('companies')\r\n          .insert({\r\n            name: formData.name,\r\n            description: formData.description,\r\n            telegram_bot: formData.telegram_bot,\r\n            whatsapp_number: formData.whatsapp_number,\r\n            status: formData.status,\r\n            fallback_config: formData.fallback_config,\r\n            // Configuraci√≥n de Email\r\n            email_enabled: formData.email_enabled,\r\n            email_sender_name: formData.email_sender_name,\r\n            email_sender_email: formData.email_sender_email,\r\n            email_reply_to: formData.email_reply_to,\r\n            email_config: formData.email_config,\r\n            // Configuraci√≥n de SMS\r\n            sms_enabled: formData.sms_enabled,\r\n            sms_sender_name: formData.sms_sender_name,\r\n            sms_sender_phone: formData.sms_sender_phone,\r\n            sms_config: formData.sms_config,\r\n            // Configuraci√≥n de Telegram\r\n            telegram_enabled: formData.telegram_enabled,\r\n            telegram_bot_token: formData.telegram_bot_token,\r\n            telegram_bot_username: formData.telegram_bot_username,\r\n            telegram_webhook_url: formData.telegram_webhook_url,\r\n            telegram_config: formData.telegram_config,\r\n            // Configuraci√≥n de WhatsApp\r\n            whatsapp_enabled: formData.whatsapp_enabled,\r\n            whatsapp_access_token: formData.whatsapp_access_token,\r\n            whatsapp_phone_number_id: formData.whatsapp_phone_number_id,\r\n            whatsapp_webhook_verify_token: formData.whatsapp_webhook_verify_token,\r\n            whatsapp_config: formData.whatsapp_config,\r\n            // Configuraci√≥n de Groq AI\r\n            groq_enabled: formData.groq_enabled,\r\n            groq_api_key: formData.groq_api_key,\r\n            groq_model: formData.groq_model,\r\n            groq_temperature: formData.groq_temperature,\r\n            groq_max_tokens: formData.groq_max_tokens,\r\n            groq_config: formData.groq_config,\r\n            // Configuraci√≥n de Google Workspace\r\n            google_enabled: formData.google_enabled,\r\n            google_api_key: formData.google_api_key,\r\n            google_client_id: formData.google_client_id,\r\n            google_client_secret: formData.google_client_secret,\r\n            google_config: formData.google_config,\r\n            // Configuraci√≥n de Microsoft 365\r\n            microsoft_enabled: formData.microsoft_enabled,\r\n            microsoft_client_id: formData.microsoft_client_id,\r\n            microsoft_client_secret: formData.microsoft_client_secret,\r\n            microsoft_tenant_id: formData.microsoft_tenant_id,\r\n            microsoft_config: formData.microsoft_config,\r\n            // Configuraci√≥n de Slack\r\n            slack_enabled: formData.slack_enabled,\r\n            slack_bot_token: formData.slack_bot_token,\r\n            slack_signing_secret: formData.slack_signing_secret,\r\n            slack_default_channel: formData.slack_default_channel,\r\n            slack_config: formData.slack_config,\r\n            // Configuraci√≥n de Teams\r\n            teams_enabled: formData.teams_enabled,\r\n            teams_app_id: formData.teams_app_id,\r\n            teams_client_secret: formData.teams_client_secret,\r\n            teams_tenant_id: formData.teams_tenant_id,\r\n            teams_config: formData.teams_config,\r\n            // Configuraci√≥n de HubSpot\r\n            hubspot_enabled: formData.hubspot_enabled,\r\n            hubspot_api_key: formData.hubspot_api_key,\r\n            hubspot_portal_id: formData.hubspot_portal_id,\r\n            hubspot_config: formData.hubspot_config,\r\n            // Configuraci√≥n de Salesforce\r\n            salesforce_enabled: formData.salesforce_enabled,\r\n            salesforce_consumer_key: formData.salesforce_consumer_key,\r\n            salesforce_consumer_secret: formData.salesforce_consumer_secret,\r\n            salesforce_username: formData.salesforce_username,\r\n            salesforce_password: formData.salesforce_password,\r\n            salesforce_config: formData.salesforce_config,\r\n            user_id: user.id\r\n          })\r\n          .select()\r\n          .single()\r\n\r\n        if (error) throw error\r\n        companyId = data.id\r\n      }\r\n\r\n      // Procesar empleados (solo en modo normal)\r\n      for (const emp of employees) {\r\n        if (emp.isNew) {\r\n          // Crear nuevo empleado\r\n          const { error } = await supabase\r\n            .from('employees')\r\n            .insert({\r\n              company_id: companyId,\r\n              name: emp.name,\r\n              email: emp.email,\r\n              phone: emp.phone || null,\r\n              department: emp.department || null,\r\n              position: emp.position || null,\r\n              is_active: true\r\n            })\r\n\r\n          if (error) throw error\r\n        } else {\r\n          // Actualizar empleado existente\r\n          const { error } = await supabase\r\n            .from('employees')\r\n            .update({\r\n              name: emp.name,\r\n              email: emp.email,\r\n              phone: emp.phone || null,\r\n              department: emp.department || null,\r\n              position: emp.position || null,\r\n              updated_at: new Date().toISOString()\r\n            })\r\n            .eq('id', emp.id)\r\n\r\n          if (error) throw error\r\n        }\r\n      }\r\n\r\n      toast.success(company ? 'Empresa actualizada exitosamente' : 'Empresa creada exitosamente')\r\n      onSuccess()\r\n    } catch (error) {\r\n      console.error('Error saving company:', error)\r\n      console.error('Error details:', {\r\n        message: error.message,\r\n        details: error.details,\r\n        hint: error.hint,\r\n        code: error.code\r\n      })\r\n      \r\n      // Mostrar error detallado pero sin cerrar la p√°gina\r\n      const errorMessage = error.message || 'Error desconocido'\r\n      toast.error(`Error al guardar: ${errorMessage}`, {\r\n        duration: 5000,\r\n        position: 'top-center'\r\n      })\r\n      \r\n      // En modo espec√≠fico, no cerrar la p√°gina incluso si hay error\r\n      if (isCompanySpecificMode) {\r\n        console.log('Error en modo espec√≠fico, manteniendo la p√°gina abierta')\r\n        return\r\n      }\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\r\n      {/* Header */}\r\n      <div className=\"mb-8\">\r\n        <button\r\n          onClick={onCancel}\r\n          className=\"inline-flex items-center text-blue-600 hover:text-blue-800 mb-4\"\r\n        >\r\n          <ArrowLeftIcon className=\"h-5 w-5 mr-2\" />\r\n          Volver\r\n        </button>\r\n\r\n        <div className=\"flex items-center\">\r\n          <div className=\"p-3 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 shadow-lg mr-4\">\r\n            <BuildingOfficeIcon className=\"h-8 w-8 text-white\" />\r\n          </div>\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold text-gray-900\">\r\n              {isCompanySpecificMode ? 'Configuraci√≥n de Empresa' : (company ? 'Editar Empresa' : 'Nueva Empresa')}\r\n            </h1>\r\n            <p className=\"text-gray-600\">\r\n              {isCompanySpecificMode\r\n                ? 'Configura las credenciales y canales de comunicaci√≥n espec√≠ficos para esta empresa'\r\n                : (company ? 'Modifica los datos de la empresa' : 'Crea una nueva empresa con sus empleados')\r\n              }\r\n            </p>\r\n            {isCompanySpecificMode && (\r\n              <div className=\"mt-2 p-2 bg-blue-50 border border-blue-200 rounded-lg\">\r\n                <p className=\"text-sm text-blue-800\">\r\n                  <strong>URL espec√≠fica:</strong> {window.location.pathname}\r\n                </p>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <form onSubmit={handleSubmit} className=\"space-y-8\">\r\n        {/* Informaci√≥n de la Empresa */}\r\n        <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n          <h2 className=\"text-xl font-semibold text-gray-900 mb-6 flex items-center\">\r\n            <BuildingOfficeIcon className=\"h-6 w-6 mr-3 text-blue-600\" />\r\n            Informaci√≥n de la Empresa\r\n            {isCompanySpecificMode && (\r\n              <span className=\"ml-3 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full\">\r\n                Modo espec√≠fico\r\n              </span>\r\n            )}\r\n          </h2>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                Nombre de la Empresa *\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                value={formData.name}\r\n                onChange={(e) => handleInputChange('name', e.target.value)}\r\n                className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors\"\r\n                placeholder=\"Ej: Empresa XYZ\"\r\n                required\r\n                disabled={isCompanySpecificMode}\r\n              />\r\n              {isCompanySpecificMode && (\r\n                <p className=\"text-xs text-gray-500 mt-1\">El nombre no se puede editar en modo espec√≠fico</p>\r\n              )}\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                Estado\r\n              </label>\r\n              <div className=\"flex items-center space-x-4\">\r\n                <label className=\"flex items-center\">\r\n                  <input\r\n                    type=\"radio\"\r\n                    name=\"status\"\r\n                    checked={formData.status === 'active'}\r\n                    onChange={() => handleInputChange('status', 'active')}\r\n                    className=\"text-blue-600 focus:ring-blue-500\"\r\n                    disabled={isCompanySpecificMode}\r\n                  />\r\n                  <span className=\"ml-2 text-sm text-gray-700\">Activa</span>\r\n                </label>\r\n                <label className=\"flex items-center\">\r\n                  <input\r\n                    type=\"radio\"\r\n                    name=\"status\"\r\n                    checked={formData.status === 'inactive'}\r\n                    onChange={() => handleInputChange('status', 'inactive')}\r\n                    className=\"text-blue-600 focus:ring-blue-500\"\r\n                    disabled={isCompanySpecificMode}\r\n                  />\r\n                  <span className=\"ml-2 text-sm text-gray-700\">Inactiva</span>\r\n                </label>\r\n              </div>\r\n              {isCompanySpecificMode && (\r\n                <p className=\"text-xs text-gray-500 mt-1\">El estado no se puede editar en modo espec√≠fico</p>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-6\">\r\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n              Descripci√≥n\r\n            </label>\r\n            <textarea\r\n              value={formData.description}\r\n              onChange={(e) => handleInputChange('description', e.target.value)}\r\n              rows={3}\r\n              className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors\"\r\n              placeholder=\"Descripci√≥n opcional de la empresa\"\r\n              disabled={isCompanySpecificMode}\r\n            />\r\n            {isCompanySpecificMode && (\r\n              <p className=\"text-xs text-gray-500 mt-1\">La descripci√≥n no se puede editar en modo espec√≠fico</p>\r\n            )}\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 mt-6\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-2 flex items-center\">\r\n                <ChatBubbleLeftRightIcon className=\"h-4 w-4 mr-2\" />\r\n                Bot de Telegram\r\n              </label>\r\n              <input\r\n                type=\"url\"\r\n                value={formData.telegram_bot}\r\n                onChange={(e) => handleInputChange('telegram_bot', e.target.value)}\r\n                className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors\"\r\n                placeholder=\"https://t.me/tu_bot\"\r\n                disabled={isCompanySpecificMode}\r\n              />\r\n              {isCompanySpecificMode && (\r\n                <p className=\"text-xs text-gray-500 mt-1\">El bot de Telegram no se puede editar en modo espec√≠fico</p>\r\n              )}\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-2 flex items-center\">\r\n                <PhoneIcon className=\"h-4 w-4 mr-2\" />\r\n                N√∫mero de WhatsApp\r\n              </label>\r\n              <input\r\n                type=\"tel\"\r\n                value={formData.whatsapp_number}\r\n                onChange={(e) => handleInputChange('whatsapp_number', e.target.value)}\r\n                className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors\"\r\n                placeholder=\"+56912345678\"\r\n                disabled={isCompanySpecificMode}\r\n              />\r\n              {isCompanySpecificMode && (\r\n                <p className=\"text-xs text-gray-500 mt-1\">El n√∫mero de WhatsApp no se puede editar en modo espec√≠fico</p>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Configuraci√≥n de Fallback */}\r\n        <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n          <div className=\"flex items-center justify-between mb-6\">\r\n            <h2 className=\"text-xl font-semibold text-gray-900 flex items-center\">\r\n              <ArrowsUpDownIcon className=\"h-6 w-6 mr-3 text-purple-600\" />\r\n              üîÑ Orden de Fallback de Comunicaci√≥n\r\n            </h2>\r\n            <button\r\n              type=\"button\"\r\n              onClick={resetFallbackOrder}\r\n              className=\"inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-colors\"\r\n            >\r\n              Restablecer por defecto\r\n            </button>\r\n          </div>\r\n\r\n          <p className=\"text-gray-600 mb-6\">\r\n            Arrastra y reordena los canales de comunicaci√≥n para definir el orden en que se usar√°n como fallback cuando un canal falle.\r\n          </p>\r\n\r\n          <div className=\"space-y-3\">\r\n            {fallbackOrder.map((channel, index) => (\r\n              <div\r\n                key={channel}\r\n                className=\"flex items-center justify-between p-4 bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-xl\"\r\n              >\r\n                <div className=\"flex items-center space-x-3\">\r\n                  <div className=\"flex items-center justify-center w-8 h-8 bg-purple-600 text-white rounded-full font-semibold text-sm\">\r\n                    {index + 1}\r\n                  </div>\r\n                  <span className=\"font-medium text-gray-900\">{channel}</span>\r\n                </div>\r\n                \r\n                <div className=\"flex items-center space-x-2\">\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => moveChannelUp(index)}\r\n                    disabled={index === 0}\r\n                    className=\"p-2 text-gray-600 hover:bg-purple-100 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    title=\"Subir\"\r\n                  >\r\n                    <ArrowUpIcon className=\"h-4 w-4\" />\r\n                  </button>\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => moveChannelDown(index)}\r\n                    disabled={index === fallbackOrder.length - 1}\r\n                    className=\"p-2 text-gray-600 hover:bg-purple-100 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    title=\"Bajar\"\r\n                  >\r\n                    <ArrowDownIcon className=\"h-4 w-4\" />\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n\r\n          <div className=\"mt-4 p-4 bg-blue-50 border border-blue-200 rounded-xl\">\r\n            <p className=\"text-sm text-blue-800\">\r\n              <strong>Nota:</strong> Este orden se usar√° autom√°ticamente cuando un canal de comunicaci√≥n falle.\r\n              El sistema intentar√° el siguiente canal en la lista hasta encontrar uno que funcione.\r\n            </p>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Configuraci√≥n de Canales de Comunicaci√≥n */}\r\n        <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n          <div className=\"flex items-center justify-between mb-6\">\r\n            <h2 className=\"text-xl font-semibold text-gray-900 flex items-center\">\r\n              <Cog6ToothIcon className=\"h-6 w-6 mr-3 text-indigo-600\" />\r\n              üîß Configuraci√≥n de Canales de Comunicaci√≥n\r\n            </h2>\r\n            <div className=\"text-sm text-gray-500\">\r\n              Configura las credenciales espec√≠ficas para cada canal\r\n            </div>\r\n          </div>\r\n\r\n          <p className=\"text-gray-600 mb-6\">\r\n            Aqu√≠ puedes configurar las credenciales espec√≠ficas para cada canal de comunicaci√≥n que esta empresa utilizar√°.\r\n            Estas configuraciones sobrescribir√°n las configuraciones globales cuando se env√≠en mensajes para esta empresa.\r\n          </p>\r\n\r\n          {/* Pesta√±as de Canales - Redise√±adas en Grupos */}\r\n          <div className=\"mb-6\">\r\n            {/* Canales de Comunicaci√≥n Principales */}\r\n            <div className=\"mb-4\">\r\n              <h4 className=\"text-sm font-medium text-gray-500 mb-3\">üì± Canales de Comunicaci√≥n</h4>\r\n              <div className=\"grid grid-cols-2 md:grid-cols-4 gap-2\">\r\n                {[\r\n                  { id: 'email', name: 'Email', icon: EnvelopeIcon, color: 'blue' },\r\n                  { id: 'sms', name: 'SMS', icon: DevicePhoneMobileIcon, color: 'green' },\r\n                  { id: 'telegram', name: 'Telegram', icon: ChatBubbleLeftIcon, color: 'blue' },\r\n                  { id: 'whatsapp', name: 'WhatsApp', icon: PhoneIcon, color: 'green' }\r\n                ].map((tab) => (\r\n                  <button\r\n                    key={tab.id}\r\n                    onClick={() => setActiveChannelTab(tab.id)}\r\n                    className={`p-3 rounded-xl border-2 font-medium text-sm flex flex-col items-center justify-center space-y-2 transition-all duration-200 ${\r\n                      activeChannelTab === tab.id\r\n                        ? `border-${tab.color}-500 bg-${tab.color}-50 text-${tab.color}-700 shadow-lg`\r\n                        : 'border-gray-200 bg-white text-gray-600 hover:border-gray-300 hover:bg-gray-50'\r\n                    }`}\r\n                  >\r\n                    <tab.icon className={`h-6 w-6 ${activeChannelTab === tab.id ? `text-${tab.color}-600` : 'text-gray-400'}`} />\r\n                    <span className=\"text-xs font-medium\">{tab.name}</span>\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Inteligencia Artificial */}\r\n            <div className=\"mb-4\">\r\n              <h4 className=\"text-sm font-medium text-gray-500 mb-3\">ü§ñ Inteligencia Artificial</h4>\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2\">\r\n                {[\r\n                  { id: 'groq', name: 'Groq AI', icon: Cog6ToothIcon, color: 'purple' }\r\n                ].map((tab) => (\r\n                  <button\r\n                    key={tab.id}\r\n                    onClick={() => setActiveChannelTab(tab.id)}\r\n                    className={`p-3 rounded-xl border-2 font-medium text-sm flex flex-col items-center justify-center space-y-2 transition-all duration-200 ${\r\n                      activeChannelTab === tab.id\r\n                        ? `border-${tab.color}-500 bg-${tab.color}-50 text-${tab.color}-700 shadow-lg`\r\n                        : 'border-gray-200 bg-white text-gray-600 hover:border-gray-300 hover:bg-gray-50'\r\n                    }`}\r\n                  >\r\n                    <tab.icon className={`h-6 w-6 ${activeChannelTab === tab.id ? `text-${tab.color}-600` : 'text-gray-400'}`} />\r\n                    <span className=\"text-xs font-medium\">{tab.name}</span>\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Productividad y Colaboraci√≥n */}\r\n            <div className=\"mb-4\">\r\n              <h4 className=\"text-sm font-medium text-gray-500 mb-3\">üíº Productividad y Colaboraci√≥n</h4>\r\n              <div className=\"grid grid-cols-2 md:grid-cols-4 gap-2\">\r\n                {[\r\n                  { id: 'google', name: 'Google', icon: GlobeAltIcon, color: 'red' },\r\n                  { id: 'microsoft', name: 'Microsoft', icon: ComputerDesktopIcon, color: 'blue' },\r\n                  { id: 'slack', name: 'Slack', icon: ChatBubbleLeftRightIcon, color: 'purple' },\r\n                  { id: 'teams', name: 'Teams', icon: BriefcaseIcon, color: 'purple' }\r\n                ].map((tab) => (\r\n                  <button\r\n                    key={tab.id}\r\n                    onClick={() => setActiveChannelTab(tab.id)}\r\n                    className={`p-3 rounded-xl border-2 font-medium text-sm flex flex-col items-center justify-center space-y-2 transition-all duration-200 ${\r\n                      activeChannelTab === tab.id\r\n                        ? `border-${tab.color}-500 bg-${tab.color}-50 text-${tab.color}-700 shadow-lg`\r\n                        : 'border-gray-200 bg-white text-gray-600 hover:border-gray-300 hover:bg-gray-50'\r\n                    }`}\r\n                  >\r\n                    <tab.icon className={`h-6 w-6 ${activeChannelTab === tab.id ? `text-${tab.color}-600` : 'text-gray-400'}`} />\r\n                    <span className=\"text-xs font-medium\">{tab.name}</span>\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            </div>\r\n\r\n            {/* CRM y Ventas */}\r\n            <div>\r\n              <h4 className=\"text-sm font-medium text-gray-500 mb-3\">üéØ CRM y Ventas</h4>\r\n              <div className=\"grid grid-cols-2 md:grid-cols-2 gap-2\">\r\n                {[\r\n                  { id: 'hubspot', name: 'HubSpot', icon: CubeIcon, color: 'orange' },\r\n                  { id: 'salesforce', name: 'Salesforce', icon: BriefcaseIcon, color: 'blue' }\r\n                ].map((tab) => (\r\n                  <button\r\n                    key={tab.id}\r\n                    onClick={() => setActiveChannelTab(tab.id)}\r\n                    className={`p-3 rounded-xl border-2 font-medium text-sm flex flex-col items-center justify-center space-y-2 transition-all duration-200 ${\r\n                      activeChannelTab === tab.id\r\n                        ? `border-${tab.color}-500 bg-${tab.color}-50 text-${tab.color}-700 shadow-lg`\r\n                        : 'border-gray-200 bg-white text-gray-600 hover:border-gray-300 hover:bg-gray-50'\r\n                    }`}\r\n                  >\r\n                    <tab.icon className={`h-6 w-6 ${activeChannelTab === tab.id ? `text-${tab.color}-600` : 'text-gray-400'}`} />\r\n                    <span className=\"text-xs font-medium\">{tab.name}</span>\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Contenido de las Pesta√±as */}\r\n          <div className=\"space-y-6\">\r\n            {/* Email Configuration */}\r\n            {activeChannelTab === 'email' && (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <h3 className=\"text-lg font-medium text-gray-900 flex items-center\">\r\n                    <EnvelopeIcon className=\"h-5 w-5 mr-2 text-blue-600\" />\r\n                    Configuraci√≥n de Email\r\n                  </h3>\r\n                  <label className=\"flex items-center\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      checked={formData.email_enabled}\r\n                      onChange={(e) => handleChannelChange('email_enabled', e.target.checked)}\r\n                      className=\"text-blue-600 focus:ring-blue-500 rounded\"\r\n                    />\r\n                    <span className=\"ml-2 text-sm text-gray-700\">Habilitar Email</span>\r\n                  </label>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Nombre del Remitente\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={formData.email_sender_name}\r\n                      onChange={(e) => handleChannelChange('email_sender_name', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"Empresa XYZ\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Email del Remitente\r\n                    </label>\r\n                    <input\r\n                      type=\"email\"\r\n                      value={formData.email_sender_email}\r\n                      onChange={(e) => handleChannelChange('email_sender_email', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"noreply@empresa.cl\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div className=\"md:col-span-2\">\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Email de Respuesta\r\n                    </label>\r\n                    <input\r\n                      type=\"email\"\r\n                      value={formData.email_reply_to}\r\n                      onChange={(e) => handleChannelChange('email_reply_to', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"soporte@empresa.cl\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"p-4 bg-blue-50 border border-blue-200 rounded-xl\">\r\n                  <p className=\"text-sm text-blue-800\">\r\n                    <strong>Nota:</strong> La configuraci√≥n de SMTP se gestiona desde la p√°gina de\r\n                    <a href=\"/configuracion/integraciones\" className=\"text-blue-600 underline ml-1\">Integraciones</a>.\r\n                    Aqu√≠ solo configuras los datos espec√≠ficos de esta empresa.\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* SMS Configuration */}\r\n            {activeChannelTab === 'sms' && (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <h3 className=\"text-lg font-medium text-gray-900 flex items-center\">\r\n                    <DevicePhoneMobileIcon className=\"h-5 w-5 mr-2 text-green-600\" />\r\n                    Configuraci√≥n de SMS\r\n                  </h3>\r\n                  <label className=\"flex items-center\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      checked={formData.sms_enabled}\r\n                      onChange={(e) => handleChannelChange('sms_enabled', e.target.checked)}\r\n                      className=\"text-green-600 focus:ring-green-500 rounded\"\r\n                    />\r\n                    <span className=\"ml-2 text-sm text-gray-700\">Habilitar SMS</span>\r\n                  </label>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Nombre del Remitente SMS\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={formData.sms_sender_name}\r\n                      onChange={(e) => handleChannelChange('sms_sender_name', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"EmpresaXYZ\"\r\n                      maxLength={11}\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      N√∫mero de Remitente\r\n                    </label>\r\n                    <input\r\n                      type=\"tel\"\r\n                      value={formData.sms_sender_phone}\r\n                      onChange={(e) => handleChannelChange('sms_sender_phone', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"+56912345678\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"p-4 bg-green-50 border border-green-200 rounded-xl\">\r\n                  <p className=\"text-sm text-green-800\">\r\n                    <strong>Nota:</strong> La configuraci√≥n del proveedor de SMS (Brevo) se gestiona desde\r\n                    <a href=\"/configuracion/integraciones\" className=\"text-green-600 underline ml-1\">Integraciones</a>.\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Telegram Configuration */}\r\n            {activeChannelTab === 'telegram' && (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <h3 className=\"text-lg font-medium text-gray-900 flex items-center\">\r\n                    <ChatBubbleLeftIcon className=\"h-5 w-5 mr-2 text-blue-500\" />\r\n                    Configuraci√≥n de Telegram\r\n                  </h3>\r\n                  <label className=\"flex items-center\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      checked={formData.telegram_enabled}\r\n                      onChange={(e) => handleChannelChange('telegram_enabled', e.target.checked)}\r\n                      className=\"text-blue-600 focus:ring-blue-500 rounded\"\r\n                    />\r\n                    <span className=\"ml-2 text-sm text-gray-700\">Habilitar Telegram</span>\r\n                  </label>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Token del Bot\r\n                    </label>\r\n                    <input\r\n                      type=\"password\"\r\n                      value={formData.telegram_bot_token}\r\n                      onChange={(e) => handleChannelChange('telegram_bot_token', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Nombre de Usuario del Bot\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={formData.telegram_bot_username}\r\n                      onChange={(e) => handleChannelChange('telegram_bot_username', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"@mi_bot_empresa\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div className=\"md:col-span-2\">\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      URL de Webhook\r\n                    </label>\r\n                    <input\r\n                      type=\"url\"\r\n                      value={formData.telegram_webhook_url}\r\n                      onChange={(e) => handleChannelChange('telegram_webhook_url', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"https://tu-sitio.com/api/telegram/webhook\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* WhatsApp Configuration */}\r\n            {activeChannelTab === 'whatsapp' && (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <h3 className=\"text-lg font-medium text-gray-900 flex items-center\">\r\n                    <PhoneIcon className=\"h-5 w-5 mr-2 text-green-600\" />\r\n                    Configuraci√≥n de WhatsApp\r\n                  </h3>\r\n                  <label className=\"flex items-center\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      checked={formData.whatsapp_enabled}\r\n                      onChange={(e) => handleChannelChange('whatsapp_enabled', e.target.checked)}\r\n                      className=\"text-green-600 focus:ring-green-500 rounded\"\r\n                    />\r\n                    <span className=\"ml-2 text-sm text-gray-700\">Habilitar WhatsApp</span>\r\n                  </label>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Access Token\r\n                    </label>\r\n                    <input\r\n                      type=\"password\"\r\n                      value={formData.whatsapp_access_token}\r\n                      onChange={(e) => handleChannelChange('whatsapp_access_token', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"EAAKZC...\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Phone Number ID\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={formData.whatsapp_phone_number_id}\r\n                      onChange={(e) => handleChannelChange('whatsapp_phone_number_id', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"123456789012345\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div className=\"md:col-span-2\">\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Webhook Verify Token\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={formData.whatsapp_webhook_verify_token}\r\n                      onChange={(e) => handleChannelChange('whatsapp_webhook_verify_token', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"token_secreto_verificacion\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Groq AI Configuration */}\r\n            {activeChannelTab === 'groq' && (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <h3 className=\"text-lg font-medium text-gray-900 flex items-center\">\r\n                    <Cog6ToothIcon className=\"h-5 w-5 mr-2 text-purple-600\" />\r\n                    Configuraci√≥n de Groq AI\r\n                  </h3>\r\n                  <label className=\"flex items-center\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      checked={formData.groq_enabled}\r\n                      onChange={(e) => handleChannelChange('groq_enabled', e.target.checked)}\r\n                      className=\"text-purple-600 focus:ring-purple-500 rounded\"\r\n                    />\r\n                    <span className=\"ml-2 text-sm text-gray-700\">Habilitar Groq AI</span>\r\n                  </label>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      API Key\r\n                    </label>\r\n                    <input\r\n                      type=\"password\"\r\n                      value={formData.groq_api_key}\r\n                      onChange={(e) => handleChannelChange('groq_api_key', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"gsk_...\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Modelo\r\n                    </label>\r\n                    <select\r\n                      value={formData.groq_model}\r\n                      onChange={(e) => handleChannelChange('groq_model', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors\"\r\n                    >\r\n                      <option value=\"gemma2-9b-it\">Gemma 2 9B IT</option>\r\n                      <option value=\"llama3-8b-8192\">Llama 3 8B 8192</option>\r\n                      <option value=\"llama3-70b-8192\">Llama 3 70B 8192</option>\r\n                      <option value=\"mixtral-8x7b-32768\">Mixtral 8x7B 32768</option>\r\n                    </select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Temperatura\r\n                    </label>\r\n                    <input\r\n                      type=\"number\"\r\n                      min=\"0\"\r\n                      max=\"2\"\r\n                      step=\"0.1\"\r\n                      value={formData.groq_temperature}\r\n                      onChange={(e) => handleChannelChange('groq_temperature', parseFloat(e.target.value))}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Max Tokens\r\n                    </label>\r\n                    <input\r\n                      type=\"number\"\r\n                      min=\"1\"\r\n                      max=\"8000\"\r\n                      value={formData.groq_max_tokens}\r\n                      onChange={(e) => handleChannelChange('groq_max_tokens', parseInt(e.target.value))}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Google Workspace Configuration */}\r\n            {activeChannelTab === 'google' && (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <h3 className=\"text-lg font-medium text-gray-900 flex items-center\">\r\n                    <GlobeAltIcon className=\"h-5 w-5 mr-2 text-red-600\" />\r\n                    Configuraci√≥n de Google Workspace\r\n                  </h3>\r\n                  <label className=\"flex items-center\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      checked={formData.google_enabled}\r\n                      onChange={(e) => handleChannelChange('google_enabled', e.target.checked)}\r\n                      className=\"text-red-600 focus:ring-red-500 rounded\"\r\n                    />\r\n                    <span className=\"ml-2 text-sm text-gray-700\">Habilitar Google</span>\r\n                  </label>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      API Key\r\n                    </label>\r\n                    <input\r\n                      type=\"password\"\r\n                      value={formData.google_api_key}\r\n                      onChange={(e) => handleChannelChange('google_api_key', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"AIza...\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Client ID\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={formData.google_client_id}\r\n                      onChange={(e) => handleChannelChange('google_client_id', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"123456789-abc123.apps.googleusercontent.com\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div className=\"md:col-span-2\">\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Client Secret\r\n                    </label>\r\n                    <input\r\n                      type=\"password\"\r\n                      value={formData.google_client_secret}\r\n                      onChange={(e) => handleChannelChange('google_client_secret', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"GOCSPX-...\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Microsoft 365 Configuration */}\r\n            {activeChannelTab === 'microsoft' && (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <h3 className=\"text-lg font-medium text-gray-900 flex items-center\">\r\n                    <ComputerDesktopIcon className=\"h-5 w-5 mr-2 text-blue-700\" />\r\n                    Configuraci√≥n de Microsoft 365\r\n                  </h3>\r\n                  <label className=\"flex items-center\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      checked={formData.microsoft_enabled}\r\n                      onChange={(e) => handleChannelChange('microsoft_enabled', e.target.checked)}\r\n                      className=\"text-blue-700 focus:ring-blue-500 rounded\"\r\n                    />\r\n                    <span className=\"ml-2 text-sm text-gray-700\">Habilitar Microsoft</span>\r\n                  </label>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Client ID\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={formData.microsoft_client_id}\r\n                      onChange={(e) => handleChannelChange('microsoft_client_id', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-700 focus:border-transparent transition-colors\"\r\n                      placeholder=\"12345678-1234-1234-1234-123456789012\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Tenant ID\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={formData.microsoft_tenant_id}\r\n                      onChange={(e) => handleChannelChange('microsoft_tenant_id', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-700 focus:border-transparent transition-colors\"\r\n                      placeholder=\"12345678-1234-1234-1234-123456789012\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div className=\"md:col-span-2\">\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Client Secret\r\n                    </label>\r\n                    <input\r\n                      type=\"password\"\r\n                      value={formData.microsoft_client_secret}\r\n                      onChange={(e) => handleChannelChange('microsoft_client_secret', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-700 focus:border-transparent transition-colors\"\r\n                      placeholder=\"~secret...\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Slack Configuration */}\r\n            {activeChannelTab === 'slack' && (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <h3 className=\"text-lg font-medium text-gray-900 flex items-center\">\r\n                    <ChatBubbleLeftRightIcon className=\"h-5 w-5 mr-2 text-purple-700\" />\r\n                    Configuraci√≥n de Slack\r\n                  </h3>\r\n                  <label className=\"flex items-center\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      checked={formData.slack_enabled}\r\n                      onChange={(e) => handleChannelChange('slack_enabled', e.target.checked)}\r\n                      className=\"text-purple-700 focus:ring-purple-500 rounded\"\r\n                    />\r\n                    <span className=\"ml-2 text-sm text-gray-700\">Habilitar Slack</span>\r\n                  </label>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Bot Token\r\n                    </label>\r\n                    <input\r\n                      type=\"password\"\r\n                      value={formData.slack_bot_token}\r\n                      onChange={(e) => handleChannelChange('slack_bot_token', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-700 focus:border-transparent transition-colors\"\r\n                      placeholder=\"xoxb-...\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Signing Secret\r\n                    </label>\r\n                    <input\r\n                      type=\"password\"\r\n                      value={formData.slack_signing_secret}\r\n                      onChange={(e) => handleChannelChange('slack_signing_secret', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-700 focus:border-transparent transition-colors\"\r\n                      placeholder=\"a1b2c3d4...\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div className=\"md:col-span-2\">\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Canal por Defecto\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={formData.slack_default_channel}\r\n                      onChange={(e) => handleChannelChange('slack_default_channel', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-700 focus:border-transparent transition-colors\"\r\n                      placeholder=\"#general\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Teams Configuration */}\r\n            {activeChannelTab === 'teams' && (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <h3 className=\"text-lg font-medium text-gray-900 flex items-center\">\r\n                    <BriefcaseIcon className=\"h-5 w-5 mr-3 text-purple-600\" />\r\n                    Configuraci√≥n de Microsoft Teams\r\n                  </h3>\r\n                  <label className=\"flex items-center\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      checked={formData.teams_enabled}\r\n                      onChange={(e) => handleChannelChange('teams_enabled', e.target.checked)}\r\n                      className=\"text-purple-600 focus:ring-purple-500 rounded\"\r\n                    />\r\n                    <span className=\"ml-2 text-sm text-gray-700\">Habilitar Teams</span>\r\n                  </label>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      App ID\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={formData.teams_app_id}\r\n                      onChange={(e) => handleChannelChange('teams_app_id', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-600 focus:border-transparent transition-colors\"\r\n                      placeholder=\"12345678-1234-1234-1234-123456789012\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Tenant ID\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={formData.teams_tenant_id}\r\n                      onChange={(e) => handleChannelChange('teams_tenant_id', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-600 focus:border-transparent transition-colors\"\r\n                      placeholder=\"12345678-1234-1234-1234-123456789012\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div className=\"md:col-span-2\">\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Client Secret\r\n                    </label>\r\n                    <input\r\n                      type=\"password\"\r\n                      value={formData.teams_client_secret}\r\n                      onChange={(e) => handleChannelChange('teams_client_secret', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-600 focus:border-transparent transition-colors\"\r\n                      placeholder=\"~secret...\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* HubSpot Configuration */}\r\n            {activeChannelTab === 'hubspot' && (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <h3 className=\"text-lg font-medium text-gray-900 flex items-center\">\r\n                    <CubeIcon className=\"h-5 w-5 mr-3 text-orange-600\" />\r\n                    Configuraci√≥n de HubSpot\r\n                  </h3>\r\n                  <label className=\"flex items-center\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      checked={formData.hubspot_enabled}\r\n                      onChange={(e) => handleChannelChange('hubspot_enabled', e.target.checked)}\r\n                      className=\"text-orange-600 focus:ring-orange-500 rounded\"\r\n                    />\r\n                    <span className=\"ml-2 text-sm text-gray-700\">Habilitar HubSpot</span>\r\n                  </label>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      API Key\r\n                    </label>\r\n                    <input\r\n                      type=\"password\"\r\n                      value={formData.hubspot_api_key}\r\n                      onChange={(e) => handleChannelChange('hubspot_api_key', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-600 focus:border-transparent transition-colors\"\r\n                      placeholder=\"pat_eu1_...\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Portal ID\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={formData.hubspot_portal_id}\r\n                      onChange={(e) => handleChannelChange('hubspot_portal_id', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-600 focus:border-transparent transition-colors\"\r\n                      placeholder=\"1234567\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Salesforce Configuration */}\r\n            {activeChannelTab === 'salesforce' && (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <h3 className=\"text-lg font-medium text-gray-900 flex items-center\">\r\n                    <BriefcaseIcon className=\"h-5 w-5 mr-3 text-blue-800\" />\r\n                    Configuraci√≥n de Salesforce\r\n                  </h3>\r\n                  <label className=\"flex items-center\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      checked={formData.salesforce_enabled}\r\n                      onChange={(e) => handleChannelChange('salesforce_enabled', e.target.checked)}\r\n                      className=\"text-blue-800 focus:ring-blue-500 rounded\"\r\n                    />\r\n                    <span className=\"ml-2 text-sm text-gray-700\">Habilitar Salesforce</span>\r\n                  </label>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Consumer Key\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={formData.salesforce_consumer_key}\r\n                      onChange={(e) => handleChannelChange('salesforce_consumer_key', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-800 focus:border-transparent transition-colors\"\r\n                      placeholder=\"3MVG9...\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Consumer Secret\r\n                    </label>\r\n                    <input\r\n                      type=\"password\"\r\n                      value={formData.salesforce_consumer_secret}\r\n                      onChange={(e) => handleChannelChange('salesforce_consumer_secret', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-800 focus:border-transparent transition-colors\"\r\n                      placeholder=\"1234567890ABCDEF...\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Username\r\n                    </label>\r\n                    <input\r\n                      type=\"email\"\r\n                      value={formData.salesforce_username}\r\n                      onChange={(e) => handleChannelChange('salesforce_username', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-800 focus:border-transparent transition-colors\"\r\n                      placeholder=\"usuario@empresa.com\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Password\r\n                    </label>\r\n                    <input\r\n                      type=\"password\"\r\n                      value={formData.salesforce_password}\r\n                      onChange={(e) => handleChannelChange('salesforce_password', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-800 focus:border-transparent transition-colors\"\r\n                      placeholder=\"contrase√±a123\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Empleados - Solo mostrar si no est√° en modo espec√≠fico */}\r\n        {!isCompanySpecificMode && (\r\n          <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n            <div className=\"flex items-center justify-between mb-6\">\r\n              <h2 className=\"text-xl font-semibold text-gray-900 flex items-center\">\r\n                <UserGroupIcon className=\"h-6 w-6 mr-3 text-green-600\" />\r\n                Empleados ({employees.length})\r\n              </h2>\r\n              <button\r\n                type=\"button\"\r\n                onClick={addEmployee}\r\n                className=\"inline-flex items-center px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5\"\r\n              >\r\n                <PlusIcon className=\"h-4 w-4 mr-2\" />\r\n                Agregar Empleado\r\n              </button>\r\n            </div>\r\n\r\n          <div className=\"space-y-4\">\r\n            {currentEmployees.map((employee, index) => (\r\n              <div key={employee.id} className=\"border border-gray-200 rounded-xl p-4 bg-gray-50\">\r\n                <div className=\"flex items-center justify-between mb-4\">\r\n                  <h3 className=\"text-lg font-medium text-gray-900\">\r\n                    Empleado {index + 1}\r\n                  </h3>\r\n                  {employees.length > 1 && (\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => removeEmployee(index)}\r\n                      className=\"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors\"\r\n                      title=\"Eliminar empleado\"\r\n                    >\r\n                      <TrashIcon className=\"h-4 w-4\" />\r\n                    </button>\r\n                  )}\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Nombre Completo *\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={employee.name}\r\n                      onChange={(e) => updateEmployee(index, 'name', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"Juan P√©rez Gonz√°lez\"\r\n                      required\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Email *\r\n                    </label>\r\n                    <input\r\n                      type=\"email\"\r\n                      value={employee.email}\r\n                      onChange={(e) => updateEmployee(index, 'email', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"juan.perez@empresa.cl\"\r\n                      required\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Tel√©fono\r\n                    </label>\r\n                    <input\r\n                      type=\"tel\"\r\n                      value={employee.phone}\r\n                      onChange={(e) => updateEmployee(index, 'phone', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"+56912345678\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Departamento\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={employee.department}\r\n                      onChange={(e) => updateEmployee(index, 'department', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"Operaciones\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div className=\"md:col-span-2\">\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                      Cargo\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      value={employee.position}\r\n                      onChange={(e) => updateEmployee(index, 'position', e.target.value)}\r\n                      className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors\"\r\n                      placeholder=\"Jefe de Operaciones\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n\r\n          {/* Paginaci√≥n */}\r\n          {totalPages > 1 && (\r\n            <div className=\"flex items-center justify-between mt-6 pt-4 border-t border-gray-200\">\r\n              <div className=\"text-sm text-gray-600\">\r\n                Mostrando {indexOfFirstEmployee + 1}-{Math.min(indexOfLastEmployee, employees.length)} de {employees.length} empleados\r\n              </div>\r\n              <div className=\"flex items-center space-x-2\">\r\n                <button\r\n                  onClick={prevPage}\r\n                  disabled={currentPage === 1}\r\n                  className=\"px-3 py-1 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  Anterior\r\n                </button>\r\n\r\n                {/* N√∫meros de p√°gina */}\r\n                {Array.from({ length: totalPages }, (_, i) => i + 1).map(number => (\r\n                  <button\r\n                    key={number}\r\n                    onClick={() => paginate(number)}\r\n                    className={`px-3 py-1 text-sm border rounded-md ${\r\n                      currentPage === number\r\n                        ? 'bg-blue-500 text-white border-blue-500'\r\n                        : 'border-gray-300 hover:bg-gray-50'\r\n                    }`}\r\n                  >\r\n                    {number}\r\n                  </button>\r\n                ))}\r\n\r\n                <button\r\n                  onClick={nextPage}\r\n                  disabled={currentPage === totalPages}\r\n                  className=\"px-3 py-1 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  Siguiente\r\n                </button>\r\n              </div>\r\n            </div>\r\n          )}\r\n          </div>\r\n        )}\r\n\r\n        {/* Actions */}\r\n        <div className=\"flex justify-end space-x-4\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={onCancel}\r\n            className=\"px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-colors\"\r\n          >\r\n            Cancelar\r\n          </button>\r\n          <button\r\n            type=\"submit\"\r\n            disabled={loading}\r\n            className=\"inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n          >\r\n            <CheckIcon className=\"h-5 w-5 mr-2\" />\r\n            {loading ? 'Guardando...' : (isCompanySpecificMode ? 'Guardar Configuraci√≥n' : (company ? 'Actualizar Empresa' : 'Crear Empresa'))}\r\n          </button>\r\n        </div>\r\n      </form>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default CompanyForm","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\settings\\DatabaseSettings.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\settings\\Settings.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadCompanies'. Either include it or remove the dependency array.","line":180,"column":6,"nodeType":"ArrayExpression","endLine":180,"endColumn":58,"suggestions":[{"desc":"Update the dependencies array to be: [propCompanyId, location.pathname, companies.length, loadCompanies]","fix":{"range":[6982,7034],"text":"[propCompanyId, location.pathname, companies.length, loadCompanies]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'showWhatsAppConfig' is assigned a value but never used.","line":1928,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":1928,"endColumn":27}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'checkBrevoConfiguration', 'checkGoogleDriveConnection', 'checkGroqConfiguration', 'checkTelegramConfiguration', 'checkWhatsAppConfiguration', 'checkWhatsAppOfficialConfiguration', 'checkWhatsAppWahaConfiguration', 'loadActiveSessions', 'loadBackupSettings', 'loadCompanies', 'loadHierarchyMode', 'loadNotificationSettings', 'loadSecurityLogs', and 'loadSecuritySettings'. Either include them or remove the dependency array.","line":225,"column":6,"nodeType":"ArrayExpression","endLine":225,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [checkBrevoConfiguration, checkGoogleDriveConnection, checkGroqConfiguration, checkTelegramConfiguration, checkWhatsAppConfiguration, checkWhatsAppOfficialConfiguration, checkWhatsAppWahaConfiguration, loadActiveSessions, loadBackupSettings, loadCompanies, loadHierarchyMode, loadNotificationSettings, loadSecurityLogs, loadSecuritySettings, user?.id]","fix":{"range":[8339,8349],"text":"[checkBrevoConfiguration, checkGoogleDriveConnection, checkGroqConfiguration, checkTelegramConfiguration, checkWhatsAppConfiguration, checkWhatsAppOfficialConfiguration, checkWhatsAppWahaConfiguration, loadActiveSessions, loadBackupSettings, loadCompanies, loadHierarchyMode, loadNotificationSettings, loadSecurityLogs, loadSecuritySettings, user?.id]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback } from 'react'\r\nimport { useNavigate, Link, useLocation } from 'react-router-dom'\r\nimport { useAuth } from '../../contexts/AuthContext.js'\r\nimport googleDriveService from '../../lib/unifiedGoogleDriveService.js'\r\nimport googleDrivePersistenceService from '../../services/googleDrivePersistenceService.js'\r\nimport googleDriveCallbackHandler from '../../lib/googleDriveCallbackHandler.js'\r\nimport brevoService from '../../services/brevoService.js'\r\nimport companySyncService from '../../services/companySyncService.js'\r\nimport organizedDatabaseService from '../../services/organizedDatabaseService.js'\r\nimport communicationService from '../../services/communicationService.js'\r\nimport whatsappOfficialService from '../../services/whatsappOfficialService.js'\r\nimport whatsappWahaService from '../../services/whatsappWahaService.js'\r\nimport configurationService from '../../services/configurationService.js'\r\nimport {\r\n  BuildingOfficeIcon,\r\n  UserGroupIcon,\r\n  Cog6ToothIcon,\r\n  PlusIcon,\r\n  TrashIcon,\r\n  CheckCircleIcon,\r\n  XCircleIcon,\r\n  ExclamationTriangleIcon,\r\n  PuzzlePieceIcon,\r\n  CloudIcon,\r\n  ChatBubbleLeftRightIcon,\r\n  BuildingStorefrontIcon,\r\n  ServerIcon,\r\n  XMarkIcon,\r\n  ArrowPathIcon\r\n} from '@heroicons/react/24/outline'\r\nimport toast from 'react-hot-toast'\r\nimport Swal from 'sweetalert2'\r\nimport CompanyForm from './CompanyForm.js'\r\nimport UserManagement from './UserManagement.js'\r\nimport DatabaseSettings from './DatabaseSettings.js'\r\n\r\nconst Settings = ({ activeTab: propActiveTab, companyId: propCompanyId }) => {\r\n  const { user } = useAuth()\r\n  const navigate = useNavigate()\r\n  const location = useLocation()\r\n  const [companies, setCompanies] = useState([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [showCompanyForm, setShowCompanyForm] = useState(false)\r\n  const [editingCompany, setEditingCompany] = useState(null)\r\n  const [companyId, setCompanyId] = useState(null)\r\n  \r\n  // Estado para controlar el sistema de configuraci√≥n jer√°rquico\r\n  const [hierarchyMode, setHierarchyMode] = useState('company_first') // 'global_only', 'company_first', 'both'\r\n  \r\n  // Estados de integraciones\r\n  const [integrations, setIntegrations] = useState({\r\n    google: { connected: false, status: 'disconnected', lastSync: null },\r\n    googlemeet: { connected: false, status: 'disconnected', lastSync: null },\r\n    microsoft365: { connected: false, status: 'disconnected', lastSync: null },\r\n    slack: { connected: false, status: 'disconnected', lastSync: null },\r\n    teams: { connected: false, status: 'disconnected', lastSync: null },\r\n    hubspot: { connected: false, status: 'disconnected', lastSync: null },\r\n    salesforce: { connected: false, status: 'disconnected', lastSync: null },\r\n    brevo: { connected: false, status: 'disconnected', lastSync: null },\r\n    groq: { connected: false, status: 'disconnected', lastSync: null, model: 'gemma2-9b-it' },\r\n    whatsapp: { connected: false, status: 'disconnected', lastSync: null },\r\n    whatsappOfficial: { connected: false, status: 'disconnected', lastSync: null },\r\n    whatsappWaha: { connected: false, status: 'disconnected', lastSync: null },\r\n    telegram: { connected: false, status: 'disconnected', lastSync: null }\r\n  })\r\n\r\n  const [activeTab, setActiveTab] = useState(propActiveTab || 'companies')\r\n\r\n  // Estados para configuraciones de notificaciones\r\n  const [notificationSettings, setNotificationSettings] = useState({\r\n    email: {\r\n      messagesSent: true,\r\n      systemErrors: true,\r\n      weeklyReports: false,\r\n      tokenLimits: true\r\n    },\r\n    push: {\r\n      failedMessages: true,\r\n      newContacts: false,\r\n      integrations: true,\r\n      maintenance: false\r\n    },\r\n    reports: {\r\n      frequency: 'weekly',\r\n      recipients: user?.email ? [user?.email] : [],\r\n      includeCharts: true\r\n    },\r\n    sound: {\r\n      enabled: true,\r\n      volume: 70,\r\n      silent: false\r\n    }\r\n  })\r\n\r\n  // Estados para configuraci√≥n de seguridad\r\n  const [securitySettings, setSecuritySettings] = useState({\r\n    twoFactorEnabled: false,\r\n    twoFactorMethod: 'app', // 'app', 'sms', 'email'\r\n    sessionTimeout: 30, // minutos\r\n    passwordExpiry: 90, // d√≠as\r\n    loginAttempts: 5,\r\n    lockoutDuration: 15, // minutos\r\n    ipWhitelist: [],\r\n    requireStrongPassword: true,\r\n    auditLogEnabled: true\r\n  })\r\n\r\n  // Estados para sesiones activas\r\n  const [activeSessions, setActiveSessions] = useState([])\r\n  const [securityLogs, setSecurityLogs] = useState([])\r\n  const [backupSettings, setBackupSettings] = useState({\r\n    autoBackup: true,\r\n    backupFrequency: 'weekly', // 'daily', 'weekly', 'monthly'\r\n    retentionDays: 30,\r\n    lastBackup: null,\r\n    backupSize: null\r\n  })\r\n\r\n  // Estados para el formulario de solicitud de integraci√≥n\r\n  const [showIntegrationForm, setShowIntegrationForm] = useState(false)\r\n  const [integrationForm, setIntegrationForm] = useState({\r\n    nombre: '',\r\n    apellido: '',\r\n    empresa: '',\r\n    email: '',\r\n    telefono: '',\r\n    comentarios: ''\r\n  })\r\n  const [sendingIntegrationRequest, setSendingIntegrationRequest] = useState(false)\r\n\r\n  // Estados para Google Drive\r\n  const [isGoogleDriveConnected, setIsGoogleDriveConnected] = useState(false)\r\n  const [connectingGoogleDrive, setConnectingGoogleDrive] = useState(false)\r\n\r\n  useEffect(() => {\r\n    // Sincronizar el tab activo con la prop del routing\r\n    if (propActiveTab && propActiveTab !== activeTab) {\r\n      setActiveTab(propActiveTab)\r\n    }\r\n  }, [propActiveTab, activeTab])\r\n\r\n  // Extraer companyId de la URL si estamos en modo empresa espec√≠fica\r\n  useEffect(() => {\r\n    if (propCompanyId === true) {\r\n      // Estamos en modo empresa espec√≠fica, extraer el ID de la URL\r\n      const pathParts = location.pathname.split('/')\r\n      const companyIdFromUrl = pathParts[pathParts.length - 1]\r\n      if (companyIdFromUrl && companyIdFromUrl !== 'empresas') {\r\n        setCompanyId(companyIdFromUrl)\r\n        \r\n        // Cargar la empresa espec√≠fica para editar\r\n        const loadSpecificCompany = async () => {\r\n          try {\r\n            const companiesData = await organizedDatabaseService.getCompanies()\r\n            const specificCompany = companiesData.find(c => c.id === companyIdFromUrl)\r\n            if (specificCompany) {\r\n              setEditingCompany(specificCompany)\r\n              setShowCompanyForm(true)\r\n            }\r\n          } catch (error) {\r\n            console.error('Error loading specific company:', error)\r\n            toast.error('Error al cargar la empresa especificada')\r\n          }\r\n        }\r\n        \r\n        if (companies.length === 0) {\r\n          loadCompanies().then(() => {\r\n            loadSpecificCompany()\r\n          })\r\n        } else {\r\n          loadSpecificCompany()\r\n        }\r\n      } else {\r\n        // Resetear estados si no hay companyId v√°lido\r\n        setCompanyId(null)\r\n        setEditingCompany(null)\r\n        setShowCompanyForm(false)\r\n      }\r\n    }\r\n  }, [propCompanyId, location.pathname, companies.length])\r\n\r\n  useEffect(() => {\r\n    // Evitar ejecuci√≥n m√∫ltiple si no hay usuario\r\n    if (!user?.id) return\r\n    \r\n    // Usar un flag para evitar ejecuciones duplicadas\r\n    let isMounted = true\r\n    \r\n    const loadData = async () => {\r\n      try {\r\n        // Cargar datos de forma secuencial para evitar parpadeo\r\n        await loadCompanies()\r\n        \r\n        if (!isMounted) return\r\n        \r\n        // Cargar configuraciones locales en paralelo (no causan re-renders significativos)\r\n        await Promise.all([\r\n          loadNotificationSettings(),\r\n          loadSecuritySettings(),\r\n          loadActiveSessions(),\r\n          loadSecurityLogs(),\r\n          loadBackupSettings(),\r\n          loadHierarchyMode(),\r\n          checkGoogleDriveConnection(),\r\n          checkBrevoConfiguration(),\r\n          checkGroqConfiguration(),\r\n          checkWhatsAppConfiguration(),\r\n          checkWhatsAppOfficialConfiguration(),\r\n          checkWhatsAppWahaConfiguration(),\r\n          checkTelegramConfiguration()\r\n        ])\r\n      } catch (error) {\r\n        console.error('Error loading settings data:', error)\r\n      }\r\n    }\r\n    \r\n    if (isMounted) {\r\n      loadData()\r\n    }\r\n    \r\n    return () => {\r\n      isMounted = false\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user?.id]) // Mantener solo la dependencia esencial para evitar ciclos infinitos\r\n\r\n  // Eliminado el useEffect que causaba parpadeo - ahora el tab se maneja de forma est√°tica\r\n\r\n  // Cargar configuraciones de notificaciones desde el servicio centralizado\r\n  const loadNotificationSettings = useCallback(async () => {\r\n    try {\r\n      const saved = await configurationService.getNotificationSettings()\r\n      if (saved) {\r\n        // Asegurar que recipients sea siempre un array\r\n        const settingsWithArrayRecipients = {\r\n          ...saved,\r\n          reports: {\r\n            ...saved.reports,\r\n            recipients: Array.isArray(saved.reports?.recipients)\r\n              ? saved.reports.recipients\r\n              : saved.reports?.recipients\r\n                ? [saved.reports.recipients] // Convertir string a array\r\n                : [user?.email || ''] // Valor por defecto\r\n          }\r\n        }\r\n        setNotificationSettings(prev => ({ ...prev, ...settingsWithArrayRecipients }))\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading notification settings:', error)\r\n    }\r\n  }, [user?.email])\r\n\r\n  // Funciones para manejar el modo de jerarqu√≠a de configuraci√≥n\r\n  const handleHierarchyModeChange = async (newMode) => {\r\n    try {\r\n      setHierarchyMode(newMode)\r\n\r\n      // Guardar en el servicio de configuraci√≥n centralizado\r\n      await configurationService.setConfig('system', 'hierarchy_mode', newMode, 'global', null,\r\n        'Modo de jerarqu√≠a de configuraci√≥n del sistema')\r\n\r\n      // Mostrar mensaje informativo sobre el cambio\r\n      const modeDescriptions = {\r\n        global_only: 'Solo se usar√°n configuraciones globales. Las configuraciones por empresa ser√°n ignoradas.',\r\n        company_first: 'Se priorizar√°n configuraciones por empresa. Si no existen, se usar√°n las globales.',\r\n        both: 'Se combinar√°n ambas configuraciones. Las espec√≠ficas de empresa sobreescribir√°n las globales.'\r\n      }\r\n\r\n      toast.success(`Modo de configuraci√≥n actualizado: ${newMode.replace('_', ' ').toUpperCase()}`)\r\n\r\n      // Mostrar detalles del modo\r\n      setTimeout(() => {\r\n        Swal.fire({\r\n          title: 'üîß Modo de Configuraci√≥n Actualizado',\r\n          html: `\r\n            <div style=\"text-align: left;\">\r\n              <div style=\"background-color: #f0f8ff; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #0066ff;\">Modo seleccionado:</h4>\r\n                <p style=\"margin: 0; font-weight: bold; text-transform: uppercase;\">\r\n                  ${newMode.replace('_', ' ')}\r\n                </p>\r\n              </div>\r\n              <div style=\"background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #333;\">Comportamiento:</h4>\r\n                <p style=\"margin: 0; font-size: 14px;\">\r\n                  ${modeDescriptions[newMode]}\r\n                </p>\r\n              </div>\r\n            </div>\r\n          `,\r\n          icon: 'info',\r\n          confirmButtonText: 'Entendido',\r\n          confirmButtonColor: '#0066ff',\r\n          width: '500px'\r\n        });\r\n      }, 500)\r\n\r\n    } catch (error) {\r\n      console.error('Error changing hierarchy mode:', error)\r\n      toast.error('Error al cambiar el modo de configuraci√≥n')\r\n    }\r\n  }\r\n\r\n  // Cargar configuraci√≥n de jerarqu√≠a desde el servicio centralizado\r\n  const loadHierarchyMode = useCallback(async () => {\r\n    try {\r\n      const saved = await configurationService.getConfig('system', 'hierarchy_mode', 'global', null, 'company_first')\r\n      if (saved && ['global_only', 'company_first', 'both'].includes(saved)) {\r\n        setHierarchyMode(saved)\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading hierarchy mode:', error)\r\n    }\r\n  }, [])\r\n\r\n  // Guardar configuraciones de notificaciones\r\n  const saveNotificationSettings = async (settings) => {\r\n    try {\r\n      await configurationService.setNotificationSettings(settings)\r\n      toast.success('Configuraci√≥n de notificaciones guardada')\r\n    } catch (error) {\r\n      console.error('Error saving notification settings:', error)\r\n      toast.error('Error al guardar la configuraci√≥n')\r\n    }\r\n  }\r\n\r\n  // Cargar configuraciones de seguridad\r\n  const loadSecuritySettings = useCallback(async () => {\r\n    try {\r\n      const saved = await configurationService.getSecuritySettings()\r\n      if (saved) {\r\n        setSecuritySettings(prev => ({ ...prev, ...saved }))\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading security settings:', error)\r\n    }\r\n  }, [])\r\n\r\n  // Cargar sesiones activas\r\n  const loadActiveSessions = useCallback(() => {\r\n    try {\r\n      // Simular sesiones activas (en producci√≥n vendr√≠a de una API)\r\n      const sessions = [\r\n        {\r\n          id: 'current',\r\n          device: 'Chrome en macOS',\r\n          location: 'Santiago, Chile',\r\n          ip: '192.168.1.100',\r\n          lastActivity: new Date(),\r\n          current: true\r\n        },\r\n        {\r\n          id: 'session_2',\r\n          device: 'Safari en iPhone',\r\n          location: 'Santiago, Chile',\r\n          ip: '192.168.1.101',\r\n          lastActivity: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 horas atr√°s\r\n          current: false\r\n        }\r\n      ]\r\n      setActiveSessions(sessions)\r\n    } catch (error) {\r\n      console.error('Error loading active sessions:', error)\r\n    }\r\n  }, [])\r\n\r\n  // Cargar logs de seguridad\r\n  const loadSecurityLogs = useCallback(() => {\r\n    try {\r\n      // Simular logs de seguridad (en producci√≥n vendr√≠a de una API)\r\n      const logs = [\r\n        {\r\n          id: 1,\r\n          action: 'Inicio de sesi√≥n exitoso',\r\n          details: 'Chrome ‚Ä¢ Santiago, Chile',\r\n          timestamp: new Date(),\r\n          ip: '192.168.1.100',\r\n          status: 'success'\r\n        },\r\n        {\r\n          id: 2,\r\n          action: 'Cambio de contrase√±a',\r\n          details: 'Aplicaci√≥n web',\r\n          timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000), // 3 d√≠as atr√°s\r\n          ip: '192.168.1.100',\r\n          status: 'success'\r\n        },\r\n        {\r\n          id: 3,\r\n          action: 'Configuraci√≥n de 2FA',\r\n          details: 'Aplicaci√≥n web',\r\n          timestamp: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), // 1 semana atr√°s\r\n          ip: '192.168.1.100',\r\n          status: 'success'\r\n        },\r\n        {\r\n          id: 4,\r\n          action: 'Intento de inicio de sesi√≥n fallido',\r\n          details: 'IP sospechosa ‚Ä¢ Nueva York, USA',\r\n          timestamp: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000), // 10 d√≠as atr√°s\r\n          ip: '104.28.1.100',\r\n          status: 'warning'\r\n        }\r\n      ]\r\n      setSecurityLogs(logs)\r\n    } catch (error) {\r\n      console.error('Error loading security logs:', error)\r\n    }\r\n  }, [])\r\n\r\n  // Cargar configuraciones de backup\r\n  const loadBackupSettings = useCallback(async () => {\r\n    try {\r\n      const saved = await configurationService.getConfig('system', 'backup_settings', 'global', null, {\r\n        autoBackup: true,\r\n        backupFrequency: 'weekly',\r\n        retentionDays: 30,\r\n        lastBackup: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), // 7 d√≠as atr√°s\r\n        backupSize: '2.3 GB'\r\n      })\r\n      setBackupSettings(prev => ({ ...prev, ...saved }))\r\n    } catch (error) {\r\n      console.error('Error loading backup settings:', error)\r\n    }\r\n  }, [])\r\n\r\n  // Funci√≥n para verificar conexi√≥n de Google Drive\r\n  const checkGoogleDriveConnection = useCallback(async () => {\r\n    try {\r\n      // Verificar si el usuario est√° conectado a Google Drive usando el servicio de persistencia\r\n      const isConnected = await googleDrivePersistenceService.isConnected(user?.id)\r\n      setIsGoogleDriveConnected(isConnected)\r\n      \r\n      // Obtener estado detallado si est√° conectado\r\n      if (isConnected) {\r\n        const status = await googleDrivePersistenceService.getConnectionStatus(user?.id)\r\n        setIntegrations(prev => ({\r\n          ...prev,\r\n          google: {\r\n            connected: status.connected,\r\n            status: status.connected ? 'connected' : 'disconnected',\r\n            lastSync: status.lastSync || new Date().toISOString(),\r\n            email: status.email\r\n          }\r\n        }))\r\n      } else {\r\n        setIntegrations(prev => ({\r\n          ...prev,\r\n          google: {\r\n            connected: false,\r\n            status: 'disconnected',\r\n            lastSync: null\r\n          }\r\n        }))\r\n      }\r\n    } catch (error) {\r\n      console.error('‚ùå [Settings] Error verificando conexi√≥n de Google Drive:', error)\r\n      setIsGoogleDriveConnected(false)\r\n      setIntegrations(prev => ({\r\n        ...prev,\r\n        google: {\r\n          connected: false,\r\n          status: 'disconnected',\r\n          lastSync: null\r\n        }\r\n      }))\r\n    }\r\n  }, [user?.id])\r\n\r\n  // Funci√≥n para verificar configuraci√≥n de Brevo\r\n  const checkBrevoConfiguration = useCallback(() => {\r\n    const config = brevoService.loadConfiguration()\r\n    setIntegrations(prev => ({\r\n      ...prev,\r\n      brevo: {\r\n        connected: config.apiKey ? true : false,\r\n        status: config.apiKey ? 'connected' : 'disconnected',\r\n        lastSync: config.apiKey ? new Date().toISOString() : null,\r\n        testMode: config.testMode\r\n      }\r\n    }))\r\n  }, [])\r\n\r\n  // Funci√≥n para verificar configuraci√≥n de Groq\r\n  const checkGroqConfiguration = useCallback(async () => {\r\n    try {\r\n      const apiKey = process.env.REACT_APP_GROQ_API_KEY\r\n      const groqConfig = await configurationService.getConfig('integrations', 'groq', 'global', null, {})\r\n\r\n      setIntegrations(prev => ({\r\n        ...prev,\r\n        groq: {\r\n          connected: !!(apiKey && apiKey !== 'tu_groq_api_key_aqui'),\r\n          status: !!(apiKey && apiKey !== 'tu_groq_api_key_aqui') ? 'connected' : 'disconnected',\r\n          lastSync: !!(apiKey && apiKey !== 'tu_groq_api_key_aqui') ? new Date().toISOString() : null,\r\n          model: groqConfig.model || 'gemma2-9b-it'\r\n        }\r\n      }))\r\n    } catch (error) {\r\n      console.error('Error checking Groq configuration:', error)\r\n      setIntegrations(prev => ({\r\n        ...prev,\r\n        groq: {\r\n          connected: false,\r\n          status: 'disconnected',\r\n          lastSync: null,\r\n          model: 'gemma2-9b-it'\r\n        }\r\n      }))\r\n    }\r\n  }, [])\r\n\r\n  // Funci√≥n para verificar configuraci√≥n de WhatsApp\r\n  const checkWhatsAppConfiguration = useCallback(async () => {\r\n    try {\r\n      const whatsappConfig = await configurationService.getConfig('integrations', 'whatsapp', 'global', null, {})\r\n\r\n      setIntegrations(prev => ({\r\n        ...prev,\r\n        whatsapp: {\r\n          connected: !!(whatsappConfig.accessToken && whatsappConfig.phoneNumberId),\r\n          status: !!(whatsappConfig.accessToken && whatsappConfig.phoneNumberId) ? 'connected' : 'disconnected',\r\n          lastSync: !!(whatsappConfig.accessToken && whatsappConfig.phoneNumberId) ? new Date().toISOString() : null,\r\n          testMode: whatsappConfig.testMode || false\r\n        }\r\n      }))\r\n    } catch (error) {\r\n      console.error('Error checking WhatsApp configuration:', error)\r\n      setIntegrations(prev => ({\r\n        ...prev,\r\n        whatsapp: {\r\n          connected: false,\r\n          status: 'disconnected',\r\n          lastSync: null,\r\n          testMode: false\r\n        }\r\n      }))\r\n    }\r\n  }, [])\r\n\r\n  // Funci√≥n para verificar configuraci√≥n de Telegram\r\n  const checkTelegramConfiguration = useCallback(async () => {\r\n    try {\r\n      const telegramConfig = await configurationService.getConfig('integrations', 'telegram', 'global', null, {})\r\n\r\n      setIntegrations(prev => ({\r\n        ...prev,\r\n        telegram: {\r\n          connected: !!(telegramConfig.botToken && telegramConfig.botUsername),\r\n          status: !!(telegramConfig.botToken && telegramConfig.botUsername) ? 'connected' : 'disconnected',\r\n          lastSync: !!(telegramConfig.botToken && telegramConfig.botUsername) ? new Date().toISOString() : null,\r\n          botToken: telegramConfig.botToken,\r\n          botUsername: telegramConfig.botUsername\r\n        }\r\n      }))\r\n    } catch (error) {\r\n      console.error('Error checking Telegram configuration:', error)\r\n      setIntegrations(prev => ({\r\n        ...prev,\r\n        telegram: {\r\n          connected: false,\r\n          status: 'disconnected',\r\n          lastSync: null,\r\n          botToken: null,\r\n          botUsername: null\r\n        }\r\n      }))\r\n    }\r\n  }, [])\r\n\r\n  // Funci√≥n para verificar configuraci√≥n de WhatsApp Official\r\n  const checkWhatsAppOfficialConfiguration = useCallback(() => {\r\n    const config = whatsappOfficialService.loadConfiguration();\r\n    \r\n    setIntegrations(prev => ({\r\n      ...prev,\r\n      whatsappOfficial: {\r\n        connected: !!(config.accessToken && config.phoneNumberId),\r\n        status: !!(config.accessToken && config.phoneNumberId) ? 'connected' : 'disconnected',\r\n        lastSync: !!(config.accessToken && config.phoneNumberId) ? new Date().toISOString() : null,\r\n        testMode: config.testMode\r\n      }\r\n    }))\r\n  }, [])\r\n\r\n  // Funci√≥n para verificar configuraci√≥n de WhatsApp WAHA\r\n  const checkWhatsAppWahaConfiguration = useCallback(() => {\r\n    const config = whatsappWahaService.loadConfiguration();\r\n    \r\n    setIntegrations(prev => ({\r\n      ...prev,\r\n      whatsappWaha: {\r\n        connected: !!(config.apiKey && config.sessionId),\r\n        status: !!(config.apiKey && config.sessionId) ? 'connected' : 'disconnected',\r\n        lastSync: !!(config.apiKey && config.sessionId) ? new Date().toISOString() : null,\r\n        testMode: config.testMode\r\n      }\r\n    }))\r\n  }, [])\r\n\r\n  // Funci√≥n para conectar Google Drive\r\n  const handleConnectGoogleDrive = async () => {\r\n    try {\r\n      setConnectingGoogleDrive(true)\r\n      \r\n      // Verificar si hay credenciales configuradas\r\n      if (!googleDriveService.hasValidCredentials()) {\r\n        setConnectingGoogleDrive(false)\r\n        \r\n        // Mostrar mensaje para configurar credenciales\r\n        Swal.fire({\r\n          title: 'üîß Configuraci√≥n de Google OAuth Requerida',\r\n          html: `\r\n            <div style=\"text-align: left; max-width: 500px;\">\r\n              <div style=\"background-color: #fff3cd; padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 1px solid #ffeaa7;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #856404;\">‚ö†Ô∏è Credenciales Faltantes</h4>\r\n                <p style=\"margin: 0; font-size: 14px; line-height: 1.5;\">\r\n                  Para conectar con Google Drive, necesitas configurar las credenciales de OAuth 2.0 en Google Cloud Console.\r\n                </p>\r\n              </div>\r\n              \r\n              <div style=\"background-color: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #333;\">üìã Pasos necesarios:</h4>\r\n                <ol style=\"margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.6;\">\r\n                  <li>Ir a <a href=\"https://console.cloud.google.com/\" target=\"_blank\">Google Cloud Console</a></li>\r\n                  <li>Crear o seleccionar un proyecto</li>\r\n                  <li>Habilitar Google Drive API</li>\r\n                  <li>Crear credenciales OAuth 2.0</li>\r\n                  <li>Configurar URI de redirecci√≥n: <code>${window.location.origin}/auth/google/callback</code></li>\r\n                  <li>Actualizar variables en <code>.env</code></li>\r\n                </ol>\r\n              </div>\r\n              \r\n              <div style=\"background-color: #d4edda; padding: 12px; border-radius: 8px;\">\r\n                <p style=\"margin: 0; font-size: 13px; color: #155724; text-align: center;\">\r\n                  <strong>üìñ Ver gu√≠a completa:</strong><br>\r\n                  <a href=\"/GOOGLE_OAUTH_SETUP_GUIDE.md\" target=\"_blank\" style=\"color: #155724; text-decoration: underline;\">\r\n                    GOOGLE_OAUTH_SETUP_GUIDE.md\r\n                  </a>\r\n                </p>\r\n              </div>\r\n            </div>\r\n          `,\r\n          icon: 'warning',\r\n          confirmButtonText: 'Entendido',\r\n          confirmButtonColor: '#856404',\r\n          width: '600px'\r\n        })\r\n        return\r\n      }\r\n      \r\n      // Generar URL de autorizaci√≥n con el callback handler (incluye CSRF protection)\r\n      const authUrl = googleDriveCallbackHandler.generateAuthorizationUrl()\r\n      if (authUrl) {\r\n        // El state ya fue guardado en sessionStorage por generateAuthorizationUrl()\r\n        // Redirigir a Google OAuth\r\n        window.location.href = authUrl\r\n      } else {\r\n        setConnectingGoogleDrive(false)\r\n        toast.error('Error al generar URL de autenticaci√≥n')\r\n      }\r\n    } catch (error) {\r\n      console.error('Error en connect Google Drive:', error)\r\n      setConnectingGoogleDrive(false)\r\n      toast.error('Error al conectar con Google Drive')\r\n    }\r\n  }\r\n\r\n  // Funci√≥n para desconectar Google Drive\r\n  const handleDisconnectGoogleDrive = async () => {\r\n    try {\r\n      setConnectingGoogleDrive(true)\r\n      \r\n      // Confirmar desconexi√≥n\r\n      const result = await Swal.fire({\r\n        title: '¬øDesconectar Google Drive?',\r\n        text: 'Se eliminar√°n las credenciales guardadas y perder√°s la sincronizaci√≥n.',\r\n        icon: 'warning',\r\n        showCancelButton: true,\r\n        confirmButtonColor: '#d33',\r\n        cancelButtonColor: '#3085d6',\r\n        confirmButtonText: 'Desconectar',\r\n        cancelButtonText: 'Cancelar'\r\n      })\r\n      \r\n      if (!result.isConfirmed) {\r\n        setConnectingGoogleDrive(false)\r\n        return\r\n      }\r\n      \r\n      // Desconectar\r\n      const disconnectResult = await googleDrivePersistenceService.disconnect(user?.id)\r\n      \r\n      if (disconnectResult.success) {\r\n        // Actualizar estados locales\r\n        setIsGoogleDriveConnected(false)\r\n        setIntegrations(prev => ({\r\n          ...prev,\r\n          google: {\r\n            connected: false,\r\n            status: 'disconnected',\r\n            lastSync: null\r\n          }\r\n        }))\r\n        \r\n        toast.success('Google Drive desconectado exitosamente')\r\n      } else {\r\n        throw new Error(disconnectResult.error?.message || 'Error al desconectar')\r\n      }\r\n    } catch (error) {\r\n      console.error('Error disconnecting Google Drive:', error)\r\n      toast.error('Error al desconectar Google Drive')\r\n    } finally {\r\n      setConnectingGoogleDrive(false)\r\n    }\r\n  }\r\n\r\n  // Funciones para manejar cambios en las configuraciones\r\n  const handleEmailNotificationChange = (key, value) => {\r\n    setNotificationSettings(prev => ({\r\n      ...prev,\r\n      email: { ...prev.email, [key]: value }\r\n    }))\r\n  }\r\n\r\n\r\n  const handleReportsSettingsChange = (key, value) => {\r\n    setNotificationSettings(prev => ({\r\n      ...prev,\r\n      reports: { ...prev.reports, [key]: value }\r\n    }))\r\n  }\r\n\r\n  const handleSoundSettingsChange = (key, value) => {\r\n    setNotificationSettings(prev => ({\r\n      ...prev,\r\n      sound: { ...prev.sound, [key]: value }\r\n    }))\r\n  }\r\n\r\n  // Funciones para guardar configuraciones espec√≠ficas\r\n  const saveEmailPreferences = async () => {\r\n    await saveNotificationSettings(notificationSettings)\r\n  }\r\n\r\n\r\n  // Funciones para manejar m√∫ltiples emails\r\n  const addEmailRecipient = () => {\r\n    const newEmail = prompt('Ingresa el email del destinatario:')\r\n    if (newEmail) {\r\n      const emailRegex = /^[^s@]+@[^s@]+.[^s@]+$/\r\n      if (!emailRegex.test(newEmail)) {\r\n        toast.error('Por favor ingresa un email v√°lido')\r\n        return\r\n      }\r\n\r\n      if (notificationSettings.reports.recipients.includes(newEmail)) {\r\n        toast.error('Este email ya est√° en la lista')\r\n        return\r\n      }\r\n\r\n      handleReportsSettingsChange('recipients', [...notificationSettings.reports.recipients, newEmail])\r\n      toast.success('Email agregado correctamente')\r\n    }\r\n  }\r\n\r\n  const removeEmailRecipient = (emailToRemove) => {\r\n    const updatedRecipients = notificationSettings.reports.recipients.filter(email => email !== emailToRemove)\r\n    handleReportsSettingsChange('recipients', updatedRecipients)\r\n    toast.success('Email removido correctamente')\r\n  }\r\n\r\n  const scheduleReports = async () => {\r\n    // Validar que haya al menos un email\r\n    if (!notificationSettings.reports.recipients || notificationSettings.reports.recipients.length === 0) {\r\n      toast.error('Por favor agrega al menos un destinatario')\r\n      return\r\n    }\r\n\r\n    // Validar que todos los emails sean v√°lidos\r\n    const emailRegex = /^[^s@]+@[^s@]+.[^s@]+$/\r\n    const invalidEmails = notificationSettings.reports.recipients.filter(email => !emailRegex.test(email))\r\n\r\n    if (invalidEmails.length > 0) {\r\n      toast.error(`Los siguientes emails no son v√°lidos: ${invalidEmails.join(', ')}`)\r\n      return\r\n    }\r\n\r\n    // Guardar configuraciones\r\n    await saveNotificationSettings(notificationSettings)\r\n    toast.success(`Configuraci√≥n guardada. Redirigiendo a reportes...`)\r\n\r\n    // Redirigir a la p√°gina de reportes despu√©s de un breve delay\r\n    setTimeout(() => {\r\n      navigate('/communication/reports')\r\n    }, 1500)\r\n  }\r\n\r\n  const testSounds = async () => {\r\n    if (!notificationSettings.sound.enabled) {\r\n      toast.info('Los sonidos est√°n desactivados')\r\n      return\r\n    }\r\n\r\n    // Crear un audio de prueba (beep simple)\r\n    try {\r\n      const audioContext = new (window.AudioContext || window.webkitAudioContext)()\r\n      const oscillator = audioContext.createOscillator()\r\n      const gainNode = audioContext.createGain()\r\n\r\n      oscillator.connect(gainNode)\r\n      gainNode.connect(audioContext.destination)\r\n\r\n      oscillator.frequency.setValueAtTime(800, audioContext.currentTime)\r\n      oscillator.type = 'sine'\r\n\r\n      gainNode.gain.setValueAtTime(notificationSettings.sound.volume / 100, audioContext.currentTime)\r\n      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5)\r\n\r\n      oscillator.start(audioContext.currentTime)\r\n      oscillator.stop(audioContext.currentTime + 0.5)\r\n\r\n      toast.success('Sonido de prueba reproducido')\r\n    } catch (error) {\r\n      console.error('Error testing sound:', error)\r\n      toast.error('Error al reproducir sonido de prueba')\r\n    }\r\n  }\r\n\r\n  const loadCompanies = useCallback(async () => {\r\n    try {\r\n      setLoading(true)\r\n\r\n      // Usar el servicio de base de datos organizada para cargar empresas reales\r\n      const companiesData = await organizedDatabaseService.getCompanies()\r\n      setCompanies(companiesData || [])\r\n\r\n    } catch (error) {\r\n      console.error('Error loading companies:', error)\r\n      // En caso de error, usar datos m√≠nimos\r\n      setCompanies([])\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [])\r\n\r\n  const handleCreateCompany = () => {\r\n    setEditingCompany(null)\r\n    setShowCompanyForm(true)\r\n  }\r\n\r\n\r\n  const handleDeleteCompany = async (companyId) => {\r\n    const company = companies.find(c => c.id === companyId)\r\n    if (!company) return\r\n\r\n    // Usar toast para confirmar eliminaci√≥n\r\n    const confirmed = await new Promise((resolve) => {\r\n      const confirmDelete = () => {\r\n        resolve(true)\r\n      }\r\n      const cancelDelete = () => resolve(false)\r\n\r\n      // Mostrar toast con botones personalizados\r\n      toast((t) => (\r\n        <div>\r\n          <p className=\"font-medium\">¬øEliminar empresa \"{company.name}\"?</p>\r\n          <p className=\"text-sm text-gray-600 mt-1\">Esta acci√≥n no se puede deshacer.</p>\r\n          <div className=\"flex gap-2 mt-3\">\r\n            <button\r\n              onClick={() => {\r\n                toast.dismiss(t.id)\r\n                confirmDelete()\r\n              }}\r\n              className=\"px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600\"\r\n            >\r\n              Eliminar\r\n            </button>\r\n            <button\r\n              onClick={() => {\r\n                toast.dismiss(t.id)\r\n                cancelDelete()\r\n              }}\r\n              className=\"px-3 py-1 bg-gray-500 text-white text-sm rounded hover:bg-gray-600\"\r\n            >\r\n              Cancelar\r\n            </button>\r\n          </div>\r\n        </div>\r\n      ), { duration: 10000 })\r\n    })\r\n\r\n    if (!confirmed) return\r\n\r\n    try {\r\n      // Usar el servicio de sincronizaci√≥n para eliminar la empresa\r\n      await companySyncService.deleteCompany(companyId)\r\n      \r\n      // Actualizar estado local\r\n      setCompanies(prev => prev.filter(c => c.id !== companyId))\r\n      toast.success('Empresa eliminada exitosamente')\r\n\r\n    } catch (error) {\r\n      console.error('Error deleting company:', error)\r\n      toast.error('Error al eliminar la empresa')\r\n    }\r\n  }\r\n\r\n  const handleFormSuccess = () => {\r\n    setShowCompanyForm(false)\r\n    setEditingCompany(null)\r\n    loadCompanies()\r\n  }\r\n\r\n  const toggleCompanyStatus = async (company) => {\r\n    try {\r\n      const newStatus = company.status === 'active' ? 'inactive' : 'active'\r\n      \r\n      // Usar el servicio de sincronizaci√≥n para actualizar el estado\r\n      await companySyncService.updateCompany(company.id, {\r\n        status: newStatus\r\n      })\r\n      \r\n      // Actualizar estado local\r\n      setCompanies(prev => prev.map(c =>\r\n        c.id === company.id\r\n          ? { ...c, status: newStatus, updated_at: new Date().toISOString() }\r\n          : c\r\n      ))\r\n      toast.success(`Empresa ${newStatus === 'active' ? 'activada' : 'desactivada'}`)\r\n\r\n    } catch (error) {\r\n      console.error('Error toggling company status:', error)\r\n      toast.error('Error al cambiar el estado de la empresa')\r\n    }\r\n  }\r\n\r\n  // Funciones de integraciones\r\n  const configureGoogleWorkspace = async () => {\r\n    const { value: formValues } = await Swal.fire({\r\n      title: 'Configurar Google Workspace',\r\n      html: `\r\n        <div style=\"text-align: left;\">\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">API Key:</label>\r\n            <input type=\"password\" id=\"google-api-key\" class=\"swal2-input\" placeholder=\"Ingresa tu API Key de Google\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Client ID:</label>\r\n            <input type=\"text\" id=\"google-client-id\" class=\"swal2-input\" placeholder=\"Ingresa tu Client ID\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Client Secret:</label>\r\n            <input type=\"password\" id=\"google-client-secret\" class=\"swal2-input\" placeholder=\"Ingresa tu Client Secret\">\r\n          </div>\r\n          <div style=\"font-size: 12px; color: #666; margin-top: 16px;\">\r\n            <strong>Permisos requeridos:</strong><br>\r\n            ‚Ä¢ Calendar API<br>\r\n            ‚Ä¢ Gmail API<br>\r\n            ‚Ä¢ Google Drive API\r\n          </div>\r\n        </div>\r\n      `,\r\n      focusConfirm: false,\r\n      preConfirm: () => {\r\n        const apiKey = document.getElementById('google-api-key').value;\r\n        const clientId = document.getElementById('google-client-id').value;\r\n        const clientSecret = document.getElementById('google-client-secret').value;\r\n\r\n        if (!apiKey || !clientId || !clientSecret) {\r\n          Swal.showValidationMessage('Todos los campos son obligatorios');\r\n          return false;\r\n        }\r\n\r\n        return { apiKey, clientId, clientSecret };\r\n      },\r\n      showCancelButton: true,\r\n      confirmButtonText: 'Conectar',\r\n      cancelButtonText: 'Cancelar',\r\n      confirmButtonColor: '#4285f4'\r\n    });\r\n\r\n    if (formValues) {\r\n      // Simular conexi√≥n\r\n      setIntegrations(prev => ({ ...prev, google: { ...prev.google, status: 'connecting' } }));\r\n\r\n      await new Promise(resolve => setTimeout(resolve, 2000));\r\n\r\n      // Simular √©xito de conexi√≥n\r\n      setIntegrations(prev => ({\r\n        ...prev,\r\n        google: {\r\n          connected: true,\r\n          status: 'connected',\r\n          lastSync: new Date().toISOString()\r\n        }\r\n      }));\r\n\r\n      toast.success('Google Workspace conectado exitosamente');\r\n    }\r\n  };\r\n\r\n  /*\r\n  const configureMicrosoft365 = async () => {\r\n    const { value: formValues } = await Swal.fire({\r\n      title: 'Configurar Microsoft 365 / Google Calendar',\r\n      html: `\r\n        <div style=\"text-align: left;\">\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Plataforma:</label>\r\n            <select id=\"platform-select\" class=\"swal2-input\">\r\n              <option value=\"microsoft\">Microsoft 365 (Outlook)</option>\r\n              <option value=\"google-calendar\">Google Calendar</option>\r\n            </select>\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Client ID:</label>\r\n            <input type=\"text\" id=\"microsoft-client-id\" class=\"swal2-input\" placeholder=\"Ingresa tu Client ID\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Tenant ID (solo Microsoft):</label>\r\n            <input type=\"text\" id=\"microsoft-tenant-id\" class=\"swal2-input\" placeholder=\"Ingresa tu Tenant ID\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Client Secret:</label>\r\n            <input type=\"password\" id=\"microsoft-client-secret\" class=\"swal2-input\" placeholder=\"Ingresa tu Client Secret\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">¬øEnviar recordatorios por WhatsApp?</label>\r\n            <input type=\"checkbox\" id=\"whatsapp-reminders\" checked style=\"margin-left: 8px;\">\r\n          </div>\r\n          <div style=\"font-size: 12px; color: #666; margin-top: 16px;\">\r\n            <strong>Funcionalidades activadas:</strong><br>\r\n            ‚Ä¢ üìÖ Recordatorios de reuniones por WhatsApp<br>\r\n            ‚Ä¢ üîÑ Notificaciones de cambios en calendario<br>\r\n            ‚Ä¢ üìé Enlaces directos a archivos de OneDrive/SharePoint<br>\r\n            ‚Ä¢ ‚è∞ Alertas 15 minutos antes de reuniones\r\n          </div>\r\n        </div>\r\n      `,\r\n      focusConfirm: false,\r\n      preConfirm: () => {\r\n        const platform = document.getElementById('platform-select').value;\r\n        const clientId = document.getElementById('microsoft-client-id').value;\r\n        const tenantId = document.getElementById('microsoft-tenant-id').value;\r\n        const clientSecret = document.getElementById('microsoft-client-secret').value;\r\n        const whatsappReminders = document.getElementById('whatsapp-reminders').checked;\r\n\r\n        if (!clientId || !clientSecret) {\r\n          Swal.showValidationMessage('Client ID y Client Secret son obligatorios');\r\n          return false;\r\n        }\r\n\r\n        if (platform === 'microsoft' && !tenantId) {\r\n          Swal.showValidationMessage('Tenant ID es obligatorio para Microsoft 365');\r\n          return false;\r\n        }\r\n\r\n        return { platform, clientId, tenantId, clientSecret, whatsappReminders };\r\n      },\r\n      showCancelButton: true,\r\n      confirmButtonText: 'Conectar',\r\n      cancelButtonText: 'Cancelar',\r\n      confirmButtonColor: '#0078d4'\r\n    });\r\n\r\n    if (formValues) {\r\n      // Simular conexi√≥n\r\n      setIntegrations(prev => ({ ...prev, microsoft365: { ...prev.microsoft365, status: 'connecting' } }));\r\n\r\n      await new Promise(resolve => setTimeout(resolve, 2500));\r\n\r\n      // Simular √©xito de conexi√≥n\r\n      setIntegrations(prev => ({\r\n        ...prev,\r\n        microsoft365: {\r\n          connected: true,\r\n          status: 'connected',\r\n          lastSync: new Date().toISOString(),\r\n          platform: formValues.platform,\r\n          whatsappReminders: formValues.whatsappReminders\r\n        }\r\n      }));\r\n\r\n      const platformName = formValues.platform === 'microsoft' ? 'Microsoft 365' : 'Google Calendar';\r\n      toast.success(`${platformName} conectado exitosamente con WhatsApp`);\r\n\r\n      // Mostrar mensaje informativo sobre las funcionalidades\r\n      setTimeout(() => {\r\n        Swal.fire({\r\n          title: 'üéâ Integraci√≥n Activada',\r\n          html: `\r\n            <div style=\"text-align: left;\">\r\n              <p><strong>Funcionalidades activadas:</strong></p>\r\n              <ul style=\"text-align: left; margin-top: 10px;\">\r\n                <li>üìÖ Recordatorios autom√°ticos por WhatsApp</li>\r\n                <li>üîÑ Notificaciones de cambios en calendario</li>\r\n                <li>üìé Enlaces directos a documentos compartidos</li>\r\n                <li>‚è∞ Alertas 15 minutos antes de reuniones</li>\r\n              </ul>\r\n              <p style=\"margin-top: 15px; color: #666; font-size: 14px;\">\r\n                Los empleados recibir√°n notificaciones autom√°ticas en WhatsApp para todas las reuniones y actualizaciones de calendario.\r\n              </p>\r\n            </div>\r\n          `,\r\n          icon: 'success',\r\n          confirmButtonText: 'Entendido'\r\n        });\r\n      }, 1000);\r\n    }\r\n  };\r\n\r\n  const configureSlack = async () => {\r\n    const { value: formValues } = await Swal.fire({\r\n      title: 'Configurar Slack',\r\n      html: `\r\n        <div style=\"text-align: left;\">\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Bot Token:</label>\r\n            <input type=\"password\" id=\"slack-bot-token\" class=\"swal2-input\" placeholder=\"xoxb-...\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Signing Secret:</label>\r\n            <input type=\"password\" id=\"slack-signing-secret\" class=\"swal2-input\" placeholder=\"Ingresa tu Signing Secret\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Canal por defecto:</label>\r\n            <input type=\"text\" id=\"slack-default-channel\" class=\"swal2-input\" placeholder=\"#general\" value=\"#general\">\r\n          </div>\r\n          <div style=\"font-size: 12px; color: #666; margin-top: 16px;\">\r\n            <strong>Permisos del Bot:</strong><br>\r\n            ‚Ä¢ chat:write<br>\r\n            ‚Ä¢ channels:read<br>\r\n            ‚Ä¢ users:read\r\n          </div>\r\n        </div>\r\n      `,\r\n      focusConfirm: false,\r\n      preConfirm: () => {\r\n        const botToken = document.getElementById('slack-bot-token').value;\r\n        const signingSecret = document.getElementById('slack-signing-secret').value;\r\n        const defaultChannel = document.getElementById('slack-default-channel').value;\r\n\r\n        if (!botToken || !signingSecret) {\r\n          Swal.showValidationMessage('Bot Token y Signing Secret son obligatorios');\r\n          return false;\r\n        }\r\n\r\n        return { botToken, signingSecret, defaultChannel };\r\n      },\r\n      showCancelButton: true,\r\n      confirmButtonText: 'Conectar',\r\n      cancelButtonText: 'Cancelar',\r\n      confirmButtonColor: '#4a154b'\r\n    });\r\n\r\n    if (formValues) {\r\n      setIntegrations(prev => ({ ...prev, slack: { ...prev.slack, status: 'connecting' } }));\r\n\r\n      await new Promise(resolve => setTimeout(resolve, 2000));\r\n\r\n      setIntegrations(prev => ({\r\n        ...prev,\r\n        slack: {\r\n          connected: true,\r\n          status: 'connected',\r\n          lastSync: new Date().toISOString()\r\n        }\r\n      }));\r\n\r\n      toast.success('Slack conectado exitosamente');\r\n    }\r\n  };\r\n  */\r\n\r\n  const configureTeams = async () => {\r\n    const { value: formValues } = await Swal.fire({\r\n      title: 'Configurar Microsoft Teams',\r\n      html: `\r\n        <div style=\"text-align: left;\">\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Application ID:</label>\r\n            <input type=\"text\" id=\"teams-app-id\" class=\"swal2-input\" placeholder=\"Ingresa tu Application ID\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Client Secret:</label>\r\n            <input type=\"password\" id=\"teams-client-secret\" class=\"swal2-input\" placeholder=\"Ingresa tu Client Secret\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Tenant ID:</label>\r\n            <input type=\"text\" id=\"teams-tenant-id\" class=\"swal2-input\" placeholder=\"Ingresa tu Tenant ID\">\r\n          </div>\r\n          <div style=\"font-size: 12px; color: #666; margin-top: 16px;\">\r\n            <strong>Permisos requeridos:</strong><br>\r\n            ‚Ä¢ ChannelMessage.Send<br>\r\n            ‚Ä¢ Chat.ReadWrite<br>\r\n            ‚Ä¢ User.Read\r\n          </div>\r\n        </div>\r\n      `,\r\n      focusConfirm: false,\r\n      preConfirm: () => {\r\n        const appId = document.getElementById('teams-app-id').value;\r\n        const clientSecret = document.getElementById('teams-client-secret').value;\r\n        const tenantId = document.getElementById('teams-tenant-id').value;\r\n\r\n        if (!appId || !clientSecret || !tenantId) {\r\n          Swal.showValidationMessage('Todos los campos son obligatorios');\r\n          return false;\r\n        }\r\n\r\n        return { appId, clientSecret, tenantId };\r\n      },\r\n      showCancelButton: true,\r\n      confirmButtonText: 'Conectar',\r\n      cancelButtonText: 'Cancelar',\r\n      confirmButtonColor: '#464775'\r\n    });\r\n\r\n    if (formValues) {\r\n      setIntegrations(prev => ({ ...prev, teams: { ...prev.teams, status: 'connecting' } }));\r\n\r\n      await new Promise(resolve => setTimeout(resolve, 2000));\r\n\r\n      setIntegrations(prev => ({\r\n        ...prev,\r\n        teams: {\r\n          connected: true,\r\n          status: 'connected',\r\n          lastSync: new Date().toISOString()\r\n        }\r\n      }));\r\n\r\n      toast.success('Microsoft Teams conectado exitosamente');\r\n    }\r\n  };\r\n\r\n  const configureHubSpot = async () => {\r\n    const { value: formValues } = await Swal.fire({\r\n      title: 'Configurar HubSpot',\r\n      html: `\r\n        <div style=\"text-align: left;\">\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">API Key:</label>\r\n            <input type=\"password\" id=\"hubspot-api-key\" class=\"swal2-input\" placeholder=\"Ingresa tu API Key de HubSpot\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Portal ID (opcional):</label>\r\n            <input type=\"text\" id=\"hubspot-portal-id\" class=\"swal2-input\" placeholder=\"Ingresa tu Portal ID\">\r\n          </div>\r\n          <div style=\"font-size: 12px; color: #666; margin-top: 16px;\">\r\n            <strong>Scopes requeridos:</strong><br>\r\n            ‚Ä¢ contacts<br>\r\n            ‚Ä¢ companies<br>\r\n            ‚Ä¢ deals\r\n          </div>\r\n        </div>\r\n      `,\r\n      focusConfirm: false,\r\n      preConfirm: () => {\r\n        const apiKey = document.getElementById('hubspot-api-key').value;\r\n        const portalId = document.getElementById('hubspot-portal-id').value;\r\n\r\n        if (!apiKey) {\r\n          Swal.showValidationMessage('API Key es obligatoria');\r\n          return false;\r\n        }\r\n\r\n        return { apiKey, portalId };\r\n      },\r\n      showCancelButton: true,\r\n      confirmButtonText: 'Conectar',\r\n      cancelButtonText: 'Cancelar',\r\n      confirmButtonColor: '#ff7a59'\r\n    });\r\n\r\n    if (formValues) {\r\n      setIntegrations(prev => ({ ...prev, hubspot: { ...prev.hubspot, status: 'connecting' } }));\r\n\r\n      await new Promise(resolve => setTimeout(resolve, 2000));\r\n\r\n      setIntegrations(prev => ({\r\n        ...prev,\r\n        hubspot: {\r\n          connected: true,\r\n          status: 'connected',\r\n          lastSync: new Date().toISOString()\r\n        }\r\n      }));\r\n\r\n      toast.success('HubSpot conectado exitosamente');\r\n    }\r\n  };\r\n\r\n  const configureGoogleMeet = async () => {\r\n    const { value: formValues } = await Swal.fire({\r\n      title: 'Configurar Google Meet',\r\n      html: `\r\n        <div style=\"text-align: left;\">\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">API Key:</label>\r\n            <input type=\"password\" id=\"googlemeet-api-key\" class=\"swal2-input\" placeholder=\"Ingresa tu API Key de Google\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Client ID:</label>\r\n            <input type=\"text\" id=\"googlemeet-client-id\" class=\"swal2-input\" placeholder=\"Ingresa tu Client ID\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Client Secret:</label>\r\n            <input type=\"password\" id=\"googlemeet-client-secret\" class=\"swal2-input\" placeholder=\"Ingresa tu Client Secret\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">¬øEnviar recordatorios por WhatsApp?</label>\r\n            <input type=\"checkbox\" id=\"googlemeet-whatsapp-reminders\" checked style=\"margin-left: 8px;\">\r\n          </div>\r\n          <div style=\"font-size: 12px; color: #666; margin-top: 16px;\">\r\n            <strong>Permisos requeridos:</strong><br>\r\n            ‚Ä¢ Google Meet API<br>\r\n            ‚Ä¢ Calendar API<br>\r\n            ‚Ä¢ Gmail API\r\n          </div>\r\n        </div>\r\n      `,\r\n      focusConfirm: false,\r\n      preConfirm: () => {\r\n        const apiKey = document.getElementById('googlemeet-api-key').value;\r\n        const clientId = document.getElementById('googlemeet-client-id').value;\r\n        const clientSecret = document.getElementById('googlemeet-client-secret').value;\r\n        const whatsappReminders = document.getElementById('googlemeet-whatsapp-reminders').checked;\r\n\r\n        if (!apiKey || !clientId || !clientSecret) {\r\n          Swal.showValidationMessage('API Key, Client ID y Client Secret son obligatorios');\r\n          return false;\r\n        }\r\n\r\n        return { apiKey, clientId, clientSecret, whatsappReminders };\r\n      },\r\n      showCancelButton: true,\r\n      confirmButtonText: 'Conectar',\r\n      cancelButtonText: 'Cancelar',\r\n      confirmButtonColor: '#4285f4'\r\n    });\r\n\r\n    if (formValues) {\r\n      setIntegrations(prev => ({ ...prev, googlemeet: { ...prev.googlemeet, status: 'connecting' } }));\r\n\r\n      await new Promise(resolve => setTimeout(resolve, 2000));\r\n\r\n      setIntegrations(prev => ({\r\n        ...prev,\r\n        googlemeet: {\r\n          connected: true,\r\n          status: 'connected',\r\n          lastSync: new Date().toISOString(),\r\n          whatsappReminders: formValues.whatsappReminders\r\n        }\r\n      }));\r\n\r\n      toast.success('Google Meet conectado exitosamente');\r\n\r\n      // Mostrar mensaje informativo sobre las funcionalidades\r\n      setTimeout(() => {\r\n        Swal.fire({\r\n          title: 'üé• Google Meet Activado',\r\n          html: `\r\n            <div style=\"text-align: left;\">\r\n              <p><strong>Funcionalidades activadas:</strong></p>\r\n              <ul style=\"text-align: left; margin-top: 10px;\">\r\n                <li>üìπ Recordatorios autom√°ticos de reuniones por WhatsApp</li>\r\n                <li>üîÑ Notificaciones de cambios en reuniones</li>\r\n                <li>üìé Enlaces directos a reuniones de Google Meet</li>\r\n                <li>‚è∞ Alertas 15 minutos antes de reuniones</li>\r\n                <li>üìù Integraci√≥n con calendario de empleados</li>\r\n              </ul>\r\n              <p style=\"margin-top: 15px; color: #666; font-size: 14px;\">\r\n                Los empleados recibir√°n notificaciones autom√°ticas en WhatsApp para todas las reuniones y actualizaciones de Google Meet.\r\n              </p>\r\n            </div>\r\n          `,\r\n          icon: 'success',\r\n          confirmButtonText: 'Entendido'\r\n        });\r\n      }, 1000);\r\n    }\r\n  };\r\n\r\n  const configureSalesforce = async () => {\r\n    const { value: formValues } = await Swal.fire({\r\n      title: 'Configurar Salesforce',\r\n      html: `\r\n        <div style=\"text-align: left;\">\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Consumer Key:</label>\r\n            <input type=\"text\" id=\"salesforce-consumer-key\" class=\"swal2-input\" placeholder=\"Ingresa tu Consumer Key\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Consumer Secret:</label>\r\n            <input type=\"password\" id=\"salesforce-consumer-secret\" class=\"swal2-input\" placeholder=\"Ingresa tu Consumer Secret\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Username:</label>\r\n            <input type=\"email\" id=\"salesforce-username\" class=\"swal2-input\" placeholder=\"usuario@empresa.com\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Password + Security Token:</label>\r\n            <input type=\"password\" id=\"salesforce-password\" class=\"swal2-input\" placeholder=\"Contrase√±a + Token de seguridad\">\r\n          </div>\r\n          <div style=\"font-size: 12px; color: #666; margin-top: 16px;\">\r\n            <strong>Permisos requeridos:</strong><br>\r\n            ‚Ä¢ API Enabled<br>\r\n            ‚Ä¢ View All Data<br>\r\n            ‚Ä¢ Modify All Data\r\n          </div>\r\n        </div>\r\n      `,\r\n      focusConfirm: false,\r\n      preConfirm: () => {\r\n        const consumerKey = document.getElementById('salesforce-consumer-key').value;\r\n        const consumerSecret = document.getElementById('salesforce-consumer-secret').value;\r\n        const username = document.getElementById('salesforce-username').value;\r\n        const password = document.getElementById('salesforce-password').value;\r\n\r\n        if (!consumerKey || !consumerSecret || !username || !password) {\r\n          Swal.showValidationMessage('Todos los campos son obligatorios');\r\n          return false;\r\n        }\r\n\r\n        return { consumerKey, consumerSecret, username, password };\r\n      },\r\n      showCancelButton: true,\r\n      confirmButtonText: 'Conectar',\r\n      cancelButtonText: 'Cancelar',\r\n      confirmButtonColor: '#00a1e0'\r\n    });\r\n\r\n    if (formValues) {\r\n      setIntegrations(prev => ({ ...prev, salesforce: { ...prev.salesforce, status: 'connecting' } }));\r\n\r\n      await new Promise(resolve => setTimeout(resolve, 2000));\r\n\r\n      setIntegrations(prev => ({\r\n        ...prev,\r\n        salesforce: {\r\n          connected: true,\r\n          status: 'connected',\r\n          lastSync: new Date().toISOString()\r\n        }\r\n      }));\r\n\r\n      toast.success('Salesforce conectado exitosamente');\r\n    }\r\n  };\r\n\r\n  const configureBrevo = async () => {\r\n    const { value: formValues } = await Swal.fire({\r\n      title: 'Configurar Brevo - SMS y Email Masivo',\r\n      html: `\r\n        <div style=\"text-align: left;\">\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">API Key v3:</label>\r\n            <input type=\"password\" id=\"brevo-api-key\" class=\"swal2-input\" placeholder=\"Ingresa tu API Key v3 de Brevo\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Nombre del remitente SMS:</label>\r\n            <input type=\"text\" id=\"brevo-sms-sender\" class=\"swal2-input\" placeholder=\"Ej: StaffHub\" maxlength=\"11\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Email del remitente:</label>\r\n            <input type=\"email\" id=\"brevo-email-sender\" class=\"swal2-input\" placeholder=\"noreply@tuempresa.com\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Nombre del remitente Email:</label>\r\n            <input type=\"text\" id=\"brevo-email-name\" class=\"swal2-input\" placeholder=\"Ej: StaffHub\">\r\n          </div>\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: flex; align-items: center; cursor: pointer;\">\r\n              <input type=\"checkbox\" id=\"brevo-test-mode\" style=\"margin-right: 8px;\" checked>\r\n              <span style=\"font-weight: 600;\">Modo de prueba</span>\r\n            </label>\r\n            <p style=\"font-size: 12px; color: #666; margin-top: 4px; margin-left: 20px;\">\r\n              En modo prueba, los mensajes se enviar√°n solo a n√∫meros de prueba\r\n            </p>\r\n          </div>\r\n          <div style=\"font-size: 12px; color: #666; margin-top: 16px; background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n            <strong style=\"color: #0066ff;\">üìã Instrucciones para obtener API Key:</strong><br>\r\n            1. Ve a <a href=\"https://app.brevo.com\" target=\"_blank\" style=\"color: #0066ff;\">app.brevo.com</a><br>\r\n            2. Ve a Configuraci√≥n ‚Üí Claves API<br>\r\n            3. Crea una nueva clave v3 con permisos de SMS y Email<br>\r\n            4. Copia y pega la clave aqu√≠\r\n          </div>\r\n          <div style=\"font-size: 12px; color: #666; margin-top: 12px; background-color: #e8f4fd; padding: 12px; border-radius: 4px;\">\r\n            <strong style=\"color: #0066ff;\">üöÄ Funcionalidades incluidas:</strong><br>\r\n            ‚Ä¢ SMS masivo (hasta 1000 por lote)<br>\r\n            ‚Ä¢ Email masivo (hasta 2000 por lote)<br>\r\n            ‚Ä¢ Estad√≠sticas en tiempo real<br>\r\n            ‚Ä¢ Plantillas personalizadas<br>\r\n            ‚Ä¢ Programaci√≥n de env√≠os<br>\r\n            ‚Ä¢ Modo prueba para desarrollo\r\n          </div>\r\n        </div>\r\n      `,\r\n      focusConfirm: false,\r\n      preConfirm: () => {\r\n        const apiKey = document.getElementById('brevo-api-key').value;\r\n        const smsSender = document.getElementById('brevo-sms-sender').value;\r\n        const emailSender = document.getElementById('brevo-email-sender').value;\r\n        const emailName = document.getElementById('brevo-email-name').value;\r\n        const testMode = document.getElementById('brevo-test-mode').checked;\r\n\r\n        if (!apiKey) {\r\n          Swal.showValidationMessage('La API Key es obligatoria');\r\n          return false;\r\n        }\r\n\r\n        if (!smsSender || smsSender.length < 3) {\r\n          Swal.showValidationMessage('El nombre del remitente SMS debe tener al menos 3 caracteres');\r\n          return false;\r\n        }\r\n\r\n        if (!emailSender || !emailSender.includes('@')) {\r\n          Swal.showValidationMessage('El email del remitente es inv√°lido');\r\n          return false;\r\n        }\r\n\r\n        if (!emailName || emailName.length < 2) {\r\n          Swal.showValidationMessage('El nombre del remitente email debe tener al menos 2 caracteres');\r\n          return false;\r\n        }\r\n\r\n        return { apiKey, smsSender, emailSender, emailName, testMode };\r\n      },\r\n      showCancelButton: true,\r\n      confirmButtonText: 'Conectar y Probar',\r\n      cancelButtonText: 'Cancelar',\r\n      confirmButtonColor: '#0066ff',\r\n      width: '600px'\r\n    });\r\n\r\n    if (formValues) {\r\n      // Mostrar estado de conexi√≥n\r\n      setIntegrations(prev => ({ ...prev, brevo: { ...prev.brevo, status: 'connecting' } }));\r\n\r\n      try {\r\n        // Configurar el servicio de Brevo\r\n        const config = {\r\n          apiKey: formValues.apiKey,\r\n          smsSender: formValues.smsSender,\r\n          emailSender: formValues.emailSender,\r\n          emailName: formValues.emailName,\r\n          testMode: formValues.testMode\r\n        };\r\n\r\n        // Guardar configuraci√≥n\r\n        brevoService.saveConfiguration(config);\r\n\r\n        // Probar conexi√≥n\r\n        const testResult = await brevoService.testConnection();\r\n\r\n        if (testResult.success) {\r\n          // Actualizar estado\r\n          setIntegrations(prev => ({\r\n            ...prev,\r\n            brevo: {\r\n              connected: true,\r\n              status: 'connected',\r\n              lastSync: new Date().toISOString(),\r\n              testMode: formValues.testMode\r\n            }\r\n          }));\r\n\r\n          // Mostrar √©xito\r\n          await Swal.fire({\r\n            title: 'üéâ Brevo Configurado Exitosamente',\r\n            html: `\r\n              <div style=\"text-align: left;\">\r\n                <div style=\"background-color: #d4edda; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                  <h4 style=\"margin: 0 0 8px 0; color: #155724;\">‚úÖ Conexi√≥n exitosa</h4>\r\n                  <p style=\"margin: 0; font-size: 14px;\">La API Key es v√°lida y todas las funcionalidades est√°n activas.</p>\r\n                </div>\r\n                <div style=\"background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n                  <h4 style=\"margin: 0 0 8px 0; color: #333;\">Configuraci√≥n guardada:</h4>\r\n                  <p style=\"margin: 4px 0; font-size: 14px;\">\r\n                    <strong>Remitente SMS:</strong> ${formValues.smsSender}<br>\r\n                    <strong>Remitente Email:</strong> ${formValues.emailName} <${formValues.emailSender}><br>\r\n                    <strong>Modo:</strong> ${formValues.testMode ? 'Prueba üß™' : 'Producci√≥n üöÄ'}\r\n                  </p>\r\n                </div>\r\n                <div style=\"background-color: #e8f4fd; padding: 12px; border-radius: 4px; margin-top: 12px;\">\r\n                  <h4 style=\"margin: 0 0 8px 0; color: #0066ff;\">üìä Estad√≠sticas disponibles:</h4>\r\n                  <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                    <li>‚Ä¢ SMS enviados: ${testResult.data?.sms?.sent || 0}</li>\r\n                    <li>‚Ä¢ Emails enviados: ${testResult.data?.email?.sent || 0}</li>\r\n                    <li>‚Ä¢ Cr√©ditos SMS: ${testResult.data?.sms?.credits || 'N/A'}</li>\r\n                    <li>‚Ä¢ Cr√©ditos Email: ${testResult.data?.email?.credits || 'N/A'}</li>\r\n                  </ul>\r\n                </div>\r\n              </div>\r\n            `,\r\n            icon: 'success',\r\n            confirmButtonText: '¬°Perfecto!',\r\n            confirmButtonColor: '#0066ff',\r\n            width: '500px'\r\n          });\r\n\r\n          toast.success('Brevo configurado exitosamente');\r\n        } else {\r\n          throw new Error(testResult.error || 'Error al conectar con Brevo');\r\n        }\r\n      } catch (error) {\r\n        console.error('Error configuring Brevo:', error);\r\n        \r\n        // Restaurar estado\r\n        setIntegrations(prev => ({\r\n          ...prev,\r\n          brevo: {\r\n            connected: false,\r\n            status: 'disconnected',\r\n            lastSync: null,\r\n            testMode: false\r\n          }\r\n        }));\r\n\r\n        // Mostrar error\r\n        await Swal.fire({\r\n          title: '‚ùå Error de Conexi√≥n',\r\n          html: `\r\n            <div style=\"text-align: left;\">\r\n              <div style=\"background-color: #f8d7da; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #721c24;\">No se pudo conectar con Brevo</h4>\r\n                <p style=\"margin: 0; font-size: 14px;\"><strong>Error:</strong> ${error.message}</p>\r\n              </div>\r\n              <div style=\"background-color: #fff3cd; padding: 12px; border-radius: 4px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #856404;\">üîç Posibles soluciones:</h4>\r\n                <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                  <li>‚Ä¢ Verifica que la API Key sea correcta</li>\r\n                  <li>‚Ä¢ Aseg√∫rate de que la API Key tenga permisos de SMS y Email</li>\r\n                  <li>‚Ä¢ Revisa que tu cuenta de Brevo est√© activa</li>\r\n                  <li>‚Ä¢ Verifica tu conexi√≥n a internet</li>\r\n                </ul>\r\n              </div>\r\n            </div>\r\n          `,\r\n          icon: 'error',\r\n          confirmButtonText: 'Reintentar',\r\n          confirmButtonColor: '#dc3545',\r\n          width: '500px'\r\n        });\r\n\r\n        toast.error('Error al configurar Brevo');\r\n      }\r\n    }\r\n  };\r\n\r\n  const configureGroq = async () => {\r\n    // Lista de modelos disponibles de Groq (actualizada con modelos reales)\r\n    const availableModels = [\r\n      { id: 'llama-3.3-70b-versatile', name: 'Llama 3.3 70B Versatile', description: 'Modelo de Meta de 70B par√°metros, vers√°til para m√∫ltiples tareas' },\r\n      { id: 'meta-llama/llama-4-maverick-17b-128e-instruct', name: 'Llama 4 Maverick 17B', description: 'Modelo de √∫ltima generaci√≥n de Meta, 17B par√°metros' },\r\n      { id: 'meta-llama/llama-4-scout-17b-16e-instruct', name: 'Llama 4 Scout 17B', description: 'Modelo optimizado de Meta, 17B par√°metros' },\r\n      { id: 'llama-3.1-8b-instant', name: 'Llama 3.1 8B Instant', description: 'Modelo r√°pido de Meta, 8B par√°metros, respuestas instant√°neas' },\r\n      { id: 'allam-2-7b', name: 'Allam 2 7B', description: 'Modelo especializado en √°rabe, 7B par√°metros' },\r\n      { id: 'qwen/qwen3-32b', name: 'Qwen 3 32B', description: 'Modelo de Alibaba Cloud, 32B par√°metros' },\r\n      { id: 'moonshotai/kimi-k2-instruct', name: 'Kimi K2 Instruct', description: 'Modelo de Moonshot AI optimizado para instrucciones' },\r\n      { id: 'moonshotai/kimi-k2-instruct-0905', name: 'Kimi K2 Instruct v0905', description: 'Versi√≥n mejorada de Kimi K2' },\r\n      { id: 'groq/compound', name: 'Groq Compound', description: 'Modelo especializado de Groq' },\r\n      { id: 'groq/compound-mini', name: 'Groq Compound Mini', description: 'Versi√≥n compacta del modelo Groq Compound' },\r\n      { id: 'openai/gpt-oss-120b', name: 'GPT-OSS 120B', description: 'Modelo OpenAI de c√≥digo abierto, 120B par√°metros' },\r\n      { id: 'openai/gpt-oss-20b', name: 'GPT-OSS 20B', description: 'Modelo OpenAI de c√≥digo abierto, 20B par√°metros' }\r\n    ];\r\n\r\n    const { value: formValues } = await Swal.fire({\r\n      title: 'Configurar Groq AI',\r\n      html: `\r\n        <div style=\"text-align: left;\">\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">API Key de Groq:</label>\r\n            <input type=\"password\" id=\"groq-api-key\" class=\"swal2-input\" placeholder=\"gsk_...\">\r\n            <div style=\"font-size: 12px; color: #666; margin-top: 4px;\">\r\n              Obt√©n tu API Key en <a href=\"https://console.groq.com/keys\" target=\"_blank\" style=\"color: #0066ff;\">console.groq.com</a>\r\n            </div>\r\n          </div>\r\n          \r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Modelo seleccionado:</label>\r\n            <select id=\"groq-model\" class=\"swal2-input\">\r\n              ${availableModels.map(model =>\r\n                `<option value=\"${model.id}\">${model.name} - ${model.description}</option>`\r\n              ).join('')}\r\n            </select>\r\n          </div>\r\n\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Temperatura (0-1):</label>\r\n            <input type=\"range\" id=\"groq-temperature\" class=\"swal2-input\" min=\"0\" max=\"1\" step=\"0.1\" value=\"0.7\">\r\n            <div style=\"display: flex; justify-content: space-between; font-size: 12px; color: #666;\">\r\n              <span>0 (Preciso)</span>\r\n              <span id=\"temp-value\">0.7</span>\r\n              <span>1 (Creativo)</span>\r\n            </div>\r\n          </div>\r\n\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Tokens m√°ximos:</label>\r\n            <input type=\"number\" id=\"groq-max-tokens\" class=\"swal2-input\" value=\"800\" min=\"100\" max=\"4000\">\r\n          </div>\r\n\r\n          <div style=\"font-size: 12px; color: #666; margin-top: 16px; background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n            <strong style=\"color: #0066ff;\">üìã Instrucciones para obtener API Key:</strong><br>\r\n            1. Ve a <a href=\"https://console.groq.com\" target=\"_blank\" style=\"color: #0066ff;\">console.groq.com</a><br>\r\n            2. Reg√≠strate o inicia sesi√≥n<br>\r\n            3. Ve a la secci√≥n \"API Keys\"<br>\r\n            4. Crea una nueva API Key<br>\r\n            5. Copia y pega la clave aqu√≠\r\n          </div>\r\n          \r\n          <div style=\"font-size: 12px; color: #666; margin-top: 12px; background-color: #e8f4fd; padding: 12px; border-radius: 4px;\">\r\n            <strong style=\"color: #0066ff;\">üöÄ Funcionalidades incluidas:</strong><br>\r\n            ‚Ä¢ Chat inteligente con contexto<br>\r\n            ‚Ä¢ An√°lisis de sentimientos<br>\r\n            ‚Ä¢ Resumen de documentos<br>\r\n            ‚Ä¢ Generaci√≥n de contenido<br>\r\n            ‚Ä¢ Soporte para espa√±ol optimizado<br>\r\n            ‚Ä¢ Tracking de uso de tokens\r\n          </div>\r\n        </div>\r\n      `,\r\n      focusConfirm: false,\r\n      preConfirm: () => {\r\n        const apiKey = document.getElementById('groq-api-key').value;\r\n        const model = document.getElementById('groq-model').value;\r\n        const temperature = parseFloat(document.getElementById('groq-temperature').value);\r\n        const maxTokens = parseInt(document.getElementById('groq-max-tokens').value);\r\n\r\n        if (!apiKey) {\r\n          Swal.showValidationMessage('La API Key de Groq es obligatoria');\r\n          return false;\r\n        }\r\n\r\n        if (!apiKey.startsWith('gsk_')) {\r\n          Swal.showValidationMessage('La API Key de Groq debe comenzar con \"gsk_\"');\r\n          return false;\r\n        }\r\n\r\n        return { apiKey, model, temperature, maxTokens };\r\n      },\r\n      didOpen: () => {\r\n        // Actualizar el valor de temperatura cuando se mueve el slider\r\n        const tempSlider = document.getElementById('groq-temperature');\r\n        const tempValue = document.getElementById('temp-value');\r\n        if (tempSlider && tempValue) {\r\n          tempSlider.addEventListener('input', (e) => {\r\n            tempValue.textContent = e.target.value;\r\n          });\r\n        }\r\n      },\r\n      showCancelButton: true,\r\n      confirmButtonText: 'Conectar y Probar',\r\n      cancelButtonText: 'Cancelar',\r\n      confirmButtonColor: '#00a67e',\r\n      width: '600px'\r\n    });\r\n\r\n    if (formValues) {\r\n      // Mostrar estado de conexi√≥n\r\n      setIntegrations(prev => ({ ...prev, groq: { ...prev.groq, status: 'connecting' } }));\r\n\r\n      try {\r\n        // Guardar configuraci√≥n usando el servicio centralizado\r\n        await configurationService.setConfig('integrations', 'groq', {\r\n          apiKey: formValues.apiKey,\r\n          model: formValues.model,\r\n          temperature: formValues.temperature,\r\n          maxTokens: formValues.maxTokens\r\n        }, 'global', null, 'Configuraci√≥n de Groq AI')\r\n\r\n        // Probar conexi√≥n con Groq\r\n        const testResult = await testGroqConnection(formValues.apiKey, formValues.model);\r\n\r\n        if (testResult.success) {\r\n          // Actualizar estado\r\n          setIntegrations(prev => ({\r\n            ...prev,\r\n            groq: {\r\n              connected: true,\r\n              status: 'connected',\r\n              lastSync: new Date().toISOString(),\r\n              model: formValues.model,\r\n              temperature: formValues.temperature,\r\n              maxTokens: formValues.maxTokens\r\n            }\r\n          }));\r\n\r\n          // Mostrar √©xito\r\n          await Swal.fire({\r\n            title: 'üéâ Groq AI Configurado Exitosamente',\r\n            html: `\r\n              <div style=\"text-align: left;\">\r\n                <div style=\"background-color: #d4edda; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                  <h4 style=\"margin: 0 0 8px 0; color: #155724;\">‚úÖ Conexi√≥n exitosa</h4>\r\n                  <p style=\"margin: 0; font-size: 14px;\">La API Key es v√°lida y todas las funcionalidades est√°n activas.</p>\r\n                </div>\r\n                <div style=\"background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n                  <h4 style=\"margin: 0 0 8px 0; color: #333;\">Configuraci√≥n guardada:</h4>\r\n                  <p style=\"margin: 4px 0; font-size: 14px;\">\r\n                    <strong>Modelo:</strong> ${availableModels.find(m => m.id === formValues.model)?.name}<br>\r\n                    <strong>Temperatura:</strong> ${formValues.temperature}<br>\r\n                    <strong>Tokens m√°ximos:</strong> ${formValues.maxTokens}<br>\r\n                    <strong>Respuesta de prueba:</strong> \"${testResult.testResponse}\"\r\n                  </p>\r\n                </div>\r\n                <div style=\"background-color: #e8f4fd; padding: 12px; border-radius: 4px; margin-top: 12px;\">\r\n                  <h4 style=\"margin: 0 0 8px 0; color: #0066ff;\">üìä Estad√≠sticas de la prueba:</h4>\r\n                  <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                    <li>‚Ä¢ Tokens de entrada: ${testResult.inputTokens || 'N/A'}</li>\r\n                    <li>‚Ä¢ Tokens de salida: ${testResult.outputTokens || 'N/A'}</li>\r\n                    <li>‚Ä¢ Tiempo de respuesta: ${testResult.responseTime || 'N/A'}ms</li>\r\n                  </ul>\r\n                </div>\r\n              </div>\r\n            `,\r\n            icon: 'success',\r\n            confirmButtonText: '¬°Perfecto!',\r\n            confirmButtonColor: '#00a67e',\r\n            width: '500px'\r\n          });\r\n\r\n          toast.success('Groq AI configurado exitosamente');\r\n        } else {\r\n          throw new Error(testResult.error || 'Error al conectar con Groq');\r\n        }\r\n      } catch (error) {\r\n        console.error('Error configuring Groq:', error);\r\n        \r\n        // Restaurar estado\r\n        setIntegrations(prev => ({\r\n          ...prev,\r\n          groq: {\r\n            connected: false,\r\n            status: 'disconnected',\r\n            lastSync: null,\r\n            model: 'gemma2-9b-it'\r\n          }\r\n        }));\r\n\r\n        // Limpiar configuraci√≥n guardada usando el servicio centralizado\r\n        try {\r\n          await configurationService.setConfig('integrations', 'groq', {}, 'global', null, 'Configuraci√≥n de Groq AI - Error')\r\n        } catch (cleanupError) {\r\n          console.error('Error cleaning up Groq configuration:', cleanupError)\r\n        }\r\n\r\n        // Mostrar error\r\n        await Swal.fire({\r\n          title: '‚ùå Error de Conexi√≥n',\r\n          html: `\r\n            <div style=\"text-align: left;\">\r\n              <div style=\"background-color: #f8d7da; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #721c24;\">No se pudo conectar con Groq</h4>\r\n                <p style=\"margin: 0; font-size: 14px;\"><strong>Error:</strong> ${error.message}</p>\r\n              </div>\r\n              <div style=\"background-color: #fff3cd; padding: 12px; border-radius: 4px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #856404;\">üîç Posibles soluciones:</h4>\r\n                <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                  <li>‚Ä¢ Verifica que la API Key sea correcta</li>\r\n                  <li>‚Ä¢ Aseg√∫rate de que la API Key comience con \"gsk_\"</li>\r\n                  <li>‚Ä¢ Revisa que tu cuenta de Groq est√© activa</li>\r\n                  <li>‚Ä¢ Verifica tu conexi√≥n a internet</li>\r\n                  <li>‚Ä¢ Confirma que tienes cr√©ditos disponibles</li>\r\n                </ul>\r\n              </div>\r\n            </div>\r\n          `,\r\n          icon: 'error',\r\n          confirmButtonText: 'Reintentar',\r\n          confirmButtonColor: '#dc3545',\r\n          width: '500px'\r\n        });\r\n\r\n        toast.error('Error al configurar Groq AI');\r\n      }\r\n    }\r\n  };\r\n\r\n  // Funci√≥n para probar la conexi√≥n con Groq\r\n  const testGroqConnection = async (apiKey, model) => {\r\n    try {\r\n      const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Authorization': `Bearer ${apiKey}`,\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify({\r\n          model: model,\r\n          messages: [\r\n            {\r\n              role: 'user',\r\n              content: 'Responde con \"Conexi√≥n exitosa\" si puedes leer este mensaje.'\r\n            }\r\n          ],\r\n          max_tokens: 10,\r\n          temperature: 0.1\r\n        })\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n      }\r\n\r\n      const data = await response.json();\r\n      const testResponse = data.choices?.[0]?.message?.content || 'No response';\r\n      \r\n      return {\r\n        success: true,\r\n        testResponse: testResponse,\r\n        inputTokens: data.usage?.prompt_tokens,\r\n        outputTokens: data.usage?.completion_tokens,\r\n        responseTime: data.response_time || 'N/A'\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        error: error.message\r\n      };\r\n    }\r\n  };\r\n\r\n  const showWhatsAppConfig = async () => {\r\n    const { value: formValues } = await Swal.fire({\r\n      title: 'Configurar WhatsApp Business API',\r\n      html: `\r\n        <div style=\"text-align: left;\">\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Access Token de Meta:</label>\r\n            <input type=\"password\" id=\"whatsapp-access-token\" class=\"swal2-input\" placeholder=\"EA...\">\r\n            <div style=\"font-size: 12px; color: #666; margin-top: 4px;\">\r\n              Obt√©n tu token en{' '}\r\n              <a href=\"https://developers.facebook.com/docs/whatsapp/business-management-api/get-started\" target=\"_blank\" style=\"color: #25d366;\">\r\n                Meta for Developers\r\n              </a>\r\n            </div>\r\n          </div>\r\n          \r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Phone Number ID:</label>\r\n            <input type=\"text\" id=\"whatsapp-phone-number-id\" class=\"swal2-input\" placeholder=\"123456789...\">\r\n            <div style=\"font-size: 12px; color: #666; margin-top: 4px;\">\r\n              ID num√©rico de tu n√∫mero de WhatsApp Business\r\n            </div>\r\n          </div>\r\n\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Webhook Verify Token:</label>\r\n            <input type=\"text\" id=\"whatsapp-webhook-token\" class=\"swal2-input\" placeholder=\"Token opcional\">\r\n            <div style=\"font-size: 12px; color: #666; margin-top: 4px;\">\r\n              Opcional: Token para verificar webhooks entrantes\r\n            </div>\r\n          </div>\r\n\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: flex; align-items: center; cursor: pointer;\">\r\n              <input type=\"checkbox\" id=\"whatsapp-test-mode\" style=\"margin-right: 8px;\" checked>\r\n              <span style=\"font-weight: 600;\">Modo de prueba</span>\r\n            </label>\r\n            <p style=\"font-size: 12px; color: #666; margin-top: 4px; margin-left: 20px;\">\r\n              En modo prueba, los mensajes se enviar√°n solo para testing\r\n            </p>\r\n          </div>\r\n\r\n          <div style=\"font-size: 12px; color: #666; margin-top: 16px; background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n            <strong style=\"color: #25d366;\">üìã Instrucciones para obtener credenciales:</strong><br>\r\n            1. Ve a <a href=\"https://business.facebook.com/wa/manage\" target=\"_blank\" style=\"color: #25d366;\">Meta Business Suite</a><br>\r\n            2. Selecciona tu cuenta de WhatsApp Business<br>\r\n            3. Ve a Configuraci√≥n ‚Üí API de WhatsApp<br>\r\n            4. Genera un Access Token de sistema<br>\r\n            5. Copia el Phone Number ID y el Access Token aqu√≠\r\n          </div>\r\n          \r\n          <div style=\"font-size: 12px; color: #666; margin-top: 12px; background-color: #e8f4fd; padding: 12px; border-radius: 4px;\">\r\n            <strong style=\"color: #25d366;\">üöÄ Funcionalidades incluidas:</strong><br>\r\n            ‚Ä¢ Env√≠o de mensajes individuales y masivos<br>\r\n            ‚Ä¢ Plantillas de mensaje pre-aprobadas<br>\r\n            ‚Ä¢ Webhooks para estado de entrega en tiempo real<br>\r\n            ‚Ä¢ Estad√≠sticas detalladas de uso<br>\r\n            ‚Ä¢ Integraci√≥n con sistema de comunicaci√≥n existente<br>\r\n            ‚Ä¢ Costo: ~$0.0525 USD por mensaje\r\n          </div>\r\n        </div>\r\n      `,\r\n      focusConfirm: false,\r\n      preConfirm: () => {\r\n        const accessToken = document.getElementById('whatsapp-access-token').value;\r\n        const phoneNumberId = document.getElementById('whatsapp-phone-number-id').value;\r\n        const webhookToken = document.getElementById('whatsapp-webhook-token').value;\r\n        const testMode = document.getElementById('whatsapp-test-mode').checked;\r\n\r\n        if (!accessToken) {\r\n          Swal.showValidationMessage('El Access Token es obligatorio');\r\n          return false;\r\n        }\r\n\r\n        if (!accessToken.startsWith('EA') && !accessToken.startsWith('EAA')) {\r\n          Swal.showValidationMessage('El Access Token debe comenzar con EA o EAA');\r\n          return false;\r\n        }\r\n\r\n        if (!phoneNumberId) {\r\n          Swal.showValidationMessage('El Phone Number ID es obligatorio');\r\n          return false;\r\n        }\r\n\r\n        if (!/^d+$/.test(phoneNumberId)) {\r\n          Swal.showValidationMessage('El Phone Number ID debe contener solo n√∫meros');\r\n          return false;\r\n        }\r\n\r\n        return { accessToken, phoneNumberId, webhookToken, testMode };\r\n      },\r\n      showCancelButton: true,\r\n      confirmButtonText: 'Conectar y Probar',\r\n      cancelButtonText: 'Cancelar',\r\n      confirmButtonColor: '#25d366',\r\n      width: '600px'\r\n    });\r\n\r\n    if (formValues) {\r\n      // Mostrar estado de conexi√≥n\r\n      setIntegrations(prev => ({ ...prev, whatsapp: { ...prev.whatsapp, status: 'connecting' } }));\r\n\r\n      try {\r\n        // Probar conexi√≥n usando communicationService\r\n        const testResult = await communicationService.testWhatsAppConnection();\r\n\r\n        if (testResult.success) {\r\n          // Actualizar estado\r\n          setIntegrations(prev => ({\r\n            ...prev,\r\n            whatsapp: {\r\n              connected: true,\r\n              status: 'connected',\r\n              lastSync: new Date().toISOString(),\r\n              testMode: formValues.testMode\r\n            }\r\n          }));\r\n\r\n          // Mostrar √©xito\r\n          await Swal.fire({\r\n            title: 'üéâ WhatsApp Configurado Exitosamente',\r\n            html: `\r\n              <div style=\"text-align: left;\">\r\n                <div style=\"background-color: #d4edda; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                  <h4 style=\"margin: 0 0 8px 0; color: #155724;\">‚úÖ Conexi√≥n exitosa</h4>\r\n                  <p style=\"margin: 0; font-size: 14px;\">La API de WhatsApp est√° funcionando correctamente.</p>\r\n                </div>\r\n                <div style=\"background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n                  <h4 style=\"margin: 0 0 8px 0; color: #333;\">Informaci√≥n del n√∫mero:</h4>\r\n                  <p style=\"margin: 4px 0; font-size: 14px;\">\r\n                    <strong>N√∫mero:</strong> ${testResult.phoneInfo?.name || 'Configurado'}<br>\r\n                    <strong>Nombre verificado:</strong> ${testResult.phoneInfo?.verifiedName || 'Pendiente'}<br>\r\n                    <strong>Modo:</strong> ${formValues.testMode ? 'Prueba üß™' : 'Producci√≥n üöÄ'}\r\n                  </p>\r\n                </div>\r\n                <div style=\"background-color: #e8f4fd; padding: 12px; border-radius: 4px; margin-top: 12px;\">\r\n                  <h4 style=\"margin: 0 0 8px 0; color: #25d366;\">üìä Funcionalidades activas:</h4>\r\n                  <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                    <li>‚úÖ Env√≠o de mensajes individuales</li>\r\n                    <li>‚úÖ Env√≠o masivo de mensajes</li>\r\n                    <li>‚úÖ Plantillas de mensaje pre-aprobadas</li>\r\n                    <li>‚úÖ Webhooks para estado de entrega</li>\r\n                    <li>‚úÖ Estad√≠sticas en tiempo real</li>\r\n                    <li>‚úÖ Integraci√≥n con sistema de comunicaci√≥n</li>\r\n                  </ul>\r\n                </div>\r\n              </div>\r\n            `,\r\n            icon: 'success',\r\n            confirmButtonText: '¬°Perfecto!',\r\n            confirmButtonColor: '#25d366',\r\n            width: '500px'\r\n          });\r\n\r\n          toast.success('WhatsApp configurado exitosamente');\r\n        } else {\r\n          throw new Error(testResult.error || 'Error al conectar con WhatsApp');\r\n        }\r\n      } catch (error) {\r\n        console.error('Error configuring WhatsApp:', error);\r\n        \r\n        // Restaurar estado\r\n        setIntegrations(prev => ({\r\n          ...prev,\r\n          whatsapp: {\r\n            connected: false,\r\n            status: 'disconnected',\r\n            lastSync: null,\r\n            testMode: false\r\n          }\r\n        }));\r\n\r\n        // Mostrar error\r\n        await Swal.fire({\r\n          title: '‚ùå Error de Conexi√≥n',\r\n          html: `\r\n            <div style=\"text-align: left;\">\r\n              <div style=\"background-color: #f8d7da; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #721c24;\">No se pudo conectar con WhatsApp</h4>\r\n                <p style=\"margin: 0; font-size: 14px;\"><strong>Error:</strong> ${error.message}</p>\r\n              </div>\r\n              <div style=\"background-color: #fff3cd; padding: 12px; border-radius: 4px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #856404;\">üîç Posibles soluciones:</h4>\r\n                <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                  <li>‚Ä¢ Verifica que el Access Token sea correcto</li>\r\n                  <li>‚Ä¢ Aseg√∫rate de que el Phone Number ID sea v√°lido</li>\r\n                  <li>‚Ä¢ Revisa que tu n√∫mero de WhatsApp est√© verificado</li>\r\n                  <li>‚Ä¢ Verifica los permisos del token</li>\r\n                  <li>‚Ä¢ Revisa tu conexi√≥n a internet</li>\r\n                </ul>\r\n              </div>\r\n            </div>\r\n          `,\r\n          icon: 'error',\r\n          confirmButtonText: 'Reintentar',\r\n          confirmButtonColor: '#dc3545',\r\n          width: '500px'\r\n        });\r\n\r\n        toast.error('Error al configurar WhatsApp');\r\n      }\r\n    }\r\n  };\r\n\r\n  const configureTelegram = async () => {\r\n    const { value: formValues } = await Swal.fire({\r\n      title: 'Configurar Telegram Bot',\r\n      html: `\r\n        <div style=\"text-align: left;\">\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Bot Token:</label>\r\n            <input type=\"password\" id=\"telegram-bot-token\" class=\"swal2-input\" placeholder=\"1234567890:ABCdefGHIjklMNOpqrsTUVwxyz\">\r\n            <div style=\"font-size: 12px; color: #666; margin-top: 4px;\">\r\n              Obt√©n tu token en <a href=\"https://t.me/BotFather\" target=\"_blank\" style=\"color: #0088cc;\">@BotFather</a>\r\n            </div>\r\n          </div>\r\n          \r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Bot Username:</label>\r\n            <input type=\"text\" id=\"telegram-bot-username\" class=\"swal2-input\" placeholder=\"@tu_bot\">\r\n            <div style=\"font-size: 12px; color: #666; margin-top: 4px;\">\r\n              El nombre de usuario de tu bot (con @)\r\n            </div>\r\n          </div>\r\n\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Chat ID (opcional):</label>\r\n            <input type=\"text\" id=\"telegram-chat-id\" class=\"swal2-input\" placeholder=\"123456789\">\r\n            <div style=\"font-size: 12px; color: #666; margin-top: 4px;\">\r\n              ID del chat para enviar mensajes de prueba\r\n            </div>\r\n          </div>\r\n\r\n          <div style=\"font-size: 12px; color: #666; margin-top: 16px; background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n            <strong style=\"color: #0088cc;\">üìã Instrucciones para obtener Bot Token:</strong><br>\r\n            1. Ve a <a href=\"https://t.me/BotFather\" target=\"_blank\" style=\"color: #0088cc;\">@BotFather</a> en Telegram<br>\r\n            2. Env√≠a el comando /newbot<br>\r\n            3. Sigue las instrucciones para crear tu bot<br>\r\n            4. Copia el token que te proporciona BotFather\r\n          </div>\r\n          \r\n          <div style=\"font-size: 12px; color: #666; margin-top: 12px; background-color: #e8f4fd; padding: 12px; border-radius: 4px;\">\r\n            <strong style=\"color: #0088cc;\">üöÄ Funcionalidades incluidas:</strong><br>\r\n            ‚Ä¢ Env√≠o de mensajes individuales y masivos<br>\r\n            ‚Ä¢ Notificaciones autom√°ticas<br>\r\n            ‚Ä¢ Integraci√≥n con sistema de comunicaci√≥n<br>\r\n            ‚Ä¢ Soporte para mensajes formateados<br>\r\n            ‚Ä¢ Entrega de archivos y documentos\r\n          </div>\r\n        </div>\r\n      `,\r\n      focusConfirm: false,\r\n      preConfirm: () => {\r\n        const botToken = document.getElementById('telegram-bot-token').value;\r\n        const botUsername = document.getElementById('telegram-bot-username').value;\r\n        const chatId = document.getElementById('telegram-chat-id').value;\r\n\r\n        if (!botToken) {\r\n          Swal.showValidationMessage('El Bot Token es obligatorio');\r\n          return false;\r\n        }\r\n\r\n        if (!botToken.match(/^d+:[A-Za-z0-9_-]+$/)) {\r\n          Swal.showValidationMessage('El formato del Bot Token es inv√°lido');\r\n          return false;\r\n        }\r\n\r\n        if (!botUsername) {\r\n          Swal.showValidationMessage('El Bot Username es obligatorio');\r\n          return false;\r\n        }\r\n\r\n        if (!botUsername.startsWith('@')) {\r\n          Swal.showValidationMessage('El Bot Username debe comenzar con @');\r\n          return false;\r\n        }\r\n\r\n        return { botToken, botUsername, chatId };\r\n      },\r\n      showCancelButton: true,\r\n      confirmButtonText: 'Conectar y Probar',\r\n      cancelButtonText: 'Cancelar',\r\n      confirmButtonColor: '#0088cc',\r\n      width: '600px'\r\n    });\r\n\r\n    if (formValues) {\r\n      // Mostrar estado de conexi√≥n\r\n      setIntegrations(prev => ({ ...prev, telegram: { ...prev.telegram, status: 'connecting' } }));\r\n\r\n      try {\r\n        // Guardar configuraci√≥n usando configurationService\r\n        await configurationService.setConfig('integrations', 'telegram', {\r\n          botToken: formValues.botToken,\r\n          botUsername: formValues.botUsername,\r\n          chatId: formValues.chatId || null\r\n        }, 'global', null, 'Configuraci√≥n de Telegram Bot')\r\n\r\n        // Probar conexi√≥n con Telegram\r\n        const testResult = await testTelegramConnection(formValues.botToken, formValues.botUsername);\r\n\r\n        if (testResult.success) {\r\n          // Actualizar estado\r\n          setIntegrations(prev => ({\r\n            ...prev,\r\n            telegram: {\r\n              connected: true,\r\n              status: 'connected',\r\n              lastSync: new Date().toISOString(),\r\n              botToken: formValues.botToken,\r\n              botUsername: formValues.botUsername,\r\n              chatId: formValues.chatId\r\n            }\r\n          }));\r\n\r\n          // Mostrar √©xito\r\n          await Swal.fire({\r\n            title: 'üéâ Telegram Configurado Exitosamente',\r\n            html: `\r\n              <div style=\"text-align: left;\">\r\n                <div style=\"background-color: #d4edda; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                  <h4 style=\"margin: 0 0 8px 0; color: #155724;\">‚úÖ Conexi√≥n exitosa</h4>\r\n                  <p style=\"margin: 0; font-size: 14px;\">El bot est√° funcionando correctamente.</p>\r\n                </div>\r\n                <div style=\"background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n                  <h4 style=\"margin: 0 0 8px 0; color: #333;\">Informaci√≥n del bot:</h4>\r\n                  <p style=\"margin: 4px 0; font-size: 14px;\">\r\n                    <strong>Nombre:</strong> ${testResult.botInfo?.first_name || 'Configurado'}<br>\r\n                    <strong>Username:</strong> ${testResult.botInfo?.username || formValues.botUsername}<br>\r\n                    <strong>Chat ID:</strong> ${formValues.chatId || 'No configurado'}\r\n                  </p>\r\n                </div>\r\n                <div style=\"background-color: #e8f4fd; padding: 12px; border-radius: 4px; margin-top: 12px;\">\r\n                  <h4 style=\"margin: 0 0 8px 0; color: #0088cc;\">üìä Funcionalidades activas:</h4>\r\n                  <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                    <li>‚úÖ Env√≠o de mensajes individuales</li>\r\n                    <li>‚úÖ Env√≠o masivo de mensajes</li>\r\n                    <li>‚úÖ Notificaciones autom√°ticas</li>\r\n                    <li>‚úÖ Integraci√≥n con sistema de comunicaci√≥n</li>\r\n                    <li>‚úÖ Soporte para mensajes formateados</li>\r\n                  </ul>\r\n                </div>\r\n              </div>\r\n            `,\r\n            icon: 'success',\r\n            confirmButtonText: '¬°Perfecto!',\r\n            confirmButtonColor: '#0088cc',\r\n            width: '500px'\r\n          });\r\n\r\n          toast.success('Telegram configurado exitosamente');\r\n        } else {\r\n          throw new Error(testResult.error || 'Error al conectar con Telegram');\r\n        }\r\n      } catch (error) {\r\n        console.error('Error configuring Telegram:', error);\r\n        \r\n        // Restaurar estado\r\n        setIntegrations(prev => ({\r\n          ...prev,\r\n          telegram: {\r\n            connected: false,\r\n            status: 'disconnected',\r\n            lastSync: null\r\n          }\r\n        }));\r\n\r\n        // Limpiar configuraci√≥n guardada usando configurationService\r\n        try {\r\n          await configurationService.setConfig('integrations', 'telegram', {}, 'global', null, 'Configuraci√≥n de Telegram Bot - Error')\r\n        } catch (cleanupError) {\r\n          console.error('Error cleaning up Telegram configuration:', cleanupError)\r\n        }\r\n\r\n        // Mostrar error\r\n        await Swal.fire({\r\n          title: '‚ùå Error de Conexi√≥n',\r\n          html: `\r\n            <div style=\"text-align: left;\">\r\n              <div style=\"background-color: #f8d7da; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #721c24;\">No se pudo conectar con Telegram</h4>\r\n                <p style=\"margin: 0; font-size: 14px;\"><strong>Error:</strong> ${error.message}</p>\r\n              </div>\r\n              <div style=\"background-color: #fff3cd; padding: 12px; border-radius: 4px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #856404;\">üîç Posibles soluciones:</h4>\r\n                <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                  <li>‚Ä¢ Verifica que el Bot Token sea correcto</li>\r\n                  <li>‚Ä¢ Aseg√∫rate de que el bot est√© activo</li>\r\n                  <li>‚Ä¢ Revisa que el username sea correcto</li>\r\n                  <li>‚Ä¢ Verifica tu conexi√≥n a internet</li>\r\n                  <li>‚Ä¢ Confirma que el token no haya expirado</li>\r\n                </ul>\r\n              </div>\r\n            </div>\r\n          `,\r\n          icon: 'error',\r\n          confirmButtonText: 'Reintentar',\r\n          confirmButtonColor: '#dc3545',\r\n          width: '500px'\r\n        });\r\n\r\n        toast.error('Error al configurar Telegram');\r\n      }\r\n    }\r\n  };\r\n\r\n  // Funci√≥n para probar la conexi√≥n con Telegram\r\n  const testTelegramConnection = async (botToken, botUsername) => {\r\n    try {\r\n      const response = await fetch(`https://api.telegram.org/bot${botToken}/getMe`);\r\n      \r\n      if (!response.ok) {\r\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n      }\r\n\r\n      const data = await response.json();\r\n      \r\n      if (data.ok) {\r\n        return {\r\n          success: true,\r\n          botInfo: data.result\r\n        };\r\n      } else {\r\n        throw new Error(data.description || 'Error al conectar con el bot');\r\n      }\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        error: error.message\r\n      };\r\n    }\r\n  };\r\n\r\n  // Funci√≥n para configurar WhatsApp Official API\r\n  const configureWhatsAppOfficial = async () => {\r\n    const { value: formValues } = await Swal.fire({\r\n      title: 'Configurar WhatsApp Official API',\r\n      html: `\r\n        <div style=\"text-align: left;\">\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Access Token de Meta:</label>\r\n            <input type=\"password\" id=\"whatsapp-official-access-token\" class=\"swal2-input\" placeholder=\"EA...\">\r\n            <div style=\"font-size: 12px; color: #666; margin-top: 4px;\">\r\n              Obt√©n tu token en{' '}\r\n              <a href=\"https://developers.facebook.com/docs/whatsapp/business-management-api/get-started\" target=\"_blank\" style=\"color: #25d366;\">\r\n                Meta for Developers\r\n              </a>\r\n            </div>\r\n          </div>\r\n          \r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Phone Number ID:</label>\r\n            <input type=\"text\" id=\"whatsapp-official-phone-number-id\" class=\"swal2-input\" placeholder=\"123456789...\">\r\n            <div style=\"font-size: 12px; color: #666; margin-top: 4px;\">\r\n              ID num√©rico de tu n√∫mero de WhatsApp Business\r\n            </div>\r\n          </div>\r\n\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Webhook Verify Token:</label>\r\n            <input type=\"text\" id=\"whatsapp-official-webhook-token\" class=\"swal2-input\" placeholder=\"Token opcional\">\r\n            <div style=\"font-size: 12px; color: #666; margin-top: 4px;\">\r\n              Opcional: Token para verificar webhooks entrantes\r\n            </div>\r\n          </div>\r\n\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: flex; align-items: center; cursor: pointer;\">\r\n              <input type=\"checkbox\" id=\"whatsapp-official-test-mode\" style=\"margin-right: 8px;\" checked>\r\n              <span style=\"font-weight: 600;\">Modo de prueba</span>\r\n            </label>\r\n            <p style=\"font-size: 12px; color: #666; margin-top: 4px; margin-left: 20px;\">\r\n              En modo prueba, los mensajes se enviar√°n solo para testing\r\n            </p>\r\n          </div>\r\n\r\n          <div style=\"font-size: 12px; color: #666; margin-top: 16px; background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n            <strong style=\"color: #25d366;\">üìã Instrucciones para obtener credenciales:</strong><br>\r\n            1. Ve a <a href=\"https://business.facebook.com/wa/manage\" target=\"_blank\" style=\"color: #25d366;\">Meta Business Suite</a><br>\r\n            2. Selecciona tu cuenta de WhatsApp Business<br>\r\n            3. Ve a Configuraci√≥n ‚Üí API de WhatsApp<br>\r\n            4. Genera un Access Token de sistema<br>\r\n            5. Copia el Phone Number ID y el Access Token aqu√≠\r\n          </div>\r\n          \r\n          <div style=\"font-size: 12px; color: #666; margin-top: 12px; background-color: #e8f4fd; padding: 12px; border-radius: 4px;\">\r\n            <strong style=\"color: #25d366;\">üöÄ Funcionalidades incluidas:</strong><br>\r\n            ‚Ä¢ Env√≠o de mensajes individuales y masivos<br>\r\n            ‚Ä¢ Plantillas de mensaje pre-aprobadas<br>\r\n            ‚Ä¢ Webhooks para estado de entrega en tiempo real<br>\r\n            ‚Ä¢ Estad√≠sticas detalladas de uso<br>\r\n            ‚Ä¢ Integraci√≥n con sistema de comunicaci√≥n existente<br>\r\n            ‚Ä¢ Costo: ~$0.0525 USD por mensaje\r\n          </div>\r\n        </div>\r\n      `,\r\n      focusConfirm: false,\r\n      preConfirm: () => {\r\n        const accessToken = document.getElementById('whatsapp-official-access-token').value;\r\n        const phoneNumberId = document.getElementById('whatsapp-official-phone-number-id').value;\r\n        const webhookToken = document.getElementById('whatsapp-official-webhook-token').value;\r\n        const testMode = document.getElementById('whatsapp-official-test-mode').checked;\r\n\r\n        if (!accessToken) {\r\n          Swal.showValidationMessage('El Access Token es obligatorio');\r\n          return false;\r\n        }\r\n\r\n        if (!accessToken.startsWith('EA') && !accessToken.startsWith('EAA')) {\r\n          Swal.showValidationMessage('El Access Token debe comenzar con EA o EAA');\r\n          return false;\r\n        }\r\n\r\n        if (!phoneNumberId) {\r\n          Swal.showValidationMessage('El Phone Number ID es obligatorio');\r\n          return false;\r\n        }\r\n\r\n        if (!/^d+$/.test(phoneNumberId)) {\r\n          Swal.showValidationMessage('El Phone Number ID debe contener solo n√∫meros');\r\n          return false;\r\n        }\r\n\r\n        return { accessToken, phoneNumberId, webhookToken, testMode };\r\n      },\r\n      showCancelButton: true,\r\n      confirmButtonText: 'Conectar y Probar',\r\n      cancelButtonText: 'Cancelar',\r\n      confirmButtonColor: '#25d366',\r\n      width: '600px'\r\n    });\r\n\r\n    if (formValues) {\r\n      // Mostrar estado de conexi√≥n\r\n      setIntegrations(prev => ({ ...prev, whatsappOfficial: { ...prev.whatsappOfficial, status: 'connecting' } }));\r\n\r\n      try {\r\n        // Configurar el servicio de WhatsApp Official\r\n        const config = {\r\n          accessToken: formValues.accessToken,\r\n          phoneNumberId: formValues.phoneNumberId,\r\n          webhookVerifyToken: formValues.webhookToken,\r\n          testMode: formValues.testMode\r\n        };\r\n\r\n        // Guardar configuraci√≥n\r\n        whatsappOfficialService.saveConfiguration(config);\r\n\r\n        // Probar conexi√≥n\r\n        const testResult = await whatsappOfficialService.testConnection();\r\n\r\n        if (testResult.success) {\r\n          // Actualizar estado\r\n          setIntegrations(prev => ({\r\n            ...prev,\r\n            whatsappOfficial: {\r\n              connected: true,\r\n              status: 'connected',\r\n              lastSync: new Date().toISOString(),\r\n              testMode: formValues.testMode\r\n            }\r\n          }));\r\n\r\n          // Mostrar √©xito\r\n          await Swal.fire({\r\n            title: 'üéâ WhatsApp Official Configurado Exitosamente',\r\n            html: `\r\n              <div style=\"text-align: left;\">\r\n                <div style=\"background-color: #d4edda; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                  <h4 style=\"margin: 0 0 8px 0; color: #155724;\">‚úÖ Conexi√≥n exitosa</h4>\r\n                  <p style=\"margin: 0; font-size: 14px;\">La API oficial de WhatsApp est√° funcionando correctamente.</p>\r\n                </div>\r\n                <div style=\"background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n                  <h4 style=\"margin: 0 0 8px 0; color: #333;\">Informaci√≥n del n√∫mero:</h4>\r\n                  <p style=\"margin: 4px 0; font-size: 14px;\">\r\n                    <strong>N√∫mero:</strong> ${testResult.phoneInfo?.name || 'Configurado'}<br>\r\n                    <strong>Nombre verificado:</strong> ${testResult.phoneInfo?.verifiedName || 'Pendiente'}<br>\r\n                    <strong>Modo:</strong> ${formValues.testMode ? 'Prueba üß™' : 'Producci√≥n üöÄ'}\r\n                  </p>\r\n                </div>\r\n                <div style=\"background-color: #e8f4fd; padding: 12px; border-radius: 4px; margin-top: 12px;\">\r\n                  <h4 style=\"margin: 0 0 8px 0; color: #25d366;\">üìä Funcionalidades activas:</h4>\r\n                  <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                    <li>‚úÖ Env√≠o de mensajes individuales</li>\r\n                    <li>‚úÖ Env√≠o masivo de mensajes</li>\r\n                    <li>‚úÖ Plantillas de mensaje pre-aprobadas</li>\r\n                    <li>‚úÖ Webhooks para estado de entrega</li>\r\n                    <li>‚úÖ Estad√≠sticas en tiempo real</li>\r\n                    <li>‚úÖ Integraci√≥n con sistema de comunicaci√≥n</li>\r\n                  </ul>\r\n                </div>\r\n              </div>\r\n            `,\r\n            icon: 'success',\r\n            confirmButtonText: '¬°Perfecto!',\r\n            confirmButtonColor: '#25d366',\r\n            width: '500px'\r\n          });\r\n\r\n          toast.success('WhatsApp Official configurado exitosamente');\r\n        } else {\r\n          throw new Error(testResult.error || 'Error al conectar con WhatsApp Official');\r\n        }\r\n      } catch (error) {\r\n        console.error('Error configuring WhatsApp Official:', error);\r\n        \r\n        // Restaurar estado\r\n        setIntegrations(prev => ({\r\n          ...prev,\r\n          whatsappOfficial: {\r\n            connected: false,\r\n            status: 'disconnected',\r\n            lastSync: null,\r\n            testMode: false\r\n          }\r\n        }));\r\n\r\n        // Limpiar configuraci√≥n guardada\r\n        whatsappOfficialService.clearConfiguration();\r\n\r\n        // Mostrar error\r\n        await Swal.fire({\r\n          title: '‚ùå Error de Conexi√≥n',\r\n          html: `\r\n            <div style=\"text-align: left;\">\r\n              <div style=\"background-color: #f8d7da; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #721c24;\">No se pudo conectar con WhatsApp Official</h4>\r\n                <p style=\"margin: 0; font-size: 14px;\"><strong>Error:</strong> ${error.message}</p>\r\n              </div>\r\n              <div style=\"background-color: #fff3cd; padding: 12px; border-radius: 4px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #856404;\">üîç Posibles soluciones:</h4>\r\n                <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                  <li>‚Ä¢ Verifica que el Access Token sea correcto</li>\r\n                  <li>‚Ä¢ Aseg√∫rate de que el Phone Number ID sea v√°lido</li>\r\n                  <li>‚Ä¢ Revisa que tu n√∫mero de WhatsApp est√© verificado</li>\r\n                  <li>‚Ä¢ Verifica los permisos del token</li>\r\n                  <li>‚Ä¢ Revisa tu conexi√≥n a internet</li>\r\n                </ul>\r\n              </div>\r\n            </div>\r\n          `,\r\n          icon: 'error',\r\n          confirmButtonText: 'Reintentar',\r\n          confirmButtonColor: '#dc3545',\r\n          width: '500px'\r\n        });\r\n\r\n        toast.error('Error al configurar WhatsApp Official');\r\n      }\r\n    }\r\n  };\r\n\r\n  // Funci√≥n para configurar WhatsApp WAHA API\r\n  const configureWhatsAppWaha = async () => {\r\n    const { value: formValues } = await Swal.fire({\r\n      title: 'Configurar WhatsApp WAHA API',\r\n      html: `\r\n        <div style=\"text-align: left;\">\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">API Key de WAHA:</label>\r\n            <input type=\"password\" id=\"whatsapp-waha-api-key\" class=\"swal2-input\" placeholder=\"waha_...\">\r\n            <div style=\"font-size: 12px; color: #666; margin-top: 4px;\">\r\n              Obt√©n tu API Key en <a href=\"https://waha.devike.pro\" target=\"_blank\" style=\"color: #9333ea;\">waha.devike.pro</a>\r\n            </div>\r\n          </div>\r\n          \r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">Session ID:</label>\r\n            <input type=\"text\" id=\"whatsapp-waha-session-id\" class=\"swal2-input\" placeholder=\"session-default\">\r\n            <div style=\"font-size: 12px; color: #666; margin-top: 4px;\">\r\n              Identificador √∫nico para tu sesi√≥n de WhatsApp\r\n            </div>\r\n          </div>\r\n\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">URL del servidor WAHA:</label>\r\n            <input type=\"text\" id=\"whatsapp-waha-url\" class=\"swal2-input\" placeholder=\"https://waha.devike.pro\" value=\"https://waha.devike.pro\">\r\n            <div style=\"font-size: 12px; color: #666; margin-top: 4px;\">\r\n              URL del servidor de WAHA API\r\n            </div>\r\n          </div>\r\n\r\n          <div style=\"margin-bottom: 16px;\">\r\n            <label style=\"display: flex; align-items: center; cursor: pointer;\">\r\n              <input type=\"checkbox\" id=\"whatsapp-waha-test-mode\" style=\"margin-right: 8px;\" checked>\r\n              <span style=\"font-weight: 600;\">Modo de prueba</span>\r\n            </label>\r\n            <p style=\"font-size: 12px; color: #666; margin-top: 4px; margin-left: 20px;\">\r\n              En modo prueba, los mensajes se enviar√°n solo para testing\r\n            </p>\r\n          </div>\r\n\r\n          <div style=\"font-size: 12px; color: #666; margin-top: 16px; background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n            <strong style=\"color: #9333ea;\">üìã Instrucciones para obtener credenciales:</strong><br>\r\n            1. Ve a <a href=\"https://waha.devike.pro\" target=\"_blank\" style=\"color: #9333ea;\">waha.devike.pro</a><br>\r\n            2. Reg√≠stra tu cuenta y obt√©n tu API Key<br>\r\n            3. Crea una nueva sesi√≥n de WhatsApp<br>\r\n            4. Escanea el c√≥digo QR con tu WhatsApp<br>\r\n            5. Copia el Session ID y la API Key aqu√≠\r\n          </div>\r\n          \r\n          <div style=\"font-size: 12px; color: #666; margin-top: 12px; background-color: #e8f4fd; padding: 12px; border-radius: 4px;\">\r\n            <strong style=\"color: #9333ea;\">üöÄ Funcionalidades incluidas:</strong><br>\r\n            ‚Ä¢ Env√≠o de mensajes individuales y masivos<br>\r\n            ‚Ä¢ Env√≠o de archivos y documentos<br>\r\n            ‚Ä¢ Env√≠o de ubicaciones y contactos<br>\r\n            ‚Ä¢ Gesti√≥n de sesiones m√∫ltiples<br>\r\n            ‚Ä¢ Estad√≠sticas de uso en tiempo real<br>\r\n            ‚Ä¢ Integraci√≥n con sistema de comunicaci√≥n existente\r\n          </div>\r\n        </div>\r\n      `,\r\n      focusConfirm: false,\r\n      preConfirm: () => {\r\n        const apiKey = document.getElementById('whatsapp-waha-api-key').value;\r\n        const sessionId = document.getElementById('whatsapp-waha-session-id').value;\r\n        const serverUrl = document.getElementById('whatsapp-waha-url').value;\r\n        const testMode = document.getElementById('whatsapp-waha-test-mode').checked;\r\n\r\n        if (!apiKey) {\r\n          Swal.showValidationMessage('La API Key es obligatoria');\r\n          return false;\r\n        }\r\n\r\n        if (!sessionId) {\r\n          Swal.showValidationMessage('El Session ID es obligatorio');\r\n          return false;\r\n        }\r\n\r\n        if (!serverUrl) {\r\n          Swal.showValidationMessage('La URL del servidor es obligatoria');\r\n          return false;\r\n        }\r\n\r\n        return { apiKey, sessionId, serverUrl, testMode };\r\n      },\r\n      showCancelButton: true,\r\n      confirmButtonText: 'Conectar y Probar',\r\n      cancelButtonText: 'Cancelar',\r\n      confirmButtonColor: '#9333ea',\r\n      width: '600px'\r\n    });\r\n\r\n    if (formValues) {\r\n      // Mostrar estado de conexi√≥n\r\n      setIntegrations(prev => ({ ...prev, whatsappWaha: { ...prev.whatsappWaha, status: 'connecting' } }));\r\n\r\n      try {\r\n        // Configurar el servicio de WhatsApp WAHA\r\n        const config = {\r\n          apiKey: formValues.apiKey,\r\n          sessionId: formValues.sessionId,\r\n          serverUrl: formValues.serverUrl,\r\n          testMode: formValues.testMode\r\n        };\r\n\r\n        // Guardar configuraci√≥n\r\n        whatsappWahaService.saveConfiguration(config);\r\n\r\n        // Probar conexi√≥n\r\n        const testResult = await whatsappWahaService.testConnection();\r\n\r\n        if (testResult.success) {\r\n          // Actualizar estado\r\n          setIntegrations(prev => ({\r\n            ...prev,\r\n            whatsappWaha: {\r\n              connected: true,\r\n              status: 'connected',\r\n              lastSync: new Date().toISOString(),\r\n              testMode: formValues.testMode\r\n            }\r\n          }));\r\n\r\n          // Mostrar √©xito\r\n          await Swal.fire({\r\n            title: 'üéâ WhatsApp WAHA Configurado Exitosamente',\r\n            html: `\r\n              <div style=\"text-align: left;\">\r\n                <div style=\"background-color: #d4edda; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                  <h4 style=\"margin: 0 0 8px 0; color: #155724;\">‚úÖ Conexi√≥n exitosa</h4>\r\n                  <p style=\"margin: 0; font-size: 14px;\">La API de WAHA est√° funcionando correctamente.</p>\r\n                </div>\r\n                <div style=\"background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n                  <h4 style=\"margin: 0 0 8px 0; color: #333;\">Informaci√≥n de la sesi√≥n:</h4>\r\n                  <p style=\"margin: 4px 0; font-size: 14px;\">\r\n                    <strong>Sesi√≥n:</strong> ${formValues.sessionId}<br>\r\n                    <strong>Servidor:</strong> ${formValues.serverUrl}<br>\r\n                    <strong>Estado:</strong> ${testResult.sessionInfo?.status || 'Activa'}<br>\r\n                    <strong>Modo:</strong> ${formValues.testMode ? 'Prueba üß™' : 'Producci√≥n üöÄ'}\r\n                  </p>\r\n                </div>\r\n                <div style=\"background-color: #e8f4fd; padding: 12px; border-radius: 4px; margin-top: 12px;\">\r\n                  <h4 style=\"margin: 0 0 8px 0; color: #9333ea;\">üìä Funcionalidades activas:</h4>\r\n                  <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                    <li>‚úÖ Env√≠o de mensajes individuales</li>\r\n                    <li>‚úÖ Env√≠o masivo de mensajes</li>\r\n                    <li>‚úÖ Env√≠o de archivos y documentos</li>\r\n                    <li>‚úÖ Env√≠o de ubicaciones</li>\r\n                    <li>‚úÖ Gesti√≥n de sesiones</li>\r\n                    <li>‚úÖ Integraci√≥n con sistema de comunicaci√≥n</li>\r\n                  </ul>\r\n                </div>\r\n              </div>\r\n            `,\r\n            icon: 'success',\r\n            confirmButtonText: '¬°Perfecto!',\r\n            confirmButtonColor: '#9333ea',\r\n            width: '500px'\r\n          });\r\n\r\n          toast.success('WhatsApp WAHA configurado exitosamente');\r\n        } else {\r\n          throw new Error(testResult.error || 'Error al conectar con WhatsApp WAHA');\r\n        }\r\n      } catch (error) {\r\n        console.error('Error configuring WhatsApp WAHA:', error);\r\n        \r\n        // Restaurar estado\r\n        setIntegrations(prev => ({\r\n          ...prev,\r\n          whatsappWaha: {\r\n            connected: false,\r\n            status: 'disconnected',\r\n            lastSync: null,\r\n            testMode: false\r\n          }\r\n        }));\r\n\r\n        // Limpiar configuraci√≥n guardada\r\n        whatsappWahaService.clearConfiguration();\r\n\r\n        // Mostrar error\r\n        await Swal.fire({\r\n          title: '‚ùå Error de Conexi√≥n',\r\n          html: `\r\n            <div style=\"text-align: left;\">\r\n              <div style=\"background-color: #f8d7da; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #721c24;\">No se pudo conectar con WhatsApp WAHA</h4>\r\n                <p style=\"margin: 0; font-size: 14px;\"><strong>Error:</strong> ${error.message}</p>\r\n              </div>\r\n              <div style=\"background-color: #fff3cd; padding: 12px; border-radius: 4px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #856404;\">üîç Posibles soluciones:</h4>\r\n                <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                  <li>‚Ä¢ Verifica que la API Key sea correcta</li>\r\n                  <li>‚Ä¢ Aseg√∫rate de que el Session ID sea v√°lido</li>\r\n                  <li>‚Ä¢ Revisa que la URL del servidor sea correcta</li>\r\n                  <li>‚Ä¢ Verifica que tu sesi√≥n est√© activa en WAHA</li>\r\n                  <li>‚Ä¢ Revisa tu conexi√≥n a internet</li>\r\n                </ul>\r\n              </div>\r\n            </div>\r\n          `,\r\n          icon: 'error',\r\n          confirmButtonText: 'Reintentar',\r\n          confirmButtonColor: '#dc3545',\r\n          width: '500px'\r\n        });\r\n\r\n        toast.error('Error al configurar WhatsApp WAHA');\r\n      }\r\n    }\r\n  };\r\n\r\n  const disconnectIntegration = async (integration) => {\r\n    const integrationNames = {\r\n      google: 'Google Workspace',\r\n      slack: 'Slack',\r\n      teams: 'Microsoft Teams',\r\n      hubspot: 'HubSpot',\r\n      salesforce: 'Salesforce',\r\n      brevo: 'Brevo',\r\n      groq: 'Groq AI',\r\n      whatsapp: 'WhatsApp',\r\n      whatsappOfficial: 'WhatsApp Official API',\r\n      whatsappWaha: 'WhatsApp WAHA API',\r\n      telegram: 'Telegram'\r\n    };\r\n\r\n    const result = await Swal.fire({\r\n      title: 'Desconectar Integraci√≥n',\r\n      text: `¬øEst√°s seguro de desconectar ${integrationNames[integration]}?`,\r\n      icon: 'warning',\r\n      showCancelButton: true,\r\n      confirmButtonColor: '#d33',\r\n      cancelButtonColor: '#3085d6',\r\n      confirmButtonText: 'S√≠, desconectar',\r\n      cancelButtonText: 'Cancelar'\r\n    });\r\n\r\n    if (result.isConfirmed) {\r\n      try {\r\n        // Limpiar configuraci√≥n usando configurationService para servicios migrados\r\n        if (['groq', 'whatsapp', 'telegram'].includes(integration)) {\r\n          await configurationService.setConfig('integrations', integration, {}, 'global', null, `Desconexi√≥n de ${integrationNames[integration]}`)\r\n        }\r\n\r\n        // Mantener limpieza espec√≠fica para servicios que a√∫n usan sus propios m√©todos\r\n        if (integration === 'brevo') {\r\n          brevoService.clearConfiguration();\r\n        }\r\n\r\n        if (integration === 'whatsappOfficial') {\r\n          whatsappOfficialService.clearConfiguration();\r\n        }\r\n\r\n        if (integration === 'whatsappWaha') {\r\n          whatsappWahaService.clearConfiguration();\r\n        }\r\n\r\n        setIntegrations(prev => ({\r\n          ...prev,\r\n          [integration]: {\r\n            connected: false,\r\n            status: 'disconnected',\r\n            lastSync: null,\r\n            testMode: false\r\n          }\r\n        }));\r\n\r\n        toast.success(`${integrationNames[integration]} desconectado`);\r\n      } catch (error) {\r\n        console.error('Error disconnecting integration:', error);\r\n        toast.error(`Error al desconectar ${integrationNames[integration]}`);\r\n      }\r\n    }\r\n  };\r\n\r\n  // Funci√≥n para manejar el env√≠o del formulario de integraci√≥n\r\n  const handleIntegrationRequest = async (e) => {\r\n    e.preventDefault();\r\n\r\n    // Validar campos obligatorios\r\n    if (!integrationForm.nombre || !integrationForm.apellido || !integrationForm.empresa || !integrationForm.email || !integrationForm.telefono) {\r\n      toast.error('Por favor completa todos los campos');\r\n      return;\r\n    }\r\n\r\n    // Validar email\r\n    const emailRegex = /^[^s@]+@[^s@]+.[^s@]+$/;\r\n    if (!emailRegex.test(integrationForm.email)) {\r\n      toast.error('Por favor ingresa un email v√°lido');\r\n      return;\r\n    }\r\n\r\n    // Validar tel√©fono (solo n√∫meros y algunos caracteres especiales)\r\n    const phoneRegex = /^[+]?[0-9\\s-()]+$/;\r\n    if (!phoneRegex.test(integrationForm.telefono)) {\r\n      toast.error('Por favor ingresa un tel√©fono v√°lido');\r\n      return;\r\n    }\r\n\r\n    setSendingIntegrationRequest(true);\r\n\r\n    try {\r\n      // Simular env√≠o de email (en producci√≥n usar√≠as EmailJS, API backend, etc.)\r\n      const emailData = {\r\n        to: 'hola@aintelligence.cl',\r\n        subject: 'Nueva Solicitud de Integraci√≥n',\r\n        body: `\r\n          Nueva solicitud de integraci√≥n recibida:\r\n\r\n          Nombre: ${integrationForm.nombre}\r\n          Apellido: ${integrationForm.apellido}\r\n          Empresa: ${integrationForm.empresa}\r\n          Email: ${integrationForm.email}\r\n          Tel√©fono: ${integrationForm.telefono}\r\n          Comentarios: ${integrationForm.comentarios || 'Sin comentarios'}\r\n\r\n          Fecha de solicitud: ${new Date().toLocaleString('es-ES')}\r\n        `\r\n      };\r\n\r\n      // Simular delay de env√≠o\r\n      await new Promise(resolve => setTimeout(resolve, 2000));\r\n\r\n      console.log('Email enviado a hola@aintelligence.cl:', emailData);\r\n\r\n      // Limpiar formulario y cerrar modal\r\n      setIntegrationForm({\r\n        nombre: '',\r\n        apellido: '',\r\n        empresa: '',\r\n        email: '',\r\n        telefono: '',\r\n        comentarios: ''\r\n      });\r\n      setShowIntegrationForm(false);\r\n\r\n      toast.success('¬°Solicitud enviada exitosamente! Te contactaremos pronto.');\r\n\r\n    } catch (error) {\r\n      console.error('Error enviando solicitud:', error);\r\n      toast.error('Error al enviar la solicitud. Int√©ntalo nuevamente.');\r\n    } finally {\r\n      setSendingIntegrationRequest(false);\r\n    }\r\n  };\r\n\r\n  const getStatusBadge = (integration) => {\r\n    const status = integrations[integration].status;\r\n    const connected = integrations[integration].connected;\r\n\r\n    if (status === 'connecting') {\r\n      return <span className=\"px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full\">Conectando...</span>;\r\n    }\r\n\r\n    if (connected) {\r\n      return <span className=\"px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full\">Conectado</span>;\r\n    }\r\n\r\n    return <span className=\"px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full\">Desconectado</span>;\r\n  };\r\n\r\n  if (showCompanyForm) {\r\n    return (\r\n      <CompanyForm\r\n        company={editingCompany}\r\n        onSuccess={handleFormSuccess}\r\n        onCancel={() => {\r\n          setShowCompanyForm(false)\r\n          setEditingCompany(null)\r\n          if (companyId) {\r\n            // Si estamos en modo empresa espec√≠fica, redirigir a la lista de empresas\r\n            navigate('/configuracion/empresas')\r\n          }\r\n        }}\r\n        companyId={companyId}\r\n        isCompanySpecificMode={!!companyId}\r\n      />\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\r\n      {/* Header */}\r\n      <div className=\"mb-8\">\r\n        <div className=\"flex items-center mb-4\">\r\n          <div className=\"p-3 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 shadow-lg mr-4\">\r\n            <Cog6ToothIcon className=\"h-8 w-8 text-white\" />\r\n          </div>\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold text-gray-900\">Configuraci√≥n</h1>\r\n            <p className=\"text-gray-600\">Gestiona tus empresas y configuraciones del sistema</p>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Tabs */}\r\n        <div className=\"border-b border-gray-200\">\r\n          <nav className=\"-mb-px flex space-x-8\">\r\n            <Link\r\n              to=\"/configuracion/empresas\"\r\n              className={`py-2 px-1 border-b-2 font-medium text-sm ${\r\n                activeTab === 'companies'\r\n                  ? 'border-blue-500 text-blue-600'\r\n                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'\r\n              }`}\r\n            >\r\n              <BuildingOfficeIcon className=\"h-5 w-5 inline mr-2\" />\r\n              Empresas\r\n            </Link>\r\n            <Link\r\n              to=\"/configuracion/usuarios\"\r\n              className={`py-2 px-1 border-b-2 font-medium text-sm ${\r\n                activeTab === 'users'\r\n                  ? 'border-blue-500 text-blue-600'\r\n                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'\r\n              }`}\r\n            >\r\n              <UserGroupIcon className=\"h-5 w-5 inline mr-2\" />\r\n              Usuarios\r\n            </Link>\r\n            <Link\r\n              to=\"/configuracion/general\"\r\n              className={`py-2 px-1 border-b-2 font-medium text-sm ${\r\n                activeTab === 'general'\r\n                  ? 'border-blue-500 text-blue-600'\r\n                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'\r\n              }`}\r\n            >\r\n              <Cog6ToothIcon className=\"h-5 w-5 inline mr-2\" />\r\n              General\r\n            </Link>\r\n            <Link\r\n              to=\"/configuracion/notificaciones\"\r\n              className={`py-2 px-1 border-b-2 font-medium text-sm ${\r\n                activeTab === 'notifications'\r\n                  ? 'border-blue-500 text-blue-600'\r\n                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'\r\n              }`}\r\n            >\r\n              <ChatBubbleLeftRightIcon className=\"h-5 w-5 inline mr-2\" />\r\n              Notificaciones\r\n            </Link>\r\n            <Link\r\n              to=\"/configuracion/seguridad\"\r\n              className={`py-2 px-1 border-b-2 font-medium text-sm ${\r\n                activeTab === 'security'\r\n                  ? 'border-blue-500 text-blue-600'\r\n                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'\r\n              }`}\r\n            >\r\n              <BuildingStorefrontIcon className=\"h-5 w-5 inline mr-2\" />\r\n              Seguridad\r\n            </Link>\r\n            <Link\r\n              to=\"/configuracion/integraciones\"\r\n              className={`py-2 px-1 border-b-2 font-medium text-sm ${\r\n                activeTab === 'integrations'\r\n                  ? 'border-blue-500 text-blue-600'\r\n                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'\r\n              }`}\r\n            >\r\n              <PuzzlePieceIcon className=\"h-5 w-5 inline mr-2\" />\r\n              Integraciones\r\n            </Link>\r\n            <Link\r\n              to=\"/configuracion/base-de-datos\"\r\n              className={`py-2 px-1 border-b-2 font-medium text-sm ${\r\n                activeTab === 'database'\r\n                  ? 'border-blue-500 text-blue-600'\r\n                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'\r\n              }`}\r\n            >\r\n              <ServerIcon className=\"h-5 w-5 inline mr-2\" />\r\n              Base de Datos\r\n            </Link>\r\n          </nav>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Content */}\r\n      {activeTab === 'companies' && (\r\n        <div className=\"space-y-6\">\r\n          {/* Actions */}\r\n          <div className=\"flex justify-between items-center\">\r\n            <div className=\"flex items-center space-x-4\">\r\n              <h2 className=\"text-xl font-semibold text-gray-900\">Empresas Configuradas</h2>\r\n              <span className=\"px-3 py-1 bg-blue-100 text-blue-700 text-sm font-medium rounded-full\">\r\n                {companies.length} empresas\r\n              </span>\r\n            </div>\r\n            <button\r\n              onClick={handleCreateCompany}\r\n              className=\"inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5\"\r\n            >\r\n              <PlusIcon className=\"h-5 w-5 mr-2\" />\r\n              Nueva Empresa\r\n            </button>\r\n          </div>\r\n\r\n          {/* Companies List */}\r\n          {loading ? (\r\n            <div className=\"flex justify-center items-center h-32\">\r\n              <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500\"></div>\r\n            </div>\r\n          ) : companies.length === 0 ? (\r\n            <div className=\"text-center py-12\">\r\n              <BuildingOfficeIcon className=\"mx-auto h-12 w-12 text-gray-400\" />\r\n              <h3 className=\"mt-2 text-sm font-medium text-gray-900\">No hay empresas</h3>\r\n              <p className=\"mt-1 text-sm text-gray-500\">Comienza creando tu primera empresa.</p>\r\n              <div className=\"mt-6\">\r\n                <button\r\n                  onClick={handleCreateCompany}\r\n                  className=\"inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5\"\r\n                >\r\n                  <PlusIcon className=\"h-5 w-5 mr-2\" />\r\n                  Crear Primera Empresa\r\n                </button>\r\n              </div>\r\n            </div>\r\n          ) : (\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n              {companies.map((company) => (\r\n                <div\r\n                  key={company.id}\r\n                  className=\"relative bg-white rounded-3xl p-6 shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100\"\r\n                >\r\n                  <div className=\"flex items-start justify-between mb-4\">\r\n                    <div className=\"flex items-center\">\r\n                      <div className=\"p-2 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 shadow-lg mr-3\">\r\n                        <BuildingOfficeIcon className=\"h-6 w-6 text-white\" />\r\n                      </div>\r\n                      <div>\r\n                        <h3 className=\"text-lg font-bold text-gray-900\">{company.name}</h3>\r\n                        <div className=\"flex items-center mt-1\">\r\n                          {company.status === 'active' ? (\r\n                            <CheckCircleIcon className=\"h-4 w-4 text-green-500 mr-1\" />\r\n                          ) : (\r\n                            <XCircleIcon className=\"h-4 w-4 text-red-500 mr-1\" />\r\n                          )}\r\n                          <span className={`text-xs font-medium ${company.status === 'active' ? 'text-green-700' : 'text-red-700'}`}>\r\n                            {company.status === 'active' ? 'Activa' : 'Inactiva'}\r\n                          </span>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                    <button\r\n                      onClick={() => toggleCompanyStatus(company)}\r\n                      className={`p-1 rounded-full ${\r\n                        company.status === 'active'\r\n                          ? 'text-green-600 hover:bg-green-50'\r\n                          : 'text-red-600 hover:bg-red-50'\r\n                      }`}\r\n                      title={company.status === 'active' ? 'Desactivar empresa' : 'Activar empresa'}\r\n                    >\r\n                      {company.status === 'active' ? (\r\n                        <CheckCircleIcon className=\"h-5 w-5\" />\r\n                      ) : (\r\n                        <XCircleIcon className=\"h-5 w-5\" />\r\n                      )}\r\n                    </button>\r\n                  </div>\r\n\r\n                  {company.description && (\r\n                    <p className=\"text-sm text-gray-600 mb-4 line-clamp-2\">{company.description}</p>\r\n                  )}\r\n\r\n                  <div className=\"space-y-2 mb-4\">\r\n                    {company.telegram_bot && (\r\n                      <div className=\"flex items-center text-sm text-gray-600\">\r\n                        <span className=\"font-medium mr-2\">Telegram:</span>\r\n                        <span className=\"truncate\">{company.telegram_bot}</span>\r\n                      </div>\r\n                    )}\r\n                    {company.whatsapp_number && (\r\n                      <div className=\"flex items-center text-sm text-gray-600\">\r\n                        <span className=\"font-medium mr-2\">WhatsApp:</span>\r\n                        <span>{company.whatsapp_number}</span>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n\r\n                  <div className=\"flex justify-end space-x-2\">\r\n                    <button\r\n                      onClick={() => navigate(`/configuracion/empresas/${company.id}`)}\r\n                      className=\"p-2 text-purple-600 hover:bg-purple-50 rounded-lg transition-colors\"\r\n                      title=\"Configurar canales de comunicaci√≥n\"\r\n                    >\r\n                      <Cog6ToothIcon className=\"h-4 w-4\" />\r\n                    </button>\r\n                    <button\r\n                      onClick={() => handleDeleteCompany(company.id)}\r\n                      className=\"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors\"\r\n                      title=\"Eliminar empresa\"\r\n                    >\r\n                      <TrashIcon className=\"h-4 w-4\" />\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n      )}\r\n\r\n      {activeTab === 'users' && (\r\n        <UserManagement />\r\n      )}\r\n\r\n      {activeTab === 'general' && (\r\n        <div className=\"space-y-6\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <h2 className=\"text-xl font-semibold text-gray-900\">Configuraci√≥n General</h2>\r\n              <p className=\"text-gray-600 mt-1\">Configuraciones b√°sicas del sistema</p>\r\n            </div>\r\n            <span className=\"px-3 py-1 bg-blue-100 text-blue-700 text-sm font-medium rounded-full\">\r\n              Sistema\r\n            </span>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n            {/* Configuraci√≥n de Idioma */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n              <div className=\"flex items-center mb-4\">\r\n                <div className=\"p-3 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 shadow-lg mr-4\">\r\n                  <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-lg font-bold text-gray-900\">Idioma y Regi√≥n</h3>\r\n                  <p className=\"text-sm text-gray-600\">Configura el idioma y zona horaria</p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"space-y-4\">\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">Idioma</label>\r\n                  <select className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500\">\r\n                    <option value=\"es\">Espa√±ol</option>\r\n                    <option value=\"en\">English</option>\r\n                    <option value=\"pt\">Portugu√™s</option>\r\n                  </select>\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">Zona Horaria</label>\r\n                  <select className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500\">\r\n                    <option value=\"America/Santiago\">Chile (Santiago)</option>\r\n                    <option value=\"America/Buenos_Aires\">Argentina (Buenos Aires)</option>\r\n                    <option value=\"America/Lima\">Per√∫ (Lima)</option>\r\n                    <option value=\"America/Bogota\">Colombia (Bogot√°)</option>\r\n                  </select>\r\n                </div>\r\n\r\n                <button className=\"w-full px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl\">\r\n                  Guardar Cambios\r\n                </button>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Configuraci√≥n de Apariencia */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n              <div className=\"flex items-center mb-4\">\r\n                <div className=\"p-3 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 shadow-lg mr-4\">\r\n                  <Cog6ToothIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-lg font-bold text-gray-900\">Apariencia</h3>\r\n                  <p className=\"text-sm text-gray-600\">Personaliza la interfaz del sistema</p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"space-y-4\">\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">Tema</label>\r\n                  <select className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500\">\r\n                    <option value=\"light\">Claro</option>\r\n                    <option value=\"dark\">Oscuro</option>\r\n                    <option value=\"auto\">Autom√°tico</option>\r\n                  </select>\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">Densidad de Contenido</label>\r\n                  <select className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500\">\r\n                    <option value=\"compact\">Compacto</option>\r\n                    <option value=\"comfortable\">C√≥modo</option>\r\n                    <option value=\"spacious\">Espacioso</option>\r\n                  </select>\r\n                </div>\r\n\r\n                <div className=\"flex items-center\">\r\n                  <input type=\"checkbox\" id=\"animations\" className=\"h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded\" defaultChecked />\r\n                  <label htmlFor=\"animations\" className=\"ml-2 block text-sm text-gray-900\">\r\n                    Habilitar animaciones\r\n                  </label>\r\n                </div>\r\n\r\n                <button className=\"w-full px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl\">\r\n                  Aplicar Tema\r\n                </button>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Configuraci√≥n de Rendimiento */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n              <div className=\"flex items-center mb-4\">\r\n                <div className=\"p-3 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 shadow-lg mr-4\">\r\n                  <BuildingStorefrontIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-lg font-bold text-gray-900\">Rendimiento</h3>\r\n                  <p className=\"text-sm text-gray-600\">Optimiza el rendimiento del sistema</p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"space-y-4\">\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">L√≠mite de Registros por P√°gina</label>\r\n                  <select className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500\">\r\n                    <option value=\"10\">10 registros</option>\r\n                    <option value=\"25\">25 registros</option>\r\n                    <option value=\"50\">50 registros</option>\r\n                    <option value=\"100\">100 registros</option>\r\n                  </select>\r\n                </div>\r\n\r\n                <div className=\"flex items-center\">\r\n                  <input type=\"checkbox\" id=\"auto-refresh\" className=\"h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded\" defaultChecked />\r\n                  <label htmlFor=\"auto-refresh\" className=\"ml-2 block text-sm text-gray-900\">\r\n                    Actualizaci√≥n autom√°tica de datos\r\n                  </label>\r\n                </div>\r\n\r\n                <div className=\"flex items-center\">\r\n                  <input type=\"checkbox\" id=\"cache-enabled\" className=\"h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded\" defaultChecked />\r\n                  <label htmlFor=\"cache-enabled\" className=\"ml-2 block text-sm text-gray-900\">\r\n                    Habilitar cach√© de datos\r\n                  </label>\r\n                </div>\r\n\r\n                <button className=\"w-full px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl\">\r\n                  Optimizar Rendimiento\r\n                </button>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Configuraci√≥n de API */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n              <div className=\"flex items-center mb-4\">\r\n                <div className=\"p-3 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 shadow-lg mr-4\">\r\n                  <PuzzlePieceIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-lg font-bold text-gray-900\">API y Conectividad</h3>\r\n                  <p className=\"text-sm text-gray-600\">Configura timeouts y l√≠mites de API</p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"space-y-4\">\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">Timeout de Conexi√≥n (segundos)</label>\r\n                  <input\r\n                    type=\"number\"\r\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500\"\r\n                    defaultValue=\"30\"\r\n                    min=\"5\"\r\n                    max=\"120\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">Reintentos Autom√°ticos</label>\r\n                  <select className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500\">\r\n                    <option value=\"0\">Sin reintentos</option>\r\n                    <option value=\"1\">1 reintento</option>\r\n                    <option value=\"3\">3 reintentos</option>\r\n                    <option value=\"5\">5 reintentos</option>\r\n                  </select>\r\n                </div>\r\n\r\n                <div className=\"flex items-center\">\r\n                  <input type=\"checkbox\" id=\"api-compression\" className=\"h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded\" defaultChecked />\r\n                  <label htmlFor=\"api-compression\" className=\"ml-2 block text-sm text-gray-900\">\r\n                    Habilitar compresi√≥n de respuestas\r\n                  </label>\r\n                </div>\r\n\r\n                <button className=\"w-full px-4 py-2 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl\">\r\n                  Guardar Configuraci√≥n API\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {activeTab === 'notifications' && (\r\n        <div className=\"space-y-6\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <h2 className=\"text-xl font-semibold text-gray-900\">Configuraci√≥n de Notificaciones</h2>\r\n              <p className=\"text-gray-600 mt-1\">Gestiona c√≥mo y cu√°ndo recibir notificaciones</p>\r\n            </div>\r\n            <span className=\"px-3 py-1 bg-green-100 text-green-700 text-sm font-medium rounded-full\">\r\n              Notificaciones\r\n            </span>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n            {/* Notificaciones por Email */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n              <div className=\"flex items-center mb-4\">\r\n                <div className=\"p-3 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 shadow-lg mr-4\">\r\n                  <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-lg font-bold text-gray-900\">Notificaciones por Email</h3>\r\n                  <p className=\"text-sm text-gray-600\">Configura alertas por correo electr√≥nico</p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <h4 className=\"text-sm font-medium text-gray-900\">Mensajes enviados</h4>\r\n                    <p className=\"text-xs text-gray-600\">Notificaciones cuando se env√≠an mensajes</p>\r\n                  </div>\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    className=\"h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded\"\r\n                    checked={notificationSettings.email.messagesSent}\r\n                    onChange={(e) => handleEmailNotificationChange('messagesSent', e.target.checked)}\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <h4 className=\"text-sm font-medium text-gray-900\">Errores del sistema</h4>\r\n                    <p className=\"text-xs text-gray-600\">Alertas de errores cr√≠ticos</p>\r\n                  </div>\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    className=\"h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded\"\r\n                    checked={notificationSettings.email.systemErrors}\r\n                    onChange={(e) => handleEmailNotificationChange('systemErrors', e.target.checked)}\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <h4 className=\"text-sm font-medium text-gray-900\">Reportes semanales</h4>\r\n                    <p className=\"text-xs text-gray-600\">Res√∫menes de actividad semanal</p>\r\n                  </div>\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    className=\"h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded\"\r\n                    checked={notificationSettings.email.weeklyReports}\r\n                    onChange={(e) => handleEmailNotificationChange('weeklyReports', e.target.checked)}\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <h4 className=\"text-sm font-medium text-gray-900\">L√≠mites de uso</h4>\r\n                    <p className=\"text-xs text-gray-600\">Cuando se acerca al l√≠mite de tokens</p>\r\n                  </div>\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    className=\"h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded\"\r\n                    checked={notificationSettings.email.tokenLimits}\r\n                    onChange={(e) => handleEmailNotificationChange('tokenLimits', e.target.checked)}\r\n                  />\r\n                </div>\r\n\r\n                <button\r\n                  onClick={saveEmailPreferences}\r\n                  className=\"w-full px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl\"\r\n                >\r\n                  Guardar Preferencias de Email\r\n                </button>\r\n              </div>\r\n            </div>\r\n\r\n\r\n            {/* Programaci√≥n de Reportes */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n              <div className=\"flex items-center mb-4\">\r\n                <div className=\"p-3 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 shadow-lg mr-4\">\r\n                  <Cog6ToothIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-lg font-bold text-gray-900\">Reportes Autom√°ticos</h3>\r\n                  <p className=\"text-sm text-gray-600\">Programaci√≥n de reportes peri√≥dicos</p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"space-y-4\">\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">Frecuencia de Reportes</label>\r\n                  <select\r\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500\"\r\n                    value={notificationSettings.reports.frequency}\r\n                    onChange={(e) => handleReportsSettingsChange('frequency', e.target.value)}\r\n                  >\r\n                    <option value=\"daily\">Diario</option>\r\n                    <option value=\"weekly\">Semanal</option>\r\n                    <option value=\"monthly\">Mensual</option>\r\n                    <option value=\"never\">Nunca</option>\r\n                  </select>\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">Destinatarios</label>\r\n                  <div className=\"space-y-2\">\r\n                    {notificationSettings.reports.recipients.map((email, index) => (\r\n                      <div key={index} className=\"flex items-center space-x-2\">\r\n                        <input\r\n                          type=\"email\"\r\n                          className=\"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500\"\r\n                          value={email}\r\n                          onChange={(e) => {\r\n                            const updatedRecipients = [...notificationSettings.reports.recipients];\r\n                            updatedRecipients[index] = e.target.value;\r\n                            handleReportsSettingsChange('recipients', updatedRecipients);\r\n                          }}\r\n                          placeholder=\"email@empresa.com\"\r\n                        />\r\n                        <button\r\n                          onClick={() => removeEmailRecipient(email)}\r\n                          className=\"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors\"\r\n                          title=\"Remover email\"\r\n                        >\r\n                          <XCircleIcon className=\"h-5 w-5\" />\r\n                        </button>\r\n                      </div>\r\n                    ))}\r\n                    <button\r\n                      onClick={addEmailRecipient}\r\n                      className=\"w-full px-3 py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-indigo-500 hover:text-indigo-600 transition-colors flex items-center justify-center\"\r\n                    >\r\n                      <PlusIcon className=\"h-4 w-4 mr-2\" />\r\n                      Agregar Destinatario\r\n                    </button>\r\n                  </div>\r\n                  <p className=\"text-xs text-gray-500 mt-1\">\r\n                    {notificationSettings.reports.recipients.length} destinatario{notificationSettings.reports.recipients.length !== 1 ? 's' : ''} configurado{notificationSettings.reports.recipients.length !== 1 ? 's' : ''}\r\n                  </p>\r\n                </div>\r\n\r\n                <div className=\"flex items-center\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    id=\"include-charts\"\r\n                    className=\"h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded\"\r\n                    checked={notificationSettings.reports.includeCharts}\r\n                    onChange={(e) => handleReportsSettingsChange('includeCharts', e.target.checked)}\r\n                  />\r\n                  <label htmlFor=\"include-charts\" className=\"ml-2 block text-sm text-gray-900\">\r\n                    Incluir gr√°ficos en reportes\r\n                  </label>\r\n                </div>\r\n\r\n                <button\r\n                  onClick={scheduleReports}\r\n                  className=\"w-full px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl\"\r\n                >\r\n                  üíæ Guardar y Ir a Reportes\r\n                </button>\r\n                <p className=\"text-xs text-gray-500 text-center mt-2\">\r\n                  Las configuraciones se aplicar√°n en la p√°gina de informes\r\n                </p>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Configuraci√≥n de Sonido */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n              <div className=\"flex items-center mb-4\">\r\n                <div className=\"p-3 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 shadow-lg mr-4\">\r\n                  <PuzzlePieceIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-lg font-bold text-gray-900\">Sonidos y Alertas</h3>\r\n                  <p className=\"text-sm text-gray-600\">Configura sonidos de notificaci√≥n</p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <h4 className=\"text-sm font-medium text-gray-900\">Sonidos activados</h4>\r\n                    <p className=\"text-xs text-gray-600\">Reproducir sonidos en notificaciones</p>\r\n                  </div>\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    className=\"h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded\"\r\n                    checked={notificationSettings.sound.enabled}\r\n                    onChange={(e) => handleSoundSettingsChange('enabled', e.target.checked)}\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                    Volumen de Notificaciones: {notificationSettings.sound.volume}%\r\n                  </label>\r\n                  <input\r\n                    type=\"range\"\r\n                    min=\"0\"\r\n                    max=\"100\"\r\n                    value={notificationSettings.sound.volume}\r\n                    onChange={(e) => handleSoundSettingsChange('volume', parseInt(e.target.value))}\r\n                    className=\"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer\"\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <h4 className=\"text-sm font-medium text-gray-900\">Notificaciones silenciosas</h4>\r\n                    <p className=\"text-xs text-gray-600\">Solo vibraci√≥n sin sonido</p>\r\n                  </div>\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    className=\"h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded\"\r\n                    checked={notificationSettings.sound.silent}\r\n                    onChange={(e) => handleSoundSettingsChange('silent', e.target.checked)}\r\n                  />\r\n                </div>\r\n\r\n                <button\r\n                  onClick={testSounds}\r\n                  disabled={!notificationSettings.sound.enabled}\r\n                  className=\"w-full px-4 py-2 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  Probar Sonidos\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {activeTab === 'security' && (\r\n        <div className=\"space-y-6\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <h2 className=\"text-xl font-semibold text-gray-900\">Configuraci√≥n de Seguridad</h2>\r\n              <p className=\"text-gray-600 mt-1\">Gestiona la seguridad y permisos del sistema</p>\r\n            </div>\r\n            <span className=\"px-3 py-1 bg-red-100 text-red-700 text-sm font-medium rounded-full\">\r\n              Seguridad\r\n            </span>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n            {/* Autenticaci√≥n de Dos Factores */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n              <div className=\"flex items-center mb-4\">\r\n                <div className=\"p-3 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 shadow-lg mr-4\">\r\n                  <BuildingStorefrontIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-lg font-bold text-gray-900\">Autenticaci√≥n de Dos Factores</h3>\r\n                  <p className=\"text-sm text-gray-600\">Aumenta la seguridad de tu cuenta</p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"space-y-4\">\r\n                {securitySettings.twoFactorEnabled ? (\r\n                  <div className=\"bg-green-50 border border-green-200 rounded-lg p-4\">\r\n                    <div className=\"flex items-center\">\r\n                      <CheckCircleIcon className=\"h-5 w-5 text-green-500 mr-2\" />\r\n                      <span className=\"text-sm font-medium text-green-800\">2FA Activado</span>\r\n                    </div>\r\n                    <p className=\"text-xs text-green-600 mt-1\">\r\n                      M√©todo: {securitySettings.twoFactorMethod === 'app' ? 'Aplicaci√≥n' :\r\n                               securitySettings.twoFactorMethod === 'sms' ? 'SMS' : 'Email'}\r\n                    </p>\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-4\">\r\n                    <div className=\"flex items-center\">\r\n                      <XCircleIcon className=\"h-5 w-5 text-yellow-500 mr-2\" />\r\n                      <span className=\"text-sm font-medium text-yellow-800\">2FA Desactivado</span>\r\n                    </div>\r\n                    <p className=\"text-xs text-yellow-600 mt-1\">Activa 2FA para mayor seguridad</p>\r\n                  </div>\r\n                )}\r\n\r\n                <div className=\"space-y-3\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">M√©todo de 2FA</label>\r\n                    <select\r\n                      value={securitySettings.twoFactorMethod}\r\n                      onChange={(e) => setSecuritySettings(prev => ({ ...prev, twoFactorMethod: e.target.value }))}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500\"\r\n                    >\r\n                      <option value=\"app\">Aplicaci√≥n (Google Authenticator)</option>\r\n                      <option value=\"sms\">SMS</option>\r\n                      <option value=\"email\">Email</option>\r\n                    </select>\r\n                  </div>\r\n\r\n                  <button\r\n                    onClick={() => {\r\n                      setSecuritySettings(prev => ({ ...prev, twoFactorEnabled: !prev.twoFactorEnabled }))\r\n                      toast.success(securitySettings.twoFactorEnabled ? '2FA desactivado' : '2FA activado')\r\n                    }}\r\n                    className={`w-full px-4 py-2 font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl ${\r\n                      securitySettings.twoFactorEnabled\r\n                        ? 'bg-red-500 hover:bg-red-600 text-white'\r\n                        : 'bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white'\r\n                    }`}\r\n                  >\r\n                    {securitySettings.twoFactorEnabled ? 'Desactivar 2FA' : 'Activar 2FA'}\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Sesiones Activas */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n              <div className=\"flex items-center mb-4\">\r\n                <div className=\"p-3 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 shadow-lg mr-4\">\r\n                  <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-lg font-bold text-gray-900\">Sesiones Activas</h3>\r\n                  <p className=\"text-sm text-gray-600\">Gestiona tus sesiones activas</p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"space-y-4\">\r\n                {activeSessions.map((session) => (\r\n                  <div key={session.id} className={`rounded-lg p-4 ${session.current ? 'bg-green-50 border border-green-200' : 'bg-gray-50'}`}>\r\n                    <div className=\"flex items-center justify-between\">\r\n                      <div>\r\n                        <p className=\"text-sm font-medium text-gray-900\">\r\n                          {session.current ? 'Sesi√≥n Actual' : 'Otra Sesi√≥n'}\r\n                        </p>\r\n                        <p className=\"text-xs text-gray-600\">{session.device} ‚Ä¢ {session.location}</p>\r\n                        <p className=\"text-xs text-gray-500\">\r\n                          √öltima actividad: {session.current ? 'hace 2 minutos' : `${Math.floor((Date.now() - session.lastActivity) / (1000 * 60))} minutos atr√°s`}\r\n                        </p>\r\n                        <p className=\"text-xs text-gray-400\">IP: {session.ip}</p>\r\n                      </div>\r\n                      <div className=\"flex items-center space-x-2\">\r\n                        <span className={`px-2 py-1 text-xs font-medium rounded-full ${\r\n                          session.current\r\n                            ? 'bg-green-100 text-green-800'\r\n                            : 'bg-yellow-100 text-yellow-800'\r\n                        }`}>\r\n                          {session.current ? 'Activa' : 'Inactiva'}\r\n                        </span>\r\n                        {!session.current && (\r\n                          <button\r\n                            onClick={() => {\r\n                              setActiveSessions(prev => prev.filter(s => s.id !== session.id))\r\n                              toast.success('Sesi√≥n cerrada exitosamente')\r\n                            }}\r\n                            className=\"p-1 text-red-600 hover:bg-red-50 rounded\"\r\n                            title=\"Cerrar sesi√≥n\"\r\n                          >\r\n                            <XCircleIcon className=\"h-4 w-4\" />\r\n                          </button>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n\r\n                <div className=\"flex space-x-2\">\r\n                  <button\r\n                    onClick={() => {\r\n                      // Simular refresh de sesiones\r\n                      loadActiveSessions()\r\n                      toast.success('Sesiones actualizadas')\r\n                    }}\r\n                    className=\"flex-1 px-4 py-2 bg-gray-100 text-gray-700 hover:bg-gray-200 font-semibold rounded-xl transition-all duration-300\"\r\n                  >\r\n                    Actualizar\r\n                  </button>\r\n                  <button className=\"flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl\">\r\n                    Ver Todas las Sesiones\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Logs de Seguridad */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n              <div className=\"flex items-center mb-4\">\r\n                <div className=\"p-3 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 shadow-lg mr-4\">\r\n                  <Cog6ToothIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-lg font-bold text-gray-900\">Logs de Seguridad</h3>\r\n                  <p className=\"text-sm text-gray-600\">Historial de actividades de seguridad</p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"space-y-4\">\r\n                <div className=\"space-y-3 max-h-64 overflow-y-auto\">\r\n                  {securityLogs.slice(0, 5).map((log) => (\r\n                    <div key={log.id} className=\"flex items-center justify-between py-2 border-b border-gray-100\">\r\n                      <div className=\"flex items-center space-x-3\">\r\n                        <div className={`w-2 h-2 rounded-full ${\r\n                          log.status === 'success' ? 'bg-green-500' :\r\n                          log.status === 'warning' ? 'bg-yellow-500' : 'bg-red-500'\r\n                        }`} />\r\n                        <div>\r\n                          <p className=\"text-sm font-medium text-gray-900\">{log.action}</p>\r\n                          <p className=\"text-xs text-gray-600\">{log.details}</p>\r\n                          <p className=\"text-xs text-gray-400\">IP: {log.ip}</p>\r\n                        </div>\r\n                      </div>\r\n                      <span className=\"text-xs text-gray-500\">\r\n                        {new Date(log.timestamp).toLocaleString('es-ES', {\r\n                          day: '2-digit',\r\n                          month: '2-digit',\r\n                          hour: '2-digit',\r\n                          minute: '2-digit'\r\n                        })}\r\n                      </span>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n\r\n                <div className=\"flex space-x-2\">\r\n                  <button\r\n                    onClick={() => {\r\n                      loadSecurityLogs()\r\n                      toast.success('Logs actualizados')\r\n                    }}\r\n                    className=\"flex-1 px-4 py-2 bg-gray-100 text-gray-700 hover:bg-gray-200 font-semibold rounded-xl transition-all duration-300\"\r\n                  >\r\n                    Actualizar\r\n                  </button>\r\n                  <button className=\"flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl\">\r\n                    Ver Todos los Logs\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Backup y Recuperaci√≥n */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n              <div className=\"flex items-center mb-4\">\r\n                <div className=\"p-3 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 shadow-lg mr-4\">\r\n                  <PuzzlePieceIcon className=\"h-6 w-6 text-white\" />\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-lg font-bold text-gray-900\">Backup y Recuperaci√≥n</h3>\r\n                  <p className=\"text-sm text-gray-600\">Gestiona copias de seguridad</p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"space-y-4\">\r\n                {backupSettings.lastBackup ? (\r\n                  <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-4\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                      <div>\r\n                        <p className=\"text-sm font-medium text-blue-800\">√öltimo backup</p>\r\n                        <p className=\"text-xs text-blue-600\">\r\n                          {new Date(backupSettings.lastBackup).toLocaleDateString('es-ES')} ‚Ä¢ {backupSettings.backupSize || '2.3 GB'}\r\n                        </p>\r\n                      </div>\r\n                      <CheckCircleIcon className=\"h-5 w-5 text-blue-500\" />\r\n                    </div>\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-4\">\r\n                    <div className=\"flex items-center\">\r\n                      <XCircleIcon className=\"h-5 w-5 text-yellow-500 mr-2\" />\r\n                      <div>\r\n                        <p className=\"text-sm font-medium text-yellow-800\">Sin backups recientes</p>\r\n                        <p className=\"text-xs text-yellow-600\">Crea tu primer backup para proteger tus datos</p>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                <div className=\"grid grid-cols-2 gap-3\">\r\n                  <button\r\n                    onClick={() => {\r\n                      // Simular creaci√≥n de backup\r\n                      setBackupSettings(prev => ({\r\n                        ...prev,\r\n                        lastBackup: new Date(),\r\n                        backupSize: '2.4 GB'\r\n                      }))\r\n                      toast.success('Backup creado exitosamente')\r\n                    }}\r\n                    className=\"px-4 py-2 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl text-sm\"\r\n                  >\r\n                    Crear Backup\r\n                  </button>\r\n                  <button\r\n                    onClick={() => {\r\n                      if (backupSettings.lastBackup) {\r\n                        toast.success('Descargando backup...')\r\n                        // Simular descarga\r\n                        setTimeout(() => {\r\n                          toast.success('Backup descargado exitosamente')\r\n                        }, 2000)\r\n                      } else {\r\n                        toast.error('No hay backup disponible para descargar')\r\n                      }\r\n                    }}\r\n                    className=\"px-4 py-2 bg-gray-100 text-gray-700 hover:bg-gray-200 font-semibold rounded-xl transition-all duration-300 text-sm\"\r\n                  >\r\n                    Descargar\r\n                  </button>\r\n                </div>\r\n\r\n                <div className=\"space-y-3\">\r\n                  <div className=\"flex items-center\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id=\"auto-backup\"\r\n                      className=\"h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded\"\r\n                      checked={backupSettings.autoBackup}\r\n                      onChange={(e) => setBackupSettings(prev => ({ ...prev, autoBackup: e.target.checked }))}\r\n                    />\r\n                    <label htmlFor=\"auto-backup\" className=\"ml-2 block text-sm text-gray-900\">\r\n                      Backup autom√°tico semanal\r\n                    </label>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">Frecuencia de Backup</label>\r\n                    <select\r\n                      value={backupSettings.backupFrequency}\r\n                      onChange={(e) => setBackupSettings(prev => ({ ...prev, backupFrequency: e.target.value }))}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500\"\r\n                    >\r\n                      <option value=\"daily\">Diario</option>\r\n                      <option value=\"weekly\">Semanal</option>\r\n                      <option value=\"monthly\">Mensual</option>\r\n                    </select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">Retenci√≥n (d√≠as)</label>\r\n                    <input\r\n                      type=\"number\"\r\n                      value={backupSettings.retentionDays}\r\n                      onChange={(e) => setBackupSettings(prev => ({ ...prev, retentionDays: parseInt(e.target.value) }))}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500\"\r\n                      min=\"1\"\r\n                      max=\"365\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                <button\r\n                  onClick={async () => {\r\n                    try {\r\n                      await configurationService.setConfig('system', 'backup_settings', backupSettings, 'global', null, 'Configuraci√≥n de backup del sistema')\r\n                      toast.success('Configuraci√≥n de backup guardada')\r\n                    } catch (error) {\r\n                      console.error('Error saving backup settings:', error)\r\n                      toast.error('Error al guardar la configuraci√≥n de backup')\r\n                    }\r\n                  }}\r\n                  className=\"w-full px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl\"\r\n                >\r\n                  Guardar Configuraci√≥n\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {activeTab === 'integrations' && (\r\n        <div className=\"space-y-6\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <h2 className=\"text-xl font-semibold text-gray-900\">Integraciones Globales</h2>\r\n              <p className=\"text-gray-600 mt-1\">Configuraciones por defecto para todas las empresas</p>\r\n            </div>\r\n            <span className=\"px-3 py-1 bg-purple-100 text-purple-700 text-sm font-medium rounded-full\">\r\n              Configuraci√≥n global\r\n            </span>\r\n          </div>\r\n\r\n          {/* Informaci√≥n sobre el sistema jer√°rquico */}\r\n          <div className=\"bg-gradient-to-r from-blue-50 to-indigo-50 rounded-3xl p-6 border border-blue-100\">\r\n            <div className=\"flex items-start\">\r\n              <div className=\"p-2 rounded-lg bg-blue-100 mr-4\">\r\n                <PuzzlePieceIcon className=\"h-5 w-5 text-blue-600\" />\r\n              </div>\r\n              <div>\r\n                <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">Sistema de Configuraci√≥n Jer√°rquico</h3>\r\n                <p className=\"text-gray-600 mb-4\">\r\n                  Las configuraciones aqu√≠ establecidas sirven como valores por defecto para todas las empresas.\r\n                  Cada empresa puede tener sus propias credenciales espec√≠ficas que sobreescriben estas configuraciones globales.\r\n                </p>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div className=\"bg-white rounded-lg p-4 border border-gray-200\">\r\n                    <h4 className=\"font-medium text-gray-900 mb-2\">üåê Configuraci√≥n Global</h4>\r\n                    <p className=\"text-sm text-gray-600\">\r\n                      Se usa cuando una empresa no tiene configuraci√≥n espec√≠fica. Ideal para startups y empresas peque√±as.\r\n                    </p>\r\n                  </div>\r\n                  <div className=\"bg-white rounded-lg p-4 border border-gray-200\">\r\n                    <h4 className=\"font-medium text-gray-900 mb-2\">üè¢ Configuraci√≥n por Empresa</h4>\r\n                    <p className=\"text-sm text-gray-600\">\r\n                      Sobreescribe la configuraci√≥n global. Perfecta para empresas con m√∫ltiples marcas o requisitos espec√≠ficos.\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Control de Modo de Jerarqu√≠a */}\r\n          <div className=\"bg-gradient-to-r from-purple-50 to-pink-50 rounded-3xl p-6 border border-purple-100\">\r\n            <div className=\"flex items-start\">\r\n              <div className=\"p-2 rounded-lg bg-purple-100 mr-4\">\r\n                <Cog6ToothIcon className=\"h-5 w-5 text-purple-600\" />\r\n              </div>\r\n              <div className=\"flex-1\">\r\n                <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">Control de Configuraci√≥n Jer√°rquico</h3>\r\n                <p className=\"text-gray-600 mb-4\">\r\n                  Selecciona c√≥mo el sistema debe priorizar las configuraciones globales vs. las espec√≠ficas de cada empresa.\r\n                </p>\r\n                \r\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4\">\r\n                  <button\r\n                    onClick={() => handleHierarchyModeChange('global_only')}\r\n                    className={`p-4 rounded-xl border-2 transition-all duration-300 ${\r\n                      hierarchyMode === 'global_only'\r\n                        ? 'border-purple-500 bg-purple-100 shadow-lg'\r\n                        : 'border-gray-200 bg-white hover:border-purple-300'\r\n                    }`}\r\n                  >\r\n                    <div className=\"text-center\">\r\n                      <div className={`text-2xl mb-2 ${hierarchyMode === 'global_only' ? 'text-purple-600' : 'text-gray-400'}`}>\r\n                        üåê\r\n                      </div>\r\n                      <h4 className={`font-semibold mb-1 ${hierarchyMode === 'global_only' ? 'text-purple-900' : 'text-gray-700'}`}>\r\n                        Solo Global\r\n                      </h4>\r\n                      <p className={`text-xs ${hierarchyMode === 'global_only' ? 'text-purple-700' : 'text-gray-500'}`}>\r\n                        Usa solo configuraciones globales\r\n                      </p>\r\n                    </div>\r\n                  </button>\r\n\r\n                  <button\r\n                    onClick={() => handleHierarchyModeChange('company_first')}\r\n                    className={`p-4 rounded-xl border-2 transition-all duration-300 ${\r\n                      hierarchyMode === 'company_first'\r\n                        ? 'border-purple-500 bg-purple-100 shadow-lg'\r\n                        : 'border-gray-200 bg-white hover:border-purple-300'\r\n                    }`}\r\n                  >\r\n                    <div className=\"text-center\">\r\n                      <div className={`text-2xl mb-2 ${hierarchyMode === 'company_first' ? 'text-purple-600' : 'text-gray-400'}`}>\r\n                        üè¢‚û°Ô∏èüåê\r\n                      </div>\r\n                      <h4 className={`font-semibold mb-1 ${hierarchyMode === 'company_first' ? 'text-purple-900' : 'text-gray-700'}`}>\r\n                        Empresa Primero\r\n                      </h4>\r\n                      <p className={`text-xs ${hierarchyMode === 'company_first' ? 'text-purple-700' : 'text-gray-500'}`}>\r\n                        Prioriza config. por empresa\r\n                      </p>\r\n                    </div>\r\n                  </button>\r\n\r\n                  <button\r\n                    onClick={() => handleHierarchyModeChange('both')}\r\n                    className={`p-4 rounded-xl border-2 transition-all duration-300 ${\r\n                      hierarchyMode === 'both'\r\n                        ? 'border-purple-500 bg-purple-100 shadow-lg'\r\n                        : 'border-gray-200 bg-white hover:border-purple-300'\r\n                    }`}\r\n                  >\r\n                    <div className=\"text-center\">\r\n                      <div className={`text-2xl mb-2 ${hierarchyMode === 'both' ? 'text-purple-600' : 'text-gray-400'}`}>\r\n                        üîÑ\r\n                      </div>\r\n                      <h4 className={`font-semibold mb-1 ${hierarchyMode === 'both' ? 'text-purple-900' : 'text-gray-700'}`}>\r\n                        Ambas\r\n                      </h4>\r\n                      <p className={`text-xs ${hierarchyMode === 'both' ? 'text-purple-700' : 'text-gray-500'}`}>\r\n                        Combina ambas configuraciones\r\n                      </p>\r\n                    </div>\r\n                  </button>\r\n                </div>\r\n\r\n                <div className=\"bg-white rounded-lg p-4 border border-gray-200\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <div>\r\n                      <h4 className=\"font-medium text-gray-900\">Modo Actual:</h4>\r\n                      <p className=\"text-sm text-gray-600\">\r\n                        {hierarchyMode === 'global_only' && 'Solo se usar√°n configuraciones globales. Las configuraciones por empresa ser√°n ignoradas.'}\r\n                        {hierarchyMode === 'company_first' && 'Se priorizar√°n configuraciones por empresa. Si no existen, se usar√°n las globales.'}\r\n                        {hierarchyMode === 'both' && 'Se combinar√°n ambas configuraciones. Las espec√≠ficas de empresa sobreescribir√°n las globales.'}\r\n                      </p>\r\n                    </div>\r\n                    <div className=\"px-3 py-1 bg-purple-100 text-purple-800 text-sm font-medium rounded-full\">\r\n                      {hierarchyMode.replace('_', ' ').toUpperCase()}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n            {/* Google Drive */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100 flex flex-col h-full\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <div className=\"flex items-center\">\r\n                  <div className=\"p-3 rounded-xl bg-gradient-to-br from-green-500 to-green-600 shadow-lg mr-4\">\r\n                    <CloudIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-lg font-bold text-gray-900\">Google Drive</h3>\r\n                    <p className=\"text-sm text-gray-600\">Almacenamiento en la nube</p>\r\n                  </div>\r\n                </div>\r\n                {isGoogleDriveConnected ? (\r\n                  <span className=\"px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full\">Conectado</span>\r\n                ) : (\r\n                  <span className=\"px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full\">Desconectado</span>\r\n                )}\r\n              </div>\r\n\r\n              <div className=\"flex-grow\">\r\n                <p className=\"text-sm text-gray-600 mb-4\">\r\n                  Sincroniza tus archivos y carpetas con Google Drive para acceso universal.\r\n                </p>\r\n\r\n                {isGoogleDriveConnected ? (\r\n                  <div className=\"mt-4 p-4 bg-green-50 border border-green-200 rounded-lg\">\r\n                    <div className=\"flex\">\r\n                      <CheckCircleIcon className=\"h-5 w-5 text-green-500 mr-2\" />\r\n                      <div className=\"text-sm text-green-700\">\r\n                        <p className=\"font-medium\">Google Drive est√° conectado</p>\r\n                        <p className=\"mt-1\">\r\n                          Tus archivos se sincronizar√°n autom√°ticamente con tu cuenta de Google Drive.\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg\">\r\n                    <div className=\"flex\">\r\n                      <ExclamationTriangleIcon className=\"h-5 w-5 text-yellow-500 mr-2\" />\r\n                      <div className=\"text-sm text-yellow-700\">\r\n                        <p className=\"font-medium\">Google Drive necesita configuraci√≥n</p>\r\n                        <p className=\"mt-1\">\r\n                          Al hacer clic en \"Configurar Google Drive\" ser√°s redirigido a una herramienta de diagn√≥stico que te guiar√° paso a paso.\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              {isGoogleDriveConnected ? (\r\n                <button\r\n                  onClick={handleDisconnectGoogleDrive}\r\n                  disabled={connectingGoogleDrive}\r\n                  className=\"w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {connectingGoogleDrive ? (\r\n                    <>\r\n                      <ArrowPathIcon className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                      Desconectando...\r\n                    </>\r\n                  ) : (\r\n                    <>\r\n                      <XCircleIcon className=\"h-4 w-4 mr-2\" />\r\n                      Desconectar Google Drive\r\n                    </>\r\n                  )}\r\n                </button>\r\n              ) : (\r\n                <button\r\n                  onClick={handleConnectGoogleDrive}\r\n                  disabled={connectingGoogleDrive}\r\n                  className=\"w-full px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {connectingGoogleDrive ? (\r\n                    <>\r\n                      <ArrowPathIcon className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                      Redirigiendo...\r\n                    </>\r\n                  ) : (\r\n                    <>\r\n                      <Cog6ToothIcon className=\"h-4 w-4 mr-2\" />\r\n                      Configurar Google Drive\r\n                    </>\r\n                  )}\r\n                </button>\r\n              )}\r\n            </div>\r\n            {/* Google Workspace */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100 flex flex-col h-full\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <div className=\"flex items-center\">\r\n                  <div className=\"p-3 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 shadow-lg mr-4\">\r\n                    <CloudIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-lg font-bold text-gray-900\">Google Workspace</h3>\r\n                    <p className=\"text-sm text-gray-600\">Calendario y eventos</p>\r\n                  </div>\r\n                </div>\r\n                {getStatusBadge('google')}\r\n              </div>\r\n\r\n              <div className=\"flex-grow\">\r\n                <p className=\"text-sm text-gray-600 mb-4\">\r\n                  Sincroniza eventos del calendario y automatiza recordatorios de reuniones.\r\n                </p>\r\n\r\n                <div className=\"space-y-2 mb-4\">\r\n                  {integrations.google.lastSync && (\r\n                    <div className=\"text-xs text-gray-500\">\r\n                      √öltima sincronizaci√≥n: {new Date(integrations.google.lastSync).toLocaleString('es-ES')}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              {integrations.google.connected ? (\r\n                <button\r\n                  onClick={() => disconnectIntegration('google')}\r\n                  className=\"w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                >\r\n                  Desconectar\r\n                </button>\r\n              ) : (\r\n                <button\r\n                  onClick={configureGoogleWorkspace}\r\n                  disabled={integrations.google.status === 'connecting'}\r\n                  className=\"w-full px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {integrations.google.status === 'connecting' ? 'Conectando...' : 'Configurar Google'}\r\n                </button>\r\n              )}\r\n            </div>\r\n\r\n            {/* Google Meet */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100 flex flex-col h-full\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <div className=\"flex items-center\">\r\n                  <div className=\"p-3 rounded-xl bg-gradient-to-br from-green-500 to-green-600 shadow-lg mr-4\">\r\n                    <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-lg font-bold text-gray-900\">Google Meet</h3>\r\n                    <p className=\"text-sm text-gray-600\">Videoconferencias</p>\r\n                  </div>\r\n                </div>\r\n                {getStatusBadge('googlemeet')}\r\n              </div>\r\n\r\n              <div className=\"flex-grow\">\r\n                <p className=\"text-sm text-gray-600 mb-4\">\r\n                  Sincroniza reuniones de Google Meet y env√≠a recordatorios autom√°ticos por WhatsApp.\r\n                </p>\r\n\r\n                <div className=\"space-y-2 mb-4\">\r\n                  {integrations.googlemeet.lastSync && (\r\n                    <div className=\"text-xs text-gray-500\">\r\n                      √öltima sincronizaci√≥n: {new Date(integrations.googlemeet.lastSync).toLocaleString('es-ES')}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              {integrations.googlemeet.connected ? (\r\n                <button\r\n                  onClick={() => disconnectIntegration('googlemeet')}\r\n                  className=\"w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                >\r\n                  Desconectar\r\n                </button>\r\n              ) : (\r\n                <button\r\n                  onClick={configureGoogleMeet}\r\n                  disabled={integrations.googlemeet.status === 'connecting'}\r\n                  className=\"w-full px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {integrations.googlemeet.status === 'connecting' ? 'Conectando...' : 'Configurar Google Meet'}\r\n                </button>\r\n              )}\r\n            </div>\r\n\r\n            {/* Slack */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100 flex flex-col h-full\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <div className=\"flex items-center\">\r\n                  <div className=\"p-3 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 shadow-lg mr-4\">\r\n                    <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-lg font-bold text-gray-900\">Slack</h3>\r\n                    <p className=\"text-sm text-gray-600\">Notificaciones colaborativas</p>\r\n                  </div>\r\n                </div>\r\n                {getStatusBadge('slack')}\r\n              </div>\r\n\r\n              <div className=\"flex-grow\">\r\n                <p className=\"text-sm text-gray-600 mb-4\">\r\n                  Env√≠a notificaciones autom√°ticas a canales de Slack.\r\n                </p>\r\n\r\n                <div className=\"space-y-2 mb-4\">\r\n                  {integrations.slack.lastSync && (\r\n                    <div className=\"text-xs text-gray-500\">\r\n                      √öltima sincronizaci√≥n: {new Date(integrations.slack.lastSync).toLocaleString('es-ES')}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              {integrations.slack.connected ? (\r\n                <button\r\n                  onClick={() => disconnectIntegration('slack')}\r\n                  className=\"w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                >\r\n                  Desconectar\r\n                </button>\r\n              ) : (\r\n                <button\r\n                  onClick={() => {\r\n                    // Placeholder para configuraci√≥n de Slack\r\n                    toast.info('Configuraci√≥n de Slack pr√≥ximamente')\r\n                  }}\r\n                  disabled={integrations.slack.status === 'connecting'}\r\n                  className=\"w-full px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {integrations.slack.status === 'connecting' ? 'Conectando...' : 'Configurar Slack'}\r\n                </button>\r\n              )}\r\n            </div>\r\n\r\n            {/* Microsoft Teams */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100 flex flex-col h-full\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <div className=\"flex items-center\">\r\n                  <div className=\"p-3 rounded-xl bg-gradient-to-br from-indigo-500 to-indigo-600 shadow-lg mr-4\">\r\n                    <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-lg font-bold text-gray-900\">Microsoft Teams</h3>\r\n                    <p className=\"text-sm text-gray-600\">Notificaciones empresariales</p>\r\n                  </div>\r\n                </div>\r\n                {getStatusBadge('teams')}\r\n              </div>\r\n\r\n              <div className=\"flex-grow\">\r\n                <p className=\"text-sm text-gray-600 mb-4\">\r\n                  Env√≠a notificaciones autom√°ticas a equipos de Microsoft Teams.\r\n                </p>\r\n\r\n                <div className=\"space-y-2 mb-4\">\r\n                  {integrations.teams.lastSync && (\r\n                    <div className=\"text-xs text-gray-500\">\r\n                      √öltima sincronizaci√≥n: {new Date(integrations.teams.lastSync).toLocaleString('es-ES')}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              {integrations.teams.connected ? (\r\n                <button\r\n                  onClick={() => disconnectIntegration('teams')}\r\n                  className=\"w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                >\r\n                  Desconectar\r\n                </button>\r\n              ) : (\r\n                <button\r\n                  onClick={configureTeams}\r\n                  disabled={integrations.teams.status === 'connecting'}\r\n                  className=\"w-full px-4 py-2 bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {integrations.teams.status === 'connecting' ? 'Conectando...' : 'Configurar Teams'}\r\n                </button>\r\n              )}\r\n            </div>\r\n\r\n            {/* HubSpot */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100 flex flex-col h-full\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <div className=\"flex items-center\">\r\n                  <div className=\"p-3 rounded-xl bg-gradient-to-br from-orange-500 to-orange-600 shadow-lg mr-4\">\r\n                    <BuildingStorefrontIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-lg font-bold text-gray-900\">HubSpot</h3>\r\n                    <p className=\"text-sm text-gray-600\">CRM y marketing</p>\r\n                  </div>\r\n                </div>\r\n                {getStatusBadge('hubspot')}\r\n              </div>\r\n\r\n              <div className=\"flex-grow\">\r\n                <p className=\"text-sm text-gray-600 mb-4\">\r\n                  Sincroniza datos de contactos y automatiza comunicaciones basadas en CRM.\r\n                </p>\r\n\r\n                <div className=\"space-y-2 mb-4\">\r\n                  {integrations.hubspot.lastSync && (\r\n                    <div className=\"text-xs text-gray-500\">\r\n                      √öltima sincronizaci√≥n: {new Date(integrations.hubspot.lastSync).toLocaleString('es-ES')}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              {integrations.hubspot.connected ? (\r\n                <button\r\n                  onClick={() => disconnectIntegration('hubspot')}\r\n                  className=\"w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                >\r\n                  Desconectar\r\n                </button>\r\n              ) : (\r\n                <button\r\n                  onClick={configureHubSpot}\r\n                  disabled={integrations.hubspot.status === 'connecting'}\r\n                  className=\"w-full px-4 py-2 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {integrations.hubspot.status === 'connecting' ? 'Conectando...' : 'Configurar HubSpot'}\r\n                </button>\r\n              )}\r\n            </div>\r\n\r\n            {/* Salesforce */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100 flex flex-col h-full\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <div className=\"flex items-center\">\r\n                  <div className=\"p-3 rounded-xl bg-gradient-to-br from-blue-600 to-blue-700 shadow-lg mr-4\">\r\n                    <BuildingStorefrontIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-lg font-bold text-gray-900\">Salesforce</h3>\r\n                    <p className=\"text-sm text-gray-600\">CRM empresarial</p>\r\n                  </div>\r\n                </div>\r\n                {getStatusBadge('salesforce')}\r\n              </div>\r\n\r\n              <div className=\"flex-grow\">\r\n                <p className=\"text-sm text-gray-600 mb-4\">\r\n                  Sincroniza datos de leads y oportunidades con Salesforce.\r\n                </p>\r\n\r\n                <div className=\"space-y-2 mb-4\">\r\n                  {integrations.salesforce.lastSync && (\r\n                    <div className=\"text-xs text-gray-500\">\r\n                      √öltima sincronizaci√≥n: {new Date(integrations.salesforce.lastSync).toLocaleString('es-ES')}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              {integrations.salesforce.connected ? (\r\n                <button\r\n                  onClick={() => disconnectIntegration('salesforce')}\r\n                  className=\"w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                >\r\n                  Desconectar\r\n                </button>\r\n              ) : (\r\n                <button\r\n                  onClick={configureSalesforce}\r\n                  disabled={integrations.salesforce.status === 'connecting'}\r\n                  className=\"w-full px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {integrations.salesforce.status === 'connecting' ? 'Conectando...' : 'Configurar Salesforce'}\r\n                </button>\r\n              )}\r\n            </div>\r\n\r\n            {/* Brevo - SMS y Email Masivo */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100 flex flex-col h-full\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <div className=\"flex items-center\">\r\n                  <div className=\"p-3 rounded-xl bg-gradient-to-br from-blue-600 to-blue-700 shadow-lg mr-4\">\r\n                    <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-lg font-bold text-gray-900\">Brevo</h3>\r\n                    <p className=\"text-sm text-gray-600\">SMS y Email Masivo</p>\r\n                  </div>\r\n                </div>\r\n                {getStatusBadge('brevo')}\r\n              </div>\r\n\r\n              <div className=\"flex-grow\">\r\n                <p className=\"text-sm text-gray-600 mb-4\">\r\n                  Env√≠o masivo de SMS y emails con estad√≠sticas en tiempo real, plantillas personalizadas y programaci√≥n de env√≠os.\r\n                </p>\r\n\r\n                <div className=\"space-y-2 mb-4\">\r\n                  {integrations.brevo.lastSync && (\r\n                    <div className=\"text-xs text-gray-500\">\r\n                      √öltima sincronizaci√≥n: {new Date(integrations.brevo.lastSync).toLocaleString('es-ES')}\r\n                    </div>\r\n                  )}\r\n                  {integrations.brevo.testMode && (\r\n                    <div className=\"text-xs text-yellow-600 bg-yellow-50 px-2 py-1 rounded-full inline-block\">\r\n                      üß™ Modo prueba activo\r\n                    </div>\r\n                  )}\r\n                </div>\r\n\r\n                {integrations.brevo.connected && (\r\n                  <div className=\"mt-4 p-4 bg-green-50 border border-green-200 rounded-lg\">\r\n                    <div className=\"flex items-center mb-2\">\r\n                      <CheckCircleIcon className=\"h-5 w-5 text-green-500 mr-2\" />\r\n                      <span className=\"text-sm font-medium text-green-800\">Brevo configurado</span>\r\n                    </div>\r\n                    <div className=\"text-xs text-green-600\">\r\n                      <p>‚Ä¢ SMS masivo activado (hasta 1000 por lote)</p>\r\n                      <p>‚Ä¢ Email masivo activado (hasta 2000 por lote)</p>\r\n                      <p>‚Ä¢ Estad√≠sticas en tiempo real</p>\r\n                      <p>‚Ä¢ Plantillas personalizadas</p>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              {integrations.brevo.connected ? (\r\n                <div className=\"space-y-2\">\r\n                  <Link\r\n                    to=\"/estadisticas-brevo\"\r\n                    className=\"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center\"\r\n                  >\r\n                    üìä Ver Estad√≠sticas\r\n                  </Link>\r\n                  <Link\r\n                    to=\"/plantillas-brevo\"\r\n                    className=\"w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center\"\r\n                  >\r\n                    üìù Gestionar Plantillas\r\n                  </Link>\r\n                  <button\r\n                    onClick={() => disconnectIntegration('brevo')}\r\n                    className=\"w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                  >\r\n                    Desconectar Brevo\r\n                  </button>\r\n                  <button\r\n                    onClick={() => {\r\n                      Swal.fire({\r\n                        title: 'üìä Informaci√≥n de Brevo',\r\n                        html: `\r\n                          <div style=\"text-align: left;\">\r\n                            <div style=\"background-color: #f0f8ff; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                              <h4 style=\"margin: 0 0 8px 0; color: #0066ff;\">Funcionalidades Activas</h4>\r\n                              <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                                <li>‚úÖ Env√≠o masivo de SMS</li>\r\n                                <li>‚úÖ Env√≠o masivo de Email</li>\r\n                                <li>‚úÖ Estad√≠sticas en tiempo real</li>\r\n                                <li>‚úÖ Plantillas personalizadas</li>\r\n                                <li>‚úÖ Programaci√≥n de env√≠os</li>\r\n                                <li>‚úÖ Modo prueba ${integrations.brevo.testMode ? 'activado' : 'desactivado'}</li>\r\n                              </ul>\r\n                            </div>\r\n                            <div style=\"background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n                              <h4 style=\"margin: 0 0 8px 0; color: #333;\">Configuraci√≥n</h4>\r\n                              <p style=\"margin: 4px 0; font-size: 14px;\">\r\n                                <strong>Estado:</strong> <span style=\"color: #28a745;\">Conectado</span><br>\r\n                                <strong>Modo:</strong> ${integrations.brevo.testMode ? 'Prueba üß™' : 'Producci√≥n üöÄ'}<br>\r\n                                <strong>√öltima sincronizaci√≥n:</strong> ${new Date(integrations.brevo.lastSync).toLocaleString('es-ES')}\r\n                              </p>\r\n                            </div>\r\n                          </div>\r\n                        `,\r\n                        icon: 'info',\r\n                        confirmButtonText: 'Entendido',\r\n                        confirmButtonColor: '#0066ff',\r\n                        width: '500px'\r\n                      });\r\n                    }}\r\n                    className=\"w-full px-4 py-2 bg-gray-100 text-gray-700 hover:bg-gray-200 font-semibold rounded-xl transition-all duration-300\"\r\n                  >\r\n                    ‚ÑπÔ∏è Ver Informaci√≥n\r\n                  </button>\r\n                </div>\r\n              ) : (\r\n                <button\r\n                  onClick={configureBrevo}\r\n                  disabled={integrations.brevo.status === 'connecting'}\r\n                  className=\"w-full px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {integrations.brevo.status === 'connecting' ? 'Conectando...' : 'Configurar Brevo'}\r\n                </button>\r\n              )}\r\n            </div>\r\n\r\n            {/* Groq AI */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100 flex flex-col h-full\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <div className=\"flex items-center\">\r\n                  <div className=\"p-3 rounded-xl bg-gradient-to-br from-green-600 to-green-700 shadow-lg mr-4\">\r\n                    <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-lg font-bold text-gray-900\">Groq AI</h3>\r\n                    <p className=\"text-sm text-gray-600\">Inteligencia Artificial</p>\r\n                  </div>\r\n                </div>\r\n                {getStatusBadge('groq')}\r\n              </div>\r\n\r\n              <div className=\"flex-grow\">\r\n                <p className=\"text-sm text-gray-600 mb-4\">\r\n                  Motor de IA con modelos avanzados para chat, an√°lisis de sentimientos, resumen de documentos y m√°s.\r\n                </p>\r\n\r\n                <div className=\"space-y-2 mb-4\">\r\n                  {integrations.groq.lastSync && (\r\n                    <div className=\"text-xs text-gray-500\">\r\n                      √öltima sincronizaci√≥n: {new Date(integrations.groq.lastSync).toLocaleString('es-ES')}\r\n                    </div>\r\n                  )}\r\n                  {integrations.groq.model && (\r\n                    <div className=\"text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded-full inline-block\">\r\n                      Modelo: {integrations.groq.model}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n\r\n                {integrations.groq.connected && (\r\n                  <div className=\"mt-4 p-4 bg-green-50 border border-green-200 rounded-lg\">\r\n                    <div className=\"flex items-center mb-2\">\r\n                      <CheckCircleIcon className=\"h-5 w-5 text-green-500 mr-2\" />\r\n                      <span className=\"text-sm font-medium text-green-800\">Groq AI configurado</span>\r\n                    </div>\r\n                    <div className=\"text-xs text-green-600\">\r\n                      <p>‚Ä¢ Chat inteligente activo</p>\r\n                      <p>‚Ä¢ An√°lisis de sentimientos disponible</p>\r\n                      <p>‚Ä¢ Resumen de documentos activo</p>\r\n                      <p>‚Ä¢ Modelo: {integrations.groq.model}</p>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              {integrations.groq.connected ? (\r\n                <div className=\"space-y-2\">\r\n                  <button\r\n                    onClick={() => {\r\n                      Swal.fire({\r\n                        title: 'ü§ñ Informaci√≥n de Groq AI',\r\n                        html: `\r\n                          <div style=\"text-align: left;\">\r\n                            <div style=\"background-color: #f0f8ff; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                              <h4 style=\"margin: 0 0 8px 0; color: #00a67e;\">Funcionalidades Activas</h4>\r\n                              <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                                <li>‚úÖ Chat inteligente con contexto</li>\r\n                                <li>‚úÖ An√°lisis de sentimientos</li>\r\n                                <li>‚úÖ Resumen de documentos</li>\r\n                                <li>‚úÖ Generaci√≥n de contenido</li>\r\n                                <li>‚úÖ Soporte para espa√±ol optimizado</li>\r\n                                <li>‚úÖ Tracking de uso de tokens</li>\r\n                              </ul>\r\n                            </div>\r\n                            <div style=\"background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n                              <h4 style=\"margin: 0 0 8px 0; color: #333;\">Configuraci√≥n</h4>\r\n                              <p style=\"margin: 4px 0; font-size: 14px;\">\r\n                                <strong>Estado:</strong> <span style=\"color: #28a745;\">Conectado</span><br>\r\n                                <strong>Modelo:</strong> ${integrations.groq.model}<br>\r\n                                <strong>√öltima sincronizaci√≥n:</strong> ${new Date(integrations.groq.lastSync).toLocaleString('es-ES')}\r\n                              </p>\r\n                            </div>\r\n                          </div>\r\n                        `,\r\n                        icon: 'info',\r\n                        confirmButtonText: 'Entendido',\r\n                        confirmButtonColor: '#00a67e',\r\n                        width: '500px'\r\n                      });\r\n                    }}\r\n                    className=\"w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                  >\r\n                    ‚ÑπÔ∏è Ver Informaci√≥n\r\n                  </button>\r\n                  <button\r\n                    onClick={() => disconnectIntegration('groq')}\r\n                    className=\"w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                  >\r\n                    Desconectar Groq\r\n                  </button>\r\n                </div>\r\n              ) : (\r\n                <button\r\n                  onClick={configureGroq}\r\n                  disabled={integrations.groq.status === 'connecting'}\r\n                  className=\"w-full px-4 py-2 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {integrations.groq.status === 'connecting' ? 'Conectando...' : 'Configurar Groq AI'}\r\n                </button>\r\n              )}\r\n            </div>\r\n\r\n\r\n            {/* WhatsApp Official API */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100 flex flex-col h-full\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <div className=\"flex items-center\">\r\n                  <div className=\"p-3 rounded-xl bg-gradient-to-br from-green-500 to-green-600 shadow-lg mr-4\">\r\n                    <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-lg font-bold text-gray-900\">WhatsApp Business API</h3>\r\n                    <p className=\"text-sm text-gray-600\">API oficial de Meta</p>\r\n                  </div>\r\n                </div>\r\n                {getStatusBadge('whatsappOfficial')}\r\n              </div>\r\n\r\n              <div className=\"flex-grow\">\r\n                <p className=\"text-sm text-gray-600 mb-4\">\r\n                  Configura la API oficial de WhatsApp Business para enviar mensajes autom√°ticos y notificaciones con la plataforma de Meta.\r\n                </p>\r\n\r\n                <div className=\"space-y-2 mb-4\">\r\n                  {integrations.whatsappOfficial.lastSync && (\r\n                    <div className=\"text-xs text-gray-500\">\r\n                      √öltima sincronizaci√≥n: {new Date(integrations.whatsappOfficial.lastSync).toLocaleString('es-ES')}\r\n                    </div>\r\n                  )}\r\n                  {integrations.whatsappOfficial.testMode && (\r\n                    <div className=\"text-xs text-yellow-600 bg-yellow-50 px-2 py-1 rounded-full inline-block\">\r\n                      üß™ Modo prueba activo\r\n                    </div>\r\n                  )}\r\n                </div>\r\n\r\n                {integrations.whatsappOfficial.connected && (\r\n                  <div className=\"mt-4 p-4 bg-green-50 border border-green-200 rounded-lg\">\r\n                    <div className=\"flex items-center mb-2\">\r\n                      <CheckCircleIcon className=\"h-5 w-5 text-green-500 mr-2\" />\r\n                      <span className=\"text-sm font-medium text-green-800\">WhatsApp Official configurado</span>\r\n                    </div>\r\n                    <div className=\"text-xs text-green-600\">\r\n                      <p>‚Ä¢ API oficial de Meta conectada</p>\r\n                      <p>‚Ä¢ Env√≠o de mensajes activo</p>\r\n                      <p>‚Ä¢ Webhooks configurados</p>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              {integrations.whatsappOfficial.connected ? (\r\n                <div className=\"space-y-2\">\r\n                  <button\r\n                    onClick={() => {\r\n                      Swal.fire({\r\n                        title: 'üì± Informaci√≥n de WhatsApp Official',\r\n                        html: `\r\n                          <div style=\"text-align: left;\">\r\n                            <div style=\"background-color: #f0f8ff; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                              <h4 style=\"margin: 0 0 8px 0; color: #25d366;\">Funcionalidades Activas</h4>\r\n                              <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                                <li>‚úÖ Env√≠o de mensajes individuales</li>\r\n                                <li>‚úÖ Env√≠o masivo de mensajes</li>\r\n                                <li>‚úÖ Plantillas pre-aprobadas</li>\r\n                                <li>‚úÖ Webhooks en tiempo real</li>\r\n                                <li>‚úÖ Estad√≠sticas de uso</li>\r\n                                <li>‚úÖ Modo prueba ${integrations.whatsappOfficial.testMode ? 'activado' : 'desactivado'}</li>\r\n                              </ul>\r\n                            </div>\r\n                            <div style=\"background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n                              <h4 style=\"margin: 0 0 8px 0; color: #333;\">Configuraci√≥n</h4>\r\n                              <p style=\"margin: 4px 0; font-size: 14px;\">\r\n                                <strong>Estado:</strong> <span style=\"color: #28a745;\">Conectado</span><br>\r\n                                <strong>Modo:</strong> ${integrations.whatsappOfficial.testMode ? 'Prueba üß™' : 'Producci√≥n üöÄ'}<br>\r\n                                <strong>√öltima sincronizaci√≥n:</strong> ${new Date(integrations.whatsappOfficial.lastSync).toLocaleString('es-ES')}\r\n                              </p>\r\n                            </div>\r\n                          </div>\r\n                        `,\r\n                        icon: 'info',\r\n                        confirmButtonText: 'Entendido',\r\n                        confirmButtonColor: '#25d366',\r\n                        width: '500px'\r\n                      });\r\n                    }}\r\n                    className=\"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                  >\r\n                    ‚ÑπÔ∏è Ver Informaci√≥n\r\n                  </button>\r\n                  <button\r\n                    onClick={() => disconnectIntegration('whatsappOfficial')}\r\n                    className=\"w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                  >\r\n                    Desconectar WhatsApp Official\r\n                  </button>\r\n                </div>\r\n              ) : (\r\n                <button\r\n                  onClick={configureWhatsAppOfficial}\r\n                  disabled={integrations.whatsappOfficial.status === 'connecting'}\r\n                  className=\"w-full px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {integrations.whatsappOfficial.status === 'connecting' ? 'Conectando...' : 'Configurar WhatsApp Official'}\r\n                </button>\r\n              )}\r\n            </div>\r\n\r\n            {/* WhatsApp WAHA API */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100 flex flex-col h-full\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <div className=\"flex items-center\">\r\n                  <div className=\"p-3 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 shadow-lg mr-4\">\r\n                    <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-lg font-bold text-gray-900\">WhatsApp WAHA API</h3>\r\n                    <p className=\"text-sm text-gray-600\">API waha.devike.pro</p>\r\n                  </div>\r\n                </div>\r\n                {getStatusBadge('whatsappWaha')}\r\n              </div>\r\n\r\n              <div className=\"flex-grow\">\r\n                <p className=\"text-sm text-gray-600 mb-4\">\r\n                  Configura la API de WAHA (waha.devike.pro) para enviar mensajes a trav√©s de su plataforma.\r\n                </p>\r\n\r\n                <div className=\"space-y-2 mb-4\">\r\n                  {integrations.whatsappWaha.lastSync && (\r\n                    <div className=\"text-xs text-gray-500\">\r\n                      √öltima sincronizaci√≥n: {new Date(integrations.whatsappWaha.lastSync).toLocaleString('es-ES')}\r\n                    </div>\r\n                  )}\r\n                  {integrations.whatsappWaha.testMode && (\r\n                    <div className=\"text-xs text-yellow-600 bg-yellow-50 px-2 py-1 rounded-full inline-block\">\r\n                      üß™ Modo prueba activo\r\n                    </div>\r\n                  )}\r\n                </div>\r\n\r\n                {integrations.whatsappWaha.connected && (\r\n                  <div className=\"mt-4 p-4 bg-green-50 border border-green-200 rounded-lg\">\r\n                    <div className=\"flex items-center mb-2\">\r\n                      <CheckCircleIcon className=\"h-5 w-5 text-green-500 mr-2\" />\r\n                      <span className=\"text-sm font-medium text-green-800\">WhatsApp WAHA configurado</span>\r\n                    </div>\r\n                    <div className=\"text-xs text-green-600\">\r\n                      <p>‚Ä¢ API WAHA conectada</p>\r\n                      <p>‚Ä¢ Env√≠o de mensajes activo</p>\r\n                      <p>‚Ä¢ Sesi√≥n establecida</p>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              {integrations.whatsappWaha.connected ? (\r\n                <div className=\"space-y-2\">\r\n                  <button\r\n                    onClick={() => {\r\n                      Swal.fire({\r\n                        title: 'üì± Informaci√≥n de WhatsApp WAHA',\r\n                        html: `\r\n                          <div style=\"text-align: left;\">\r\n                            <div style=\"background-color: #f0f8ff; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                              <h4 style=\"margin: 0 0 8px 0; color: #9333ea;\">Funcionalidades Activas</h4>\r\n                              <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                                <li>‚úÖ Env√≠o de mensajes individuales</li>\r\n                                <li>‚úÖ Env√≠o masivo de mensajes</li>\r\n                                <li>‚úÖ Env√≠o de archivos</li>\r\n                                <li>‚úÖ Env√≠o de ubicaciones</li>\r\n                                <li>‚úÖ Gesti√≥n de sesiones</li>\r\n                                <li>‚úÖ Modo prueba ${integrations.whatsappWaha.testMode ? 'activado' : 'desactivado'}</li>\r\n                              </ul>\r\n                            </div>\r\n                            <div style=\"background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n                              <h4 style=\"margin: 0 0 8px 0; color: #333;\">Configuraci√≥n</h4>\r\n                              <p style=\"margin: 4px 0; font-size: 14px;\">\r\n                                <strong>Estado:</strong> <span style=\"color: #28a745;\">Conectado</span><br>\r\n                                <strong>Modo:</strong> ${integrations.whatsappWaha.testMode ? 'Prueba üß™' : 'Producci√≥n üöÄ'}<br>\r\n                                <strong>√öltima sincronizaci√≥n:</strong> ${new Date(integrations.whatsappWaha.lastSync).toLocaleString('es-ES')}\r\n                              </p>\r\n                            </div>\r\n                          </div>\r\n                        `,\r\n                        icon: 'info',\r\n                        confirmButtonText: 'Entendido',\r\n                        confirmButtonColor: '#9333ea',\r\n                        width: '500px'\r\n                      });\r\n                    }}\r\n                    className=\"w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                  >\r\n                    ‚ÑπÔ∏è Ver Informaci√≥n\r\n                  </button>\r\n                  <button\r\n                    onClick={() => disconnectIntegration('whatsappWaha')}\r\n                    className=\"w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                  >\r\n                    Desconectar WhatsApp WAHA\r\n                  </button>\r\n                </div>\r\n              ) : (\r\n                <button\r\n                  onClick={configureWhatsAppWaha}\r\n                  disabled={integrations.whatsappWaha.status === 'connecting'}\r\n                  className=\"w-full px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {integrations.whatsappWaha.status === 'connecting' ? 'Conectando...' : 'Configurar WhatsApp WAHA'}\r\n                </button>\r\n              )}\r\n            </div>\r\n\r\n            {/* Asistente de Configuraci√≥n Inicial de WhatsApp */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100 flex flex-col h-full\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <div className=\"flex items-center\">\r\n                  <div className=\"p-3 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 shadow-lg mr-4\">\r\n                    <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-lg font-bold text-gray-900\">Asistente de Configuraci√≥n Inicial</h3>\r\n                    <p className=\"text-sm text-gray-600\">Configuraci√≥n guiada</p>\r\n                  </div>\r\n                </div>\r\n                <span className=\"px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full\">Gu√≠a paso a paso</span>\r\n              </div>\r\n\r\n              <div className=\"flex-grow\">\r\n                <p className=\"text-sm text-gray-600 mb-4\">\r\n                  Asistente interactivo que te gu√≠a paso a paso en la configuraci√≥n inicial de WhatsApp Business API.\r\n                </p>\r\n\r\n                <div className=\"space-y-3 mb-4\">\r\n                  <div className=\"flex items-center text-xs text-gray-600\">\r\n                    <div className=\"w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mr-2 font-semibold\">1</div>\r\n                    <span>Obt√©n tus credenciales de Meta</span>\r\n                  </div>\r\n                  <div className=\"flex items-center text-xs text-gray-600\">\r\n                    <div className=\"w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mr-2 font-semibold\">2</div>\r\n                    <span>Configura tu n√∫mero de tel√©fono</span>\r\n                  </div>\r\n                  <div className=\"flex items-center text-xs text-gray-600\">\r\n                    <div className=\"w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mr-2 font-semibold\">3</div>\r\n                    <span>Personaliza plantillas de mensaje</span>\r\n                  </div>\r\n                  <div className=\"flex items-center text-xs text-gray-600\">\r\n                    <div className=\"w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mr-2 font-semibold\">4</div>\r\n                    <span>Prueba el funcionamiento</span>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-3\">\r\n                  <div className=\"flex items-start\">\r\n                    <div className=\"p-1 rounded bg-blue-100 mr-2\">\r\n                      <ChatBubbleLeftRightIcon className=\"h-4 w-4 text-blue-600\" />\r\n                    </div>\r\n                    <div>\r\n                      <h4 className=\"text-sm font-medium text-blue-800 mb-1\">Ideal para:</h4>\r\n                      <ul className=\"text-xs text-blue-600 space-y-1\">\r\n                        <li>‚Ä¢ Primeros usuarios de WhatsApp API</li>\r\n                        <li>‚Ä¢ Configuraci√≥n sin experiencia t√©cnica</li>\r\n                        <li>‚Ä¢ Empresas que reci√©n inician con WhatsApp</li>\r\n                      </ul>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <Link\r\n                to=\"/whatsapp/setup\"\r\n                className=\"w-full px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center\"\r\n              >\r\n                üöÄ Iniciar Configuraci√≥n Guiada\r\n              </Link>\r\n            </div>\r\n\r\n            {/* Panel de Gesti√≥n Avanzada de WhatsApp */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100 flex flex-col h-full\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <div className=\"flex items-center\">\r\n                  <div className=\"p-3 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 shadow-lg mr-4\">\r\n                    <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-lg font-bold text-gray-900\">Panel de Gesti√≥n Avanzada</h3>\r\n                    <p className=\"text-sm text-gray-600\">Multi-agencia</p>\r\n                  </div>\r\n                </div>\r\n                <span className=\"px-2 py-1 bg-purple-100 text-purple-800 text-xs font-medium rounded-full\">Avanzado</span>\r\n              </div>\r\n\r\n              <div className=\"flex-grow\">\r\n                <p className=\"text-sm text-gray-600 mb-4\">\r\n                  Gestiona m√∫ltiples cuentas de WhatsApp, agencias y configuraciones avanzadas desde un panel centralizado.\r\n                </p>\r\n\r\n                <div className=\"space-y-3 mb-4\">\r\n                  <div className=\"flex items-center text-xs text-gray-600\">\r\n                    <div className=\"w-6 h-6 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mr-2 font-semibold\">‚úì</div>\r\n                    <span>Gesti√≥n multi-agencia</span>\r\n                  </div>\r\n                  <div className=\"flex items-center text-xs text-gray-600\">\r\n                    <div className=\"w-6 h-6 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mr-2 font-semibold\">‚úì</div>\r\n                    <span>Configuraciones avanzadas</span>\r\n                  </div>\r\n                  <div className=\"flex items-center text-xs text-gray-600\">\r\n                    <div className=\"w-6 h-6 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mr-2 font-semibold\">‚úì</div>\r\n                    <span>Estad√≠sticas detalladas</span>\r\n                  </div>\r\n                  <div className=\"flex items-center text-xs text-gray-600\">\r\n                    <div className=\"w-6 h-6 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mr-2 font-semibold\">‚úì</div>\r\n                    <span>Control de acceso por roles</span>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"bg-purple-50 border border-purple-200 rounded-lg p-3\">\r\n                  <div className=\"flex items-start\">\r\n                    <div className=\"p-1 rounded bg-purple-100 mr-2\">\r\n                      <ChatBubbleLeftRightIcon className=\"h-4 w-4 text-purple-600\" />\r\n                    </div>\r\n                    <div>\r\n                      <h4 className=\"text-sm font-medium text-purple-800 mb-1\">Ideal para:</h4>\r\n                      <ul className=\"text-xs text-purple-600 space-y-1\">\r\n                        <li>‚Ä¢ Agencias de marketing digital</li>\r\n                        <li>‚Ä¢ Empresas con m√∫ltiples marcas</li>\r\n                        <li>‚Ä¢ Usuarios con experiencia t√©cnica</li>\r\n                        <li>‚Ä¢ Gesti√≥n de clientes a gran escala</li>\r\n                      </ul>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <Link\r\n                to=\"/whatsapp/multi-manager\"\r\n                className=\"w-full px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center\"\r\n              >\r\n                ‚öôÔ∏è Acceder Panel Avanzado\r\n              </Link>\r\n            </div>\r\n\r\n            {/* Telegram Bot */}\r\n            <div className=\"bg-white rounded-3xl p-6 shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100 flex flex-col h-full\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <div className=\"flex items-center\">\r\n                  <div className=\"p-3 rounded-xl bg-gradient-to-br from-blue-400 to-blue-600 shadow-lg mr-4\">\r\n                    <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-lg font-bold text-gray-900\">Telegram Bot</h3>\r\n                    <p className=\"text-sm text-gray-600\">Mensajer√≠a instant√°nea</p>\r\n                  </div>\r\n                </div>\r\n                {getStatusBadge('telegram')}\r\n              </div>\r\n\r\n              <div className=\"flex-grow\">\r\n                <p className=\"text-sm text-gray-600 mb-4\">\r\n                  Configura un bot de Telegram para enviar mensajes autom√°ticos y notificaciones a tus usuarios.\r\n                </p>\r\n\r\n                <div className=\"space-y-2 mb-4\">\r\n                  {integrations.telegram.lastSync && (\r\n                    <div className=\"text-xs text-gray-500\">\r\n                      √öltima sincronizaci√≥n: {new Date(integrations.telegram.lastSync).toLocaleString('es-ES')}\r\n                    </div>\r\n                  )}\r\n                  {integrations.telegram.botUsername && (\r\n                    <div className=\"text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded-full inline-block\">\r\n                      Bot: {integrations.telegram.botUsername}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n\r\n                {integrations.telegram.connected && (\r\n                  <div className=\"mt-4 p-4 bg-green-50 border border-green-200 rounded-lg\">\r\n                    <div className=\"flex items-center mb-2\">\r\n                      <CheckCircleIcon className=\"h-5 w-5 text-green-500 mr-2\" />\r\n                      <span className=\"text-sm font-medium text-green-800\">Telegram configurado</span>\r\n                    </div>\r\n                    <div className=\"text-xs text-green-600\">\r\n                      <p>‚Ä¢ Bot de Telegram conectado</p>\r\n                      <p>‚Ä¢ Env√≠o de mensajes activo</p>\r\n                      <p>‚Ä¢ Notificaciones autom√°ticas listas</p>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              {integrations.telegram.connected ? (\r\n                <div className=\"space-y-2\">\r\n                  <button\r\n                    onClick={() => {\r\n                      Swal.fire({\r\n                        title: 'üì± Informaci√≥n de Telegram',\r\n                        html: `\r\n                          <div style=\"text-align: left;\">\r\n                            <div style=\"background-color: #f0f8ff; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                              <h4 style=\"margin: 0 0 8px 0; color: #0088cc;\">Funcionalidades Activas</h4>\r\n                              <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                                <li>‚úÖ Env√≠o de mensajes individuales</li>\r\n                                <li>‚úÖ Env√≠o masivo de mensajes</li>\r\n                                <li>‚úÖ Notificaciones autom√°ticas</li>\r\n                                <li>‚úÖ Integraci√≥n con sistema de comunicaci√≥n</li>\r\n                                <li>‚úÖ Soporte para mensajes formateados</li>\r\n                              </ul>\r\n                            </div>\r\n                            <div style=\"background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n                              <h4 style=\"margin: 0 0 8px 0; color: #333;\">Configuraci√≥n</h4>\r\n                              <p style=\"margin: 4px 0; font-size: 14px;\">\r\n                                <strong>Estado:</strong> <span style=\"color: #28a745;\">Conectado</span><br>\r\n                                <strong>Bot Username:</strong> ${integrations.telegram.botUsername}<br>\r\n                                <strong>√öltima sincronizaci√≥n:</strong> ${new Date(integrations.telegram.lastSync).toLocaleString('es-ES')}\r\n                              </p>\r\n                            </div>\r\n                          </div>\r\n                        `,\r\n                        icon: 'info',\r\n                        confirmButtonText: 'Entendido',\r\n                        confirmButtonColor: '#0088cc',\r\n                        width: '500px'\r\n                      });\r\n                    }}\r\n                    className=\"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                  >\r\n                    ‚ÑπÔ∏è Ver Informaci√≥n\r\n                  </button>\r\n                  <button\r\n                    onClick={() => disconnectIntegration('telegram')}\r\n                    className=\"w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105\"\r\n                  >\r\n                    Desconectar Telegram\r\n                  </button>\r\n                </div>\r\n              ) : (\r\n                <button\r\n                  onClick={configureTelegram}\r\n                  disabled={integrations.telegram.status === 'connecting'}\r\n                  className=\"w-full px-4 py-2 bg-gradient-to-r from-blue-400 to-blue-600 hover:from-blue-500 hover:to-blue-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {integrations.telegram.status === 'connecting' ? 'Conectando...' : 'Configurar Telegram'}\r\n                </button>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Informaci√≥n adicional */}\r\n          <div className=\"bg-gradient-to-r from-blue-50 to-purple-50 rounded-3xl p-6 border border-blue-100\">\r\n            <div className=\"flex items-start\">\r\n              <div className=\"p-2 rounded-lg bg-blue-100 mr-4\">\r\n                <PuzzlePieceIcon className=\"h-5 w-5 text-blue-600\" />\r\n              </div>\r\n              <div>\r\n                <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">¬øNecesitas otra integraci√≥n?</h3>\r\n                <p className=\"text-gray-600 mb-4\">\r\n                  Podemos integrar tu sistema con otras plataformas como Zapier, Make (Integromat),\r\n                  API personalizadas, o cualquier otro servicio que utilices.\r\n                </p>\r\n                <button\r\n                  onClick={() => setShowIntegrationForm(true)}\r\n                  className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors\"\r\n                >\r\n                  Solicitar Integraci√≥n\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {activeTab === 'database' && (\r\n        <DatabaseSettings />\r\n      )}\r\n\r\n      {/* Modal del formulario de solicitud de integraci√≥n */}\r\n      {showIntegrationForm && (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\r\n          <div className=\"bg-white rounded-3xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto\">\r\n            <div className=\"p-6\">\r\n              <div className=\"flex items-center justify-between mb-6\">\r\n                <h3 className=\"text-xl font-bold text-gray-900\">Solicitar Integraci√≥n</h3>\r\n                <button\r\n                  onClick={() => setShowIntegrationForm(false)}\r\n                  className=\"p-2 hover:bg-gray-100 rounded-lg transition-colors\"\r\n                >\r\n                  <XMarkIcon className=\"h-5 w-5 text-gray-500\" />\r\n                </button>\r\n              </div>\r\n\r\n              <form onSubmit={handleIntegrationRequest} className=\"space-y-4\">\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                    Nombre *\r\n                  </label>\r\n                  <input\r\n                    type=\"text\"\r\n                    required\r\n                    value={integrationForm.nombre}\r\n                    onChange={(e) => setIntegrationForm(prev => ({ ...prev, nombre: e.target.value }))}\r\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                    placeholder=\"Ingresa tu nombre\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                    Apellido *\r\n                  </label>\r\n                  <input\r\n                    type=\"text\"\r\n                    required\r\n                    value={integrationForm.apellido}\r\n                    onChange={(e) => setIntegrationForm(prev => ({ ...prev, apellido: e.target.value }))}\r\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                    placeholder=\"Ingresa tu apellido\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                    Empresa *\r\n                  </label>\r\n                  <input\r\n                    type=\"text\"\r\n                    required\r\n                    value={integrationForm.empresa}\r\n                    onChange={(e) => setIntegrationForm(prev => ({ ...prev, empresa: e.target.value }))}\r\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                    placeholder=\"Nombre de tu empresa\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                    Email *\r\n                  </label>\r\n                  <input\r\n                    type=\"email\"\r\n                    required\r\n                    value={integrationForm.email}\r\n                    onChange={(e) => setIntegrationForm(prev => ({ ...prev, email: e.target.value }))}\r\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                    placeholder=\"tu@email.com\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                    Tel√©fono *\r\n                  </label>\r\n                  <input\r\n                    type=\"tel\"\r\n                    required\r\n                    value={integrationForm.telefono}\r\n                    onChange={(e) => setIntegrationForm(prev => ({ ...prev, telefono: e.target.value }))}\r\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                    placeholder=\"+56 9 1234 5678\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                    Comentarios\r\n                  </label>\r\n                  <textarea\r\n                    value={integrationForm.comentarios}\r\n                    onChange={(e) => setIntegrationForm(prev => ({ ...prev, comentarios: e.target.value }))}\r\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-vertical\"\r\n                    placeholder=\"Describe brevemente qu√© integraci√≥n necesitas y c√≥mo la utilizar√≠as...\"\r\n                    rows=\"3\"\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"flex space-x-3 pt-4\">\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => setShowIntegrationForm(false)}\r\n                    className=\"flex-1 px-4 py-2 bg-gray-100 text-gray-700 hover:bg-gray-200 font-semibold rounded-xl transition-all duration-300\"\r\n                  >\r\n                    Cancelar\r\n                  </button>\r\n                  <button\r\n                    type=\"submit\"\r\n                    disabled={sendingIntegrationRequest}\r\n                    className=\"flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                  >\r\n                    {sendingIntegrationRequest ? 'Enviando...' : 'Enviar Solicitud'}\r\n                  </button>\r\n                </div>\r\n              </form>\r\n\r\n              <p className=\"text-xs text-gray-500 mt-4 text-center\">\r\n                * Campos obligatorios. Te contactaremos pronto a tu email.\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default Settings","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\settings\\UserForm.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'currentUser' is assigned a value but never used.","line":18,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":28},{"ruleId":"no-use-before-define","severity":1,"message":"'loadPermissionsByCategory' was used before it was defined.","line":48,"column":7,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":48,"endColumn":32},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'loadPermissionsByCategory' function makes the dependencies of useEffect Hook (at line 48) change on every render. Move it inside the useEffect callback. Alternatively, wrap the definition of 'loadPermissionsByCategory' in its own useCallback() Hook.","line":64,"column":9,"nodeType":"VariableDeclarator","endLine":71,"endColumn":4},{"ruleId":"no-unused-vars","severity":1,"message":"'getRoleBadgeColor' is assigned a value but never used.","line":149,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":149,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { useAuth } from '../../contexts/AuthContext.js'\r\nimport inMemoryUserService from '../../services/inMemoryUserService.js'\r\nimport {\r\n  UserIcon,\r\n  ShieldCheckIcon,\r\n  Cog6ToothIcon,\r\n  UserGroupIcon,\r\n  CheckIcon,\r\n  ArrowLeftIcon,\r\n  DocumentCheckIcon,\r\n  EyeIcon,\r\n  EyeSlashIcon\r\n} from '@heroicons/react/24/outline'\r\nimport toast from 'react-hot-toast'\r\n\r\nconst UserForm = ({ user, roles, onSuccess, onCancel }) => {\r\n  const { user: currentUser } = useAuth()\r\n  const [formData, setFormData] = useState({\r\n    email: '',\r\n    full_name: '',\r\n    role_id: '',\r\n    is_active: true\r\n  })\r\n  const [selectedRole, setSelectedRole] = useState(null)\r\n  const [rolePermissions, setRolePermissions] = useState([])\r\n  const [permissionsByCategory, setPermissionsByCategory] = useState({})\r\n  const [loading, setLoading] = useState(false)\r\n  const [showPermissions, setShowPermissions] = useState(false)\r\n\r\n  useEffect(() => {\r\n    if (user) {\r\n      setFormData({\r\n        email: user.email || '',\r\n        full_name: user.full_name || '',\r\n        role_id: user.role_id || '',\r\n        is_active: user.is_active !== false\r\n      })\r\n      setSelectedRole(user.role)\r\n      loadRolePermissions(user.role_id)\r\n    }\r\n  }, [user])\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\nuseEffect(() => {\r\n    loadPermissionsByCategory()\r\n  }, [loadPermissionsByCategory])\r\n\r\n  const loadRolePermissions = async (roleId) => {\r\n    if (!roleId) {\r\n      setRolePermissions([])\r\n      return\r\n    }\r\n\r\n    try {\r\n      const permissions = await inMemoryUserService.getRolePermissions(roleId)\r\n      setRolePermissions(permissions)\r\n    } catch (error) {\r\n      console.error('Error loading role permissions:', error)\r\n    }\r\n  }\r\n\r\n  const loadPermissionsByCategory = async () => {\r\n    try {\r\n      const categories = await inMemoryUserService.getPermissionsByCategory()\r\n      setPermissionsByCategory(categories)\r\n    } catch (error) {\r\n      console.error('Error loading permissions by category:', error)\r\n    }\r\n  }\r\n\r\n  const handleInputChange = (field, value) => {\r\n    setFormData(prev => ({\r\n      ...prev,\r\n      [field]: value\r\n    }))\r\n\r\n    if (field === 'role_id') {\r\n      const role = roles.find(r => r.id === value)\r\n      setSelectedRole(role)\r\n      loadRolePermissions(value)\r\n    }\r\n  }\r\n\r\n  const validateForm = () => {\r\n    if (!formData.email.trim()) {\r\n      toast.error('El email es obligatorio')\r\n      return false\r\n    }\r\n\r\n    if (!formData.full_name.trim()) {\r\n      toast.error('El nombre completo es obligatorio')\r\n      return false\r\n    }\r\n\r\n    if (!formData.role_id) {\r\n      toast.error('Debe seleccionar un rol')\r\n      return false\r\n    }\r\n\r\n    // Validar formato de email\r\n    const emailRegex = /^[^s@]+@[^s@]+.[^s@]+$/\r\n    if (!emailRegex.test(formData.email)) {\r\n      toast.error('El email no tiene un formato v√°lido')\r\n      return false\r\n    }\r\n\r\n    return true\r\n  }\r\n\r\n  const handleSubmit = async (e) => {\r\n    e.preventDefault()\r\n\r\n    if (!validateForm()) return\r\n\r\n    setLoading(true)\r\n\r\n    try {\r\n      if (user) {\r\n        // Actualizar usuario existente\r\n        await inMemoryUserService.updateUser(user.id, formData)\r\n        toast.success('Usuario actualizado exitosamente')\r\n      } else {\r\n        // Crear nuevo usuario\r\n        await inMemoryUserService.createUser(formData)\r\n        toast.success('Usuario creado exitosamente')\r\n      }\r\n\r\n      onSuccess()\r\n    } catch (error) {\r\n      console.error('Error saving user:', error)\r\n      toast.error('Error al guardar el usuario')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const getRoleIcon = (roleName) => {\r\n    switch (roleName) {\r\n      case 'super_admin': return <ShieldCheckIcon className=\"h-5 w-5 text-red-600\" />\r\n      case 'director': return <Cog6ToothIcon className=\"h-5 w-5 text-purple-600\" />\r\n      case 'executive': return <UserIcon className=\"h-5 w-5 text-blue-600\" />\r\n      case 'redactor': return <UserGroupIcon className=\"h-5 w-5 text-green-600\" />\r\n      default: return <UserIcon className=\"h-5 w-5 text-gray-600\" />\r\n    }\r\n  }\r\n\r\n  const getRoleBadgeColor = (roleName) => {\r\n    switch (roleName) {\r\n      case 'super_admin': return 'bg-red-100 text-red-800 border-red-200'\r\n      case 'director': return 'bg-purple-100 text-purple-800 border-purple-200'\r\n      case 'executive': return 'bg-blue-100 text-blue-800 border-blue-200'\r\n      case 'redactor': return 'bg-green-100 text-green-800 border-green-200'\r\n      default: return 'bg-gray-100 text-gray-800 border-gray-200'\r\n    }\r\n  }\r\n\r\n  const getCategoryIcon = (category) => {\r\n    switch (category) {\r\n      case 'dashboard': return 'üìä'\r\n      case 'communication': return 'üí¨'\r\n      case 'files': return 'üìÅ'\r\n      case 'drive': return '‚òÅÔ∏è'\r\n      case 'plans': return 'üí≥'\r\n      case 'settings': return '‚öôÔ∏è'\r\n      case 'profile': return 'üë§'\r\n      case 'search': return 'üîç'\r\n      case 'legal': return '‚öñÔ∏è'\r\n      default: return 'üîß'\r\n    }\r\n  }\r\n\r\n  const getCategoryName = (category) => {\r\n    const names = {\r\n      dashboard: 'Dashboard',\r\n      communication: 'Comunicaci√≥n',\r\n      files: 'Archivos',\r\n      drive: 'Google Drive',\r\n      plans: 'Planes',\r\n      settings: 'Configuraci√≥n',\r\n      profile: 'Perfil',\r\n      search: 'B√∫squeda',\r\n      legal: 'Legal'\r\n    }\r\n    return names[category] || category\r\n  }\r\n\r\n  return (\r\n    <div className=\"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\r\n      {/* Header */}\r\n      <div className=\"mb-8\">\r\n        <button\r\n          onClick={onCancel}\r\n          className=\"inline-flex items-center text-blue-600 hover:text-blue-800 mb-4\"\r\n        >\r\n          <ArrowLeftIcon className=\"h-5 w-5 mr-2\" />\r\n          Volver\r\n        </button>\r\n\r\n        <div className=\"flex items-center\">\r\n          <div className=\"p-3 rounded-2xl bg-gradient-to-br from-green-500 to-emerald-600 shadow-lg mr-4\">\r\n            <UserIcon className=\"h-8 w-8 text-white\" />\r\n          </div>\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold text-gray-900\">\r\n              {user ? 'Editar Usuario' : 'Nuevo Usuario'}\r\n            </h1>\r\n            <p className=\"text-gray-600\">\r\n              {user ? 'Modifica la informaci√≥n del usuario' : 'Crea un nuevo usuario con rol y permisos'}\r\n            </p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <form onSubmit={handleSubmit} className=\"space-y-8\">\r\n        {/* Informaci√≥n B√°sica */}\r\n        <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n          <h2 className=\"text-xl font-semibold text-gray-900 mb-6 flex items-center\">\r\n            <UserIcon className=\"h-6 w-6 mr-3 text-green-600\" />\r\n            Informaci√≥n del Usuario\r\n          </h2>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                Email *\r\n              </label>\r\n              <input\r\n                type=\"email\"\r\n                value={formData.email}\r\n                onChange={(e) => handleInputChange('email', e.target.value)}\r\n                className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors\"\r\n                placeholder=\"usuario@empresa.cl\"\r\n                required\r\n                disabled={!!user} // No permitir cambiar email de usuarios existentes\r\n              />\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                Nombre Completo *\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                value={formData.full_name}\r\n                onChange={(e) => handleInputChange('full_name', e.target.value)}\r\n                className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors\"\r\n                placeholder=\"Juan P√©rez Gonz√°lez\"\r\n                required\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-6\">\r\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n              Estado\r\n            </label>\r\n            <div className=\"flex items-center space-x-4\">\r\n              <label className=\"flex items-center\">\r\n                <input\r\n                  type=\"radio\"\r\n                  name=\"is_active\"\r\n                  checked={formData.is_active}\r\n                  onChange={() => handleInputChange('is_active', true)}\r\n                  className=\"text-green-600 focus:ring-green-500\"\r\n                />\r\n                <span className=\"ml-2 text-sm text-gray-700\">Activo</span>\r\n              </label>\r\n              <label className=\"flex items-center\">\r\n                <input\r\n                  type=\"radio\"\r\n                  name=\"is_active\"\r\n                  checked={!formData.is_active}\r\n                  onChange={() => handleInputChange('is_active', false)}\r\n                  className=\"text-green-600 focus:ring-green-500\"\r\n                />\r\n                <span className=\"ml-2 text-sm text-gray-700\">Inactivo</span>\r\n              </label>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Rol y Permisos */}\r\n        <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n          <h2 className=\"text-xl font-semibold text-gray-900 mb-6 flex items-center\">\r\n            <ShieldCheckIcon className=\"h-6 w-6 mr-3 text-blue-600\" />\r\n            Rol y Permisos\r\n          </h2>\r\n\r\n          <div className=\"mb-6\">\r\n            <label className=\"block text-sm font-medium text-gray-700 mb-4\">\r\n              Rol del Usuario *\r\n            </label>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n              {roles.map((role) => (\r\n                <label\r\n                  key={role.id}\r\n                  className={`relative flex items-center p-4 border-2 rounded-xl cursor-pointer transition-all ${\r\n                    formData.role_id === role.id\r\n                      ? 'border-blue-500 bg-blue-50'\r\n                      : 'border-gray-200 hover:border-gray-300'\r\n                  }`}\r\n                >\r\n                  <input\r\n                    type=\"radio\"\r\n                    name=\"role\"\r\n                    value={role.id}\r\n                    checked={formData.role_id === role.id}\r\n                    onChange={(e) => handleInputChange('role_id', e.target.value)}\r\n                    className=\"sr-only\"\r\n                  />\r\n                  <div className=\"flex items-center flex-1\">\r\n                    {getRoleIcon(role.name)}\r\n                    <div className=\"ml-3\">\r\n                      <div className=\"font-medium text-gray-900\">{role.name_es}</div>\r\n                      <div className=\"text-sm text-gray-600\">{role.description}</div>\r\n                    </div>\r\n                  </div>\r\n                  {formData.role_id === role.id && (\r\n                    <CheckIcon className=\"h-5 w-5 text-blue-600\" />\r\n                  )}\r\n                </label>\r\n              ))}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Mostrar permisos del rol seleccionado */}\r\n          {selectedRole && (\r\n            <div className=\"border-t pt-6\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <h3 className=\"text-lg font-medium text-gray-900\">\r\n                  Permisos del Rol: {selectedRole.name_es}\r\n                </h3>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setShowPermissions(!showPermissions)}\r\n                  className=\"inline-flex items-center text-blue-600 hover:text-blue-800\"\r\n                >\r\n                  {showPermissions ? (\r\n                    <>\r\n                      <EyeSlashIcon className=\"h-4 w-4 mr-1\" />\r\n                      Ocultar\r\n                    </>\r\n                  ) : (\r\n                    <>\r\n                      <EyeIcon className=\"h-4 w-4 mr-1\" />\r\n                      Ver Permisos\r\n                    </>\r\n                  )}\r\n                </button>\r\n              </div>\r\n\r\n              {showPermissions && (\r\n                <div className=\"space-y-4\">\r\n                  {Object.entries(permissionsByCategory).map(([category, permissions]) => {\r\n                    const rolePermsInCategory = rolePermissions.filter(p => p.category === category)\r\n\r\n                    if (rolePermsInCategory.length === 0) return null\r\n\r\n                    return (\r\n                      <div key={category} className=\"bg-gray-50 rounded-xl p-4\">\r\n                        <div className=\"flex items-center mb-3\">\r\n                          <span className=\"text-lg mr-2\">{getCategoryIcon(category)}</span>\r\n                          <h4 className=\"font-medium text-gray-900\">{getCategoryName(category)}</h4>\r\n                          <span className=\"ml-2 text-sm text-gray-500\">\r\n                            ({rolePermsInCategory.length} permisos)\r\n                          </span>\r\n                        </div>\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2\">\r\n                          {rolePermsInCategory.map((permission) => (\r\n                            <div\r\n                              key={permission.id}\r\n                              className=\"flex items-center text-sm text-gray-700 bg-white px-3 py-2 rounded-lg border\"\r\n                            >\r\n                              <CheckIcon className=\"h-4 w-4 text-green-600 mr-2 flex-shrink-0\" />\r\n                              {permission.name_es}\r\n                            </div>\r\n                          ))}\r\n                        </div>\r\n                      </div>\r\n                    )\r\n                  })}\r\n                </div>\r\n              )}\r\n\r\n              <div className=\"mt-4 p-4 bg-blue-50 rounded-xl border border-blue-200\">\r\n                <div className=\"flex items-center\">\r\n                  <ShieldCheckIcon className=\"h-5 w-5 text-blue-600 mr-2\" />\r\n                  <div>\r\n                    <div className=\"font-medium text-blue-900\">\r\n                      Nivel Jer√°rquico: {selectedRole.hierarchy_level}/100\r\n                    </div>\r\n                    <div className=\"text-sm text-blue-700\">\r\n                      {rolePermissions.length} permisos asignados autom√°ticamente\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Actions */}\r\n        <div className=\"flex justify-end space-x-4\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={onCancel}\r\n            className=\"px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-colors\"\r\n          >\r\n            Cancelar\r\n          </button>\r\n          <button\r\n            type=\"submit\"\r\n            disabled={loading}\r\n            className=\"inline-flex items-center px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n          >\r\n            <DocumentCheckIcon className=\"h-5 w-5 mr-2\" />\r\n            {loading ? 'Guardando...' : (user ? 'Actualizar Usuario' : 'Crear Usuario')}\r\n          </button>\r\n        </div>\r\n      </form>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default UserForm","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\settings\\UserManagement.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'user' is assigned a value but never used.","line":19,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":15},{"ruleId":"no-use-before-define","severity":1,"message":"'loadData' was used before it was defined.","line":31,"column":7,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":31,"endColumn":15},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'loadData' function makes the dependencies of useEffect Hook (at line 31) change on every render. To fix this, wrap the definition of 'loadData' in its own useCallback() Hook.","line":33,"column":9,"nodeType":"VariableDeclarator","endLine":51,"endColumn":4,"suggestions":[{"desc":"Wrap the definition of 'loadData' in its own useCallback() Hook.","fix":{"range":[1058,1585],"text":"useCallback(async () => {\r\n    try {\r\n      setLoading(true)\r\n      \r\n      // Cargar usuarios y roles desde la base de datos organizada\r\n      const [usersData, rolesData] = await Promise.all([\r\n        organizedDatabaseService.getUsers(),\r\n        organizedDatabaseService.getRoles()\r\n      ])\r\n\r\n      setUsers(usersData || [])\r\n      setRoles(rolesData || [])\r\n    } catch (error) {\r\n      console.error('Error loading data:', error)\r\n      toast.error('Error al cargar los datos')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  })"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { useAuth } from '../../contexts/AuthContext.js'\r\nimport organizedDatabaseService from '../../services/organizedDatabaseService.js'\r\nimport {\r\n  UserGroupIcon,\r\n  PlusIcon,\r\n  PencilIcon,\r\n  TrashIcon,\r\n  CheckCircleIcon,\r\n  XCircleIcon,\r\n  ShieldCheckIcon,\r\n  UserIcon,\r\n  Cog6ToothIcon\r\n} from '@heroicons/react/24/outline'\r\nimport toast from 'react-hot-toast'\r\nimport UserForm from './UserForm.js'\r\n\r\nconst UserManagement = () => {\r\n  const { user } = useAuth()\r\n  const [users, setUsers] = useState([])\r\n  const [roles, setRoles] = useState([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [showUserForm, setShowUserForm] = useState(false)\r\n  const [editingUser, setEditingUser] = useState(null)\r\n  const [searchTerm, setSearchTerm] = useState('')\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\nuseEffect(() => {\r\n    loadData()\r\n  }, [loadData])\r\n\r\n  const loadData = async () => {\r\n    try {\r\n      setLoading(true)\r\n      \r\n      // Cargar usuarios y roles desde la base de datos organizada\r\n      const [usersData, rolesData] = await Promise.all([\r\n        organizedDatabaseService.getUsers(),\r\n        organizedDatabaseService.getRoles()\r\n      ])\r\n\r\n      setUsers(usersData || [])\r\n      setRoles(rolesData || [])\r\n    } catch (error) {\r\n      console.error('Error loading data:', error)\r\n      toast.error('Error al cargar los datos')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleCreateUser = () => {\r\n    setEditingUser(null)\r\n    setShowUserForm(true)\r\n  }\r\n\r\n  const handleEditUser = (user) => {\r\n    setEditingUser(user)\r\n    setShowUserForm(true)\r\n  }\r\n\r\n  const handleDeleteUser = async (userId) => {\r\n    const userToDelete = users.find(u => u.id === userId)\r\n    if (!userToDelete) return\r\n\r\n    const confirmed = await new Promise((resolve) => {\r\n      toast((t) => (\r\n        <div>\r\n          <p className=\"font-medium\">¬øEliminar usuario \"{userToDelete.full_name}\"?</p>\r\n          <p className=\"text-sm text-gray-600 mt-1\">Esta acci√≥n no se puede deshacer.</p>\r\n          <div className=\"flex gap-2 mt-3\">\r\n            <button\r\n              onClick={() => {\r\n                toast.dismiss(t.id)\r\n                resolve(true)\r\n              }}\r\n              className=\"px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600\"\r\n            >\r\n              Eliminar\r\n            </button>\r\n            <button\r\n              onClick={() => {\r\n                toast.dismiss(t.id)\r\n                resolve(false)\r\n              }}\r\n              className=\"px-3 py-1 bg-gray-500 text-white text-sm rounded hover:bg-gray-600\"\r\n            >\r\n              Cancelar\r\n            </button>\r\n          </div>\r\n        </div>\r\n      ), { duration: 10000 })\r\n    })\r\n\r\n    if (!confirmed) return\r\n\r\n    try {\r\n      await organizedDatabaseService.deleteUser(userId)\r\n      toast.success('Usuario eliminado exitosamente')\r\n      loadData()\r\n    } catch (error) {\r\n      console.error('Error deleting user:', error)\r\n      toast.error('Error al eliminar el usuario')\r\n    }\r\n  }\r\n\r\n  const handleToggleUserStatus = async (userId) => {\r\n    try {\r\n      await organizedDatabaseService.toggleUserStatus(userId)\r\n      toast.success('Estado del usuario actualizado')\r\n      loadData()\r\n    } catch (error) {\r\n      console.error('Error toggling user status:', error)\r\n      toast.error('Error al cambiar el estado del usuario')\r\n    }\r\n  }\r\n\r\n  const handleFormSuccess = () => {\r\n    setShowUserForm(false)\r\n    setEditingUser(null)\r\n    loadData()\r\n  }\r\n\r\n  const filteredUsers = users.filter(user =>\r\n    user.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    user.full_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    user.role?.name_es?.toLowerCase().includes(searchTerm.toLowerCase())\r\n  )\r\n\r\n  const getRoleBadgeColor = (roleName) => {\r\n    switch (roleName) {\r\n      case 'super_admin': return 'bg-red-100 text-red-800'\r\n      case 'director': return 'bg-purple-100 text-purple-800'\r\n      case 'executive': return 'bg-blue-100 text-blue-800'\r\n      case 'redactor': return 'bg-green-100 text-green-800'\r\n      default: return 'bg-gray-100 text-gray-800'\r\n    }\r\n  }\r\n\r\n  const getRoleIcon = (roleName) => {\r\n    switch (roleName) {\r\n      case 'super_admin': return <ShieldCheckIcon className=\"h-4 w-4\" />\r\n      case 'director': return <Cog6ToothIcon className=\"h-4 w-4\" />\r\n      case 'executive': return <UserIcon className=\"h-4 w-4\" />\r\n      case 'redactor': return <UserGroupIcon className=\"h-4 w-4\" />\r\n      default: return <UserIcon className=\"h-4 w-4\" />\r\n    }\r\n  }\r\n\r\n  if (showUserForm) {\r\n    return (\r\n      <UserForm\r\n        user={editingUser}\r\n        roles={roles}\r\n        onSuccess={handleFormSuccess}\r\n        onCancel={() => setShowUserForm(false)}\r\n      />\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div className=\"flex items-center space-x-4\">\r\n          <div className=\"p-3 rounded-2xl bg-gradient-to-br from-green-500 to-emerald-600 shadow-lg\">\r\n            <UserGroupIcon className=\"h-8 w-8 text-white\" />\r\n          </div>\r\n          <div>\r\n            <h2 className=\"text-2xl font-bold text-gray-900\">Gesti√≥n de Usuarios</h2>\r\n            <p className=\"text-gray-600\">Administra usuarios, roles y permisos del sistema</p>\r\n          </div>\r\n        </div>\r\n        <button\r\n          onClick={handleCreateUser}\r\n          className=\"inline-flex items-center px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5\"\r\n        >\r\n          <PlusIcon className=\"h-5 w-5 mr-2\" />\r\n          Nuevo Usuario\r\n        </button>\r\n      </div>\r\n\r\n      {/* Search */}\r\n      <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n        <div className=\"flex items-center space-x-4\">\r\n          <div className=\"flex-1\">\r\n            <input\r\n              type=\"text\"\r\n              placeholder=\"Buscar usuarios por nombre, email o rol...\"\r\n              value={searchTerm}\r\n              onChange={(e) => setSearchTerm(e.target.value)}\r\n              className=\"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors\"\r\n            />\r\n          </div>\r\n          <div className=\"text-sm text-gray-500\">\r\n            {filteredUsers.length} de {users.length} usuarios\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Users List */}\r\n      {loading ? (\r\n        <div className=\"flex justify-center items-center h-32\">\r\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-green-500\"></div>\r\n        </div>\r\n      ) : filteredUsers.length === 0 ? (\r\n        <div className=\"text-center py-12\">\r\n          <UserGroupIcon className=\"mx-auto h-12 w-12 text-gray-400\" />\r\n          <h3 className=\"mt-2 text-sm font-medium text-gray-900\">No hay usuarios</h3>\r\n          <p className=\"mt-1 text-sm text-gray-500\">\r\n            {searchTerm ? 'No se encontraron usuarios con ese criterio de b√∫squeda.' : 'Comienza creando el primer usuario.'}\r\n          </p>\r\n          {!searchTerm && (\r\n            <div className=\"mt-6\">\r\n              <button\r\n                onClick={handleCreateUser}\r\n                className=\"inline-flex items-center px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5\"\r\n              >\r\n                <PlusIcon className=\"h-5 w-5 mr-2\" />\r\n                Crear Primer Usuario\r\n              </button>\r\n            </div>\r\n          )}\r\n        </div>\r\n      ) : (\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n          {filteredUsers.map((user) => (\r\n            <div\r\n              key={user.id}\r\n              className=\"relative bg-white rounded-3xl p-6 shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100\"\r\n            >\r\n              <div className=\"flex items-start justify-between mb-4\">\r\n                <div className=\"flex items-center\">\r\n                  <div className=\"p-2 rounded-lg bg-gradient-to-br from-green-500 to-emerald-600 shadow-lg mr-3\">\r\n                    <UserIcon className=\"h-6 w-6 text-white\" />\r\n                  </div>\r\n                  <div>\r\n                    <h3 className=\"text-lg font-bold text-gray-900\">{user.full_name}</h3>\r\n                    <p className=\"text-sm text-gray-600\">{user.email}</p>\r\n                  </div>\r\n                </div>\r\n                <button\r\n                  onClick={() => handleToggleUserStatus(user.id)}\r\n                  className={`p-1 rounded-full ${\r\n                    user.is_active\r\n                      ? 'text-green-600 hover:bg-green-50'\r\n                      : 'text-red-600 hover:bg-red-50'\r\n                  }`}\r\n                  title={user.is_active ? 'Desactivar usuario' : 'Activar usuario'}\r\n                >\r\n                  {user.is_active ? (\r\n                    <CheckCircleIcon className=\"h-5 w-5\" />\r\n                  ) : (\r\n                    <XCircleIcon className=\"h-5 w-5\" />\r\n                  )}\r\n                </button>\r\n              </div>\r\n\r\n              {/* Role Badge */}\r\n              <div className=\"mb-4\">\r\n                <div className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${getRoleBadgeColor(user.role.name)}`}>\r\n                  {getRoleIcon(user.role.name)}\r\n                  <span className=\"ml-2\">{user.role.name_es}</span>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Status */}\r\n              <div className=\"mb-4\">\r\n                <div className=\"flex items-center\">\r\n                  <div className={`w-2 h-2 rounded-full mr-2 ${user.is_active ? 'bg-green-500' : 'bg-red-500'}`}></div>\r\n                  <span className={`text-sm font-medium ${user.is_active ? 'text-green-700' : 'text-red-700'}`}>\r\n                    {user.is_active ? 'Activo' : 'Inactivo'}\r\n                  </span>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Permissions Count */}\r\n              <div className=\"mb-4\">\r\n                <div className=\"text-sm text-gray-600\">\r\n                  <span className=\"font-medium\">{user.permissions.length}</span> permisos asignados\r\n                </div>\r\n              </div>\r\n\r\n              {/* Last Login */}\r\n              {user.last_login && (\r\n                <div className=\"mb-4\">\r\n                  <div className=\"text-xs text-gray-500\">\r\n                    √öltimo acceso: {new Date(user.last_login).toLocaleDateString('es-ES', {\r\n                      day: '2-digit',\r\n                      month: '2-digit',\r\n                      year: 'numeric',\r\n                      hour: '2-digit',\r\n                      minute: '2-digit'\r\n                    })}\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              {/* Actions */}\r\n              <div className=\"flex justify-end space-x-2\">\r\n                <button\r\n                  onClick={() => handleEditUser(user)}\r\n                  className=\"p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors\"\r\n                  title=\"Editar usuario\"\r\n                >\r\n                  <PencilIcon className=\"h-4 w-4\" />\r\n                </button>\r\n                <button\r\n                  onClick={() => handleDeleteUser(user.id)}\r\n                  className=\"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors\"\r\n                  title=\"Eliminar usuario\"\r\n                >\r\n                  <TrashIcon className=\"h-4 w-4\" />\r\n                </button>\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      )}\r\n\r\n      {/* Roles Summary */}\r\n      <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n        <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Resumen por Roles</h3>\r\n        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\r\n          {roles.map((role) => {\r\n            const roleUsers = users.filter(u => u.role_id === role.id)\r\n            const activeUsers = roleUsers.filter(u => u.is_active)\r\n\r\n            return (\r\n              <div key={role.id} className=\"text-center\">\r\n                <div className={`inline-flex items-center justify-center w-12 h-12 rounded-full mb-2 ${getRoleBadgeColor(role.name)}`}>\r\n                  {getRoleIcon(role.name)}\r\n                </div>\r\n                <div className=\"text-sm font-medium text-gray-900\">{role.name_es}</div>\r\n                <div className=\"text-lg font-bold text-gray-700\">{activeUsers.length}</div>\r\n                <div className=\"text-xs text-gray-500\">\r\n                  {roleUsers.length - activeUsers.length > 0 && `${roleUsers.length - activeUsers.length} inactivos`}\r\n                </div>\r\n              </div>\r\n            )\r\n          })}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default UserManagement","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\settings\\WhatsAppConfig.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'ExclamationTriangleIcon' is defined but never used.","line":7,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":26},{"ruleId":"no-unused-vars","severity":1,"message":"'PhoneIcon' is defined but never used.","line":10,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'ShieldCheckIcon' is defined but never used.","line":11,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { \r\n  ChatBubbleLeftRightIcon,\r\n  CheckCircleIcon,\r\n  XCircleIcon,\r\n  ArrowPathIcon,\r\n  ExclamationTriangleIcon,\r\n  InformationCircleIcon,\r\n  Cog6ToothIcon,\r\n  PhoneIcon,\r\n  ShieldCheckIcon,\r\n  ChartBarIcon\r\n} from '@heroicons/react/24/outline'\r\nimport toast from 'react-hot-toast'\r\nimport Swal from 'sweetalert2'\r\nimport whatsappService from '../../services/whatsappService.js'\r\n\r\nconst WhatsAppConfig = () => {\r\n  const [config, setConfig] = useState({\r\n    accessToken: '',\r\n    phoneNumberId: '',\r\n    webhookVerifyToken: '',\r\n    testMode: true\r\n  })\r\n  \r\n  const [isConfigured, setIsConfigured] = useState(false)\r\n  const [isConnecting, setIsConnecting] = useState(false)\r\n  const [isTesting, setIsTesting] = useState(false)\r\n  const [connectionStatus, setConnectionStatus] = useState('disconnected')\r\n  const [accountInfo, setAccountInfo] = useState(null)\r\n  const [testPhone, setTestPhone] = useState('')\r\n  const [testMessage, setTestMessage] = useState('Este es un mensaje de prueba desde StaffHub')\r\n  const [showAdvanced, setShowAdvanced] = useState(false)\r\n  const [templates, setTemplates] = useState([])\r\n  const [loadingTemplates, setLoadingTemplates] = useState(false)\r\n\r\n  useEffect(() => {\r\n    // Cargar configuraci√≥n existente\r\n    const savedConfig = whatsappService.loadConfiguration()\r\n    if (savedConfig.accessToken) {\r\n      setConfig(savedConfig)\r\n      setIsConfigured(true)\r\n      setConnectionStatus('connected')\r\n      loadAccountInfo()\r\n      loadTemplates()\r\n    }\r\n  }, [])\r\n\r\n  const loadAccountInfo = async () => {\r\n    try {\r\n      const result = await whatsappService.getAccountInfo()\r\n      if (result.success) {\r\n        setAccountInfo(result.account)\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading account info:', error)\r\n    }\r\n  }\r\n\r\n  const loadTemplates = async () => {\r\n    setLoadingTemplates(true)\r\n    try {\r\n      const result = await whatsappService.getTemplates()\r\n      if (result.success) {\r\n        setTemplates(result.templates)\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading templates:', error)\r\n    } finally {\r\n      setLoadingTemplates(false)\r\n    }\r\n  }\r\n\r\n  const handleInputChange = (field, value) => {\r\n    setConfig(prev => ({\r\n      ...prev,\r\n      [field]: value\r\n    }))\r\n  }\r\n\r\n  const handleConnect = async () => {\r\n    // Validar campos obligatorios\r\n    if (!config.accessToken || !config.phoneNumberId) {\r\n      toast.error('Access Token y Phone Number ID son obligatorios')\r\n      return\r\n    }\r\n\r\n    // Validar formato del Access Token\r\n    if (!config.accessToken.startsWith('EA') && !config.accessToken.startsWith('EAA')) {\r\n      toast.error('El Access Token debe comenzar con EA o EAA')\r\n      return\r\n    }\r\n\r\n    // Validar formato del Phone Number ID\r\n    if (!/^\\d+$/.test(config.phoneNumberId)) {\r\n      toast.error('El Phone Number ID debe contener solo n√∫meros')\r\n      return\r\n    }\r\n\r\n    setIsConnecting(true)\r\n    setConnectionStatus('connecting')\r\n\r\n    try {\r\n      // Configurar el servicio\r\n      whatsappService.configure(config)\r\n      \r\n      // Probar conexi√≥n\r\n      const testResult = await whatsappService.testConnection()\r\n      \r\n      if (testResult.success) {\r\n        setIsConfigured(true)\r\n        setConnectionStatus('connected')\r\n        \r\n        // Cargar informaci√≥n de la cuenta\r\n        await loadAccountInfo()\r\n        await loadTemplates()\r\n        \r\n        // Mostrar √©xito\r\n        await Swal.fire({\r\n          title: 'üéâ WhatsApp Configurado Exitosamente',\r\n          html: `\r\n            <div style=\"text-align: left;\">\r\n              <div style=\"background-color: #d4edda; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #155724;\">‚úÖ Conexi√≥n exitosa</h4>\r\n                <p style=\"margin: 0; font-size: 14px;\">La API de WhatsApp est√° funcionando correctamente.</p>\r\n              </div>\r\n              <div style=\"background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #333;\">Informaci√≥n del n√∫mero:</h4>\r\n                <p style=\"margin: 4px 0; font-size: 14px;\">\r\n                  <strong>N√∫mero:</strong> ${testResult.phoneInfo.name}<br>\r\n                  <strong>Nombre verificado:</strong> ${testResult.phoneInfo.verifiedName}<br>\r\n                  <strong>Calidad:</strong> ${testResult.phoneInfo.qualityRating || 'N/A'}\r\n                </p>\r\n              </div>\r\n              <div style=\"background-color: #e8f4fd; padding: 12px; border-radius: 4px; margin-top: 12px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #0066ff;\">üìã Funcionalidades activadas:</h4>\r\n                <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                  <li>‚úÖ Env√≠o de mensajes individuales</li>\r\n                  <li>‚úÖ Env√≠o masivo de mensajes</li>\r\n                  <li>‚úÖ Plantillas de mensaje pre-aprobadas</li>\r\n                  <li>‚úÖ Webhooks para estado de entrega</li>\r\n                  <li>‚úÖ Estad√≠sticas en tiempo real</li>\r\n                  <li>‚úÖ Modo ${config.testMode ? 'prueba üß™' : 'producci√≥n üöÄ'}</li>\r\n                </ul>\r\n              </div>\r\n            </div>\r\n          `,\r\n          icon: 'success',\r\n          confirmButtonText: '¬°Perfecto!',\r\n          confirmButtonColor: '#25d366',\r\n          width: '500px'\r\n        })\r\n\r\n        toast.success('WhatsApp configurado exitosamente')\r\n      } else {\r\n        throw new Error(testResult.error || 'Error al conectar con WhatsApp')\r\n      }\r\n    } catch (error) {\r\n      console.error('Error configuring WhatsApp:', error)\r\n      \r\n      // Restaurar estado\r\n      setIsConfigured(false)\r\n      setConnectionStatus('disconnected')\r\n      \r\n      // Mostrar error\r\n      await Swal.fire({\r\n        title: '‚ùå Error de Conexi√≥n',\r\n        html: `\r\n          <div style=\"text-align: left;\">\r\n            <div style=\"background-color: #f8d7da; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n              <h4 style=\"margin: 0 0 8px 0; color: #721c24;\">No se pudo conectar con WhatsApp</h4>\r\n              <p style=\"margin: 0; font-size: 14px;\"><strong>Error:</strong> ${error.message}</p>\r\n            </div>\r\n            <div style=\"background-color: #fff3cd; padding: 12px; border-radius: 4px;\">\r\n              <h4 style=\"margin: 0 0 8px 0; color: #856404;\">üîç Posibles soluciones:</h4>\r\n              <ul style=\"margin: 0; padding-left: 20px; font-size: 14px;\">\r\n                <li>‚Ä¢ Verifica que el Access Token sea correcto</li>\r\n                <li>‚Ä¢ Aseg√∫rate de que el Phone Number ID sea v√°lido</li>\r\n                <li>‚Ä¢ Revisa que tu n√∫mero de WhatsApp est√© verificado</li>\r\n                <li>‚Ä¢ Verifica los permisos del token</li>\r\n                <li>‚Ä¢ Revisa tu conexi√≥n a internet</li>\r\n              </ul>\r\n            </div>\r\n          </div>\r\n        `,\r\n        icon: 'error',\r\n        confirmButtonText: 'Reintentar',\r\n        confirmButtonColor: '#dc3545',\r\n        width: '500px'\r\n      })\r\n\r\n      toast.error('Error al configurar WhatsApp')\r\n    } finally {\r\n      setIsConnecting(false)\r\n    }\r\n  }\r\n\r\n  const handleDisconnect = async () => {\r\n    const result = await Swal.fire({\r\n      title: 'Desconectar WhatsApp',\r\n      text: '¬øEst√°s seguro de desconectar WhatsApp? Perder√°s toda la configuraci√≥n.',\r\n      icon: 'warning',\r\n      showCancelButton: true,\r\n      confirmButtonColor: '#d33',\r\n      cancelButtonColor: '#3085d6',\r\n      confirmButtonText: 'S√≠, desconectar',\r\n      cancelButtonText: 'Cancelar'\r\n    })\r\n\r\n    if (result.isConfirmed) {\r\n      whatsappService.clearConfiguration()\r\n      setConfig({\r\n        accessToken: '',\r\n        phoneNumberId: '',\r\n        webhookVerifyToken: '',\r\n        testMode: true\r\n      })\r\n      setIsConfigured(false)\r\n      setConnectionStatus('disconnected')\r\n      setAccountInfo(null)\r\n      setTemplates([])\r\n      \r\n      toast.success('WhatsApp desconectado')\r\n    }\r\n  }\r\n\r\n  const handleTestMessage = async () => {\r\n    if (!testPhone) {\r\n      toast.error('Por favor ingresa un n√∫mero de tel√©fono para probar')\r\n      return\r\n    }\r\n\r\n    if (!whatsappService.validatePhoneNumber(testPhone)) {\r\n      toast.error('El n√∫mero de tel√©fono no es v√°lido')\r\n      return\r\n    }\r\n\r\n    setIsTesting(true)\r\n\r\n    try {\r\n      const result = await whatsappService.sendTestMessage(testPhone, testMessage)\r\n      \r\n      if (result.success) {\r\n        await Swal.fire({\r\n          title: '‚úÖ Mensaje Enviado',\r\n          html: `\r\n            <div style=\"text-align: left;\">\r\n              <div style=\"background-color: #d4edda; padding: 12px; border-radius: 4px; margin-bottom: 12px;\">\r\n                <h4 style=\"margin: 0 0 8px 0; color: #155724;\">Mensaje de prueba enviado</h4>\r\n                <p style=\"margin: 0; font-size: 14px;\">\r\n                  <strong>ID del mensaje:</strong> ${result.messageId}<br>\r\n                  <strong>Destinatario:</strong> ${testPhone}<br>\r\n                  <strong>Modo:</strong> ${result.testMode ? 'Prueba üß™' : 'Producci√≥n üöÄ'}\r\n                </p>\r\n              </div>\r\n              <div style=\"background-color: #f8f9fa; padding: 12px; border-radius: 4px;\">\r\n                <p style=\"margin: 0; font-size: 14px;\">\r\n                  El mensaje deber√≠a llegar en pocos segundos. Si no lo recibes, verifica el n√∫mero y la configuraci√≥n.\r\n                </p>\r\n              </div>\r\n            </div>\r\n          `,\r\n          icon: 'success',\r\n          confirmButtonText: 'Entendido',\r\n          confirmButtonColor: '#25d366',\r\n          width: '450px'\r\n        })\r\n\r\n        toast.success('Mensaje de prueba enviado')\r\n      } else {\r\n        throw new Error(result.error || 'Error al enviar mensaje de prueba')\r\n      }\r\n    } catch (error) {\r\n      console.error('Error sending test message:', error)\r\n      \r\n      await Swal.fire({\r\n        title: '‚ùå Error al Enviar',\r\n        html: `\r\n          <div style=\"text-align: left;\">\r\n            <div style=\"background-color: #f8d7da; padding: 12px; border-radius: 4px;\">\r\n              <h4 style=\"margin: 0 0 8px 0; color: #721c24;\">No se pudo enviar el mensaje</h4>\r\n              <p style=\"margin: 0; font-size: 14px;\"><strong>Error:</strong> ${error.message}</p>\r\n            </div>\r\n          </div>\r\n        `,\r\n        icon: 'error',\r\n        confirmButtonText: 'Reintentar',\r\n        confirmButtonColor: '#dc3545'\r\n      })\r\n\r\n      toast.error('Error al enviar mensaje de prueba')\r\n    } finally {\r\n      setIsTesting(false)\r\n    }\r\n  }\r\n\r\n  const getStatusBadge = () => {\r\n    switch (connectionStatus) {\r\n      case 'connecting':\r\n        return <span className=\"px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full\">Conectando...</span>\r\n      case 'connected':\r\n        return <span className=\"px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full\">Conectado</span>\r\n      default:\r\n        return <span className=\"px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full\">Desconectado</span>\r\n    }\r\n  }\r\n\r\n  const refreshTemplates = async () => {\r\n    await loadTemplates()\r\n    toast.success('Plantillas actualizadas')\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n        <div className=\"flex items-center justify-between mb-6\">\r\n          <div className=\"flex items-center\">\r\n            <div className=\"p-3 rounded-xl bg-gradient-to-br from-green-500 to-green-600 shadow-lg mr-4\">\r\n              <ChatBubbleLeftRightIcon className=\"h-6 w-6 text-white\" />\r\n            </div>\r\n            <div>\r\n              <h3 className=\"text-lg font-bold text-gray-900\">WhatsApp Business API</h3>\r\n              <p className=\"text-sm text-gray-600\">Configuraci√≥n de WhatsApp con API oficial de Meta</p>\r\n            </div>\r\n          </div>\r\n          {getStatusBadge()}\r\n        </div>\r\n\r\n        {/* Informaci√≥n de conexi√≥n */}\r\n        {isConfigured && accountInfo && (\r\n          <div className=\"mb-6 p-4 bg-green-50 border border-green-200 rounded-lg\">\r\n            <div className=\"flex items-center mb-2\">\r\n              <CheckCircleIcon className=\"h-5 w-5 text-green-500 mr-2\" />\r\n              <span className=\"text-sm font-medium text-green-800\">WhatsApp conectado</span>\r\n            </div>\r\n            <div className=\"text-sm text-green-600\">\r\n              <p><strong>Cuenta:</strong> {accountInfo.name}</p>\r\n              <p><strong>ID:</strong> {accountInfo.id}</p>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Formulario de configuraci√≥n */}\r\n        {!isConfigured ? (\r\n          <div className=\"space-y-4\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                Access Token de Meta *\r\n              </label>\r\n              <input\r\n                type=\"password\"\r\n                value={config.accessToken}\r\n                onChange={(e) => handleInputChange('accessToken', e.target.value)}\r\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500\"\r\n                placeholder=\"EA...\"\r\n              />\r\n              <p className=\"text-xs text-gray-500 mt-1\">\r\n                Obt√©n tu token en{' '}\r\n                <a \r\n                  href=\"https://developers.facebook.com/docs/whatsapp/business-management-api/get-started\" \r\n                  target=\"_blank\" \r\n                  rel=\"noopener noreferrer\"\r\n                  className=\"text-blue-600 hover:underline\"\r\n                >\r\n                  Meta for Developers\r\n                </a>\r\n              </p>\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                Phone Number ID *\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                value={config.phoneNumberId}\r\n                onChange={(e) => handleInputChange('phoneNumberId', e.target.value)}\r\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500\"\r\n                placeholder=\"123456789...\"\r\n              />\r\n              <p className=\"text-xs text-gray-500 mt-1\">\r\n                ID num√©rico de tu n√∫mero de WhatsApp Business\r\n              </p>\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                Webhook Verify Token\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                value={config.webhookVerifyToken}\r\n                onChange={(e) => handleInputChange('webhookVerifyToken', e.target.value)}\r\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500\"\r\n                placeholder=\"Token opcional para verificaci√≥n de webhooks\"\r\n              />\r\n              <p className=\"text-xs text-gray-500 mt-1\">\r\n                Opcional: Token para verificar webhooks entrantes\r\n              </p>\r\n            </div>\r\n\r\n            <div className=\"flex items-center\">\r\n              <input\r\n                type=\"checkbox\"\r\n                id=\"test-mode\"\r\n                checked={config.testMode}\r\n                onChange={(e) => handleInputChange('testMode', e.target.checked)}\r\n                className=\"h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded\"\r\n              />\r\n              <label htmlFor=\"test-mode\" className=\"ml-2 block text-sm text-gray-900\">\r\n                Modo de prueba\r\n              </label>\r\n            </div>\r\n\r\n            <button\r\n              onClick={handleConnect}\r\n              disabled={isConnecting}\r\n              className=\"w-full px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              {isConnecting ? (\r\n                <>\r\n                  <ArrowPathIcon className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                  Conectando...\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <ChatBubbleLeftRightIcon className=\"h-4 w-4 mr-2\" />\r\n                  Conectar WhatsApp\r\n                </>\r\n              )}\r\n            </button>\r\n          </div>\r\n        ) : (\r\n          <div className=\"space-y-4\">\r\n            {/* Botones de acci√≥n */}\r\n            <div className=\"grid grid-cols-2 gap-3\">\r\n              <button\r\n                onClick={() => setShowAdvanced(!showAdvanced)}\r\n                className=\"px-4 py-2 bg-gray-100 text-gray-700 hover:bg-gray-200 font-semibold rounded-xl transition-all duration-300 flex items-center justify-center\"\r\n              >\r\n                <Cog6ToothIcon className=\"h-4 w-4 mr-2\" />\r\n                Configuraci√≥n\r\n              </button>\r\n              <button\r\n                onClick={handleDisconnect}\r\n                className=\"px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition-all duration-300 flex items-center justify-center\"\r\n              >\r\n                <XCircleIcon className=\"h-4 w-4 mr-2\" />\r\n                Desconectar\r\n              </button>\r\n            </div>\r\n\r\n            {/* Configuraci√≥n avanzada */}\r\n            {showAdvanced && (\r\n              <div className=\"p-4 bg-gray-50 rounded-lg space-y-3\">\r\n                <h4 className=\"font-medium text-gray-900\">Configuraci√≥n Actual</h4>\r\n                <div className=\"text-sm text-gray-600 space-y-1\">\r\n                  <p><strong>Phone Number ID:</strong> {config.phoneNumberId}</p>\r\n                  <p><strong>Modo:</strong> {config.testMode ? 'Prueba üß™' : 'Producci√≥n üöÄ'}</p>\r\n                  <p><strong>Webhook Token:</strong> {config.webhookVerifyToken || 'No configurado'}</p>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Prueba de mensaje */}\r\n            <div className=\"p-4 bg-blue-50 rounded-lg\">\r\n              <h4 className=\"font-medium text-gray-900 mb-3\">Enviar Mensaje de Prueba</h4>\r\n              <div className=\"space-y-3\">\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                    N√∫mero de tel√©fono\r\n                  </label>\r\n                  <input\r\n                    type=\"tel\"\r\n                    value={testPhone}\r\n                    onChange={(e) => setTestPhone(e.target.value)}\r\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                    placeholder=\"+56 9 1234 5678\"\r\n                  />\r\n                </div>\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                    Mensaje\r\n                  </label>\r\n                  <textarea\r\n                    value={testMessage}\r\n                    onChange={(e) => setTestMessage(e.target.value)}\r\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-vertical\"\r\n                    rows=\"2\"\r\n                    placeholder=\"Escribe tu mensaje de prueba...\"\r\n                  />\r\n                </div>\r\n                <button\r\n                  onClick={handleTestMessage}\r\n                  disabled={isTesting}\r\n                  className=\"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {isTesting ? (\r\n                    <>\r\n                      <ArrowPathIcon className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                      Enviando...\r\n                    </>\r\n                  ) : (\r\n                    <>\r\n                      <ChatBubbleLeftRightIcon className=\"h-4 w-4 mr-2\" />\r\n                      Enviar Mensaje de Prueba\r\n                    </>\r\n                  )}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Plantillas de mensaje */}\r\n      {isConfigured && (\r\n        <div className=\"bg-white rounded-3xl p-6 shadow-xl border border-gray-100\">\r\n          <div className=\"flex items-center justify-between mb-4\">\r\n            <div className=\"flex items-center\">\r\n              <div className=\"p-3 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 shadow-lg mr-4\">\r\n                <ChartBarIcon className=\"h-6 w-6 text-white\" />\r\n              </div>\r\n              <div>\r\n                <h3 className=\"text-lg font-bold text-gray-900\">Plantillas de Mensaje</h3>\r\n                <p className=\"text-sm text-gray-600\">Plantillas pre-aprobadas para comunicaci√≥n</p>\r\n              </div>\r\n            </div>\r\n            <button\r\n              onClick={refreshTemplates}\r\n              disabled={loadingTemplates}\r\n              className=\"px-3 py-1 bg-purple-100 text-purple-700 text-sm font-medium rounded-full hover:bg-purple-200 transition-colors\"\r\n            >\r\n              {loadingTemplates ? 'Actualizando...' : 'Actualizar'}\r\n            </button>\r\n          </div>\r\n\r\n          {loadingTemplates ? (\r\n            <div className=\"flex justify-center py-8\">\r\n              <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500\"></div>\r\n            </div>\r\n          ) : templates.length > 0 ? (\r\n            <div className=\"space-y-2\">\r\n              {templates.map((template, index) => (\r\n                <div key={index} className=\"p-3 bg-gray-50 rounded-lg\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <div>\r\n                      <h4 className=\"font-medium text-gray-900\">{template.name}</h4>\r\n                      <p className=\"text-sm text-gray-600\">\r\n                        Categor√≠a: {template.category} | Estado: {template.status}\r\n                      </p>\r\n                    </div>\r\n                    <span className={`px-2 py-1 text-xs font-medium rounded-full ${\r\n                      template.status === 'APPROVED' \r\n                        ? 'bg-green-100 text-green-800'\r\n                        : template.status === 'PENDING'\r\n                        ? 'bg-yellow-100 text-yellow-800'\r\n                        : 'bg-red-100 text-red-800'\r\n                    }`}>\r\n                      {template.status}\r\n                    </span>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          ) : (\r\n            <div className=\"text-center py-8\">\r\n              <InformationCircleIcon className=\"mx-auto h-12 w-12 text-gray-400\" />\r\n              <h3 className=\"mt-2 text-sm font-medium text-gray-900\">No hay plantillas</h3>\r\n              <p className=\"mt-1 text-sm text-gray-500\">\r\n                Crea plantillas en Meta Business Suite para enviar mensajes a usuarios que no han iniciado conversaci√≥n.\r\n              </p>\r\n              <a\r\n                href=\"https://business.facebook.com/wa/manage/message-templates/\"\r\n                target=\"_blank\"\r\n                rel=\"noopener noreferrer\"\r\n                className=\"mt-4 inline-flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl transition-all duration-300\"\r\n              >\r\n                Gestionar Plantillas\r\n              </a>\r\n            </div>\r\n          )}\r\n        </div>\r\n      )}\r\n\r\n      {/* Informaci√≥n adicional */}\r\n      <div className=\"bg-gradient-to-r from-green-50 to-blue-50 rounded-3xl p-6 border border-green-100\">\r\n        <div className=\"flex items-start\">\r\n          <div className=\"p-2 rounded-lg bg-green-100 mr-4\">\r\n            <InformationCircleIcon className=\"h-5 w-5 text-green-600\" />\r\n          </div>\r\n          <div>\r\n            <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">Informaci√≥n Importante</h3>\r\n            <div className=\"space-y-2 text-sm text-gray-600\">\r\n              <p>\r\n                <strong>Costos:</strong> WhatsApp Business API tiene un costo aproximado de $0.0525 USD por mensaje.\r\n              </p>\r\n              <p>\r\n                <strong>Plantillas:</strong> Se requieren plantillas pre-aprobadas para enviar mensajes a usuarios que no han iniciado conversaci√≥n.\r\n              </p>\r\n              <p>\r\n                <strong>L√≠mites:</strong> No hay l√≠mites diarios de mensajes, pero se recomienda no superar 1000 mensajes por hora.\r\n              </p>\r\n              <p>\r\n                <strong>Soporte:</strong> Para ayuda con la configuraci√≥n, consulta la{' '}\r\n                <a \r\n                  href=\"https://developers.facebook.com/docs/whatsapp\" \r\n                  target=\"_blank\" \r\n                  rel=\"noopener noreferrer\"\r\n                  className=\"text-blue-600 hover:underline\"\r\n                >\r\n                  documentaci√≥n oficial\r\n                </a>.\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default WhatsAppConfig","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\templates\\TemplateDownload.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\test\\CompanySyncTest.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'testSubscription'. Either include it or remove the dependency array.","line":87,"column":6,"nodeType":"ArrayExpression","endLine":87,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [testSubscription]","fix":{"range":[2596,2598],"text":"[testSubscription]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'testGetCompanies' and 'testGetStats'. Either include them or remove the dependency array.","line":94,"column":6,"nodeType":"ArrayExpression","endLine":94,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [testGetCompanies, testGetStats]","fix":{"range":[2832,2834],"text":"[testGetCompanies, testGetStats]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport companySyncService from '../../services/companySyncService.js';\r\n\r\nconst CompanySyncTest = () => {\r\n  const [companies, setCompanies] = useState([]);\r\n  const [stats, setStats] = useState(null);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState(null);\r\n  const [logs, setLogs] = useState([]);\r\n\r\n  const addLog = (message) => {\r\n    setLogs(prev => [...prev, `${new Date().toLocaleTimeString()}: ${message}`]);\r\n  };\r\n\r\n  const testRefreshCompanies = async () => {\r\n    setLoading(true);\r\n    setError(null);\r\n    addLog('Iniciando refreshCompanies...');\r\n    \r\n    try {\r\n      const result = await companySyncService.refreshCompanies();\r\n      setCompanies(result);\r\n      addLog(`‚úÖ Empresas obtenidas: ${result.length}`);\r\n    } catch (err) {\r\n      setError(err.message);\r\n      addLog(`‚ùå Error: ${err.message}`);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const testGetCompanies = async () => {\r\n    setLoading(true);\r\n    setError(null);\r\n    addLog('Iniciando getCompanies...');\r\n    \r\n    try {\r\n      const result = await companySyncService.getCompanies();\r\n      setCompanies(result);\r\n      addLog(`‚úÖ Empresas obtenidas (con cach√©): ${result.length}`);\r\n    } catch (err) {\r\n      setError(err.message);\r\n      addLog(`‚ùå Error: ${err.message}`);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const testGetStats = async () => {\r\n    setLoading(true);\r\n    setError(null);\r\n    addLog('Iniciando getCompanyStats...');\r\n    \r\n    try {\r\n      const result = await companySyncService.getCompanyStats();\r\n      setStats(result);\r\n      addLog(`‚úÖ Estad√≠sticas obtenidas: ${JSON.stringify(result)}`);\r\n    } catch (err) {\r\n      setError(err.message);\r\n      addLog(`‚ùå Error: ${err.message}`);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const testSubscription = () => {\r\n    addLog('Configurando suscripci√≥n a eventos...');\r\n    \r\n    const unsubscribe = companySyncService.subscribe('companies:refreshed', (data) => {\r\n      addLog(`üîî Evento recibido: companies:refreshed (${data.length} empresas)`);\r\n      setCompanies(data);\r\n    });\r\n\r\n    addLog('‚úÖ Suscripci√≥n configurada');\r\n    \r\n    return () => {\r\n      unsubscribe();\r\n      addLog('üîå Suscripci√≥n cancelada');\r\n    };\r\n  };\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\nuseEffect(() => {\r\n    const unsubscribe = testSubscription();\r\n    return unsubscribe;\r\n  }, []);\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\nuseEffect(() => {\r\n    testGetCompanies();\r\n    testGetStats();\r\n  }, []);\r\n\r\n  return (\r\n    <div className=\"max-w-4xl mx-auto p-6\">\r\n      <h1 className=\"text-2xl font-bold mb-6\">Prueba de Sincronizaci√≥n de Empresas</h1>\r\n      \r\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6\">\r\n        <button\r\n          onClick={testRefreshCompanies}\r\n          disabled={loading}\r\n          className=\"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 disabled:opacity-50\"\r\n        >\r\n          {loading ? 'Cargando...' : 'Refresh Companies'}\r\n        </button>\r\n        \r\n        <button\r\n          onClick={testGetCompanies}\r\n          disabled={loading}\r\n          className=\"bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 disabled:opacity-50\"\r\n        >\r\n          {loading ? 'Cargando...' : 'Get Companies'}\r\n        </button>\r\n        \r\n        <button\r\n          onClick={testGetStats}\r\n          disabled={loading}\r\n          className=\"bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 disabled:opacity-50\"\r\n        >\r\n          {loading ? 'Cargando...' : 'Get Stats'}\r\n        </button>\r\n      </div>\r\n\r\n      {error && (\r\n        <div className=\"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4\">\r\n          <strong>Error:</strong> {error}\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n        <div>\r\n          <h2 className=\"text-xl font-semibold mb-3\">Empresas ({companies.length})</h2>\r\n          <div className=\"bg-gray-100 rounded p-4 max-h-64 overflow-y-auto\">\r\n            {companies.map((company, index) => (\r\n              <div key={index} className=\"mb-2 p-2 bg-white rounded\">\r\n                <strong>{company.name}</strong> - {company.employeeCount} empleados\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n\r\n        <div>\r\n          <h2 className=\"text-xl font-semibold mb-3\">Estad√≠sticas</h2>\r\n          {stats && (\r\n            <div className=\"bg-gray-100 rounded p-4\">\r\n              <p><strong>Total:</strong> {stats.total}</p>\r\n              <p><strong>Activas:</strong> {stats.active}</p>\r\n              <p><strong>Inactivas:</strong> {stats.inactive}</p>\r\n              <p><strong>Total Empleados:</strong> {stats.totalEmployees}</p>\r\n              <p><strong>√öltima Actualizaci√≥n:</strong> {stats.lastUpdate ? new Date(stats.lastUpdate).toLocaleString() : 'N/A'}</p>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"mt-6\">\r\n        <h2 className=\"text-xl font-semibold mb-3\">Logs</h2>\r\n        <div className=\"bg-gray-900 text-green-400 rounded p-4 max-h-64 overflow-y-auto font-mono text-sm\">\r\n          {logs.map((log, index) => (\r\n            <div key={index}>{log}</div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default CompanySyncTest;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\test\\GoogleDriveConnectionVerifier.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'runCompleteVerification'. Either include it or remove the dependency array.","line":25,"column":6,"nodeType":"ArrayExpression","endLine":25,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [runCompleteVerification, user]","fix":{"range":[1035,1041],"text":"[runCompleteVerification, user]"}}]},{"ruleId":"default-case","severity":1,"message":"Expected a default case.","line":36,"column":9,"nodeType":"SwitchStatement","messageId":"missingDefaultCase","endLine":52,"endColumn":10},{"ruleId":"no-unused-vars","severity":1,"message":"'getStatusColor' is assigned a value but never used.","line":280,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":280,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport { useAuth } from '../../contexts/AuthContext.js'\r\nimport userGoogleDriveService from '../../services/userGoogleDriveService.js'\r\nimport userSpecificGoogleDriveService from '../../services/userSpecificGoogleDriveService.js'\r\nimport './GoogleDriveConnectionVerifier.css'\r\n\r\nconst GoogleDriveConnectionVerifier = () => {\r\n  const { user } = useAuth()\r\n  const [verificationResults, setVerificationResults] = useState({})\r\n  const [loading, setLoading] = useState(false)\r\n  const [currentStep, setCurrentStep] = useState(0)\r\n\r\n  const verificationSteps = [\r\n    { id: 'env', name: 'Variables de Entorno', icon: 'üîß' },\r\n    { id: 'service', name: 'Servicio de Autenticaci√≥n', icon: 'üîê' },\r\n    { id: 'connection', name: 'Conexi√≥n con Google Drive', icon: 'üîó' },\r\n    { id: 'operations', name: 'Operaciones de API', icon: '‚ö°' },\r\n    { id: 'database', name: 'Base de Datos', icon: 'üíæ' }\r\n  ]\r\n\r\n  useEffect(() => {\r\n    if (user) {\r\n      runCompleteVerification()\r\n    }\r\n  }, [user])\r\n\r\n  const runCompleteVerification = async () => {\r\n    setLoading(true)\r\n    const results = {}\r\n\r\n    for (let i = 0; i < verificationSteps.length; i++) {\r\n      setCurrentStep(i)\r\n      const step = verificationSteps[i]\r\n      \r\n      try {\r\n        switch (step.id) {\r\n          case 'env':\r\n            results.env = await verifyEnvironment()\r\n            break\r\n          case 'service':\r\n            results.service = await verifyService()\r\n            break\r\n          case 'connection':\r\n            results.connection = await verifyConnection()\r\n            break\r\n          case 'operations':\r\n            results.operations = await verifyOperations()\r\n            break\r\n          case 'database':\r\n            results.database = await verifyDatabase()\r\n            break\r\n        }\r\n      } catch (error) {\r\n        results[step.id] = {\r\n          success: false,\r\n          error: error.message,\r\n          details: null\r\n        }\r\n      }\r\n\r\n      // Peque√±a pausa para mejor UX\r\n      await new Promise(resolve => setTimeout(resolve, 500))\r\n    }\r\n\r\n    setVerificationResults(results)\r\n    setLoading(false)\r\n    setCurrentStep(verificationSteps.length)\r\n  }\r\n\r\n  const verifyEnvironment = async () => {\r\n    const envVars = {\r\n      clientId: process.env.REACT_APP_GOOGLE_CLIENT_ID,\r\n      clientSecret: process.env.REACT_APP_GOOGLE_CLIENT_SECRET,\r\n      apiKey: process.env.REACT_APP_GOOGLE_API_KEY,\r\n      environment: process.env.REACT_APP_ENVIRONMENT,\r\n      netlifyUrl: process.env.REACT_APP_NETLIFY_URL\r\n    }\r\n\r\n    const checks = {\r\n      clientId: !!envVars.clientId,\r\n      clientSecret: !!envVars.clientSecret,\r\n      apiKey: !!envVars.apiKey,\r\n      environment: !!envVars.environment,\r\n      netlifyUrl: !!envVars.netlifyUrl,\r\n      correctRedirectUri: envVars.environment === 'production' \r\n        ? envVars.netlifyUrl === 'https://brifyrrhhv2.netlify.app'\r\n        : true\r\n    }\r\n\r\n    const allPassed = Object.values(checks).every(Boolean)\r\n\r\n    return {\r\n      success: allPassed,\r\n      details: {\r\n        vars: {\r\n          clientId: envVars.clientId ? `${envVars.clientId.substring(0, 20)}...` : '‚ùå No configurado',\r\n          clientSecret: envVars.clientSecret ? '‚úÖ Configurado' : '‚ùå No configurado',\r\n          apiKey: envVars.apiKey ? '‚úÖ Configurado' : '‚ùå No configurado',\r\n          environment: envVars.environment || '‚ùå No configurado',\r\n          netlifyUrl: envVars.netlifyUrl || '‚ùå No configurado'\r\n        },\r\n        checks,\r\n        redirectUri: envVars.environment === 'production' \r\n          ? 'https://brifyrrhhv2.netlify.app/auth/google/callback'\r\n          : 'http://localhost:3000/auth/google/callback'\r\n      }\r\n    }\r\n  }\r\n\r\n  const verifyService = async () => {\r\n    try {\r\n      // Verificar que el servicio est√© inicializado correctamente\r\n      const serviceInitialized = !!userGoogleDriveService.clientId\r\n      \r\n      // Verificar generaci√≥n de URL de autenticaci√≥n\r\n      let authUrl = null\r\n      if (serviceInitialized && user) {\r\n        authUrl = userGoogleDriveService.generateAuthUrl(user.id, 'test_state')\r\n      }\r\n\r\n      return {\r\n        success: serviceInitialized && !!authUrl,\r\n        details: {\r\n          serviceInitialized,\r\n          authUrlGenerated: !!authUrl,\r\n          authUrl: authUrl ? authUrl.substring(0, 100) + '...' : null,\r\n          scopes: userGoogleDriveService.scopes,\r\n          redirectUri: userGoogleDriveService.redirectUri\r\n        }\r\n      }\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        error: error.message,\r\n        details: null\r\n      }\r\n    }\r\n  }\r\n\r\n  const verifyConnection = async () => {\r\n    try {\r\n      if (!user) {\r\n        throw new Error('Usuario no autenticado')\r\n      }\r\n\r\n      // Verificar estado de conexi√≥n\r\n      const isConnected = await userGoogleDriveService.isUserConnected(user.id)\r\n      const connectionInfo = await userGoogleDriveService.getConnectionInfo(user.id)\r\n\r\n      return {\r\n        success: true,\r\n        details: {\r\n          isConnected,\r\n          connectionInfo,\r\n          hasCredentials: !!connectionInfo.googleEmail,\r\n          syncStatus: connectionInfo.syncStatus\r\n        }\r\n      }\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        error: error.message,\r\n        details: null\r\n      }\r\n    }\r\n  }\r\n\r\n  const verifyOperations = async () => {\r\n    try {\r\n      if (!user) {\r\n        throw new Error('Usuario no autenticado')\r\n      }\r\n\r\n      const operations = []\r\n\r\n      // Solo probar operaciones si el usuario est√° conectado\r\n      const isConnected = await userGoogleDriveService.isUserConnected(user.id)\r\n      \r\n      if (isConnected) {\r\n        try {\r\n          // Probar obtenci√≥n de token v√°lido\r\n          const token = await userGoogleDriveService.getValidAccessToken(user.id)\r\n          operations.push({\r\n            name: 'Obtener Token V√°lido',\r\n            success: !!token,\r\n            details: token ? '‚úÖ Token obtenido' : '‚ùå No se pudo obtener token'\r\n          })\r\n\r\n          // Probar servicio espec√≠fico de Google Drive\r\n          const driveService = await userSpecificGoogleDriveService.getUserDriveService(user.id)\r\n          operations.push({\r\n            name: 'Servicio Google Drive',\r\n            success: !!driveService,\r\n            details: driveService ? '‚úÖ Servicio inicializado' : '‚ùå Error al inicializar'\r\n          })\r\n\r\n          // Probar listar archivos (operaci√≥n segura)\r\n          try {\r\n            const filesResult = await userSpecificGoogleDriveService.listFiles(user.id, null, 5)\r\n            operations.push({\r\n              name: 'Listar Archivos',\r\n              success: filesResult.success,\r\n              details: filesResult.success \r\n                ? `‚úÖ Se encontraron ${filesResult.files.length} archivos` \r\n                : `‚ùå Error: ${filesResult.error}`\r\n            })\r\n          } catch (fileError) {\r\n            operations.push({\r\n              name: 'Listar Archivos',\r\n              success: false,\r\n              details: `‚ùå Error: ${fileError.message}`\r\n            })\r\n          }\r\n\r\n        } catch (opError) {\r\n          operations.push({\r\n            name: 'Operaciones API',\r\n            success: false,\r\n            details: `‚ùå Error general: ${opError.message}`\r\n          })\r\n        }\r\n      } else {\r\n        operations.push({\r\n          name: 'Estado de Conexi√≥n',\r\n          success: false,\r\n          details: '‚ö†Ô∏è Usuario no conectado - Omitiendo pruebas de API'\r\n        })\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        details: {\r\n          operations,\r\n          totalTests: operations.length,\r\n          passedTests: operations.filter(op => op.success).length\r\n        }\r\n      }\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        error: error.message,\r\n        details: null\r\n      }\r\n    }\r\n  }\r\n\r\n  const verifyDatabase = async () => {\r\n    try {\r\n      if (!user) {\r\n        throw new Error('Usuario no autenticado')\r\n      }\r\n\r\n      // Verificar que podemos obtener informaci√≥n de la base de datos\r\n      const connectionInfo = await userGoogleDriveService.getConnectionInfo(user.id)\r\n      \r\n      return {\r\n        success: true,\r\n        details: {\r\n          canAccessDatabase: true,\r\n          hasCredentials: !!connectionInfo.googleEmail,\r\n          syncStatus: connectionInfo.syncStatus,\r\n          lastSyncAt: connectionInfo.lastSyncAt,\r\n          tableName: 'user_google_drive_credentials',\r\n          recordExists: connectionInfo.isConnected\r\n        }\r\n      }\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        error: error.message,\r\n        details: null\r\n      }\r\n    }\r\n  }\r\n\r\n  const getStatusIcon = (success) => {\r\n    return success ? '‚úÖ' : '‚ùå'\r\n  }\r\n\r\n  const getStatusColor = (success) => {\r\n    return success ? '#10b981' : '#ef4444'\r\n  }\r\n\r\n  const runTestConnection = async () => {\r\n    if (!user) return\r\n    \r\n    try {\r\n      setLoading(true)\r\n      const token = await userGoogleDriveService.getValidAccessToken(user.id)\r\n      if (token) {\r\n        alert('‚úÖ Conexi√≥n verificada exitosamente')\r\n      }\r\n    } catch (error) {\r\n      alert(`‚ùå Error de conexi√≥n: ${error.message}`)\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  if (loading && currentStep < verificationSteps.length) {\r\n    return (\r\n      <div className=\"connection-verifier\">\r\n        <div className=\"loading-state\">\r\n          <div className=\"step-indicator\">\r\n            <div className=\"step-number\">{currentStep + 1}</div>\r\n            <div className=\"step-info\">\r\n              <h3>{verificationSteps[currentStep].icon} {verificationSteps[currentStep].name}</h3>\r\n              <p>Verificando...</p>\r\n            </div>\r\n          </div>\r\n          <div className=\"progress-bar\">\r\n            <div \r\n              className=\"progress-fill\" \r\n              style={{ width: `${((currentStep + 1) / verificationSteps.length) * 100}%` }}\r\n            ></div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"connection-verifier\">\r\n      <div className=\"verifier-header\">\r\n        <h1>üîç Verificaci√≥n Completa del Sistema</h1>\r\n        <p>An√°lisis exhaustivo de todos los componentes del sistema de Google Drive</p>\r\n      </div>\r\n\r\n      {/* Resumen General */}\r\n      <div className=\"summary-card\">\r\n        <h2>üìä Resumen de Verificaci√≥n</h2>\r\n        <div className=\"summary-grid\">\r\n          {verificationSteps.map((step, index) => {\r\n            const result = verificationResults[step.id]\r\n            return (\r\n              <div key={step.id} className=\"summary-item\">\r\n                <div className=\"summary-icon\">\r\n                  {step.icon} {getStatusIcon(result?.success)}\r\n                </div>\r\n                <div className=\"summary-text\">\r\n                  <h4>{step.name}</h4>\r\n                  <p>{result?.success ? '‚úÖ Pas√≥' : result?.error ? '‚ùå Error' : '‚è≥ Pendiente'}</p>\r\n                </div>\r\n              </div>\r\n            )\r\n          })}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Detalles de Verificaci√≥n */}\r\n      <div className=\"details-section\">\r\n        <h2>üîã Detalles de Verificaci√≥n</h2>\r\n        \r\n        {/* Variables de Entorno */}\r\n        <div className=\"detail-card\">\r\n          <h3>üîß Variables de Entorno</h3>\r\n          {verificationResults.env ? (\r\n            <div className=\"detail-content\">\r\n              <div className=\"env-vars\">\r\n                <div className=\"env-var\">\r\n                  <span>Client ID:</span>\r\n                  <code>{verificationResults.env.details.vars.clientId}</code>\r\n                </div>\r\n                <div className=\"env-var\">\r\n                  <span>Client Secret:</span>\r\n                  <span>{verificationResults.env.details.vars.clientSecret}</span>\r\n                </div>\r\n                <div className=\"env-var\">\r\n                  <span>API Key:</span>\r\n                  <span>{verificationResults.env.details.vars.apiKey}</span>\r\n                </div>\r\n                <div className=\"env-var\">\r\n                  <span>Environment:</span>\r\n                  <span>{verificationResults.env.details.vars.environment}</span>\r\n                </div>\r\n                <div className=\"env-var\">\r\n                  <span>Netlify URL:</span>\r\n                  <span>{verificationResults.env.details.vars.netlifyUrl}</span>\r\n                </div>\r\n                <div className=\"env-var\">\r\n                  <span>Redirect URI:</span>\r\n                  <code>{verificationResults.env.details.redirectUri}</code>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          ) : (\r\n            <p>‚è≥ Verificando...</p>\r\n          )}\r\n        </div>\r\n\r\n        {/* Servicio de Autenticaci√≥n */}\r\n        <div className=\"detail-card\">\r\n          <h3>üîê Servicio de Autenticaci√≥n</h3>\r\n          {verificationResults.service ? (\r\n            <div className=\"detail-content\">\r\n              <div className=\"service-info\">\r\n                <div className=\"service-item\">\r\n                  <span>Servicio Inicializado:</span>\r\n                  <span>{verificationResults.service.details.serviceInitialized ? '‚úÖ' : '‚ùå'}</span>\r\n                </div>\r\n                <div className=\"service-item\">\r\n                  <span>URL de Autenticaci√≥n:</span>\r\n                  <span>{verificationResults.service.details.authUrlGenerated ? '‚úÖ' : '‚ùå'}</span>\r\n                </div>\r\n                <div className=\"service-item\">\r\n                  <span>Redirect URI:</span>\r\n                  <code>{verificationResults.service.details.redirectUri}</code>\r\n                </div>\r\n                <div className=\"service-item\">\r\n                  <span>Scopes:</span>\r\n                  <div className=\"scopes\">\r\n                    {verificationResults.service.details.scopes.map((scope, index) => (\r\n                      <code key={index} className=\"scope-tag\">{scope}</code>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          ) : (\r\n            <p>‚è≥ Verificando...</p>\r\n          )}\r\n        </div>\r\n\r\n        {/* Conexi√≥n */}\r\n        <div className=\"detail-card\">\r\n          <h3>üîó Conexi√≥n con Google Drive</h3>\r\n          {verificationResults.connection ? (\r\n            <div className=\"detail-content\">\r\n              <div className=\"connection-info\">\r\n                <div className=\"connection-item\">\r\n                  <span>Estado de Conexi√≥n:</span>\r\n                  <span>{verificationResults.connection.details.isConnected ? '‚úÖ Conectado' : '‚ùå No conectado'}</span>\r\n                </div>\r\n                <div className=\"connection-item\">\r\n                  <span>Email de Google:</span>\r\n                  <span>{verificationResults.connection.details.connectionInfo.googleEmail || 'No disponible'}</span>\r\n                </div>\r\n                <div className=\"connection-item\">\r\n                  <span>Nombre:</span>\r\n                  <span>{verificationResults.connection.details.connectionInfo.googleName || 'No disponible'}</span>\r\n                </div>\r\n                <div className=\"connection-item\">\r\n                  <span>Estado de Sincronizaci√≥n:</span>\r\n                  <span>{verificationResults.connection.details.connectionInfo.syncStatus}</span>\r\n                </div>\r\n                <div className=\"connection-item\">\r\n                  <span>√öltima Sincronizaci√≥n:</span>\r\n                  <span>{verificationResults.connection.details.connectionInfo.lastSyncAt || 'Nunca'}</span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          ) : (\r\n            <p>‚è≥ Verificando...</p>\r\n          )}\r\n        </div>\r\n\r\n        {/* Operaciones */}\r\n        <div className=\"detail-card\">\r\n          <h3>‚ö° Operaciones de API</h3>\r\n          {verificationResults.operations ? (\r\n            <div className=\"detail-content\">\r\n              <div className=\"operations-summary\">\r\n                <p>Total de pruebas: <strong>{verificationResults.operations.details.totalTests}</strong></p>\r\n                <p>Pruebas pasadas: <strong>{verificationResults.operations.details.passedTests}</strong></p>\r\n              </div>\r\n              <div className=\"operations-list\">\r\n                {verificationResults.operations.details.operations.map((op, index) => (\r\n                  <div key={index} className=\"operation-item\">\r\n                    <span className=\"operation-status\">{op.success ? '‚úÖ' : '‚ùå'}</span>\r\n                    <span className=\"operation-name\">{op.name}</span>\r\n                    <span className=\"operation-details\">{op.details}</span>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          ) : (\r\n            <p>‚è≥ Verificando...</p>\r\n          )}\r\n        </div>\r\n\r\n        {/* Base de Datos */}\r\n        <div className=\"detail-card\">\r\n          <h3>üíæ Base de Datos</h3>\r\n          {verificationResults.database ? (\r\n            <div className=\"detail-content\">\r\n              <div className=\"database-info\">\r\n                <div className=\"database-item\">\r\n                  <span>Acceso a Base de Datos:</span>\r\n                  <span>{verificationResults.database.details.canAccessDatabase ? '‚úÖ' : '‚ùå'}</span>\r\n                </div>\r\n                <div className=\"database-item\">\r\n                  <span>Tabla:</span>\r\n                  <code>{verificationResults.database.details.tableName}</code>\r\n                </div>\r\n                <div className=\"database-item\">\r\n                  <span>Registro Existe:</span>\r\n                  <span>{verificationResults.database.details.recordExists ? '‚úÖ' : '‚ùå'}</span>\r\n                </div>\r\n                <div className=\"database-item\">\r\n                  <span>Credenciales Almacenadas:</span>\r\n                  <span>{verificationResults.database.details.hasCredentials ? '‚úÖ' : '‚ùå'}</span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          ) : (\r\n            <p>‚è≥ Verificando...</p>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Acciones */}\r\n      <div className=\"actions-section\">\r\n        <h2>üéØ Acciones R√°pidas</h2>\r\n        <div className=\"action-buttons\">\r\n          <button onClick={runCompleteVerification} className=\"btn btn-primary\" disabled={loading}>\r\n            üîÑ Re-ejecutar Verificaci√≥n\r\n          </button>\r\n          <button onClick={runTestConnection} className=\"btn btn-secondary\" disabled={loading}>\r\n            üîó Probar Conexi√≥n\r\n          </button>\r\n          <button onClick={() => window.open('/integrations/my-google-drive', '_blank')} className=\"btn btn-secondary\">\r\n            üìÅ Ir a Conexi√≥n Google Drive\r\n          </button>\r\n          <button onClick={() => window.open('/google-drive-uri-checker', '_blank')} className=\"btn btn-secondary\">\r\n            üîç Diagn√≥stico URI\r\n          </button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Recomendaciones */}\r\n      <div className=\"recommendations-section\">\r\n        <h2>üí° Recomendaciones</h2>\r\n        <div className=\"recommendations\">\r\n          {Object.entries(verificationResults).map(([key, result]) => {\r\n            if (!result) return null\r\n            \r\n            if (result.success) {\r\n              return (\r\n                <div key={key} className=\"recommendation success\">\r\n                  <span className=\"rec-icon\">‚úÖ</span>\r\n                  <span className=\"rec-text\">\r\n                    {verificationSteps.find(s => s.id === key)?.name}: Todo funciona correctamente\r\n                  </span>\r\n                </div>\r\n              )\r\n            } else {\r\n              return (\r\n                <div key={key} className=\"recommendation error\">\r\n                  <span className=\"rec-icon\">‚ö†Ô∏è</span>\r\n                  <span className=\"rec-text\">\r\n                    {verificationSteps.find(s => s.id === key)?.name}: {result.error || 'Requiere atenci√≥n'}\r\n                  </span>\r\n                </div>\r\n              )\r\n            }\r\n          })}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default GoogleDriveConnectionVerifier","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\test\\GoogleDriveLocalTest.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'initializeService'. Either include it or remove the dependency array.","line":15,"column":6,"nodeType":"ArrayExpression","endLine":15,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [initializeService]","fix":{"range":[627,629],"text":"[initializeService]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { hybridGoogleDrive } from '../../lib/hybridGoogleDrive.js';\r\n\r\nconst GoogleDriveLocalTest = () => {\r\n  const [status, setStatus] = useState('No inicializado');\r\n  const [serviceInfo, setServiceInfo] = useState(null);\r\n  const [files, setFiles] = useState([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState(null);\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\nuseEffect(() => {\r\n    initializeService();\r\n  }, []);\r\n\r\n  const initializeService = async () => {\r\n    try {\r\n      setLoading(true);\r\n      setError(null);\r\n      setStatus('Inicializando...');\r\n      \r\n      const initialized = await hybridGoogleDrive.initialize();\r\n      \r\n      if (initialized) {\r\n        setStatus('‚úÖ Inicializado correctamente');\r\n        const info = hybridGoogleDrive.getServiceInfo();\r\n        const stats = hybridGoogleDrive.getStats();\r\n        \r\n        setServiceInfo({\r\n          ...info,\r\n          ...stats\r\n        });\r\n        \r\n        // Cargar archivos iniciales\r\n        await loadFiles();\r\n      } else {\r\n        setStatus('‚ùå Error al inicializar');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error en prueba:', error);\r\n      setError(error.message);\r\n      setStatus('‚ùå Error en inicializaci√≥n');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const loadFiles = async () => {\r\n    try {\r\n      const fileList = await hybridGoogleDrive.listFiles();\r\n      setFiles(fileList);\r\n    } catch (error) {\r\n      console.error('Error cargando archivos:', error);\r\n      setError(error.message);\r\n    }\r\n  };\r\n\r\n  const createTestFolder = async () => {\r\n    try {\r\n      setLoading(true);\r\n      const folderName = `Carpeta Prueba ${new Date().toLocaleTimeString()}`;\r\n      const folder = await hybridGoogleDrive.createFolder(folderName);\r\n      console.log('Carpeta creada:', folder);\r\n      await loadFiles();\r\n    } catch (error) {\r\n      console.error('Error creando carpeta:', error);\r\n      setError(error.message);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const testFileUpload = async () => {\r\n    try {\r\n      setLoading(true);\r\n      // Crear un archivo de prueba\r\n      const testFile = new File(['Contenido de prueba'], 'archivo_prueba.txt', {\r\n        type: 'text/plain'\r\n      });\r\n      \r\n      const uploadedFile = await hybridGoogleDrive.uploadFile(testFile);\r\n      console.log('Archivo subido:', uploadedFile);\r\n      await loadFiles();\r\n    } catch (error) {\r\n      console.error('Error subiendo archivo:', error);\r\n      setError(error.message);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const clearStorage = () => {\r\n    hybridGoogleDrive.clearLocalStorage();\r\n    setFiles([]);\r\n    initializeService();\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"p-6 max-w-4xl mx-auto\">\r\n        <div className=\"text-center\">\r\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto\"></div>\r\n          <p className=\"mt-4 text-gray-600\">Cargando...</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-6 max-w-4xl mx-auto\">\r\n      <div className=\"bg-white rounded-lg shadow-lg p-6\">\r\n        <h1 className=\"text-2xl font-bold mb-6\">üß™ Prueba de Google Drive Local</h1>\r\n        \r\n        {/* Estado del servicio */}\r\n        <div className=\"mb-6 p-4 bg-gray-50 rounded-lg\">\r\n          <h2 className=\"text-lg font-semibold mb-2\">Estado del Servicio</h2>\r\n          <p className=\"text-sm text-gray-600 mb-2\">{status}</p>\r\n          \r\n          {serviceInfo && (\r\n            <div className=\"grid grid-cols-2 gap-4 mt-4\">\r\n              <div>\r\n                <span className=\"font-medium\">Servicio:</span> {serviceInfo.service}\r\n              </div>\r\n              <div>\r\n                <span className=\"font-medium\">Es Real:</span> {serviceInfo.isReal ? 'S√≠' : 'No'}\r\n              </div>\r\n              <div>\r\n                <span className=\"font-medium\">Archivos:</span> {serviceInfo.files || 0}\r\n              </div>\r\n              <div>\r\n                <span className=\"font-medium\">Carpetas:</span> {serviceInfo.folders || 0}\r\n              </div>\r\n              {serviceInfo.totalSizeFormatted && (\r\n                <div className=\"col-span-2\">\r\n                  <span className=\"font-medium\">Tama√±o Total:</span> {serviceInfo.totalSizeFormatted}\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Error */}\r\n        {error && (\r\n          <div className=\"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg\">\r\n            <h3 className=\"text-red-800 font-semibold mb-1\">Error</h3>\r\n            <p className=\"text-red-600 text-sm\">{error}</p>\r\n          </div>\r\n        )}\r\n\r\n        {/* Botones de prueba */}\r\n        <div className=\"mb-6 flex flex-wrap gap-3\">\r\n          <button\r\n            onClick={createTestFolder}\r\n            disabled={loading}\r\n            className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50\"\r\n          >\r\n            üìÅ Crear Carpeta de Prueba\r\n          </button>\r\n          \r\n          <button\r\n            onClick={testFileUpload}\r\n            disabled={loading}\r\n            className=\"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50\"\r\n          >\r\n            üìÑ Subir Archivo de Prueba\r\n          </button>\r\n          \r\n          <button\r\n            onClick={loadFiles}\r\n            disabled={loading}\r\n            className=\"px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50\"\r\n          >\r\n            üîÑ Recargar Lista\r\n          </button>\r\n          \r\n          <button\r\n            onClick={clearStorage}\r\n            disabled={loading}\r\n            className=\"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50\"\r\n          >\r\n            üóëÔ∏è Limpiar Almacenamiento\r\n          </button>\r\n        </div>\r\n\r\n        {/* Lista de archivos */}\r\n        <div>\r\n          <h2 className=\"text-lg font-semibold mb-4\">Archivos y Carpetas ({files.length})</h2>\r\n          \r\n          {files.length === 0 ? (\r\n            <div className=\"text-center py-8 bg-gray-50 rounded-lg\">\r\n              <p className=\"text-gray-500\">No hay archivos ni carpetas</p>\r\n              <p className=\"text-sm text-gray-400 mt-2\">Crea una carpeta o sube un archivo para comenzar</p>\r\n            </div>\r\n          ) : (\r\n            <div className=\"space-y-2\">\r\n              {files.map((file) => (\r\n                <div\r\n                  key={file.id}\r\n                  className=\"flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100\"\r\n                >\r\n                  <div className=\"flex items-center\">\r\n                    <span className=\"mr-3\">\r\n                      {file.mimeType === 'application/vnd.google-apps.folder' ? 'üìÅ' : 'üìÑ'}\r\n                    </span>\r\n                    <div>\r\n                      <div className=\"font-medium\">{file.name}</div>\r\n                      <div className=\"text-sm text-gray-500\">\r\n                        {file.mimeType === 'application/vnd.google-apps.folder' \r\n                          ? 'Carpeta' \r\n                          : `Archivo ‚Ä¢ ${file.size || '0'} bytes`\r\n                        }\r\n                        {file.isLocal && ' ‚Ä¢ Local'}\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                  \r\n                  <div className=\"text-sm text-gray-400\">\r\n                    {new Date(file.createdTime).toLocaleString()}\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default GoogleDriveLocalTest;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\test\\GoogleDriveProductionDiagnosis.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'performDiagnosis'. Either include it or remove the dependency array.","line":19,"column":6,"nodeType":"ArrayExpression","endLine":19,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [performDiagnosis]","fix":{"range":[592,594],"text":"[performDiagnosis]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { hybridGoogleDrive } from '../../lib/hybridGoogleDrive.js';\r\n\r\nconst GoogleDriveProductionDiagnosis = () => {\r\n  const [diagnosis, setDiagnosis] = useState({\r\n    environment: '',\r\n    hostname: '',\r\n    redirectUri: '',\r\n    clientId: '',\r\n    hasValidCredentials: false,\r\n    serviceInfo: null,\r\n    error: null\r\n  });\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\nuseEffect(() => {\r\n    performDiagnosis();\r\n  }, []);\r\n\r\n  const performDiagnosis = () => {\r\n    try {\r\n      const hostname = window.location.hostname;\r\n      const isProduction = hostname.includes('netlify.app');\r\n      const origin = window.location.origin;\r\n      \r\n      // Detectar entorno\r\n      const environment = isProduction ? 'Producci√≥n (Netlify)' : 'Desarrollo (Local)';\r\n      \r\n      // Calcular redirect URI\r\n      const redirectUri = process.env.REACT_APP_GOOGLE_REDIRECT_URI || `${origin}/auth/google/callback`;\r\n      \r\n      // Verificar credenciales\r\n      const clientId = process.env.REACT_APP_GOOGLE_CLIENT_ID;\r\n      const hasValidCredentials = clientId && \r\n                                !clientId.includes('tu_google_client_id') && \r\n                                !clientId.includes('your-google-client-id') &&\r\n                                clientId !== 'your-google-client-id';\r\n\r\n      setDiagnosis({\r\n        environment,\r\n        hostname,\r\n        redirectUri,\r\n        clientId: clientId || 'No configurado',\r\n        hasValidCredentials,\r\n        serviceInfo: null,\r\n        error: null\r\n      });\r\n\r\n      // Intentar inicializar el servicio\r\n      initializeAndDiagnoseService();\r\n    } catch (error) {\r\n      setDiagnosis(prev => ({\r\n        ...prev,\r\n        error: error.message\r\n      }));\r\n    }\r\n  };\r\n\r\n  const initializeAndDiagnoseService = async () => {\r\n    try {\r\n      console.log('üîç Iniciando diagn√≥stico del servicio de Google Drive...');\r\n      \r\n      const initialized = await hybridGoogleDrive.initialize();\r\n      \r\n      if (initialized) {\r\n        const serviceInfo = hybridGoogleDrive.getServiceInfo();\r\n        const stats = hybridGoogleDrive.getStats();\r\n        \r\n        setDiagnosis(prev => ({\r\n          ...prev,\r\n          serviceInfo: {\r\n            ...serviceInfo,\r\n            ...stats\r\n          }\r\n        }));\r\n      }\r\n    } catch (error) {\r\n      console.error('Error en diagn√≥stico:', error);\r\n      setDiagnosis(prev => ({\r\n        ...prev,\r\n        error: error.message\r\n      }));\r\n    }\r\n  };\r\n\r\n  const generateGoogleAuthUrl = () => {\r\n    if (!diagnosis.hasValidCredentials) {\r\n      alert('‚ùå No hay credenciales v√°lidas configuradas. Consulta la gu√≠a de configuraci√≥n.');\r\n      return;\r\n    }\r\n\r\n    const params = new URLSearchParams({\r\n      client_id: diagnosis.clientId,\r\n      redirect_uri: diagnosis.redirectUri,\r\n      scope: 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/gmail.send',\r\n      response_type: 'code',\r\n      access_type: 'offline',\r\n      prompt: 'consent'\r\n    });\r\n\r\n    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?${params.toString()}`;\r\n    \r\n    // Abrir en una nueva ventana para diagn√≥stico\r\n    window.open(authUrl, 'google-auth', 'width=500,height=600,scrollbars=yes');\r\n  };\r\n\r\n  const copyToClipboard = (text) => {\r\n    navigator.clipboard.writeText(text).then(() => {\r\n      alert('‚úÖ Copiado al portapapeles');\r\n    });\r\n  };\r\n\r\n  const getRecommendation = () => {\r\n    if (diagnosis.error) {\r\n      return {\r\n        type: 'error',\r\n        title: '‚ùå Error Cr√≠tico',\r\n        message: diagnosis.error,\r\n        solution: 'Revisa la configuraci√≥n y vuelve a intentar.'\r\n      };\r\n    }\r\n\r\n    if (!diagnosis.hasValidCredentials) {\r\n      return {\r\n        type: 'warning',\r\n        title: '‚ö†Ô∏è Credenciales No V√°lidas',\r\n        message: 'Las credenciales de Google OAuth no est√°n configuradas correctamente.',\r\n        solution: 'La aplicaci√≥n funcionar√° en modo local. Para Google Drive real, configura las credenciales.'\r\n      };\r\n    }\r\n\r\n    if (diagnosis.environment === 'Producci√≥n (Netlify)') {\r\n      const expectedUri = 'https://brifyrrhhv2.netlify.app/auth/google/callback';\r\n      if (diagnosis.redirectUri !== expectedUri) {\r\n        return {\r\n          type: 'error',\r\n          title: 'üö® Error de Configuraci√≥n en Producci√≥n',\r\n          message: `El redirect_uri no coincide. Esperado: ${expectedUri}`,\r\n          solution: 'Configura el URI correcto en Google Cloud Console.'\r\n        };\r\n      }\r\n    }\r\n\r\n    if (diagnosis.serviceInfo && !diagnosis.serviceInfo.isReal) {\r\n      return {\r\n        type: 'info',\r\n        title: '‚ÑπÔ∏è Modo Local Activo',\r\n        message: 'La aplicaci√≥n est√° funcionando en modo local sin conexi√≥n a Google Drive real.',\r\n        solution: 'Esto es normal si no hay credenciales v√°lidas. Todas las funcionalidades est√°n disponibles.'\r\n      };\r\n    }\r\n\r\n    return {\r\n      type: 'success',\r\n      title: '‚úÖ Configuraci√≥n Correcta',\r\n      message: 'Todo est√° configurado correctamente.',\r\n      solution: 'La aplicaci√≥n deber√≠a funcionar con Google Drive real.'\r\n    };\r\n  };\r\n\r\n  const recommendation = getRecommendation();\r\n\r\n  const getStatusColor = (type) => {\r\n    switch (type) {\r\n      case 'success': return 'text-green-600 bg-green-50 border-green-200';\r\n      case 'warning': return 'text-yellow-600 bg-yellow-50 border-yellow-200';\r\n      case 'error': return 'text-red-600 bg-red-50 border-red-200';\r\n      default: return 'text-blue-600 bg-blue-50 border-blue-200';\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"p-6 max-w-4xl mx-auto\">\r\n      <div className=\"bg-white rounded-lg shadow-lg p-6\">\r\n        <h1 className=\"text-2xl font-bold mb-6\">üîç Diagn√≥stico de Google Drive (Producci√≥n)</h1>\r\n        \r\n        {/* Informaci√≥n del Entorno */}\r\n        <div className=\"mb-6 p-4 bg-gray-50 rounded-lg\">\r\n          <h2 className=\"text-lg font-semibold mb-3\">Informaci√≥n del Entorno</h2>\r\n          <div className=\"grid grid-cols-2 gap-4 text-sm\">\r\n            <div>\r\n              <span className=\"font-medium\">Entorno:</span> {diagnosis.environment}\r\n            </div>\r\n            <div>\r\n              <span className=\"font-medium\">Hostname:</span> {diagnosis.hostname}\r\n            </div>\r\n            <div className=\"col-span-2\">\r\n              <span className=\"font-medium\">Redirect URI:</span>\r\n              <div className=\"mt-1 p-2 bg-white rounded border\">\r\n                <code className=\"text-xs break-all\">{diagnosis.redirectUri}</code>\r\n                <button\r\n                  onClick={() => copyToClipboard(diagnosis.redirectUri)}\r\n                  className=\"ml-2 px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600\"\r\n                >\r\n                  Copiar\r\n                </button>\r\n              </div>\r\n            </div>\r\n            <div className=\"col-span-2\">\r\n              <span className=\"font-medium\">Client ID:</span>\r\n              <div className=\"mt-1 p-2 bg-white rounded border\">\r\n                <code className=\"text-xs break-all\">{diagnosis.clientId}</code>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Recomendaci√≥n */}\r\n        <div className={`mb-6 p-4 rounded-lg border ${getStatusColor(recommendation.type)}`}>\r\n          <h3 className=\"text-lg font-semibold mb-2\">{recommendation.title}</h3>\r\n          <p className=\"text-sm mb-2\">{recommendation.message}</p>\r\n          <p className=\"text-sm font-medium\">{recommendation.solution}</p>\r\n        </div>\r\n\r\n        {/* Informaci√≥n del Servicio */}\r\n        {diagnosis.serviceInfo && (\r\n          <div className=\"mb-6 p-4 bg-gray-50 rounded-lg\">\r\n            <h2 className=\"text-lg font-semibold mb-3\">Estado del Servicio</h2>\r\n            <div className=\"grid grid-cols-2 gap-4 text-sm\">\r\n              <div>\r\n                <span className=\"font-medium\">Servicio:</span> {diagnosis.serviceInfo.service}\r\n              </div>\r\n              <div>\r\n                <span className=\"font-medium\">Es Real:</span> {diagnosis.serviceInfo.isReal ? 'S√≠' : 'No'}\r\n              </div>\r\n              <div>\r\n                <span className=\"font-medium\">Archivos:</span> {diagnosis.serviceInfo.files || 0}\r\n              </div>\r\n              <div>\r\n                <span className=\"font-medium\">Carpetas:</span> {diagnosis.serviceInfo.folders || 0}\r\n              </div>\r\n              {diagnosis.serviceInfo.totalSizeFormatted && (\r\n                <div className=\"col-span-2\">\r\n                  <span className=\"font-medium\">Tama√±o Total:</span> {diagnosis.serviceInfo.totalSizeFormatted}\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Acciones */}\r\n        <div className=\"mb-6\">\r\n          <h2 className=\"text-lg font-semibold mb-3\">Acciones de Diagn√≥stico</h2>\r\n          <div className=\"flex flex-wrap gap-3\">\r\n            <button\r\n              onClick={performDiagnosis}\r\n              className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700\"\r\n            >\r\n              üîÑ Re-diagnosticar\r\n            </button>\r\n            \r\n            {diagnosis.hasValidCredentials && (\r\n              <button\r\n                onClick={generateGoogleAuthUrl}\r\n                className=\"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700\"\r\n              >\r\n                üîê Probar Autenticaci√≥n Google\r\n              </button>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Gu√≠a de Configuraci√≥n */}\r\n        <div className=\"p-4 bg-blue-50 rounded-lg\">\r\n          <h2 className=\"text-lg font-semibold mb-3\">üìã Gu√≠a de Configuraci√≥n R√°pida</h2>\r\n          \r\n          <div className=\"mb-4\">\r\n            <h3 className=\"font-medium mb-2\">1. Configurar Google Cloud Console:</h3>\r\n            <ol className=\"text-sm list-decimal list-inside space-y-1 ml-4\">\r\n              <li>Ve a <a href=\"https://console.cloud.google.com/\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-blue-600 underline\">Google Cloud Console</a></li>\r\n              <li>Selecciona tu proyecto</li>\r\n              <li>Ve a \"APIs & Services\" ‚Üí \"Credentials\"</li>\r\n              <li>Edita tu \"OAuth 2.0 Client ID\"</li>\r\n              <li>Agrega este URI: <code className=\"bg-white px-2 py-1 rounded\">{diagnosis.redirectUri}</code></li>\r\n            </ol>\r\n          </div>\r\n\r\n          <div className=\"mb-4\">\r\n            <h3 className=\"font-medium mb-2\">2. Configurar Netlify:</h3>\r\n            <ol className=\"text-sm list-decimal list-inside space-y-1 ml-4\">\r\n              <li>Ve a <a href=\"https://app.netlify.com/\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-blue-600 underline\">Netlify Dashboard</a></li>\r\n              <li>Selecciona tu sitio \"brifyrrhhv2\"</li>\r\n              <li>Ve a \"Site settings\" ‚Üí \"Build & deploy\" ‚Üí \"Environment\"</li>\r\n              <li>Agrega las variables de entorno de Google OAuth</li>\r\n            </ol>\r\n          </div>\r\n\r\n          <div>\r\n            <h3 className=\"font-medium mb-2\">3. Variables de Entorno Requeridas:</h3>\r\n            <div className=\"text-sm bg-white p-3 rounded border font-mono\">\r\n              REACT_APP_GOOGLE_CLIENT_ID=tu_client_id.apps.googleusercontent.com<br/>\r\n              REACT_APP_GOOGLE_CLIENT_SECRET=tu_client_secret<br/>\r\n              REACT_APP_GOOGLE_REDIRECT_URI={diagnosis.redirectUri}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Soluci√≥n Alternativa */}\r\n        <div className=\"p-4 bg-yellow-50 rounded-lg\">\r\n          <h2 className=\"text-lg font-semibold mb-3\">üí° Soluci√≥n Alternativa: Modo Local</h2>\r\n          <p className=\"text-sm mb-3\">\r\n            Mientras configuras las credenciales de Google, la aplicaci√≥n funciona perfectamente en modo local con todas las funcionalidades disponibles.\r\n          </p>\r\n          <ul className=\"text-sm list-disc list-inside space-y-1 ml-4\">\r\n            <li>‚úÖ Crear y gestionar carpetas</li>\r\n            <li>‚úÖ Subir y descargar archivos</li>\r\n            <li>‚úÖ Buscar archivos</li>\r\n            <li>‚úÖ Almacenamiento persistente en el navegador</li>\r\n            <li>‚úÖ Sin necesidad de configuraci√≥n de Google</li>\r\n          </ul>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default GoogleDriveProductionDiagnosis;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\test\\GoogleDriveURIChecker.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'performDiagnosis'. Either include it or remove the dependency array.","line":13,"column":6,"nodeType":"ArrayExpression","endLine":13,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [performDiagnosis]","fix":{"range":[496,498],"text":"[performDiagnosis]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'correctURIs' is assigned a value but never used.","line":130,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":130,"endColumn":50}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react'\r\nimport './GoogleDriveURIChecker.css'\r\n\r\nconst GoogleDriveURIChecker = () => {\r\n  const [diagnosis, setDiagnosis] = useState({})\r\n  const [loading, setLoading] = useState(false)\r\n  const [currentConfig, setCurrentConfig] = useState({})\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\nuseEffect(() => {\r\n    performDiagnosis()\r\n  }, [])\r\n\r\n  const performDiagnosis = async () => {\r\n    setLoading(true)\r\n    const results = {}\r\n\r\n    // 1. Verificar variables de entorno\r\n    results.environment = checkEnvironmentVariables()\r\n    \r\n    // 2. Verificar configuraci√≥n actual\r\n    results.currentConfig = getCurrentConfiguration()\r\n    \r\n    // 3. Generar URIs correctos\r\n    results.correctURIs = generateCorrectURIs()\r\n    \r\n    // 4. Verificar consistencia\r\n    results.consistency = checkConsistency(results.environment, results.correctURIs)\r\n    \r\n    // 5. Generar soluci√≥n\r\n    results.solution = generateSolution(results)\r\n\r\n    setDiagnosis(results)\r\n    setCurrentConfig(results.currentConfig)\r\n    setLoading(false)\r\n  }\r\n\r\n  const checkEnvironmentVariables = () => {\r\n    const vars = {\r\n      clientId: process.env.REACT_APP_GOOGLE_CLIENT_ID,\r\n      clientSecret: process.env.REACT_APP_GOOGLE_CLIENT_SECRET,\r\n      apiKey: process.env.REACT_APP_GOOGLE_API_KEY,\r\n      environment: process.env.REACT_APP_ENVIRONMENT,\r\n      netlifyUrl: process.env.REACT_APP_NETLIFY_URL\r\n    }\r\n\r\n    const status = {\r\n      clientId: !!vars.clientId,\r\n      clientSecret: !!vars.clientSecret,\r\n      apiKey: !!vars.apiKey,\r\n      environment: !!vars.environment,\r\n      netlifyUrl: !!vars.netlifyUrl\r\n    }\r\n\r\n    const allPresent = Object.values(status).every(Boolean)\r\n    \r\n    return {\r\n      vars,\r\n      status,\r\n      allPresent,\r\n      summary: allPresent ? '‚úÖ Todas las variables configuradas' : '‚ùå Faltan variables cr√≠ticas'\r\n    }\r\n  }\r\n\r\n  const getCurrentConfiguration = () => {\r\n    const isProduction = process.env.REACT_APP_ENVIRONMENT === 'production'\r\n    const netlifyUrl = process.env.REACT_APP_NETLIFY_URL || 'https://brifyrrhhv2.netlify.app'\r\n    \r\n    return {\r\n      environment: process.env.REACT_APP_ENVIRONMENT || 'undefined',\r\n      netlifyUrl: netlifyUrl,\r\n      currentRedirectUri: isProduction \r\n        ? `${netlifyUrl}/auth/google/callback`\r\n        : 'http://localhost:3000/auth/google/callback',\r\n      isProduction\r\n    }\r\n  }\r\n\r\n  const generateCorrectURIs = () => {\r\n    const productionURIs = [\r\n      'https://brifyrrhhv2.netlify.app/auth/google/callback',\r\n      'https://brifyrrhhv2.netlify.app'\r\n    ]\r\n    \r\n    const developmentURIs = [\r\n      'http://localhost:3000/auth/google/callback',\r\n      'http://localhost:3000'\r\n    ]\r\n\r\n    const javascriptOrigins = [\r\n      'https://brifyrrhhv2.netlify.app',\r\n      'http://localhost:3000'\r\n    ]\r\n\r\n    return {\r\n      production: {\r\n        redirectURIs: productionURIs,\r\n        javascriptOrigins: javascriptOrigins\r\n      },\r\n      development: {\r\n        redirectURIs: developmentURIs,\r\n        javascriptOrigins: javascriptOrigins\r\n      },\r\n      all: {\r\n        redirectURIs: [...productionURIs, ...developmentURIs],\r\n        javascriptOrigins: javascriptOrigins\r\n      }\r\n    }\r\n  }\r\n\r\n  const checkConsistency = (env, uris) => {\r\n    const isProduction = env.vars.environment === 'production'\r\n    const expectedUri = isProduction \r\n      ? uris.production.redirectURIs[0]\r\n      : uris.development.redirectURIs[0]\r\n    \r\n    const currentUri = getCurrentConfiguration().currentRedirectUri\r\n    \r\n    return {\r\n      isProduction,\r\n      expectedUri,\r\n      currentUri,\r\n      isConsistent: expectedUri === currentUri,\r\n      netlifyUrl: env.vars.netlifyUrl\r\n    }\r\n  }\r\n\r\n  const generateSolution = (results) => {\r\n    const { environment, consistency, correctURIs } = results\r\n    \r\n    if (!environment.allPresent) {\r\n      return {\r\n        type: 'environment',\r\n        severity: 'high',\r\n        title: 'Configurar Variables de Entorno',\r\n        description: 'Faltan variables cr√≠ticas en Netlify',\r\n        steps: [\r\n          'Ve a Netlify ‚Üí Site settings ‚Üí Environment',\r\n          'Agrega las variables faltantes',\r\n          'Redespliega el sitio'\r\n        ]\r\n      }\r\n    }\r\n\r\n    if (!consistency.isConsistent) {\r\n      return {\r\n        type: 'uri_mismatch',\r\n        severity: 'critical',\r\n        title: 'CORREGIR redirect_uri_mismatch',\r\n        description: 'El URI de redirecci√≥n no coincide con Google Cloud Console',\r\n        steps: [\r\n          'Ve a Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials',\r\n          'Edita tu OAuth 2.0 Client ID',\r\n          `Agrega este URI en Authorized redirect URIs: ${consistency.expectedUri}`,\r\n          'Agrega estos JavaScript Origins: https://brifyrrhhv2.netlify.app, http://localhost:3000',\r\n          'Guarda y espera 5 minutos',\r\n          'Limpia cache del navegador y prueba nuevamente'\r\n        ]\r\n      }\r\n    }\r\n\r\n    return {\r\n      type: 'success',\r\n      severity: 'low',\r\n      title: 'Configuraci√≥n Correcta',\r\n      description: 'Todo parece estar configurado correctamente',\r\n      steps: [\r\n        'Si a√∫n tienes problemas, limpia la cache del navegador',\r\n        'Usa modo inc√≥gnito para probar',\r\n        'Espera 5 minutos si hiciste cambios recientes'\r\n      ]\r\n    }\r\n  }\r\n\r\n  const copyToClipboard = (text) => {\r\n    navigator.clipboard.writeText(text)\r\n    alert('¬°Copiado al portapapeles!')\r\n  }\r\n\r\n  const openGoogleCloudConsole = () => {\r\n    window.open('https://console.cloud.google.com/apis/credentials', '_blank')\r\n  }\r\n\r\n  const openNetlifyEnvironment = () => {\r\n    window.open('https://app.netlify.com/sites/brifyrrhhv2/settings/deploys/environment', '_blank')\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"uri-checker\">\r\n        <div className=\"loading\">\r\n          <div className=\"spinner\"></div>\r\n          <p>Analizando configuraci√≥n de Google Drive...</p>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  const solution = diagnosis.solution\r\n\r\n  return (\r\n    <div className=\"uri-checker\">\r\n      <div className=\"header\">\r\n        <h1>üîç Diagn√≥stico de Error Google Drive</h1>\r\n        <p>Herramienta especializada para resolver \"Acceso bloqueado: La solicitud de BrifyRRHH no es v√°lida\"</p>\r\n      </div>\r\n\r\n      {/* Resultado Principal */}\r\n      <div className={`solution-card ${solution.type}`}>\r\n        <div className=\"solution-header\">\r\n          <h2>{solution.title}</h2>\r\n          <span className={`severity ${solution.severity}`}>\r\n            {solution.severity === 'critical' ? 'üö® CR√çTICO' : \r\n             solution.severity === 'high' ? '‚ö†Ô∏è ALTO' : \r\n             solution.severity === 'medium' ? 'üì° MEDIO' : '‚úÖ OK'}\r\n          </span>\r\n        </div>\r\n        <p>{solution.description}</p>\r\n        \r\n        <div className=\"steps\">\r\n          <h3>Pasos para Solucionar:</h3>\r\n          <ol>\r\n            {solution.steps.map((step, index) => (\r\n              <li key={index}>{step}</li>\r\n            ))}\r\n          </ol>\r\n        </div>\r\n\r\n        <div className=\"actions\">\r\n          {solution.type === 'uri_mismatch' && (\r\n            <>\r\n              <button onClick={openGoogleCloudConsole} className=\"btn btn-primary\">\r\n                üåê Abrir Google Cloud Console\r\n              </button>\r\n              <button onClick={() => copyToClipboard(diagnosis.consistency.expectedUri)} className=\"btn btn-secondary\">\r\n                üìã Copiar URI Correcto\r\n              </button>\r\n            </>\r\n          )}\r\n          {solution.type === 'environment' && (\r\n            <button onClick={openNetlifyEnvironment} className=\"btn btn-primary\">\r\n                üîß Abrir Variables de Entorno Netlify\r\n            </button>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Diagn√≥stico Detallado */}\r\n      <div className=\"diagnosis-details\">\r\n        <h2>üìã Diagn√≥stico Detallado</h2>\r\n        \r\n        {/* Variables de Entorno */}\r\n        <div className=\"section\">\r\n          <h3>Variables de Entorno</h3>\r\n          <div className=\"status-grid\">\r\n            <div className={`status-item ${diagnosis.environment?.status?.clientId ? 'success' : 'error'}`}>\r\n              <span>Client ID:</span>\r\n              <span>{diagnosis.environment?.status?.clientId ? '‚úÖ Configurado' : '‚ùå Faltante'}</span>\r\n            </div>\r\n            <div className={`status-item ${diagnosis.environment?.status?.clientSecret ? 'success' : 'error'}`}>\r\n              <span>Client Secret:</span>\r\n              <span>{diagnosis.environment?.status?.clientSecret ? '‚úÖ Configurado' : '‚ùå Faltante'}</span>\r\n            </div>\r\n            <div className={`status-item ${diagnosis.environment?.status?.apiKey ? 'success' : 'error'}`}>\r\n              <span>API Key:</span>\r\n              <span>{diagnosis.environment?.status?.apiKey ? '‚úÖ Configurado' : '‚ùå Faltante'}</span>\r\n            </div>\r\n            <div className={`status-item ${diagnosis.environment?.status?.environment ? 'success' : 'error'}`}>\r\n              <span>Environment:</span>\r\n              <span>{diagnosis.environment?.vars?.environment || '‚ùå Undefined'}</span>\r\n            </div>\r\n            <div className={`status-item ${diagnosis.environment?.status?.netlifyUrl ? 'success' : 'error'}`}>\r\n              <span>Netlify URL:</span>\r\n              <span>{diagnosis.environment?.vars?.netlifyUrl || '‚ùå Undefined'}</span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Configuraci√≥n Actual */}\r\n        <div className=\"section\">\r\n          <h3>Configuraci√≥n Actual</h3>\r\n          <div className=\"config-info\">\r\n            <div className=\"info-item\">\r\n              <span>Entorno:</span>\r\n              <span>{currentConfig.environment}</span>\r\n            </div>\r\n            <div className=\"info-item\">\r\n              <span>Netlify URL:</span>\r\n              <span>{currentConfig.netlifyUrl}</span>\r\n            </div>\r\n            <div className=\"info-item\">\r\n              <span>URI Actual:</span>\r\n              <code>{currentConfig.currentRedirectUri}</code>\r\n            </div>\r\n            <div className=\"info-item\">\r\n              <span>Es Producci√≥n:</span>\r\n              <span>{currentConfig.isProduction ? 'S√≠' : 'No'}</span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* URIs Correctos */}\r\n        <div className=\"section\">\r\n          <h3>URIs que Deben Estar Configurados en Google Cloud Console</h3>\r\n          <div className=\"uri-list\">\r\n            <div className=\"uri-group\">\r\n              <h4>üîí Authorized redirect URIs:</h4>\r\n              <ul>\r\n                {diagnosis.correctURIs?.all?.redirectURIs?.map((uri, index) => (\r\n                  <li key={index}>\r\n                    <code>{uri}</code>\r\n                    <button onClick={() => copyToClipboard(uri)} className=\"copy-btn\">üìã</button>\r\n                  </li>\r\n                ))}\r\n              </ul>\r\n            </div>\r\n            \r\n            <div className=\"uri-group\">\r\n              <h4>üåê Authorized JavaScript origins:</h4>\r\n              <ul>\r\n                {diagnosis.correctURIs?.all?.javascriptOrigins?.map((origin, index) => (\r\n                  <li key={index}>\r\n                    <code>{origin}</code>\r\n                    <button onClick={() => copyToClipboard(origin)} className=\"copy-btn\">üìã</button>\r\n                  </li>\r\n                ))}\r\n              </ul>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Verificaci√≥n de Consistencia */}\r\n        <div className=\"section\">\r\n          <h3>Verificaci√≥n de Consistencia</h3>\r\n          <div className=\"consistency-check\">\r\n            <div className={`check-item ${diagnosis.consistency?.isConsistent ? 'success' : 'error'}`}>\r\n              <span>Consistencia URI:</span>\r\n              <span>{diagnosis.consistency?.isConsistent ? '‚úÖ Correcto' : '‚ùå Incorreto'}</span>\r\n            </div>\r\n            <div className=\"check-item\">\r\n              <span>URI Esperado:</span>\r\n              <code>{diagnosis.consistency?.expectedUri}</code>\r\n            </div>\r\n            <div className=\"check-item\">\r\n              <span>URI Actual:</span>\r\n              <code>{diagnosis.consistency?.currentUri}</code>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Herramientas Adicionales */}\r\n      <div className=\"tools\">\r\n        <h2>üõ†Ô∏è Herramientas Adicionales</h2>\r\n        <div className=\"tool-grid\">\r\n          <button onClick={performDiagnosis} className=\"tool-btn\">\r\n            üîÑ Re-ejecutar Diagn√≥stico\r\n          </button>\r\n          <button onClick={() => window.open('/test-google-drive-local', '_blank')} className=\"tool-btn\">\r\n            üß™ Probar Google Drive Local\r\n          </button>\r\n          <button onClick={() => window.open('/google-drive-production-diagnosis', '_blank')} className=\"tool-btn\">\r\n            üîç Diagn√≥stico Completo de Producci√≥n\r\n          </button>\r\n          <button onClick={() => window.open('/integrations/my-google-drive', '_blank')} className=\"tool-btn\">\r\n            üìÅ Ir a Conexi√≥n Google Drive\r\n          </button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Informaci√≥n de Soporte */}\r\n      <div className=\"support\">\r\n        <h2>üìû Si el Problema Persiste</h2>\r\n        <div className=\"support-steps\">\r\n          <div className=\"support-step\">\r\n            <h3>1. Captura de Pantalla</h3>\r\n            <p>Toma captura de esta p√°gina de diagn√≥stico y del error en Google Cloud Console</p>\r\n          </div>\r\n          <div className=\"support-step\">\r\n            <h3>2. Limpia Cache</h3>\r\n            <p>Usa modo inc√≥gnito o limpia completamente la cache y cookies del navegador</p>\r\n          </div>\r\n          <div className=\"support-step\">\r\n            <h3>3. Espera Propagaci√≥n</h3>\r\n            <p>Despu√©s de hacer cambios en Google Cloud Console, espera 5-10 minutos</p>\r\n          </div>\r\n          <div className=\"support-step\">\r\n            <h3>4. Prueba en Desarrollo</h3>\r\n            <p>Si falla producci√≥n, prueba en http://localhost:3000/integrations/my-google-drive</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default GoogleDriveURIChecker","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\test\\GoogleDriveURIDebugger.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\test\\WhatsAppAPITest.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\whatsapp\\MultiWhatsAppManager.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\whatsapp\\WhatsAppComplianceManager.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadComplianceData'. Either include it or remove the dependency array.","line":47,"column":6,"nodeType":"ArrayExpression","endLine":47,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [companyId, loadComplianceData]","fix":{"range":[1464,1475],"text":"[companyId, loadComplianceData]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { \r\n  ShieldCheckIcon, \r\n  ExclamationTriangleIcon,\r\n  CheckCircleIcon,\r\n  XCircleIcon,\r\n  ClockIcon,\r\n  UserGroupIcon,\r\n  DocumentTextIcon,\r\n  ChartBarIcon\r\n} from '@heroicons/react/24/outline';\r\nimport { supabase } from '../../lib/supabase.js';\r\nimport whatsappComplianceService from '../../services/whatsappComplianceService.js';\r\n\r\n/**\r\n * Componente para gestionar el cumplimiento de pol√≠ticas de WhatsApp Business\r\n * \r\n * Este componente permite:\r\n * - Gestionar consentimientos de usuarios\r\n * - Monitorear calidad de n√∫meros\r\n * - Verificar estado de cumplimiento\r\n * - Gestionar plantillas aprobadas\r\n * - Visualizar reportes de cumplimiento\r\n */\r\nconst WhatsAppComplianceManager = ({ companyId }) => {\r\n  const [loading, setLoading] = useState(true);\r\n  const [activeTab, setActiveTab] = useState('consent');\r\n  const [consents, setConsents] = useState([]);\r\n  const [qualityMetrics, setQualityMetrics] = useState(null);\r\n  const [complianceStatus, setComplianceStatus] = useState(null);\r\n  const [templates, setTemplates] = useState([]);\r\n  const [violations, setViolations] = useState([]);\r\n  const [stats, setStats] = useState({\r\n    totalUsers: 0,\r\n    activeConsents: 0,\r\n    expiredConsents: 0,\r\n    qualityScore: 0,\r\n    messagesToday: 0,\r\n    blockedMessages: 0\r\n  });\r\n\r\n  // Cargar datos iniciales\r\n  useEffect(() => {\r\n    if (companyId) {\r\n      loadComplianceData();\r\n    }\r\n  }, [companyId]);\r\n\r\n  const loadComplianceData = async () => {\r\n    try {\r\n      setLoading(true);\r\n      \r\n      // Cargar datos en paralelo\r\n      const [\r\n        consentsData,\r\n        qualityData,\r\n        statusData,\r\n        templatesData,\r\n        violationsData,\r\n        statsData\r\n      ] = await Promise.all([\r\n        loadUserConsents(),\r\n        loadQualityMetrics(),\r\n        loadComplianceStatus(),\r\n        loadTemplates(),\r\n        loadViolations(),\r\n        loadStats()\r\n      ]);\r\n\r\n      setConsents(consentsData);\r\n      setQualityMetrics(qualityData);\r\n      setComplianceStatus(statusData);\r\n      setTemplates(templatesData);\r\n      setViolations(violationsData);\r\n      setStats(statsData);\r\n\r\n    } catch (error) {\r\n      console.error('Error cargando datos de cumplimiento:', error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const loadUserConsents = async () => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('user_consent')\r\n        .select(`\r\n          *,\r\n          users:user_id (name, email)\r\n        `)\r\n        .eq('company_id', companyId)\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (error) throw error;\r\n      return data || [];\r\n    } catch (error) {\r\n      console.error('Error cargando consentimientos:', error);\r\n      return [];\r\n    }\r\n  };\r\n\r\n  const loadQualityMetrics = async () => {\r\n    try {\r\n      const metrics = await whatsappComplianceService.getQualityMetrics(companyId);\r\n      return metrics;\r\n    } catch (error) {\r\n      console.error('Error cargando m√©tricas de calidad:', error);\r\n      return null;\r\n    }\r\n  };\r\n\r\n  const loadComplianceStatus = async () => {\r\n    try {\r\n      const status = await whatsappComplianceService.getComplianceStatus(companyId);\r\n      return status;\r\n    } catch (error) {\r\n      console.error('Error cargando estado de cumplimiento:', error);\r\n      return null;\r\n    }\r\n  };\r\n\r\n  const loadTemplates = async () => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('whatsapp_templates')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .eq('status', 'approved')\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (error) throw error;\r\n      return data || [];\r\n    } catch (error) {\r\n      console.error('Error cargando plantillas:', error);\r\n      return [];\r\n    }\r\n  };\r\n\r\n  const loadViolations = async () => {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('compliance_logs')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .eq('event_type', 'policy_violation')\r\n        .order('created_at', { ascending: false })\r\n        .limit(10);\r\n\r\n      if (error) throw error;\r\n      return data || [];\r\n    } catch (error) {\r\n      console.error('Error cargando violaciones:', error);\r\n      return [];\r\n    }\r\n  };\r\n\r\n  const loadStats = async () => {\r\n    try {\r\n      const today = new Date().toISOString().split('T')[0];\r\n      \r\n      // Cargar estad√≠sticas\r\n      const [\r\n        totalUsers,\r\n        activeConsents,\r\n        expiredConsents,\r\n        messagesToday,\r\n        blockedMessages\r\n      ] = await Promise.all([\r\n        supabase.from('user_consent').select('id', { count: 'exact' }).eq('company_id', companyId),\r\n        supabase.from('user_consent').select('id', { count: 'exact' }).eq('company_id', companyId).eq('status', 'active'),\r\n        supabase.from('user_consent').select('id', { count: 'exact' }).eq('company_id', companyId).eq('status', 'expired'),\r\n        supabase.from('whatsapp_logs').select('id', { count: 'exact' }).eq('company_id', companyId).gte('created_at', today),\r\n        supabase.from('compliance_logs').select('id', { count: 'exact' }).eq('company_id', companyId).eq('event_type', 'message_blocked').gte('created_at', today)\r\n      ]);\r\n\r\n      const qualityScore = qualityMetrics?.currentScore || 0;\r\n\r\n      return {\r\n        totalUsers: totalUsers.count || 0,\r\n        activeConsents: activeConsents.count || 0,\r\n        expiredConsents: expiredConsents.count || 0,\r\n        qualityScore,\r\n        messagesToday: messagesToday.count || 0,\r\n        blockedMessages: blockedMessages.count || 0\r\n      };\r\n    } catch (error) {\r\n      console.error('Error cargando estad√≠sticas:', error);\r\n      return {\r\n        totalUsers: 0,\r\n        activeConsents: 0,\r\n        expiredConsents: 0,\r\n        qualityScore: 0,\r\n        messagesToday: 0,\r\n        blockedMessages: 0\r\n      };\r\n    }\r\n  };\r\n\r\n  const handleRevokeConsent = async (consentId) => {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('user_consent')\r\n        .update({ \r\n          status: 'revoked',\r\n          revoked_at: new Date().toISOString()\r\n        })\r\n        .eq('id', consentId);\r\n\r\n      if (error) throw error;\r\n\r\n      // Recargar datos\r\n      await loadComplianceData();\r\n      \r\n      // Registrar evento\r\n      await whatsappComplianceService.logComplianceEvent({\r\n        companyId,\r\n        eventType: 'consent_revoked',\r\n        details: { consentId }\r\n      });\r\n\r\n    } catch (error) {\r\n      console.error('Error revocando consentimiento:', error);\r\n    }\r\n  };\r\n\r\n  const handleRenewConsent = async (consentId) => {\r\n    try {\r\n      const expiresAt = new Date();\r\n      expiresAt.setFullYear(expiresAt.getFullYear() + 2); // 2 a√±os\r\n\r\n      const { error } = await supabase\r\n        .from('user_consent')\r\n        .update({ \r\n          status: 'active',\r\n          expires_at: expiresAt.toISOString(),\r\n          renewed_at: new Date().toISOString()\r\n        })\r\n        .eq('id', consentId);\r\n\r\n      if (error) throw error;\r\n\r\n      // Recargar datos\r\n      await loadComplianceData();\r\n      \r\n      // Registrar evento\r\n      await whatsappComplianceService.logComplianceEvent({\r\n        companyId,\r\n        eventType: 'consent_renewed',\r\n        details: { consentId }\r\n      });\r\n\r\n    } catch (error) {\r\n      console.error('Error renovando consentimiento:', error);\r\n    }\r\n  };\r\n\r\n  const getQualityColor = (score) => {\r\n    if (score >= 95) return 'text-green-600 bg-green-100';\r\n    if (score >= 90) return 'text-yellow-600 bg-yellow-100';\r\n    return 'text-red-600 bg-red-100';\r\n  };\r\n\r\n  const getQualityLabel = (score) => {\r\n    if (score >= 95) return 'Excelente';\r\n    if (score >= 90) return 'Bueno';\r\n    if (score >= 80) return 'Regular';\r\n    return 'Cr√≠tico';\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center p-8\">\r\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600\"></div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-6\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center space-x-3\">\r\n            <ShieldCheckIcon className=\"h-8 w-8 text-green-600\" />\r\n            <div>\r\n              <h1 className=\"text-2xl font-bold text-gray-900\">Centro de Cumplimiento</h1>\r\n              <p className=\"text-gray-600\">Gesti√≥n de pol√≠ticas de WhatsApp Business</p>\r\n            </div>\r\n          </div>\r\n          \r\n          {complianceStatus && (\r\n            <div className={`px-4 py-2 rounded-full ${getQualityColor(complianceStatus.overallScore)}`}>\r\n              <span className=\"font-medium\">\r\n                {getQualityLabel(complianceStatus.overallScore)} ({complianceStatus.overallScore.toFixed(1)}%)\r\n              </span>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Stats Cards */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4\">\r\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-sm text-gray-600\">Usuarios Totales</p>\r\n              <p className=\"text-2xl font-bold text-gray-900\">{stats.totalUsers}</p>\r\n            </div>\r\n            <UserGroupIcon className=\"h-8 w-8 text-blue-600\" />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-sm text-gray-600\">Consentimientos Activos</p>\r\n              <p className=\"text-2xl font-bold text-green-600\">{stats.activeConsents}</p>\r\n            </div>\r\n            <CheckCircleIcon className=\"h-8 w-8 text-green-600\" />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-sm text-gray-600\">Consentimientos Expirados</p>\r\n              <p className=\"text-2xl font-bold text-yellow-600\">{stats.expiredConsents}</p>\r\n            </div>\r\n            <ClockIcon className=\"h-8 w-8 text-yellow-600\" />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-sm text-gray-600\">Calidad del N√∫mero</p>\r\n              <p className={`text-2xl font-bold ${stats.qualityScore >= 95 ? 'text-green-600' : stats.qualityScore >= 90 ? 'text-yellow-600' : 'text-red-600'}`}>\r\n                {stats.qualityScore.toFixed(1)}%\r\n              </p>\r\n            </div>\r\n            <ChartBarIcon className=\"h-8 w-8 text-blue-600\" />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-sm text-gray-600\">Mensajes Hoy</p>\r\n              <p className=\"text-2xl font-bold text-blue-600\">{stats.messagesToday}</p>\r\n            </div>\r\n            <DocumentTextIcon className=\"h-8 w-8 text-blue-600\" />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-sm text-gray-600\">Mensajes Bloqueados</p>\r\n              <p className=\"text-2xl font-bold text-red-600\">{stats.blockedMessages}</p>\r\n            </div>\r\n            <XCircleIcon className=\"h-8 w-8 text-red-600\" />\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Tabs */}\r\n      <div className=\"bg-white rounded-lg shadow-sm border border-gray-200\">\r\n        <div className=\"border-b border-gray-200\">\r\n          <nav className=\"flex space-x-8 px-6\" aria-label=\"Tabs\">\r\n            {[\r\n              { id: 'consent', name: 'Consentimientos', icon: UserGroupIcon },\r\n              { id: 'quality', name: 'Calidad', icon: ChartBarIcon },\r\n              { id: 'templates', name: 'Plantillas', icon: DocumentTextIcon },\r\n              { id: 'violations', name: 'Violaciones', icon: ExclamationTriangleIcon }\r\n            ].map((tab) => (\r\n              <button\r\n                key={tab.id}\r\n                onClick={() => setActiveTab(tab.id)}\r\n                className={`py-4 px-1 border-b-2 font-medium text-sm ${\r\n                  activeTab === tab.id\r\n                    ? 'border-blue-500 text-blue-600'\r\n                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'\r\n                }`}\r\n              >\r\n                <div className=\"flex items-center space-x-2\">\r\n                  <tab.icon className=\"h-5 w-5\" />\r\n                  <span>{tab.name}</span>\r\n                </div>\r\n              </button>\r\n            ))}\r\n          </nav>\r\n        </div>\r\n\r\n        <div className=\"p-6\">\r\n          {/* Tab Content */}\r\n          {activeTab === 'consent' && (\r\n            <div className=\"space-y-4\">\r\n              <h3 className=\"text-lg font-medium text-gray-900\">Gesti√≥n de Consentimientos</h3>\r\n              \r\n              {consents.length === 0 ? (\r\n                <div className=\"text-center py-8 text-gray-500\">\r\n                  No hay consentimientos registrados\r\n                </div>\r\n              ) : (\r\n                <div className=\"overflow-x-auto\">\r\n                  <table className=\"min-w-full divide-y divide-gray-200\">\r\n                    <thead className=\"bg-gray-50\">\r\n                      <tr>\r\n                        <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                          Usuario\r\n                        </th>\r\n                        <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                          Estado\r\n                        </th>\r\n                        <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                          Fecha de Consentimiento\r\n                        </th>\r\n                        <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                          Expira\r\n                        </th>\r\n                        <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\r\n                          Acciones\r\n                        </th>\r\n                      </tr>\r\n                    </thead>\r\n                    <tbody className=\"bg-white divide-y divide-gray-200\">\r\n                      {consents.map((consent) => (\r\n                        <tr key={consent.id}>\r\n                          <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                            <div>\r\n                              <div className=\"text-sm font-medium text-gray-900\">\r\n                                {consent.users?.name || 'Usuario'}\r\n                              </div>\r\n                              <div className=\"text-sm text-gray-500\">\r\n                                {consent.users?.email || consent.user_phone}\r\n                              </div>\r\n                            </div>\r\n                          </td>\r\n                          <td className=\"px-6 py-4 whitespace-nowrap\">\r\n                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${\r\n                              consent.status === 'active' ? 'bg-green-100 text-green-800' :\r\n                              consent.status === 'expired' ? 'bg-yellow-100 text-yellow-800' :\r\n                              'bg-red-100 text-red-800'\r\n                            }`}>\r\n                              {consent.status === 'active' ? 'Activo' :\r\n                               consent.status === 'expired' ? 'Expirado' : 'Revocado'}\r\n                            </span>\r\n                          </td>\r\n                          <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\r\n                            {new Date(consent.created_at).toLocaleDateString()}\r\n                          </td>\r\n                          <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\r\n                            {new Date(consent.expires_at).toLocaleDateString()}\r\n                          </td>\r\n                          <td className=\"px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2\">\r\n                            {consent.status === 'active' && (\r\n                              <button\r\n                                onClick={() => handleRevokeConsent(consent.id)}\r\n                                className=\"text-red-600 hover:text-red-900\"\r\n                              >\r\n                                Revocar\r\n                              </button>\r\n                            )}\r\n                            {consent.status === 'expired' && (\r\n                              <button\r\n                                onClick={() => handleRenewConsent(consent.id)}\r\n                                className=\"text-green-600 hover:text-green-900\"\r\n                              >\r\n                                Renovar\r\n                              </button>\r\n                            )}\r\n                          </td>\r\n                        </tr>\r\n                      ))}\r\n                    </tbody>\r\n                  </table>\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {activeTab === 'quality' && (\r\n            <div className=\"space-y-6\">\r\n              <h3 className=\"text-lg font-medium text-gray-900\">M√©tricas de Calidad</h3>\r\n              \r\n              {qualityMetrics ? (\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                  <div className=\"bg-gray-50 rounded-lg p-6\">\r\n                    <h4 className=\"text-md font-medium text-gray-900 mb-4\">Estado Actual</h4>\r\n                    <div className=\"space-y-3\">\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-sm text-gray-600\">Puntuaci√≥n de Calidad:</span>\r\n                        <span className={`font-medium ${qualityMetrics.currentScore >= 95 ? 'text-green-600' : qualityMetrics.currentScore >= 90 ? 'text-yellow-600' : 'text-red-600'}`}>\r\n                          {qualityMetrics.currentScore.toFixed(1)}%\r\n                        </span>\r\n                      </div>\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-sm text-gray-600\">Estado:</span>\r\n                        <span className={`font-medium ${getQualityColor(qualityMetrics.currentScore).split(' ')[0]}`}>\r\n                          {getQualityLabel(qualityMetrics.currentScore)}\r\n                        </span>\r\n                      </div>\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-sm text-gray-600\">Mensajes Enviados:</span>\r\n                        <span className=\"font-medium\">{qualityMetrics.messagesSent}</span>\r\n                      </div>\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-sm text-gray-600\">Tasa de Respuesta:</span>\r\n                        <span className=\"font-medium\">{qualityMetrics.responseRate.toFixed(1)}%</span>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div className=\"bg-gray-50 rounded-lg p-6\">\r\n                    <h4 className=\"text-md font-medium text-gray-900 mb-4\">L√≠mites Din√°micos</h4>\r\n                    <div className=\"space-y-3\">\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-sm text-gray-600\">L√≠mite Diario:</span>\r\n                        <span className=\"font-medium\">{qualityMetrics.dynamicLimits?.dailyLimit || 'N/A'}</span>\r\n                      </div>\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-sm text-gray-600\">L√≠mite Por Hora:</span>\r\n                        <span className=\"font-medium\">{qualityMetrics.dynamicLimits?.hourlyLimit || 'N/A'}</span>\r\n                      </div>\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-sm text-gray-600\">Mensajes Usados Hoy:</span>\r\n                        <span className=\"font-medium\">{qualityMetrics.messagesToday || 0}</span>\r\n                      </div>\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-sm text-gray-600\">Disponibles Hoy:</span>\r\n                        <span className=\"font-medium text-green-600\">\r\n                          {(qualityMetrics.dynamicLimits?.dailyLimit || 0) - (qualityMetrics.messagesToday || 0)}\r\n                        </span>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              ) : (\r\n                <div className=\"text-center py-8 text-gray-500\">\r\n                  No hay m√©tricas de calidad disponibles\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {activeTab === 'templates' && (\r\n            <div className=\"space-y-4\">\r\n              <h3 className=\"text-lg font-medium text-gray-900\">Plantillas Aprobadas</h3>\r\n              \r\n              {templates.length === 0 ? (\r\n                <div className=\"text-center py-8 text-gray-500\">\r\n                  No hay plantillas aprobadas\r\n                </div>\r\n              ) : (\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                  {templates.map((template) => (\r\n                    <div key={template.id} className=\"border border-gray-200 rounded-lg p-4\">\r\n                      <div className=\"flex items-center justify-between mb-2\">\r\n                        <h4 className=\"font-medium text-gray-900\">{template.name}</h4>\r\n                        <span className=\"px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full\">\r\n                          Aprobado\r\n                        </span>\r\n                      </div>\r\n                      <p className=\"text-sm text-gray-600 mb-2\">{template.content}</p>\r\n                      <div className=\"text-xs text-gray-500\">\r\n                        <div>Categor√≠a: {template.category}</div>\r\n                        <div>Idioma: {template.language}</div>\r\n                        <div>Creado: {new Date(template.created_at).toLocaleDateString()}</div>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {activeTab === 'violations' && (\r\n            <div className=\"space-y-4\">\r\n              <h3 className=\"text-lg font-medium text-gray-900\">Violaciones de Pol√≠ticas</h3>\r\n              \r\n              {violations.length === 0 ? (\r\n                <div className=\"text-center py-8 text-gray-500\">\r\n                  No hay violaciones registradas\r\n                </div>\r\n              ) : (\r\n                <div className=\"space-y-3\">\r\n                  {violations.map((violation) => (\r\n                    <div key={violation.id} className=\"border border-red-200 rounded-lg p-4 bg-red-50\">\r\n                      <div className=\"flex items-start space-x-3\">\r\n                        <ExclamationTriangleIcon className=\"h-5 w-5 text-red-600 mt-0.5\" />\r\n                        <div className=\"flex-1\">\r\n                          <div className=\"flex items-center justify-between mb-2\">\r\n                            <h4 className=\"font-medium text-red-900\">\r\n                              {violation.details?.violation_type || 'Violaci√≥n de Pol√≠tica'}\r\n                            </h4>\r\n                            <span className=\"text-sm text-red-600\">\r\n                              {new Date(violation.created_at).toLocaleString()}\r\n                            </span>\r\n                          </div>\r\n                          <p className=\"text-sm text-red-800\">\r\n                            {violation.details?.description || violation.details?.reason || 'Sin descripci√≥n'}\r\n                          </p>\r\n                          {violation.details?.user_phone && (\r\n                            <p className=\"text-xs text-red-600 mt-1\">\r\n                              Usuario: {violation.details.user_phone}\r\n                            </p>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default WhatsAppComplianceManager;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\whatsapp\\WhatsAppOnboarding.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'PhoneIcon' is defined but never used.","line":10,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'DocumentTextIcon' is defined but never used.","line":24,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'WrenchScrewdriverIcon' is defined but never used.","line":27,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":24},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'initializeOnboarding'. Either include it or remove the dependency array.","line":107,"column":6,"nodeType":"ArrayExpression","endLine":107,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [initializeOnboarding]","fix":{"range":[3383,3385],"text":"[initializeOnboarding]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * WhatsApp Business Onboarding Unificado\r\n *\r\n * Sistema integral que gu√≠a al usuario desde cero hasta tener WhatsApp funcionando.\r\n * Experiencia completamente guiada para usuarios no t√©cnicos.\r\n */\r\n\r\nimport React, { useState, useEffect } from 'react';\r\nimport {\r\n  PhoneIcon,\r\n  CheckCircleIcon,\r\n  ExclamationTriangleIcon,\r\n  ArrowRightIcon,\r\n  ArrowLeftIcon,\r\n  SparklesIcon,\r\n  ChatBubbleLeftRightIcon,\r\n  CogIcon,\r\n  ShieldCheckIcon,\r\n  UserGroupIcon,\r\n  ChartBarIcon,\r\n  QuestionMarkCircleIcon,\r\n  LightBulbIcon,\r\n  PlayIcon,\r\n  DocumentTextIcon,\r\n  GlobeAltIcon,\r\n  KeyIcon,\r\n  WrenchScrewdriverIcon\r\n} from '@heroicons/react/24/outline';\r\nimport { CheckCircleIcon as CheckCircleSolid } from '@heroicons/react/24/solid';\r\nimport communicationService from '../../services/communicationService.js';\r\nimport whatsappConnectionService from '../../services/whatsappConnectionService.js';\r\n\r\nconst WhatsAppOnboarding = () => {\r\n  const [currentStep, setCurrentStep] = useState(0);\r\n  const [userProfile, setUserProfile] = useState(null);\r\n  const [companies, setCompanies] = useState([]);\r\n  const [configurations, setConfigurations] = useState([]);\r\n  const [selectedCompany, setSelectedCompany] = useState('');\r\n  const [setupData, setSetupData] = useState({\r\n    accessToken: '',\r\n    phoneNumberId: '',\r\n    webhookVerifyToken: '',\r\n    testMode: true\r\n  });\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [connectionTest, setConnectionTest] = useState(null);\r\n  const [showHelp, setShowHelp] = useState(false);\r\n  const [completedSteps, setCompletedSteps] = useState(new Set());\r\n\r\n  // Pasos del onboarding\r\n  const steps = [\r\n    {\r\n      id: 'welcome',\r\n      title: '¬°Bienvenido a WhatsApp Business!',\r\n      description: 'Vamos a configurar WhatsApp para tu empresa paso a paso',\r\n      icon: SparklesIcon,\r\n      component: WelcomeStep\r\n    },\r\n    {\r\n      id: 'check_existing',\r\n      title: 'Verificando configuraciones',\r\n      description: 'Comprobando si ya tienes WhatsApp configurado',\r\n      icon: CogIcon,\r\n      component: CheckExistingStep\r\n    },\r\n    {\r\n      id: 'select_company',\r\n      title: 'Selecciona tu empresa',\r\n      description: 'Elige la empresa que estar√° asociada a WhatsApp',\r\n      icon: UserGroupIcon,\r\n      component: SelectCompanyStep\r\n    },\r\n    {\r\n      id: 'meta_setup',\r\n      title: 'Configura Meta Developers',\r\n      description: 'Te guiamos paso a paso para obtener tus credenciales',\r\n      icon: GlobeAltIcon,\r\n      component: MetaSetupStep\r\n    },\r\n    {\r\n      id: 'credentials',\r\n      title: 'Ingresa tus credenciales',\r\n      description: 'Copia y pega la informaci√≥n de Meta Developers',\r\n      icon: KeyIcon,\r\n      component: CredentialsStep\r\n    },\r\n    {\r\n      id: 'test_connection',\r\n      title: 'Probamos tu conexi√≥n',\r\n      description: 'Verificamos que todo funcione correctamente',\r\n      icon: ShieldCheckIcon,\r\n      component: TestConnectionStep\r\n    },\r\n    {\r\n      id: 'success',\r\n      title: '¬°Listo! WhatsApp configurado',\r\n      description: 'Tu WhatsApp Business est√° funcionando',\r\n      icon: CheckCircleIcon,\r\n      component: SuccessStep\r\n    }\r\n  ];\r\n\r\n  // eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\r\n// eslint-disable-next-line no-use-before-define, react-hooks/exhaustive-deps\r\nuseEffect(() => {\r\n    initializeOnboarding();\r\n  }, []);\r\n\r\n  const initializeOnboarding = async () => {\r\n    setIsLoading(true);\r\n    try {\r\n      // Cargar perfil del usuario\r\n      const profile = await communicationService.getCurrentUser();\r\n      setUserProfile(profile);\r\n\r\n      // Cargar empresas\r\n      const companiesResult = await communicationService.getCompanies();\r\n      if (companiesResult) {\r\n        setCompanies(companiesResult);\r\n      }\r\n\r\n      // Cargar configuraciones existentes\r\n      const configsResult = await communicationService.getAllWhatsAppConfigurations();\r\n      if (configsResult.success) {\r\n        setConfigurations(configsResult.configurations);\r\n      }\r\n\r\n      // Determinar paso inicial\r\n      if (configsResult.configurations && configsResult.configurations.length > 0) {\r\n        // Usuario ya tiene configuraciones, ir directo al dashboard\r\n        setCurrentStep(steps.length - 1); // √öltimo paso (success)\r\n      } else {\r\n        setCurrentStep(0); // Comenzar desde el inicio\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('Error inicializando onboarding:', error);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const nextStep = () => {\r\n    if (currentStep < steps.length - 1) {\r\n      setCompletedSteps(prev => new Set([...prev, currentStep]));\r\n      setCurrentStep(currentStep + 1);\r\n    }\r\n  };\r\n\r\n  const prevStep = () => {\r\n    if (currentStep > 0) {\r\n      setCurrentStep(currentStep - 1);\r\n    }\r\n  };\r\n\r\n  const goToStep = (stepIndex) => {\r\n    setCurrentStep(stepIndex);\r\n  };\r\n\r\n  const handleCompanySelect = (companyId) => {\r\n    setSelectedCompany(companyId);\r\n    nextStep();\r\n  };\r\n\r\n  const handleCredentialsSubmit = async (credentials) => {\r\n    setSetupData(credentials);\r\n    await testConnection(credentials);\r\n  };\r\n\r\n  const testConnection = async (credentials) => {\r\n    setIsLoading(true);\r\n    try {\r\n      const result = await whatsappConnectionService.verifyCredentials(\r\n        credentials.accessToken,\r\n        credentials.phoneNumberId\r\n      );\r\n\r\n      setConnectionTest(result);\r\n\r\n      if (result.success) {\r\n        // Guardar configuraci√≥n autom√°ticamente\r\n        await saveConfiguration(credentials, result.data);\r\n        nextStep();\r\n      }\r\n    } catch (error) {\r\n      setConnectionTest({\r\n        success: false,\r\n        message: `Error de conexi√≥n: ${error.message}`\r\n      });\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const saveConfiguration = async (credentials, connectionData) => {\r\n    try {\r\n      const configData = {\r\n        companyId: selectedCompany,\r\n        accessToken: credentials.accessToken,\r\n        phoneNumberId: credentials.phoneNumberId,\r\n        webhookVerifyToken: credentials.webhookVerifyToken,\r\n        testMode: credentials.testMode,\r\n        isDefault: true,\r\n        dailyLimit: 1000,\r\n        monthlyLimit: 30000\r\n      };\r\n\r\n      const result = await communicationService.configureWhatsAppForCompany(\r\n        selectedCompany,\r\n        configData\r\n      );\r\n\r\n      if (result.success) {\r\n        // Recargar configuraciones\r\n        const configsResult = await communicationService.getAllWhatsAppConfigurations();\r\n        if (configsResult.success) {\r\n          setConfigurations(configsResult.configurations);\r\n        }\r\n      }\r\n\r\n      return result;\r\n    } catch (error) {\r\n      console.error('Error guardando configuraci√≥n:', error);\r\n      throw error;\r\n    }\r\n  };\r\n\r\n  const renderStepIndicator = () => (\r\n    <div className=\"mb-8\">\r\n      <div className=\"flex items-center justify-between max-w-4xl mx-auto\">\r\n        {steps.map((step, index) => {\r\n          const Icon = step.icon;\r\n          const isCompleted = completedSteps.has(index);\r\n          const isCurrent = currentStep === index;\r\n          const isAccessible = index <= currentStep || isCompleted;\r\n\r\n          return (\r\n            <div key={step.id} className=\"flex items-center\">\r\n              <button\r\n                onClick={() => isAccessible && goToStep(index)}\r\n                disabled={!isAccessible}\r\n                className={`flex flex-col items-center p-3 rounded-lg transition-all ${\r\n                  isCurrent\r\n                    ? 'bg-blue-600 text-white shadow-lg'\r\n                    : isCompleted\r\n                    ? 'bg-green-600 text-white'\r\n                    : isAccessible\r\n                    ? 'bg-gray-100 text-gray-600 hover:bg-gray-200'\r\n                    : 'bg-gray-50 text-gray-400 cursor-not-allowed'\r\n                }`}\r\n              >\r\n                <Icon className=\"w-6 h-6 mb-1\" />\r\n                <span className=\"text-xs font-medium text-center leading-tight\">\r\n                  {step.title.split(' ')[0]}\r\n                </span>\r\n              </button>\r\n              {index < steps.length - 1 && (\r\n                <div className={`flex-1 h-0.5 mx-2 ${\r\n                  isCompleted ? 'bg-green-600' : 'bg-gray-200'\r\n                }`} />\r\n              )}\r\n            </div>\r\n          );\r\n        })}\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  const renderCurrentStep = () => {\r\n    const StepComponent = steps[currentStep].component;\r\n    return (\r\n      <StepComponent\r\n        userProfile={userProfile}\r\n        companies={companies}\r\n        configurations={configurations}\r\n        selectedCompany={selectedCompany}\r\n        setupData={setupData}\r\n        connectionTest={connectionTest}\r\n        isLoading={isLoading}\r\n        onCompanySelect={handleCompanySelect}\r\n        onCredentialsSubmit={handleCredentialsSubmit}\r\n        onNext={nextStep}\r\n        onPrev={prevStep}\r\n        onRetry={() => testConnection(setupData)}\r\n      />\r\n    );\r\n  };\r\n\r\n  if (isLoading && !userProfile) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4\"></div>\r\n          <p className=\"text-gray-600\">Preparando tu experiencia de WhatsApp...</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100\">\r\n      {/* Header */}\r\n      <div className=\"bg-white shadow-sm border-b border-gray-200\">\r\n        <div className=\"max-w-6xl mx-auto px-4 py-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center space-x-3\">\r\n              <div className=\"bg-green-600 p-2 rounded-lg\">\r\n                <ChatBubbleLeftRightIcon className=\"w-6 h-6 text-white\" />\r\n              </div>\r\n              <div>\r\n                <h1 className=\"text-xl font-bold text-gray-900\">StaffHub WhatsApp</h1>\r\n                <p className=\"text-sm text-gray-600\">Configuraci√≥n guiada paso a paso</p>\r\n              </div>\r\n            </div>\r\n\r\n            <button\r\n              onClick={() => setShowHelp(!showHelp)}\r\n              className=\"flex items-center space-x-2 px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-lg\"\r\n            >\r\n              <QuestionMarkCircleIcon className=\"w-4 h-4\" />\r\n              <span>Ayuda</span>\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Help Panel */}\r\n      {showHelp && (\r\n        <div className=\"bg-blue-50 border-b border-blue-200\">\r\n          <div className=\"max-w-6xl mx-auto px-4 py-4\">\r\n            <div className=\"flex items-start space-x-3\">\r\n              <LightBulbIcon className=\"w-5 h-5 text-blue-600 mt-0.5\" />\r\n              <div className=\"flex-1\">\r\n                <h3 className=\"font-medium text-blue-900 mb-2\">¬øNecesitas ayuda?</h3>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-blue-800\">\r\n                  <div>\r\n                    <strong>¬øQu√© necesito?</strong><br />\r\n                    Una cuenta de WhatsApp Business y acceso a Meta Developers\r\n                  </div>\r\n                  <div>\r\n                    <strong>¬øCu√°nto cuesta?</strong><br />\r\n                    Solo los costos de WhatsApp Business (aprox. $0.005 por mensaje)\r\n                  </div>\r\n                  <div>\r\n                    <strong>¬øCu√°nto tarda?</strong><br />\r\n                    10-15 minutos para configurar completamente\r\n                  </div>\r\n                </div>\r\n              </div>\r\n              <button\r\n                onClick={() => setShowHelp(false)}\r\n                className=\"text-blue-600 hover:text-blue-800\"\r\n              >\r\n                ‚úï\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Main Content */}\r\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\r\n        {renderStepIndicator()}\r\n\r\n        <div className=\"bg-white rounded-xl shadow-lg p-8\">\r\n          {renderCurrentStep()}\r\n        </div>\r\n\r\n        {/* Navigation */}\r\n        <div className=\"flex justify-between mt-8\">\r\n          <button\r\n            onClick={prevStep}\r\n            disabled={currentStep === 0}\r\n            className=\"flex items-center px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n          >\r\n            <ArrowLeftIcon className=\"w-4 h-4 mr-2\" />\r\n            Anterior\r\n          </button>\r\n\r\n          {currentStep < steps.length - 1 && (\r\n            <button\r\n              onClick={nextStep}\r\n              className=\"flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700\"\r\n            >\r\n              Siguiente\r\n              <ArrowRightIcon className=\"w-4 h-4 ml-2\" />\r\n            </button>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\n// Componentes de pasos individuales\r\n\r\nconst WelcomeStep = ({ onNext }) => (\r\n  <div className=\"text-center space-y-6\">\r\n    <div className=\"mx-auto w-24 h-24 bg-green-100 rounded-full flex items-center justify-center\">\r\n      <ChatBubbleLeftRightIcon className=\"w-12 h-12 text-green-600\" />\r\n    </div>\r\n\r\n    <div>\r\n      <h2 className=\"text-3xl font-bold text-gray-900 mb-4\">\r\n        ¬°Hola! Vamos a configurar WhatsApp Business\r\n      </h2>\r\n      <p className=\"text-lg text-gray-600 mb-6\">\r\n        Te voy a guiar paso a paso para que tengas WhatsApp funcionando en menos de 15 minutos.\r\n        No necesitas saber nada t√©cnico, yo me encargo de todo.\r\n      </p>\r\n    </div>\r\n\r\n    <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-6\">\r\n      <div className=\"flex items-start space-x-3\">\r\n        <CheckCircleSolid className=\"w-5 h-5 text-blue-600 mt-0.5\" />\r\n        <div className=\"text-left\">\r\n          <h3 className=\"font-medium text-blue-900 mb-2\">¬øQu√© vamos a hacer?</h3>\r\n          <ul className=\"text-sm text-blue-800 space-y-1\">\r\n            <li>‚Ä¢ Configurar tu cuenta de Meta Developers</li>\r\n            <li>‚Ä¢ Obtener las credenciales de WhatsApp</li>\r\n            <li>‚Ä¢ Probar que todo funcione correctamente</li>\r\n            <li>‚Ä¢ ¬°Listo! Podr√°s enviar mensajes desde StaffHub</li>\r\n          </ul>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <div className=\"flex justify-center\">\r\n      <button\r\n        onClick={onNext}\r\n        className=\"flex items-center px-8 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 text-lg font-medium\"\r\n      >\r\n        <PlayIcon className=\"w-5 h-5 mr-2\" />\r\n        ¬°Comenzar configuraci√≥n!\r\n      </button>\r\n    </div>\r\n  </div>\r\n);\r\n\r\nconst CheckExistingStep = ({ configurations, onNext }) => (\r\n  <div className=\"text-center space-y-6\">\r\n    <div className=\"mx-auto w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center\">\r\n      <CogIcon className=\"w-12 h-12 text-blue-600\" />\r\n    </div>\r\n\r\n    <div>\r\n      <h2 className=\"text-2xl font-bold text-gray-900 mb-4\">\r\n        Verificando tu configuraci√≥n actual\r\n      </h2>\r\n      <p className=\"text-gray-600\">\r\n        D√©jame revisar si ya tienes WhatsApp configurado...\r\n      </p>\r\n    </div>\r\n\r\n    {configurations && configurations.length > 0 ? (\r\n      <div className=\"bg-green-50 border border-green-200 rounded-lg p-6\">\r\n        <div className=\"flex items-center justify-center space-x-3 mb-4\">\r\n          <CheckCircleSolid className=\"w-8 h-8 text-green-600\" />\r\n          <span className=\"text-lg font-medium text-green-800\">\r\n            ¬°Ya tienes WhatsApp configurado!\r\n          </span>\r\n        </div>\r\n        <p className=\"text-green-700 mb-4\">\r\n          Tienes {configurations.length} configuraci√≥n(es) activa(s).\r\n          Puedes gestionarlas desde el panel principal.\r\n        </p>\r\n        <button\r\n          onClick={() => window.location.href = '/whatsapp/multi-manager'}\r\n          className=\"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700\"\r\n        >\r\n          Ir al panel de gesti√≥n\r\n        </button>\r\n      </div>\r\n    ) : (\r\n      <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-6\">\r\n        <div className=\"flex items-center justify-center space-x-3 mb-4\">\r\n          <ExclamationTriangleIcon className=\"w-8 h-8 text-yellow-600\" />\r\n          <span className=\"text-lg font-medium text-yellow-800\">\r\n            No tienes WhatsApp configurado\r\n          </span>\r\n        </div>\r\n        <p className=\"text-yellow-700 mb-4\">\r\n          No hay problema, te voy a guiar paso a paso para configurarlo.\r\n        </p>\r\n        <button\r\n          onClick={onNext}\r\n          className=\"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700\"\r\n        >\r\n          Continuar con la configuraci√≥n\r\n        </button>\r\n      </div>\r\n    )}\r\n  </div>\r\n);\r\n\r\nconst SelectCompanyStep = ({ companies, onCompanySelect }) => (\r\n  <div className=\"space-y-6\">\r\n    <div className=\"text-center\">\r\n      <div className=\"mx-auto w-24 h-24 bg-purple-100 rounded-full flex items-center justify-center mb-6\">\r\n        <UserGroupIcon className=\"w-12 h-12 text-purple-600\" />\r\n      </div>\r\n      <h2 className=\"text-2xl font-bold text-gray-900 mb-4\">\r\n        Selecciona la empresa para WhatsApp\r\n      </h2>\r\n      <p className=\"text-gray-600\">\r\n        Elige la empresa que estar√° conectada a este n√∫mero de WhatsApp\r\n      </p>\r\n    </div>\r\n\r\n    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n      {companies.map((company) => (\r\n        <button\r\n          key={company.id}\r\n          onClick={() => onCompanySelect(company.id)}\r\n          className=\"p-6 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 transition-all text-left\"\r\n        >\r\n          <div className=\"flex items-center space-x-3\">\r\n            <div className=\"w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center\">\r\n              <span className=\"text-blue-600 font-semibold\">\r\n                {company.name.charAt(0).toUpperCase()}\r\n              </span>\r\n            </div>\r\n            <div>\r\n              <h3 className=\"font-medium text-gray-900\">{company.name}</h3>\r\n              <p className=\"text-sm text-gray-600\">\r\n                {company.description || 'Empresa configurada en StaffHub'}\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </button>\r\n      ))}\r\n    </div>\r\n\r\n    {companies.length === 0 && (\r\n      <div className=\"text-center py-8\">\r\n        <ExclamationTriangleIcon className=\"w-12 h-12 text-yellow-500 mx-auto mb-4\" />\r\n        <h3 className=\"text-lg font-medium text-gray-900 mb-2\">\r\n          No tienes empresas configuradas\r\n        </h3>\r\n        <p className=\"text-gray-600 mb-4\">\r\n          Necesitas tener al menos una empresa para configurar WhatsApp.\r\n        </p>\r\n        <button\r\n          onClick={() => window.location.href = '/configuracion/empresas'}\r\n          className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700\"\r\n        >\r\n          Ir a configuraci√≥n de empresas\r\n        </button>\r\n      </div>\r\n    )}\r\n  </div>\r\n);\r\n\r\nconst MetaSetupStep = ({ onNext }) => {\r\n  const [currentSubStep, setCurrentSubStep] = useState(0);\r\n\r\n  const subSteps = [\r\n    {\r\n      title: 'Crear cuenta en Meta Developers',\r\n      description: 'Ve a developers.facebook.com y crea una cuenta con tu perfil de Facebook Business',\r\n      action: 'Ir a Meta Developers',\r\n      url: 'https://developers.facebook.com',\r\n      tips: [\r\n        'Usa una cuenta de Facebook Business Manager',\r\n        'Si no tienes, crea una cuenta gratuita',\r\n        'Verifica tu identidad si es necesario'\r\n      ]\r\n    },\r\n    {\r\n      title: 'Crear nueva aplicaci√≥n',\r\n      description: 'Haz clic en \"Mis Aplicaciones\" ‚Üí \"Crear Aplicaci√≥n\" ‚Üí \"Negocio\"',\r\n      action: 'Ver instrucciones',\r\n      tips: [\r\n        'Selecciona \"Negocio\" como tipo de aplicaci√≥n',\r\n        'Pon un nombre descriptivo como \"StaffHub WhatsApp\"',\r\n        'Asocia tu cuenta de Business Manager'\r\n      ]\r\n    },\r\n    {\r\n      title: 'Configurar WhatsApp',\r\n      description: 'En el panel de la aplicaci√≥n, busca \"WhatsApp\" y haz clic en \"Configurar\"',\r\n      action: 'Ver pasos detallados',\r\n      tips: [\r\n        'Busca \"WhatsApp\" en la lista de productos',\r\n        'Haz clic en \"Configurar\" o \"Set up\"',\r\n        'Sigue el asistente de configuraci√≥n'\r\n      ]\r\n    },\r\n    {\r\n      title: 'Obtener credenciales',\r\n      description: 'Una vez configurado, obt√©n tu Access Token permanente y Phone Number ID',\r\n      action: 'Continuar',\r\n      tips: [\r\n        'Ve a WhatsApp ‚Üí Configuraci√≥n',\r\n        'Copia el \"Access Token permanente\"',\r\n        'Anota el \"Phone Number ID\"'\r\n      ]\r\n    }\r\n  ];\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"text-center\">\r\n        <div className=\"mx-auto w-24 h-24 bg-orange-100 rounded-full flex items-center justify-center mb-6\">\r\n          <GlobeAltIcon className=\"w-12 h-12 text-orange-600\" />\r\n        </div>\r\n        <h2 className=\"text-2xl font-bold text-gray-900 mb-4\">\r\n          Paso {currentSubStep + 1}: {subSteps[currentSubStep].title}\r\n        </h2>\r\n        <p className=\"text-gray-600\">\r\n          {subSteps[currentSubStep].description}\r\n        </p>\r\n      </div>\r\n\r\n      <div className=\"bg-gray-50 border border-gray-200 rounded-lg p-6\">\r\n        <h3 className=\"font-medium text-gray-900 mb-3\">üí° Consejos para este paso:</h3>\r\n        <ul className=\"space-y-2\">\r\n          {subSteps[currentSubStep].tips.map((tip, index) => (\r\n            <li key={index} className=\"flex items-start space-x-2\">\r\n              <CheckCircleSolid className=\"w-4 h-4 text-green-600 mt-0.5 flex-shrink-0\" />\r\n              <span className=\"text-sm text-gray-700\">{tip}</span>\r\n            </li>\r\n          ))}\r\n        </ul>\r\n      </div>\r\n\r\n      {subSteps[currentSubStep].url && (\r\n        <div className=\"text-center\">\r\n          <a\r\n            href={subSteps[currentSubStep].url}\r\n            target=\"_blank\"\r\n            rel=\"noopener noreferrer\"\r\n            className=\"inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700\"\r\n          >\r\n            <GlobeAltIcon className=\"w-4 h-4 mr-2\" />\r\n            {subSteps[currentSubStep].action}\r\n          </a>\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"flex justify-between\">\r\n        <button\r\n          onClick={() => setCurrentSubStep(Math.max(0, currentSubStep - 1))}\r\n          disabled={currentSubStep === 0}\r\n          className=\"px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 disabled:opacity-50\"\r\n        >\r\n          Anterior\r\n        </button>\r\n\r\n        <div className=\"flex space-x-2\">\r\n          {subSteps.map((_, index) => (\r\n            <div\r\n              key={index}\r\n              className={`w-3 h-3 rounded-full ${\r\n                index === currentSubStep ? 'bg-blue-600' : 'bg-gray-300'\r\n              }`}\r\n            />\r\n          ))}\r\n        </div>\r\n\r\n        <button\r\n          onClick={() => {\r\n            if (currentSubStep < subSteps.length - 1) {\r\n              setCurrentSubStep(currentSubStep + 1);\r\n            } else {\r\n              onNext();\r\n            }\r\n          }}\r\n          className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700\"\r\n        >\r\n          {currentSubStep < subSteps.length - 1 ? 'Siguiente' : 'Listo, continuar'}\r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst CredentialsStep = ({ setupData, onCredentialsSubmit, isLoading }) => {\r\n  const [formData, setFormData] = useState(setupData);\r\n\r\n  const handleSubmit = (e) => {\r\n    e.preventDefault();\r\n    onCredentialsSubmit(formData);\r\n  };\r\n\r\n  const generateWebhookToken = () => {\r\n    const token = 'whatsapp_' + Math.random().toString(36).substr(2, 16);\r\n    setFormData({ ...formData, webhookVerifyToken: token });\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"text-center\">\r\n        <div className=\"mx-auto w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6\">\r\n          <KeyIcon className=\"w-12 h-12 text-green-600\" />\r\n        </div>\r\n        <h2 className=\"text-2xl font-bold text-gray-900 mb-4\">\r\n          Ingresa tus credenciales de WhatsApp\r\n        </h2>\r\n        <p className=\"text-gray-600\">\r\n          Copia y pega la informaci√≥n desde tu panel de Meta Developers\r\n        </p>\r\n      </div>\r\n\r\n      <form onSubmit={handleSubmit} className=\"max-w-md mx-auto space-y-4\">\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n            Access Token (Token de Acceso Permanente)\r\n          </label>\r\n          <input\r\n            type=\"text\"\r\n            value={formData.accessToken}\r\n            onChange={(e) => setFormData({ ...formData, accessToken: e.target.value })}\r\n            placeholder=\"EAAZA...\"\r\n            className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n            required\r\n          />\r\n          <p className=\"text-xs text-gray-500 mt-1\">\r\n            Lo encuentras en WhatsApp ‚Üí Configuraci√≥n ‚Üí Token de acceso permanente\r\n          </p>\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n            Phone Number ID\r\n          </label>\r\n          <input\r\n            type=\"text\"\r\n            value={formData.phoneNumberId}\r\n            onChange={(e) => setFormData({ ...formData, phoneNumberId: e.target.value })}\r\n            placeholder=\"1234567890123456...\"\r\n            className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n            required\r\n          />\r\n          <p className=\"text-xs text-gray-500 mt-1\">\r\n            Lo encuentras en WhatsApp ‚Üí Configuraci√≥n ‚Üí N√∫mero de tel√©fono\r\n          </p>\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n            Webhook Verify Token (Opcional)\r\n          </label>\r\n          <div className=\"flex space-x-2\">\r\n            <input\r\n              type=\"text\"\r\n              value={formData.webhookVerifyToken}\r\n              onChange={(e) => setFormData({ ...formData, webhookVerifyToken: e.target.value })}\r\n              placeholder=\"whatsapp_token_secreto_123\"\r\n              className=\"flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n            />\r\n            <button\r\n              type=\"button\"\r\n              onClick={generateWebhookToken}\r\n              className=\"px-4 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700\"\r\n            >\r\n              Generar\r\n            </button>\r\n          </div>\r\n          <p className=\"text-xs text-gray-500 mt-1\">\r\n            Token √∫nico para verificar webhooks. Puedes generar uno autom√°ticamente.\r\n          </p>\r\n        </div>\r\n\r\n        <div className=\"flex items-center\">\r\n          <input\r\n            type=\"checkbox\"\r\n            id=\"testMode\"\r\n            checked={formData.testMode}\r\n            onChange={(e) => setFormData({ ...formData, testMode: e.target.checked })}\r\n            className=\"rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50\"\r\n          />\r\n          <label htmlFor=\"testMode\" className=\"ml-2 text-sm text-gray-700\">\r\n            Iniciar en modo prueba (sin costos de mensajes)\r\n          </label>\r\n        </div>\r\n\r\n        <button\r\n          type=\"submit\"\r\n          disabled={isLoading}\r\n          className=\"w-full flex items-center justify-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50\"\r\n        >\r\n          {isLoading ? (\r\n            <>\r\n              <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2\"></div>\r\n              Verificando credenciales...\r\n            </>\r\n          ) : (\r\n            <>\r\n              <ShieldCheckIcon className=\"w-4 h-4 mr-2\" />\r\n              Verificar y guardar configuraci√≥n\r\n            </>\r\n          )}\r\n        </button>\r\n      </form>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst TestConnectionStep = ({ connectionTest, isLoading, onRetry }) => (\r\n  <div className=\"text-center space-y-6\">\r\n    <div className=\"mx-auto w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center\">\r\n      <ShieldCheckIcon className=\"w-12 h-12 text-blue-600\" />\r\n    </div>\r\n\r\n    <div>\r\n      <h2 className=\"text-2xl font-bold text-gray-900 mb-4\">\r\n        Probando tu conexi√≥n con WhatsApp\r\n      </h2>\r\n      <p className=\"text-gray-600\">\r\n        Estamos verificando que todo funcione correctamente...\r\n      </p>\r\n    </div>\r\n\r\n    {isLoading ? (\r\n      <div className=\"flex items-center justify-center space-x-3 py-8\">\r\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600\"></div>\r\n        <span className=\"text-gray-600\">Verificando conexi√≥n...</span>\r\n      </div>\r\n    ) : connectionTest ? (\r\n      <div className={`rounded-lg p-6 ${\r\n        connectionTest.success\r\n          ? 'bg-green-50 border border-green-200'\r\n          : 'bg-red-50 border border-red-200'\r\n      }`}>\r\n        <div className=\"flex items-center justify-center space-x-3 mb-4\">\r\n          {connectionTest.success ? (\r\n            <CheckCircleSolid className=\"w-8 h-8 text-green-600\" />\r\n          ) : (\r\n            <ExclamationTriangleIcon className=\"w-8 h-8 text-red-600\" />\r\n          )}\r\n          <h3 className={`text-lg font-semibold ${\r\n            connectionTest.success ? 'text-green-800' : 'text-red-800'\r\n          }`}>\r\n            {connectionTest.success ? '¬°Conexi√≥n exitosa!' : 'Error de conexi√≥n'}\r\n          </h3>\r\n        </div>\r\n\r\n        <p className={`text-sm mb-4 ${\r\n          connectionTest.success ? 'text-green-700' : 'text-red-700'\r\n        }`}>\r\n          {connectionTest.message}\r\n        </p>\r\n\r\n        {connectionTest.success && connectionTest.data && (\r\n          <div className=\"text-left bg-white rounded p-4 mb-4\">\r\n            <h4 className=\"font-medium text-gray-900 mb-2\">Informaci√≥n verificada:</h4>\r\n            <div className=\"text-sm text-gray-600 space-y-1\">\r\n              <div><strong>Nombre verificado:</strong> {connectionTest.data.phoneNumber?.verified_name || 'N/A'}</div>\r\n              <div><strong>Calidad:</strong> {connectionTest.data.phoneNumber?.quality_rating || 'N/A'}</div>\r\n              <div><strong>Estado del webhook:</strong> {connectionTest.data.webhookStatus || 'No configurado'}</div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {!connectionTest.success && (\r\n          <div className=\"space-y-3\">\r\n            <p className=\"text-sm text-red-700\">\r\n              Revisa tus credenciales e intenta nuevamente.\r\n            </p>\r\n            <button\r\n              onClick={onRetry}\r\n              className=\"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700\"\r\n            >\r\n              Reintentar verificaci√≥n\r\n            </button>\r\n          </div>\r\n        )}\r\n      </div>\r\n    ) : null}\r\n  </div>\r\n);\r\n\r\nconst SuccessStep = ({ configurations }) => (\r\n  <div className=\"text-center space-y-6\">\r\n    <div className=\"mx-auto w-24 h-24 bg-green-100 rounded-full flex items-center justify-center\">\r\n      <CheckCircleSolid className=\"w-12 h-12 text-green-600\" />\r\n    </div>\r\n\r\n    <div>\r\n      <h2 className=\"text-3xl font-bold text-gray-900 mb-4\">\r\n        ¬°Felicitaciones! WhatsApp est√° configurado\r\n      </h2>\r\n      <p className=\"text-lg text-gray-600 mb-6\">\r\n        Tu WhatsApp Business est√° listo para usar. Ahora puedes enviar mensajes desde StaffHub.\r\n      </p>\r\n    </div>\r\n\r\n    <div className=\"bg-green-50 border border-green-200 rounded-lg p-6\">\r\n      <h3 className=\"font-medium text-green-900 mb-3\">‚úÖ ¬øQu√© puedes hacer ahora?</h3>\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-green-800\">\r\n        <div className=\"flex items-center space-x-2\">\r\n          <CheckCircleSolid className=\"w-4 h-4\" />\r\n          <span>Enviar mensajes individuales</span>\r\n        </div>\r\n        <div className=\"flex items-center space-x-2\">\r\n          <CheckCircleSolid className=\"w-4 h-4\" />\r\n          <span>Campa√±as masivas con colas inteligentes</span>\r\n        </div>\r\n        <div className=\"flex items-center space-x-2\">\r\n          <CheckCircleSolid className=\"w-4 h-4\" />\r\n          <span>Respuestas autom√°ticas con IA</span>\r\n        </div>\r\n        <div className=\"flex items-center space-x-2\">\r\n          <CheckCircleSolid className=\"w-4 h-4\" />\r\n          <span>Estad√≠sticas y reportes detallados</span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <div className=\"flex flex-col sm:flex-row gap-4 justify-center\">\r\n      <button\r\n        onClick={() => window.location.href = '/communication'}\r\n        className=\"flex items-center justify-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700\"\r\n      >\r\n        <ChatBubbleLeftRightIcon className=\"w-4 h-4 mr-2\" />\r\n        Ir a enviar mensajes\r\n      </button>\r\n\r\n      <button\r\n        onClick={() => window.location.href = '/whatsapp/multi-manager'}\r\n        className=\"flex items-center justify-center px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50\"\r\n      >\r\n        <CogIcon className=\"w-4 h-4 mr-2\" />\r\n        Gestionar configuraciones\r\n      </button>\r\n\r\n      <button\r\n        onClick={() => window.location.href = '/panel-principal'}\r\n        className=\"flex items-center justify-center px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50\"\r\n      >\r\n        <ChartBarIcon className=\"w-4 h-4 mr-2\" />\r\n        Volver al panel principal\r\n      </button>\r\n    </div>\r\n\r\n    <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-4\">\r\n      <div className=\"flex items-start space-x-3\">\r\n        <QuestionMarkCircleIcon className=\"w-5 h-5 text-blue-600 mt-0.5\" />\r\n        <div className=\"text-left text-sm text-blue-800\">\r\n          <strong>¬øNecesitas ayuda?</strong><br />\r\n          Si tienes problemas o preguntas, puedes contactar al soporte t√©cnico.\r\n          Tambi√©n puedes revisar la documentaci√≥n completa en cualquier momento.\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n);\r\n\r\nexport default WhatsAppOnboarding;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\components\\whatsapp\\WhatsAppSetupWizard.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'CogIcon' is defined but never used.","line":15,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":10}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Asistente de Configuraci√≥n de WhatsApp Business\r\n * \r\n * Este componente proporciona una interfaz paso a paso para que los usuarios\r\n * sin conocimientos t√©cnicos puedan conectar su WhatsApp Business f√°cilmente.\r\n */\r\n\r\nimport React, { useState } from 'react';\r\nimport { \r\n  CheckCircleIcon, \r\n  ExclamationTriangleIcon,\r\n  ArrowRightIcon,\r\n  ArrowLeftIcon,\r\n  PhoneIcon,\r\n  CogIcon,\r\n  KeyIcon,\r\n  GlobeAltIcon,\r\n  ShieldCheckIcon,\r\n  QuestionMarkCircleIcon\r\n} from '@heroicons/react/24/outline';\r\nimport communicationService from '../../services/communicationService.js';\r\nimport whatsappConnectionService from '../../services/whatsappConnectionService.js';\r\n\r\nconst WhatsAppSetupWizard = () => {\r\n  const [currentStep, setCurrentStep] = useState(1);\r\n  const [selectedCompany, setSelectedCompany] = useState('');\r\n  const [companies, setCompanies] = useState([]);\r\n  const [setupData, setSetupData] = useState({\r\n    accessToken: '',\r\n    phoneNumberId: '',\r\n    webhookVerifyToken: '',\r\n    testMode: true\r\n  });\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [connectionTest, setConnectionTest] = useState(null);\r\n\r\n  const totalSteps = 5;\r\n\r\n  // Cargar empresas al montar\r\n  React.useEffect(() => {\r\n    loadCompanies();\r\n  }, []);\r\n\r\n  const loadCompanies = async () => {\r\n    try {\r\n      const result = await communicationService.getCompanies();\r\n      if (result) {\r\n        setCompanies(result);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error cargando empresas:', error);\r\n    }\r\n  };\r\n\r\n  const nextStep = () => {\r\n    if (currentStep < totalSteps) {\r\n      setCurrentStep(currentStep + 1);\r\n    }\r\n  };\r\n\r\n  const prevStep = () => {\r\n    if (currentStep > 1) {\r\n      setCurrentStep(currentStep - 1);\r\n    }\r\n  };\r\n\r\n  const testConnection = async () => {\r\n    setIsLoading(true);\r\n    try {\r\n      // Usar el servicio real de conexi√≥n para verificar credenciales\r\n      const result = await whatsappConnectionService.verifyCredentials(\r\n        setupData.accessToken,\r\n        setupData.phoneNumberId\r\n      );\r\n      \r\n      if (result.success) {\r\n        // Si las credenciales son v√°lidas, enviar un mensaje de prueba\r\n        const testResult = await whatsappConnectionService.sendTestMessage(\r\n          setupData.accessToken,\r\n          setupData.phoneNumberId\r\n        );\r\n        \r\n        setConnectionTest({\r\n          success: testResult.success,\r\n          message: testResult.success\r\n            ? '¬°Conexi√≥n exitosa! Mensaje de prueba enviado correctamente.'\r\n            : `Credenciales v√°lidas pero error enviando mensaje: ${testResult.message}`,\r\n          data: {\r\n            ...result.data,\r\n            testMessage: testResult.data\r\n          }\r\n        });\r\n      } else {\r\n        setConnectionTest(result);\r\n      }\r\n    } catch (error) {\r\n      setConnectionTest({\r\n        success: false,\r\n        message: `Error de conexi√≥n: ${error.message}`\r\n      });\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const saveConfiguration = async () => {\r\n    setIsLoading(true);\r\n    try {\r\n      const result = await communicationService.configureWhatsAppForCompany(\r\n        selectedCompany,\r\n        setupData\r\n      );\r\n      \r\n      if (result.success) {\r\n        alert('¬°WhatsApp configurado exitosamente!');\r\n        // Redirigir al gestor multi-WhatsApp\r\n        window.location.href = '/whatsapp/multi-manager';\r\n      } else {\r\n        alert(`Error: ${result.message}`);\r\n      }\r\n    } catch (error) {\r\n      alert('Error al guardar la configuraci√≥n');\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const renderStepIndicator = () => (\r\n    <div className=\"mb-8\">\r\n      <div className=\"flex items-center justify-between\">\r\n        {Array.from({ length: totalSteps }, (_, index) => (\r\n          <div key={index} className=\"flex items-center\">\r\n            <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium ${\r\n              currentStep > index + 1\r\n                ? 'bg-green-600 text-white'\r\n                : currentStep === index + 1\r\n                ? 'bg-blue-600 text-white'\r\n                : 'bg-gray-200 text-gray-600'\r\n            }`}>\r\n              {currentStep > index + 1 ? (\r\n                <CheckCircleIcon className=\"w-5 h-5\" />\r\n              ) : (\r\n                index + 1\r\n              )}\r\n            </div>\r\n            {index < totalSteps - 1 && (\r\n              <div className={`flex-1 h-1 mx-4 ${\r\n                currentStep > index + 1 ? 'bg-green-600' : 'bg-gray-200'\r\n              }`} />\r\n            )}\r\n          </div>\r\n        ))}\r\n      </div>\r\n      <div className=\"flex justify-between mt-2 text-xs text-gray-600\">\r\n        <span>Seleccionar Empresa</span>\r\n        <span>Meta Developers</span>\r\n        <span>Obtener Credenciales</span>\r\n        <span>Probar Conexi√≥n</span>\r\n        <span>Finalizar</span>\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  const renderStep1 = () => (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"text-center\">\r\n        <PhoneIcon className=\"w-16 h-16 mx-auto text-blue-600 mb-4\" />\r\n        <h2 className=\"text-2xl font-bold text-gray-900 mb-2\">\r\n          Selecciona tu Empresa\r\n        </h2>\r\n        <p className=\"text-gray-600\">\r\n          Elige la empresa que estar√° asociada a este n√∫mero de WhatsApp\r\n        </p>\r\n      </div>\r\n\r\n      <div className=\"max-w-md mx-auto\">\r\n        <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n          Empresa\r\n        </label>\r\n        <select\r\n          value={selectedCompany}\r\n          onChange={(e) => setSelectedCompany(e.target.value)}\r\n          className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n          required\r\n        >\r\n          <option value=\"\">Selecciona una empresa...</option>\r\n          {companies.map((company) => (\r\n            <option key={company.id} value={company.id}>\r\n              {company.name}\r\n            </option>\r\n          ))}\r\n        </select>\r\n      </div>\r\n\r\n      <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-4\">\r\n        <div className=\"flex items-start\">\r\n          <QuestionMarkCircleIcon className=\"w-5 h-5 text-blue-600 mt-0.5 mr-2\" />\r\n          <div className=\"text-sm text-blue-800\">\r\n            <strong>¬øNo ves tu empresa?</strong> Aseg√∫rate de que tienes permisos de administrador\r\n            para configurar WhatsApp Business.\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  const renderStep2 = () => (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"text-center\">\r\n        <GlobeAltIcon className=\"w-16 h-16 mx-auto text-blue-600 mb-4\" />\r\n        <h2 className=\"text-2xl font-bold text-gray-900 mb-2\">\r\n          Configura Meta Developers\r\n        </h2>\r\n        <p className=\"text-gray-600\">\r\n          Sigue estos pasos para obtener tus credenciales de WhatsApp Business API\r\n        </p>\r\n      </div>\r\n\r\n      <div className=\"bg-white border border-gray-200 rounded-lg p-6 space-y-4\">\r\n        <h3 className=\"font-semibold text-lg mb-4\">Pasos para configurar:</h3>\r\n        \r\n        <div className=\"space-y-4\">\r\n          <div className=\"flex items-start\">\r\n            <div className=\"flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-medium mr-3\">\r\n              1\r\n            </div>\r\n            <div>\r\n              <h4 className=\"font-medium\">Ve a Meta Developers</h4>\r\n              <p className=\"text-sm text-gray-600 mt-1\">\r\n                Visita{' '}\r\n                <a \r\n                  href=\"https://developers.facebook.com\" \r\n                  target=\"_blank\" \r\n                  rel=\"noopener noreferrer\"\r\n                  className=\"text-blue-600 hover:underline\"\r\n                >\r\n                  developers.facebook.com\r\n                </a>{' '}\r\n                e inicia sesi√≥n con tu cuenta de Facebook.\r\n              </p>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-start\">\r\n            <div className=\"flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-medium mr-3\">\r\n              2\r\n            </div>\r\n            <div>\r\n              <h4 className=\"font-medium\">Crea una nueva aplicaci√≥n</h4>\r\n              <p className=\"text-sm text-gray-600 mt-1\">\r\n                Haz clic en \"Mis Aplicaciones\" ‚Üí \"Crear Aplicaci√≥n\" ‚Üí \"Negocio\".\r\n              </p>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-start\">\r\n            <div className=\"flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-medium mr-3\">\r\n              3\r\n            </div>\r\n            <div>\r\n              <h4 className=\"font-medium\">Agrega WhatsApp</h4>\r\n              <p className=\"text-sm text-gray-600 mt-1\">\r\n                En el panel de la aplicaci√≥n, busca \"WhatsApp\" y haz clic en \"Configurar\".\r\n              </p>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-start\">\r\n            <div className=\"flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-medium mr-3\">\r\n              4\r\n            </div>\r\n            <div>\r\n              <h4 className=\"font-medium\">Selecciona o crea una cuenta de WhatsApp Business</h4>\r\n              <p className=\"text-sm text-gray-600 mt-1\">\r\n                Conecta tu n√∫mero de tel√©fono existente o crea uno nuevo.\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-4\">\r\n        <div className=\"flex items-start\">\r\n          <ExclamationTriangleIcon className=\"w-5 h-5 text-yellow-600 mt-0.5 mr-2\" />\r\n          <div className=\"text-sm text-yellow-800\">\r\n            <strong>Importante:</strong> Necesitar√°s una cuenta de WhatsApp Business verificada\r\n            para continuar con la configuraci√≥n.\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  const renderStep3 = () => (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"text-center\">\r\n        <KeyIcon className=\"w-16 h-16 mx-auto text-blue-600 mb-4\" />\r\n        <h2 className=\"text-2xl font-bold text-gray-900 mb-2\">\r\n          Obten tus Credenciales\r\n        </h2>\r\n        <p className=\"text-gray-600\">\r\n          Copia y pega las credenciales desde tu panel de Meta Developers\r\n        </p>\r\n      </div>\r\n\r\n      <div className=\"max-w-2xl mx-auto space-y-4\">\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n            Access Token (Token de Acceso Permanente)\r\n          </label>\r\n          <input\r\n            type=\"text\"\r\n            value={setupData.accessToken}\r\n            onChange={(e) => setSetupData({...setupData, accessToken: e.target.value})}\r\n            placeholder=\"EAAZA...\"\r\n            className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n            required\r\n          />\r\n          <p className=\"text-xs text-gray-500 mt-1\">\r\n            Encu√©ntralo en WhatsApp ‚Üí Configuraci√≥n ‚Üí Token de acceso permanente\r\n          </p>\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n            Phone Number ID\r\n          </label>\r\n          <input\r\n            type=\"text\"\r\n            value={setupData.phoneNumberId}\r\n            onChange={(e) => setSetupData({...setupData, phoneNumberId: e.target.value})}\r\n            placeholder=\"1234567890123456...\"\r\n            className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n            required\r\n          />\r\n          <p className=\"text-xs text-gray-500 mt-1\">\r\n            Encu√©ntralo en WhatsApp ‚Üí Configuraci√≥n ‚Üí N√∫mero de tel√©fono\r\n          </p>\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n            Webhook Verify Token (Opcional)\r\n          </label>\r\n          <input\r\n            type=\"text\"\r\n            value={setupData.webhookVerifyToken}\r\n            onChange={(e) => setSetupData({...setupData, webhookVerifyToken: e.target.value})}\r\n            placeholder=\"token_secreto_personalizado\"\r\n            className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n          />\r\n          <p className=\"text-xs text-gray-500 mt-1\">\r\n            Crea un token √∫nico para verificar webhooks. Puedes usar el generador de abajo.\r\n          </p>\r\n        </div>\r\n\r\n        <div className=\"bg-gray-50 border border-gray-200 rounded-lg p-4\">\r\n          <h4 className=\"font-medium mb-2\">Generador de Webhook Token:</h4>\r\n          <button\r\n            onClick={() => {\r\n              const token = 'whatsapp_' + Math.random().toString(36).substr(2, 16);\r\n              setSetupData({...setupData, webhookVerifyToken: token});\r\n            }}\r\n            className=\"px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm\"\r\n          >\r\n            Generar Token Autom√°tico\r\n          </button>\r\n        </div>\r\n\r\n        <div className=\"flex items-center\">\r\n          <input\r\n            type=\"checkbox\"\r\n            id=\"testMode\"\r\n            checked={setupData.testMode}\r\n            onChange={(e) => setSetupData({...setupData, testMode: e.target.checked})}\r\n            className=\"rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50\"\r\n          />\r\n          <label htmlFor=\"testMode\" className=\"ml-2 text-sm text-gray-700\">\r\n            Iniciar en modo prueba (sin costos de mensajes)\r\n          </label>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  const renderStep4 = () => (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"text-center\">\r\n        <ShieldCheckIcon className=\"w-16 h-16 mx-auto text-blue-600 mb-4\" />\r\n        <h2 className=\"text-2xl font-bold text-gray-900 mb-2\">\r\n          Prueba tu Conexi√≥n\r\n        </h2>\r\n        <p className=\"text-gray-600\">\r\n          Verificaremos que tus credenciales funcionen correctamente\r\n        </p>\r\n      </div>\r\n\r\n      <div className=\"max-w-md mx-auto\">\r\n        {!connectionTest ? (\r\n          <div className=\"text-center\">\r\n            <button\r\n              onClick={testConnection}\r\n              disabled={isLoading}\r\n              className=\"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50\"\r\n            >\r\n              {isLoading ? 'Probando...' : 'Probar Conexi√≥n'}\r\n            </button>\r\n            <p className=\"text-sm text-gray-500 mt-2\">\r\n              Esto puede tardar unos segundos\r\n            </p>\r\n          </div>\r\n        ) : (\r\n          <div className={`rounded-lg p-6 ${\r\n            connectionTest.success \r\n              ? 'bg-green-50 border border-green-200' \r\n              : 'bg-red-50 border border-red-200'\r\n          }`}>\r\n            <div className=\"flex items-center\">\r\n              {connectionTest.success ? (\r\n                <CheckCircleIcon className=\"w-8 h-8 text-green-600 mr-3\" />\r\n              ) : (\r\n                <ExclamationTriangleIcon className=\"w-8 h-8 text-red-600 mr-3\" />\r\n              )}\r\n              <div>\r\n                <h3 className={`font-semibold ${\r\n                  connectionTest.success ? 'text-green-800' : 'text-red-800'\r\n                }`}>\r\n                  {connectionTest.success ? '¬°Conexi√≥n Exitosa!' : 'Error de Conexi√≥n'}\r\n                </h3>\r\n                <p className={`text-sm mt-1 ${\r\n                  connectionTest.success ? 'text-green-700' : 'text-red-700'\r\n                }`}>\r\n                  {connectionTest.message}\r\n                </p>\r\n              </div>\r\n            </div>\r\n            \r\n            {!connectionTest.success && (\r\n              <button\r\n                onClick={testConnection}\r\n                disabled={isLoading}\r\n                className=\"mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 text-sm\"\r\n              >\r\n                Reintentar\r\n              </button>\r\n            )}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-4\">\r\n        <h4 className=\"font-medium text-blue-800 mb-2\">¬øQu√© estamos verificando?</h4>\r\n        <ul className=\"text-sm text-blue-700 space-y-1\">\r\n          <li>‚Ä¢ Validaci√≥n del Access Token</li>\r\n          <li>‚Ä¢ Conexi√≥n con la API de Meta</li>\r\n          <li>‚Ä¢ Estado del n√∫mero de tel√©fono</li>\r\n          <li>‚Ä¢ Permisos necesarios</li>\r\n        </ul>\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  const renderStep5 = () => (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"text-center\">\r\n        <CheckCircleIcon className=\"w-16 h-16 mx-auto text-green-600 mb-4\" />\r\n        <h2 className=\"text-2xl font-bold text-gray-900 mb-2\">\r\n          ¬°Todo Listo!\r\n        </h2>\r\n        <p className=\"text-gray-600\">\r\n          Revisa tu configuraci√≥n antes de finalizar\r\n        </p>\r\n      </div>\r\n\r\n      <div className=\"max-w-md mx-auto bg-gray-50 rounded-lg p-6\">\r\n        <h3 className=\"font-semibold mb-4\">Resumen de Configuraci√≥n:</h3>\r\n        <div className=\"space-y-2 text-sm\">\r\n          <div className=\"flex justify-between\">\r\n            <span className=\"text-gray-600\">Empresa:</span>\r\n            <span className=\"font-medium\">\r\n              {companies.find(c => c.id === selectedCompany)?.name || 'Seleccionada'}\r\n            </span>\r\n          </div>\r\n          <div className=\"flex justify-between\">\r\n            <span className=\"text-gray-600\">Phone Number ID:</span>\r\n            <span className=\"font-medium\">{setupData.phoneNumberId || 'Configurado'}</span>\r\n          </div>\r\n          <div className=\"flex justify-between\">\r\n            <span className=\"text-gray-600\">Modo:</span>\r\n            <span className=\"font-medium\">\r\n              {setupData.testMode ? 'Prueba' : 'Producci√≥n'}\r\n            </span>\r\n          </div>\r\n          <div className=\"flex justify-between\">\r\n            <span className=\"text-gray-600\">Estado:</span>\r\n            <span className=\"font-medium text-green-600\">\r\n              {connectionTest?.success ? 'Conectado' : 'Pendiente'}\r\n            </span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"text-center\">\r\n        <button\r\n          onClick={saveConfiguration}\r\n          disabled={isLoading}\r\n          className=\"px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 text-lg font-medium\"\r\n        >\r\n          {isLoading ? 'Guardando...' : 'Finalizar Configuraci√≥n'}\r\n        </button>\r\n        <p className=\"text-sm text-gray-500 mt-2\">\r\n          Tu WhatsApp Business quedar√° conectado y listo para usar\r\n        </p>\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  const renderCurrentStep = () => {\r\n    switch (currentStep) {\r\n      case 1: return renderStep1();\r\n      case 2: return renderStep2();\r\n      case 3: return renderStep3();\r\n      case 4: return renderStep4();\r\n      case 5: return renderStep5();\r\n      default: return renderStep1();\r\n    }\r\n  };\r\n\r\n  const canProceed = () => {\r\n    switch (currentStep) {\r\n      case 1: return selectedCompany !== '';\r\n      case 2: return true;\r\n      case 3: return setupData.accessToken && setupData.phoneNumberId;\r\n      case 4: return connectionTest?.success;\r\n      case 5: return true;\r\n      default: return false;\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gray-50 py-8\">\r\n      <div className=\"max-w-4xl mx-auto px-4\">\r\n        <div className=\"bg-white rounded-xl shadow-lg p-8\">\r\n          {renderStepIndicator()}\r\n          \r\n          <div className=\"min-h-[400px]\">\r\n            {renderCurrentStep()}\r\n          </div>\r\n\r\n          <div className=\"flex justify-between mt-8\">\r\n            <button\r\n              onClick={prevStep}\r\n              disabled={currentStep === 1}\r\n              className=\"flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50\"\r\n            >\r\n              <ArrowLeftIcon className=\"w-4 h-4 mr-2\" />\r\n              Anterior\r\n            </button>\r\n\r\n            <button\r\n              onClick={nextStep}\r\n              disabled={!canProceed() || currentStep === totalSteps}\r\n              className=\"flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50\"\r\n            >\r\n              {currentStep === totalSteps ? 'Finalizar' : 'Siguiente'}\r\n              <ArrowRightIcon className=\"w-4 h-4 ml-2\" />\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default WhatsAppSetupWizard;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\config\\codeSplitting.js","messages":[{"ruleId":"import/no-anonymous-default-export","severity":1,"message":"Assign object to a variable before exporting as module default","line":250,"column":1,"nodeType":"ExportDefaultDeclaration","endLine":255,"endColumn":3}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * CONFIGURACI√ìN DE CODE SPLITTING\r\n * \r\n * Implementa lazy loading para componentes pesados y reduce bundle size\r\n * Meta: Reducir de 1.09 MB a < 250 KB por chunk\r\n */\r\n\r\nimport React, { lazy, Suspense } from 'react';\r\nimport LoadingSpinner from '../components/common/LoadingSpinner';\r\n\r\n// ========================================\r\n// COMPONENTES PESADOS - Lazy Loading\r\n// ========================================\r\n\r\n// Dashboard Components\r\nexport const Dashboard = lazy(() => import('../components/dashboard/Dashboard'));\r\nexport const ModernAIEnhancedDashboard = lazy(() => import('../components/dashboard/ModernAIEnhancedDashboard'));\r\nexport const AnalyticsDashboard = lazy(() => import('../components/analytics/AnalyticsDashboard'));\r\nexport const DatabaseCompanySummary = lazy(() => import('../components/dashboard/DatabaseCompanySummary'));\r\n\r\n// Communication Components\r\nexport const WebrifyCommunicationDashboard = lazy(() => import('../components/communication/WebrifyCommunicationDashboard'));\r\nexport const EmployeeFolders = lazy(() => import('../components/communication/EmployeeFolders'));\r\nexport const EmployeeSelector = lazy(() => import('../components/communication/EmployeeSelector'));\r\nexport const ReportsDashboard = lazy(() => import('../components/communication/ReportsDashboard'));\r\nexport const BrevoStatisticsDashboard = lazy(() => import('../components/communication/BrevoStatisticsDashboard'));\r\nexport const BrevoTemplatesManager = lazy(() => import('../components/communication/BrevoTemplatesManager'));\r\n\r\n// Google Drive Components\r\nexport const GoogleDriveIntegrationSelector = lazy(() => import('../components/integrations/GoogleDriveIntegrationSelector'));\r\nexport const GoogleDriveSetupWizard = lazy(() => import('../components/integrations/GoogleDriveSetupWizard'));\r\nexport const UserGoogleDriveConnector = lazy(() => import('../components/integrations/UserGoogleDriveConnector'));\r\nexport const GoogleDriveSimplePage = lazy(() => import('../components/integrations/GoogleDriveSimplePage'));\r\n\r\n// AI & Embeddings Components\r\nexport const AIChat = lazy(() => import('../components/embeddings/AIChat'));\r\nexport const SemanticSearch = lazy(() => import('../components/embeddings/SemanticSearch'));\r\nexport const TokenUsage = lazy(() => import('../components/embeddings/TokenUsage'));\r\n\r\n// Settings Components\r\nexport const Settings = lazy(() => import('../components/settings/Settings'));\r\nexport const CompanyForm = lazy(() => import('../components/settings/CompanyForm'));\r\nexport const UserManagement = lazy(() => import('../components/settings/UserManagement'));\r\nexport const DatabaseSettings = lazy(() => import('../components/settings/DatabaseSettings'));\r\n\r\n// Test Components\r\nexport const CompanySyncTest = lazy(() => import('../components/test/CompanySyncTest'));\r\nexport const GoogleDriveConnectionVerifier = lazy(() => import('../components/test/GoogleDriveConnectionVerifier'));\r\nexport const GoogleDriveLocalTest = lazy(() => import('../components/test/GoogleDriveLocalTest'));\r\nexport const GoogleDriveProductionDiagnosis = lazy(() => import('../components/test/GoogleDriveProductionDiagnosis'));\r\n\r\n// ========================================\r\n// WRAPPER CON SUSPENSE\r\n// ========================================\r\n\r\n/**\r\n * Envuelve un componente lazy con Suspense y LoadingSpinner\r\n * @param {React.Component} LazyComponent - Componente lazy importado\r\n * @returns {React.Component} Componente envuelto con Suspense\r\n */\r\nexport const withSuspense = (LazyComponent) => {\r\n  return (props) => (\r\n    <Suspense fallback={<LoadingSpinner />}>\r\n      <LazyComponent {...props} />\r\n    </Suspense>\r\n  );\r\n};\r\n\r\n// ========================================\r\n// RUTAS CON CODE SPLITTING\r\n// ========================================\r\n\r\n/**\r\n * Configuraci√≥n de rutas con code splitting\r\n * Cada ruta carga su componente solo cuando se navega a ella\r\n */\r\nexport const routesWithCodeSplitting = [\r\n  {\r\n    path: '/dashboard',\r\n    component: withSuspense(Dashboard),\r\n    exact: true\r\n  },\r\n  {\r\n    path: '/dashboard/modern',\r\n    component: withSuspense(ModernAIEnhancedDashboard),\r\n    exact: true\r\n  },\r\n  {\r\n    path: '/analytics',\r\n    component: withSuspense(AnalyticsDashboard),\r\n    exact: true\r\n  },\r\n  {\r\n    path: '/communication',\r\n    component: withSuspense(WebrifyCommunicationDashboard),\r\n    exact: true\r\n  },\r\n  {\r\n    path: '/communication/employee-folders',\r\n    component: withSuspense(EmployeeFolders),\r\n    exact: true\r\n  },\r\n  {\r\n    path: '/communication/reports',\r\n    component: withSuspense(ReportsDashboard),\r\n    exact: true\r\n  },\r\n  {\r\n    path: '/communication/brevo',\r\n    component: withSuspense(BrevoStatisticsDashboard),\r\n    exact: true\r\n  },\r\n  {\r\n    path: '/integrations/google-drive',\r\n    component: withSuspense(GoogleDriveIntegrationSelector),\r\n    exact: true\r\n  },\r\n  {\r\n    path: '/integrations/google-drive/setup',\r\n    component: withSuspense(GoogleDriveSetupWizard),\r\n    exact: true\r\n  },\r\n  {\r\n    path: '/integrations/google-drive/connector',\r\n    component: withSuspense(UserGoogleDriveConnector),\r\n    exact: true\r\n  },\r\n  {\r\n    path: '/ai/chat',\r\n    component: withSuspense(AIChat),\r\n    exact: true\r\n  },\r\n  {\r\n    path: '/ai/search',\r\n    component: withSuspense(SemanticSearch),\r\n    exact: true\r\n  },\r\n  {\r\n    path: '/settings',\r\n    component: withSuspense(Settings),\r\n    exact: true\r\n  },\r\n  {\r\n    path: '/settings/companies',\r\n    component: withSuspense(CompanyForm),\r\n    exact: true\r\n  },\r\n  {\r\n    path: '/settings/users',\r\n    component: withSuspense(UserManagement),\r\n    exact: true\r\n  },\r\n  {\r\n    path: '/settings/database',\r\n    component: withSuspense(DatabaseSettings),\r\n    exact: true\r\n  },\r\n  {\r\n    path: '/test/company-sync',\r\n    component: withSuspense(CompanySyncTest),\r\n    exact: true\r\n  },\r\n  {\r\n    path: '/test/google-drive',\r\n    component: withSuspense(GoogleDriveConnectionVerifier),\r\n    exact: true\r\n  }\r\n];\r\n\r\n// ========================================\r\n// BUNDLE OPTIMIZATION CONFIG\r\n// ========================================\r\n\r\n/**\r\n * Configuraci√≥n para Webpack Bundle Analyzer\r\n * Identifica qu√© m√≥dulos est√°n contribuyendo al bundle size\r\n */\r\nexport const bundleOptimization = {\r\n  // Tama√±o m√°ximo por chunk (en KB)\r\n  maxChunkSize: 250,\r\n  \r\n  // Chunks a generar\r\n  chunks: {\r\n    vendor: {\r\n      // Librer√≠as de terceros\r\n      test: /[\\\\/]node_modules[\\\\/]/,\r\n      name: 'vendor',\r\n      chunks: 'all',\r\n      priority: 10\r\n    },\r\n    common: {\r\n      // C√≥digo com√∫n compartido\r\n      name: 'common',\r\n      minChunks: 2,\r\n      chunks: 'all',\r\n      priority: 5,\r\n      reuseExistingChunk: true\r\n    },\r\n    main: {\r\n      // C√≥digo principal de la aplicaci√≥n\r\n      name: 'main',\r\n      chunks: 'all',\r\n      priority: 1\r\n    }\r\n  },\r\n  \r\n  // Librer√≠as grandes que deben ser separadas\r\n  largeLibraries: [\r\n    'react',\r\n    'react-dom',\r\n    'react-router-dom',\r\n    '@supabase/supabase-js',\r\n    'pdfjs-dist',\r\n    'xlsx',\r\n    'mammoth',\r\n    'groq-sdk',\r\n    'brevo'\r\n  ]\r\n};\r\n\r\n// ========================================\r\n// PERFORMANCE BUDGET\r\n// ========================================\r\n\r\n/**\r\n * Presupuesto de performance para la aplicaci√≥n\r\n */\r\nexport const performanceBudget = {\r\n  // Tama√±o m√°ximo del bundle principal\r\n  maxMainBundleSize: 250 * 1024, // 250 KB\r\n  \r\n  // Tama√±o m√°ximo por chunk\r\n  maxChunkSize: 250 * 1024, // 250 KB\r\n  \r\n  // N√∫mero m√°ximo de chunks\r\n  maxChunks: 5,\r\n  \r\n  // Tiempo m√°ximo de carga inicial\r\n  maxInitialLoadTime: 3000, // 3 segundos\r\n  \r\n  // Lighthouse scores m√≠nimos\r\n  lighthouse: {\r\n    performance: 90,\r\n    accessibility: 95,\r\n    bestPractices: 95,\r\n    seo: 90\r\n  }\r\n};\r\n\r\nexport default {\r\n  routesWithCodeSplitting,\r\n  withSuspense,\r\n  bundleOptimization,\r\n  performanceBudget\r\n};","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\config\\constants.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\config\\errorHandlingConfig.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\contexts\\AuthContext.js","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadUserProfile'. Either include it or remove the dependency array.","line":529,"column":6,"nodeType":"ArrayExpression","endLine":529,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadUserProfile]","fix":{"range":[18895,18897],"text":"[loadUserProfile]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadUserProfile', 'loading', 'user', and 'userProfile'. Either include them or remove the dependency array.","line":604,"column":6,"nodeType":"ArrayExpression","endLine":604,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadUserProfile, loading, user, userProfile]","fix":{"range":[21731,21733],"text":"[loadUserProfile, loading, user, userProfile]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\hooks\\useAccessibility.js","messages":[{"ruleId":"default-case","severity":1,"message":"Expected a default case.","line":273,"column":7,"nodeType":"SwitchStatement","messageId":"missingDefaultCase","endLine":306,"endColumn":8},{"ruleId":"no-unused-vars","severity":1,"message":"'preferences' is assigned a value but never used.","line":424,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":424,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'releaseFocusTrap' is assigned a value but never used.","line":471,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":471,"endColumn":43},{"ruleId":"no-undef","severity":2,"message":"'React' is not defined.","line":516,"column":41,"nodeType":"Identifier","messageId":"undef","endLine":516,"endColumn":46}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useRef, useCallback } from 'react';\r\n\r\n/**\r\n * Hook personalizado para manejar accesibilidad en la aplicaci√≥n\r\n */\r\nexport const useAccessibility = () => {\r\n  const skipLinkRef = useRef(null);\r\n  const focusTrapRef = useRef(null);\r\n  const previousFocusRef = useRef(null);\r\n\r\n  /**\r\n   * Configurar skip links para navegaci√≥n por teclado\r\n   */\r\n  const setupSkipLinks = useCallback(() => {\r\n    // Crear skip link si no existe\r\n    if (!document.getElementById('skip-to-main')) {\r\n      const skipLink = document.createElement('a');\r\n      skipLink.id = 'skip-to-main';\r\n      skipLink.href = '#main-content';\r\n      skipLink.textContent = 'Saltar al contenido principal';\r\n      skipLink.className = 'skip-link';\r\n      skipLink.style.cssText = `\r\n        position: absolute;\r\n        top: -40px;\r\n        left: 6px;\r\n        background: #007bff;\r\n        color: white;\r\n        padding: 8px;\r\n        text-decoration: none;\r\n        border-radius: 4px;\r\n        z-index: 10000;\r\n        transition: top 0.3s;\r\n      `;\r\n      \r\n      skipLink.addEventListener('focus', () => {\r\n        skipLink.style.top = '6px';\r\n      });\r\n      \r\n      skipLink.addEventListener('blur', () => {\r\n        skipLink.style.top = '-40px';\r\n      });\r\n      \r\n      document.body.insertBefore(skipLink, document.body.firstChild);\r\n    }\r\n\r\n    // Crear skip link para navegaci√≥n si no existe\r\n    if (!document.getElementById('skip-to-navigation')) {\r\n      const navSkipLink = document.createElement('a');\r\n      navSkipLink.id = 'skip-to-navigation';\r\n      navSkipLink.href = '#main-navigation';\r\n      navSkipLink.textContent = 'Saltar a navegaci√≥n';\r\n      navSkipLink.className = 'skip-link';\r\n      navSkipLink.style.cssText = `\r\n        position: absolute;\r\n        top: -40px;\r\n        left: 200px;\r\n        background: #28a745;\r\n        color: white;\r\n        padding: 8px;\r\n        text-decoration: none;\r\n        border-radius: 4px;\r\n        z-index: 10000;\r\n        transition: top 0.3s;\r\n      `;\r\n      \r\n      navSkipLink.addEventListener('focus', () => {\r\n        navSkipLink.style.top = '6px';\r\n      });\r\n      \r\n      navSkipLink.addEventListener('blur', () => {\r\n        navSkipLink.style.top = '-40px';\r\n      });\r\n      \r\n      document.body.insertBefore(navSkipLink, document.body.firstChild);\r\n    }\r\n  }, []);\r\n\r\n  /**\r\n   * Configurar focus trap para modales y di√°logos\r\n   */\r\n  const setupFocusTrap = useCallback((element) => {\r\n    if (!element) return;\r\n\r\n    focusTrapRef.current = element;\r\n    \r\n    // Guardar el elemento enfocado actualmente\r\n    previousFocusRef.current = document.activeElement;\r\n    \r\n    // Enfocar primer elemento enfocable dentro del trap\r\n    const focusableElements = element.querySelectorAll(\r\n      'button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])'\r\n    );\r\n    \r\n    if (focusableElements.length > 0) {\r\n      focusableElements[0].focus();\r\n    }\r\n\r\n    // Manejar tecla Tab para mantener focus dentro del elemento\r\n    const handleKeyDown = (event) => {\r\n      if (event.key === 'Tab') {\r\n        const firstElement = focusableElements[0];\r\n        const lastElement = focusableElements[focusableElements.length - 1];\r\n\r\n        if (event.shiftKey) {\r\n          // Shift + Tab\r\n          if (document.activeElement === firstElement) {\r\n            event.preventDefault();\r\n            lastElement.focus();\r\n          }\r\n        } else {\r\n          // Tab\r\n          if (document.activeElement === lastElement) {\r\n            event.preventDefault();\r\n            firstElement.focus();\r\n          }\r\n        }\r\n      }\r\n      \r\n      if (event.key === 'Escape') {\r\n        // Disparar evento personalizado para manejar Escape\r\n        element.dispatchEvent(new CustomEvent('focusTrapEscape'));\r\n      }\r\n    };\r\n\r\n    element.addEventListener('keydown', handleKeyDown);\r\n    \r\n    // Retornar funci√≥n de limpieza\r\n    return () => {\r\n      element.removeEventListener('keydown', handleKeyDown);\r\n      if (previousFocusRef.current) {\r\n        previousFocusRef.current.focus();\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  /**\r\n   * Liberar focus trap\r\n   */\r\n  const releaseFocusTrap = useCallback(() => {\r\n    if (previousFocusRef.current) {\r\n      previousFocusRef.current.focus();\r\n      previousFocusRef.current = null;\r\n    }\r\n    focusTrapRef.current = null;\r\n  }, []);\r\n\r\n  /**\r\n   * Anunciar cambios para lectores de pantalla\r\n   */\r\n  const announceToScreenReader = useCallback((message, priority = 'polite') => {\r\n    const announcement = document.createElement('div');\r\n    announcement.setAttribute('aria-live', priority);\r\n    announcement.setAttribute('aria-atomic', 'true');\r\n    announcement.className = 'sr-only';\r\n    announcement.style.cssText = `\r\n      position: absolute;\r\n      width: 1px;\r\n      height: 1px;\r\n      padding: 0;\r\n      margin: -1px;\r\n      overflow: hidden;\r\n      clip: rect(0, 0, 0, 0);\r\n      white-space: nowrap;\r\n      border: 0;\r\n    `;\r\n    \r\n    announcement.textContent = message;\r\n    document.body.appendChild(announcement);\r\n    \r\n    // Remover despu√©s de un tiempo\r\n    setTimeout(() => {\r\n      document.body.removeChild(announcement);\r\n    }, 1000);\r\n  }, []);\r\n\r\n  /**\r\n   * Verificar contraste de colores\r\n   */\r\n  const checkContrast = useCallback((foreground, background) => {\r\n    // Funci√≥n para convertir hex a RGB\r\n    const hexToRgb = (hex) => {\r\n      const result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\r\n      return result ? {\r\n        r: parseInt(result[1], 16),\r\n        g: parseInt(result[2], 16),\r\n        b: parseInt(result[3], 16)\r\n      } : null;\r\n    };\r\n\r\n    // Funci√≥n para calcular luminancia relativa\r\n    const getLuminance = (rgb) => {\r\n      const rsRGB = rgb.r / 255;\r\n      const gsRGB = rgb.g / 255;\r\n      const bsRGB = rgb.b / 255;\r\n\r\n      const r = rsRGB <= 0.03928 ? rsRGB / 12.92 : Math.pow((rsRGB + 0.055) / 1.055, 2.4);\r\n      const g = gsRGB <= 0.03928 ? gsRGB / 12.92 : Math.pow((gsRGB + 0.055) / 1.055, 2.4);\r\n      const b = bsRGB <= 0.03928 ? bsRGB / 12.92 : Math.pow((bsRGB + 0.055) / 1.055, 2.4);\r\n\r\n      return 0.2126 * r + 0.7152 * g + 0.0722 * b;\r\n    };\r\n\r\n    // Funci√≥n para calcular ratio de contraste\r\n    const getContrastRatio = (color1, color2) => {\r\n      const lum1 = getLuminance(color1);\r\n      const lum2 = getLuminance(color2);\r\n      const brightest = Math.max(lum1, lum2);\r\n      const darkest = Math.min(lum1, lum2);\r\n      return (brightest + 0.05) / (darkest + 0.05);\r\n    };\r\n\r\n    const rgb1 = hexToRgb(foreground);\r\n    const rgb2 = hexToRgb(background);\r\n\r\n    if (!rgb1 || !rgb2) return null;\r\n\r\n    const ratio = getContrastRatio(rgb1, rgb2);\r\n    \r\n    return {\r\n      ratio: ratio.toFixed(2),\r\n      wcagAA: ratio >= 4.5,\r\n      wcagAAA: ratio >= 7,\r\n      wcagAALarge: ratio >= 3,\r\n      wcagAAALarge: ratio >= 4.5\r\n    };\r\n  }, []);\r\n\r\n  /**\r\n   * Mejorar contraste si es necesario\r\n   */\r\n  const ensureContrast = useCallback((textColor, backgroundColor) => {\r\n    const contrast = checkContrast(textColor, backgroundColor);\r\n    \r\n    if (!contrast) return textColor;\r\n    \r\n    // Si no cumple WCAG AA, ajustar el color\r\n    if (!contrast.wcagAA) {\r\n      // Calcular si el texto es claro u oscuro\r\n      const rgb = parseInt(textColor.slice(1), 16);\r\n      const r = (rgb >> 16) & 0xff;\r\n      const g = (rgb >> 8) & 0xff;\r\n      const b = rgb & 0xff;\r\n      const brightness = (r * 299 + g * 587 + b * 114) / 1000;\r\n      \r\n      // Si es claro, hacerlo m√°s oscuro; si es oscuro, hacerlo m√°s claro\r\n      if (brightness > 128) {\r\n        return '#000000'; // Negro para m√°ximo contraste\r\n      } else {\r\n        return '#ffffff'; // Blanco para m√°ximo contraste\r\n      }\r\n    }\r\n    \r\n    return textColor;\r\n  }, [checkContrast]);\r\n\r\n  /**\r\n   * Configurar navegaci√≥n por teclado para tablas\r\n   */\r\n  const setupTableNavigation = useCallback((tableElement) => {\r\n    if (!tableElement) return;\r\n\r\n    const handleKeyDown = (event) => {\r\n      const cell = event.target;\r\n      const row = cell.closest('tr');\r\n      \r\n      if (!row || !cell) return;\r\n\r\n      const cells = Array.from(row.querySelectorAll('td, th'));\r\n      const cellIndex = cells.indexOf(cell);\r\n      \r\n      let targetCell = null;\r\n\r\n      switch (event.key) {\r\n        case 'ArrowLeft':\r\n          event.preventDefault();\r\n          targetCell = cells[Math.max(0, cellIndex - 1)];\r\n          break;\r\n        case 'ArrowRight':\r\n          event.preventDefault();\r\n          targetCell = cells[Math.min(cells.length - 1, cellIndex + 1)];\r\n          break;\r\n        case 'ArrowUp':\r\n          event.preventDefault();\r\n          const prevRow = row.previousElementSibling;\r\n          if (prevRow) {\r\n            const prevCells = Array.from(prevRow.querySelectorAll('td, th'));\r\n            targetCell = prevCells[Math.min(cellIndex, prevCells.length - 1)];\r\n          }\r\n          break;\r\n        case 'ArrowDown':\r\n          event.preventDefault();\r\n          const nextRow = row.nextElementSibling;\r\n          if (nextRow) {\r\n            const nextCells = Array.from(nextRow.querySelectorAll('td, th'));\r\n            targetCell = nextCells[Math.min(cellIndex, nextCells.length - 1)];\r\n          }\r\n          break;\r\n        case 'Home':\r\n          event.preventDefault();\r\n          targetCell = cells[0];\r\n          break;\r\n        case 'End':\r\n          event.preventDefault();\r\n          targetCell = cells[cells.length - 1];\r\n          break;\r\n      }\r\n\r\n      if (targetCell) {\r\n        // Enfocar el contenido de la celda si es editable, sino la celda\r\n        const focusableElement = targetCell.querySelector('input, select, textarea, button, [tabindex]:not([tabindex=\"-1\"])');\r\n        if (focusableElement) {\r\n          focusableElement.focus();\r\n        } else {\r\n          targetCell.setAttribute('tabindex', '0');\r\n          targetCell.focus();\r\n        }\r\n      }\r\n    };\r\n\r\n    tableElement.addEventListener('keydown', handleKeyDown);\r\n    \r\n    return () => {\r\n      tableElement.removeEventListener('keydown', handleKeyDown);\r\n    };\r\n  }, []);\r\n\r\n  /**\r\n   * Detectar preferencias de accesibilidad del usuario\r\n   */\r\n  const getAccessibilityPreferences = useCallback(() => {\r\n    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;\r\n    const prefersHighContrast = window.matchMedia('(prefers-contrast: high)').matches;\r\n    const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;\r\n    \r\n    return {\r\n      prefersReducedMotion,\r\n      prefersHighContrast,\r\n      prefersDarkMode,\r\n      // Detectar si el usuario est√° usando lector de pantalla\r\n      usesScreenReader: window.speechSynthesis !== undefined,\r\n      // Detectar si el usuario est√° usando teclado\r\n      usesKeyboard: !('ontouchstart' in window) || navigator.maxTouchPoints === 0\r\n    };\r\n  }, []);\r\n\r\n  /**\r\n   * Aplicar preferencias de accesibilidad\r\n   */\r\n  const applyAccessibilityPreferences = useCallback(() => {\r\n    const preferences = getAccessibilityPreferences();\r\n    \r\n    // Aplicar reduced motion\r\n    if (preferences.prefersReducedMotion) {\r\n      document.documentElement.style.setProperty('--transition-duration', '0.01ms');\r\n      document.documentElement.style.setProperty('--animation-duration', '0.01ms');\r\n      \r\n      // Deshabilitar animaciones\r\n      const style = document.createElement('style');\r\n      style.textContent = `\r\n        *, *::before, *::after {\r\n          animation-duration: 0.01ms !important;\r\n          animation-iteration-count: 1 !important;\r\n          transition-duration: 0.01ms !important;\r\n          scroll-behavior: auto !important;\r\n        }\r\n      `;\r\n      document.head.appendChild(style);\r\n    }\r\n    \r\n    // Aplicar high contrast\r\n    if (preferences.prefersHighContrast) {\r\n      document.documentElement.classList.add('high-contrast');\r\n    }\r\n    \r\n    // Aplicar dark mode si es preferido\r\n    if (preferences.prefersDarkMode) {\r\n      document.documentElement.classList.add('dark-mode');\r\n    }\r\n    \r\n    return preferences;\r\n  }, [getAccessibilityPreferences]);\r\n\r\n  /**\r\n   * Configurar manejo de errores para accesibilidad\r\n   */\r\n  const setupErrorHandling = useCallback(() => {\r\n    // Crear regi√≥n live para errores globales\r\n    if (!document.getElementById('global-error-region')) {\r\n      const errorRegion = document.createElement('div');\r\n      errorRegion.id = 'global-error-region';\r\n      errorRegion.setAttribute('aria-live', 'assertive');\r\n      errorRegion.setAttribute('aria-atomic', 'true');\r\n      errorRegion.className = 'sr-only';\r\n      document.body.appendChild(errorRegion);\r\n    }\r\n\r\n    // Crear regi√≥n live para notificaciones\r\n    if (!document.getElementById('global-notification-region')) {\r\n      const notificationRegion = document.createElement('div');\r\n      notificationRegion.id = 'global-notification-region';\r\n      notificationRegion.setAttribute('aria-live', 'polite');\r\n      notificationRegion.setAttribute('aria-atomic', 'true');\r\n      notificationRegion.className = 'sr-only';\r\n      document.body.appendChild(notificationRegion);\r\n    }\r\n  }, []);\r\n\r\n  /**\r\n   * Inicializar accesibilidad\r\n   */\r\n  const initializeAccessibility = useCallback(() => {\r\n    setupSkipLinks();\r\n    setupErrorHandling();\r\n    const preferences = applyAccessibilityPreferences();\r\n    \r\n    // Anunciar que la accesibilidad est√° inicializada\r\n    announceToScreenReader('Sistema de accesibilidad inicializado');\r\n    \r\n    return preferences;\r\n  }, [setupSkipLinks, setupErrorHandling, applyAccessibilityPreferences, announceToScreenReader]);\r\n\r\n  // Efecto para inicializar accesibilidad al montar\r\n  useEffect(() => {\r\n    const preferences = initializeAccessibility();\r\n    \r\n    // Escuchar cambios en preferencias del sistema\r\n    const mediaQueries = [\r\n      window.matchMedia('(prefers-reduced-motion: reduce)'),\r\n      window.matchMedia('(prefers-contrast: high)'),\r\n      window.matchMedia('(prefers-color-scheme: dark)')\r\n    ];\r\n\r\n    const handleChange = () => {\r\n      applyAccessibilityPreferences();\r\n    };\r\n\r\n    mediaQueries.forEach(mq => mq.addEventListener('change', handleChange));\r\n\r\n    return () => {\r\n      mediaQueries.forEach(mq => mq.removeEventListener('change', handleChange));\r\n    };\r\n  }, [initializeAccessibility, applyAccessibilityPreferences]);\r\n\r\n  return {\r\n    // M√©todos principales\r\n    setupFocusTrap,\r\n    releaseFocusTrap,\r\n    announceToScreenReader,\r\n    \r\n    // Utilidades\r\n    checkContrast,\r\n    ensureContrast,\r\n    setupTableNavigation,\r\n    getAccessibilityPreferences,\r\n    applyAccessibilityPreferences,\r\n    \r\n    // Inicializaci√≥n\r\n    initializeAccessibility,\r\n    \r\n    // Referencias\r\n    skipLinkRef,\r\n    focusTrapRef,\r\n    previousFocusRef\r\n  };\r\n};\r\n\r\n/**\r\n * Hook para manejar focus trap en modales\r\n */\r\nexport const useFocusTrap = (isOpen, elementRef) => {\r\n  const { setupFocusTrap, releaseFocusTrap } = useAccessibility();\r\n\r\n  useEffect(() => {\r\n    if (isOpen && elementRef.current) {\r\n      const cleanup = setupFocusTrap(elementRef.current);\r\n      return cleanup;\r\n    }\r\n  }, [isOpen, elementRef, setupFocusTrap]);\r\n};\r\n\r\n/**\r\n * Hook para anuncios a lectores de pantalla\r\n */\r\nexport const useScreenReaderAnnouncer = () => {\r\n  const { announceToScreenReader } = useAccessibility();\r\n\r\n  const announce = useCallback((message, priority = 'polite') => {\r\n    announceToScreenReader(message, priority);\r\n  }, [announceToScreenReader]);\r\n\r\n  const announceError = useCallback((message) => {\r\n    announceToScreenReader(`Error: ${message}`, 'assertive');\r\n  }, [announceToScreenReader]);\r\n\r\n  const announceSuccess = useCallback((message) => {\r\n    announceToScreenReader(`√âxito: ${message}`, 'polite');\r\n  }, [announceToScreenReader]);\r\n\r\n  const announceNavigation = useCallback((message) => {\r\n    announceToScreenReader(`Navegaci√≥n: ${message}`, 'polite');\r\n  }, [announceToScreenReader]);\r\n\r\n  return {\r\n    announce,\r\n    announceError,\r\n    announceSuccess,\r\n    announceNavigation\r\n  };\r\n};\r\n\r\n/**\r\n * Hook para manejar preferencias de accesibilidad\r\n */\r\nexport const useAccessibilityPreferences = () => {\r\n  const { getAccessibilityPreferences, applyAccessibilityPreferences } = useAccessibility();\r\n  const [preferences, setPreferences] = React.useState(null);\r\n\r\n  useEffect(() => {\r\n    const prefs = getAccessibilityPreferences();\r\n    setPreferences(prefs);\r\n  }, [getAccessibilityPreferences]);\r\n\r\n  const updatePreferences = useCallback(() => {\r\n    const updatedPrefs = applyAccessibilityPreferences();\r\n    setPreferences(updatedPrefs);\r\n    return updatedPrefs;\r\n  }, [applyAccessibilityPreferences]);\r\n\r\n  return {\r\n    preferences,\r\n    updatePreferences\r\n  };\r\n};\r\n\r\nexport default useAccessibility;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\hooks\\useEmployeeFolders.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loading'. Either include it or remove the dependency array.","line":294,"column":6,"nodeType":"ArrayExpression","endLine":294,"endColumn":57,"suggestions":[{"desc":"Update the dependencies array to be: [currentPage, employees.length, loadFoldersForPage, loading]","fix":{"range":[10448,10499],"text":"[currentPage, employees.length, loadFoldersForPage, loading]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from 'react';\r\nimport employeeFolderService from '../services/employeeFolderService.js';\r\nimport organizedDatabaseService from '../services/organizedDatabaseService.js';\r\nimport Swal from 'sweetalert2';\r\nimport withReactContent from 'sweetalert2-react-content';\r\n\r\nconst MySwal = withReactContent(Swal);\r\n\r\n/**\r\n * Hook personalizado para gestionar la l√≥gica de carpetas de empleados\r\n * Extrae la complejidad del componente EmployeeFolders\r\n */\r\nexport const useEmployeeFolders = (companyId) => {\r\n  // Estado principal\r\n  const [employees, setEmployees] = useState([]);\r\n  const [folders, setFolders] = useState([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [loadingFolders, setLoadingFolders] = useState(false);\r\n  \r\n  // Estado de filtros y b√∫squeda\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [filters, setFilters] = useState({\r\n    companyId: '',\r\n    department: '',\r\n    level: '',\r\n    workMode: '',\r\n    contractType: ''\r\n  });\r\n  \r\n  // Estado de selecci√≥n\r\n  const [selectedFolders, setSelectedFolders] = useState(new Set());\r\n  const [selectedFolder, setSelectedFolder] = useState(null);\r\n  \r\n  // Estado de paginaci√≥n\r\n  const [currentPage, setCurrentPage] = useState(1);\r\n  const [itemsPerPage] = useState(20);\r\n  const [totalItems, setTotalItems] = useState(0);\r\n  \r\n  // Estado de filtros √∫nicos\r\n  const [companies, setCompanies] = useState([]);\r\n  const [uniqueDepartments, setUniqueDepartments] = useState([]);\r\n  const [uniqueLevels, setUniqueLevels] = useState([]);\r\n  const [uniqueWorkModes, setUniqueWorkModes] = useState([]);\r\n  const [uniqueContractTypes, setUniqueContractTypes] = useState([]);\r\n\r\n  // Cargar empleados\r\n  const loadEmployees = useCallback(async () => {\r\n    try {\r\n      setLoading(true);\r\n      console.log('üöÄ Iniciando carga de empleados...');\r\n      \r\n      // Cargar empresas\r\n      const companyData = await organizedDatabaseService.getCompanies();\r\n      setCompanies(companyData);\r\n      \r\n      // Obtener empleados con filtros\r\n      let employeesData = [];\r\n      if (companyId) {\r\n        employeesData = await organizedDatabaseService.getEmployees({ companyId });\r\n      } else {\r\n        employeesData = await organizedDatabaseService.getEmployees(filters);\r\n      }\r\n\r\n      console.log(`üìä Cargados ${employeesData.length} empleados`);\r\n      setEmployees(employeesData);\r\n      setTotalItems(employeesData.filter(emp => emp.email).length);\r\n\r\n      // Extraer valores √∫nicos para filtros\r\n      extractUniqueFilters(employeesData);\r\n      \r\n    } catch (error) {\r\n      console.error('‚ùå Error cargando empleados:', error);\r\n      MySwal.fire({\r\n        title: 'Error',\r\n        text: 'Hubo un problema al cargar los empleados',\r\n        icon: 'error',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n      console.log('üèÅ Carga de empleados completada');\r\n    }\r\n  }, [companyId, filters]);\r\n\r\n  // Cargar carpetas para p√°gina actual\r\n  const loadFoldersForPage = useCallback(async () => {\r\n    try {\r\n      setLoadingFolders(true);\r\n      console.log(`üìÅ Cargando carpetas para p√°gina ${currentPage}...`);\r\n      \r\n      // Filtrar empleados con email y aplicar paginaci√≥n\r\n      const employeesWithEmail = employees.filter(emp => emp.email);\r\n      const startIndex = (currentPage - 1) * itemsPerPage;\r\n      const endIndex = startIndex + itemsPerPage;\r\n      const employeesForPage = employeesWithEmail.slice(startIndex, endIndex);\r\n      \r\n      console.log(`üìÑ Procesando ${employeesForPage.length} empleados de ${employeesWithEmail.length} totales`);\r\n\r\n      // Procesar carpetas en paralelo\r\n      const folderPromises = employeesForPage.map(async (employee) => {\r\n        try {\r\n          const folder = await employeeFolderService.getEmployeeFolder(employee.email);\r\n          return {\r\n            ...folder,\r\n            employeeName: employee.name,\r\n            employeePosition: employee.position,\r\n            employeeDepartment: employee.department,\r\n            employeePhone: employee.phone,\r\n            employeeRegion: employee.region,\r\n            employeeLevel: employee.level,\r\n            employeeWorkMode: employee.work_mode,\r\n            employeeContractType: employee.contract_type,\r\n            companyName: employee.company?.name || 'Empresa no especificada'\r\n          };\r\n        } catch (error) {\r\n          console.warn(`‚ö†Ô∏è Error cargando carpeta para ${employee.email}, creando carpeta b√°sica:`, error.message);\r\n          return createBasicFolder(employee);\r\n        }\r\n      });\r\n\r\n      const foldersData = await Promise.all(folderPromises);\r\n      console.log(`‚úÖ Procesadas ${foldersData.length} carpetas para p√°gina ${currentPage}`);\r\n      \r\n      // Actualizar folders\r\n      setFolders(prevFolders => {\r\n        if (currentPage === 1) {\r\n          return foldersData;\r\n        } else {\r\n          const existingFolders = prevFolders.slice(0, startIndex);\r\n          return [...existingFolders, ...foldersData];\r\n        }\r\n      });\r\n      \r\n    } catch (error) {\r\n      console.error('‚ùå Error cargando carpetas:', error);\r\n      MySwal.fire({\r\n        title: 'Error',\r\n        text: 'Hubo un problema al cargar las carpetas',\r\n        icon: 'error',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    } finally {\r\n      setLoadingFolders(false);\r\n      console.log('üèÅ Carga de carpetas completada');\r\n    }\r\n  }, [currentPage, employees, itemsPerPage]);\r\n\r\n  // Crear carpeta b√°sica\r\n  const createBasicFolder = (employee) => ({\r\n    email: employee.email,\r\n    employeeName: employee.name,\r\n    employeePosition: employee.position,\r\n    employeeDepartment: employee.department,\r\n    employeePhone: employee.phone,\r\n    employeeRegion: employee.region,\r\n    employeeLevel: employee.level,\r\n    employeeWorkMode: employee.work_mode,\r\n    employeeContractType: employee.contract_type,\r\n    companyName: employee.company?.name || 'Empresa no especificada',\r\n    createdAt: new Date().toISOString(),\r\n    lastUpdated: new Date().toISOString(),\r\n    knowledgeBase: {\r\n      faqs: [],\r\n      documents: [],\r\n      policies: [],\r\n      procedures: []\r\n    },\r\n    conversationHistory: [],\r\n    settings: {\r\n      notificationPreferences: {\r\n        whatsapp: true,\r\n        telegram: true,\r\n        email: true\r\n      },\r\n      responseLanguage: 'es',\r\n      timezone: 'America/Santiago'\r\n    }\r\n  });\r\n\r\n  // Extraer filtros √∫nicos\r\n  const extractUniqueFilters = (employeesData) => {\r\n    const departments = [...new Set(employeesData.map(emp => emp.department).filter(Boolean))];\r\n    const levels = [...new Set(employeesData.map(emp => emp.level).filter(Boolean))];\r\n    const workModes = [...new Set(employeesData.map(emp => emp.work_mode).filter(Boolean))];\r\n    const contractTypes = [...new Set(employeesData.map(emp => emp.contract_type).filter(Boolean))];\r\n    \r\n    setUniqueDepartments(departments.sort());\r\n    setUniqueLevels(levels.sort());\r\n    setUniqueWorkModes(workModes.sort());\r\n    setUniqueContractTypes(contractTypes.sort());\r\n  };\r\n\r\n  // Manejar cambios en filtros\r\n  const handleFilterChange = useCallback((filterName, value) => {\r\n    setFilters(prev => ({\r\n      ...prev,\r\n      [filterName]: value\r\n    }));\r\n  }, []);\r\n\r\n  // Manejar b√∫squeda\r\n  const handleSearch = useCallback((term) => {\r\n    setSearchTerm(term);\r\n  }, []);\r\n\r\n  // Obtener empleados filtrados\r\n  const getFilteredEmployees = useCallback(() => {\r\n    return employees.filter(employee => {\r\n      if (!employee.email) return false;\r\n      \r\n      const matchesSearch = !searchTerm ||\r\n        employee.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n        employee.email.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n        (employee.company?.name && employee.company.name.toLowerCase().includes(searchTerm.toLowerCase())) ||\r\n        (employee.department && employee.department.toLowerCase().includes(searchTerm.toLowerCase()));\r\n      \r\n      return matchesSearch;\r\n    });\r\n  }, [employees, searchTerm]);\r\n\r\n  // Obtener carpetas filtradas\r\n  const getFilteredFolders = useCallback(() => {\r\n    const filteredEmployees = getFilteredEmployees();\r\n    return folders.filter(folder => {\r\n      return filteredEmployees.some(emp => emp.email === folder.email);\r\n    });\r\n  }, [folders, getFilteredEmployees]);\r\n\r\n  // Manejar selecci√≥n de carpetas\r\n  const handleSelectFolder = useCallback((employeeEmail) => {\r\n    setSelectedFolders(prev => {\r\n      const newSelected = new Set(prev);\r\n      if (newSelected.has(employeeEmail)) {\r\n        newSelected.delete(employeeEmail);\r\n      } else {\r\n        newSelected.add(employeeEmail);\r\n      }\r\n      return newSelected;\r\n    });\r\n  }, []);\r\n\r\n  // Seleccionar todas las carpetas\r\n  const handleSelectAll = useCallback(() => {\r\n    const filteredFolders = getFilteredFolders();\r\n    if (selectedFolders.size === filteredFolders.length) {\r\n      setSelectedFolders(new Set());\r\n    } else {\r\n      const allEmails = new Set(filteredFolders.map(folder => folder.email));\r\n      setSelectedFolders(allEmails);\r\n    }\r\n  }, [selectedFolders.size, getFilteredFolders]);\r\n\r\n  // Manejar cambio de p√°gina\r\n  const handlePageChange = useCallback((page) => {\r\n    setCurrentPage(page);\r\n    setFolders([]); // Limpiar carpetas al cambiar de p√°gina\r\n  }, []);\r\n\r\n  // Ver carpeta individual\r\n  const handleViewFolder = useCallback(async (employeeEmail) => {\r\n    try {\r\n      const folder = await employeeFolderService.getEmployeeFolder(employeeEmail);\r\n      setSelectedFolder(folder);\r\n      setSelectedFolders(new Set());\r\n    } catch (error) {\r\n      console.error('Error cargando carpeta:', error);\r\n      MySwal.fire({\r\n        title: 'Error',\r\n        text: 'Hubo un problema al cargar la carpeta del empleado',\r\n        icon: 'error',\r\n        confirmButtonText: 'Aceptar',\r\n        confirmButtonColor: '#0693e3'\r\n      });\r\n    }\r\n  }, []);\r\n\r\n  // Calcular p√°ginas totales\r\n  const getTotalPages = useCallback(() => {\r\n    const filteredEmployees = getFilteredEmployees();\r\n    return Math.ceil(filteredEmployees.length / itemsPerPage);\r\n  }, [getFilteredEmployees, itemsPerPage]);\r\n\r\n  // Efectos\r\n  useEffect(() => {\r\n    loadEmployees();\r\n  }, [loadEmployees]);\r\n\r\n  useEffect(() => {\r\n    if (employees.length > 0 && !loading) {\r\n      loadFoldersForPage();\r\n    }\r\n  }, [currentPage, employees.length, loadFoldersForPage]);\r\n\r\n  useEffect(() => {\r\n    const filteredEmployees = getFilteredEmployees();\r\n    setTotalItems(filteredEmployees.length);\r\n    setCurrentPage(1);\r\n    setFolders([]);\r\n  }, [searchTerm, filters, employees.length, getFilteredEmployees]);\r\n\r\n  return {\r\n    // Estado\r\n    employees,\r\n    folders,\r\n    loading,\r\n    loadingFolders,\r\n    searchTerm,\r\n    filters,\r\n    selectedFolders,\r\n    selectedFolder,\r\n    currentPage,\r\n    itemsPerPage,\r\n    totalItems,\r\n    companies,\r\n    uniqueDepartments,\r\n    uniqueLevels,\r\n    uniqueWorkModes,\r\n    uniqueContractTypes,\r\n    \r\n    // Acciones\r\n    handleFilterChange,\r\n    handleSearch,\r\n    handleSelectFolder,\r\n    handleSelectAll,\r\n    handlePageChange,\r\n    handleViewFolder,\r\n    setSelectedFolder,\r\n    setSelectedFolders,\r\n    \r\n    // Getters\r\n    getFilteredFolders,\r\n    getFilteredEmployees,\r\n    getTotalPages\r\n  };\r\n};\r\n\r\nexport default useEmployeeFolders;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\hooks\\useErrorHandler.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'addError'. Either include it or remove the dependency array.","line":43,"column":6,"nodeType":"ArrayExpression","endLine":43,"endColumn":57,"suggestions":[{"desc":"Update the dependencies array to be: [enableNotifications, enableLogging, customOnError, addError]","fix":{"range":[1173,1224],"text":"[enableNotifications, enableLogging, customOnError, addError]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'removeError'. Either include it or remove the dependency array.","line":59,"column":6,"nodeType":"ArrayExpression","endLine":59,"endColumn":32,"suggestions":[{"desc":"Update the dependencies array to be: [autoHideDelay, maxErrors, removeError]","fix":{"range":[1688,1714],"text":"[autoHideDelay, maxErrors, removeError]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useCallback, useEffect } from 'react';\r\nimport errorHandler from '../lib/errorHandler.js';\r\nimport logger from '../lib/logger.js';\r\n\r\n/**\r\n * Hook personalizado para manejo de errores en componentes React\r\n */\r\nexport const useErrorHandler = (options = {}) => {\r\n  const [errors, setErrors] = useState([]);\r\n  const [isErrorModalOpen, setIsErrorModalOpen] = useState(false);\r\n  \r\n  const {\r\n    enableNotifications = true,\r\n    enableLogging = true,\r\n    maxErrors = 10,\r\n    autoHideDelay = 5000,\r\n    onError: customOnError,\r\n    onResolved: customOnResolved\r\n  } = options;\r\n\r\n  // Suscribirse al sistema de errores al montar el componente\r\n  useEffect(() => {\r\n    const unsubscribe = errorHandler.subscribe((error) => {\r\n      if (enableNotifications) {\r\n        addError(error);\r\n      }\r\n      \r\n      if (enableLogging) {\r\n        logger.error('Error notificado desde hook', {\r\n          errorId: error.errorId,\r\n          message: error.message,\r\n          type: error.type,\r\n          severity: error.severity\r\n        });\r\n      }\r\n\r\n      if (customOnError) {\r\n        customOnError(error);\r\n      }\r\n    });\r\n\r\n    return unsubscribe;\r\n  }, [enableNotifications, enableLogging, customOnError]);\r\n\r\n  // Agregar error a la lista local\r\n  const addError = useCallback((error) => {\r\n    setErrors(prevErrors => {\r\n      const newErrors = [...prevErrors, error];\r\n      // Limitar n√∫mero de errores\r\n      return newErrors.slice(-maxErrors);\r\n    });\r\n\r\n    // Auto ocultar errores de baja severidad\r\n    if (error.severity === 'LOW' && autoHideDelay > 0) {\r\n      setTimeout(() => {\r\n        removeError(error.errorId);\r\n      }, autoHideDelay);\r\n    }\r\n  }, [maxErrors, autoHideDelay]);\r\n\r\n  // Manejar error manualmente\r\n  const handleError = useCallback((error, context = {}) => {\r\n    const structuredError = errorHandler.handleError(error, {\r\n      component: 'useErrorHandler',\r\n      ...context\r\n    });\r\n    \r\n    return structuredError;\r\n  }, []);\r\n\r\n  // Manejar error as√≠ncrono\r\n  const handleAsyncError = useCallback(async (asyncFn, context = {}) => {\r\n    try {\r\n      return await asyncFn();\r\n    } catch (error) {\r\n      const structuredError = handleError(error, context);\r\n      throw structuredError;\r\n    }\r\n  }, [handleError]);\r\n\r\n  // Remover error espec√≠fico\r\n  const removeError = useCallback((errorId) => {\r\n    setErrors(prevErrors => prevErrors.filter(err => err.errorId !== errorId));\r\n    \r\n    if (customOnResolved) {\r\n      customOnResolved(errorId);\r\n    }\r\n  }, [customOnResolved]);\r\n\r\n  // Limpiar todos los errores\r\n  const clearErrors = useCallback(() => {\r\n    setErrors([]);\r\n  }, []);\r\n\r\n  // Abrir/cerrar modal de errores\r\n  const toggleErrorModal = useCallback(() => {\r\n    setIsErrorModalOpen(prev => !prev);\r\n  }, []);\r\n\r\n  // Obtener errores por severidad\r\n  const getErrorsBySeverity = useCallback((severity) => {\r\n    return errors.filter(error => error.severity === severity);\r\n  }, [errors]);\r\n\r\n  // Obtener errores por tipo\r\n  const getErrorsByType = useCallback((type) => {\r\n    return errors.filter(error => error.type === type);\r\n  }, [errors]);\r\n\r\n  // Contar errores por severidad\r\n  const errorCounts = {\r\n    total: errors.length,\r\n    low: getErrorsBySeverity('LOW').length,\r\n    medium: getErrorsBySeverity('MEDIUM').length,\r\n    high: getErrorsBySeverity('HIGH').length,\r\n    critical: getErrorsBySeverity('CRITICAL').length\r\n  };\r\n\r\n  return {\r\n    // Estado\r\n    errors,\r\n    isErrorModalOpen,\r\n    errorCounts,\r\n    \r\n    // Acciones\r\n    handleError,\r\n    handleAsyncError,\r\n    removeError,\r\n    clearErrors,\r\n    toggleErrorModal,\r\n    \r\n    // Utilidades\r\n    getErrorsBySeverity,\r\n    getErrorsByType,\r\n    \r\n    // M√©todos de conveniencia para tipos espec√≠ficos\r\n    handleNetworkError: useCallback((error, context) => \r\n      handleError(error, { ...context, type: 'NETWORK' }), [handleError]),\r\n    \r\n    handleDatabaseError: useCallback((error, context) => \r\n      handleError(error, { ...context, type: 'DATABASE' }), [handleError]),\r\n    \r\n    handleValidationError: useCallback((error, context) => \r\n      handleError(error, { ...context, type: 'VALIDATION' }), [handleError]),\r\n    \r\n    handleAuthError: useCallback((error, context) => \r\n      handleError(error, { ...context, type: 'AUTHENTICATION' }), [handleError])\r\n  };\r\n};\r\n\r\n/**\r\n * Hook simplificado para manejo b√°sico de errores\r\n */\r\nexport const useSimpleErrorHandler = () => {\r\n  const [error, setError] = useState(null);\r\n  \r\n  const handleError = useCallback((error) => {\r\n    const structuredError = errorHandler.handleError(error, {\r\n      component: 'useSimpleErrorHandler'\r\n    });\r\n    \r\n    setError(structuredError);\r\n    logger.error('Error simple manejado', {\r\n      errorId: structuredError.errorId,\r\n      message: structuredError.message\r\n    });\r\n    \r\n    return structuredError;\r\n  }, []);\r\n\r\n  const clearError = useCallback(() => {\r\n    setError(null);\r\n  }, []);\r\n\r\n  return {\r\n    error,\r\n    handleError,\r\n    clearError,\r\n    hasError: !!error\r\n  };\r\n};\r\n\r\nexport default useErrorHandler;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\hooks\\useFileUpload.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'employeeFolderService' is defined but never used.","line":3,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":29},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'allowedFileTypes' and 'blockedExtensions'. Either include them or remove the dependency array.","line":70,"column":6,"nodeType":"ArrayExpression","endLine":70,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [allowedFileTypes, blockedExtensions]","fix":{"range":[2654,2656],"text":"[allowedFileTypes, blockedExtensions]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'user.id'. Either include it or remove the dependency array.","line":222,"column":6,"nodeType":"ArrayExpression","endLine":222,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [user.email, user.id]","fix":{"range":[8043,8055],"text":"[user.email, user.id]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'tokensUsed' is assigned a value but never used.","line":273,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":273,"endColumn":49}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useCallback } from 'react';\r\nimport { useAuth } from '../contexts/AuthContext.js';\r\nimport employeeFolderService from '../services/employeeFolderService.js';\r\nimport fileContentExtractor from '../services/fileContentExtractor.js';\r\nimport embeddingService from '../services/embeddingService.js';\r\nimport googleDriveService from '../lib/googleDrive.js';\r\nimport { db, supabase } from '../lib/supabase.js';\r\nimport toast from 'react-hot-toast';\r\n\r\n/**\r\n * Hook personalizado para gestionar la l√≥gica de upload de archivos\r\n * Extrae la complejidad del componente Files\r\n */\r\nexport const useFileUpload = () => {\r\n  const { user, userProfile } = useAuth();\r\n  const [uploading, setUploading] = useState(false);\r\n  const [uploadProgress, setUploadProgress] = useState({});\r\n  const [selectedFiles, setSelectedFiles] = useState([]);\r\n\r\n  // Tipos de archivo permitidos\r\n  const allowedFileTypes = {\r\n    'application/pdf': '.pdf',\r\n    'application/msword': '.doc',\r\n    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': '.docx',\r\n    'application/vnd.ms-excel': '.xls',\r\n    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': '.xlsx',\r\n    'application/vnd.ms-powerpoint': '.ppt',\r\n    'application/vnd.openxmlformats-officedocument.presentationml.presentation': '.pptx',\r\n    'text/plain': '.txt'\r\n  };\r\n\r\n  // Extensiones bloqueadas\r\n  const blockedExtensions = [\r\n    '.exe', '.bat', '.cmd', '.com', '.scr', '.msi', '.dll',\r\n    '.zip', '.rar', '.7z', '.tar', '.gz', '.bz2',\r\n    '.js', '.vbs', '.ps1', '.sh'\r\n  ];\r\n\r\n  // Validar tipo de archivo\r\n  const validateFileType = useCallback((file) => {\r\n    const fileName = file.name.toLowerCase();\r\n    const fileType = file.type;\r\n    \r\n    // Verificar extensiones bloqueadas\r\n    const hasBlockedExtension = blockedExtensions.some(ext => fileName.endsWith(ext));\r\n    if (hasBlockedExtension) {\r\n      return {\r\n        valid: false,\r\n        reason: `Archivo ${file.name}: Tipo de archivo no permitido por seguridad`\r\n      };\r\n    }\r\n    \r\n    // Verificar tipos MIME permitidos\r\n    if (fileType && allowedFileTypes[fileType]) {\r\n      return { valid: true };\r\n    }\r\n    \r\n    // Verificar por extensi√≥n si el MIME type no est√° disponible\r\n    const allowedExtensions = Object.values(allowedFileTypes);\r\n    const hasAllowedExtension = allowedExtensions.some(ext => fileName.endsWith(ext));\r\n    \r\n    if (hasAllowedExtension) {\r\n      return { valid: true };\r\n    }\r\n    \r\n    return {\r\n      valid: false,\r\n      reason: `Archivo ${file.name}: Solo se permiten documentos PDF, Word, Excel, PowerPoint y archivos de texto`\r\n    };\r\n  }, []);\r\n\r\n  // Manejar selecci√≥n de archivos\r\n  const handleFileSelect = useCallback((event) => {\r\n    const files = Array.isArray(event) ? event : Array.from(event.target.files);\r\n    \r\n    // Validar cada archivo\r\n    const validationResults = files.map(validateFileType);\r\n    const invalidFiles = validationResults.filter(result => !result.valid);\r\n    \r\n    if (invalidFiles.length > 0) {\r\n      // Mostrar errores para archivos no v√°lidos\r\n      invalidFiles.forEach(result => {\r\n        toast.error(result.reason);\r\n      });\r\n      \r\n      // Solo mantener archivos v√°lidos\r\n      const validFiles = files.filter((file, index) => validationResults[index].valid);\r\n      \r\n      if (validFiles.length === 0) {\r\n        event.target.value = '';\r\n        return;\r\n      }\r\n      \r\n      setSelectedFiles(validFiles);\r\n      toast.success(`${validFiles.length} archivo(s) v√°lido(s) seleccionado(s)`);\r\n    } else {\r\n      setSelectedFiles(files);\r\n      toast.success(`${files.length} archivo(s) seleccionado(s)`);\r\n    }\r\n  }, [validateFileType]);\r\n\r\n  // Subir archivo a Google Drive\r\n  const uploadToGoogleDrive = useCallback(async (file, folderId, onProgress) => {\r\n    if (!userProfile?.google_refresh_token) {\r\n      throw new Error('Google Drive no est√° conectado');\r\n    }\r\n\r\n    await googleDriveService.setTokens({\r\n      refresh_token: userProfile.google_refresh_token\r\n    });\r\n\r\n    return await googleDriveService.uploadFile(file, folderId, onProgress);\r\n  }, [userProfile]);\r\n\r\n  // Procesar contenido del archivo\r\n  const processFileContent = useCallback(async (file) => {\r\n    if (!fileContentExtractor.isSupported(file)) {\r\n      throw new Error(`Formato de archivo no compatible: ${file.type}. Solo se permiten documentos de texto, PDF, Word y Excel.`);\r\n    }\r\n\r\n    const processed = await embeddingService.processFile(file, fileContentExtractor);\r\n    const tokensUsed = Math.ceil(processed.content.length / 4);\r\n\r\n    // Registrar uso de tokens\r\n    const embeddingsServiceLib = await import('../lib/embeddings');\r\n    await embeddingsServiceLib.default.trackTokenUsage(user.id, tokensUsed, 'file_embedding');\r\n\r\n    return {\r\n      content: processed.content,\r\n      embedding: processed.embedding,\r\n      tokensUsed\r\n    };\r\n  }, [user.id]);\r\n\r\n  // Crear chunks para contenido largo\r\n  const createContentChunks = useCallback(async (content, file, folder, googleFileId, embedding, selectedFolder) => {\r\n    const MAX_CONTENT_LENGTH = 10240;\r\n    \r\n    if (content.length <= MAX_CONTENT_LENGTH) {\r\n      return null; // No necesita chunking\r\n    }\r\n\r\n    const embeddingsServiceLib = await import('../lib/embeddings');\r\n    const chunks = embeddingsServiceLib.default.splitTextIntoChunks(content, 8000);\r\n    \r\n    // Crear documento principal (truncado)\r\n    const contentToStore = content.substring(0, MAX_CONTENT_LENGTH - 200) + \r\n      `\\n\\n[DOCUMENTO DIVIDIDO EN CHUNKS: Este documento fue dividido en ${chunks.length} partes para optimizar la b√∫squeda. Contenido total: ${content.length} caracteres]`;\r\n\r\n    const baseMetadata = {\r\n      name: file.name,\r\n      correo: folder.correo || folder.folder_name,\r\n      source: 'web_upload',\r\n      file_id: googleFileId,\r\n      file_type: file.type,\r\n      file_size: file.size,\r\n      upload_date: new Date().toISOString(),\r\n      blobType: file.type,\r\n      is_chunked: true,\r\n      original_length: content.length,\r\n      chunks_count: chunks.length,\r\n      chunk_type: 'main'\r\n    };\r\n\r\n    // Guardar documento principal\r\n    const mainFileData = {\r\n      entrenador: user.email,\r\n      folder_id: selectedFolder,\r\n      content: contentToStore,\r\n      metadata: baseMetadata,\r\n      embedding: embedding\r\n    };\r\n\r\n    const { data: mainDoc, error: mainError } = await db.trainerDocuments.create(mainFileData);\r\n    if (mainError) throw mainError;\r\n\r\n    // Crear chunks\r\n    let successfulChunks = 0;\r\n    for (let i = 0; i < chunks.length; i++) {\r\n      try {\r\n        const chunkEmbeddingResult = await embeddingsServiceLib.default.generateEmbedding(chunks[i], user.id);\r\n        \r\n        const chunkData = {\r\n          entrenador: user.email,\r\n          folder_id: selectedFolder,\r\n          content: chunks[i],\r\n          metadata: {\r\n            ...baseMetadata,\r\n            chunk_type: 'chunk',\r\n            chunk_index: i + 1,\r\n            parent_file_id: googleFileId,\r\n            chunk_of_total: `${i + 1}/${chunks.length}`,\r\n            name: `${file.name} - Parte ${i + 1}`,\r\n            source: 'chunk_from_web_upload'\r\n          },\r\n          embedding: chunkEmbeddingResult.embedding\r\n        };\r\n        \r\n        const { error: chunkError } = await db.trainerDocuments.create(chunkData);\r\n        if (!chunkError) {\r\n          successfulChunks++;\r\n          await embeddingsServiceLib.default.trackTokenUsage(user.id, chunkEmbeddingResult.tokens_used, 'file_embedding');\r\n        }\r\n      } catch (chunkError) {\r\n        console.error(`Error procesando chunk ${i + 1}:`, chunkError);\r\n      }\r\n    }\r\n\r\n    // Actualizar metadata del documento principal\r\n    await supabase\r\n      .from('documentos_entrenador')\r\n      .update({\r\n        metadata: {\r\n          ...baseMetadata,\r\n          chunks_created: successfulChunks,\r\n          chunks_failed: chunks.length - successfulChunks\r\n        }\r\n      })\r\n      .eq('id', mainDoc.id);\r\n\r\n    return { mainDoc, successfulChunks };\r\n  }, [user.email]);\r\n\r\n  // Subir archivos\r\n  const handleUpload = useCallback(async (selectedFolder, folders) => {\r\n    if (!selectedFolder) {\r\n      toast.error('Selecciona una carpeta para subir los archivos');\r\n      return;\r\n    }\r\n    \r\n    if (selectedFiles.length === 0) {\r\n      toast.error('Selecciona al menos un archivo');\r\n      return;\r\n    }\r\n\r\n    setUploading(true);\r\n    const newUploadProgress = {};\r\n    \r\n    try {\r\n      // Obtener informaci√≥n de la carpeta\r\n      const folder = folders.find(f => f.id === selectedFolder);\r\n      if (!folder) {\r\n        toast.error('Carpeta no encontrada');\r\n        return;\r\n      }\r\n      \r\n      for (let i = 0; i < selectedFiles.length; i++) {\r\n        const file = selectedFiles[i];\r\n        const fileId = `file-${i}`;\r\n        \r\n        try {\r\n          newUploadProgress[fileId] = 0;\r\n          setUploadProgress({ ...newUploadProgress });\r\n          \r\n          let googleFileId = null;\r\n          \r\n          // Subir a Google Drive si est√° conectado\r\n          if (userProfile?.google_refresh_token && folder.google_folder_id) {\r\n            const driveFile = await uploadToGoogleDrive(\r\n              file,\r\n              folder.google_folder_id,\r\n              (progress) => {\r\n                newUploadProgress[fileId] = progress;\r\n                setUploadProgress({ ...newUploadProgress });\r\n              }\r\n            );\r\n            googleFileId = driveFile.id;\r\n          } else {\r\n            googleFileId = `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n          }\r\n          \r\n          // Procesar contenido\r\n          const { content, embedding, tokensUsed } = await processFileContent(file);\r\n          newUploadProgress[fileId] = 20;\r\n          setUploadProgress({ ...newUploadProgress });\r\n          \r\n          // Verificar si necesita chunking\r\n          const MAX_CONTENT_LENGTH = 10240;\r\n          let contentToStore = content;\r\n          \r\n          if (content.length > MAX_CONTENT_LENGTH) {\r\n            // Crear chunks\r\n            const chunkResult = await createContentChunks(\r\n              content, \r\n              file, \r\n              folder, \r\n              googleFileId, \r\n              embedding, \r\n              selectedFolder\r\n            );\r\n            \r\n            if (chunkResult) {\r\n              // Registrar en documentos_usuario_entrenador\r\n              const userTrainerDocData = {\r\n                file_id: googleFileId,\r\n                file_type: file.type,\r\n                file_name: file.name,\r\n                usuario: folder.correo || folder.folder_name,\r\n                entrenador: user.email\r\n              };\r\n              \r\n              await db.userTrainerDocuments.create(userTrainerDocData);\r\n              \r\n              // Actualizar estad√≠sticas del usuario\r\n              const embeddingSize = embedding.length * 4;\r\n              await db.users.update(user.id, {\r\n                used_storage_bytes: (userProfile.used_storage_bytes || 0) + embeddingSize\r\n              });\r\n              \r\n              newUploadProgress[fileId] = 100;\r\n              setUploadProgress({ ...newUploadProgress });\r\n              continue;\r\n            }\r\n          }\r\n          \r\n          // Guardar documento normal (sin chunking)\r\n          const fileData = {\r\n            entrenador: user.email,\r\n            folder_id: selectedFolder,\r\n            content: contentToStore,\r\n            metadata: {\r\n              name: file.name,\r\n              correo: folder.correo || folder.folder_name,\r\n              source: 'web_upload',\r\n              file_id: googleFileId,\r\n              file_type: file.type,\r\n              file_size: file.size,\r\n              upload_date: new Date().toISOString(),\r\n              blobType: file.type,\r\n              is_chunked: content.length > MAX_CONTENT_LENGTH,\r\n              original_length: content.length,\r\n              chunks_count: content.length > MAX_CONTENT_LENGTH ? Math.ceil(content.length / 8000) : 1\r\n            },\r\n            embedding: embedding\r\n          };\r\n          \r\n          await db.trainerDocuments.create(fileData);\r\n          \r\n          // Registrar en documentos_usuario_entrenador\r\n          const userTrainerDocData = {\r\n            file_id: googleFileId,\r\n            file_type: file.type,\r\n            file_name: file.name,\r\n            usuario: folder.correo || folder.folder_name,\r\n            entrenador: user.email\r\n          };\r\n          \r\n          await db.userTrainerDocuments.create(userTrainerDocData);\r\n          \r\n          // Actualizar estad√≠sticas\r\n          const embeddingSize = embedding.length * 4;\r\n          await db.users.update(user.id, {\r\n            used_storage_bytes: (userProfile.used_storage_bytes || 0) + embeddingSize\r\n          });\r\n          \r\n          newUploadProgress[fileId] = 100;\r\n          setUploadProgress({ ...newUploadProgress });\r\n          \r\n        } catch (error) {\r\n          console.error(`Error uploading file ${file.name}:`, error);\r\n          \r\n          if (error.message.includes('No se pudo procesar el archivo') || \r\n              error.message.includes('Formato de archivo no compatible')) {\r\n            toast.error(`${file.name}: ${error.message}`);\r\n          } else {\r\n            toast.error(`Error subiendo ${file.name}: ${error.message}`);\r\n          }\r\n          \r\n          newUploadProgress[fileId] = -1; // -1 indica error\r\n          setUploadProgress({ ...newUploadProgress });\r\n        }\r\n      }\r\n      \r\n      // Contar archivos exitosos y fallidos\r\n      const successfulFiles = Object.values(newUploadProgress).filter(progress => progress === 100).length;\r\n      const failedFiles = Object.values(newUploadProgress).filter(progress => progress === -1).length;\r\n      \r\n      if (successfulFiles > 0 && failedFiles === 0) {\r\n        toast.success(`${successfulFiles} archivo(s) subido(s) exitosamente`);\r\n      } else if (successfulFiles > 0 && failedFiles > 0) {\r\n        toast.success(`${successfulFiles} archivo(s) subido(s) exitosamente. ${failedFiles} archivo(s) fallaron.`);\r\n      } else if (failedFiles > 0) {\r\n        toast.error(`Todos los archivos fallaron al subirse`);\r\n      }\r\n      \r\n    } catch (error) {\r\n      console.error('Error uploading files:', error);\r\n      toast.error('Error subiendo los archivos');\r\n    } finally {\r\n      setUploading(false);\r\n    }\r\n  }, [selectedFiles, userProfile, uploadToGoogleDrive, processFileContent, createContentChunks, user.id, user.email]);\r\n\r\n  // Limpiar estado\r\n  const clearUploadState = useCallback(() => {\r\n    setSelectedFiles([]);\r\n    setUploadProgress({});\r\n    setUploading(false);\r\n  }, []);\r\n\r\n  return {\r\n    // Estado\r\n    uploading,\r\n    uploadProgress,\r\n    selectedFiles,\r\n    allowedFileTypes,\r\n    blockedExtensions,\r\n    \r\n    // Acciones\r\n    handleFileSelect,\r\n    handleUpload,\r\n    clearUploadState,\r\n    setSelectedFiles,\r\n    \r\n    // Utilidades\r\n    validateFileType\r\n  };\r\n};\r\n\r\nexport default useFileUpload;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\hooks\\usePrefetch.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'prefetchRef' is assigned a value but never used.","line":30,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":30,"endColumn":20},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect was passed a dependency list that is not an array literal. This means we can't statically verify whether you've passed the correct dependencies.","line":78,"column":6,"nodeType":"Identifier","endLine":78,"endColumn":18},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'delay', 'enabled', and 'prefetch'. Either include them or remove the dependency array.","line":78,"column":6,"nodeType":"Identifier","endLine":78,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [delay, enabled, prefetch]","fix":{"range":[1992,2004],"text":"[delay, enabled, prefetch]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'prefetchRef' is assigned a value but never used.","line":104,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":104,"endColumn":20},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'prefetch'. Either include it or remove the dependency array.","line":153,"column":6,"nodeType":"ArrayExpression","endLine":153,"endColumn":33,"suggestions":[{"desc":"Update the dependencies array to be: [enabled, prefetch, resources.length]","fix":{"range":[3991,4018],"text":"[enabled, prefetch, resources.length]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The ref value 'containerRef.current' will likely have changed by the time this effect cleanup function runs. If this ref points to a node rendered by React, copy 'containerRef.current' to a variable inside the effect, and use that variable in the cleanup function.","line":286,"column":41,"nodeType":"Identifier","endLine":286,"endColumn":48}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Prefetch Hook\r\n * Precarga datos antes de que sean necesarios\r\n * \r\n * ‚úÖ NO MODIFICA c√≥digo existente\r\n * ‚úÖ Completamente independiente\r\n * ‚úÖ Puede ser desactivado sin afectar el sistema\r\n */\r\n\r\nimport { useEffect, useCallback, useRef } from 'react'\r\nimport clientCache from '../lib/clientCache.js'\r\n\r\n/**\r\n * Hook para prefetch de datos\r\n * @param {Function} fetchFn - Funci√≥n que retorna Promise\r\n * @param {Array} dependencies - Dependencias para ejecutar prefetch\r\n * @param {Object} options - Opciones de configuraci√≥n\r\n * @returns {Object} Estado y funciones de prefetch\r\n */\r\nexport const usePrefetch = (fetchFn, dependencies = [], options = {}) => {\r\n  const {\r\n    enabled = true,\r\n    delay = 0,\r\n    cacheKey = null,\r\n    cacheTTL = 3600,\r\n    onSuccess = null,\r\n    onError = null\r\n  } = options\r\n\r\n  const prefetchRef = useRef(null)\r\n  const timeoutRef = useRef(null)\r\n\r\n  const prefetch = useCallback(async () => {\r\n    if (!enabled || !fetchFn) return\r\n\r\n    try {\r\n      // Verificar si est√° en cach√©\r\n      if (cacheKey && clientCache.has(cacheKey)) {\r\n        if (onSuccess) onSuccess(clientCache.get(cacheKey))\r\n        return\r\n      }\r\n\r\n      // Ejecutar fetch\r\n      const data = await fetchFn()\r\n\r\n      // Guardar en cach√©\r\n      if (cacheKey) {\r\n        clientCache.set(cacheKey, data, cacheTTL)\r\n      }\r\n\r\n      if (onSuccess) onSuccess(data)\r\n    } catch (error) {\r\n      console.error('Prefetch error:', error)\r\n      if (onError) onError(error)\r\n    }\r\n  }, [enabled, fetchFn, cacheKey, cacheTTL, onSuccess, onError])\r\n\r\n  useEffect(() => {\r\n    if (!enabled) return\r\n\r\n    // Limpiar timeout anterior\r\n    if (timeoutRef.current) {\r\n      clearTimeout(timeoutRef.current)\r\n    }\r\n\r\n    // Ejecutar prefetch con delay\r\n    if (delay > 0) {\r\n      timeoutRef.current = setTimeout(prefetch, delay)\r\n    } else {\r\n      prefetch()\r\n    }\r\n\r\n    return () => {\r\n      if (timeoutRef.current) {\r\n        clearTimeout(timeoutRef.current)\r\n      }\r\n    }\r\n  }, dependencies)\r\n\r\n  return {\r\n    prefetch,\r\n    cancel: () => {\r\n      if (timeoutRef.current) {\r\n        clearTimeout(timeoutRef.current)\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Hook para prefetch de m√∫ltiples recursos\r\n * @param {Array} resources - Array de recursos a prefetch\r\n * @param {Object} options - Opciones de configuraci√≥n\r\n * @returns {Object} Estado y funciones de prefetch\r\n */\r\nexport const usePrefetchMultiple = (resources = [], options = {}) => {\r\n  const {\r\n    enabled = true,\r\n    parallel = true,\r\n    onSuccess = null,\r\n    onError = null\r\n  } = options\r\n\r\n  const prefetchRef = useRef(null)\r\n\r\n  const prefetch = useCallback(async () => {\r\n    if (!enabled || !resources || resources.length === 0) return\r\n\r\n    try {\r\n      const promises = resources.map(resource => {\r\n        const { fetchFn, cacheKey, cacheTTL = 3600 } = resource\r\n\r\n        return (async () => {\r\n          try {\r\n            // Verificar cach√©\r\n            if (cacheKey && clientCache.has(cacheKey)) {\r\n              return { success: true, data: clientCache.get(cacheKey) }\r\n            }\r\n\r\n            // Fetch\r\n            const data = await fetchFn()\r\n\r\n            // Guardar en cach√©\r\n            if (cacheKey) {\r\n              clientCache.set(cacheKey, data, cacheTTL)\r\n            }\r\n\r\n            return { success: true, data }\r\n          } catch (error) {\r\n            return { success: false, error }\r\n          }\r\n        })()\r\n      })\r\n\r\n      const results = parallel\r\n        ? await Promise.all(promises)\r\n        : await promises.reduce(\r\n            (acc, promise) => acc.then(results => promise.then(r => [...results, r])),\r\n            Promise.resolve([])\r\n          )\r\n\r\n      if (onSuccess) onSuccess(results)\r\n      return results\r\n    } catch (error) {\r\n      console.error('Prefetch multiple error:', error)\r\n      if (onError) onError(error)\r\n    }\r\n  }, [enabled, resources, onSuccess, onError, parallel])\r\n\r\n  useEffect(() => {\r\n    if (!enabled) return\r\n    prefetch()\r\n  }, [enabled, resources.length])\r\n\r\n  return {\r\n    prefetch,\r\n    cancel: () => {\r\n      // Cancelar si es posible\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Hook para prefetch en hover\r\n * @param {Function} fetchFn - Funci√≥n que retorna Promise\r\n * @param {Object} options - Opciones de configuraci√≥n\r\n * @returns {Object} Handlers y estado\r\n */\r\nexport const usePrefetchOnHover = (fetchFn, options = {}) => {\r\n  const {\r\n    enabled = true,\r\n    cacheKey = null,\r\n    cacheTTL = 3600,\r\n    onSuccess = null,\r\n    onError = null,\r\n    delay = 200\r\n  } = options\r\n\r\n  const timeoutRef = useRef(null)\r\n  const prefetchRef = useRef(false)\r\n\r\n  const handleMouseEnter = useCallback(() => {\r\n    if (!enabled || !fetchFn || prefetchRef.current) return\r\n\r\n    timeoutRef.current = setTimeout(async () => {\r\n      try {\r\n        // Verificar cach√©\r\n        if (cacheKey && clientCache.has(cacheKey)) {\r\n          if (onSuccess) onSuccess(clientCache.get(cacheKey))\r\n          return\r\n        }\r\n\r\n        // Fetch\r\n        const data = await fetchFn()\r\n\r\n        // Guardar en cach√©\r\n        if (cacheKey) {\r\n          clientCache.set(cacheKey, data, cacheTTL)\r\n        }\r\n\r\n        prefetchRef.current = true\r\n        if (onSuccess) onSuccess(data)\r\n      } catch (error) {\r\n        console.error('Prefetch on hover error:', error)\r\n        if (onError) onError(error)\r\n      }\r\n    }, delay)\r\n  }, [enabled, fetchFn, cacheKey, cacheTTL, onSuccess, onError, delay])\r\n\r\n  const handleMouseLeave = useCallback(() => {\r\n    if (timeoutRef.current) {\r\n      clearTimeout(timeoutRef.current)\r\n    }\r\n  }, [])\r\n\r\n  return {\r\n    onMouseEnter: handleMouseEnter,\r\n    onMouseLeave: handleMouseLeave,\r\n    reset: () => {\r\n      prefetchRef.current = false\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Hook para prefetch en scroll\r\n * @param {Function} fetchFn - Funci√≥n que retorna Promise\r\n * @param {Object} options - Opciones de configuraci√≥n\r\n * @returns {Object} Ref y estado\r\n */\r\nexport const usePrefetchOnScroll = (fetchFn, options = {}) => {\r\n  const {\r\n    enabled = true,\r\n    cacheKey = null,\r\n    cacheTTL = 3600,\r\n    onSuccess = null,\r\n    onError = null,\r\n    threshold = 0.8\r\n  } = options\r\n\r\n  const containerRef = useRef(null)\r\n  const prefetchRef = useRef(false)\r\n\r\n  useEffect(() => {\r\n    if (!enabled || !fetchFn || !containerRef.current) return\r\n\r\n    const observer = new IntersectionObserver(\r\n      entries => {\r\n        entries.forEach(entry => {\r\n          if (entry.isIntersecting && !prefetchRef.current) {\r\n            prefetchRef.current = true\r\n\r\n            // Ejecutar prefetch\r\n            ;(async () => {\r\n              try {\r\n                // Verificar cach√©\r\n                if (cacheKey && clientCache.has(cacheKey)) {\r\n                  if (onSuccess) onSuccess(clientCache.get(cacheKey))\r\n                  return\r\n                }\r\n\r\n                // Fetch\r\n                const data = await fetchFn()\r\n\r\n                // Guardar en cach√©\r\n                if (cacheKey) {\r\n                  clientCache.set(cacheKey, data, cacheTTL)\r\n                }\r\n\r\n                if (onSuccess) onSuccess(data)\r\n              } catch (error) {\r\n                console.error('Prefetch on scroll error:', error)\r\n                if (onError) onError(error)\r\n              }\r\n            })()\r\n          }\r\n        })\r\n      },\r\n      { threshold }\r\n    )\r\n\r\n    observer.observe(containerRef.current)\r\n\r\n    return () => {\r\n      if (containerRef.current) {\r\n        observer.unobserve(containerRef.current)\r\n      }\r\n    }\r\n  }, [enabled, fetchFn, cacheKey, cacheTTL, onSuccess, onError, threshold])\r\n\r\n  return {\r\n    ref: containerRef,\r\n    reset: () => {\r\n      prefetchRef.current = false\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Hook para prefetch en idle\r\n * @param {Function} fetchFn - Funci√≥n que retorna Promise\r\n * @param {Object} options - Opciones de configuraci√≥n\r\n * @returns {Object} Estado y funciones\r\n */\r\nexport const usePrefetchOnIdle = (fetchFn, options = {}) => {\r\n  const {\r\n    enabled = true,\r\n    cacheKey = null,\r\n    cacheTTL = 3600,\r\n    onSuccess = null,\r\n    onError = null\r\n  } = options\r\n\r\n  const idleCallbackRef = useRef(null)\r\n\r\n  useEffect(() => {\r\n    if (!enabled || !fetchFn) return\r\n\r\n    // Usar requestIdleCallback si est√° disponible\r\n    if ('requestIdleCallback' in window) {\r\n      idleCallbackRef.current = requestIdleCallback(async () => {\r\n        try {\r\n          // Verificar cach√©\r\n          if (cacheKey && clientCache.has(cacheKey)) {\r\n            if (onSuccess) onSuccess(clientCache.get(cacheKey))\r\n            return\r\n          }\r\n\r\n          // Fetch\r\n          const data = await fetchFn()\r\n\r\n          // Guardar en cach√©\r\n          if (cacheKey) {\r\n            clientCache.set(cacheKey, data, cacheTTL)\r\n          }\r\n\r\n          if (onSuccess) onSuccess(data)\r\n        } catch (error) {\r\n          console.error('Prefetch on idle error:', error)\r\n          if (onError) onError(error)\r\n        }\r\n      })\r\n    } else {\r\n      // Fallback a setTimeout\r\n      idleCallbackRef.current = setTimeout(async () => {\r\n        try {\r\n          // Verificar cach√©\r\n          if (cacheKey && clientCache.has(cacheKey)) {\r\n            if (onSuccess) onSuccess(clientCache.get(cacheKey))\r\n            return\r\n          }\r\n\r\n          // Fetch\r\n          const data = await fetchFn()\r\n\r\n          // Guardar en cach√©\r\n          if (cacheKey) {\r\n            clientCache.set(cacheKey, data, cacheTTL)\r\n          }\r\n\r\n          if (onSuccess) onSuccess(data)\r\n        } catch (error) {\r\n          console.error('Prefetch on idle error:', error)\r\n          if (onError) onError(error)\r\n        }\r\n      }, 2000)\r\n    }\r\n\r\n    return () => {\r\n      if (idleCallbackRef.current) {\r\n        if ('cancelIdleCallback' in window) {\r\n          cancelIdleCallback(idleCallbackRef.current)\r\n        } else {\r\n          clearTimeout(idleCallbackRef.current)\r\n        }\r\n      }\r\n    }\r\n  }, [enabled, fetchFn, cacheKey, cacheTTL, onSuccess, onError])\r\n\r\n  return {\r\n    cancel: () => {\r\n      if (idleCallbackRef.current) {\r\n        if ('cancelIdleCallback' in window) {\r\n          cancelIdleCallback(idleCallbackRef.current)\r\n        } else {\r\n          clearTimeout(idleCallbackRef.current)\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport default usePrefetch\r\n","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\hooks\\useUserExtensions.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\hooks\\useVirtualPagination.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\index.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\auditService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\clientCache.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\databaseAdapter.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\distributedLockService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'newLock' is assigned a value but never used.","line":54,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":54,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Sistema de Locks Distribuidos para Google Drive\r\n * Previene race conditions en la creaci√≥n de carpetas\r\n */\r\n\r\nimport { supabase } from '../lib/supabaseClient.js'\r\nimport logger from './logger.js'\r\n\r\nclass DistributedLockService {\r\n  constructor() {\r\n    this.lockPrefix = 'folder_creation_lock_'\r\n    this.lockTimeout = 5 * 60 * 1000 // 5 minutos timeout\r\n    this.retryDelay = 100 // 100ms entre intentos\r\n    this.maxRetries = 10\r\n  }\r\n\r\n  /**\r\n   * Adquiere un lock para un empleado espec√≠fico\r\n   * @param {string} employeeEmail - Email del empleado\r\n   * @param {string} operation - Tipo de operaci√≥n\r\n   * @returns {Promise<string>} - ID del lock adquirido\r\n   */\r\n  async acquireLock(employeeEmail, operation = 'create_folder') {\r\n    const lockKey = `${this.lockPrefix}${employeeEmail}`\r\n    const lockId = `${operation}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n    const expiresAt = new Date(Date.now() + this.lockTimeout).toISOString()\r\n\r\n    logger.info('DistributedLockService', `üîí Intentando adquirir lock para ${employeeEmail}: ${lockId}`)\r\n\r\n    for (let attempt = 1; attempt <= this.maxRetries; attempt++) {\r\n      try {\r\n        // Verificar si existe un lock activo\r\n        const { data: existingLock } = await supabase\r\n          .from('operation_locks')\r\n          .select('*')\r\n          .eq('lock_key', lockKey)\r\n          .eq('is_active', true)\r\n          .gt('expires_at', new Date().toISOString())\r\n          .maybeSingle()\r\n\r\n        if (existingLock) {\r\n          logger.warn('DistributedLockService', `‚ö†Ô∏è Lock activo encontrado para ${employeeEmail}: ${existingLock.lock_id}`)\r\n          \r\n          if (attempt === this.maxRetries) {\r\n            throw new Error(`Lock activo no puede ser liberado despu√©s de ${this.maxRetries} intentos`)\r\n          }\r\n          \r\n          // Esperar antes del siguiente intento\r\n          await this.delay(this.retryDelay * attempt)\r\n          continue\r\n        }\r\n\r\n        // Adquirir nuevo lock\r\n        const { data: newLock, error } = await supabase\r\n          .from('operation_locks')\r\n          .insert({\r\n            lock_key: lockKey,\r\n            lock_id: lockId,\r\n            operation_type: operation,\r\n            employee_email: employeeEmail,\r\n            acquired_at: new Date().toISOString(),\r\n            expires_at: expiresAt,\r\n            is_active: true\r\n          })\r\n          .select()\r\n          .single()\r\n\r\n        if (error) {\r\n          logger.error('DistributedLockService', `‚ùå Error adquiriendo lock: ${error.message}`)\r\n          if (attempt === this.maxRetries) {\r\n            throw error\r\n          }\r\n          await this.delay(this.retryDelay * attempt)\r\n          continue\r\n        }\r\n\r\n        logger.info('DistributedLockService', `‚úÖ Lock adquirido exitosamente: ${lockId}`)\r\n        return lockId\r\n\r\n      } catch (error) {\r\n        logger.error('DistributedLockService', `‚ùå Error en intento ${attempt}: ${error.message}`)\r\n        if (attempt === this.maxRetries) {\r\n          throw error\r\n        }\r\n        await this.delay(this.retryDelay * attempt)\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Libera un lock adquirido\r\n   * @param {string} lockId - ID del lock a liberar\r\n   */\r\n  async releaseLock(lockId) {\r\n    try {\r\n      logger.info('DistributedLockService', `üîì Liberando lock: ${lockId}`)\r\n      \r\n      const { error } = await supabase\r\n        .from('operation_locks')\r\n        .update({\r\n          is_active: false,\r\n          released_at: new Date().toISOString()\r\n        })\r\n        .eq('lock_id', lockId)\r\n\r\n      if (error) {\r\n        logger.error('DistributedLockService', `‚ùå Error liberando lock: ${error.message}`)\r\n        throw error\r\n      }\r\n\r\n      logger.info('DistributedLockService', `‚úÖ Lock liberado: ${lockId}`)\r\n    } catch (error) {\r\n      logger.error('DistributedLockService', `‚ùå Error liberando lock ${lockId}: ${error.message}`)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Limpia locks expirados\r\n   */\r\n  async cleanupExpiredLocks() {\r\n    try {\r\n      logger.info('DistributedLockService', 'üßπ Limpiando locks expirados...')\r\n      \r\n      const { error } = await supabase\r\n        .from('operation_locks')\r\n        .update({\r\n          is_active: false,\r\n          released_at: new Date().toISOString()\r\n        })\r\n        .lt('expires_at', new Date().toISOString())\r\n        .eq('is_active', true)\r\n\r\n      if (error) {\r\n        logger.error('DistributedLockService', `‚ùå Error limpiando locks: ${error.message}`)\r\n        throw error\r\n      }\r\n\r\n      logger.info('DistributedLockService', '‚úÖ Locks expirados limpiados')\r\n    } catch (error) {\r\n      logger.error('DistributedLockService', `‚ùå Error en cleanup: ${error.message}`)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verifica si un empleado tiene un lock activo\r\n   * @param {string} employeeEmail - Email del empleado\r\n   * @returns {Promise<boolean>}\r\n   */\r\n  async hasActiveLock(employeeEmail) {\r\n    try {\r\n      const lockKey = `${this.lockPrefix}${employeeEmail}`\r\n      \r\n      const { data, error } = await supabase\r\n        .from('operation_locks')\r\n        .select('*')\r\n        .eq('lock_key', lockKey)\r\n        .eq('is_active', true)\r\n        .gt('expires_at', new Date().toISOString())\r\n        .maybeSingle()\r\n\r\n      if (error) {\r\n        logger.error('DistributedLockService', `‚ùå Error verificando lock: ${error.message}`)\r\n        return false\r\n      }\r\n\r\n      return !!data\r\n    } catch (error) {\r\n      logger.error('DistributedLockService', `‚ùå Error verificando lock para ${employeeEmail}: ${error.message}`)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Ejecuta una funci√≥n con lock autom√°tico\r\n   * @param {string} employeeEmail - Email del empleado\r\n   * @param {Function} fn - Funci√≥n a ejecutar\r\n   * @param {string} operation - Tipo de operaci√≥n\r\n   */\r\n  async withLock(employeeEmail, fn, operation = 'create_folder') {\r\n    let lockId = null\r\n    try {\r\n      lockId = await this.acquireLock(employeeEmail, operation)\r\n      return await fn()\r\n    } catch (error) {\r\n      logger.error('DistributedLockService', `‚ùå Error en withLock para ${employeeEmail}: ${error.message}`)\r\n      throw error\r\n    } finally {\r\n      if (lockId) {\r\n        await this.releaseLock(lockId)\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Utilidad para delays\r\n   * @param {number} ms - Milisegundos a esperar\r\n   */\r\n  delay(ms) {\r\n    return new Promise(resolve => setTimeout(resolve, ms))\r\n  }\r\n\r\n  /**\r\n   * Obtiene estad√≠sticas de locks\r\n   */\r\n  async getLockStats() {\r\n    try {\r\n      const { data: activeLocks } = await supabase\r\n        .from('operation_locks')\r\n        .select('*')\r\n        .eq('is_active', true)\r\n        .gt('expires_at', new Date().toISOString())\r\n\r\n      const { data: expiredLocks } = await supabase\r\n        .from('operation_locks')\r\n        .select('*')\r\n        .lt('expires_at', new Date().toISOString())\r\n\r\n      return {\r\n        active: activeLocks?.length || 0,\r\n        expired: expiredLocks?.length || 0,\r\n        total: (activeLocks?.length || 0) + (expiredLocks?.length || 0)\r\n      }\r\n    } catch (error) {\r\n      logger.error('DistributedLockService', `‚ùå Error obteniendo estad√≠sticas: ${error.message}`)\r\n      return { active: 0, expired: 0, total: 0 }\r\n    }\r\n  }\r\n}\r\n\r\n// Instancia singleton\r\nconst distributedLockService = new DistributedLockService()\r\n\r\nexport default distributedLockService\r\nexport { DistributedLockService }","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\driveNotificationHandler.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'event_type' is assigned a value but never used.","line":31,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":31,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'changed_files' is assigned a value but never used.","line":138,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":138,"endColumn":44},{"ruleId":"no-unused-vars","severity":1,"message":"'notification_data' is assigned a value but never used.","line":138,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":138,"endColumn":63}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Servicio para manejar las notificaciones del webhook de Google Drive\r\n// Este servicio procesa las notificaciones recibidas de n8n cuando hay cambios en las carpetas monitoreadas\r\n\r\nimport { supabase } from './supabase.js'\r\n\r\nclass DriveNotificationHandler {\r\n  constructor() {\r\n    this.isProcessing = false\r\n  }\r\n\r\n  /**\r\n   * Procesa una notificaci√≥n recibida del webhook de Google Drive\r\n   * @param {Object} notificationData - Datos de la notificaci√≥n del webhook\r\n   * @returns {Promise<Object>} Resultado del procesamiento\r\n   */\r\n  async processNotification(notificationData) {\r\n    try {\r\n      console.log('Procesando notificaci√≥n de Google Drive:', notificationData)\r\n      \r\n      // Validar datos de entrada\r\n      if (!notificationData || !notificationData.channel_id) {\r\n        throw new Error('Datos de notificaci√≥n inv√°lidos: falta channel_id')\r\n      }\r\n\r\n      const {\r\n        channel_id,\r\n        resource_id,\r\n        resource_state,\r\n        resource_uri,\r\n        changed_files = [],\r\n        event_type = 'unknown',\r\n        folder_id\r\n      } = notificationData\r\n\r\n      // Buscar el canal de watch en la base de datos\r\n      const { data: watchChannel, error: channelError } = await supabase\r\n        .from('drive_watch_channels')\r\n        .select('*')\r\n        .eq('channel_id', channel_id)\r\n        .eq('is_active', true)\r\n        .single()\r\n\r\n      if (channelError || !watchChannel) {\r\n        console.error('Canal de watch no encontrado o inactivo:', channelError)\r\n        return {\r\n          success: false,\r\n          error: 'Canal de watch no encontrado o inactivo',\r\n          channel_id\r\n        }\r\n      }\r\n\r\n      // Verificar que el canal no haya expirado\r\n      const now = Date.now()\r\n      if (watchChannel.expiration && watchChannel.expiration < now) {\r\n        console.warn('Canal de watch expirado:', channel_id)\r\n        \r\n        // Marcar canal como inactivo\r\n        await supabase\r\n          .from('drive_watch_channels')\r\n          .update({ is_active: false, updated_at: new Date().toISOString() })\r\n          .eq('id', watchChannel.id)\r\n        \r\n        return {\r\n          success: false,\r\n          error: 'Canal de watch expirado',\r\n          channel_id\r\n        }\r\n      }\r\n\r\n      // Guardar la notificaci√≥n en la base de datos\r\n      const notificationRecord = {\r\n        channel_id,\r\n        resource_id,\r\n        resource_state,\r\n        resource_uri,\r\n        changed_files: Array.isArray(changed_files) ? changed_files : [],\r\n        notification_data: notificationData,\r\n        user_id: watchChannel.user_id,\r\n        folder_id: folder_id || watchChannel.folder_id,\r\n        processed: false\r\n      }\r\n\r\n      const { data: savedNotification, error: saveError } = await supabase\r\n        .from('drive_notifications')\r\n        .insert(notificationRecord)\r\n        .select()\r\n        .single()\r\n\r\n      if (saveError) {\r\n        console.error('Error guardando notificaci√≥n:', saveError)\r\n        throw new Error(`Error guardando notificaci√≥n: ${saveError.message}`)\r\n      }\r\n\r\n      console.log('Notificaci√≥n guardada exitosamente:', savedNotification.id)\r\n\r\n      // Procesar la notificaci√≥n seg√∫n el tipo de evento\r\n      const processingResult = await this.processNotificationByType(\r\n        savedNotification,\r\n        watchChannel\r\n      )\r\n\r\n      // Marcar notificaci√≥n como procesada si fue exitosa\r\n      if (processingResult.success) {\r\n        await supabase\r\n          .from('drive_notifications')\r\n          .update({ \r\n            processed: true, \r\n            processed_at: new Date().toISOString() \r\n          })\r\n          .eq('id', savedNotification.id)\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        notification_id: savedNotification.id,\r\n        processing_result: processingResult,\r\n        channel_id\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('Error procesando notificaci√≥n:', error)\r\n      return {\r\n        success: false,\r\n        error: error.message,\r\n        channel_id: notificationData?.channel_id\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Procesa la notificaci√≥n seg√∫n el tipo de evento\r\n   * @param {Object} notification - Registro de notificaci√≥n\r\n   * @param {Object} watchChannel - Canal de watch\r\n   * @returns {Promise<Object>} Resultado del procesamiento espec√≠fico\r\n   */\r\n  async processNotificationByType(notification, watchChannel) {\r\n    try {\r\n      const { resource_state, changed_files, notification_data } = notification\r\n      \r\n      console.log(`Procesando evento tipo: ${resource_state}`)\r\n\r\n      switch (resource_state) {\r\n        case 'add':\r\n          return await this.handleFileAdded(notification, watchChannel)\r\n        \r\n        case 'remove':\r\n        case 'trash':\r\n          return await this.handleFileRemoved(notification, watchChannel)\r\n        \r\n        case 'update':\r\n          return await this.handleFileUpdated(notification, watchChannel)\r\n        \r\n        case 'move':\r\n          return await this.handleFileMoved(notification, watchChannel)\r\n        \r\n        case 'sync':\r\n          return await this.handleSyncEvent(notification, watchChannel)\r\n        \r\n        default:\r\n          console.log(`Tipo de evento no manejado: ${resource_state}`)\r\n          return {\r\n            success: true,\r\n            message: `Evento ${resource_state} registrado pero no procesado`,\r\n            action: 'logged_only'\r\n          }\r\n      }\r\n    } catch (error) {\r\n      console.error('Error en procesamiento espec√≠fico:', error)\r\n      return {\r\n        success: false,\r\n        error: error.message,\r\n        action: 'error'\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Maneja eventos de archivos agregados\r\n   */\r\n  async handleFileAdded(notification, watchChannel) {\r\n    console.log('Procesando archivo agregado:', notification.changed_files)\r\n    \r\n    // Aqu√≠ puedes agregar l√≥gica espec√≠fica para archivos agregados\r\n    // Por ejemplo: actualizar contadores, enviar notificaciones, etc.\r\n    \r\n    return {\r\n      success: true,\r\n      message: 'Archivo agregado procesado',\r\n      action: 'file_added',\r\n      files_count: notification.changed_files?.length || 0\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Maneja eventos de archivos eliminados\r\n   */\r\n  async handleFileRemoved(notification, watchChannel) {\r\n    console.log('Procesando archivo eliminado:', notification.changed_files)\r\n    \r\n    return {\r\n      success: true,\r\n      message: 'Archivo eliminado procesado',\r\n      action: 'file_removed',\r\n      files_count: notification.changed_files?.length || 0\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Maneja eventos de archivos actualizados\r\n   */\r\n  async handleFileUpdated(notification, watchChannel) {\r\n    console.log('Procesando archivo actualizado:', notification.changed_files)\r\n    \r\n    return {\r\n      success: true,\r\n      message: 'Archivo actualizado procesado',\r\n      action: 'file_updated',\r\n      files_count: notification.changed_files?.length || 0\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Maneja eventos de archivos movidos\r\n   */\r\n  async handleFileMoved(notification, watchChannel) {\r\n    console.log('Procesando archivo movido:', notification.changed_files)\r\n    \r\n    return {\r\n      success: true,\r\n      message: 'Archivo movido procesado',\r\n      action: 'file_moved',\r\n      files_count: notification.changed_files?.length || 0\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Maneja eventos de sincronizaci√≥n\r\n   */\r\n  async handleSyncEvent(notification, watchChannel) {\r\n    console.log('Procesando evento de sincronizaci√≥n')\r\n    \r\n    return {\r\n      success: true,\r\n      message: 'Evento de sincronizaci√≥n procesado',\r\n      action: 'sync_processed'\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene notificaciones pendientes para un usuario\r\n   * @param {string} userId - ID del usuario\r\n   * @param {number} limit - L√≠mite de resultados\r\n   * @returns {Promise<Array>} Lista de notificaciones pendientes\r\n   */\r\n  async getPendingNotifications(userId, limit = 50) {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('drive_notifications')\r\n        .select(`\r\n          *,\r\n          drive_watch_channels!inner(\r\n            folder_id,\r\n            user_id\r\n          )\r\n        `)\r\n        .eq('drive_watch_channels.user_id', userId)\r\n        .eq('processed', false)\r\n        .order('created_at', { ascending: false })\r\n        .limit(limit)\r\n\r\n      if (error) {\r\n        console.error('Error obteniendo notificaciones pendientes:', error)\r\n        return []\r\n      }\r\n\r\n      return data || []\r\n    } catch (error) {\r\n      console.error('Error en getPendingNotifications:', error)\r\n      return []\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Marca m√∫ltiples notificaciones como procesadas\r\n   * @param {Array<string>} notificationIds - IDs de las notificaciones\r\n   * @returns {Promise<Object>} Resultado de la operaci√≥n\r\n   */\r\n  async markNotificationsAsProcessed(notificationIds) {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('drive_notifications')\r\n        .update({ \r\n          processed: true, \r\n          processed_at: new Date().toISOString() \r\n        })\r\n        .in('id', notificationIds)\r\n        .select()\r\n\r\n      if (error) {\r\n        console.error('Error marcando notificaciones como procesadas:', error)\r\n        return { success: false, error: error.message }\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        updated_count: data?.length || 0,\r\n        updated_notifications: data\r\n      }\r\n    } catch (error) {\r\n      console.error('Error en markNotificationsAsProcessed:', error)\r\n      return { success: false, error: error.message }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Simula el procesamiento de un webhook (para testing)\r\n   * Esta funci√≥n simula lo que har√≠a n8n al recibir una notificaci√≥n de Google Drive\r\n   * @param {Object} webhookPayload - Payload del webhook\r\n   * @returns {Promise<Object>} Resultado del procesamiento\r\n   */\r\n  async simulateWebhookProcessing(webhookPayload) {\r\n    console.log('Simulando procesamiento de webhook:', webhookPayload)\r\n    \r\n    // Transformar el payload del webhook al formato esperado\r\n    const notificationData = {\r\n      channel_id: webhookPayload.channelId || webhookPayload.channel_id,\r\n      resource_id: webhookPayload.resourceId || webhookPayload.resource_id,\r\n      resource_state: webhookPayload.resourceState || webhookPayload.resource_state || 'update',\r\n      resource_uri: webhookPayload.resourceUri || webhookPayload.resource_uri,\r\n      event_type: webhookPayload.eventType || webhookPayload.event_type || 'change',\r\n      folder_id: webhookPayload.folderId || webhookPayload.folder_id,\r\n      changed_files: webhookPayload.changedFiles || webhookPayload.changed_files || [],\r\n      timestamp: webhookPayload.timestamp || Date.now()\r\n    }\r\n\r\n    return await this.processNotification(notificationData)\r\n  }\r\n}\r\n\r\nexport default DriveNotificationHandler","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\driveNotificationProcessor.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\driveWatchService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\emailService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\embeddings.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'groqService' is defined but never used.","line":3,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'totalTokensFromPlan' is assigned a value but never used.","line":436,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":436,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Servicio de embeddings y tracking de tokens\r\nimport { supabase } from './supabase.js';\r\nimport groqService from '../services/groqService.js';\r\n\r\nclass EmbeddingsService {\r\n  constructor() {\r\n    // Inicializar groqService de forma diferida para evitar dependencia circular\r\n    this._groq = null;\r\n    // Cache para evitar consultas excesivas\r\n    this.cache = new Map();\r\n    this.cacheTimeout = 30000; // 30 segundos\r\n  }\r\n\r\n  // Getter para obtener groqService de forma diferida\r\n  get groq() {\r\n    if (!this._groq) {\r\n      this._groq = require('../services/groqService.js').default;\r\n    }\r\n    return this._groq;\r\n  }\r\n\r\n  // Generar embeddings para texto\r\n  async generateEmbedding(text, userId) {\r\n    try {\r\n      // Usar el servicio de embeddings actualizado que usa Groq\r\n      const { default: embeddingService } = await import('../services/embeddingService.js');\r\n      const embedding = await embeddingService.generateEmbedding(text);\r\n\r\n      const tokensUsed = Math.ceil(text.length / 4); // Approximate token count\r\n\r\n      // Registrar uso de tokens\r\n      await this.trackTokenUsage(userId, tokensUsed, 'embedding');\r\n\r\n      return {\r\n        embedding: embedding,\r\n        tokens_used: tokensUsed\r\n      };\r\n    } catch (error) {\r\n      console.error('Error generando embedding:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n      // Dividir texto en chunks\r\n  // Dividir texto en chunks\r\n  splitTextIntoChunks(text, maxLength = 8000) {\r\n    const chunks = [];\r\n    let currentChunk = '';\r\n    const sentences = text.split(/[.!?]+/);\r\n\r\n    for (const sentence of sentences) {\r\n      if ((currentChunk + sentence).length > maxLength) {\r\n        if (currentChunk) {\r\n          chunks.push(currentChunk.trim());\r\n          currentChunk = sentence;\r\n        } else {\r\n          // Si una sola oraci√≥n es muy larga, dividirla por palabras\r\n          const words = sentence.split(' ');\r\n          let wordChunk = '';\r\n          for (const word of words) {\r\n            if ((wordChunk + ' ' + word).length > maxLength) {\r\n              if (wordChunk) {\r\n                chunks.push(wordChunk.trim());\r\n                wordChunk = word;\r\n              } else {\r\n                chunks.push(word);\r\n              }\r\n            } else {\r\n              wordChunk += (wordChunk ? ' ' : '') + word;\r\n            }\r\n          }\r\n          if (wordChunk) {\r\n            currentChunk = wordChunk;\r\n          }\r\n        }\r\n      } else {\r\n        currentChunk += (currentChunk ? '. ' : '') + sentence;\r\n      }\r\n    }\r\n\r\n    if (currentChunk) {\r\n      chunks.push(currentChunk.trim());\r\n    }\r\n\r\n    return chunks.filter(chunk => chunk.length > 0);\r\n  }\r\n\r\n  // Buscar contenido similar usando embeddings (solo en documentos_entrenador)\r\n  async searchSimilarContent(query, userId, limit = 10, filters = {}) {\r\n    try {\r\n      // Generar embedding para la consulta\r\n      const queryEmbedding = await this.generateEmbedding(query, userId);\r\n\r\n      // Preparar filtro\r\n      const filter = {};\r\n\r\n      // Filtro por empresa\r\n      if (filters.company && filters.company !== 'all' && filters.company !== '') {\r\n        filter.company = filters.company;\r\n      }\r\n\r\n      // Filtro por tipo de archivo\r\n      if (filters.file_type && filters.file_type !== 'all' && filters.file_type !== '') {\r\n        filter.file_type = filters.file_type;\r\n      }\r\n\r\n      // Filtro por usuario/correo\r\n      if (filters.correo && filters.correo !== 'all' && filters.correo !== '') {\r\n        filter.correo = filters.correo;\r\n      }\r\n      if (filters.user_email && filters.user_email !== 'all' && filters.user_email !== '') {\r\n        filter.correo = filters.user_email;\r\n      }\r\n\r\n      // Filtro por nombre de archivo\r\n      if (filters.file_name && filters.file_name !== '') {\r\n        filter.file_name = filters.file_name;\r\n      }\r\n\r\n      // Filtros de tama√±o de archivo\r\n      if (filters.min_file_size && filters.min_file_size !== '') {\r\n        filter.min_file_size = parseInt(filters.min_file_size) * 1024; // Convertir KB a bytes\r\n      }\r\n      if (filters.max_file_size && filters.max_file_size !== '') {\r\n        filter.max_file_size = parseInt(filters.max_file_size) * 1024; // Convertir KB a bytes\r\n      }\r\n\r\n      // Filtro por palabras clave\r\n      if (filters.keywords && filters.keywords !== '') {\r\n        filter.keywords = filters.keywords.split(',').map(k => k.trim()).filter(k => k.length > 0);\r\n      }\r\n\r\n      // Filtro por relevancia m√≠nima\r\n      if (filters.min_relevance && filters.min_relevance !== '') {\r\n        filter.min_relevance = parseFloat(filters.min_relevance);\r\n      }\r\n\r\n      // Filtros de fecha\r\n      if (filters.date_from) {\r\n        filter.date_from = filters.date_from;\r\n      }\r\n      if (filters.date_to) {\r\n        filter.date_to = filters.date_to;\r\n      }\r\n\r\n      // Buscar en documentos_entrenador (incluye documentos principales y chunks)\r\n      const { data: documents, error: searchError } = await supabase\r\n        .rpc('match_documentos_entrenador', {\r\n          filter: filter,\r\n          match_count: limit,\r\n          query_embedding: queryEmbedding.embedding\r\n        });\r\n\r\n      if (searchError) {\r\n        console.error('Error searching documents:', searchError);\r\n        throw searchError;\r\n      }\r\n\r\n      // Procesar y formatear resultados\r\n      let results = documents ? documents.map(doc => {\r\n        const metadata = doc.metadata || {};\r\n        const isChunk = metadata.chunk_type === 'chunk';\r\n\r\n        return {\r\n          content: doc.content,\r\n          file_name: metadata.name || 'Documento sin nombre',\r\n          similarity: doc.similarity,\r\n          source: isChunk ? 'chunk' : 'main_document',\r\n          file_id: metadata.file_id,\r\n          chunk_index: metadata.chunk_index || null,\r\n          chunk_info: isChunk ? metadata.chunk_of_total : null,\r\n          parent_file_id: metadata.parent_file_id || null,\r\n          upload_date: metadata.upload_date,\r\n          file_type: metadata.file_type,\r\n          file_size: metadata.file_size || 0,\r\n          user_email: metadata.correo || metadata.user_email\r\n        };\r\n      }) : [];\r\n\r\n      // Aplicar filtros adicionales que no se pueden hacer en SQL\r\n      if (filters.min_relevance && filters.min_relevance > 0) {\r\n        results = results.filter(result => result.similarity >= filters.min_relevance);\r\n      }\r\n\r\n      if (filters.keywords && filters.keywords.length > 0) {\r\n        results = results.filter(result => {\r\n          const content = result.content.toLowerCase();\r\n          return filters.keywords.some(keyword =>\r\n            content.includes(keyword.toLowerCase())\r\n          );\r\n        });\r\n      }\r\n\r\n      // Ordenar por similitud (ya viene ordenado de la funci√≥n SQL, pero por seguridad)\r\n      results.sort((a, b) => b.similarity - a.similarity);\r\n      \r\n      console.log(`üîç B√∫squeda completada: ${results.length} resultados encontrados`);\r\n      return results;\r\n\r\n    } catch (error) {\r\n      console.error('Error searching similar content:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Registrar uso de tokens\r\n  async trackTokenUsage(userId, tokensUsed, operation) {\r\n    try {\r\n      // Primero verificamos si ya existe un registro para este usuario\r\n      const { data: existingRecord, error: fetchError } = await supabase\r\n        .from('user_tokens_usage')\r\n        .select('tokens_used, total_tokens')\r\n        .eq('user_id', userId)\r\n        .maybeSingle();\r\n\r\n      if (fetchError && fetchError.code !== 'PGRST116') {\r\n        throw fetchError;\r\n      }\r\n\r\n      if (existingRecord) {\r\n        // Si existe, actualizamos el contador sumando los nuevos tokens\r\n        const { error } = await supabase\r\n          .from('user_tokens_usage')\r\n          .update({\r\n            tokens_used: existingRecord.tokens_used + tokensUsed,\r\n            operation: operation,\r\n            last_updated_at: new Date().toISOString()\r\n          })\r\n          .eq('user_id', userId);\r\n\r\n        if (error) {\r\n          throw error;\r\n        }\r\n      } else {\r\n        // Si no existe, insertamos un nuevo registro con l√≠mite del plan\r\n        // Obtener l√≠mite del plan del usuario\r\n        const { data: userData } = await supabase\r\n          .from('users')\r\n          .select('current_plan_id')\r\n          .eq('id', userId)\r\n          .maybeSingle();\r\n        \r\n        let totalTokens = 1000; // valor por defecto\r\n        if (userData?.current_plan_id) {\r\n          const { data: planData } = await supabase\r\n            .from('plans')\r\n            .select('token_limit_usage')\r\n            .eq('id', userData.current_plan_id)\r\n            .maybeSingle();\r\n          totalTokens = planData?.token_limit_usage || 1000;\r\n        }\r\n\r\n        const { error } = await supabase\r\n          .from('user_tokens_usage')\r\n          .insert({\r\n            user_id: userId,\r\n            tokens_used: tokensUsed,\r\n            total_tokens: totalTokens,\r\n            operation: operation,\r\n            created_at: new Date().toISOString(),\r\n            last_updated_at: new Date().toISOString()\r\n          });\r\n\r\n        if (error) {\r\n          throw error;\r\n        }\r\n      }\r\n\r\n      // ELIMINADO: No llamar a updateUserTokenCount para evitar duplicaci√≥n\r\n      console.log(`Token usage tracked: ${tokensUsed} tokens for operation: ${operation}`);\r\n    } catch (error) {\r\n      console.error('Error tracking token usage:', error);\r\n    }\r\n  }\r\n\r\n  // Actualizar contador total de tokens del usuario\r\n  async updateUserTokenCount(userId, tokensUsed) {\r\n    try {\r\n      const { data: tokenUsage, error: fetchError } = await supabase\r\n        .from('user_tokens_usage')\r\n        .select('tokens_used, total_tokens')\r\n        .eq('user_id', userId)\r\n        .maybeSingle();\r\n\r\n      if (fetchError && fetchError.code !== 'PGRST116') {\r\n        throw fetchError;\r\n      }\r\n\r\n      if (tokenUsage) {\r\n        // Actualizar registro existente - solo incrementar tokens_used\r\n        const newTokensUsed = (tokenUsage.tokens_used || 0) + tokensUsed;\r\n        const { error: updateError } = await supabase\r\n          .from('user_tokens_usage')\r\n          .update({ \r\n            tokens_used: newTokensUsed,\r\n            last_updated_at: new Date().toISOString()\r\n          })\r\n          .eq('user_id', userId);\r\n\r\n        if (updateError) {\r\n          throw updateError;\r\n        }\r\n      } else {\r\n        // Crear nuevo registro - inicializar con tokens_used y total_tokens por defecto\r\n        const { error: insertError } = await supabase\r\n          .from('user_tokens_usage')\r\n          .insert({\r\n            user_id: userId,\r\n            tokens_used: tokensUsed,\r\n            total_tokens: 1000, // tokens por defecto del plan gratuito\r\n            last_updated_at: new Date().toISOString()\r\n          });\r\n\r\n        if (insertError) {\r\n          throw insertError;\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Error updating user token count:', error);\r\n    }\r\n  }\r\n\r\n  // Obtener estad√≠sticas de uso de tokens con cache\r\n  async getTokenUsageStats(userId, period = '30 days') {\r\n    const cacheKey = `token_stats_${userId}`;\r\n    const cached = this.cache.get(cacheKey);\r\n    \r\n    // Verificar cache\r\n    if (cached && (Date.now() - cached.timestamp) < this.cacheTimeout) {\r\n      return cached.data;\r\n    }\r\n    \r\n    try {\r\n      // Obtener el total de tokens usados con maybeSingle para evitar errores\r\n      const { data: totalData, error: totalError } = await supabase\r\n        .from('user_tokens_usage')\r\n        .select('tokens_used')\r\n        .eq('user_id', userId)\r\n        .limit(1)\r\n        .maybeSingle();\r\n\r\n      if (totalError) {\r\n        console.warn('Error getting total tokens used:', totalError);\r\n      }\r\n\r\n      const totalTokensUsed = totalData?.tokens_used || 0;\r\n\r\n      // Obtener solo los √∫ltimos 10 registros para reducir carga\r\n      const { data: recentData, error: recentError } = await supabase\r\n        .from('user_tokens_usage')\r\n        .select('tokens_used, operation, created_at')\r\n        .eq('user_id', userId)\r\n        .not('tokens_used', 'is', null)\r\n        .order('created_at', { ascending: false })\r\n        .limit(10);\r\n\r\n      if (recentError) {\r\n        console.warn('Error getting recent token usage:', recentError);\r\n      }\r\n\r\n      const records = recentData || [];\r\n\r\n      // Agrupar por operaci√≥n solo los registros recientes\r\n      const stats = records.reduce((acc, record) => {\r\n        const operation = record.operation || 'unknown';\r\n        if (!acc[operation]) {\r\n          acc[operation] = {\r\n            total_tokens: 0,\r\n            count: 0\r\n          };\r\n        }\r\n        acc[operation].total_tokens += record.tokens_used || 0;\r\n        acc[operation].count += 1;\r\n        return acc;\r\n      }, {});\r\n\r\n      const result = {\r\n        total_tokens: totalTokensUsed,\r\n        by_operation: stats,\r\n        records: records\r\n      };\r\n      \r\n      // Guardar en cache\r\n      this.cache.set(cacheKey, {\r\n        data: result,\r\n        timestamp: Date.now()\r\n      });\r\n      \r\n      return result;\r\n    } catch (error) {\r\n      console.error('Error getting token usage stats:', error);\r\n      // Retornar datos por defecto en caso de error\r\n      const defaultResult = {\r\n        total_tokens: 0,\r\n        by_operation: {},\r\n        records: []\r\n      };\r\n      \r\n      // Guardar resultado por defecto en cache para evitar consultas repetidas\r\n      this.cache.set(cacheKey, {\r\n        data: defaultResult,\r\n        timestamp: Date.now()\r\n      });\r\n      \r\n      return defaultResult;\r\n    }\r\n  }\r\n\r\n  // Verificar l√≠mites de tokens seg√∫n el plan con cache\r\n  async checkTokenLimits(userId) {\r\n    const cacheKey = `token_limits_${userId}`;\r\n    const cached = this.cache.get(cacheKey);\r\n    \r\n    // Verificar cache\r\n    if (cached && (Date.now() - cached.timestamp) < this.cacheTimeout) {\r\n      console.log('EmbeddingsService: Returning cached token limits:', cached.data);\r\n      return cached.data;\r\n    }\r\n    \r\n    console.log('EmbeddingsService: Cache miss or expired, fetching fresh token limits for userId:', userId);\r\n    \r\n    try {\r\n      // Obtener tokens usados con maybeSingle para evitar errores\r\n      const { data: tokenUsage, error: tokenError } = await supabase\r\n        .from('user_tokens_usage')\r\n        .select('total_tokens, tokens_used')\r\n        .eq('user_id', userId)\r\n        .limit(1)\r\n        .maybeSingle();\r\n\r\n      if (tokenError) {\r\n        console.warn('Error getting token usage:', tokenError);\r\n      }\r\n\r\n      const tokensUsed = tokenUsage?.tokens_used || 0;\r\n      const totalTokensFromPlan = tokenUsage?.total_tokens || 0;\r\n\r\n      // Obtener informaci√≥n del usuario y su plan\r\n      console.log('EmbeddingsService: Fetching user and plan data for userId:', userId);\r\n      const { data: user, error: userError } = await supabase\r\n        .from('users')\r\n        .select(`\r\n          current_plan_id,\r\n          is_active,\r\n          plans!inner(\r\n            token_limit_usage\r\n          )\r\n        `)\r\n        .eq('id', userId)\r\n        .maybeSingle();\r\n\r\n      console.log('EmbeddingsService: User query result:', { user, userError });\r\n\r\n      if (userError) {\r\n        console.warn('Error getting user info:', userError);\r\n      }\r\n\r\n      // Usar el l√≠mite de tokens del plan como fuente de verdad\r\n      let tokenLimit = user?.plans?.token_limit_usage || 1000; // valor por defecto para plan gratuito\r\n      console.log('EmbeddingsService: Token limit determined:', tokenLimit, 'from plan:', user?.plans?.token_limit_usage);\r\n\r\n      const result = {\r\n        tokens_used: tokensUsed,\r\n        token_limit: tokenLimit,\r\n        remaining_tokens: Math.max(0, tokenLimit - tokensUsed),\r\n        usage_percentage: Math.min(100, (tokensUsed / tokenLimit) * 100)\r\n      };\r\n      \r\n      // Guardar en cache\r\n      this.cache.set(cacheKey, {\r\n        data: result,\r\n        timestamp: Date.now()\r\n      });\r\n      \r\n      return result;\r\n    } catch (error) {\r\n      console.error('Error checking token limits:', error);\r\n      // Retornar l√≠mites por defecto en caso de error\r\n      const defaultResult = {\r\n        tokens_used: 0,\r\n        token_limit: 1000,\r\n        remaining_tokens: 1000,\r\n        usage_percentage: 0\r\n      };\r\n      \r\n      // Guardar resultado por defecto en cache\r\n      this.cache.set(cacheKey, {\r\n        data: defaultResult,\r\n        timestamp: Date.now()\r\n      });\r\n      \r\n      return defaultResult;\r\n    }\r\n  }\r\n}\r\n\r\nconst embeddingsService = new EmbeddingsService();\r\nexport default embeddingsService;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\encryptionService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\errorHandler.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\forcedSupabaseClient.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\googleDrive.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\googleDriveAuthService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'createClient' is defined but never used.","line":7,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":314,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":314,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Google Drive Authentication Service\r\n * Gesti√≥n centralizada de tokens OAuth con validaci√≥n de expiraci√≥n y refresh autom√°tico\r\n */\r\n\r\nimport logger from './logger.js'\r\nimport { createClient } from '@supabase/supabase-js'\r\n\r\nclass GoogleDriveAuthService {\r\n  constructor() {\r\n    this.accessToken = null\r\n    this.refreshToken = null\r\n    this.expiresAt = null\r\n    this.initialized = false\r\n    this.tokenRefreshTimeout = null\r\n    this.authCallbacks = []\r\n    this.supabase = null\r\n    this.currentUserId = null\r\n  }\r\n\r\n  /**\r\n   * Inicializa la conexi√≥n a Supabase\r\n   */\r\n  initializeSupabase(supabaseClient, userId) {\r\n    this.supabase = supabaseClient\r\n    this.currentUserId = userId\r\n    logger.info('GoogleDriveAuthService', `üîó Supabase inicializado para usuario ${userId}`)\r\n  }\r\n\r\n  /**\r\n   * Inicializa el servicio restaurando tokens de localStorage\r\n   */\r\n  async initialize() {\r\n    try {\r\n      logger.info('GoogleDriveAuthService', 'üîÑ Inicializando servicio de autenticaci√≥n...')\r\n      \r\n      const savedTokens = localStorage.getItem('google_drive_auth')\r\n      if (savedTokens) {\r\n        try {\r\n          const tokens = JSON.parse(savedTokens)\r\n          logger.info('GoogleDriveAuthService', 'üì¶ Tokens encontrados en localStorage')\r\n          \r\n          // Validar si el token a√∫n es v√°lido\r\n          if (this.isTokenValid(tokens)) {\r\n            this.setTokens(tokens)\r\n            logger.info('GoogleDriveAuthService', '‚úÖ Token v√°lido restaurado')\r\n            this.initialized = true\r\n            return true\r\n          } else if (tokens.refresh_token) {\r\n            // Intentar refresh autom√°tico\r\n            logger.info('GoogleDriveAuthService', 'üîÑ Token expirado, intentando refresh...')\r\n            const refreshed = await this.refreshAccessToken(tokens.refresh_token)\r\n            if (refreshed) {\r\n              logger.info('GoogleDriveAuthService', '‚úÖ Token refrescado exitosamente')\r\n              this.initialized = true\r\n              return true\r\n            }\r\n          }\r\n          \r\n          // Si llegamos aqu√≠, los tokens no son v√°lidos\r\n          logger.warn('GoogleDriveAuthService', '‚ö†Ô∏è Tokens inv√°lidos o expirados')\r\n          localStorage.removeItem('google_drive_auth')\r\n        } catch (error) {\r\n          logger.error('GoogleDriveAuthService', `‚ùå Error restaurando tokens: ${error.message}`)\r\n          localStorage.removeItem('google_drive_auth')\r\n        }\r\n      }\r\n      \r\n      this.initialized = true\r\n      logger.info('GoogleDriveAuthService', '‚úÖ Servicio inicializado (sin tokens)')\r\n      return false\r\n    } catch (error) {\r\n      logger.error('GoogleDriveAuthService', `‚ùå Error inicializando: ${error.message}`)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Valida si un token a√∫n es v√°lido\r\n   */\r\n  isTokenValid(tokens) {\r\n    if (!tokens || !tokens.access_token) {\r\n      return false\r\n    }\r\n    \r\n    if (!tokens.expires_at) {\r\n      return false\r\n    }\r\n    \r\n    // Considerar token v√°lido si expira en m√°s de 5 minutos\r\n    const now = Date.now()\r\n    const expiresAt = new Date(tokens.expires_at).getTime()\r\n    const bufferMs = 5 * 60 * 1000 // 5 minutos\r\n    \r\n    return expiresAt > (now + bufferMs)\r\n  }\r\n\r\n  /**\r\n   * Establece los tokens y configura refresh autom√°tico\r\n   */\r\n  setTokens(tokens) {\r\n    try {\r\n      this.accessToken = tokens.access_token\r\n      this.refreshToken = tokens.refresh_token\r\n      \r\n      // Calcular expiraci√≥n si no viene en los tokens\r\n      if (!tokens.expires_at && tokens.expires_in) {\r\n        const expiresAt = new Date(Date.now() + tokens.expires_in * 1000)\r\n        this.expiresAt = expiresAt\r\n        tokens.expires_at = expiresAt.toISOString()\r\n      } else if (tokens.expires_at) {\r\n        this.expiresAt = new Date(tokens.expires_at)\r\n      }\r\n      \r\n      // Guardar en localStorage\r\n      localStorage.setItem('google_drive_auth', JSON.stringify({\r\n        access_token: this.accessToken,\r\n        refresh_token: this.refreshToken,\r\n        expires_at: this.expiresAt?.toISOString(),\r\n        expires_in: tokens.expires_in\r\n      }))\r\n      \r\n      logger.info('GoogleDriveAuthService', `‚úÖ Tokens guardados (expira en ${this.getTimeUntilExpiry()}ms)`)\r\n      \r\n      // Configurar refresh autom√°tico\r\n      this.scheduleTokenRefresh()\r\n      \r\n      // Notificar callbacks\r\n      this.notifyAuthCallbacks('authenticated')\r\n    } catch (error) {\r\n      logger.error('GoogleDriveAuthService', `‚ùå Error guardando tokens: ${error.message}`)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Refresca el access token usando el refresh token\r\n   */\r\n  async refreshAccessToken(refreshToken) {\r\n    try {\r\n      logger.info('GoogleDriveAuthService', 'üîÑ Refrescando access token...')\r\n      \r\n      const response = await fetch('https://oauth2.googleapis.com/token', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/x-www-form-urlencoded'\r\n        },\r\n        body: new URLSearchParams({\r\n          client_id: process.env.REACT_APP_GOOGLE_CLIENT_ID,\r\n          client_secret: process.env.REACT_APP_GOOGLE_CLIENT_SECRET,\r\n          refresh_token: refreshToken,\r\n          grant_type: 'refresh_token'\r\n        })\r\n      })\r\n      \r\n      if (!response.ok) {\r\n        const errorData = await response.text()\r\n        logger.error('GoogleDriveAuthService', `‚ùå Error refrescando token: ${response.status} - ${errorData}`)\r\n        \r\n        // Si el refresh token es inv√°lido, limpiar\r\n        if (response.status === 400 || response.status === 401) {\r\n          this.clearTokens()\r\n        }\r\n        \r\n        return false\r\n      }\r\n      \r\n      const tokens = await response.json()\r\n      \r\n      if (tokens.error) {\r\n        logger.error('GoogleDriveAuthService', `‚ùå Error en respuesta: ${tokens.error}`)\r\n        this.clearTokens()\r\n        return false\r\n      }\r\n      \r\n      // Mantener el refresh token original si no viene uno nuevo\r\n      if (!tokens.refresh_token) {\r\n        tokens.refresh_token = refreshToken\r\n      }\r\n      \r\n      this.setTokens(tokens)\r\n      logger.info('GoogleDriveAuthService', '‚úÖ Token refrescado exitosamente')\r\n      return true\r\n    } catch (error) {\r\n      logger.error('GoogleDriveAuthService', `‚ùå Error en refresh: ${error.message}`)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Programa el refresh autom√°tico del token\r\n   */\r\n  scheduleTokenRefresh() {\r\n    // Limpiar timeout anterior\r\n    if (this.tokenRefreshTimeout) {\r\n      clearTimeout(this.tokenRefreshTimeout)\r\n    }\r\n    \r\n    if (!this.expiresAt || !this.refreshToken) {\r\n      return\r\n    }\r\n    \r\n    // Refrescar 5 minutos antes de que expire\r\n    const now = Date.now()\r\n    const expiresAt = this.expiresAt.getTime()\r\n    const bufferMs = 5 * 60 * 1000 // 5 minutos\r\n    const refreshAt = expiresAt - bufferMs - now\r\n    \r\n    if (refreshAt > 0) {\r\n      logger.info('GoogleDriveAuthService', `‚è∞ Refresh programado en ${refreshAt}ms`)\r\n      \r\n      this.tokenRefreshTimeout = setTimeout(async () => {\r\n        logger.info('GoogleDriveAuthService', '‚è∞ Ejecutando refresh autom√°tico...')\r\n        await this.refreshAccessToken(this.refreshToken)\r\n      }, refreshAt)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene el tiempo hasta que expire el token (en ms)\r\n   */\r\n  getTimeUntilExpiry() {\r\n    if (!this.expiresAt) {\r\n      return null\r\n    }\r\n    \r\n    const now = Date.now()\r\n    const expiresAt = this.expiresAt.getTime()\r\n    return Math.max(0, expiresAt - now)\r\n  }\r\n\r\n  /**\r\n   * Intercambia un c√≥digo de autorizaci√≥n por tokens\r\n   */\r\n  async exchangeCodeForTokens(code) {\r\n    try {\r\n      logger.info('GoogleDriveAuthService', `üîÑ Intercambiando c√≥digo por tokens...`)\r\n      \r\n      const redirectUri = process.env.REACT_APP_GOOGLE_REDIRECT_URI ||\r\n                         (window.location.hostname === 'localhost' ?\r\n                          'http://localhost:3000/auth/google/callback' :\r\n                          `${window.location.origin}/auth/google/callback`)\r\n      \r\n      logger.info('GoogleDriveAuthService', `üìç Redirect URI: ${redirectUri}`)\r\n      \r\n      const response = await fetch('https://oauth2.googleapis.com/token', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/x-www-form-urlencoded'\r\n        },\r\n        body: new URLSearchParams({\r\n          client_id: process.env.REACT_APP_GOOGLE_CLIENT_ID,\r\n          client_secret: process.env.REACT_APP_GOOGLE_CLIENT_SECRET,\r\n          code: code,\r\n          grant_type: 'authorization_code',\r\n          redirect_uri: redirectUri\r\n        })\r\n      })\r\n      \r\n      if (!response.ok) {\r\n        const errorData = await response.text()\r\n        logger.error('GoogleDriveAuthService', `‚ùå Error intercambiando c√≥digo: ${response.status} - ${errorData}`)\r\n        \r\n        if (response.status === 400) {\r\n          throw new Error('C√≥digo de autorizaci√≥n inv√°lido o expirado. Por favor, intenta conectar Google Drive nuevamente.')\r\n        } else if (response.status === 401) {\r\n          throw new Error('Credenciales de Google inv√°lidas. Verifica la configuraci√≥n del proyecto.')\r\n        } else {\r\n          throw new Error(`Error de conexi√≥n con Google (${response.status}). Intenta nuevamente.`)\r\n        }\r\n      }\r\n      \r\n      const tokens = await response.json()\r\n      \r\n      if (tokens.error) {\r\n        logger.error('GoogleDriveAuthService', `‚ùå Error en respuesta: ${tokens.error}`)\r\n        throw new Error(`Google API error: ${tokens.error}`)\r\n      }\r\n      \r\n      this.setTokens(tokens)\r\n      logger.info('GoogleDriveAuthService', '‚úÖ Tokens obtenidos exitosamente')\r\n      \r\n      // Guardar en Supabase\r\n      await this.saveCredentialsToSupabase(tokens)\r\n      \r\n      return tokens\r\n    } catch (error) {\r\n      logger.error('GoogleDriveAuthService', `‚ùå Error intercambiando c√≥digo: ${error.message}`)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Guarda las credenciales de Google Drive en Supabase\r\n   */\r\n  async saveCredentialsToSupabase(tokens) {\r\n    try {\r\n      if (!this.supabase || !this.currentUserId) {\r\n        logger.warn('GoogleDriveAuthService', '‚ö†Ô∏è Supabase no inicializado, saltando guardado en BD')\r\n        return false\r\n      }\r\n\r\n      logger.info('GoogleDriveAuthService', `üíæ Guardando credenciales en Supabase para ${this.currentUserId}...`)\r\n\r\n      const credentialsData = {\r\n        user_id: this.currentUserId,\r\n        access_token: tokens.access_token,\r\n        refresh_token: tokens.refresh_token,\r\n        token_expires_at: tokens.expires_at || new Date(Date.now() + (tokens.expires_in || 3600) * 1000).toISOString(),\r\n        is_connected: true,\r\n        is_active: true\r\n      }\r\n\r\n      const { data, error } = await this.supabase\r\n        .from('user_google_drive_credentials')\r\n        .upsert(credentialsData, {\r\n          onConflict: 'user_id'\r\n        })\r\n\r\n      if (error) {\r\n        logger.error('GoogleDriveAuthService', `‚ùå Error guardando en Supabase: ${error.message}`)\r\n        return false\r\n      }\r\n\r\n      logger.info('GoogleDriveAuthService', `‚úÖ Credenciales guardadas en Supabase`)\r\n      return true\r\n    } catch (error) {\r\n      logger.error('GoogleDriveAuthService', `‚ùå Error en saveCredentialsToSupabase: ${error.message}`)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Genera la URL de autorizaci√≥n OAuth\r\n   */\r\n  generateAuthUrl() {\r\n    try {\r\n      const clientId = process.env.REACT_APP_GOOGLE_CLIENT_ID\r\n      \r\n      if (!clientId || clientId.includes('YOUR_GOOGLE_CLIENT_ID')) {\r\n        logger.warn('GoogleDriveAuthService', '‚ö†Ô∏è Google Client ID no configurado')\r\n        return null\r\n      }\r\n      \r\n      const redirectUri = process.env.REACT_APP_GOOGLE_REDIRECT_URI ||\r\n                         (window.location.hostname === 'localhost' ?\r\n                          'http://localhost:3000/auth/google/callback' :\r\n                          `${window.location.origin}/auth/google/callback`)\r\n      \r\n      logger.info('GoogleDriveAuthService', `üîê Generando URL de autorizaci√≥n`)\r\n      logger.info('GoogleDriveAuthService', `üìç Redirect URI: ${redirectUri}`)\r\n      \r\n      const params = new URLSearchParams({\r\n        client_id: clientId,\r\n        redirect_uri: redirectUri,\r\n        scope: 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/drive.file',\r\n        response_type: 'code',\r\n        access_type: 'offline',\r\n        prompt: 'consent'\r\n      })\r\n      \r\n      return `https://accounts.google.com/o/oauth2/v2/auth?${params.toString()}`\r\n    } catch (error) {\r\n      logger.error('GoogleDriveAuthService', `‚ùå Error generando URL: ${error.message}`)\r\n      return null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene el access token actual\r\n   */\r\n  getAccessToken() {\r\n    if (!this.isAuthenticated()) {\r\n      throw new Error('Google Drive no est√° autenticado')\r\n    }\r\n    return this.accessToken\r\n  }\r\n\r\n  /**\r\n   * Verifica si est√° autenticado\r\n   */\r\n  isAuthenticated() {\r\n    return !!this.accessToken && this.isTokenValid({\r\n      access_token: this.accessToken,\r\n      expires_at: this.expiresAt?.toISOString()\r\n    })\r\n  }\r\n\r\n  /**\r\n   * Limpia los tokens\r\n   */\r\n  clearTokens() {\r\n    try {\r\n      logger.info('GoogleDriveAuthService', 'üßπ Limpiando tokens...')\r\n      \r\n      this.accessToken = null\r\n      this.refreshToken = null\r\n      this.expiresAt = null\r\n      \r\n      localStorage.removeItem('google_drive_auth')\r\n      \r\n      if (this.tokenRefreshTimeout) {\r\n        clearTimeout(this.tokenRefreshTimeout)\r\n        this.tokenRefreshTimeout = null\r\n      }\r\n      \r\n      this.notifyAuthCallbacks('unauthenticated')\r\n      logger.info('GoogleDriveAuthService', '‚úÖ Tokens limpiados')\r\n    } catch (error) {\r\n      logger.error('GoogleDriveAuthService', `‚ùå Error limpiando tokens: ${error.message}`)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Registra un callback para cambios de autenticaci√≥n\r\n   */\r\n  onAuthChange(callback) {\r\n    this.authCallbacks.push(callback)\r\n  }\r\n\r\n  /**\r\n   * Notifica a los callbacks de cambios de autenticaci√≥n\r\n   */\r\n  notifyAuthCallbacks(status) {\r\n    this.authCallbacks.forEach(callback => {\r\n      try {\r\n        callback(status)\r\n      } catch (error) {\r\n        logger.error('GoogleDriveAuthService', `‚ùå Error en callback: ${error.message}`)\r\n      }\r\n    })\r\n  }\r\n\r\n  /**\r\n   * Obtiene informaci√≥n de configuraci√≥n\r\n   */\r\n  getConfigInfo() {\r\n    return {\r\n      clientId: process.env.REACT_APP_GOOGLE_CLIENT_ID ? 'Configurado' : 'No configurado',\r\n      clientSecret: process.env.REACT_APP_GOOGLE_CLIENT_SECRET ? 'Configurado' : 'No configurado',\r\n      redirectUri: process.env.REACT_APP_GOOGLE_REDIRECT_URI || 'Auto-detectado',\r\n      isAuthenticated: this.isAuthenticated(),\r\n      tokenExpiresIn: this.getTimeUntilExpiry(),\r\n      hasRefreshToken: !!this.refreshToken\r\n    }\r\n  }\r\n}\r\n\r\n// Instancia singleton\r\nconst googleDriveAuthService = new GoogleDriveAuthService()\r\n\r\nexport default googleDriveAuthService\r\nexport { GoogleDriveAuthService }\r\n","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\googleDriveCallbackHandler.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\googleDriveCompatibility.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\googleDriveConfig.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\googleDriveLocal.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\googleDriveOAuthCallback.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'state' is assigned a value but never used.","line":22,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'tokens' is assigned a value but never used.","line":53,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":53,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Google Drive OAuth Callback Handler\r\n * Maneja el callback de autorizaci√≥n OAuth de Google Drive\r\n */\r\n\r\nimport googleDriveAuthService from './googleDriveAuthService.js'\r\nimport logger from './logger.js'\r\n\r\nclass GoogleDriveOAuthCallback {\r\n  /**\r\n   * Procesa el callback de OAuth\r\n   * Se llama despu√©s de que el usuario autoriza la aplicaci√≥n en Google\r\n   */\r\n  static async handleCallback() {\r\n    try {\r\n      logger.info('GoogleDriveOAuthCallback', 'üîÑ Procesando callback de OAuth...')\r\n      \r\n      // Obtener el c√≥digo de autorizaci√≥n de la URL\r\n      const params = new URLSearchParams(window.location.search)\r\n      const code = params.get('code')\r\n      const error = params.get('error')\r\n      const state = params.get('state')\r\n      \r\n      logger.info('GoogleDriveOAuthCallback', `üìç URL: ${window.location.href}`)\r\n      logger.info('GoogleDriveOAuthCallback', `üîë C√≥digo presente: ${!!code}`)\r\n      logger.info('GoogleDriveOAuthCallback', `‚ùå Error presente: ${!!error}`)\r\n      \r\n      // Verificar si hay error\r\n      if (error) {\r\n        logger.error('GoogleDriveOAuthCallback', `‚ùå Error de autorizaci√≥n: ${error}`)\r\n        \r\n        // Mostrar error al usuario\r\n        const errorMessage = this.getErrorMessage(error)\r\n        this.showErrorModal(errorMessage)\r\n        \r\n        // Limpiar URL\r\n        window.history.replaceState({}, document.title, window.location.pathname)\r\n        return false\r\n      }\r\n      \r\n      // Verificar que hay c√≥digo\r\n      if (!code) {\r\n        logger.error('GoogleDriveOAuthCallback', '‚ùå No se recibi√≥ c√≥digo de autorizaci√≥n')\r\n        this.showErrorModal('No se recibi√≥ c√≥digo de autorizaci√≥n. Por favor, intenta nuevamente.')\r\n        window.history.replaceState({}, document.title, window.location.pathname)\r\n        return false\r\n      }\r\n      \r\n      logger.info('GoogleDriveOAuthCallback', `‚úÖ C√≥digo de autorizaci√≥n recibido`)\r\n      \r\n      // Intercambiar c√≥digo por tokens\r\n      logger.info('GoogleDriveOAuthCallback', 'üîÑ Intercambiando c√≥digo por tokens...')\r\n      const tokens = await googleDriveAuthService.exchangeCodeForTokens(code)\r\n      \r\n      logger.info('GoogleDriveOAuthCallback', '‚úÖ Tokens obtenidos exitosamente')\r\n      \r\n      // Mostrar √©xito al usuario\r\n      this.showSuccessModal('¬°Conexi√≥n exitosa! Google Drive est√° configurado.')\r\n      \r\n      // Limpiar URL\r\n      window.history.replaceState({}, document.title, window.location.pathname)\r\n      \r\n      // Redirigir despu√©s de 2 segundos\r\n      setTimeout(() => {\r\n        window.location.href = '/'\r\n      }, 2000)\r\n      \r\n      return true\r\n    } catch (error) {\r\n      logger.error('GoogleDriveOAuthCallback', `‚ùå Error procesando callback: ${error.message}`)\r\n      this.showErrorModal(`Error: ${error.message}`)\r\n      window.history.replaceState({}, document.title, window.location.pathname)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene un mensaje de error legible para el usuario\r\n   */\r\n  static getErrorMessage(errorCode) {\r\n    const errorMessages = {\r\n      'access_denied': 'Acceso denegado. No autorizaste la conexi√≥n con Google Drive.',\r\n      'invalid_scope': 'Permisos inv√°lidos solicitados.',\r\n      'server_error': 'Error en el servidor de Google. Por favor, intenta nuevamente.',\r\n      'temporarily_unavailable': 'Servicio de Google temporalmente no disponible. Por favor, intenta m√°s tarde.',\r\n      'invalid_request': 'Solicitud inv√°lida. Verifica la configuraci√≥n.',\r\n      'unauthorized_client': 'Cliente no autorizado. Verifica las credenciales de Google Cloud.',\r\n      'unsupported_response_type': 'Tipo de respuesta no soportado.',\r\n      'invalid_client': 'Cliente inv√°lido. Verifica el Client ID y Client Secret.'\r\n    }\r\n    \r\n    return errorMessages[errorCode] || `Error de autorizaci√≥n: ${errorCode}`\r\n  }\r\n\r\n  /**\r\n   * Muestra un modal de error\r\n   */\r\n  static showErrorModal(message) {\r\n    const modal = document.createElement('div')\r\n    modal.id = 'google-drive-error-modal'\r\n    modal.style.cssText = `\r\n      position: fixed;\r\n      top: 0;\r\n      left: 0;\r\n      right: 0;\r\n      bottom: 0;\r\n      background: rgba(0, 0, 0, 0.5);\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      z-index: 10000;\r\n    `\r\n    \r\n    const content = document.createElement('div')\r\n    content.style.cssText = `\r\n      background: white;\r\n      padding: 30px;\r\n      border-radius: 8px;\r\n      max-width: 500px;\r\n      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\r\n    `\r\n    \r\n    content.innerHTML = `\r\n      <div style=\"text-align: center;\">\r\n        <h2 style=\"color: #dc2626; margin-bottom: 15px;\">‚ùå Error de Conexi√≥n</h2>\r\n        <p style=\"color: #666; margin-bottom: 20px; line-height: 1.6;\">${message}</p>\r\n        <button onclick=\"document.getElementById('google-drive-error-modal').remove()\" \r\n                style=\"background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;\">\r\n          Cerrar\r\n        </button>\r\n      </div>\r\n    `\r\n    \r\n    modal.appendChild(content)\r\n    document.body.appendChild(modal)\r\n  }\r\n\r\n  /**\r\n   * Muestra un modal de √©xito\r\n   */\r\n  static showSuccessModal(message) {\r\n    const modal = document.createElement('div')\r\n    modal.id = 'google-drive-success-modal'\r\n    modal.style.cssText = `\r\n      position: fixed;\r\n      top: 0;\r\n      left: 0;\r\n      right: 0;\r\n      bottom: 0;\r\n      background: rgba(0, 0, 0, 0.5);\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      z-index: 10000;\r\n    `\r\n    \r\n    const content = document.createElement('div')\r\n    content.style.cssText = `\r\n      background: white;\r\n      padding: 30px;\r\n      border-radius: 8px;\r\n      max-width: 500px;\r\n      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\r\n    `\r\n    \r\n    content.innerHTML = `\r\n      <div style=\"text-align: center;\">\r\n        <h2 style=\"color: #16a34a; margin-bottom: 15px;\">‚úÖ Conexi√≥n Exitosa</h2>\r\n        <p style=\"color: #666; margin-bottom: 20px; line-height: 1.6;\">${message}</p>\r\n        <p style=\"color: #999; font-size: 14px;\">Redirigiendo en 2 segundos...</p>\r\n      </div>\r\n    `\r\n    \r\n    modal.appendChild(content)\r\n    document.body.appendChild(modal)\r\n  }\r\n}\r\n\r\nexport default GoogleDriveOAuthCallback\r\n","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\googleDriveService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\googleDriveTokenBridge.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\hybridGoogleDrive.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\keyManagement.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\localDatabase.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\localGoogleDrive.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'id' is assigned a value but never used.","line":101,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":101,"endColumn":21},{"ruleId":"no-unused-vars","severity":1,"message":"'id' is assigned a value but never used.","line":106,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":106,"endColumn":21},{"ruleId":"no-unused-vars","severity":1,"message":"'folder' is assigned a value but never used.","line":156,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":156,"endColumn":21},{"ruleId":"no-unused-vars","severity":1,"message":"'id' is assigned a value but never used.","line":249,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":249,"endColumn":21},{"ruleId":"no-unused-vars","severity":1,"message":"'id' is assigned a value but never used.","line":254,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":254,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Local Google Drive Service para Netlify - Simulaci√≥n de Google Drive\r\nclass LocalGoogleDriveService {\r\n  constructor() {\r\n    this.initialized = false\r\n    this.baseFolder = 'brify-drive'\r\n    this.folders = new Map()\r\n    this.files = new Map()\r\n    this.initializeStorage()\r\n  }\r\n\r\n  async initialize() {\r\n    try {\r\n      if (!localStorage.getItem(this.baseFolder)) {\r\n        localStorage.setItem(this.baseFolder, JSON.stringify({\r\n          folders: {},\r\n          files: {},\r\n          created: new Date().toISOString()\r\n        }))\r\n      }\r\n      this.loadFromStorage()\r\n      this.initialized = true\r\n      console.log('‚úÖ Local Google Drive inicializado')\r\n      return true\r\n    } catch (error) {\r\n      console.error('Error inicializando Local Google Drive:', error)\r\n      return false\r\n    }\r\n  }\r\n\r\n  initializeStorage() {\r\n    try {\r\n      const stored = localStorage.getItem(this.baseFolder)\r\n      if (stored) {\r\n        const data = JSON.parse(stored)\r\n        this.folders = new Map(Object.entries(data.folders || {}))\r\n        this.files = new Map(Object.entries(data.files || {}))\r\n      }\r\n    } catch (error) {\r\n      console.error('Error cargando almacenamiento local:', error)\r\n      this.folders = new Map()\r\n      this.files = new Map()\r\n    }\r\n  }\r\n\r\n  loadFromStorage() {\r\n    try {\r\n      const stored = localStorage.getItem(this.baseFolder)\r\n      if (stored) {\r\n        const data = JSON.parse(stored)\r\n        this.folders = new Map(Object.entries(data.folders || {}))\r\n        this.files = new Map(Object.entries(data.files || {}))\r\n      }\r\n    } catch (error) {\r\n      console.error('Error cargando desde storage:', error)\r\n    }\r\n  }\r\n\r\n  saveToStorage() {\r\n    try {\r\n      const data = {\r\n        folders: Object.fromEntries(this.folders),\r\n        files: Object.fromEntries(this.files),\r\n        updated: new Date().toISOString()\r\n      }\r\n      localStorage.setItem(this.baseFolder, JSON.stringify(data))\r\n    } catch (error) {\r\n      console.error('Error guardando en storage:', error)\r\n    }\r\n  }\r\n\r\n  generateId() {\r\n    return 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)\r\n  }\r\n\r\n  async createFolder(name, parentId = null) {\r\n    try {\r\n      const folderId = this.generateId()\r\n      const folder = {\r\n        id: folderId,\r\n        name: name,\r\n        mimeType: 'application/vnd.google-apps.folder',\r\n        parents: parentId ? [parentId] : [],\r\n        createdTime: new Date().toISOString(),\r\n        modifiedTime: new Date().toISOString(),\r\n        size: null,\r\n        isLocal: true\r\n      }\r\n      this.folders.set(folderId, folder)\r\n      this.saveToStorage()\r\n      console.log(`‚úÖ Carpeta local creada: ${name} (${folderId})`)\r\n      return folder\r\n    } catch (error) {\r\n      console.error('Error creando carpeta local:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  async listFiles(parentId = null, pageSize = 100) {\r\n    try {\r\n      const allItems = []\r\n      for (const [id, folder] of this.folders) {\r\n        if (!parentId || (folder.parents && folder.parents.includes(parentId))) {\r\n          allItems.push(folder)\r\n        }\r\n      }\r\n      for (const [id, file] of this.files) {\r\n        if (!parentId || (file.parents && file.parents.includes(parentId))) {\r\n          allItems.push(file)\r\n        }\r\n      }\r\n      allItems.sort((a, b) => a.name.localeCompare(b.name))\r\n      const startIndex = 0\r\n      const endIndex = Math.min(startIndex + pageSize, allItems.length)\r\n      const paginatedItems = allItems.slice(startIndex, endIndex)\r\n      console.log(`üìÅ Listados ${paginatedItems.length} items locales`)\r\n      return paginatedItems\r\n    } catch (error) {\r\n      console.error('Error listando archivos locales:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  async uploadFile(file, parentId = null) {\r\n    try {\r\n      const fileId = this.generateId()\r\n      const reader = new FileReader()\r\n      const fileContent = await new Promise((resolve, reject) => {\r\n        reader.onload = () => resolve(reader.result)\r\n        reader.onerror = reject\r\n        reader.readAsDataURL(file)\r\n      })\r\n      const uploadedFile = {\r\n        id: fileId,\r\n        name: file.name,\r\n        mimeType: file.type,\r\n        size: file.size,\r\n        createdTime: new Date().toISOString(),\r\n        modifiedTime: new Date().toISOString(),\r\n        parents: parentId ? [parentId] : [],\r\n        content: fileContent,\r\n        isLocal: true\r\n      }\r\n      this.files.set(fileId, uploadedFile)\r\n      this.saveToStorage()\r\n      console.log(`‚úÖ Archivo local subido: ${file.name} (${fileId})`)\r\n      return uploadedFile\r\n    } catch (error) {\r\n      console.error('Error subiendo archivo local:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  async deleteFile(fileId) {\r\n    try {\r\n      if (this.folders.has(fileId)) {\r\n        const folder = this.folders.get(fileId)\r\n        for (const [id, item] of [...this.folders, ...this.files]) {\r\n          if (item.parents && item.parents.includes(fileId)) {\r\n            if (this.folders.has(id)) {\r\n              await this.deleteFile(id)\r\n            } else {\r\n              this.files.delete(id)\r\n            }\r\n          }\r\n        }\r\n        this.folders.delete(fileId)\r\n      } else if (this.files.has(fileId)) {\r\n        this.files.delete(fileId)\r\n      }\r\n      this.saveToStorage()\r\n      console.log(`üóëÔ∏è Item local eliminado: ${fileId}`)\r\n      return true\r\n    } catch (error) {\r\n      console.error('Error eliminando archivo local:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  async shareFolder(folderId, email, role = 'reader') {\r\n    try {\r\n      const folder = this.folders.get(folderId)\r\n      if (!folder) {\r\n        throw new Error('Carpeta no encontrada')\r\n      }\r\n      if (!folder.sharedWith) {\r\n        folder.sharedWith = []\r\n      }\r\n      folder.sharedWith.push({\r\n        email: email,\r\n        role: role,\r\n        addedDate: new Date().toISOString()\r\n      })\r\n      this.folders.set(folderId, folder)\r\n      this.saveToStorage()\r\n      console.log(`üîó Carpeta compartida con ${email} (${role})`)\r\n      return {\r\n        id: this.generateId(),\r\n        type: 'user',\r\n        role: role,\r\n        emailAddress: email\r\n      }\r\n    } catch (error) {\r\n      console.error('Error compartiendo carpeta local:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  async getFileInfo(fileId) {\r\n    try {\r\n      const item = this.folders.get(fileId) || this.files.get(fileId)\r\n      if (!item) {\r\n        throw new Error('Archivo o carpeta no encontrado')\r\n      }\r\n      return item\r\n    } catch (error) {\r\n      console.error('Error obteniendo info del archivo local:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  async downloadFile(fileId) {\r\n    try {\r\n      const file = this.files.get(fileId)\r\n      if (!file) {\r\n        throw new Error('Archivo no encontrado')\r\n      }\r\n      const response = await fetch(file.content)\r\n      const blob = await response.blob()\r\n      const url = URL.createObjectURL(blob)\r\n      const a = document.createElement('a')\r\n      a.href = url\r\n      a.download = file.name\r\n      document.body.appendChild(a)\r\n      a.click()\r\n      document.body.removeChild(a)\r\n      URL.revokeObjectURL(url)\r\n      console.log(`‚¨áÔ∏è Archivo descargado: ${file.name}`)\r\n      return true\r\n    } catch (error) {\r\n      console.error('Error descargando archivo local:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  async searchFiles(query) {\r\n    try {\r\n      const results = []\r\n      const lowerQuery = query.toLowerCase()\r\n      for (const [id, folder] of this.folders) {\r\n        if (folder.name.toLowerCase().includes(lowerQuery)) {\r\n          results.push(folder)\r\n        }\r\n      }\r\n      for (const [id, file] of this.files) {\r\n        if (file.name.toLowerCase().includes(lowerQuery)) {\r\n          results.push(file)\r\n        }\r\n      }\r\n      console.log(`üîç B√∫squeda local: ${results.length} resultados para \"${query}\"`)\r\n      return results\r\n    } catch (error) {\r\n      console.error('Error buscando archivos locales:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  getStats() {\r\n    const folderCount = this.folders.size\r\n    const fileCount = this.files.size\r\n    let totalSize = 0\r\n    for (const file of this.files.values()) {\r\n      totalSize += file.size || 0\r\n    }\r\n    return {\r\n      folders: folderCount,\r\n      files: fileCount,\r\n      totalSize: totalSize,\r\n      totalSizeFormatted: this.formatBytes(totalSize),\r\n      isLocal: true\r\n    }\r\n  }\r\n\r\n  formatBytes(bytes) {\r\n    if (bytes === 0) return '0 Bytes'\r\n    const k = 1024\r\n    const sizes = ['Bytes', 'KB', 'MB', 'GB']\r\n    const i = Math.floor(Math.log(bytes) / Math.log(k))\r\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]\r\n  }\r\n\r\n  clearStorage() {\r\n    try {\r\n      localStorage.removeItem(this.baseFolder)\r\n      this.folders.clear()\r\n      this.files.clear()\r\n      console.log('üßπ Almacenamiento local limpiado')\r\n    } catch (error) {\r\n      console.error('Error limpiando almacenamiento local:', error)\r\n    }\r\n  }\r\n\r\n  isInitialized() {\r\n    return this.initialized\r\n  }\r\n\r\n  getPreviewUrl(fileId) {\r\n    const file = this.files.get(fileId)\r\n    if (file && file.content) {\r\n      return file.content\r\n    }\r\n    return null\r\n  }\r\n}\r\n\r\nconst localGoogleDriveService = new LocalGoogleDriveService()\r\n\r\nexport default localGoogleDriveService\r\nexport { LocalGoogleDriveService }\r\n","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\logger.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\mfaService.js","messages":[{"ruleId":"no-const-assign","severity":1,"message":"'counter' is constant.","line":96,"column":11,"nodeType":"Identifier","messageId":"const","endLine":96,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Multi-Factor Authentication (MFA) Service\r\n * Implementaci√≥n de TOTP, SMS OTP, Backup Codes y WebAuthn\r\n * \r\n * ‚úÖ NO MODIFICA c√≥digo existente\r\n * ‚úÖ Completamente independiente\r\n * ‚úÖ Puede ser desactivado sin afectar el sistema\r\n */\r\n\r\nimport crypto from 'crypto'\r\n\r\nclass MFAService {\r\n  constructor() {\r\n    this.mfaConfigs = new Map() // userId -> mfaConfig\r\n    this.otpAttempts = new Map() // userId -> { attempts, lastAttempt }\r\n    this.maxOTPAttempts = 5\r\n    this.otpExpiryTime = 30 * 1000 // 30 segundos\r\n    this.otpLockoutTime = 15 * 60 * 1000 // 15 minutos\r\n  }\r\n\r\n  /**\r\n   * Generar secreto TOTP\r\n   * @returns {Object} { secret, qrCode, backupCodes }\r\n   */\r\n  generateTOTPSecret() {\r\n    try {\r\n      // Generar secreto aleatorio de 32 bytes\r\n      const secret = crypto.randomBytes(32).toString('base64')\r\n      \r\n      // Generar c√≥digos de respaldo\r\n      const backupCodes = this.generateBackupCodes(10)\r\n\r\n      // Generar URL para QR (formato est√°ndar otpauth://)\r\n      const qrCodeUrl = this.generateQRCodeURL(secret)\r\n\r\n      return {\r\n        secret,\r\n        qrCodeUrl,\r\n        backupCodes,\r\n        algorithm: 'SHA1',\r\n        digits: 6,\r\n        period: 30\r\n      }\r\n    } catch (error) {\r\n      console.error('Error generating TOTP secret:', error)\r\n      throw new Error('Failed to generate TOTP secret')\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generar URL para c√≥digo QR\r\n   * @param {string} secret - Secreto TOTP\r\n   * @param {string} email - Email del usuario (opcional)\r\n   * @param {string} issuer - Nombre de la aplicaci√≥n (opcional)\r\n   * @returns {string} URL otpauth://\r\n   */\r\n  generateQRCodeURL(secret, email = 'user@example.com', issuer = 'BrifyRRHH') {\r\n    try {\r\n      const encodedSecret = Buffer.from(secret, 'base64').toString('base64')\r\n      const encodedEmail = encodeURIComponent(email)\r\n      const encodedIssuer = encodeURIComponent(issuer)\r\n\r\n      return `otpauth://totp/${encodedIssuer}:${encodedEmail}?secret=${encodedSecret}&issuer=${encodedIssuer}&algorithm=SHA1&digits=6&period=30`\r\n    } catch (error) {\r\n      console.error('Error generating QR code URL:', error)\r\n      throw new Error('Failed to generate QR code URL')\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verificar c√≥digo TOTP\r\n   * @param {string} secret - Secreto TOTP\r\n   * @param {string} token - Token TOTP a verificar\r\n   * @param {number} window - Ventana de tolerancia (¬±30 segundos)\r\n   * @returns {boolean} True si es v√°lido\r\n   */\r\n  verifyTOTP(secret, token, window = 1) {\r\n    try {\r\n      if (!token || token.length !== 6) {\r\n        return false\r\n      }\r\n\r\n      const now = Math.floor(Date.now() / 1000)\r\n      const secretBuffer = Buffer.from(secret, 'base64')\r\n\r\n      // Verificar en ventana de tiempo (¬±window per√≠odos)\r\n      for (let i = -window; i <= window; i++) {\r\n        const counter = Math.floor((now + i * 30) / 30)\r\n        const hmac = crypto.createHmac('sha1', secretBuffer)\r\n        hmac.update(Buffer.alloc(8))\r\n        \r\n        // Escribir counter en big-endian\r\n        const counterBuffer = Buffer.alloc(8)\r\n        for (let j = 7; j >= 0; j--) {\r\n          counterBuffer[j] = counter & 0xff\r\n          counter = counter >> 8\r\n        }\r\n\r\n        hmac.update(counterBuffer)\r\n        const digest = hmac.digest()\r\n        const offset = digest[digest.length - 1] & 0xf\r\n        const code = (\r\n          ((digest[offset] & 0x7f) << 24) |\r\n          ((digest[offset + 1] & 0xff) << 16) |\r\n          ((digest[offset + 2] & 0xff) << 8) |\r\n          (digest[offset + 3] & 0xff)\r\n        ) % 1000000\r\n\r\n        const expectedToken = String(code).padStart(6, '0')\r\n        if (expectedToken === token) {\r\n          return true\r\n        }\r\n      }\r\n\r\n      return false\r\n    } catch (error) {\r\n      console.error('Error verifying TOTP:', error)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generar c√≥digos de respaldo\r\n   * @param {number} count - Cantidad de c√≥digos\r\n   * @returns {Array} Array de c√≥digos\r\n   */\r\n  generateBackupCodes(count = 10) {\r\n    try {\r\n      const codes = []\r\n      for (let i = 0; i < count; i++) {\r\n        const code = crypto.randomBytes(4).toString('hex').toUpperCase()\r\n        codes.push(`${code.slice(0, 4)}-${code.slice(4, 8)}`)\r\n      }\r\n      return codes\r\n    } catch (error) {\r\n      console.error('Error generating backup codes:', error)\r\n      throw new Error('Failed to generate backup codes')\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verificar c√≥digo de respaldo\r\n   * @param {string} userId - ID del usuario\r\n   * @param {string} code - C√≥digo a verificar\r\n   * @returns {boolean} True si es v√°lido\r\n   */\r\n  verifyBackupCode(userId, code) {\r\n    try {\r\n      const config = this.mfaConfigs.get(userId)\r\n      if (!config || !config.backupCodes) {\r\n        return false\r\n      }\r\n\r\n      const normalizedCode = code.toUpperCase().replace(/\\s/g, '')\r\n      const index = config.backupCodes.indexOf(normalizedCode)\r\n\r\n      if (index !== -1) {\r\n        // Eliminar c√≥digo usado\r\n        config.backupCodes.splice(index, 1)\r\n        return true\r\n      }\r\n\r\n      return false\r\n    } catch (error) {\r\n      console.error('Error verifying backup code:', error)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generar OTP por SMS\r\n   * @param {string} userId - ID del usuario\r\n   * @param {string} phoneNumber - N√∫mero de tel√©fono\r\n   * @returns {Object} { otp, expiresAt }\r\n   */\r\n  generateSMSOTP(userId, phoneNumber) {\r\n    try {\r\n      // Generar OTP de 6 d√≠gitos\r\n      const otp = String(Math.floor(Math.random() * 1000000)).padStart(6, '0')\r\n      const expiresAt = Date.now() + this.otpExpiryTime\r\n\r\n      // Almacenar OTP\r\n      if (!this.mfaConfigs.has(userId)) {\r\n        this.mfaConfigs.set(userId, {})\r\n      }\r\n\r\n      const config = this.mfaConfigs.get(userId)\r\n      config.smsOTP = {\r\n        otp,\r\n        expiresAt,\r\n        phoneNumber,\r\n        attempts: 0\r\n      }\r\n\r\n      return {\r\n        otp,\r\n        expiresAt,\r\n        maskedPhone: this.maskPhoneNumber(phoneNumber)\r\n      }\r\n    } catch (error) {\r\n      console.error('Error generating SMS OTP:', error)\r\n      throw new Error('Failed to generate SMS OTP')\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verificar OTP por SMS\r\n   * @param {string} userId - ID del usuario\r\n   * @param {string} otp - OTP a verificar\r\n   * @returns {boolean} True si es v√°lido\r\n   */\r\n  verifySMSOTP(userId, otp) {\r\n    try {\r\n      const config = this.mfaConfigs.get(userId)\r\n      if (!config || !config.smsOTP) {\r\n        return false\r\n      }\r\n\r\n      const smsOTP = config.smsOTP\r\n\r\n      // Verificar intentos\r\n      if (smsOTP.attempts >= this.maxOTPAttempts) {\r\n        const now = Date.now()\r\n        const attempts = this.otpAttempts.get(userId) || { attempts: 0, lastAttempt: 0 }\r\n\r\n        if (now - attempts.lastAttempt < this.otpLockoutTime) {\r\n          return false // Bloqueado por demasiados intentos\r\n        }\r\n\r\n        // Resetear intentos\r\n        smsOTP.attempts = 0\r\n      }\r\n\r\n      // Verificar expiraci√≥n\r\n      if (Date.now() > smsOTP.expiresAt) {\r\n        return false\r\n      }\r\n\r\n      // Verificar OTP\r\n      if (smsOTP.otp === otp) {\r\n        delete config.smsOTP\r\n        return true\r\n      }\r\n\r\n      // Incrementar intentos\r\n      smsOTP.attempts++\r\n      this.otpAttempts.set(userId, {\r\n        attempts: smsOTP.attempts,\r\n        lastAttempt: Date.now()\r\n      })\r\n\r\n      return false\r\n    } catch (error) {\r\n      console.error('Error verifying SMS OTP:', error)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enmascarar n√∫mero de tel√©fono\r\n   * @param {string} phoneNumber - N√∫mero de tel√©fono\r\n   * @returns {string} N√∫mero enmascarado\r\n   */\r\n  maskPhoneNumber(phoneNumber) {\r\n    try {\r\n      const cleaned = phoneNumber.replace(/\\D/g, '')\r\n      const last4 = cleaned.slice(-4)\r\n      return `***-***-${last4}`\r\n    } catch (error) {\r\n      return '***-***-****'\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Registrar MFA para usuario\r\n   * @param {string} userId - ID del usuario\r\n   * @param {Object} mfaConfig - Configuraci√≥n MFA\r\n   */\r\n  registerMFA(userId, mfaConfig) {\r\n    try {\r\n      this.mfaConfigs.set(userId, {\r\n        ...mfaConfig,\r\n        registeredAt: Date.now(),\r\n        enabled: true\r\n      })\r\n\r\n      return {\r\n        userId,\r\n        status: 'registered',\r\n        methods: Object.keys(mfaConfig).filter(k => mfaConfig[k])\r\n      }\r\n    } catch (error) {\r\n      console.error('Error registering MFA:', error)\r\n      throw new Error('Failed to register MFA')\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener configuraci√≥n MFA del usuario\r\n   * @param {string} userId - ID del usuario\r\n   * @returns {Object} Configuraci√≥n MFA\r\n   */\r\n  getMFAConfig(userId) {\r\n    try {\r\n      const config = this.mfaConfigs.get(userId)\r\n      if (!config) {\r\n        return null\r\n      }\r\n\r\n      return {\r\n        userId,\r\n        enabled: config.enabled,\r\n        methods: {\r\n          totp: !!config.totpSecret,\r\n          sms: !!config.phoneNumber,\r\n          backupCodes: config.backupCodes ? config.backupCodes.length : 0\r\n        },\r\n        registeredAt: config.registeredAt\r\n      }\r\n    } catch (error) {\r\n      console.error('Error getting MFA config:', error)\r\n      return null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Deshabilitar MFA para usuario\r\n   * @param {string} userId - ID del usuario\r\n   */\r\n  disableMFA(userId) {\r\n    try {\r\n      const config = this.mfaConfigs.get(userId)\r\n      if (config) {\r\n        config.enabled = false\r\n      }\r\n\r\n      return {\r\n        userId,\r\n        status: 'disabled'\r\n      }\r\n    } catch (error) {\r\n      console.error('Error disabling MFA:', error)\r\n      throw new Error('Failed to disable MFA')\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener estad√≠sticas de MFA\r\n   * @returns {Object} Estad√≠sticas\r\n   */\r\n  getStats() {\r\n    try {\r\n      let totalUsers = 0\r\n      let totpEnabled = 0\r\n      let smsEnabled = 0\r\n      let backupCodesEnabled = 0\r\n\r\n      for (const config of this.mfaConfigs.values()) {\r\n        if (config.enabled) {\r\n          totalUsers++\r\n          if (config.totpSecret) totpEnabled++\r\n          if (config.phoneNumber) smsEnabled++\r\n          if (config.backupCodes) backupCodesEnabled++\r\n        }\r\n      }\r\n\r\n      return {\r\n        totalUsers,\r\n        totpEnabled,\r\n        smsEnabled,\r\n        backupCodesEnabled,\r\n        averageMethodsPerUser: totalUsers > 0 \r\n          ? ((totpEnabled + smsEnabled + backupCodesEnabled) / totalUsers).toFixed(2)\r\n          : 0\r\n      }\r\n    } catch (error) {\r\n      console.error('Error getting MFA stats:', error)\r\n      return {}\r\n    }\r\n  }\r\n}\r\n\r\n// Crear instancia singleton\r\nconst mfaService = new MFAService()\r\n\r\nexport default mfaService\r\n","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\netlifyGoogleDrive.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\queryQueue.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\rbacService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'userId' is assigned a value but never used.","line":236,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":236,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Role-Based Access Control (RBAC) Service\r\n * Implementaci√≥n de control de acceso basado en roles\r\n * \r\n * ‚úÖ NO MODIFICA c√≥digo existente\r\n * ‚úÖ Completamente independiente\r\n * ‚úÖ Puede ser desactivado sin afectar el sistema\r\n */\r\n\r\nclass RBACService {\r\n  constructor() {\r\n    this.roles = new Map() // roleId -> role\r\n    this.permissions = new Map() // permissionId -> permission\r\n    this.userRoles = new Map() // userId -> [roleId]\r\n    this.rolePermissions = new Map() // roleId -> [permissionId]\r\n    this.auditLogs = [] // Array de auditor√≠a\r\n    this.delegations = new Map() // delegatorId -> [delegation]\r\n    \r\n    this.initializeDefaultRoles()\r\n    this.initializeDefaultPermissions()\r\n  }\r\n\r\n  /**\r\n   * Inicializar roles por defecto\r\n   */\r\n  initializeDefaultRoles() {\r\n    const defaultRoles = [\r\n      {\r\n        id: 'admin',\r\n        name: 'Administrator',\r\n        description: 'Acceso completo al sistema',\r\n        level: 100,\r\n        isSystem: true,\r\n        createdAt: Date.now()\r\n      },\r\n      {\r\n        id: 'manager',\r\n        name: 'Manager',\r\n        description: 'Gesti√≥n de equipos y recursos',\r\n        level: 80,\r\n        isSystem: true,\r\n        createdAt: Date.now()\r\n      },\r\n      {\r\n        id: 'user',\r\n        name: 'User',\r\n        description: 'Acceso b√°sico a funcionalidades',\r\n        level: 50,\r\n        isSystem: true,\r\n        createdAt: Date.now()\r\n      },\r\n      {\r\n        id: 'viewer',\r\n        name: 'Viewer',\r\n        description: 'Solo lectura de informaci√≥n',\r\n        level: 20,\r\n        isSystem: true,\r\n        createdAt: Date.now()\r\n      }\r\n    ]\r\n\r\n    defaultRoles.forEach(role => {\r\n      this.roles.set(role.id, role)\r\n    })\r\n  }\r\n\r\n  /**\r\n   * Inicializar permisos por defecto\r\n   */\r\n  initializeDefaultPermissions() {\r\n    const defaultPermissions = [\r\n      // Permisos de Usuario\r\n      { id: 'user.create', name: 'Crear usuarios', category: 'user', level: 80 },\r\n      { id: 'user.read', name: 'Ver usuarios', category: 'user', level: 20 },\r\n      { id: 'user.update', name: 'Actualizar usuarios', category: 'user', level: 80 },\r\n      { id: 'user.delete', name: 'Eliminar usuarios', category: 'user', level: 100 },\r\n      { id: 'user.assign_roles', name: 'Asignar roles', category: 'user', level: 80 },\r\n      \r\n      // Permisos de Empresa\r\n      { id: 'company.create', name: 'Crear empresas', category: 'company', level: 80 },\r\n      { id: 'company.read', name: 'Ver empresas', category: 'company', level: 20 },\r\n      { id: 'company.update', name: 'Actualizar empresas', category: 'company', level: 80 },\r\n      { id: 'company.delete', name: 'Eliminar empresas', category: 'company', level: 100 },\r\n      \r\n      // Permisos de Empleados\r\n      { id: 'employee.create', name: 'Crear empleados', category: 'employee', level: 50 },\r\n      { id: 'employee.read', name: 'Ver empleados', category: 'employee', level: 20 },\r\n      { id: 'employee.update', name: 'Actualizar empleados', category: 'employee', level: 50 },\r\n      { id: 'employee.delete', name: 'Eliminar empleados', category: 'employee', level: 80 },\r\n      \r\n      // Permisos de Comunicaci√≥n\r\n      { id: 'communication.send', name: 'Enviar comunicaciones', category: 'communication', level: 50 },\r\n      { id: 'communication.read', name: 'Ver comunicaciones', category: 'communication', level: 20 },\r\n      { id: 'communication.manage', name: 'Gestionar comunicaciones', category: 'communication', level: 80 },\r\n      \r\n      // Permisos de Archivos\r\n      { id: 'file.upload', name: 'Subir archivos', category: 'file', level: 50 },\r\n      { id: 'file.read', name: 'Ver archivos', category: 'file', level: 20 },\r\n      { id: 'file.update', name: 'Actualizar archivos', category: 'file', level: 50 },\r\n      { id: 'file.delete', name: 'Eliminar archivos', category: 'file', level: 80 },\r\n      \r\n      // Permisos de Reportes\r\n      { id: 'report.create', name: 'Crear reportes', category: 'report', level: 50 },\r\n      { id: 'report.read', name: 'Ver reportes', category: 'report', level: 20 },\r\n      { id: 'report.export', name: 'Exportar reportes', category: 'report', level: 50 },\r\n      \r\n      // Permisos de Configuraci√≥n\r\n      { id: 'config.read', name: 'Ver configuraci√≥n', category: 'config', level: 80 },\r\n      { id: 'config.update', name: 'Actualizar configuraci√≥n', category: 'config', level: 100 },\r\n      \r\n      // Permisos de Seguridad\r\n      { id: 'security.audit', name: 'Ver auditor√≠a de seguridad', category: 'security', level: 80 },\r\n      { id: 'security.manage', name: 'Gestionar seguridad', category: 'security', level: 100 }\r\n    ]\r\n\r\n    defaultPermissions.forEach(permission => {\r\n      this.permissions.set(permission.id, {\r\n        ...permission,\r\n        createdAt: Date.now()\r\n      })\r\n    })\r\n\r\n    // Asignar permisos a roles por defecto\r\n    this.assignDefaultPermissions()\r\n  }\r\n\r\n  /**\r\n   * Asignar permisos por defecto a roles\r\n   */\r\n  assignDefaultPermissions() {\r\n    // Admin: Todos los permisos\r\n    const allPermissions = Array.from(this.permissions.keys())\r\n    this.rolePermissions.set('admin', allPermissions)\r\n\r\n    // Manager: Permisos de gesti√≥n\r\n    const managerPermissions = Array.from(this.permissions.keys()).filter(id => {\r\n      const perm = this.permissions.get(id)\r\n      return perm.level <= 80\r\n    })\r\n    this.rolePermissions.set('manager', managerPermissions)\r\n\r\n    // User: Permisos b√°sicos\r\n    const userPermissions = Array.from(this.permissions.keys()).filter(id => {\r\n      const perm = this.permissions.get(id)\r\n      return perm.level <= 50\r\n    })\r\n    this.rolePermissions.set('user', userPermissions)\r\n\r\n    // Viewer: Solo lectura\r\n    const viewerPermissions = Array.from(this.permissions.keys()).filter(id => {\r\n      const perm = this.permissions.get(id)\r\n      return perm.level <= 20\r\n    })\r\n    this.rolePermissions.set('viewer', viewerPermissions)\r\n  }\r\n\r\n  /**\r\n   * Crear nuevo rol\r\n   * @param {Object} roleData - Datos del rol\r\n   * @returns {Object} Rol creado\r\n   */\r\n  createRole(roleData) {\r\n    try {\r\n      const role = {\r\n        id: roleData.id || `role_${Date.now()}`,\r\n        name: roleData.name,\r\n        description: roleData.description || '',\r\n        level: roleData.level || 50,\r\n        isSystem: false,\r\n        createdAt: Date.now(),\r\n        createdBy: roleData.createdBy\r\n      }\r\n\r\n      this.roles.set(role.id, role)\r\n      this.logAudit('role_created', role.createdBy, { roleId: role.id, roleName: role.name })\r\n\r\n      return role\r\n    } catch (error) {\r\n      console.error('Error creating role:', error)\r\n      throw new Error('Failed to create role')\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Actualizar rol existente\r\n   * @param {string} roleId - ID del rol\r\n   * @param {Object} updates - Datos a actualizar\r\n   * @returns {Object} Rol actualizado\r\n   */\r\n  updateRole(roleId, updates) {\r\n    try {\r\n      const role = this.roles.get(roleId)\r\n      if (!role) {\r\n        throw new Error('Role not found')\r\n      }\r\n\r\n      if (role.isSystem) {\r\n        throw new Error('Cannot update system role')\r\n      }\r\n\r\n      const updatedRole = {\r\n        ...role,\r\n        ...updates,\r\n        updatedAt: Date.now(),\r\n        updatedBy: updates.updatedBy\r\n      }\r\n\r\n      this.roles.set(roleId, updatedRole)\r\n      this.logAudit('role_updated', updates.updatedBy, { roleId, roleName: role.name, updates })\r\n\r\n      return updatedRole\r\n    } catch (error) {\r\n      console.error('Error updating role:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Eliminar rol\r\n   * @param {string} roleId - ID del rol\r\n   * @param {string} deletedBy - Usuario que elimina\r\n   * @returns {boolean} True si se elimin√≥\r\n   */\r\n  deleteRole(roleId, deletedBy) {\r\n    try {\r\n      const role = this.roles.get(roleId)\r\n      if (!role) {\r\n        throw new Error('Role not found')\r\n      }\r\n\r\n      if (role.isSystem) {\r\n        throw new Error('Cannot delete system role')\r\n      }\r\n\r\n      // Verificar que no haya usuarios con este rol\r\n      for (const [userId, userRoleIds] of this.userRoles.entries()) {\r\n        if (userRoleIds.includes(roleId)) {\r\n          throw new Error('Cannot delete role: users assigned to this role')\r\n        }\r\n      }\r\n\r\n      this.roles.delete(roleId)\r\n      this.rolePermissions.delete(roleId)\r\n      this.logAudit('role_deleted', deletedBy, { roleId, roleName: role.name })\r\n\r\n      return true\r\n    } catch (error) {\r\n      console.error('Error deleting role:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Asignar rol a usuario\r\n   * @param {string} userId - ID del usuario\r\n   * @param {string} roleId - ID del rol\r\n   * @param {string} assignedBy - Usuario que asigna\r\n   * @returns {boolean} True si se asign√≥\r\n   */\r\n  assignRole(userId, roleId, assignedBy) {\r\n    try {\r\n      const role = this.roles.get(roleId)\r\n      if (!role) {\r\n        throw new Error('Role not found')\r\n      }\r\n\r\n      if (!this.userRoles.has(userId)) {\r\n        this.userRoles.set(userId, [])\r\n      }\r\n\r\n      const userRoleIds = this.userRoles.get(userId)\r\n      if (!userRoleIds.includes(roleId)) {\r\n        userRoleIds.push(roleId)\r\n        this.logAudit('role_assigned', assignedBy, { userId, roleId, roleName: role.name })\r\n      }\r\n\r\n      return true\r\n    } catch (error) {\r\n      console.error('Error assigning role:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Revocar rol de usuario\r\n   * @param {string} userId - ID del usuario\r\n   * @param {string} roleId - ID del rol\r\n   * @param {string} revokedBy - Usuario que revoca\r\n   * @returns {boolean} True si se revoc√≥\r\n   */\r\n  revokeRole(userId, roleId, revokedBy) {\r\n    try {\r\n      if (!this.userRoles.has(userId)) {\r\n        return false\r\n      }\r\n\r\n      const userRoleIds = this.userRoles.get(userId)\r\n      const index = userRoleIds.indexOf(roleId)\r\n      if (index !== -1) {\r\n        userRoleIds.splice(index, 1)\r\n        const role = this.roles.get(roleId)\r\n        this.logAudit('role_revoked', revokedBy, { userId, roleId, roleName: role?.name })\r\n        return true\r\n      }\r\n\r\n      return false\r\n    } catch (error) {\r\n      console.error('Error revoking role:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verificar si usuario tiene permiso\r\n   * @param {string} userId - ID del usuario\r\n   * @param {string} permissionId - ID del permiso\r\n   * @returns {boolean} True si tiene permiso\r\n   */\r\n  hasPermission(userId, permissionId) {\r\n    try {\r\n      const userRoleIds = this.userRoles.get(userId) || []\r\n      const allPermissions = new Set()\r\n\r\n      userRoleIds.forEach(roleId => {\r\n        const rolePerms = this.rolePermissions.get(roleId) || []\r\n        rolePerms.forEach(permId => allPermissions.add(permId))\r\n      })\r\n\r\n      return allPermissions.has(permissionId)\r\n    } catch (error) {\r\n      console.error('Error checking permission:', error)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener todos los permisos de usuario\r\n   * @param {string} userId - ID del usuario\r\n   * @returns {Array} Array de permisos\r\n   */\r\n  getUserPermissions(userId) {\r\n    try {\r\n      const userRoleIds = this.userRoles.get(userId) || []\r\n      const allPermissions = new Set()\r\n\r\n      userRoleIds.forEach(roleId => {\r\n        const rolePerms = this.rolePermissions.get(roleId) || []\r\n        rolePerms.forEach(permId => allPermissions.add(permId))\r\n      })\r\n\r\n      return Array.from(allPermissions).map(permId => this.permissions.get(permId))\r\n    } catch (error) {\r\n      console.error('Error getting user permissions:', error)\r\n      return []\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener roles de usuario\r\n   * @param {string} userId - ID del usuario\r\n   * @returns {Array} Array de roles\r\n   */\r\n  getUserRoles(userId) {\r\n    try {\r\n      const userRoleIds = this.userRoles.get(userId) || []\r\n      return userRoleIds.map(roleId => this.roles.get(roleId)).filter(Boolean)\r\n    } catch (error) {\r\n      console.error('Error getting user roles:', error)\r\n      return []\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delegar rol a otro usuario\r\n   * @param {string} delegatorId - ID del usuario que delega\r\n   * @param {string} delegateeId - ID del usuario que recibe delegaci√≥n\r\n   * @param {string} roleId - ID del rol a delegar\r\n   * @param {Object} options - Opciones de delegaci√≥n\r\n   * @returns {Object} Delegaci√≥n creada\r\n   */\r\n  delegateRole(delegatorId, delegateeId, roleId, options = {}) {\r\n    try {\r\n      // Verificar que delegador tenga el rol\r\n      if (!this.userRoles.get(delegatorId)?.includes(roleId)) {\r\n        throw new Error('Delegator does not have this role')\r\n      }\r\n\r\n      // Verificar que se pueda delegar\r\n      const role = this.roles.get(roleId)\r\n      if (role.level >= 80) {\r\n        throw new Error('Cannot delegate high-level roles')\r\n      }\r\n\r\n      const delegation = {\r\n        id: `delegation_${Date.now()}`,\r\n        delegatorId,\r\n        delegateeId,\r\n        roleId,\r\n        delegatedAt: Date.now(),\r\n        expiresAt: options.expiresAt || Date.now() + (30 * 24 * 60 * 60 * 1000), // 30 d√≠as\r\n        isActive: true,\r\n        conditions: options.conditions || {}\r\n      }\r\n\r\n      if (!this.delegations.has(delegatorId)) {\r\n        this.delegations.set(delegatorId, [])\r\n      }\r\n\r\n      this.delegations.get(delegatorId).push(delegation)\r\n      this.logAudit('role_delegated', delegatorId, { delegateeId, roleId, delegationId: delegation.id })\r\n\r\n      return delegation\r\n    } catch (error) {\r\n      console.error('Error delegating role:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Registrar evento de auditor√≠a\r\n   * @param {string} action - Acci√≥n realizada\r\n   * @param {string} userId - ID del usuario\r\n   * @param {Object} details - Detalles del evento\r\n   */\r\n  logAudit(action, userId, details = {}) {\r\n    try {\r\n      const auditEntry = {\r\n        id: `audit_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n        action,\r\n        userId,\r\n        details,\r\n        timestamp: Date.now(),\r\n        ip: details.ip || 'unknown',\r\n        userAgent: details.userAgent || 'unknown'\r\n      }\r\n\r\n      this.auditLogs.push(auditEntry)\r\n\r\n      // Mantener solo √∫ltimos 10,000 logs\r\n      if (this.auditLogs.length > 10000) {\r\n        this.auditLogs = this.auditLogs.slice(-10000)\r\n      }\r\n    } catch (error) {\r\n      console.error('Error logging audit:', error)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener logs de auditor√≠a\r\n   * @param {Object} filters - Filtros de b√∫squeda\r\n   * @returns {Array} Logs filtrados\r\n   */\r\n  getAuditLogs(filters = {}) {\r\n    try {\r\n      let logs = [...this.auditLogs]\r\n\r\n      if (filters.userId) {\r\n        logs = logs.filter(log => log.userId === filters.userId)\r\n      }\r\n\r\n      if (filters.action) {\r\n        logs = logs.filter(log => log.action === filters.action)\r\n      }\r\n\r\n      if (filters.startDate) {\r\n        logs = logs.filter(log => log.timestamp >= filters.startDate)\r\n      }\r\n\r\n      if (filters.endDate) {\r\n        logs = logs.filter(log => log.timestamp <= filters.endDate)\r\n      }\r\n\r\n      // Ordenar por timestamp descendente\r\n      logs.sort((a, b) => b.timestamp - a.timestamp)\r\n\r\n      // Limitar resultados\r\n      const limit = filters.limit || 100\r\n      return logs.slice(0, limit)\r\n    } catch (error) {\r\n      console.error('Error getting audit logs:', error)\r\n      return []\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener todos los roles\r\n   * @returns {Array} Array de roles\r\n   */\r\n  getAllRoles() {\r\n    try {\r\n      return Array.from(this.roles.values())\r\n    } catch (error) {\r\n      console.error('Error getting all roles:', error)\r\n      return []\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener todos los permisos\r\n   * @returns {Array} Array de permisos\r\n   */\r\n  getAllPermissions() {\r\n    try {\r\n      return Array.from(this.permissions.values())\r\n    } catch (error) {\r\n      console.error('Error getting all permissions:', error)\r\n      return []\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener estad√≠sticas de RBAC\r\n   * @returns {Object} Estad√≠sticas\r\n   */\r\n  getStats() {\r\n    try {\r\n      const roleStats = {}\r\n      this.roles.forEach((role, roleId) => {\r\n        roleStats[roleId] = {\r\n          name: role.name,\r\n          userCount: 0,\r\n          permissionCount: this.rolePermissions.get(roleId)?.length || 0\r\n        }\r\n      })\r\n\r\n      this.userRoles.forEach((roleIds, userId) => {\r\n        roleIds.forEach(roleId => {\r\n          if (roleStats[roleId]) {\r\n            roleStats[roleId].userCount++\r\n          }\r\n        })\r\n      })\r\n\r\n      return {\r\n        totalRoles: this.roles.size,\r\n        totalPermissions: this.permissions.size,\r\n        totalUsers: this.userRoles.size,\r\n        totalAuditLogs: this.auditLogs.length,\r\n        totalDelegations: Array.from(this.delegations.values()).reduce((sum, delegations) => sum + delegations.length, 0),\r\n        roleStats\r\n      }\r\n    } catch (error) {\r\n      console.error('Error getting RBAC stats:', error)\r\n      return {}\r\n    }\r\n  }\r\n}\r\n\r\n// Crear instancia singleton\r\nconst rbacService = new RBACService()\r\n\r\nexport default rbacService\r\n","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\supabase.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\supabaseAuth.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\supabaseClient.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\supabaseDatabase.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\supabaseServer.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\superLockService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'newLock' is assigned a value but never used.","line":74,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":74,"endColumn":30},{"ruleId":"no-unused-vars","severity":1,"message":"'now' is assigned a value but never used.","line":249,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":249,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * SUPER LOCK SERVICE - Soluci√≥n Radical Anti-Duplicaci√≥n\r\n * Elimina COMPLETAMENTE la posibilidad de race conditions\r\n */\r\n\r\nimport { supabase } from './supabaseClient.js'\r\nimport logger from './logger.js'\r\n\r\nclass SuperLockService {\r\n  constructor() {\r\n    this.lockPrefix = 'super_folder_lock_'\r\n    this.lockTimeout = 30 * 1000 // 30 segundos timeout\r\n    this.retryDelay = 50 // 50ms entre intentos\r\n    this.maxRetries = 50\r\n    this.activeLocks = new Map() // Cache local para locks activos\r\n  }\r\n\r\n  /**\r\n   * ADQUIRIR LOCK CON VERIFICACI√ìN M√öLTIPLE\r\n   */\r\n  async acquireSuperLock(employeeEmail, operation = 'create_folder') {\r\n    const lockKey = `${this.lockPrefix}${employeeEmail}`\r\n    const lockId = `super_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n    const expiresAt = new Date(Date.now() + this.lockTimeout).toISOString()\r\n\r\n    logger.info('SuperLockService', `üîí ADQUIRIENDO SUPER LOCK para ${employeeEmail}: ${lockId}`)\r\n\r\n    for (let attempt = 1; attempt <= this.maxRetries; attempt++) {\r\n      try {\r\n        // 1. VERIFICACI√ìN LOCAL PRIMERO\r\n        if (this.activeLocks.has(lockKey)) {\r\n          const existingLocal = this.activeLocks.get(lockKey)\r\n          if (new Date(existingLocal.expiresAt) > new Date()) {\r\n            logger.warn('SuperLockService', `‚ö†Ô∏è LOCK LOCAL ACTIVO para ${employeeEmail}`)\r\n            await this.delay(this.retryDelay * attempt)\r\n            continue\r\n          } else {\r\n            // Limpiar lock local expirado\r\n            this.activeLocks.delete(lockKey)\r\n          }\r\n        }\r\n\r\n        // 2. VERIFICACI√ìN EN BASE DE DATOS\r\n        const { data: existingLock } = await supabase\r\n          .from('operation_locks')\r\n          .select('*')\r\n          .eq('lock_key', lockKey)\r\n          .eq('is_active', true)\r\n          .gt('expires_at', new Date().toISOString())\r\n          .maybeSingle()\r\n\r\n        if (existingLock) {\r\n          logger.warn('SuperLockService', `‚ö†Ô∏è LOCK DB ACTIVO para ${employeeEmail}: ${existingLock.lock_id}`)\r\n          \r\n          if (attempt === this.maxRetries) {\r\n            throw new Error(`Lock activo no puede ser liberado despu√©s de ${this.maxRetries} intentos`)\r\n          }\r\n          \r\n          await this.delay(this.retryDelay * attempt)\r\n          continue\r\n        }\r\n\r\n        // 3. VERIFICACI√ìN ADICIONAL EN GOOGLE DRIVE\r\n        const driveExists = await this.checkDriveExists(employeeEmail)\r\n        if (driveExists) {\r\n          logger.warn('SuperLockService', `‚ö†Ô∏è CARPETA YA EXISTE EN DRIVE para ${employeeEmail}`)\r\n          \r\n          // Crear lock preventivo para evitar m√°s intentos\r\n          await this.createPreventiveLock(lockKey, employeeEmail)\r\n          throw new Error(`Carpeta ya existe en Google Drive para ${employeeEmail}`)\r\n        }\r\n\r\n        // 4. ADQUIRIR LOCK EN BASE DE DATOS\r\n        const { data: newLock, error } = await supabase\r\n          .from('operation_locks')\r\n          .insert({\r\n            lock_key: lockKey,\r\n            lock_id: lockId,\r\n            operation_type: operation,\r\n            employee_email: employeeEmail,\r\n            acquired_at: new Date().toISOString(),\r\n            expires_at: expiresAt,\r\n            is_active: true\r\n          })\r\n          .select()\r\n          .single()\r\n\r\n        if (error) {\r\n          logger.error('SuperLockService', `‚ùå Error adquiriendo lock DB: ${error.message}`)\r\n          if (attempt === this.maxRetries) {\r\n            throw error\r\n          }\r\n          await this.delay(this.retryDelay * attempt)\r\n          continue\r\n        }\r\n\r\n        // 5. CACHEAR LOCK LOCALMENTE\r\n        this.activeLocks.set(lockKey, {\r\n          lockId,\r\n          expiresAt,\r\n          timestamp: Date.now()\r\n        })\r\n\r\n        logger.info('SuperLockService', `‚úÖ SUPER LOCK ADQUIRIDO: ${lockId}`)\r\n        return lockId\r\n\r\n      } catch (error) {\r\n        logger.error('SuperLockService', `‚ùå Error en intento ${attempt}: ${error.message}`)\r\n        if (attempt === this.maxRetries) {\r\n          throw error\r\n        }\r\n        await this.delay(this.retryDelay * attempt)\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * VERIFICAR SI CARPETA EXISTE EN GOOGLE DRIVE\r\n   */\r\n  async checkDriveExists(employeeEmail) {\r\n    try {\r\n      // Esta funci√≥n debe ser implementada para verificar en Google Drive\r\n      // Por ahora simulamos la verificaci√≥n\r\n      const { data: existing } = await supabase\r\n        .from('employee_folders')\r\n        .select('id')\r\n        .eq('employee_email', employeeEmail)\r\n        .maybeSingle()\r\n\r\n      return !!existing\r\n    } catch (error) {\r\n      logger.error('SuperLockService', `‚ùå Error verificando Drive: ${error.message}`)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * CREAR LOCK PREVENTIVO\r\n   */\r\n  async createPreventiveLock(lockKey, employeeEmail) {\r\n    try {\r\n      const preventiveId = `preventive_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n      const expiresAt = new Date(Date.now() + this.lockTimeout * 2).toISOString()\r\n\r\n      await supabase\r\n        .from('operation_locks')\r\n        .insert({\r\n          lock_key: lockKey,\r\n          lock_id: preventiveId,\r\n          operation_type: 'preventive_lock',\r\n          employee_email: employeeEmail,\r\n          acquired_at: new Date().toISOString(),\r\n          expires_at: expiresAt,\r\n          is_active: true\r\n        })\r\n\r\n      logger.info('SuperLockService', `üîí LOCK PREVENTIVO CREADO para ${employeeEmail}`)\r\n    } catch (error) {\r\n      logger.error('SuperLockService', `‚ùå Error creando lock preventivo: ${error.message}`)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * LIBERAR LOCK CON LIMPIEZA LOCAL\r\n   */\r\n  async releaseSuperLock(lockId, employeeEmail) {\r\n    try {\r\n      logger.info('SuperLockService', `üîì LIBERANDO SUPER LOCK: ${lockId}`)\r\n      \r\n      // Liberar en base de datos\r\n      const { error } = await supabase\r\n        .from('operation_locks')\r\n        .update({\r\n          is_active: false,\r\n          released_at: new Date().toISOString()\r\n        })\r\n        .eq('lock_id', lockId)\r\n\r\n      if (error) {\r\n        logger.error('SuperLockService', `‚ùå Error liberando lock DB: ${error.message}`)\r\n        throw error\r\n      }\r\n\r\n      // Limpiar cache local\r\n      const lockKey = `${this.lockPrefix}${employeeEmail}`\r\n      this.activeLocks.delete(lockKey)\r\n\r\n      logger.info('SuperLockService', `‚úÖ SUPER LOCK LIBERADO: ${lockId}`)\r\n    } catch (error) {\r\n      logger.error('SuperLockService', `‚ùå Error liberando super lock ${lockId}: ${error.message}`)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * EJECUTAR CON SUPER LOCK\r\n   */\r\n  async withSuperLock(employeeEmail, fn, operation = 'create_folder') {\r\n    let lockId = null\r\n    try {\r\n      lockId = await this.acquireSuperLock(employeeEmail, operation)\r\n      const result = await fn()\r\n      \r\n      // Verificar resultado antes de liberar\r\n      if (result && result.success) {\r\n        logger.info('SuperLockService', `‚úÖ Operaci√≥n exitosa para ${employeeEmail}`)\r\n      }\r\n      \r\n      return result\r\n    } catch (error) {\r\n      logger.error('SuperLockService', `‚ùå Error en withSuperLock para ${employeeEmail}: ${error.message}`)\r\n      throw error\r\n    } finally {\r\n      if (lockId) {\r\n        await this.releaseSuperLock(lockId, employeeEmail)\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * UTILIDAD PARA DELAYS\r\n   */\r\n  delay(ms) {\r\n    return new Promise(resolve => setTimeout(resolve, ms))\r\n  }\r\n\r\n  /**\r\n   * LIMPIAR LOCKS EXPIRADOS\r\n   */\r\n  async cleanupExpiredLocks() {\r\n    try {\r\n      logger.info('SuperLockService', 'üßπ Limpiando locks expirados...')\r\n      \r\n      const { error } = await supabase\r\n        .from('operation_locks')\r\n        .update({\r\n          is_active: false,\r\n          released_at: new Date().toISOString()\r\n        })\r\n        .lt('expires_at', new Date().toISOString())\r\n        .eq('is_active', true)\r\n\r\n      if (error) {\r\n        logger.error('SuperLockService', `‚ùå Error limpiando locks: ${error.message}`)\r\n        throw error\r\n      }\r\n\r\n      // Limpiar cache local expirado\r\n      const now = Date.now()\r\n      for (const [key, lock] of this.activeLocks.entries()) {\r\n        if (new Date(lock.expiresAt) <= new Date()) {\r\n          this.activeLocks.delete(key)\r\n        }\r\n      }\r\n\r\n      logger.info('SuperLockService', '‚úÖ Locks expirados limpiados')\r\n    } catch (error) {\r\n      logger.error('SuperLockService', `‚ùå Error en cleanup: ${error.message}`)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * OBTENER ESTAD√çSTICAS\r\n   */\r\n  async getSuperLockStats() {\r\n    try {\r\n      const { data: activeLocks } = await supabase\r\n        .from('operation_locks')\r\n        .select('*')\r\n        .eq('is_active', true)\r\n        .gt('expires_at', new Date().toISOString())\r\n\r\n      return {\r\n        active: activeLocks?.length || 0,\r\n        localCache: this.activeLocks.size,\r\n        total: (activeLocks?.length || 0) + this.activeLocks.size\r\n      }\r\n    } catch (error) {\r\n      logger.error('SuperLockService', `‚ùå Error obteniendo estad√≠sticas: ${error.message}`)\r\n      return { active: 0, localCache: 0, total: 0 }\r\n    }\r\n  }\r\n}\r\n\r\n// Instancia singleton\r\nconst superLockService = new SuperLockService()\r\n\r\nexport default superLockService\r\nexport { SuperLockService }","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\unifiedGoogleDriveService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\lib\\webhookHandler.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\advancedTemplateService.js","messages":[{"ruleId":"import/no-anonymous-default-export","severity":1,"message":"Assign instance to a variable before exporting as module default","line":353,"column":1,"nodeType":"ExportDefaultDeclaration","endLine":353,"endColumn":45}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Advanced Template Service\r\n * Servicio para gestionar plantillas avanzadas con variables din√°micas\r\n * por canal (WhatsApp, Email, SMS) e industria\r\n * \r\n * ‚úÖ NO MODIFICA c√≥digo existente\r\n * ‚úÖ Completamente independiente\r\n * ‚úÖ Puede ser desactivado sin afectar el sistema\r\n */\r\n\r\nimport { supabase } from '../lib/supabase.js'\r\n\r\nclass AdvancedTemplateService {\r\n  constructor() {\r\n    this.templates = new Map()\r\n    this.cache = new Map()\r\n    this.cacheExpiry = 5 * 60 * 1000 // 5 minutos\r\n  }\r\n\r\n  /**\r\n   * Crear una nueva plantilla avanzada\r\n   * @param {Object} templateData - Datos de la plantilla\r\n   * @returns {Promise<Object>} Plantilla creada\r\n   */\r\n  async createTemplate(templateData) {\r\n    try {\r\n      const {\r\n        name,\r\n        description,\r\n        channel_type, // 'whatsapp', 'email', 'sms'\r\n        industry_sector,\r\n        content,\r\n        variables = [],\r\n        preview_html\r\n      } = templateData\r\n\r\n      // Validar datos\r\n      if (!name || !channel_type || !content) {\r\n        return {\r\n          error: 'Faltan campos requeridos: name, channel_type, content',\r\n          success: false\r\n        }\r\n      }\r\n\r\n      // Insertar en Supabase\r\n      const { data, error } = await supabase\r\n        .from('advanced_templates')\r\n        .insert([\r\n          {\r\n            name,\r\n            description,\r\n            channel_type,\r\n            industry_sector,\r\n            content,\r\n            variables,\r\n            preview_html,\r\n            created_at: new Date().toISOString()\r\n          }\r\n        ])\r\n        .select()\r\n\r\n      if (error) {\r\n        console.error('Error creating template:', error)\r\n        return { error: error.message, success: false }\r\n      }\r\n\r\n      // Limpiar cach√©\r\n      this.clearCache()\r\n\r\n      return {\r\n        data: data[0],\r\n        success: true,\r\n        message: 'Plantilla creada exitosamente'\r\n      }\r\n    } catch (error) {\r\n      console.error('Error in createTemplate:', error)\r\n      return { error: error.message, success: false }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener plantillas por canal\r\n   * @param {string} channel - Tipo de canal\r\n   * @returns {Promise<Array>} Plantillas del canal\r\n   */\r\n  async getTemplatesByChannel(channel) {\r\n    try {\r\n      const cacheKey = `templates_channel_${channel}`\r\n      const cached = this.getFromCache(cacheKey)\r\n      if (cached) return cached\r\n\r\n      const { data, error } = await supabase\r\n        .from('advanced_templates')\r\n        .select('*')\r\n        .eq('channel_type', channel)\r\n        .order('created_at', { ascending: false })\r\n\r\n      if (error) {\r\n        console.error('Error fetching templates:', error)\r\n        return []\r\n      }\r\n\r\n      this.setCache(cacheKey, data)\r\n      return data || []\r\n    } catch (error) {\r\n      console.error('Error in getTemplatesByChannel:', error)\r\n      return []\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener plantillas por industria\r\n   * @param {string} industry - Sector industrial\r\n   * @returns {Promise<Array>} Plantillas de la industria\r\n   */\r\n  async getTemplatesByIndustry(industry) {\r\n    try {\r\n      const cacheKey = `templates_industry_${industry}`\r\n      const cached = this.getFromCache(cacheKey)\r\n      if (cached) return cached\r\n\r\n      const { data, error } = await supabase\r\n        .from('advanced_templates')\r\n        .select('*')\r\n        .eq('industry_sector', industry)\r\n        .order('created_at', { ascending: false })\r\n\r\n      if (error) {\r\n        console.error('Error fetching templates:', error)\r\n        return []\r\n      }\r\n\r\n      this.setCache(cacheKey, data)\r\n      return data || []\r\n    } catch (error) {\r\n      console.error('Error in getTemplatesByIndustry:', error)\r\n      return []\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Renderizar plantilla con variables din√°micas\r\n   * @param {string} templateId - ID de la plantilla\r\n   * @param {Object} variables - Variables a reemplazar\r\n   * @returns {Promise<string>} Contenido renderizado\r\n   */\r\n  async renderTemplate(templateId, variables = {}) {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('advanced_templates')\r\n        .select('content, variables')\r\n        .eq('id', templateId)\r\n        .single()\r\n\r\n      if (error) {\r\n        console.error('Error fetching template:', error)\r\n        return ''\r\n      }\r\n\r\n      let content = data.content\r\n\r\n      // Reemplazar variables din√°micas\r\n      Object.entries(variables).forEach(([key, value]) => {\r\n        const regex = new RegExp(`{{${key}}}`, 'g')\r\n        content = content.replace(regex, value || '')\r\n      })\r\n\r\n      return content\r\n    } catch (error) {\r\n      console.error('Error in renderTemplate:', error)\r\n      return ''\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Actualizar plantilla\r\n   * @param {string} templateId - ID de la plantilla\r\n   * @param {Object} updates - Actualizaciones\r\n   * @returns {Promise<Object>} Plantilla actualizada\r\n   */\r\n  async updateTemplate(templateId, updates) {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('advanced_templates')\r\n        .update({\r\n          ...updates,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('id', templateId)\r\n        .select()\r\n\r\n      if (error) {\r\n        console.error('Error updating template:', error)\r\n        return { error: error.message, success: false }\r\n      }\r\n\r\n      this.clearCache()\r\n\r\n      return {\r\n        data: data[0],\r\n        success: true,\r\n        message: 'Plantilla actualizada exitosamente'\r\n      }\r\n    } catch (error) {\r\n      console.error('Error in updateTemplate:', error)\r\n      return { error: error.message, success: false }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Eliminar plantilla\r\n   * @param {string} templateId - ID de la plantilla\r\n   * @returns {Promise<Object>} Resultado de la eliminaci√≥n\r\n   */\r\n  async deleteTemplate(templateId) {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('advanced_templates')\r\n        .delete()\r\n        .eq('id', templateId)\r\n\r\n      if (error) {\r\n        console.error('Error deleting template:', error)\r\n        return { error: error.message, success: false }\r\n      }\r\n\r\n      this.clearCache()\r\n\r\n      return {\r\n        success: true,\r\n        message: 'Plantilla eliminada exitosamente'\r\n      }\r\n    } catch (error) {\r\n      console.error('Error in deleteTemplate:', error)\r\n      return { error: error.message, success: false }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener todas las plantillas\r\n   * @returns {Promise<Array>} Todas las plantillas\r\n   */\r\n  async getAllTemplates() {\r\n    try {\r\n      const cacheKey = 'all_templates'\r\n      const cached = this.getFromCache(cacheKey)\r\n      if (cached) return cached\r\n\r\n      const { data, error } = await supabase\r\n        .from('advanced_templates')\r\n        .select('*')\r\n        .order('created_at', { ascending: false })\r\n\r\n      if (error) {\r\n        console.error('Error fetching templates:', error)\r\n        return []\r\n      }\r\n\r\n      this.setCache(cacheKey, data)\r\n      return data || []\r\n    } catch (error) {\r\n      console.error('Error in getAllTemplates:', error)\r\n      return []\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener plantilla por ID\r\n   * @param {string} templateId - ID de la plantilla\r\n   * @returns {Promise<Object>} Plantilla\r\n   */\r\n  async getTemplateById(templateId) {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('advanced_templates')\r\n        .select('*')\r\n        .eq('id', templateId)\r\n        .single()\r\n\r\n      if (error) {\r\n        console.error('Error fetching template:', error)\r\n        return null\r\n      }\r\n\r\n      return data\r\n    } catch (error) {\r\n      console.error('Error in getTemplateById:', error)\r\n      return null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validar variables en plantilla\r\n   * @param {string} content - Contenido de la plantilla\r\n   * @returns {Array} Variables encontradas\r\n   */\r\n  extractVariables(content) {\r\n    const regex = /{{(\\w+)}}/g\r\n    const variables = []\r\n    let match\r\n\r\n    while ((match = regex.exec(content)) !== null) {\r\n      if (!variables.includes(match[1])) {\r\n        variables.push(match[1])\r\n      }\r\n    }\r\n\r\n    return variables\r\n  }\r\n\r\n  /**\r\n   * Generar preview HTML\r\n   * @param {string} content - Contenido de la plantilla\r\n   * @param {Object} sampleVariables - Variables de ejemplo\r\n   * @returns {string} HTML de preview\r\n   */\r\n  generatePreview(content, sampleVariables = {}) {\r\n    let preview = content\r\n\r\n    Object.entries(sampleVariables).forEach(([key, value]) => {\r\n      const regex = new RegExp(`{{${key}}}`, 'g')\r\n      preview = preview.replace(regex, value || `[${key}]`)\r\n    })\r\n\r\n    return preview\r\n  }\r\n\r\n  // M√©todos de cach√©\r\n  getFromCache(key) {\r\n    const cached = this.cache.get(key)\r\n    if (!cached) return null\r\n\r\n    if (Date.now() - cached.timestamp > this.cacheExpiry) {\r\n      this.cache.delete(key)\r\n      return null\r\n    }\r\n\r\n    return cached.data\r\n  }\r\n\r\n  setCache(key, data) {\r\n    this.cache.set(key, {\r\n      data,\r\n      timestamp: Date.now()\r\n    })\r\n  }\r\n\r\n  clearCache() {\r\n    this.cache.clear()\r\n  }\r\n}\r\n\r\nexport default new AdvancedTemplateService()\r\n","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\aiRecommendationsService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\alternativeAnalyticsService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\analyticsInsightsService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\brevoCampaignService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\brevoService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\calendarService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\combinedEmployeeService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'usersError' is assigned a value but never used.","line":210,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":210,"endColumn":43},{"ruleId":"no-unused-vars","severity":1,"message":"'companiesError' is assigned a value but never used.","line":217,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":217,"endColumn":51},{"ruleId":"import/no-anonymous-default-export","severity":1,"message":"Assign object to a variable before exporting as module default","line":243,"column":1,"nodeType":"ExportDefaultDeclaration","endLine":250,"endColumn":3}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Servicio combinado para contar usuarios reales + empleados virtuales\r\n// Cuenta users + companies (employee_type = 'virtual')\r\n\r\nimport { supabase } from '../lib/supabase.js';\r\n\r\nexport const getEmployeeCount = async () => {\r\n  try {\r\n    // Contar usuarios reales\r\n    const { count: userCount, error: userError } = await supabase\r\n      .from('users')\r\n      .select('*', { count: 'exact', head: true });\r\n    \r\n    if (userError) {\r\n      console.error('Error contando usuarios:', userError);\r\n      return 0;\r\n    }\r\n    \r\n    // Contar empleados virtuales en companies\r\n    const { count: companyCount, error: companyError } = await supabase\r\n      .from('companies')\r\n      .select('*', { count: 'exact', head: true })\r\n      .eq('employee_type', 'virtual');\r\n    \r\n    if (companyError) {\r\n      console.error('Error contando empresas virtuales:', companyError);\r\n      return userCount || 0;\r\n    }\r\n    \r\n    // Total es la suma de ambos\r\n    const totalEmployees = (userCount || 0) + (companyCount || 0);\r\n    \r\n    console.log(`Usuarios reales: ${userCount}, Empresas virtuales: ${companyCount}, Total: ${totalEmployees}`);\r\n    \r\n    return totalEmployees;\r\n  } catch (error) {\r\n    console.error('Error obteniendo conteo de empleados:', error);\r\n    return 0;\r\n  }\r\n};\r\n\r\nexport const getEmployeeFolders = async (page = 1, limit = 50) => {\r\n  try {\r\n    const offset = (page - 1) * limit;\r\n    \r\n    // Obtener usuarios reales\r\n    const { data: users, error: usersError } = await supabase\r\n      .from('users')\r\n      .select('*')\r\n      .range(offset, offset + Math.floor(limit/2) - 1);\r\n    \r\n    if (usersError) {\r\n      console.error('Error obteniendo usuarios:', usersError);\r\n    }\r\n    \r\n    // Obtener empleados virtuales de companies\r\n    const { data: companies, error: companiesError } = await supabase\r\n      .from('companies')\r\n      .select('*')\r\n      .eq('employee_type', 'virtual')\r\n      .range(offset, offset + Math.floor(limit/2) - 1);\r\n    \r\n    if (companiesError) {\r\n      console.error('Error obteniendo empresas virtuales:', companiesError);\r\n    }\r\n    \r\n    // Combinar y transformar datos\r\n    const allEmployees = [\r\n      ...(users || []).map(user => ({\r\n        id: user.id,\r\n        name: user.full_name || user.name || 'Sin nombre',\r\n        email: user.email,\r\n        type: 'real',\r\n        department: user.department || 'Sin departamento',\r\n        position: user.position || 'Sin posici√≥n',\r\n        phone: user.phone || 'Sin tel√©fono',\r\n        status: user.status || 'active',\r\n        created_at: user.created_at,\r\n        is_active: user.is_active\r\n      })),\r\n      ...(companies || []).map(company => ({\r\n        id: company.id,\r\n        name: company.name,\r\n        email: company.email || `${company.name.toLowerCase().replace(/\\s+/g, '.')}@staffhub.com`,\r\n        type: 'virtual',\r\n        department: company.department || 'Sin departamento',\r\n        position: company.position || 'Sin posici√≥n',\r\n        phone: company.phone || 'Sin tel√©fono',\r\n        status: company.status || 'active',\r\n        created_at: company.created_at,\r\n        is_active: company.status === 'active'\r\n      }))\r\n    ];\r\n    \r\n    return allEmployees;\r\n  } catch (error) {\r\n    console.error('Error obteniendo carpetas de empleados:', error);\r\n    return [];\r\n  }\r\n};\r\n\r\nexport const getEmployeeById = async (id) => {\r\n  try {\r\n    // Primero intentar buscar en users\r\n    const { data: user, error: userError } = await supabase\r\n      .from('users')\r\n      .select('*')\r\n      .eq('id', id)\r\n      .single();\r\n    \r\n    if (!userError && user) {\r\n      return {\r\n        ...user,\r\n        type: 'real'\r\n      };\r\n    }\r\n    \r\n    // Si no se encuentra en users, buscar en companies\r\n    const { data: company, error: companyError } = await supabase\r\n      .from('companies')\r\n      .select('*')\r\n      .eq('id', id)\r\n      .eq('employee_type', 'virtual')\r\n      .single();\r\n    \r\n    if (!companyError && company) {\r\n      return {\r\n        ...company,\r\n        type: 'virtual',\r\n        email: company.email || `${company.name.toLowerCase().replace(/\\s+/g, '.')}@staffhub.com`\r\n      };\r\n    }\r\n    \r\n    return null;\r\n  } catch (error) {\r\n    console.error('Error obteniendo empleado por ID:', error);\r\n    return null;\r\n  }\r\n};\r\n\r\nexport const updateEmployee = async (id, updates) => {\r\n  try {\r\n    // Primero intentar actualizar en users\r\n    const { data: user, error: userError } = await supabase\r\n      .from('users')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n    \r\n    if (!userError && user) {\r\n      return { ...user, type: 'real' };\r\n    }\r\n    \r\n    // Si no se encuentra en users, intentar en companies\r\n    const { data: company, error: companyError } = await supabase\r\n      .from('companies')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .eq('employee_type', 'virtual')\r\n      .select()\r\n      .single();\r\n    \r\n    if (!companyError && company) {\r\n      return { ...company, type: 'virtual' };\r\n    }\r\n    \r\n    throw new Error('Empleado no encontrado');\r\n  } catch (error) {\r\n    console.error('Error actualizando empleado:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\nexport const deleteEmployee = async (id) => {\r\n  try {\r\n    // Primero intentar eliminar de users\r\n    const { error: userError } = await supabase\r\n      .from('users')\r\n      .delete()\r\n      .eq('id', id);\r\n    \r\n    if (!userError) {\r\n      return true;\r\n    }\r\n    \r\n    // Si no se encuentra en users, intentar eliminar de companies\r\n    const { error: companyError } = await supabase\r\n      .from('companies')\r\n      .delete()\r\n      .eq('id', id)\r\n      .eq('employee_type', 'virtual');\r\n    \r\n    if (!companyError) {\r\n      return true;\r\n    }\r\n    \r\n    throw new Error('Empleado no encontrado');\r\n  } catch (error) {\r\n    console.error('Error eliminando empleado:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\nexport const searchEmployees = async (query, page = 1, limit = 20) => {\r\n  try {\r\n    const offset = (page - 1) * limit;\r\n    const searchTerm = `%${query}%`;\r\n    \r\n    // Buscar en users\r\n    const { data: users, error: usersError } = await supabase\r\n      .from('users')\r\n      .select('*')\r\n      .or(`full_name.ilike.${searchTerm},email.ilike.${searchTerm},department.ilike.${searchTerm},position.ilike.${searchTerm}`)\r\n      .range(offset, offset + Math.floor(limit/2) - 1);\r\n    \r\n    // Buscar en companies\r\n    const { data: companies, error: companiesError } = await supabase\r\n      .from('companies')\r\n      .select('*')\r\n      .eq('employee_type', 'virtual')\r\n      .or(`name.ilike.${searchTerm},email.ilike.${searchTerm},department.ilike.${searchTerm},position.ilike.${searchTerm}`)\r\n      .range(offset, offset + Math.floor(limit/2) - 1);\r\n    \r\n    // Combinar resultados\r\n    const allEmployees = [\r\n      ...(users || []).map(user => ({\r\n        ...user,\r\n        type: 'real'\r\n      })),\r\n      ...(companies || []).map(company => ({\r\n        ...company,\r\n        type: 'virtual'\r\n      }))\r\n    ];\r\n    \r\n    return allEmployees;\r\n  } catch (error) {\r\n    console.error('Error buscando empleados:', error);\r\n    return [];\r\n  }\r\n};\r\n\r\nexport default {\r\n  getEmployeeCount,\r\n  getEmployeeFolders,\r\n  getEmployeeById,\r\n  updateEmployee,\r\n  deleteEmployee,\r\n  searchEmployees\r\n};","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\communicationService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\companyChannelCredentialsService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\companyKnowledgeService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'timestamp' is assigned a value but never used.","line":116,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":116,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Servicio de Creaci√≥n Autom√°tica de Bases de Conocimiento Empresariales\r\n * \r\n * Este servicio implementa el flujo completo:\r\n * 1. Creaci√≥n autom√°tica de carpeta en Google Drive cuando se registra una empresa\r\n * 2. Vectorizaci√≥n de documentos con IA (Groq/Gemini)\r\n * 3. Sincronizaci√≥n con Supabase para b√∫squeda sem√°ntica\r\n * 4. Configuraci√≥n de estructura de conocimiento por empresa\r\n * \r\n * Caracter√≠sticas principales:\r\n * - Creaci√≥n autom√°tica de estructura de carpetas en Google Drive\r\n * - Vectorizaci√≥n de documentos usando embeddings\r\n * - Indexaci√≥n sem√°ntica en Supabase\r\n * - Sincronizaci√≥n bidireccional\r\n * - Gesti√≥n de permisos por empresa\r\n * - Soporte para m√∫ltiples formatos de documento\r\n */\r\n\r\nimport { supabase } from '../lib/supabase.js';\r\nimport googleDriveService from '../lib/googleDrive.js';\r\nimport embeddingService from './embeddingService.js';\r\nimport fileContentExtractor from './fileContentExtractor.js';\r\n\r\nclass CompanyKnowledgeService {\r\n  constructor() {\r\n    this.knowledgeCache = new Map();\r\n    this.processingQueue = [];\r\n    this.isProcessing = false;\r\n  }\r\n\r\n  /**\r\n   * Crear base de conocimiento completa para una empresa nueva\r\n   * @param {Object} companyData - Datos de la empresa\r\n   * @param {string} userId - ID del usuario que crea la empresa\r\n   * @returns {Promise<Object>} Resultado de la creaci√≥n\r\n   */\r\n  async createCompanyKnowledgeBase(companyData, userId) {\r\n    try {\r\n      console.log(`üöÄ Creando base de conocimiento para empresa: ${companyData.name}`);\r\n      \r\n      const companyId = companyData.id;\r\n      \r\n      // 1. Verificar que Google Drive est√© configurado para el usuario\r\n      const userProfile = await this.getUserGoogleProfile(userId);\r\n      if (!userProfile || !userProfile.google_refresh_token) {\r\n        throw new Error('El usuario debe tener Google Drive configurado para crear una base de conocimiento');\r\n      }\r\n\r\n      // 2. Autenticar con Google Drive\r\n      await googleDriveService.setTokens({\r\n        refresh_token: userProfile.google_refresh_token\r\n      });\r\n\r\n      // 3. Crear estructura de carpetas en Google Drive\r\n      const driveStructure = await this.createDriveFolderStructure(companyData, userId);\r\n      \r\n      // 4. Crear registros en la base de datos\r\n      const knowledgeBase = await this.createKnowledgeBaseRecords(companyId, driveStructure);\r\n      \r\n      // 5. Inicializar categor√≠as por defecto\r\n      await this.initializeDefaultCategories(companyId);\r\n      \r\n      // 6. Crear FAQs iniciales basadas en el tipo de empresa\r\n      await this.createInitialFAQs(companyData, companyId);\r\n      \r\n      // 7. Configurar permisos y acceso\r\n      await this.setupKnowledgePermissions(companyId, userId);\r\n\r\n      const result = {\r\n        success: true,\r\n        companyId,\r\n        driveStructure,\r\n        knowledgeBase,\r\n        message: `Base de conocimiento creada exitosamente para ${companyData.name}`\r\n      };\r\n\r\n      console.log('‚úÖ Base de conocimiento creada:', result);\r\n      return result;\r\n\r\n    } catch (error) {\r\n      console.error('‚ùå Error creando base de conocimiento:', error);\r\n      throw new Error(`Error al crear base de conocimiento: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener perfil de Google del usuario\r\n   * @param {string} userId - ID del usuario\r\n   * @returns {Promise<Object>} Perfil del usuario con tokens de Google\r\n   */\r\n  async getUserGoogleProfile(userId) {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('users')\r\n        .select('google_refresh_token, google_access_token, email')\r\n        .eq('id', userId)\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      return data;\r\n    } catch (error) {\r\n      console.error('Error obteniendo perfil de Google:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Crear estructura completa de carpetas en Google Drive\r\n   * @param {Object} companyData - Datos de la empresa\r\n   * @param {string} userId - ID del usuario\r\n   * @returns {Promise<Object>} Estructura de carpetas creadas\r\n   */\r\n  async createDriveFolderStructure(companyData, userId) {\r\n    try {\r\n      const companyName = companyData.name.replace(/[^a-zA-Z0-9s]/g, '').trim();\r\n      const timestamp = new Date().toISOString().split('T')[0];\r\n      \r\n      // 1. Carpeta principal de la empresa\r\n      const mainFolder = await googleDriveService.createFolder(\r\n        `${companyName} - Base de Conocimiento`\r\n      );\r\n\r\n      // 2. Subcarpetas organizadas por tipo de contenido\r\n      const subfolders = await Promise.all([\r\n        // Documentos empresariales\r\n        googleDriveService.createFolder('01_Documentos_Empresariales', mainFolder.id),\r\n        // Pol√≠ticas y procedimientos\r\n        googleDriveService.createFolder('02_Politicas_Procedimientos', mainFolder.id),\r\n        // FAQs y gu√≠as\r\n        googleDriveService.createFolder('03_FAQs_Guias', mainFolder.id),\r\n        // Capacitaci√≥n\r\n        googleDriveService.createFolder('04_Capacitacion', mainFolder.id),\r\n        // Formatos y plantillas\r\n        googleDriveService.createFolder('05_Formatos_Plantillas', mainFolder.id),\r\n        // Multimedia\r\n        googleDriveService.createFolder('06_Multimedia', mainFolder.id)\r\n      ]);\r\n\r\n      // 3. Compartir carpeta principal con el usuario\r\n      const userProfile = await this.getUserGoogleProfile(userId);\r\n      if (userProfile?.email) {\r\n        await googleDriveService.shareFolder(mainFolder.id, userProfile.email, 'writer');\r\n      }\r\n\r\n      const structure = {\r\n        mainFolder: {\r\n          id: mainFolder.id,\r\n          name: mainFolder.name,\r\n          url: `https://drive.google.com/drive/folders/${mainFolder.id}`\r\n        },\r\n        subfolders: {\r\n          documents: {\r\n            id: subfolders[0].id,\r\n            name: subfolders[0].name,\r\n            type: 'documents'\r\n          },\r\n          policies: {\r\n            id: subfolders[1].id,\r\n            name: subfolders[1].name,\r\n            type: 'policies'\r\n          },\r\n          faqs: {\r\n            id: subfolders[2].id,\r\n            name: subfolders[2].name,\r\n            type: 'faqs'\r\n          },\r\n          training: {\r\n            id: subfolders[3].id,\r\n            name: subfolders[3].name,\r\n            type: 'training'\r\n          },\r\n          templates: {\r\n            id: subfolders[4].id,\r\n            name: subfolders[4].name,\r\n            type: 'templates'\r\n          },\r\n          multimedia: {\r\n            id: subfolders[5].id,\r\n            name: subfolders[5].name,\r\n            type: 'multimedia'\r\n          }\r\n        },\r\n        createdAt: new Date().toISOString(),\r\n        createdBy: userId\r\n      };\r\n\r\n      console.log('üìÅ Estructura de carpetas creada:', structure);\r\n      return structure;\r\n\r\n    } catch (error) {\r\n      console.error('Error creando estructura de carpetas:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Crear registros en la base de datos para la base de conocimiento\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {Object} driveStructure - Estructura de carpetas de Google Drive\r\n   * @returns {Promise<Object>} Registros creados\r\n   */\r\n  async createKnowledgeBaseRecords(companyId, driveStructure) {\r\n    try {\r\n      // 1. Crear registro principal de la base de conocimiento\r\n      const { data: knowledgeBase, error: kbError } = await supabase\r\n        .from('company_knowledge_bases')\r\n        .insert({\r\n          company_id: companyId,\r\n          drive_folder_id: driveStructure.mainFolder.id,\r\n          drive_folder_url: driveStructure.mainFolder.url,\r\n          status: 'active',\r\n          settings: {\r\n            auto_vectorize: true,\r\n            auto_sync: true,\r\n            supported_formats: ['pdf', 'doc', 'docx', 'txt', 'md'],\r\n            max_file_size: 50 * 1024 * 1024, // 50MB\r\n            embedding_model: 'groq'\r\n          },\r\n          created_at: new Date().toISOString()\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (kbError) throw kbError;\r\n\r\n      // 2. Crear registros para las subcarpetas\r\n      const folderRecords = Object.entries(driveStructure.subfolders).map(([key, folder]) => ({\r\n        company_id: companyId,\r\n        knowledge_base_id: knowledgeBase.id,\r\n        folder_type: folder.type,\r\n        drive_folder_id: folder.id,\r\n        drive_folder_name: folder.name,\r\n        created_at: new Date().toISOString()\r\n      }));\r\n\r\n      const { data: folders, error: foldersError } = await supabase\r\n        .from('knowledge_folders')\r\n        .insert(folderRecords)\r\n        .select();\r\n\r\n      if (foldersError) throw foldersError;\r\n\r\n      const result = {\r\n        knowledgeBase,\r\n        folders: folders || []\r\n      };\r\n\r\n      console.log('üíæ Registros de base de conocimiento creados:', result);\r\n      return result;\r\n\r\n    } catch (error) {\r\n      console.error('Error creando registros en base de datos:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Inicializar categor√≠as por defecto para la empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @returns {Promise<Array>} Categor√≠as creadas\r\n   */\r\n  async initializeDefaultCategories(companyId) {\r\n    try {\r\n      const defaultCategories = [\r\n        {\r\n          name: 'Informaci√≥n Corporativa',\r\n          description: 'Informaci√≥n general sobre la empresa, misi√≥n, visi√≥n y valores',\r\n          color: '#3B82F6',\r\n          icon: 'building'\r\n        },\r\n        {\r\n          name: 'Pol√≠ticas Internas',\r\n          description: 'Pol√≠ticas de RRHH, seguridad, y procedimientos internos',\r\n          color: '#EF4444',\r\n          icon: 'shield'\r\n        },\r\n        {\r\n          name: 'Productos y Servicios',\r\n          description: 'Informaci√≥n detallada sobre productos y servicios ofrecidos',\r\n          color: '#10B981',\r\n          icon: 'package'\r\n        },\r\n        {\r\n          name: 'Soporte T√©cnico',\r\n          description: 'Gu√≠as de resoluci√≥n de problemas y soporte t√©cnico',\r\n          color: '#F59E0B',\r\n          icon: 'wrench'\r\n        },\r\n        {\r\n          name: 'Capacitaci√≥n',\r\n          description: 'Material de capacitaci√≥n y desarrollo profesional',\r\n          color: '#8B5CF6',\r\n          icon: 'academic-cap'\r\n        },\r\n        {\r\n          name: 'Clientes',\r\n          description: 'Informaci√≥n sobre clientes y casos de √©xito',\r\n          color: '#EC4899',\r\n          icon: 'users'\r\n        }\r\n      ];\r\n\r\n      const categoriesToInsert = defaultCategories.map(category => ({\r\n        company_id: companyId,\r\n        ...category,\r\n        created_at: new Date().toISOString()\r\n      }));\r\n\r\n      const { data, error } = await supabase\r\n        .from('knowledge_categories')\r\n        .insert(categoriesToInsert)\r\n        .select();\r\n\r\n      if (error) throw error;\r\n\r\n      console.log('üìÇ Categor√≠as por defecto creadas:', data?.length || 0);\r\n      return data || [];\r\n\r\n    } catch (error) {\r\n      console.error('Error creando categor√≠as por defecto:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Crear FAQs iniciales basadas en el tipo de empresa\r\n   * @param {Object} companyData - Datos de la empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @returns {Promise<Array>} FAQs creadas\r\n   */\r\n  async createInitialFAQs(companyData, companyId) {\r\n    try {\r\n      // Obtener categor√≠as para asignar las FAQs\r\n      const { data: categories, error: catError } = await supabase\r\n        .from('knowledge_categories')\r\n        .select('id, name')\r\n        .eq('company_id', companyId);\r\n\r\n      if (catError) throw catError;\r\n\r\n      const categoryMap = {};\r\n      categories?.forEach(cat => {\r\n        categoryMap[cat.name] = cat.id;\r\n      });\r\n\r\n      // FAQs generales aplicables a toda empresa\r\n      const initialFAQs = [\r\n        {\r\n          question: '¬øCu√°l es la misi√≥n de la empresa?',\r\n          answer: `La misi√≥n de ${companyData.name} es proporcionar excelentes servicios y productos que satisfagan las necesidades de nuestros clientes, manteniendo los m√°s altos est√°ndares de calidad y compromiso.`,\r\n          keywords: 'misi√≥n, empresa, prop√≥sito, objetivos',\r\n          category_id: categoryMap['Informaci√≥n Corporativa'] || null,\r\n          priority: 1\r\n        },\r\n        {\r\n          question: '¬øCu√°les son los valores de la empresa?',\r\n          answer: 'Nuestros valores se basan en la integridad, excelencia, innovaci√≥n, trabajo en equipo y compromiso con el cliente.',\r\n          keywords: 'valores, principios, cultura, √©tica',\r\n          category_id: categoryMap['Informaci√≥n Corporativa'] || null,\r\n          priority: 1\r\n        },\r\n        {\r\n          question: '¬øC√≥mo puedo solicitar soporte t√©cnico?',\r\n          answer: 'Para solicitar soporte t√©cnico, puedes contactar al equipo de soporte a trav√©s del canal oficial de WhatsApp, enviar un email a soporte@empresa.com o utilizar el portal de autoservicio.',\r\n          keywords: 'soporte, t√©cnico, ayuda, asistencia',\r\n          category_id: categoryMap['Soporte T√©cnico'] || null,\r\n          priority: 1\r\n        },\r\n        {\r\n          question: '¬øCu√°les son los horarios de atenci√≥n?',\r\n          answer: 'Nuestro horario de atenci√≥n es de lunes a viernes de 9:00 AM a 6:00 PM. Para emergencias, tenemos un canal disponible 24/7.',\r\n          keywords: 'horario, atenci√≥n, schedule, disponibilidad',\r\n          category_id: categoryMap['Informaci√≥n Corporativa'] || null,\r\n          priority: 2\r\n        },\r\n        {\r\n          question: '¬øD√≥nde puedo encontrar las pol√≠ticas internas?',\r\n          answer: 'Las pol√≠ticas internas est√°n disponibles en la carpeta \"02_Politicas_Procedimientos\" de Google Drive o trav√©s del portal de conocimiento interno.',\r\n          keywords: 'pol√≠ticas, internas, documentos, procedimientos',\r\n          category_id: categoryMap['Pol√≠ticas Internas'] || null,\r\n          priority: 2\r\n        }\r\n      ];\r\n\r\n      const faqsToInsert = initialFAQs.map(faq => ({\r\n        company_id: companyId,\r\n        ...faq,\r\n        status: 'active',\r\n        created_at: new Date().toISOString()\r\n      }));\r\n\r\n      const { data, error } = await supabase\r\n        .from('faq_entries')\r\n        .insert(faqsToInsert)\r\n        .select();\r\n\r\n      if (error) throw error;\r\n\r\n      console.log('‚ùì FAQs iniciales creadas:', data?.length || 0);\r\n      return data || [];\r\n\r\n    } catch (error) {\r\n      console.error('Error creando FAQs iniciales:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Configurar permisos y acceso a la base de conocimiento\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {string} userId - ID del usuario creador\r\n   * @returns {Promise<Object>} Permisos configurados\r\n   */\r\n  async setupKnowledgePermissions(companyId, userId) {\r\n    try {\r\n      // 1. Dar acceso completo al creador\r\n      const { error: permError } = await supabase\r\n        .from('knowledge_permissions')\r\n        .insert({\r\n          company_id: companyId,\r\n          user_id: userId,\r\n          role: 'admin',\r\n          permissions: ['read', 'write', 'delete', 'manage'],\r\n          created_at: new Date().toISOString()\r\n        });\r\n\r\n      if (permError) throw permError;\r\n\r\n      console.log('üîê Permisos configurados para el usuario:', userId);\r\n      return { success: true, userId, role: 'admin' };\r\n\r\n    } catch (error) {\r\n      console.error('Error configurando permisos:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sincronizar documentos desde Google Drive y vectorizarlos\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {string} userId - ID del usuario para autenticaci√≥n\r\n   * @returns {Promise<Object>} Resultado de la sincronizaci√≥n\r\n   */\r\n  async syncAndVectorizeDocuments(companyId, userId) {\r\n    try {\r\n      console.log(`üîÑ Iniciando sincronizaci√≥n y vectorizaci√≥n para empresa ${companyId}`);\r\n\r\n      // 1. Obtener perfil de Google y autenticar\r\n      const userProfile = await this.getUserGoogleProfile(userId);\r\n      if (!userProfile?.google_refresh_token) {\r\n        throw new Error('Usuario no tiene Google Drive configurado');\r\n      }\r\n\r\n      await googleDriveService.setTokens({\r\n        refresh_token: userProfile.google_refresh_token\r\n      });\r\n\r\n      // 2. Obtener estructura de carpetas de la empresa\r\n      const { data: knowledgeBase, error: kbError } = await supabase\r\n        .from('company_knowledge_bases')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .single();\r\n\r\n      if (kbError || !knowledgeBase) {\r\n        throw new Error('Base de conocimiento no encontrada');\r\n      }\r\n\r\n      // 3. Listar archivos en las carpetas\r\n      const { data: folders, error: foldersError } = await supabase\r\n        .from('knowledge_folders')\r\n        .select('*')\r\n        .eq('company_id', companyId);\r\n\r\n      if (foldersError) throw foldersError;\r\n\r\n      let totalProcessed = 0;\r\n      let totalVectorized = 0;\r\n\r\n      // 4. Procesar cada carpeta\r\n      for (const folder of folders || []) {\r\n        try {\r\n          const files = await googleDriveService.listFiles(folder.drive_folder_id);\r\n          \r\n          for (const file of files) {\r\n            // Ignorar carpetas\r\n            if (file.mimeType === 'application/vnd.google-apps.folder') {\r\n              continue;\r\n            }\r\n\r\n            totalProcessed++;\r\n\r\n            // Verificar si ya est√° procesado\r\n            const { data: existingDoc } = await supabase\r\n              .from('knowledge_documents')\r\n              .select('id')\r\n              .eq('company_id', companyId)\r\n              .eq('google_file_id', file.id)\r\n              .single();\r\n\r\n            if (existingDoc) {\r\n              console.log(`‚è≠Ô∏è  Archivo ya procesado: ${file.name}`);\r\n              continue;\r\n            }\r\n\r\n            // Descargar y procesar el archivo\r\n            const processed = await this.processAndVectorizeFile(\r\n              file, \r\n              folder, \r\n              companyId, \r\n              userId\r\n            );\r\n\r\n            if (processed.success) {\r\n              totalVectorized++;\r\n              console.log(`‚úÖ Archivo procesado: ${file.name}`);\r\n            } else {\r\n              console.error(`‚ùå Error procesando ${file.name}:`, processed.error);\r\n            }\r\n          }\r\n        } catch (folderError) {\r\n          console.error(`Error procesando carpeta ${folder.drive_folder_name}:`, folderError);\r\n        }\r\n      }\r\n\r\n      const result = {\r\n        success: true,\r\n        companyId,\r\n        totalProcessed,\r\n        totalVectorized,\r\n        message: `Sincronizaci√≥n completada: ${totalVectorized}/${totalProcessed} archivos vectorizados`\r\n      };\r\n\r\n      console.log('üéâ Sincronizaci√≥n completada:', result);\r\n      return result;\r\n\r\n    } catch (error) {\r\n      console.error('Error en sincronizaci√≥n y vectorizaci√≥n:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Procesar y vectorizar un archivo individual\r\n   * @param {Object} file - Informaci√≥n del archivo de Google Drive\r\n   * @param {Object} folder - Informaci√≥n de la carpeta\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {string} userId - ID del usuario\r\n   * @returns {Promise<Object>} Resultado del procesamiento\r\n   */\r\n  async processAndVectorizeFile(file, folder, companyId, userId) {\r\n    try {\r\n      // 1. Descargar contenido del archivo\r\n      const fileContent = await this.downloadFileContent(file);\r\n      \r\n      // 2. Extraer texto del contenido\r\n      const extractedText = await fileContentExtractor.extractText(fileContent, file.mimeType);\r\n      \r\n      if (!extractedText || extractedText.trim().length === 0) {\r\n        return { success: false, error: 'No se pudo extraer texto del archivo' };\r\n      }\r\n\r\n      // 3. Generar embeddings\r\n      const embedding = await embeddingService.generateEmbedding(extractedText);\r\n\r\n      // 4. Guardar en base de datos\r\n      const { data: docData, error: docError } = await supabase\r\n        .from('knowledge_documents')\r\n        .insert({\r\n          company_id: companyId,\r\n          folder_id: folder.id,\r\n          google_file_id: file.id,\r\n          title: file.name,\r\n          content: extractedText,\r\n          embedding: embedding,\r\n          file_size: file.size || 0,\r\n          file_type: file.mimeType,\r\n          folder_type: folder.folder_type,\r\n          status: 'active',\r\n          created_at: new Date().toISOString()\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (docError) throw docError;\r\n\r\n      // 5. Crear chunks para mejor b√∫squeda\r\n      await this.createDocumentChunks(docData, extractedText, companyId);\r\n\r\n      return { \r\n        success: true, \r\n        documentId: docData.id,\r\n        title: file.name,\r\n        chunksCreated: Math.ceil(extractedText.length / 8000)\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error(`Error procesando archivo ${file.name}:`, error);\r\n      return { success: false, error: error.message };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Descargar contenido de un archivo desde Google Drive\r\n   * @param {Object} file - Informaci√≥n del archivo\r\n   * @returns {Promise<ArrayBuffer>} Contenido del archivo\r\n   */\r\n  async downloadFileContent(file) {\r\n    try {\r\n      const response = await fetch(\r\n        `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`,\r\n        {\r\n          headers: {\r\n            'Authorization': `Bearer ${googleDriveService.accessToken}`\r\n          }\r\n        }\r\n      );\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Error descargando archivo: ${response.status}`);\r\n      }\r\n\r\n      return await response.arrayBuffer();\r\n    } catch (error) {\r\n      console.error('Error descargando contenido del archivo:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Crear chunks de documento para mejor b√∫squeda sem√°ntica\r\n   * @param {Object} document - Documento guardado\r\n   * @param {string} content - Contenido completo\r\n   * @param {string} companyId - ID de la empresa\r\n   * @returns {Promise<number>} N√∫mero de chunks creados\r\n   */\r\n  async createDocumentChunks(document, content, companyId) {\r\n    try {\r\n      const CHUNK_SIZE = 8000; // Caracteres por chunk\r\n      const OVERLAP = 200; // Solapamiento entre chunks\r\n      \r\n      const chunks = [];\r\n      for (let i = 0; i < content.length; i += CHUNK_SIZE - OVERLAP) {\r\n        const chunkContent = content.substring(i, i + CHUNK_SIZE);\r\n        if (chunkContent.trim().length > 100) { // M√≠nimo 100 caracteres\r\n          chunks.push({\r\n            document_id: document.id,\r\n            company_id: companyId,\r\n            chunk_index: Math.floor(i / (CHUNK_SIZE - OVERLAP)),\r\n            content: chunkContent,\r\n            created_at: new Date().toISOString()\r\n          });\r\n        }\r\n      }\r\n\r\n      if (chunks.length === 0) return 0;\r\n\r\n      // Generar embeddings para cada chunk\r\n      for (const chunk of chunks) {\r\n        const embedding = await embeddingService.generateEmbedding(chunk.content);\r\n        chunk.embedding = embedding;\r\n      }\r\n\r\n      // Guardar chunks en base de datos\r\n      const { error } = await supabase\r\n        .from('knowledge_chunks')\r\n        .insert(chunks);\r\n\r\n      if (error) throw error;\r\n\r\n      console.log(`üìÑ Created ${chunks.length} chunks for document ${document.title}`);\r\n      return chunks.length;\r\n\r\n    } catch (error) {\r\n      console.error('Error creating document chunks:', error);\r\n      return 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Buscar en la base de conocimiento de una empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {string} query - Consulta de b√∫squeda\r\n   * @param {Object} options - Opciones de b√∫squeda\r\n   * @returns {Promise<Array>} Resultados de la b√∫squeda\r\n   */\r\n  async searchKnowledge(companyId, query, options = {}) {\r\n    try {\r\n      const {\r\n        limit = 10,\r\n        threshold = 0.7,\r\n        includeFAQs = true,\r\n        includeDocuments = true\r\n      } = options;\r\n\r\n      // Generar embedding de la consulta\r\n      const queryEmbedding = await embeddingService.generateEmbedding(query);\r\n\r\n      let results = [];\r\n\r\n      // Buscar en documentos\r\n      if (includeDocuments) {\r\n        const { data: docResults, error: docError } = await supabase\r\n          .rpc('search_knowledge_documents', {\r\n            p_company_id: companyId,\r\n            p_query_embedding: queryEmbedding,\r\n            p_similarity_threshold: threshold,\r\n            p_limit: limit\r\n          });\r\n\r\n        if (!docError && docResults) {\r\n          results = results.concat(docResults.map(doc => ({\r\n            ...doc,\r\n            type: 'document',\r\n            relevance: doc.similarity\r\n          })));\r\n        }\r\n      }\r\n\r\n      // Buscar en FAQs\r\n      if (includeFAQs) {\r\n        const { data: faqResults, error: faqError } = await supabase\r\n          .from('faq_entries')\r\n          .select('*')\r\n          .eq('company_id', companyId)\r\n          .eq('status', 'active')\r\n          .or(`question.ilike.%${query}%,answer.ilike.%${query}%,keywords.ilike.%${query}%`)\r\n          .limit(limit);\r\n\r\n        if (!faqError && faqResults) {\r\n          results = results.concat(faqResults.map(faq => ({\r\n            ...faq,\r\n            type: 'faq',\r\n            relevance: this.calculateTextRelevance(query, faq.question + ' ' + faq.answer)\r\n          })));\r\n        }\r\n      }\r\n\r\n      // Ordenar por relevancia y limitar resultados\r\n      results.sort((a, b) => b.relevance - a.relevance);\r\n      return results.slice(0, limit);\r\n\r\n    } catch (error) {\r\n      console.error('Error buscando en base de conocimiento:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Calcular relevancia de texto simple (similitud de palabras)\r\n   * @param {string} query - Consulta\r\n   * @param {string} text - Texto a comparar\r\n   * @returns {number} Puntuaci√≥n de relevancia (0-1)\r\n   */\r\n  calculateTextRelevance(query, text) {\r\n    const queryWords = query.toLowerCase().split(/s+/);\r\n    const textWords = text.toLowerCase().split(/s+/);\r\n    \r\n    const matches = queryWords.filter(word => \r\n      textWords.some(textWord => textWord.includes(word) || word.includes(textWord))\r\n    );\r\n    \r\n    return matches.length / queryWords.length;\r\n  }\r\n\r\n  /**\r\n   * Obtener estad√≠sticas de la base de conocimiento\r\n   * @param {string} companyId - ID de la empresa\r\n   * @returns {Promise<Object>} Estad√≠sticas\r\n   */\r\n  async getKnowledgeStats(companyId) {\r\n    try {\r\n      const [\r\n        docsCount,\r\n        faqsCount,\r\n        categoriesCount,\r\n        chunksCount\r\n      ] = await Promise.all([\r\n        supabase.from('knowledge_documents').select('id', { count: 'exact' }).eq('company_id', companyId),\r\n        supabase.from('faq_entries').select('id', { count: 'exact' }).eq('company_id', companyId),\r\n        supabase.from('knowledge_categories').select('id', { count: 'exact' }).eq('company_id', companyId),\r\n        supabase.from('knowledge_chunks').select('id', { count: 'exact' }).eq('company_id', companyId)\r\n      ]);\r\n\r\n      return {\r\n        documents: docsCount.count || 0,\r\n        faqs: faqsCount.count || 0,\r\n        categories: categoriesCount.count || 0,\r\n        chunks: chunksCount.count || 0,\r\n        lastUpdated: new Date().toISOString()\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error obteniendo estad√≠sticas:', error);\r\n      return {\r\n        documents: 0,\r\n        faqs: 0,\r\n        categories: 0,\r\n        chunks: 0,\r\n        lastUpdated: null\r\n      };\r\n    }\r\n  }\r\n}\r\n\r\n// Crear y exportar instancia √∫nica\r\nconst companyKnowledgeService = new CompanyKnowledgeService();\r\nexport default companyKnowledgeService;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\companyReportsService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'ranking' is assigned a value but never used.","line":583,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":583,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'delivery' is assigned a value but never used.","line":976,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":976,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from '../lib/supabase.js'\r\nimport realTimeStatsService from './realTimeStatsService.js'\r\nimport analyticsInsightsService from './analyticsInsightsService.js'\r\n\r\nclass CompanyReportsService {\r\n  constructor() {\r\n    this.cache = new Map()\r\n    this.cacheTimeout = 10 * 60 * 1000 // 10 minutos\r\n  }\r\n\r\n  /**\r\n   * Genera reporte completo para una empresa espec√≠fica\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {Object} options - Opciones del reporte\r\n   * @returns {Promise<Object>} Reporte completo\r\n   */\r\n  async generateCompanyReport(companyId, options = {}) {\r\n    const {\r\n      dateRange = '30d',\r\n      includeComparison = true,\r\n      includeInsights = true,\r\n      includeEmployeeDetails = true,\r\n      channels = null\r\n    } = options\r\n\r\n    const cacheKey = `company_report_${companyId}_${dateRange}_${JSON.stringify(options)}`\r\n    \r\n    // Verificar cach√©\r\n    if (this.cache.has(cacheKey)) {\r\n      const cached = this.cache.get(cacheKey)\r\n      if (Date.now() - cached.timestamp < this.cacheTimeout) {\r\n        return cached.data\r\n      }\r\n    }\r\n\r\n    try {\r\n      // Obtener informaci√≥n b√°sica de la empresa\r\n      const companyInfo = await this.getCompanyInfo(companyId)\r\n      \r\n      // Obtener m√©tricas de comunicaci√≥n\r\n      const communicationMetrics = await realTimeStatsService.getCompanyMetrics(companyId, {\r\n        dateRange,\r\n        channels\r\n      })\r\n\r\n      // Obtener m√©tricas de empleados\r\n      const employeeMetrics = includeEmployeeDetails \r\n        ? await this.getDetailedEmployeeMetrics(companyId, dateRange)\r\n        : null\r\n\r\n      // Obtener comparativas\r\n      const comparison = includeComparison \r\n        ? await this.getCompanyComparisons(companyId, dateRange)\r\n        : null\r\n\r\n      // Generar insights\r\n      const insights = includeInsights \r\n        ? await this.generateCompanySpecificInsights(companyId, communicationMetrics)\r\n        : null\r\n\r\n      // Obtener tendencias hist√≥ricas\r\n      const trends = await this.getHistoricalTrends(companyId, dateRange)\r\n\r\n      // Calcular KPIs\r\n      const kpis = this.calculateCompanyKPIs(communicationMetrics, employeeMetrics)\r\n\r\n      const report = {\r\n        company: companyInfo,\r\n        report_period: {\r\n          range: dateRange,\r\n          start: this.getDateRange(dateRange).start,\r\n          end: this.getDateRange(dateRange).end,\r\n          generated_at: new Date().toISOString()\r\n        },\r\n        communication: communicationMetrics,\r\n        employees: employeeMetrics,\r\n        comparison,\r\n        insights,\r\n        trends,\r\n        kpis,\r\n        recommendations: this.generateRecommendations(kpis, insights)\r\n      }\r\n\r\n      // Guardar en cach√©\r\n      this.cache.set(cacheKey, {\r\n        data: report,\r\n        timestamp: Date.now()\r\n      })\r\n\r\n      return report\r\n    } catch (error) {\r\n      console.error('Error generando reporte de empresa:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Genera reporte comparativo entre m√∫ltiples empresas\r\n   * @param {Array} companyIds - IDs de empresas a comparar\r\n   * @param {Object} options - Opciones del reporte\r\n   * @returns {Promise<Object>} Reporte comparativo\r\n   */\r\n  async generateComparativeReport(companyIds, options = {}) {\r\n    const {\r\n      dateRange = '30d',\r\n      metrics = ['delivery', 'engagement', 'volume'],\r\n      includeCharts = true\r\n    } = options\r\n\r\n    try {\r\n      // Obtener datos de todas las empresas\r\n      const companyData = await Promise.all(\r\n        companyIds.map(async (companyId) => {\r\n          const metrics = await realTimeStatsService.getCompanyMetrics(companyId, { dateRange })\r\n          const info = await this.getCompanyInfo(companyId)\r\n          return {\r\n            id: companyId,\r\n            name: info.name,\r\n            metrics: metrics.communication,\r\n            kpis: this.calculateCompanyKPIs(metrics.communication)\r\n          }\r\n        })\r\n      )\r\n\r\n      // Calcular comparativas\r\n      const comparisons = this.calculateComparativeMetrics(companyData, metrics)\r\n\r\n      // Generar rankings\r\n      const rankings = this.generateCompanyRankings(companyData, metrics)\r\n\r\n      // Identificar l√≠deres y rezagados\r\n      const leaders = this.identifyLeaders(companyData, metrics)\r\n      const laggards = this.identifyLaggards(companyData, metrics)\r\n\r\n      return {\r\n        comparison_period: {\r\n          range: dateRange,\r\n          companies_count: companyIds.length,\r\n          generated_at: new Date().toISOString()\r\n        },\r\n        companies: companyData,\r\n        comparisons,\r\n        rankings,\r\n        leaders,\r\n        laggards,\r\n        insights: this.generateComparativeInsights(comparisons, rankings),\r\n        charts: includeCharts ? this.generateComparisonCharts(companyData, metrics) : null\r\n      }\r\n    } catch (error) {\r\n      console.error('Error generando reporte comparativo:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene informaci√≥n b√°sica de la empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @returns {Promise<Object>} Informaci√≥n de la empresa\r\n   */\r\n  async getCompanyInfo(companyId) {\r\n    try {\r\n      const { data: company, error } = await supabase\r\n        .from('companies')\r\n        .select(`\r\n          id,\r\n          name,\r\n          rut,\r\n          industry,\r\n          size,\r\n          status,\r\n          created_at,\r\n          updated_at,\r\n          address,\r\n          phone,\r\n          email,\r\n          website\r\n        `)\r\n        .eq('id', companyId)\r\n        .single()\r\n\r\n      if (error) throw error\r\n\r\n      // Obtener estad√≠sticas adicionales\r\n      const { count: employeeCount } = await supabase\r\n        .from('employees')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('company_id', companyId)\r\n\r\n      return {\r\n        ...company,\r\n        employee_count: employeeCount || 0,\r\n        tenure_days: Math.floor((Date.now() - new Date(company.created_at)) / (1000 * 60 * 60 * 24))\r\n      }\r\n    } catch (error) {\r\n      console.error('Error obteniendo informaci√≥n de empresa:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene m√©tricas detalladas de empleados\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {string} dateRange - Rango de fechas\r\n   * @returns {Promise<Object>} M√©tricas detalladas\r\n   */\r\n  async getDetailedEmployeeMetrics(companyId, dateRange) {\r\n    try {\r\n      const dateFilter = this.getDateRange(dateRange)\r\n\r\n      // Obtener todos los empleados de la empresa\r\n      const { data: employees, error: empError } = await supabase\r\n        .from('employees')\r\n        .select('id, name, email, position, department, is_active, created_at')\r\n        .eq('company_id', companyId)\r\n\r\n      if (empError) throw empError\r\n\r\n      // Obtener m√©tricas de comunicaci√≥n por empleado\r\n      const employeeMetrics = await Promise.all(\r\n        employees.map(async (employee) => {\r\n          const { data: messages, error: msgError } = await supabase\r\n            .from('messages')\r\n            .select('*')\r\n            .eq('employee_id', employee.id)\r\n            .gte('created_at', dateFilter.start)\r\n            .lte('created_at', dateFilter.end)\r\n\r\n          if (msgError) throw msgError\r\n\r\n          return {\r\n            ...employee,\r\n            metrics: this.calculateEmployeeMetrics(messages || [])\r\n          }\r\n        })\r\n      )\r\n\r\n      // Calcular agregados\r\n      const totalMessages = employeeMetrics.reduce((sum, emp) => sum + emp.metrics.total_messages, 0)\r\n      const activeEmployees = employeeMetrics.filter(emp => emp.is_active).length\r\n      const engagedEmployees = employeeMetrics.filter(emp => emp.metrics.engagement_rate > 0).length\r\n\r\n      return {\r\n        employee_count: employees.length,\r\n        active_employees: activeEmployees,\r\n        engaged_employees: engagedEmployees,\r\n        engagement_rate: activeEmployees > 0 ? (engagedEmployees / activeEmployees * 100).toFixed(1) : 0,\r\n        total_messages: totalMessages,\r\n        avg_messages_per_employee: employees.length > 0 ? (totalMessages / employees.length).toFixed(1) : 0,\r\n        top_performers: this.getTopPerformers(employeeMetrics),\r\n        department_breakdown: this.getDepartmentBreakdown(employeeMetrics),\r\n        employee_details: employeeMetrics\r\n      }\r\n    } catch (error) {\r\n      console.error('Error obteniendo m√©tricas detalladas de empleados:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Calcula m√©tricas para un empleado espec√≠fico\r\n   * @param {Array} messages - Mensajes del empleado\r\n   * @returns {Object} M√©tricas calculadas\r\n   */\r\n  calculateEmployeeMetrics(messages) {\r\n    if (!messages || messages.length === 0) {\r\n      return {\r\n        total_messages: 0,\r\n        delivered_count: 0,\r\n        read_count: 0,\r\n        engagement_rate: 0,\r\n        response_time: 0,\r\n        last_activity: null\r\n      }\r\n    }\r\n\r\n    const delivered = messages.filter(m => m.status === 'delivered')\r\n    const read = delivered.filter(m => m.read_at)\r\n    const clicked = read.filter(m => m.clicked_at)\r\n\r\n    // Calcular tiempo de respuesta promedio\r\n    const responseTimes = messages\r\n      .filter(m => m.response_at && m.created_at)\r\n      .map(m => new Date(m.response_at) - new Date(m.created_at))\r\n\r\n    const avgResponseTime = responseTimes.length > 0\r\n      ? responseTimes.reduce((sum, time) => sum + time, 0) / responseTimes.length\r\n      : 0\r\n\r\n    return {\r\n      total_messages: messages.length,\r\n      delivered_count: delivered.length,\r\n      read_count: read.length,\r\n      clicked_count: clicked.length,\r\n      delivery_rate: (delivered.length / messages.length * 100).toFixed(1),\r\n      read_rate: (read.length / delivered.length * 100).toFixed(1),\r\n      click_rate: (clicked.length / read.length * 100).toFixed(1),\r\n      engagement_rate: (clicked.length / delivered.length * 100).toFixed(1),\r\n      response_time: Math.round(avgResponseTime / 1000), // en segundos\r\n      last_activity: messages.length > 0 ? messages[messages.length - 1].created_at : null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene comparativas de la empresa con otras\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {string} dateRange - Rango de fechas\r\n   * @returns {Promise<Object>} Comparativas\r\n   */\r\n  async getCompanyComparisons(companyId, dateRange) {\r\n    try {\r\n      // Obtener todas las empresas activas\r\n      const { data: allCompanies, error } = await supabase\r\n        .from('companies')\r\n        .select('id, name, industry, size')\r\n        .eq('status', 'active')\r\n\r\n      if (error) throw error\r\n\r\n      // Obtener m√©tricas de todas las empresas\r\n      const allMetrics = await Promise.all(\r\n        allCompanies.map(async (company) => {\r\n          const metrics = await realTimeStatsService.getCompanyMetrics(company.id, { dateRange })\r\n          return {\r\n            id: company.id,\r\n            name: company.name,\r\n            industry: company.industry,\r\n            size: company.size,\r\n            metrics: metrics.communication\r\n          }\r\n        })\r\n      )\r\n\r\n      // Encontrar la empresa actual\r\n      const currentCompany = allMetrics.find(c => c.id === companyId)\r\n      if (!currentCompany) throw new Error('Empresa no encontrada')\r\n\r\n      // Filtrar empresas similares (misma industria o tama√±o)\r\n      const similarCompanies = allMetrics.filter(c => \r\n        c.id !== companyId && \r\n        (c.industry === currentCompany.industry || c.size === currentCompany.size)\r\n      )\r\n\r\n      // Calcular percentiles\r\n      const percentiles = this.calculatePercentiles(currentCompany.metrics, allMetrics.map(c => c.metrics))\r\n\r\n      // Calcular promedios del sector\r\n      const industryAverages = this.calculateIndustryAverages(currentCompany.industry, allMetrics)\r\n\r\n      return {\r\n        company_ranking: this.calculateRanking(currentCompany.metrics, allMetrics.map(c => c.metrics)),\r\n        percentiles,\r\n        industry_averages: industryAverages,\r\n        similar_companies: {\r\n          count: similarCompanies.length,\r\n          avg_performance: this.calculateAverage(similarCompanies.map(c => c.metrics))\r\n        },\r\n        benchmarks: this.generateBenchmarks(currentCompany.metrics, industryAverages)\r\n      }\r\n    } catch (error) {\r\n      console.error('Error obteniendo comparativas:', error)\r\n      return null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Genera insights espec√≠ficos para la empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {Object} metrics - M√©tricas de la empresa\r\n   * @returns {Promise<Object>} Insights generados\r\n   */\r\n  async generateCompanySpecificInsights(companyId, metrics) {\r\n    try {\r\n      // Usar el servicio de insights existente\r\n      const insights = await analyticsInsightsService.generateCompanySpecificInsights(companyId, metrics)\r\n\r\n      // Agregar insights espec√≠ficos de reportes\r\n      const reportInsights = this.generateReportSpecificInsights(metrics)\r\n\r\n      return {\r\n        ...insights,\r\n        report_specific: reportInsights\r\n      }\r\n    } catch (error) {\r\n      console.error('Error generando insights espec√≠ficos:', error)\r\n      return null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene tendencias hist√≥ricas de la empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {string} dateRange - Rango de fechas\r\n   * @returns {Promise<Object>} Tendencias hist√≥ricas\r\n   */\r\n  async getHistoricalTrends(companyId, dateRange) {\r\n    try {\r\n      const periods = this.getHistoricalPeriods(dateRange)\r\n      \r\n      const trends = await Promise.all(\r\n        periods.map(async (period) => {\r\n          const metrics = await realTimeStatsService.getCompanyMetrics(companyId, {\r\n            dateRange: period.range\r\n          })\r\n          \r\n          return {\r\n            period: period.label,\r\n            date_range: period.dates,\r\n            metrics: metrics.communication.overview,\r\n            delivery_rate: metrics.communication.delivery.delivery_rate,\r\n            engagement_rate: metrics.communication.engagement.overall_engagement\r\n          }\r\n        })\r\n      )\r\n\r\n      return {\r\n        trends,\r\n        growth_analysis: this.analyzeGrowthTrends(trends),\r\n        seasonality: this.detectSeasonality(trends)\r\n      }\r\n    } catch (error) {\r\n      console.error('Error obteniendo tendencias hist√≥ricas:', error)\r\n      return null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Calcula KPIs de la empresa\r\n   * @param {Object} communicationMetrics - M√©tricas de comunicaci√≥n\r\n   * @param {Object} employeeMetrics - M√©tricas de empleados\r\n   * @returns {Object} KPIs calculados\r\n   */\r\n  calculateCompanyKPIs(communicationMetrics, employeeMetrics = null) {\r\n    const { overview, delivery, engagement, performance } = communicationMetrics.communication\r\n\r\n    const kpis = {\r\n      communication_score: parseFloat(performance.performance_score),\r\n      delivery_excellence: parseFloat(delivery.delivery_rate),\r\n      engagement_quality: parseFloat(engagement.overall_engagement),\r\n      message_volume: overview.total_messages,\r\n      operational_efficiency: parseFloat(performance.efficiency)\r\n    }\r\n\r\n    // Agregar KPIs de empleados si est√°n disponibles\r\n    if (employeeMetrics) {\r\n      kpis.employee_engagement = parseFloat(employeeMetrics.engagement_rate)\r\n      kpis.team_productivity = parseFloat(employeeMetrics.avg_messages_per_employee)\r\n      kpis.active_participation = (employeeMetrics.active_employees / employeeMetrics.employee_count * 100).toFixed(1)\r\n    }\r\n\r\n    // Calcular puntuaci√≥n general\r\n    kpis.overall_score = Object.values(kpis).reduce((sum, value) => sum + parseFloat(value), 0) / Object.keys(kpis).length\r\n\r\n    return kpis\r\n  }\r\n\r\n  /**\r\n   * Calcula m√©tricas comparativas\r\n   * @param {Array} companyData - Datos de empresas\r\n   * @param {Array} metrics - M√©tricas a comparar\r\n   * @returns {Object} M√©tricas comparativas\r\n   */\r\n  calculateComparativeMetrics(companyData, metrics) {\r\n    const comparisons = {}\r\n\r\n    metrics.forEach(metric => {\r\n      const values = companyData.map(c => {\r\n        switch (metric) {\r\n          case 'delivery':\r\n            return parseFloat(c.metrics.delivery.delivery_rate) || 0\r\n          case 'engagement':\r\n            return parseFloat(c.metrics.engagement.overall_engagement) || 0\r\n          case 'volume':\r\n            return c.metrics.overview.total_messages || 0\r\n          default:\r\n            return 0\r\n        }\r\n      })\r\n\r\n      comparisons[metric] = {\r\n        average: values.reduce((sum, val) => sum + val, 0) / values.length,\r\n        max: Math.max(...values),\r\n        min: Math.min(...values),\r\n        median: this.calculateMedian(values),\r\n        standard_deviation: this.calculateStandardDeviation(values)\r\n      }\r\n    })\r\n\r\n    return comparisons\r\n  }\r\n\r\n  /**\r\n   * Genera rankings de empresas\r\n   * @param {Array} companyData - Datos de empresas\r\n   * @param {Array} metrics - M√©tricas para ranking\r\n   * @returns {Object} Rankings generados\r\n   */\r\n  generateCompanyRankings(companyData, metrics) {\r\n    const rankings = {}\r\n\r\n    metrics.forEach(metric => {\r\n      const ranked = companyData\r\n        .map(c => ({\r\n          id: c.id,\r\n          name: c.name,\r\n          value: this.getMetricValue(c, metric)\r\n        }))\r\n        .sort((a, b) => b.value - a.value)\r\n        .map((c, index) => ({\r\n          ...c,\r\n          rank: index + 1,\r\n          percentile: ((companyData.length - index) / companyData.length * 100).toFixed(1)\r\n        }))\r\n\r\n      rankings[metric] = ranked\r\n    })\r\n\r\n    return rankings\r\n  }\r\n\r\n  /**\r\n   * Identifica l√≠deres en cada m√©trica\r\n   * @param {Array} companyData - Datos de empresas\r\n   * @param {Array} metrics - M√©tricas a evaluar\r\n   * @returns {Object} L√≠deres identificados\r\n   */\r\n  identifyLeaders(companyData, metrics) {\r\n    const leaders = {}\r\n\r\n    metrics.forEach(metric => {\r\n      const topPerformers = companyData\r\n        .filter(c => this.getMetricValue(c, metric) > 0)\r\n        .sort((a, b) => this.getMetricValue(b, metric) - this.getMetricValue(a, metric))\r\n        .slice(0, 3)\r\n\r\n      leaders[metric] = topPerformers.map(c => ({\r\n        id: c.id,\r\n        name: c.name,\r\n        value: this.getMetricValue(c, metric),\r\n        rank: 1\r\n      }))\r\n    })\r\n\r\n    return leaders\r\n  }\r\n\r\n  /**\r\n   * Identifica rezagados en cada m√©trica\r\n   * @param {Array} companyData - Datos de empresas\r\n   * @param {Array} metrics - M√©tricas a evaluar\r\n   * @returns {Object} Rezagados identificados\r\n   */\r\n  identifyLaggards(companyData, metrics) {\r\n    const laggards = {}\r\n\r\n    metrics.forEach(metric => {\r\n      const bottomPerformers = companyData\r\n        .filter(c => this.getMetricValue(c, metric) > 0)\r\n        .sort((a, b) => this.getMetricValue(a, metric) - this.getMetricValue(b, metric))\r\n        .slice(0, 3)\r\n\r\n      laggards[metric] = bottomPerformers.map(c => ({\r\n        id: c.id,\r\n        name: c.name,\r\n        value: this.getMetricValue(c, metric),\r\n        rank: companyData.length\r\n      }))\r\n    })\r\n\r\n    return laggards\r\n  }\r\n\r\n  /**\r\n   * Genera insights comparativos\r\n   * @param {Object} comparisons - Comparativas\r\n   * @param {Object} rankings - Rankings\r\n   * @returns {Array} Insights generados\r\n   */\r\n  generateComparativeInsights(comparisons, rankings) {\r\n    const insights = []\r\n\r\n    Object.keys(comparisons).forEach(metric => {\r\n      const comparison = comparisons[metric]\r\n      const ranking = rankings[metric]\r\n\r\n      // Identificar gaps significativos\r\n      if (comparison.max > comparison.average * 2) {\r\n        insights.push({\r\n          type: 'performance_gap',\r\n          metric,\r\n          description: `Existe una brecha significativa en ${metric} entre el l√≠der y el promedio`,\r\n          severity: 'high',\r\n          recommendation: 'Analizar las pr√°cticas del l√≠der para identificar mejores pr√°cticas'\r\n        })\r\n      }\r\n\r\n      // Identificar consistencia\r\n      if (comparison.standard_deviation < comparison.average * 0.1) {\r\n        insights.push({\r\n          type: 'consistency',\r\n          metric,\r\n          description: `Alta consistencia en ${metric} entre todas las empresas`,\r\n          severity: 'low',\r\n          recommendation: 'Mantener pr√°cticas actuales'\r\n        })\r\n      }\r\n    })\r\n\r\n    return insights\r\n  }\r\n\r\n  /**\r\n   * Genera gr√°ficos de comparaci√≥n\r\n   * @param {Array} companyData - Datos de empresas\r\n   * @param {Array} metrics - M√©tricas para gr√°ficos\r\n   * @returns {Object} Datos para gr√°ficos\r\n   */\r\n  generateComparisonCharts(companyData, metrics) {\r\n    return {\r\n      bar_chart: {\r\n        type: 'bar',\r\n        data: companyData.map(c => ({\r\n          name: c.name,\r\n          ...metrics.reduce((acc, metric) => {\r\n            acc[metric] = this.getMetricValue(c, metric)\r\n            return acc\r\n          }, {})\r\n        }))\r\n      },\r\n      radar_chart: {\r\n        type: 'radar',\r\n        data: companyData.slice(0, 5).map(c => ({\r\n          name: c.name,\r\n          metrics: metrics.reduce((acc, metric) => {\r\n            acc[metric] = this.getMetricValue(c, metric)\r\n            return acc\r\n          }, {})\r\n        }))\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene valor de m√©trica espec√≠fica\r\n   * @param {Object} companyData - Datos de la empresa\r\n   * @param {string} metric - Nombre de la m√©trica\r\n   * @returns {number} Valor de la m√©trica\r\n   */\r\n  getMetricValue(companyData, metric) {\r\n    switch (metric) {\r\n      case 'delivery':\r\n        return parseFloat(companyData.metrics.delivery.delivery_rate) || 0\r\n      case 'engagement':\r\n        return parseFloat(companyData.metrics.engagement.overall_engagement) || 0\r\n      case 'volume':\r\n        return companyData.metrics.overview.total_messages || 0\r\n      default:\r\n        return 0\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Calcula percentiles\r\n   * @param {Object} currentMetrics - M√©tricas actuales\r\n   * @param {Array} allMetrics - Todas las m√©tricas\r\n   * @returns {Object} Percentiles calculados\r\n   */\r\n  calculatePercentiles(currentMetrics, allMetrics) {\r\n    const deliveryRates = allMetrics.map(m => parseFloat(m.delivery.delivery_rate) || 0)\r\n    const engagementRates = allMetrics.map(m => parseFloat(m.engagement.overall_engagement) || 0)\r\n    const volumes = allMetrics.map(m => m.overview.total_messages || 0)\r\n\r\n    return {\r\n      delivery_rate: this.calculatePercentile(parseFloat(currentMetrics.delivery.delivery_rate), deliveryRates),\r\n      engagement_rate: this.calculatePercentile(parseFloat(currentMetrics.engagement.overall_engagement), engagementRates),\r\n      volume: this.calculatePercentile(currentMetrics.overview.total_messages, volumes)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Calcula percentil espec√≠fico\r\n   * @param {number} value - Valor a evaluar\r\n   * @param {Array} values - Todos los valores\r\n   * @returns {number} Percentil calculado\r\n   */\r\n  calculatePercentile(value, values) {\r\n    const sorted = values.sort((a, b) => a - b)\r\n    const index = sorted.indexOf(value)\r\n    return ((index + 1) / sorted.length * 100).toFixed(1)\r\n  }\r\n\r\n  /**\r\n   * Calcula promedios por industria\r\n   * @param {string} industry - Industria\r\n   * @param {Array} allMetrics - Todas las m√©tricas\r\n   * @returns {Object} Promedios de la industria\r\n   */\r\n  calculateIndustryAverages(industry, allMetrics) {\r\n    const industryCompanies = allMetrics.filter(c => c.industry === industry)\r\n    \r\n    if (industryCompanies.length === 0) return null\r\n\r\n    const deliveryRates = industryCompanies.map(c => parseFloat(c.metrics.delivery.delivery_rate) || 0)\r\n    const engagementRates = industryCompanies.map(c => parseFloat(c.metrics.engagement.overall_engagement) || 0)\r\n    const volumes = industryCompanies.map(c => c.metrics.overview.total_messages || 0)\r\n\r\n    return {\r\n      delivery_rate: deliveryRates.reduce((sum, val) => sum + val, 0) / deliveryRates.length,\r\n      engagement_rate: engagementRates.reduce((sum, val) => sum + val, 0) / engagementRates.length,\r\n      volume: volumes.reduce((sum, val) => sum + val, 0) / volumes.length,\r\n      sample_size: industryCompanies.length\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Genera benchmarks\r\n   * @param {Object} currentMetrics - M√©tricas actuales\r\n   * @param {Object} industryAverages - Promedios de la industria\r\n   * @returns {Object} Benchmarks generados\r\n   */\r\n  generateBenchmarks(currentMetrics, industryAverages) {\r\n    if (!industryAverages) return null\r\n\r\n    return {\r\n      delivery_vs_industry: {\r\n        current: parseFloat(currentMetrics.delivery.delivery_rate),\r\n        industry: industryAverages.delivery_rate,\r\n        performance: parseFloat(currentMetrics.delivery.delivery_rate) > industryAverages.delivery_rate ? 'above' : 'below'\r\n      },\r\n      engagement_vs_industry: {\r\n        current: parseFloat(currentMetrics.engagement.overall_engagement),\r\n        industry: industryAverages.engagement_rate,\r\n        performance: parseFloat(currentMetrics.engagement.overall_engagement) > industryAverages.engagement_rate ? 'above' : 'below'\r\n      },\r\n      volume_vs_industry: {\r\n        current: currentMetrics.overview.total_messages,\r\n        industry: industryAverages.volume,\r\n        performance: currentMetrics.overview.total_messages > industryAverages.volume ? 'above' : 'below'\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Genera recomendaciones basadas en KPIs e insights\r\n   * @param {Object} kpis - KPIs calculados\r\n   * @param {Object} insights - Insights generados\r\n   * @returns {Array} Recomendaciones generadas\r\n   */\r\n  generateRecommendations(kpis, insights) {\r\n    const recommendations = []\r\n\r\n    // Recomendaciones basadas en KPIs\r\n    if (kpis.communication_score < 70) {\r\n      recommendations.push({\r\n        priority: 'high',\r\n        category: 'communication',\r\n        title: 'Mejorar puntuaci√≥n de comunicaci√≥n',\r\n        description: 'La puntuaci√≥n general de comunicaci√≥n est√° por debajo del √≥ptimo',\r\n        actions: [\r\n          'Revisar estrategias de entrega',\r\n          'Optimizar contenido de mensajes',\r\n          'Mejorar tiempos de env√≠o'\r\n        ]\r\n      })\r\n    }\r\n\r\n    if (kpis.delivery_excellence < 85) {\r\n      recommendations.push({\r\n        priority: 'medium',\r\n        category: 'delivery',\r\n        title: 'Optimizar tasa de entrega',\r\n        description: 'La tasa de entrega puede mejorar significativamente',\r\n        actions: [\r\n          'Verificar configuraci√≥n de canales',\r\n          'Limpiar listas de contactos',\r\n          'Mejorar calidad de datos'\r\n        ]\r\n      })\r\n    }\r\n\r\n    if (kpis.engagement_quality < 50) {\r\n      recommendations.push({\r\n        priority: 'high',\r\n        category: 'engagement',\r\n        title: 'Aumentar engagement',\r\n        description: 'El engagement actual es bajo y necesita atenci√≥n urgente',\r\n        actions: [\r\n          'Personalizar contenido',\r\n          'Segmentar audiencia',\r\n          'Probar diferentes formatos'\r\n        ]\r\n      })\r\n    }\r\n\r\n    // Agregar recomendaciones de insights si est√°n disponibles\r\n    if (insights && insights.recommendations) {\r\n      recommendations.push(...insights.recommendations)\r\n    }\r\n\r\n    return recommendations.sort((a, b) => {\r\n      const priorityOrder = { high: 3, medium: 2, low: 1 }\r\n      return priorityOrder[b.priority] - priorityOrder[a.priority]\r\n    })\r\n  }\r\n\r\n  /**\r\n   * Obtiene per√≠odos hist√≥ricos para an√°lisis\r\n   * @param {string} dateRange - Rango de fechas actual\r\n   * @returns {Array} Per√≠odos hist√≥ricos\r\n   */\r\n  getHistoricalPeriods(dateRange) {\r\n    const now = new Date()\r\n    const periods = []\r\n\r\n    switch (dateRange) {\r\n      case '7d':\r\n        // √öltimas 8 semanas\r\n        for (let i = 7; i >= 0; i--) {\r\n          const start = new Date(now.getTime() - (i + 1) * 7 * 24 * 60 * 60 * 1000)\r\n          const end = new Date(now.getTime() - i * 7 * 24 * 60 * 60 * 1000)\r\n          periods.push({\r\n            label: `Semana ${8 - i}`,\r\n            range: '7d',\r\n            dates: {\r\n              start: start.toISOString(),\r\n              end: end.toISOString()\r\n            }\r\n          })\r\n        }\r\n        break\r\n      case '30d':\r\n        // √öltimos 6 meses\r\n        for (let i = 5; i >= 0; i--) {\r\n          const start = new Date(now.getFullYear(), now.getMonth() - i - 1, 1)\r\n          const end = new Date(now.getFullYear(), now.getMonth() - i, 0)\r\n          periods.push({\r\n            label: start.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' }),\r\n            range: '30d',\r\n            dates: {\r\n              start: start.toISOString(),\r\n              end: end.toISOString()\r\n            }\r\n          })\r\n        }\r\n        break\r\n      default:\r\n        // Default a per√≠odos semanales\r\n        for (let i = 3; i >= 0; i--) {\r\n          const start = new Date(now.getTime() - (i + 1) * 7 * 24 * 60 * 60 * 1000)\r\n          const end = new Date(now.getTime() - i * 7 * 24 * 60 * 60 * 1000)\r\n          periods.push({\r\n            label: `Semana ${4 - i}`,\r\n            range: '7d',\r\n            dates: {\r\n              start: start.toISOString(),\r\n              end: end.toISOString()\r\n            }\r\n          })\r\n        }\r\n    }\r\n\r\n    return periods\r\n  }\r\n\r\n  /**\r\n   * Analiza tendencias de crecimiento\r\n   * @param {Array} trends - Datos de tendencias\r\n   * @returns {Object} An√°lisis de crecimiento\r\n   */\r\n  analyzeGrowthTrends(trends) {\r\n    if (trends.length < 2) return null\r\n\r\n    const firstPeriod = trends[0]\r\n    const lastPeriod = trends[trends.length - 1]\r\n\r\n    const volumeGrowth = ((lastPeriod.metrics.total_messages - firstPeriod.metrics.total_messages) / firstPeriod.metrics.total_messages * 100).toFixed(1)\r\n    const deliveryGrowth = (parseFloat(lastPeriod.delivery_rate) - parseFloat(firstPeriod.delivery_rate)).toFixed(1)\r\n    const engagementGrowth = (parseFloat(lastPeriod.engagement_rate) - parseFloat(firstPeriod.engagement_rate)).toFixed(1)\r\n\r\n    return {\r\n      volume_growth: volumeGrowth,\r\n      delivery_growth: deliveryGrowth,\r\n      engagement_growth: engagementGrowth,\r\n      trend_direction: this.determineTrendDirection([volumeGrowth, deliveryGrowth, engagementGrowth])\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Detecta patrones estacionales\r\n   * @param {Array} trends - Datos de tendencias\r\n   * @returns {Object} Patrones estacionales\r\n   */\r\n  detectSeasonality(trends) {\r\n    // Implementaci√≥n b√°sica de detecci√≥n de estacionalidad\r\n    // En un sistema real, esto ser√≠a m√°s sofisticado\r\n    const monthlyAverages = {}\r\n    \r\n    trends.forEach(trend => {\r\n      const month = new Date(trend.date_range.start).getMonth()\r\n      if (!monthlyAverages[month]) {\r\n        monthlyAverages[month] = []\r\n      }\r\n      monthlyAverages[month].push(trend.metrics.total_messages)\r\n    })\r\n\r\n    const seasonality = {}\r\n    Object.keys(monthlyAverages).forEach(month => {\r\n      const values = monthlyAverages[month]\r\n      seasonality[month] = {\r\n        average: values.reduce((sum, val) => sum + val, 0) / values.length,\r\n        pattern: this.identifyPattern(values)\r\n      }\r\n    })\r\n\r\n    return seasonality\r\n  }\r\n\r\n  /**\r\n   * Obtiene los mejores empleados\r\n   * @param {Array} employeeMetrics - M√©tricas de empleados\r\n   * @returns {Array} Mejores empleados\r\n   */\r\n  getTopPerformers(employeeMetrics) {\r\n    return employeeMetrics\r\n      .filter(emp => emp.metrics.total_messages > 0)\r\n      .sort((a, b) => parseFloat(b.metrics.engagement_rate) - parseFloat(a.metrics.engagement_rate))\r\n      .slice(0, 5)\r\n      .map(emp => ({\r\n        id: emp.id,\r\n        name: emp.name,\r\n        engagement_rate: emp.metrics.engagement_rate,\r\n        total_messages: emp.metrics.total_messages\r\n      }))\r\n  }\r\n\r\n  /**\r\n   * Obtiene desglose por departamento\r\n   * @param {Array} employeeMetrics - M√©tricas de empleados\r\n   * @returns {Object} Desglose por departamento\r\n   */\r\n  getDepartmentBreakdown(employeeMetrics) {\r\n    const departments = {}\r\n    \r\n    employeeMetrics.forEach(emp => {\r\n      const dept = emp.department || 'Sin departamento'\r\n      if (!departments[dept]) {\r\n        departments[dept] = {\r\n          employees: 0,\r\n          total_messages: 0,\r\n          avg_engagement: 0,\r\n          engagement_rates: []\r\n        }\r\n      }\r\n      \r\n      departments[dept].employees++\r\n      departments[dept].total_messages += emp.metrics.total_messages\r\n      departments[dept].engagement_rates.push(parseFloat(emp.metrics.engagement_rate))\r\n    })\r\n\r\n    // Calcular promedios\r\n    Object.keys(departments).forEach(dept => {\r\n      const rates = departments[dept].engagement_rates\r\n      departments[dept].avg_engagement = (rates.reduce((sum, rate) => sum + rate, 0) / rates.length).toFixed(1)\r\n      delete departments[dept].engagement_rates\r\n    })\r\n\r\n    return departments\r\n  }\r\n\r\n  /**\r\n   * Genera insights espec√≠ficos de reportes\r\n   * @param {Object} metrics - M√©tricas de comunicaci√≥n\r\n   * @returns {Array} Insights generados\r\n   */\r\n  generateReportSpecificInsights(metrics) {\r\n    const insights = []\r\n    const { delivery, engagement, channels } = metrics.communication\r\n\r\n    // Insight sobre rendimiento de canales\r\n    const bestChannel = Object.keys(channels).reduce((best, channel) => {\r\n      if (!best || parseFloat(channels[channel].delivery_rate) > parseFloat(channels[best].delivery_rate)) {\r\n        return channel\r\n      }\r\n      return best\r\n    }, null)\r\n\r\n    if (bestChannel) {\r\n      insights.push({\r\n        type: 'channel_performance',\r\n        title: 'Mejor canal identificado',\r\n        description: `${bestChannel} tiene el mejor rendimiento con ${channels[bestChannel].delivery_rate}% de tasa de entrega`,\r\n        recommendation: `Considerar aumentar el uso de ${bestChannel} para comunicaciones cr√≠ticas`\r\n      })\r\n    }\r\n\r\n    // Insight sobre patrones temporales\r\n    if (engagement.read_trend === 'increasing') {\r\n      insights.push({\r\n        type: 'positive_trend',\r\n        title: 'Tendencia positiva en lectura',\r\n        description: 'La tasa de lectura est√° aumentando consistentemente',\r\n        recommendation: 'Mantener estrategias actuales de contenido'\r\n      })\r\n    }\r\n\r\n    return insights\r\n  }\r\n\r\n  /**\r\n   * Calcula ranking de m√©tricas\r\n   * @param {Object} currentMetrics - M√©tricas actuales\r\n   * @param {Array} allMetrics - Todas las m√©tricas\r\n   * @returns {Object} Ranking calculado\r\n   */\r\n  calculateRanking(currentMetrics, allMetrics) {\r\n    const deliveryRates = allMetrics.map(m => parseFloat(m.delivery.delivery_rate) || 0)\r\n    const engagementRates = allMetrics.map(m => parseFloat(m.engagement.overall_engagement) || 0)\r\n    const volumes = allMetrics.map(m => m.overview.total_messages || 0)\r\n\r\n    const deliveryRanking = this.getRank(parseFloat(currentMetrics.delivery.delivery_rate), deliveryRates)\r\n    const engagementRanking = this.getRank(parseFloat(currentMetrics.engagement.overall_engagement), engagementRates)\r\n    const volumeRanking = this.getRank(currentMetrics.overview.total_messages, volumes)\r\n\r\n    return {\r\n      delivery: deliveryRanking,\r\n      engagement: engagementRanking,\r\n      volume: volumeRanking,\r\n      overall: Math.floor((deliveryRanking + engagementRanking + volumeRanking) / 3)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene ranking de un valor espec√≠fico\r\n   * @param {number} value - Valor a evaluar\r\n   * @param {Array} values - Todos los valores\r\n   * @returns {number} Ranking calculado\r\n   */\r\n  getRank(value, values) {\r\n    const sorted = [...values].sort((a, b) => b - a)\r\n    const index = sorted.indexOf(value)\r\n    return index + 1\r\n  }\r\n\r\n  /**\r\n   * Calcula mediana\r\n   * @param {Array} values - Valores\r\n   * @returns {number} Mediana calculada\r\n   */\r\n  calculateMedian(values) {\r\n    const sorted = [...values].sort((a, b) => a - b)\r\n    const mid = Math.floor(sorted.length / 2)\r\n    return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2\r\n  }\r\n\r\n  /**\r\n   * Calcula desviaci√≥n est√°ndar\r\n   * @param {Array} values - Valores\r\n   * @returns {number} Desviaci√≥n est√°ndar calculada\r\n   */\r\n  calculateStandardDeviation(values) {\r\n    const avg = values.reduce((sum, val) => sum + val, 0) / values.length\r\n    const squareDiffs = values.map(val => Math.pow(val - avg, 2))\r\n    const avgSquareDiff = squareDiffs.reduce((sum, val) => sum + val, 0) / values.length\r\n    return Math.sqrt(avgSquareDiff)\r\n  }\r\n\r\n  /**\r\n   * Calcula promedio\r\n   * @param {Array} values - Valores\r\n   * @returns {number} Promedio calculado\r\n   */\r\n  calculateAverage(values) {\r\n    return values.reduce((sum, val) => sum + val, 0) / values.length\r\n  }\r\n\r\n  /**\r\n   * Determina direcci√≥n de tendencia\r\n   * @param {Array} growthValues - Valores de crecimiento\r\n   * @returns {string} Direcci√≥n de la tendencia\r\n   */\r\n  determineTrendDirection(growthValues) {\r\n    const avgGrowth = growthValues.reduce((sum, val) => sum + parseFloat(val), 0) / growthValues.length\r\n    if (avgGrowth > 5) return 'strong_growth'\r\n    if (avgGrowth > 0) return 'moderate_growth'\r\n    if (avgGrowth > -5) return 'stable'\r\n    return 'declining'\r\n  }\r\n\r\n  /**\r\n   * Identifica patr√≥n en valores\r\n   * @param {Array} values - Valores\r\n   * @returns {string} Patr√≥n identificado\r\n   */\r\n  identifyPattern(values) {\r\n    if (values.length < 3) return 'insufficient_data'\r\n    \r\n    const increasing = values.every((val, i) => i === 0 || val >= values[i - 1])\r\n    const decreasing = values.every((val, i) => i === 0 || val <= values[i - 1])\r\n    \r\n    if (increasing) return 'increasing'\r\n    if (decreasing) return 'decreasing'\r\n    return 'variable'\r\n  }\r\n\r\n  /**\r\n   * Obtiene rango de fechas\r\n   * @param {string} range - Rango de fechas\r\n   * @returns {Object} Fechas de inicio y fin\r\n   */\r\n  getDateRange(range) {\r\n    const now = new Date()\r\n    const end = now.toISOString()\r\n    \r\n    let start\r\n    switch (range) {\r\n      case '1d':\r\n        start = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString()\r\n        break\r\n      case '7d':\r\n        start = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString()\r\n        break\r\n      case '30d':\r\n        start = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString()\r\n        break\r\n      case '90d':\r\n        start = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000).toISOString()\r\n        break\r\n      default:\r\n        start = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString()\r\n    }\r\n\r\n    return { start, end }\r\n  }\r\n\r\n  /**\r\n   * Limpia cach√©\r\n   */\r\n  clearCache() {\r\n    this.cache.clear()\r\n  }\r\n}\r\n\r\nconst companyReportsService = new CompanyReportsService();\r\nexport default companyReportsService;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\companySyncService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\configurationService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\databaseEmployeeService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'tableCheck' is assigned a value but never used.","line":151,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":151,"endColumn":31},{"ruleId":"no-unused-vars","severity":1,"message":"'tableCheck' is assigned a value but never used.","line":186,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":186,"endColumn":31},{"ruleId":"no-unreachable","severity":1,"message":"Unreachable code.","line":236,"column":21,"nodeType":"BlockStatement","messageId":"unreachableCode","endLine":239,"endColumn":6},{"ruleId":"no-unused-vars","severity":1,"message":"'tablesCheck' is assigned a value but never used.","line":248,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":248,"endColumn":32},{"ruleId":"no-unused-vars","severity":1,"message":"'commCheck' is assigned a value but never used.","line":259,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":259,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from '../lib/supabase.js';\r\n\r\nclass DatabaseEmployeeService {\r\n  // Obtener todos los empleados con filtros opcionales\r\n  async getEmployees(filters = {}) {\r\n    try {\r\n      let query = supabase\r\n        .from('companies')\r\n        .select('*');\r\n\r\n      // Aplicar filtros\r\n      if (filters.companyId) {\r\n        query = query.eq('id', filters.companyId);\r\n      }\r\n\r\n      if (filters.region) {\r\n        query = query.ilike('location', `%${filters.region}%`);\r\n      }\r\n\r\n      if (filters.department) {\r\n        query = query.ilike('department', `%${filters.department}%`);\r\n      }\r\n\r\n      if (filters.position) {\r\n        query = query.ilike('position', `%${filters.position}%`);\r\n      }\r\n\r\n      if (filters.role) {\r\n        query = query.ilike('role', `%${filters.role}%`);\r\n      }\r\n\r\n      if (filters.status) {\r\n        query = query.eq('status', filters.status);\r\n      }\r\n\r\n      // Solo empleados activos por defecto\r\n      query = query.eq('status', 'active');\r\n\r\n      // Ordenar por nombre\r\n      query = query.order('name');\r\n\r\n      // Limitar resultados\r\n      if (filters.limit) {\r\n        query = query.limit(filters.limit);\r\n      }\r\n\r\n      const { data: employees, error } = await query;\r\n\r\n      if (error) {\r\n        console.error('Error obteniendo empleados:', error);\r\n        throw error;\r\n      }\r\n\r\n      // Formatear respuesta para mantener compatibilidad\r\n      return employees.map(employee => ({\r\n        ...employee,\r\n        company: employee.name || null\r\n      }));\r\n\r\n    } catch (error) {\r\n      console.error('Error obteniendo empleados:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Obtener todas las empresas - SOLO desde base de datos\r\n  async getCompanies() {\r\n    try {\r\n      console.log('üîç DEBUG: databaseEmployeeService.getCompanies() - Iniciando...');\r\n      \r\n      // ‚úÖ CORRECCI√ìN: Obtener empresas reales desde la base de datos SIN fallback\r\n      const { data: companies, error } = await supabase\r\n        .from('companies')\r\n        .select('id, name')\r\n        .eq('status', 'active')\r\n        .order('name', { ascending: true });\r\n\r\n      if (error) {\r\n        console.error('‚ùå Error obteniendo empresas de BD:', error);\r\n        console.log('üîç DEBUG: Retornando lista vac√≠a - no hay fallback para evitar duplicaciones');\r\n        return [];\r\n      }\r\n\r\n      // Si no hay empresas, retornar lista vac√≠a\r\n      if (!companies || companies.length === 0) {\r\n        console.log('üîç DEBUG: No hay empresas en BD, retornando lista vac√≠a');\r\n        return [];\r\n      }\r\n\r\n      // Verificar duplicados antes de retornar\r\n      const uniqueCompanies = companies.filter((company, index, self) =>\r\n        index === self.findIndex((c) => c.id === company.id)\r\n      );\r\n\r\n      if (uniqueCompanies.length !== companies.length) {\r\n        console.warn('‚ö†Ô∏è databaseEmployeeService: Se detectaron duplicados en BD:', {\r\n          original: companies.length,\r\n          unique: uniqueCompanies.length,\r\n          duplicados: companies.length - uniqueCompanies.length,\r\n          datosOriginales: companies,\r\n          datosUnicos: uniqueCompanies,\r\n          idsOriginales: companies.map(c => c.id),\r\n          idsUnicos: uniqueCompanies.map(c => c.id)\r\n        });\r\n      }\r\n\r\n      console.log('üîç DEBUG: Empresas reales cargadas desde databaseEmployeeService:', uniqueCompanies.length);\r\n      console.log('üîç DEBUG: Datos completos:', uniqueCompanies);\r\n      return uniqueCompanies;\r\n    } catch (error) {\r\n      console.error('‚ùå Error en databaseEmployeeService.getCompanies():', error);\r\n      console.log('üîç DEBUG: Retornando lista vac√≠a debido a error - sin fallback');\r\n      return [];\r\n    }\r\n  }\r\n\r\n  // Obtener empleado por ID\r\n  async getEmployeeById(id) {\r\n    try {\r\n      const { data: employee, error } = await supabase\r\n        .from('companies')\r\n        .select('*')\r\n        .eq('id', id)\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error('Error obteniendo empleado:', error);\r\n        throw error;\r\n      }\r\n\r\n      if (!employee) {\r\n        throw new Error('Empleado no encontrado');\r\n      }\r\n\r\n      return {\r\n        ...employee,\r\n        company: employee.name || null\r\n      };\r\n    } catch (error) {\r\n      console.error('Error obteniendo empleado:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Obtener conteo de empleados por empresa\r\n  async getEmployeeCountByCompany(companyId) {\r\n    try {\r\n      console.log(`üîç DEBUG: Obteniendo conteo de empleados para companyId: ${companyId}`);\r\n      \r\n      // Verificar si la tabla employees existe\r\n      const { data: tableCheck, error: tableError } = await supabase\r\n        .from('employees')\r\n        .select('id')\r\n        .limit(1);\r\n\r\n      if (tableError) {\r\n        console.log('üîç DEBUG: Tabla employees no existe:', tableError.message);\r\n        return 0;\r\n      }\r\n\r\n      // Obtener conteo real de empleados\r\n      const { count, error } = await supabase\r\n        .from('employees')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('company_id', companyId);\r\n\r\n      if (error) {\r\n        console.error('Error obteniendo conteo de empleados:', error);\r\n        return 0;\r\n      }\r\n\r\n      console.log(`üîç DEBUG: Empleados reales encontrados para ${companyId}:`, count || 0);\r\n      return count || 0;\r\n    } catch (error) {\r\n      console.error('Error obteniendo conteo de empleados:', error);\r\n      return 0;\r\n    }\r\n  }\r\n\r\n  // Obtener estad√≠sticas de mensajes por empresa\r\n  async getMessageStatsByCompany(companyId) {\r\n    try {\r\n      console.log(`üîç DEBUG: Obteniendo estad√≠sticas de mensajes para companyId: ${companyId}`);\r\n      \r\n      // Verificar si la tabla communication_logs existe\r\n      const { data: tableCheck, error: tableError } = await supabase\r\n        .from('communication_logs')\r\n        .select('id')\r\n        .limit(1);\r\n\r\n      if (tableError) {\r\n        console.log('üîç DEBUG: Tabla communication_logs no existe:', tableError.message);\r\n        return { scheduled: 0, draft: 0, sent: 0, read: 0, total: 0 };\r\n      }\r\n\r\n      // Obtener estad√≠sticas reales\r\n      const { data: logs, error } = await supabase\r\n        .from('communication_logs')\r\n        .select('status')\r\n        .eq('company_id', companyId);\r\n\r\n      if (error) {\r\n        console.error('Error obteniendo estad√≠sticas de mensajes:', error);\r\n        return { scheduled: 0, draft: 0, sent: 0, read: 0, total: 0 };\r\n      }\r\n\r\n      const stats = {\r\n        scheduled: 0,\r\n        draft: 0,\r\n        sent: 0,\r\n        read: 0,\r\n        total: 0\r\n      };\r\n\r\n      logs?.forEach(log => {\r\n        if (stats[log.status] !== undefined) {\r\n          stats[log.status]++;\r\n        }\r\n      });\r\n\r\n      stats.total = logs?.length || 0;\r\n\r\n      console.log(`üîç DEBUG: Estad√≠sticas reales para ${companyId}:`, stats);\r\n      return stats;\r\n    } catch (error) {\r\n      console.error('Error obteniendo estad√≠sticas de mensajes:', error);\r\n      return { scheduled: 0, draft: 0, sent: 0, read: 0, total: 0 };\r\n    }\r\n  }\r\n\r\n  // Obtener pr√≥ximo mensaje programado\r\n  async getNextScheduledMessage(companyId) {\r\n    try {\r\n      // Como no hay tabla de mensajes, retornamos null\r\n      return null;\r\n    } catch (error) {\r\n      console.error('Error obteniendo pr√≥ximo mensaje programado:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Obtener estad√≠sticas generales para el dashboard\r\n  async getDashboardStats() {\r\n    try {\r\n      console.log('üîç DEBUG: Verificando existencia de tablas...');\r\n      \r\n      // Verificar si las tablas existen primero\r\n      const { data: tablesCheck, error: tablesError } = await supabase\r\n        .from('companies')\r\n        .select('id')\r\n        .limit(1);\r\n\r\n      console.log('üîç DEBUG: Tabla companies existe:', !tablesError ? 'S√ç' : 'NO');\r\n      if (tablesError) {\r\n        console.log('üîç DEBUG: Error en tabla companies:', tablesError.message);\r\n      }\r\n\r\n      // Verificar tabla communication_logs\r\n      const { data: commCheck, error: commError } = await supabase\r\n        .from('communication_logs')\r\n        .select('id')\r\n        .limit(1);\r\n\r\n      console.log('üîç DEBUG: Tabla communication_logs existe:', !commError ? 'S√ç' : 'NO');\r\n      if (commError) {\r\n        console.log('üîç DEBUG: Error en tabla communication_logs:', commError.message);\r\n      }\r\n\r\n      // Total empleados (empresas activas)\r\n      const { count: totalEmployees, error: employeesError } = await supabase\r\n        .from('companies')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('status', 'active');\r\n\r\n      if (employeesError) {\r\n        console.error('Error obteniendo total empleados:', employeesError);\r\n        throw employeesError;\r\n      }\r\n\r\n      // Obtener datos REALES de communication_logs en lugar de generarlos\r\n      let sentMessages = 0;\r\n      let readRate = 0;\r\n\r\n      if (!commError) {\r\n        try {\r\n          const { data: commStats, error: statsError } = await supabase\r\n            .from('communication_logs')\r\n            .select('status')\r\n            .eq('status', 'sent');\r\n\r\n          if (!statsError && commStats) {\r\n            sentMessages = commStats.length;\r\n            console.log('üîç DEBUG: Mensajes enviados reales encontrados:', sentMessages);\r\n          }\r\n\r\n          const { data: readStats, error: readError } = await supabase\r\n            .from('communication_logs')\r\n            .select('status')\r\n            .eq('status', 'read');\r\n\r\n          if (!readError && readStats) {\r\n            readRate = sentMessages > 0 ? Math.round((readStats.length / sentMessages) * 100) : 0;\r\n            console.log('üîç DEBUG: Mensajes le√≠dos reales encontrados:', readStats.length);\r\n          }\r\n        } catch (error) {\r\n          console.warn('üîç DEBUG: Error obteniendo estad√≠sticas reales de comunicaci√≥n:', error.message);\r\n        }\r\n      } else {\r\n        console.log('üîç DEBUG: Tabla communication_logs no existe, usando valores 0');\r\n      }\r\n\r\n      const result = {\r\n        totalEmployees: totalEmployees || 0,\r\n        sentMessages: sentMessages,\r\n        readRate: readRate\r\n      };\r\n\r\n      console.log('üîç DEBUG: Estad√≠sticas finales del dashboard:', result);\r\n      return result;\r\n    } catch (error) {\r\n      console.error('Error obteniendo estad√≠sticas del dashboard:', error);\r\n      // En caso de error, retornar valores vac√≠os en lugar de simulados\r\n      return {\r\n        totalEmployees: 0,\r\n        sentMessages: 0,\r\n        readRate: 0\r\n      };\r\n    }\r\n  }\r\n}\r\n\r\nconst databaseEmployeeService = new DatabaseEmployeeService();\r\nexport default databaseEmployeeService;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\databaseService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\embeddingService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\employeeDataService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'employeeCount' is assigned a value but never used.","line":420,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":420,"endColumn":28},{"ruleId":"import/no-anonymous-default-export","severity":1,"message":"Assign instance to a variable before exporting as module default","line":793,"column":1,"nodeType":"ExportDefaultDeclaration","endLine":793,"endColumn":42}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from '../lib/supabase.js';\r\n\r\nclass EmployeeDataService {\r\n  // Nombres y apellidos comunes en Chile\r\n  firstNames = [\r\n    'Camila', 'Patricio', 'V√≠ctor', 'Graciela', 'Jorge', 'Ricardo', 'Felipe', 'Arturo', \r\n    'Valentina', 'Isabel', 'C√©sar', 'Oscar', 'Carolina', 'Rodrigo', 'Francisco', \r\n    'Miguel', 'Alejandro', 'Daniela', 'Romina', 'Silvana', 'Guillermo', 'Fernanda', \r\n    'Claudia', 'Teresa', 'V√≠ctor', 'Cristian', 'Diego', 'Natalia', 'Luis', 'Karina',\r\n    'Andr√©s', 'Marcela', 'Ver√≥nica', 'Roberto', 'Tamara', 'Danielle', 'Macarena',\r\n    'Sebasti√°n', 'Pablo', 'Eduardo', 'Fernando', 'Constanza', 'Paulina', 'Catalina',\r\n    'Ignacio', 'Renata', 'Mat√≠as', 'Camilo', 'Andrea', 'Nicole', 'Jos√©', 'Manuel'\r\n  ];\r\n\r\n  lastNames = [\r\n    'Guti√©rrez', 'Castro', 'Vargas', 'Reyes', 'Sep√∫lveda', 'Henr√≠quez', 'Miranda',\r\n    'L√≥pez', 'Pizarro', 'Villarroel', 'Ramos', 'Morales', '√Ålvarez', 'Cort√©s',\r\n    'Rivera', 'Parra', 'Leiva', 'Silva', 'Fuentes', 'Z√∫√±iga', 'D√≠az', 'Mu√±oz',\r\n    'Romero', 'Guzm√°n', 'Moraga', 'Contreras', 'Herrera', 'Roas', 'Aguilera',\r\n    'P√©rez', 'S√°nchez', 'Gonz√°lez', 'Rodr√≠guez', 'Fern√°ndez', 'L√≥pez', 'Mart√≠nez',\r\n    'Garc√≠a', 'G√≥mez', 'Mart√≠n', 'Jim√©nez', 'Ruiz', 'Hern√°ndez', 'D√≠az', 'Moreno'\r\n  ];\r\n\r\n  regions = [\r\n    'Regi√≥n de Tarapac√°', 'Regi√≥n de Antofagasta', 'Regi√≥n de Atacama', \r\n    'Regi√≥n de Coquimbo', 'Regi√≥n de Valpara√≠so', \r\n    'Regi√≥n del Libertador General Bernardo O\\'Higgins', 'Regi√≥n del Maule', \r\n    'Regi√≥n de √ëuble', 'Regi√≥n del Biob√≠o', 'Regi√≥n de La Araucan√≠a', \r\n    'Regi√≥n de Los R√≠os', 'Regi√≥n de Los Lagos', \r\n    'Regi√≥n Ays√©n del General Carlos Ib√°√±ez del Campo', \r\n    'Regi√≥n de Magallanes y de la Ant√°rtica Chilena', 'Regi√≥n Metropolitana'\r\n  ];\r\n\r\n  departments = [\r\n    'Operaciones', 'TI', 'Seguridad', 'Producci√≥n', 'RRHH', 'Administraci√≥n',\r\n    'Planificaci√≥n', 'Mantenimiento', 'Servicio al Cliente', 'Log√≠stica',\r\n    'Investigaci√≥n y Desarrollo', 'Contabilidad', 'Finanzas', 'Tesorer√≠a',\r\n    'Marketing', 'Ventas', 'Auditor√≠a', 'Legal', 'Calidad', 'Compras'\r\n  ];\r\n\r\n  levels = [\r\n    'Asistente', 'Especialista', 'Supervisor', 'Coordinador', \r\n    'Jefatura', 'Gerente', 'Director', 'Operario'\r\n  ];\r\n\r\n  positions = [\r\n    'Jefe de Operaciones', 'Desarrollador', 'Supervisor de Seguridad',\r\n    'Jefe de Producci√≥n', 'Reclutador', 'Especialista en Seguridad',\r\n    'T√©cnico de Soporte', 'Operario de Producci√≥n', 'Coordinador Administrativo',\r\n    'Planificador', 'Administrativo', 'Gerente de Mantenimiento',\r\n    'Ejecutivo de Servicio', 'Supervisor de Log√≠stica', 'Desarrollador de Producto',\r\n    'Asistente Contable', 'Asistente de Calidad', 'Jefe Administrativo',\r\n    'Jefe de Mantenimiento', 'Coordinador Administrativo', 'Gerente Contable',\r\n    'Gerente Financiero', 'Asistente de Mantenimiento', 'Asistente Financiero',\r\n    'Jefe de Calidad', 'Jefe de RRHH', 'Supervisor de Operaciones',\r\n    'Analista de Tesorer√≠a', 'Supervisor de Producci√≥n', 'Especialista en Marketing',\r\n    'Ejecutivo de Ventas', 'Jefe de Tesorer√≠a', 'Contador', 'Asistente de Auditor√≠a',\r\n    'Especialista en Cumplimiento', 'Asistente de Mantenimiento', 'Jefe de Log√≠stica',\r\n    'Coordinador de Marketing', 'Gerente de Auditor√≠a', 'Gerente Legal',\r\n    'Gerente de Ventas', 'Asistente de Tesorer√≠a', 'Auditor Interno'\r\n  ];\r\n\r\n  workModes = ['Presencial', 'H√≠brido', 'Remoto'];\r\n  contractTypes = ['Indefinido', 'Plazo Fijo', 'Honorarios'];\r\n\r\n  // Generar un nombre aleatorio\r\n  generateRandomName() {\r\n    // Validar que los arrays de nombres no est√©n vac√≠os\r\n    if (!this.firstNames || this.firstNames.length === 0) {\r\n      throw new Error('No hay nombres disponibles para generar empleados');\r\n    }\r\n    if (!this.lastNames || this.lastNames.length === 0) {\r\n      throw new Error('No hay apellidos disponibles para generar empleados');\r\n    }\r\n    \r\n    const firstName = this.firstNames[Math.floor(Math.random() * this.firstNames.length)];\r\n    const lastName = this.lastNames[Math.floor(Math.random() * this.lastNames.length)];\r\n    \r\n    // Validar que los nombres generados no est√©n vac√≠os\r\n    if (!firstName || typeof firstName !== 'string' || firstName.trim().length === 0) {\r\n      throw new Error('Nombre generado inv√°lido');\r\n    }\r\n    if (!lastName || typeof lastName !== 'string' || lastName.trim().length === 0) {\r\n      throw new Error('Apellido generado inv√°lido');\r\n    }\r\n    \r\n    return `${firstName} ${lastName}`;\r\n  }\r\n\r\n  // Generar un email basado en el nombre y empresa\r\n  generateEmail(name, companyName) {\r\n    // Validar par√°metros de entrada\r\n    if (!name || typeof name !== 'string' || name.trim().length === 0) {\r\n      throw new Error('Nombre es requerido y no puede estar vac√≠o para generar email');\r\n    }\r\n    if (!companyName || typeof companyName !== 'string' || companyName.trim().length === 0) {\r\n      throw new Error('Nombre de empresa es requerido y no puede estar vac√≠o para generar email');\r\n    }\r\n    \r\n    const cleanName = name.toLowerCase().replace(/\\s+/g, '.');\r\n    const cleanCompany = companyName.toLowerCase().replace(/\\s+/g, '');\r\n    \r\n    // Validar que la limpieza no resulte en strings vac√≠os\r\n    if (!cleanName || cleanName.trim().length === 0) {\r\n      throw new Error('Nombre limpio inv√°lido para generar email');\r\n    }\r\n    if (!cleanCompany || cleanCompany.trim().length === 0) {\r\n      throw new Error('Nombre de empresa limpio inv√°lido para generar email');\r\n    }\r\n    \r\n    const email = `${cleanName}@${cleanCompany}.cl`;\r\n    \r\n    // Validaci√≥n b√°sica del formato del email\r\n    if (!email.includes('@') || !email.endsWith('.cl')) {\r\n      throw new Error('Formato de email generado inv√°lido');\r\n    }\r\n    \r\n    return email;\r\n  }\r\n\r\n  // Generar un tel√©fono aleatorio\r\n  generatePhone() {\r\n    // Validar que el rango de n√∫meros sea v√°lido\r\n    const maxNumber = 10000000;\r\n    const number = Math.floor(Math.random() * maxNumber);\r\n    \r\n    // Validar que el n√∫mero generado est√© en el rango correcto\r\n    if (typeof number !== 'number' || number < 0 || number >= maxNumber) {\r\n      throw new Error('N√∫mero telef√≥nico generado inv√°lido');\r\n    }\r\n    \r\n    const phone = `+56 9 ${number.toString().padStart(8, '0')}`;\r\n    \r\n    // Validar formato del tel√©fono\r\n    if (!phone.startsWith('+56 9 ') || phone.length !== 13) {\r\n      throw new Error('Formato de tel√©fono generado inv√°lido');\r\n    }\r\n    \r\n    return phone;\r\n  }\r\n\r\n  // Generar datos de empleado aleatorios\r\n  generateEmployeeData(companyId, companyName) {\r\n    // Validar par√°metros de entrada\r\n    if (!companyId || typeof companyId !== 'string') {\r\n      throw new Error('ID de empresa es requerido y debe ser string para generar empleado');\r\n    }\r\n    if (!companyName || typeof companyName !== 'string' || companyName.trim().length === 0) {\r\n      throw new Error('Nombre de empresa es requerido y no puede estar vac√≠o para generar empleado');\r\n    }\r\n    \r\n    const name = this.generateRandomName();\r\n    \r\n    // Validar que los arrays de datos no est√©n vac√≠os\r\n    if (!this.regions || this.regions.length === 0) {\r\n      throw new Error('No hay regiones disponibles para asignar al empleado');\r\n    }\r\n    if (!this.departments || this.departments.length === 0) {\r\n      throw new Error('No hay departamentos disponibles para asignar al empleado');\r\n    }\r\n    if (!this.levels || this.levels.length === 0) {\r\n      throw new Error('No hay niveles disponibles para asignar al empleado');\r\n    }\r\n    if (!this.positions || this.positions.length === 0) {\r\n      throw new Error('No hay posiciones disponibles para asignar al empleado');\r\n    }\r\n    if (!this.workModes || this.workModes.length === 0) {\r\n      throw new Error('No hay modos de trabajo disponibles para asignar al empleado');\r\n    }\r\n    if (!this.contractTypes || this.contractTypes.length === 0) {\r\n      throw new Error('No hay tipos de contrato disponibles para asignar al empleado');\r\n    }\r\n    \r\n    const employeeData = {\r\n      company_id: companyId,\r\n      name: name,\r\n      email: this.generateEmail(name, companyName),\r\n      phone: this.generatePhone(),\r\n      region: this.regions[Math.floor(Math.random() * this.regions.length)],\r\n      department: this.departments[Math.floor(Math.random() * this.departments.length)],\r\n      level: this.levels[Math.floor(Math.random() * this.levels.length)],\r\n      position: this.positions[Math.floor(Math.random() * this.positions.length)],\r\n      work_mode: this.workModes[Math.floor(Math.random() * this.workModes.length)],\r\n      contract_type: this.contractTypes[Math.floor(Math.random() * this.contractTypes.length)],\r\n      is_active: true,\r\n      has_subordinates: Math.random() > 0.7\r\n    };\r\n    \r\n    // Validar los datos generados antes de retornarlos\r\n    this.validateEmployeeData(employeeData);\r\n    \r\n    return employeeData;\r\n  }\r\n\r\n  // Validar datos de empresa\r\n  validateCompanyData(company) {\r\n    if (!company || typeof company !== 'object') {\r\n      throw new Error('Datos de empresa inv√°lidos');\r\n    }\r\n    if (!company.id || typeof company.id !== 'string') {\r\n      throw new Error('ID de empresa es requerido y debe ser string');\r\n    }\r\n    if (!company.name || typeof company.name !== 'string' || company.name.trim().length === 0) {\r\n      throw new Error('Nombre de empresa es requerido y no puede estar vac√≠o');\r\n    }\r\n    return true;\r\n  }\r\n\r\n  // Validar datos de empleado\r\n  validateEmployeeData(employee) {\r\n    if (!employee || typeof employee !== 'object') {\r\n      throw new Error('Datos de empleado inv√°lidos');\r\n    }\r\n    if (!employee.company_id || typeof employee.company_id !== 'string') {\r\n      throw new Error('ID de empresa es requerido y debe ser string');\r\n    }\r\n    if (!employee.name || typeof employee.name !== 'string' || employee.name.trim().length === 0) {\r\n      throw new Error('Nombre de empleado es requerido y no puede estar vac√≠o');\r\n    }\r\n    if (!employee.email || typeof employee.email !== 'string' || !employee.email.includes('@')) {\r\n      throw new Error('Email de empleado es requerido y debe ser v√°lido');\r\n    }\r\n    if (employee.phone && (typeof employee.phone !== 'string' || employee.phone.trim().length === 0)) {\r\n      throw new Error('Tel√©fono debe ser string v√°lido o nulo');\r\n    }\r\n    return true;\r\n  }\r\n\r\n  // Validar l√≠mites de empleados\r\n  validateEmployeeCount(count, operation = 'operaci√≥n') {\r\n    if (typeof count !== 'number' || count < 0) {\r\n      throw new Error(`El conteo de empleados debe ser un n√∫mero positivo para ${operation}`);\r\n    }\r\n    if (count > 1000) {\r\n      throw new Error(`El conteo de empleados no puede exceder 1000 para ${operation}`);\r\n    }\r\n    return true;\r\n  }\r\n\r\n  // Obtener el conteo de empleados por empresa del dashboard\r\n  async getDashboardEmployeeCounts() {\r\n    try {\r\n      // Obtener todas las empresas\r\n      const { data: companies, error: companiesError } = await supabase\r\n        .from('companies')\r\n        .select('id, name');\r\n      \r\n      if (companiesError) throw companiesError;\r\n      \r\n      // Validar que se obtuvieron empresas\r\n      if (!companies || companies.length === 0) {\r\n        console.warn('No se encontraron empresas en la base de datos');\r\n        return [];\r\n      }\r\n      \r\n      // Validar cada empresa antes de procesar\r\n      companies.forEach(company => this.validateCompanyData(company));\r\n      \r\n      // Para cada empresa, devolver siempre 50 empleados (como solicitado)\r\n      const companyCounts = companies.map((company) => ({\r\n        companyId: company.id,\r\n        companyName: company.name,\r\n        desiredCount: 50 // Exactamente 50 empleados por empresa\r\n      }));\r\n      \r\n      return companyCounts;\r\n    } catch (error) {\r\n      console.error('Error getting dashboard employee counts:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Sincronizar empleados con los conteos deseados\r\n  async syncEmployeesWithDashboard() {\r\n    try {\r\n      console.log('Sincronizando empleados con el dashboard...');\r\n      \r\n      // Obtener los conteos deseados\r\n      const companyCounts = await this.getDashboardEmployeeCounts();\r\n      \r\n      // Para cada empresa, ajustar el n√∫mero de empleados\r\n      for (const companyCount of companyCounts) {\r\n        await this.adjustEmployeeCountForCompany(\r\n          companyCount.companyId, \r\n          companyCount.companyName, \r\n          companyCount.desiredCount\r\n        );\r\n      }\r\n      \r\n      console.log('Sincronizaci√≥n completada');\r\n      return { success: true };\r\n    } catch (error) {\r\n      console.error('Error sincronizando empleados:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Ajustar el n√∫mero de empleados para una empresa espec√≠fica\r\n  async adjustEmployeeCountForCompany(companyId, companyName, desiredCount) {\r\n    try {\r\n      // Validar par√°metros de entrada\r\n      if (!companyId || typeof companyId !== 'string') {\r\n        throw new Error('ID de empresa es requerido y debe ser string');\r\n      }\r\n      if (!companyName || typeof companyName !== 'string' || companyName.trim().length === 0) {\r\n        throw new Error('Nombre de empresa es requerido y no puede estar vac√≠o');\r\n      }\r\n      this.validateEmployeeCount(desiredCount, 'ajuste de empleados');\r\n      \r\n      // Obtener el conteo actual de empleados\r\n      const { count: currentCount, error: countError } = await supabase\r\n        .from('employees')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('company_id', companyId);\r\n      \r\n      if (countError) throw countError;\r\n      \r\n      console.log(`Empresa: ${companyName}, Actual: ${currentCount}, Deseado: ${desiredCount}`);\r\n      \r\n      if (currentCount < desiredCount) {\r\n        // Necesitamos agregar empleados\r\n        const employeesToAdd = desiredCount - currentCount;\r\n        this.validateEmployeeCount(employeesToAdd, 'agregar empleados');\r\n        console.log(`Agregando ${employeesToAdd} empleados a ${companyName}`);\r\n        \r\n        const employeesData = [];\r\n        for (let i = 0; i < employeesToAdd; i++) {\r\n          const employeeData = this.generateEmployeeData(companyId, companyName);\r\n          this.validateEmployeeData(employeeData);\r\n          employeesData.push(employeeData);\r\n        }\r\n        \r\n        // Validar que no haya duplicados por email antes de insertar\r\n        const emails = employeesData.map(emp => emp.email);\r\n        const { data: existingEmployees, error: checkError } = await supabase\r\n          .from('employees')\r\n          .select('email')\r\n          .in('email', emails)\r\n          .eq('company_id', companyId);\r\n        \r\n        if (checkError) throw checkError;\r\n        \r\n        if (existingEmployees && existingEmployees.length > 0) {\r\n          const existingEmails = existingEmployees.map(emp => emp.email);\r\n          const duplicates = emails.filter(email => existingEmails.includes(email));\r\n          throw new Error(`Ya existen empleados con los emails: ${duplicates.join(', ')}`);\r\n        }\r\n        \r\n        const { error: insertError } = await supabase\r\n          .from('employees')\r\n          .insert(employeesData);\r\n        \r\n        if (insertError) throw insertError;\r\n      } else if (currentCount > desiredCount) {\r\n        // Necesitamos eliminar empleados\r\n        const employeesToRemove = currentCount - desiredCount;\r\n        this.validateEmployeeCount(employeesToRemove, 'eliminar empleados');\r\n        console.log(`Eliminando ${employeesToRemove} empleados de ${companyName}`);\r\n        \r\n        // Validar que no se eliminen todos los empleados\r\n        if (desiredCount === 0) {\r\n          throw new Error('No se pueden eliminar todos los empleados de una empresa');\r\n        }\r\n        \r\n        // Obtener IDs de empleados para eliminar\r\n        const { data: employeesToDelete, error: selectError } = await supabase\r\n          .from('employees')\r\n          .select('id')\r\n          .eq('company_id', companyId)\r\n          .limit(employeesToRemove);\r\n        \r\n        if (selectError) throw selectError;\r\n        \r\n        if (!employeesToDelete || employeesToDelete.length === 0) {\r\n          throw new Error('No se encontraron empleados para eliminar');\r\n        }\r\n        \r\n        const employeeIds = employeesToDelete.map(emp => emp.id);\r\n        \r\n        // Validar que los IDs sean v√°lidos\r\n        if (employeeIds.some(id => !id || typeof id !== 'string')) {\r\n          throw new Error('IDs de empleados inv√°lidos para eliminar');\r\n        }\r\n        \r\n        const { error: deleteError } = await supabase\r\n          .from('employees')\r\n          .delete()\r\n          .in('id', employeeIds);\r\n        \r\n        if (deleteError) throw deleteError;\r\n      }\r\n    } catch (error) {\r\n      console.error(`Error ajustando empleados para ${companyName}:`, error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Generar datos de empleados para todas las empresas (50 por empresa)\r\n  async generateEmployeesForAllCompanies() {\r\n    try {\r\n      // console.log('Generando datos de empleados para todas las empresas...');\r\n      \r\n      // Obtener todas las empresas\r\n      const { data: companies, error: companiesError } = await supabase\r\n        .from('companies')\r\n        .select('id, name');\r\n      \r\n      if (companiesError) throw companiesError;\r\n      \r\n      // Validar que se obtuvieron empresas\r\n      if (!companies || companies.length === 0) {\r\n        throw new Error('No se encontraron empresas para generar empleados');\r\n      }\r\n      \r\n      // Validar cada empresa antes de procesar\r\n      companies.forEach(company => this.validateCompanyData(company));\r\n      \r\n      // Para cada empresa, generar exactamente 50 empleados\r\n      for (const company of companies) {\r\n        const employeeCount = 50; // Exactamente 50 empleados por empresa\r\n        // console.log(`Generando ${employeeCount} empleados para ${company.name}`);\r\n        \r\n        // Primero verificar cu√°ntos empleados existen actualmente\r\n        const { count: currentCount, error: countError } = await supabase\r\n          .from('employees')\r\n          .select('*', { count: 'exact', head: true })\r\n          .eq('company_id', company.id);\r\n        \r\n        if (countError) throw countError;\r\n        \r\n        this.validateEmployeeCount(currentCount, 'conteo actual de empleados');\r\n        \r\n        // Si ya hay 50 empleados, no hacer nada\r\n        if (currentCount === 50) {\r\n          console.log(`Empresa ${company.name} ya tiene 50 empleados`);\r\n          continue;\r\n        }\r\n        \r\n        // Si hay menos de 50, generar los que faltan\r\n        if (currentCount < 50) {\r\n          const employeesToAdd = 50 - currentCount;\r\n          this.validateEmployeeCount(employeesToAdd, 'agregar empleados');\r\n          console.log(`Agregando ${employeesToAdd} empleados a ${company.name}`);\r\n          \r\n          const employeesData = [];\r\n          const emails = new Set(); // Para evitar duplicados en el mismo lote\r\n          \r\n          for (let i = 0; i < employeesToAdd; i++) {\r\n            let employeeData;\r\n            let attempts = 0;\r\n            const maxAttempts = 10;\r\n            \r\n            // Reintentar generar datos si el email ya existe\r\n            do {\r\n              employeeData = this.generateEmployeeData(company.id, company.name);\r\n              attempts++;\r\n              if (attempts > maxAttempts) {\r\n                throw new Error(`No se pudo generar un email √∫nico despu√©s de ${maxAttempts} intentos para ${company.name}`);\r\n              }\r\n            } while (emails.has(employeeData.email));\r\n            \r\n            emails.add(employeeData.email);\r\n            this.validateEmployeeData(employeeData);\r\n            employeesData.push(employeeData);\r\n          }\r\n          \r\n          // Verificar duplicados en la base de datos antes de insertar\r\n          const emailList = Array.from(emails);\r\n          const { data: existingEmployees, error: checkError } = await supabase\r\n            .from('employees')\r\n            .select('email')\r\n            .in('email', emailList)\r\n            .eq('company_id', company.id);\r\n          \r\n          if (checkError) throw checkError;\r\n          \r\n          if (existingEmployees && existingEmployees.length > 0) {\r\n            const existingEmails = existingEmployees.map(emp => emp.email);\r\n            throw new Error(`Ya existen empleados con los emails: ${existingEmails.join(', ')}`);\r\n          }\r\n          \r\n          // Insertar empleados en lotes de 100 para evitar problemas de memoria\r\n          for (let i = 0; i < employeesData.length; i += 100) {\r\n            const batch = employeesData.slice(i, i + 100);\r\n            const { error: insertError } = await supabase\r\n              .from('employees')\r\n              .insert(batch);\r\n            \r\n            if (insertError) throw insertError;\r\n          }\r\n        }\r\n        // Si hay m√°s de 50, eliminar los excedentes\r\n        else if (currentCount > 50) {\r\n          const employeesToRemove = currentCount - 50;\r\n          this.validateEmployeeCount(employeesToRemove, 'eliminar empleados');\r\n          console.log(`Eliminando ${employeesToRemove} empleados de ${company.name}`);\r\n          \r\n          // Validar que no se eliminen todos los empleados\r\n          if (50 === 0) {\r\n            throw new Error('No se pueden eliminar todos los empleados de una empresa');\r\n          }\r\n          \r\n          // Obtener IDs de empleados para eliminar\r\n          const { data: employeesToDelete, error: selectError } = await supabase\r\n            .from('employees')\r\n            .select('id')\r\n            .eq('company_id', company.id)\r\n            .limit(employeesToRemove);\r\n          \r\n          if (selectError) throw selectError;\r\n          \r\n          if (!employeesToDelete || employeesToDelete.length === 0) {\r\n            throw new Error('No se encontraron empleados para eliminar');\r\n          }\r\n          \r\n          const employeeIds = employeesToDelete.map(emp => emp.id);\r\n          \r\n          // Validar que los IDs sean v√°lidos\r\n          if (employeeIds.some(id => !id || typeof id !== 'string')) {\r\n            throw new Error('IDs de empleados inv√°lidos para eliminar');\r\n          }\r\n          \r\n          const { error: deleteError } = await supabase\r\n            .from('employees')\r\n            .delete()\r\n            .in('id', employeeIds);\r\n          \r\n          if (deleteError) throw deleteError;\r\n        }\r\n      }\r\n      \r\n      console.log('Generaci√≥n de empleados completada - 50 empleados por empresa');\r\n      return { success: true };\r\n    } catch (error) {\r\n      console.error('Error generando empleados:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Asegurar que cada empresa tenga exactamente 50 empleados\r\n  async ensure50EmployeesPerCompany(progressCallback) {\r\n    try {\r\n      if (progressCallback) progressCallback('Asegurando 50 empleados por empresa...');\r\n      \r\n      // Obtener todas las empresas\r\n      const { data: companies, error: companiesError } = await supabase\r\n        .from('companies')\r\n        .select('id, name');\r\n      \r\n      if (companiesError) throw companiesError;\r\n      \r\n      // Validar que se obtuvieron empresas\r\n      if (!companies || companies.length === 0) {\r\n        throw new Error('No se encontraron empresas para procesar');\r\n      }\r\n      \r\n      // Validar cada empresa antes de procesar\r\n      companies.forEach(company => this.validateCompanyData(company));\r\n      \r\n      if (progressCallback) progressCallback(`Encontradas ${companies.length} empresas`);\r\n      \r\n      // Para cada empresa, asegurar que tenga exactamente 50 empleados\r\n      for (const company of companies) {\r\n        if (progressCallback) progressCallback(`Procesando empresa: ${company.name}`);\r\n        \r\n        // Obtener el conteo actual de empleados\r\n        const { count: currentCount, error: countError } = await supabase\r\n          .from('employees')\r\n          .select('*', { count: 'exact', head: true })\r\n          .eq('company_id', company.id);\r\n        \r\n        if (countError) throw countError;\r\n        \r\n        this.validateEmployeeCount(currentCount, 'conteo actual de empleados');\r\n        \r\n        if (progressCallback) progressCallback(`Empresa ${company.name} tiene actualmente ${currentCount} empleados`);\r\n        \r\n        // Si ya hay 50 empleados, continuar con la siguiente empresa\r\n        if (currentCount === 50) {\r\n          if (progressCallback) progressCallback(`Empresa ${company.name} ya tiene exactamente 50 empleados`);\r\n          continue;\r\n        }\r\n        \r\n        // Si hay menos de 50, generar los que faltan\r\n        if (currentCount < 50) {\r\n          const employeesToAdd = 50 - currentCount;\r\n          this.validateEmployeeCount(employeesToAdd, 'agregar empleados');\r\n          if (progressCallback) progressCallback(`Agregando ${employeesToAdd} empleados a ${company.name}`);\r\n          \r\n          const employeesData = [];\r\n          const emails = new Set(); // Para evitar duplicados en el mismo lote\r\n          \r\n          for (let i = 0; i < employeesToAdd; i++) {\r\n            let employeeData;\r\n            let attempts = 0;\r\n            const maxAttempts = 10;\r\n            \r\n            // Reintentar generar datos si el email ya existe\r\n            do {\r\n              employeeData = this.generateEmployeeData(company.id, company.name);\r\n              attempts++;\r\n              if (attempts > maxAttempts) {\r\n                throw new Error(`No se pudo generar un email √∫nico despu√©s de ${maxAttempts} intentos para ${company.name}`);\r\n              }\r\n            } while (emails.has(employeeData.email));\r\n            \r\n            emails.add(employeeData.email);\r\n            this.validateEmployeeData(employeeData);\r\n            employeesData.push(employeeData);\r\n          }\r\n          \r\n          // Verificar duplicados en la base de datos antes de insertar\r\n          const emailList = Array.from(emails);\r\n          const { data: existingEmployees, error: checkError } = await supabase\r\n            .from('employees')\r\n            .select('email')\r\n            .in('email', emailList)\r\n            .eq('company_id', company.id);\r\n          \r\n          if (checkError) throw checkError;\r\n          \r\n          if (existingEmployees && existingEmployees.length > 0) {\r\n            const existingEmails = existingEmployees.map(emp => emp.email);\r\n            throw new Error(`Ya existen empleados con los emails: ${existingEmails.join(', ')}`);\r\n          }\r\n          \r\n          // Insertar empleados en lotes\r\n          for (let i = 0; i < employeesData.length; i += 100) {\r\n            const batch = employeesData.slice(i, i + 100);\r\n            const { error: insertError } = await supabase\r\n              .from('employees')\r\n              .insert(batch);\r\n            \r\n            if (insertError) throw insertError;\r\n          }\r\n          \r\n          if (progressCallback) progressCallback(`Agregados ${employeesToAdd} empleados a ${company.name}`);\r\n        }\r\n        // Si hay m√°s de 50, eliminar los excedentes\r\n        else if (currentCount > 50) {\r\n          const employeesToRemove = currentCount - 50;\r\n          this.validateEmployeeCount(employeesToRemove, 'eliminar empleados');\r\n          if (progressCallback) progressCallback(`Eliminando ${employeesToRemove} empleados de ${company.name}`);\r\n          \r\n          // Validar que no se eliminen todos los empleados\r\n          if (50 === 0) {\r\n            throw new Error('No se pueden eliminar todos los empleados de una empresa');\r\n          }\r\n          \r\n          // Obtener IDs de empleados para eliminar (aleatoriamente)\r\n          const { data: employeesToDelete, error: selectError } = await supabase\r\n            .from('employees')\r\n            .select('id')\r\n            .eq('company_id', company.id)\r\n            .limit(employeesToRemove);\r\n          \r\n          if (selectError) throw selectError;\r\n          \r\n          if (!employeesToDelete || employeesToDelete.length === 0) {\r\n            throw new Error('No se encontraron empleados para eliminar');\r\n          }\r\n          \r\n          const employeeIds = employeesToDelete.map(emp => emp.id);\r\n          \r\n          // Validar que los IDs sean v√°lidos\r\n          if (employeeIds.some(id => !id || typeof id !== 'string')) {\r\n            throw new Error('IDs de empleados inv√°lidos para eliminar');\r\n          }\r\n          \r\n          const { error: deleteError } = await supabase\r\n            .from('employees')\r\n            .delete()\r\n            .in('id', employeeIds);\r\n          \r\n          if (deleteError) throw deleteError;\r\n          \r\n          if (progressCallback) progressCallback(`Eliminados ${employeesToRemove} empleados de ${company.name}`);\r\n        }\r\n      }\r\n      \r\n      if (progressCallback) progressCallback('Proceso completado - todas las empresas tienen 50 empleados');\r\n      return { success: true };\r\n    } catch (error) {\r\n      console.error('Error asegurando 50 empleados por empresa:', error);\r\n      return { success: false, error: error.message };\r\n    }\r\n  }\r\n\r\n  // Limpiar todos los empleados (solo para desarrollo)\r\n  async clearAllEmployees(confirmationToken = null) {\r\n    try {\r\n      // Validaci√≥n de seguridad para operaci√≥n destructiva\r\n      const expectedToken = 'CLEAR_ALL_EMPLOYEES_CONFIRMED';\r\n      if (confirmationToken !== expectedToken) {\r\n        throw new Error('Operaci√≥n de limpieza requiere confirmaci√≥n expl√≠cita. Use el token: ' + expectedToken);\r\n      }\r\n      \r\n      console.log('Limpiando todos los empleados...');\r\n      \r\n      // Verificar cu√°ntos empleados se van a eliminar\r\n      const { count: totalEmployees, error: countError } = await supabase\r\n        .from('employees')\r\n        .select('*', { count: 'exact', head: true });\r\n      \r\n      if (countError) throw countError;\r\n      \r\n      if (totalEmployees === 0) {\r\n        console.log('No hay empleados para eliminar');\r\n        return { success: true, deletedCount: 0 };\r\n      }\r\n      \r\n      console.warn(`ADVERTENCIA: Se eliminar√°n ${totalEmployees} empleados`);\r\n      \r\n      // Realizar la eliminaci√≥n en lotes para mejor control\r\n      const batchSize = 100;\r\n      let deletedCount = 0;\r\n      \r\n      for (let i = 0; i < totalEmployees; i += batchSize) {\r\n        const { error } = await supabase\r\n          .from('employees')\r\n          .delete()\r\n          .limit(batchSize);\r\n        \r\n        if (error) throw error;\r\n        deletedCount += Math.min(batchSize, totalEmployees - i);\r\n      }\r\n      \r\n      console.log(`${deletedCount} empleados eliminados`);\r\n      return { success: true, deletedCount };\r\n    } catch (error) {\r\n      console.error('Error limpiando empleados:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Nuevo m√©todo para validar la integridad de los datos\r\n  async validateDataIntegrity() {\r\n    try {\r\n      console.log('Validando integridad de datos de empleados...');\r\n      \r\n      // Verificar empleados sin empresa v√°lida\r\n      const { data: orphanEmployees, error: orphanError } = await supabase\r\n        .from('employees')\r\n        .select('id, name, email, company_id')\r\n        .is('company_id', null);\r\n      \r\n      if (orphanError) throw orphanError;\r\n      \r\n      if (orphanEmployees && orphanEmployees.length > 0) {\r\n        console.warn(`Se encontraron ${orphanEmployees.length} empleados sin empresa asignada`);\r\n      }\r\n      \r\n      // Verificar emails duplicados\r\n      const { data: duplicateEmails, error: duplicateError } = await supabase\r\n        .from('employees')\r\n        .select('email, company_id')\r\n        .group('email, company_id')\r\n        .having('count(*) > 1');\r\n      \r\n      if (duplicateError) throw duplicateError;\r\n      \r\n      if (duplicateEmails && duplicateEmails.length > 0) {\r\n        console.warn(`Se encontraron ${duplicateEmails.length} emails duplicados`);\r\n      }\r\n      \r\n      // Verificar datos inv√°lidos\r\n      const { data: invalidEmployees, error: invalidError } = await supabase\r\n        .from('employees')\r\n        .select('id, name, email')\r\n        .or('name.is.null,name.eq.,email.is.null,email.eq.');\r\n      \r\n      if (invalidError) throw invalidError;\r\n      \r\n      if (invalidEmployees && invalidEmployees.length > 0) {\r\n        console.warn(`Se encontraron ${invalidEmployees.length} empleados con datos inv√°lidos`);\r\n      }\r\n      \r\n      return {\r\n        orphanEmployees: orphanEmployees?.length || 0,\r\n        duplicateEmails: duplicateEmails?.length || 0,\r\n        invalidEmployees: invalidEmployees?.length || 0,\r\n        isValid: (orphanEmployees?.length || 0) === 0 &&\r\n                (duplicateEmails?.length || 0) === 0 &&\r\n                (invalidEmployees?.length || 0) === 0\r\n      };\r\n    } catch (error) {\r\n      console.error('Error validando integridad de datos:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n\r\nexport default new EmployeeDataService();","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\employeeFolderService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\enhancedCommunicationService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'organizedDatabaseService' is defined but never used.","line":4,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":32},{"ruleId":"no-unused-vars","severity":1,"message":"'commonLevels' is assigned a value but never used.","line":310,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":310,"endColumn":25},{"ruleId":"no-unused-vars","severity":1,"message":"'userPrefs' is assigned a value but never used.","line":527,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":527,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from '../lib/supabase.js';\r\nimport communicationService from './communicationService.js';\r\nimport groqService from './groqService.js';\r\nimport organizedDatabaseService from './organizedDatabaseService.js';\r\nimport gamificationService from './gamificationService.js';\r\n\r\n/**\r\n * Servicio de comunicaci√≥n mejorado que integra IA y an√°lisis predictivo\r\n * Implementaci√≥n de la Fase 1 del roadmap de mejoras\r\n */\r\nclass EnhancedCommunicationService {\r\n  constructor() {\r\n    this.conversationHistory = new Map(); // Memoria conversacional persistente\r\n    this.userPreferences = new Map(); // Preferencias por usuario\r\n    this.engagementPredictor = new EngagementPredictor();\r\n    this.notificationOptimizer = new NotificationOptimizer();\r\n  }\r\n\r\n  /**\r\n   * Env√≠a mensaje de WhatsApp con an√°lisis predictivo y optimizaci√≥n\r\n   */\r\n  async sendWhatsAppMessage(recipientIds, message, options = {}) {\r\n    try {\r\n      console.log('üöÄ Enviando mensaje WhatsApp mejorado con IA');\r\n      \r\n      // An√°lisis predictivo de engagement\r\n      const engagementPrediction = await this.engagementPredictor.predict(\r\n        recipientIds, \r\n        message, \r\n        'whatsapp'\r\n      );\r\n      \r\n      // Optimizaci√≥n del mensaje basada en IA\r\n      const optimizedMessage = await this.optimizeMessage(message, {\r\n        channel: 'whatsapp',\r\n        recipients: recipientIds,\r\n        engagementPrediction,\r\n        ...options\r\n      });\r\n      \r\n      // Determinar el mejor momento para enviar\r\n      const optimalTiming = await this.notificationOptimizer.getOptimalTiming(\r\n        recipientIds,\r\n        'whatsapp'\r\n      );\r\n      \r\n      // Enviar mensaje usando el servicio base\r\n      const result = await communicationService.sendWhatsAppMessage(\r\n        recipientIds,\r\n        optimizedMessage.content\r\n      );\r\n      \r\n      // Guardar an√°lisis para aprendizaje futuro\r\n      await this.saveMessageAnalysis({\r\n        ...result,\r\n        originalMessage: message,\r\n        optimizedMessage: optimizedMessage.content,\r\n        engagementPrediction,\r\n        optimalTiming,\r\n        channel: 'whatsapp'\r\n      });\r\n      \r\n      // Otorgar puntos por actividad de gamificaci√≥n\r\n      if (result.success && result.messageId) {\r\n        try {\r\n          // Para cada destinatario, otorgar puntos por env√≠o de mensaje\r\n          for (const recipientId of recipientIds) {\r\n            await gamificationService.awardPoints(\r\n              result.userId || 'system',\r\n              recipientId,\r\n              'message_sent',\r\n              result.messageId,\r\n              `Mensaje WhatsApp enviado: ${optimizedMessage.content.substring(0, 50)}...`,\r\n              {\r\n                channel: 'whatsapp',\r\n                engagementScore: engagementPrediction.score,\r\n                optimized: optimizedMessage.applied.length > 0\r\n              }\r\n            );\r\n          }\r\n        } catch (gamificationError) {\r\n          console.warn('‚ö†Ô∏è Error en gamificaci√≥n (no cr√≠tico):', gamificationError);\r\n        }\r\n      }\r\n      \r\n      return {\r\n        ...result,\r\n        engagementPrediction,\r\n        optimalTiming,\r\n        optimizations: optimizedMessage.applied\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Error en mensaje WhatsApp mejorado:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Env√≠a mensaje de Telegram con an√°lisis predictivo y optimizaci√≥n\r\n   */\r\n  async sendTelegramMessage(recipientIds, message, options = {}) {\r\n    try {\r\n      console.log('üöÄ Enviando mensaje Telegram mejorado con IA');\r\n      \r\n      // An√°lisis predictivo de engagement\r\n      const engagementPrediction = await this.engagementPredictor.predict(\r\n        recipientIds, \r\n        message, \r\n        'telegram'\r\n      );\r\n      \r\n      // Optimizaci√≥n del mensaje basada en IA\r\n      const optimizedMessage = await this.optimizeMessage(message, {\r\n        channel: 'telegram',\r\n        recipients: recipientIds,\r\n        engagementPrediction,\r\n        ...options\r\n      });\r\n      \r\n      // Determinar el mejor momento para enviar\r\n      const optimalTiming = await this.notificationOptimizer.getOptimalTiming(\r\n        recipientIds,\r\n        'telegram'\r\n      );\r\n      \r\n      // Enviar mensaje usando el servicio base\r\n      const result = await communicationService.sendTelegramMessage(\r\n        recipientIds,\r\n        optimizedMessage.content\r\n      );\r\n      \r\n      // Guardar an√°lisis para aprendizaje futuro\r\n      await this.saveMessageAnalysis({\r\n        ...result,\r\n        originalMessage: message,\r\n        optimizedMessage: optimizedMessage.content,\r\n        engagementPrediction,\r\n        optimalTiming,\r\n        channel: 'telegram'\r\n      });\r\n      \r\n      // Otorgar puntos por actividad de gamificaci√≥n\r\n      if (result.success && result.messageId) {\r\n        try {\r\n          // Para cada destinatario, otorgar puntos por env√≠o de mensaje\r\n          for (const recipientId of recipientIds) {\r\n            await gamificationService.awardPoints(\r\n              result.userId || 'system',\r\n              recipientId,\r\n              'message_sent',\r\n              result.messageId,\r\n              `Mensaje Telegram enviado: ${optimizedMessage.content.substring(0, 50)}...`,\r\n              {\r\n                channel: 'telegram',\r\n                engagementScore: engagementPrediction.score,\r\n                optimized: optimizedMessage.applied.length > 0\r\n              }\r\n            );\r\n          }\r\n        } catch (gamificationError) {\r\n          console.warn('‚ö†Ô∏è Error en gamificaci√≥n (no cr√≠tico):', gamificationError);\r\n        }\r\n      }\r\n      \r\n      return {\r\n        ...result,\r\n        engagementPrediction,\r\n        optimalTiming,\r\n        optimizations: optimizedMessage.applied\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Error en mensaje Telegram mejorado:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Optimiza el contenido del mensaje usando IA\r\n   */\r\n  async optimizeMessage(message, options) {\r\n    try {\r\n      const { channel, recipients, engagementPrediction } = options;\r\n      \r\n      // An√°lisis de sentimiento del mensaje original\r\n      const sentimentAnalysis = await groqService.analyzeSentiment(message);\r\n      \r\n      // Generar optimizaciones basadas en el canal y predicci√≥n\r\n      let optimizedContent = message;\r\n      const applied = [];\r\n      \r\n      // Optimizaci√≥n de longitud seg√∫n canal\r\n      if (channel === 'twitter' && message.length > 280) {\r\n        optimizedContent = message.substring(0, 277) + '...';\r\n        applied.push('length_optimization');\r\n      }\r\n      \r\n      // Optimizaci√≥n de tono seg√∫n sentimiento\r\n      if (sentimentAnalysis.label === 'negative' && engagementPrediction.score < 0.5) {\r\n        const toneOptimization = await this.improveMessageTone(message, sentimentAnalysis);\r\n        optimizedContent = toneOptimization.content;\r\n        applied.push('tone_optimization');\r\n      }\r\n      \r\n      // Optimizaci√≥n de claridad si el engagement predicho es bajo\r\n      if (engagementPrediction.score < 0.3) {\r\n        const clarityOptimization = await this.improveMessageClarity(message);\r\n        optimizedContent = clarityOptimization.content;\r\n        applied.push('clarity_optimization');\r\n      }\r\n      \r\n      // Personalizaci√≥n seg√∫n destinatarios\r\n      if (recipients && recipients.length > 0) {\r\n        const personalization = await this.personalizeMessage(optimizedContent, recipients);\r\n        optimizedContent = personalization.content;\r\n        if (personalization.applied) {\r\n          applied.push('personalization');\r\n        }\r\n      }\r\n      \r\n      return {\r\n        content: optimizedContent,\r\n        applied,\r\n        sentimentAnalysis,\r\n        originalLength: message.length,\r\n        optimizedLength: optimizedContent.length\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Error optimizando mensaje:', error);\r\n      return {\r\n        content: message,\r\n        applied: [],\r\n        error: error.message\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Mejora el tono del mensaje usando IA\r\n   */\r\n  async improveMessageTone(message, sentimentAnalysis) {\r\n    try {\r\n      const prompt = `Mejora el tono del siguiente mensaje para que sea m√°s positivo y constructivo, manteniendo el significado original:\r\n\r\nMensaje original: \"${message}\"\r\nAn√°lisis de sentimiento actual: ${sentimentAnalysis.label} (confianza: ${sentimentAnalysis.confidence})\r\n\r\nProporciona solo el mensaje mejorado, sin explicaciones adicionales.`;\r\n\r\n      const response = await groqService.generateChatResponse(prompt);\r\n      \r\n      return {\r\n        content: response.response.trim(),\r\n        applied: true\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Error mejorando tono:', error);\r\n      return {\r\n        content: message,\r\n        applied: false\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Mejora la claridad del mensaje usando IA\r\n   */\r\n  async improveMessageClarity(message) {\r\n    try {\r\n      const prompt = `Reescribe el siguiente mensaje para que sea m√°s claro, conciso y f√°cil de entender, manteniendo el significado original:\r\n\r\nMensaje original: \"${message}\"\r\n\r\nProporciona solo el mensaje mejorado, sin explicaciones adicionales.`;\r\n\r\n      const response = await groqService.generateChatResponse(prompt);\r\n      \r\n      return {\r\n        content: response.response.trim(),\r\n        applied: true\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Error mejorando claridad:', error);\r\n      return {\r\n        content: message,\r\n        applied: false\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Personaliza el mensaje seg√∫n los destinatarios\r\n   */\r\n  async personalizeMessage(message, recipientIds) {\r\n    try {\r\n      // Obtener informaci√≥n de los destinatarios\r\n      const recipients = await communicationService.getEmployees({\r\n        limit: 100\r\n      });\r\n      \r\n      const targetRecipients = recipients.filter(emp => \r\n        recipientIds.includes(emp.id)\r\n      );\r\n      \r\n      if (targetRecipients.length === 0) {\r\n        return { content: message, applied: false };\r\n      }\r\n      \r\n      // Analizar caracter√≠sticas comunes de los destinatarios\r\n      const commonDepartments = [...new Set(targetRecipients.map(r => r.department))];\r\n      const commonLevels = [...new Set(targetRecipients.map(r => r.level))];\r\n      \r\n      // Si hay un departamento dominante, personalizar para ese grupo\r\n      if (commonDepartments.length === 1 && commonDepartments[0]) {\r\n        const deptPersonalization = await this.personalizeForDepartment(\r\n          message, \r\n          commonDepartments[0]\r\n        );\r\n        \r\n        if (deptPersonalization.applied) {\r\n          return {\r\n            content: deptPersonalization.content,\r\n            applied: true,\r\n            type: 'department'\r\n          };\r\n        }\r\n      }\r\n      \r\n      return { content: message, applied: false };\r\n    } catch (error) {\r\n      console.error('‚ùå Error personalizando mensaje:', error);\r\n      return { content: message, applied: false };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Personaliza mensaje para un departamento espec√≠fico\r\n   */\r\n  async personalizeForDepartment(message, department) {\r\n    try {\r\n      const departmentContexts = {\r\n        'Tecnolog√≠a': 'enfocado en innovaci√≥n, desarrollo t√©cnico y soluciones digitales',\r\n        'Ventas': 'orientado a resultados, metas y crecimiento comercial',\r\n        'Recursos Humanos': 'centrado en personas, cultura organizacional y desarrollo profesional',\r\n        'Marketing': 'enfocado en creatividad, alcance de mercado y comunicaci√≥n efectiva',\r\n        'Finanzas': 'orientado a datos, precisi√≥n y control financiero'\r\n      };\r\n      \r\n      const context = departmentContexts[department] || 'general';\r\n      \r\n      const prompt = `Adapta el siguiente mensaje para un departamento de ${department} (${context}):\r\n\r\nMensaje original: \"${message}\"\r\n\r\nProporciona solo el mensaje adaptado, sin explicaciones adicionales.`;\r\n\r\n      const response = await groqService.generateChatResponse(prompt);\r\n      \r\n      return {\r\n        content: response.response.trim(),\r\n        applied: true\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Error personalizando para departamento:', error);\r\n      return { content: message, applied: false };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Guarda an√°lisis del mensaje para aprendizaje continuo\r\n   */\r\n  async saveMessageAnalysis(analysis) {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('message_analysis')\r\n        .insert({\r\n          original_message: analysis.originalMessage,\r\n          optimized_message: analysis.optimizedMessage,\r\n          channel: analysis.channel,\r\n          engagement_prediction: analysis.engagementPrediction,\r\n          optimal_timing: analysis.optimalTiming,\r\n          optimizations: analysis.optimizations,\r\n          created_at: new Date().toISOString()\r\n        })\r\n        .select('id')\r\n        .single();\r\n      \r\n      if (error) {\r\n        console.warn('‚ö†Ô∏è Error guardando an√°lisis:', error);\r\n        return null;\r\n      }\r\n      \r\n      return data.id;\r\n    } catch (error) {\r\n      console.error('‚ùå Error cr√≠tico guardando an√°lisis:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene estad√≠sticas de comunicaci√≥n mejoradas con IA\r\n   */\r\n  async getEnhancedCommunicationStats() {\r\n    try {\r\n      // Obtener estad√≠sticas base\r\n      const baseStats = await communicationService.getCommunicationStats();\r\n      \r\n      // Obtener an√°lisis de mensajes recientes\r\n      const { data: analyses, error } = await supabase\r\n        .from('message_analysis')\r\n        .select('*')\r\n        .order('created_at', { ascending: false })\r\n        .limit(100);\r\n      \r\n      if (error) {\r\n        console.warn('‚ö†Ô∏è Error obteniendo an√°lisis:', error);\r\n        return baseStats;\r\n      }\r\n      \r\n      // Analizar patrones de optimizaci√≥n\r\n      const optimizationStats = this.analyzeOptimizationPatterns(analyses || []);\r\n      \r\n      // Predecir tendencias futuras\r\n      const trends = await this.predictCommunicationTrends(analyses || []);\r\n      \r\n      return {\r\n        ...baseStats,\r\n        aiEnhancements: {\r\n          totalOptimizations: optimizationStats.total,\r\n          averageImprovement: optimizationStats.averageImprovement,\r\n          mostEffectiveOptimizations: optimizationStats.mostEffective,\r\n          trends,\r\n          lastUpdated: new Date().toISOString()\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Error obteniendo estad√≠sticas mejoradas:', error);\r\n      return communicationService.getCommunicationStats();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Analiza patrones de optimizaci√≥n\r\n   */\r\n  analyzeOptimizationPatterns(analyses) {\r\n    const patterns = {\r\n      total: analyses.length,\r\n      optimizations: {},\r\n      effectiveness: {}\r\n    };\r\n    \r\n    analyses.forEach(analysis => {\r\n      if (analysis.optimizations && Array.isArray(analysis.optimizations)) {\r\n        analysis.optimizations.forEach(opt => {\r\n          patterns.optimizations[opt] = (patterns.optimizations[opt] || 0) + 1;\r\n        });\r\n      }\r\n    });\r\n    \r\n    // Calcular efectividad (simulada para demostraci√≥n)\r\n    Object.keys(patterns.optimizations).forEach(opt => {\r\n      patterns.effectiveness[opt] = Math.random() * 0.5 + 0.5; // 50-100%\r\n    });\r\n    \r\n    return {\r\n      total: patterns.total,\r\n      averageImprovement: 0.35, // 35% mejora promedio\r\n      mostEffective: Object.keys(patterns.effectiveness)\r\n        .sort((a, b) => patterns.effectiveness[b] - patterns.effectiveness[a])\r\n        .slice(0, 3)\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Predice tendencias de comunicaci√≥n\r\n   */\r\n  async predictCommunicationTrends(analyses) {\r\n    try {\r\n      const recentAnalyses = analyses.slice(-30); // √öltimos 30 an√°lisis\r\n      \r\n      if (recentAnalyses.length < 10) {\r\n        return {\r\n          engagementTrend: 'insufficient_data',\r\n          recommendedActions: [\r\n            'Continuar recopilando datos para predicciones m√°s precisas',\r\n            'Implementar an√°lisis A/B testing para validar optimizaciones'\r\n          ]\r\n        };\r\n      }\r\n      \r\n      // Simular an√°lisis de tendencias\r\n      const engagementScores = recentAnalyses.map(a => \r\n        a.engagement_prediction?.score || 0.5\r\n      );\r\n      \r\n      const averageEngagement = engagementScores.reduce((a, b) => a + b, 0) / engagementScores.length;\r\n      const trend = averageEngagement > 0.6 ? 'increasing' : 'stable';\r\n      \r\n      return {\r\n        engagementTrend: trend,\r\n        averageEngagement,\r\n        recommendedActions: [\r\n          trend === 'increasing' \r\n            ? 'Mantener estrategia actual de optimizaci√≥n'\r\n            : 'Considerar ajustar enfoque de personalizaci√≥n',\r\n          'Expandir uso de an√°lisis de sentimiento en todos los mensajes',\r\n          'Implementar horarios √≥ptimos basados en datos hist√≥ricos'\r\n        ]\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Error prediciendo tendencias:', error);\r\n      return {\r\n        engagementTrend: 'unknown',\r\n        recommendedActions: ['Reiniciar an√°lisis de tendencias']\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Chatbot inteligente integrado con memoria persistente\r\n   */\r\n  async getChatbotResponse(userMessage, userId, context = {}) {\r\n    try {\r\n      // Obtener historial conversacional del usuario\r\n      const userHistory = this.conversationHistory.get(userId) || [];\r\n      \r\n      // Obtener preferencias del usuario\r\n      const userPrefs = this.userPreferences.get(userId) || {};\r\n      \r\n      // Analizar sentimiento del mensaje\r\n      const sentimentAnalysis = await groqService.analyzeSentiment(userMessage);\r\n      \r\n      // Generar respuesta usando GROQ con contexto completo\r\n      const response = await groqService.generateChatResponse(\r\n        userMessage,\r\n        context.documents || [],\r\n        userHistory,\r\n        userId\r\n      );\r\n      \r\n      // Actualizar historial conversacional\r\n      const newHistory = [\r\n        ...userHistory.slice(-10), // Mantener √∫ltimas 10 interacciones\r\n        { role: 'user', content: userMessage, timestamp: new Date() },\r\n        { role: 'assistant', content: response.response, timestamp: new Date() }\r\n      ];\r\n      \r\n      this.conversationHistory.set(userId, newHistory);\r\n      \r\n      // Actualizar preferencias basadas en la interacci√≥n\r\n      this.updateUserPreferences(userId, {\r\n        lastInteraction: new Date(),\r\n        sentiment: sentimentAnalysis.label,\r\n        topic: this.extractTopic(userMessage),\r\n        responseLength: response.response.length\r\n      });\r\n      \r\n      // Otorgar puntos por interacci√≥n con chatbot\r\n      try {\r\n        await gamificationService.awardPoints(\r\n          userId,\r\n          userId, // Para el chatbot, user y employee son el mismo\r\n          'message_read', // Usamos message_read como interacci√≥n\r\n          null,\r\n          `Interacci√≥n con chatbot IA: ${userMessage.substring(0, 50)}...`,\r\n          {\r\n            channel: 'chatbot',\r\n            sentiment: sentimentAnalysis.label,\r\n            topic: this.extractTopic(userMessage),\r\n            responseLength: response.response.length,\r\n            contextUsed: response.contextUsed\r\n          }\r\n        );\r\n      } catch (gamificationError) {\r\n        console.warn('‚ö†Ô∏è Error en gamificaci√≥n chatbot (no cr√≠tico):', gamificationError);\r\n      }\r\n      \r\n      return {\r\n        response: response.response,\r\n        sentimentAnalysis,\r\n        contextUsed: response.contextUsed,\r\n        historyLength: newHistory.length,\r\n        personalized: true\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Error en chatbot mejorado:', error);\r\n      return {\r\n        response: 'Lo siento, tuve un problema procesando tu mensaje. ¬øPodr√≠as intentarlo de nuevo?',\r\n        error: error.message,\r\n        personalized: false\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Extrae el tema principal de un mensaje\r\n   */\r\n  extractTopic(message) {\r\n    const topics = {\r\n      'beneficios': /beneficio|vacaci√≥n|salario|compensaci√≥n/i,\r\n      'proyectos': /proyecto|avance|entrega|deadline/i,\r\n      'capacitaci√≥n': /capacitaci√≥n|entrenamiento|curso|aprendizaje/i,\r\n      'pol√≠ticas': /pol√≠tica|regla|norma|procedimiento/i,\r\n      'reuniones': /reuni√≥n|cita|agenda|minuta/i,\r\n      'general': /hola|buenos d√≠as|gracias|saludos/i\r\n    };\r\n    \r\n    for (const [topic, regex] of Object.entries(topics)) {\r\n      if (regex.test(message)) {\r\n        return topic;\r\n      }\r\n    }\r\n    \r\n    return 'otro';\r\n  }\r\n\r\n  /**\r\n   * Actualiza preferencias del usuario\r\n   */\r\n  updateUserPreferences(userId, preferences) {\r\n    const currentPrefs = this.userPreferences.get(userId) || {};\r\n    this.userPreferences.set(userId, {\r\n      ...currentPrefs,\r\n      ...preferences\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Obtiene insights predictivos para la empresa\r\n   */\r\n  async getPredictiveInsights(companyId) {\r\n    try {\r\n      // Obtener datos de comunicaci√≥n reciente\r\n      const { data: logs, error } = await supabase\r\n        .from('communication_logs')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .order('created_at', { ascending: false })\r\n        .limit(200);\r\n      \r\n      if (error || !logs || logs.length === 0) {\r\n        return this.getFallbackInsights();\r\n      }\r\n      \r\n      // Analizar patrones con IA\r\n      const insights = await this.analyzeCommunicationPatterns(logs);\r\n      \r\n      return {\r\n        predictive: true,\r\n        insights,\r\n        confidence: 0.85,\r\n        generatedAt: new Date().toISOString()\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Error obteniendo insights predictivos:', error);\r\n      return this.getFallbackInsights();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Analiza patrones de comunicaci√≥n usando IA\r\n   */\r\n  async analyzeCommunicationPatterns(logs) {\r\n    try {\r\n      // Preparar datos para an√°lisis\r\n      const communicationData = logs.map(log => ({\r\n        channel: log.channel_id,\r\n        status: log.status,\r\n        timestamp: log.created_at,\r\n        messageLength: log.message?.length || 0\r\n      }));\r\n      \r\n      // Generar insights usando GROQ\r\n      const prompt = `Analiza los siguientes datos de comunicaci√≥n empresarial y genera 5 insights clave:\r\n\r\n${JSON.stringify(communicationData.slice(0, 50), null, 2)}\r\n\r\nGenera insights sobre:\r\n1. Patrones de uso por canal\r\n2. Tendencias temporales\r\n3. Efectividad de comunicaci√≥n\r\n4. √Åreas de mejora\r\n5. Recomendaciones espec√≠ficas\r\n\r\nResponde en formato JSON con estructura: {insights: [{tipo, descripcion, impacto}]}`;\r\n\r\n      const response = await groqService.generateChatResponse(prompt);\r\n      \r\n      try {\r\n        return JSON.parse(response.response);\r\n      } catch (parseError) {\r\n        // Si no puede parsear, generar insights b√°sicos\r\n        return this.generateBasicInsights(logs);\r\n      }\r\n    } catch (error) {\r\n      console.error('‚ùå Error analizando patrones:', error);\r\n      return this.generateBasicInsights(logs);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Genera insights b√°sicos cuando falla el an√°lisis avanzado\r\n   */\r\n  generateBasicInsights(logs) {\r\n    const channelStats = {};\r\n    const statusStats = {};\r\n    \r\n    logs.forEach(log => {\r\n      channelStats[log.channel_id] = (channelStats[log.channel_id] || 0) + 1;\r\n      statusStats[log.status] = (statusStats[log.status] || 0) + 1;\r\n    });\r\n    \r\n    return {\r\n      insights: [\r\n        {\r\n          tipo: 'uso_canales',\r\n          descripcion: `WhatsApp es el canal m√°s utilizado con ${channelStats.whatsapp || 0} mensajes`,\r\n          impacto: 'alto'\r\n        },\r\n        {\r\n          tipo: 'efectividad',\r\n          descripcion: `Tasa de entrega: ${((statusStats.delivered || 0) / logs.length * 100).toFixed(1)}%`,\r\n          impacto: 'medio'\r\n        },\r\n        {\r\n          tipo: 'recomendacion',\r\n          descripcion: 'Considerar aumentar el uso de canales con mayor engagement',\r\n          impacto: 'alto'\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Insights de respaldo cuando no hay datos suficientes\r\n   */\r\n  getFallbackInsights() {\r\n    return {\r\n      predictive: false,\r\n      insights: [\r\n        {\r\n          tipo: 'datos_insuficientes',\r\n          descripcion: 'Se necesitan m√°s datos de comunicaci√≥n para generar insights predictivos',\r\n          impacto: 'medio'\r\n        }\r\n      ],\r\n      confidence: 0.3,\r\n      generatedAt: new Date().toISOString()\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Clase para predicci√≥n de engagement\r\n */\r\nclass EngagementPredictor {\r\n  async predict(recipientIds, message, channel) {\r\n    try {\r\n      // Factores que influyen en el engagement\r\n      const factors = {\r\n        messageLength: this.calculateMessageLengthScore(message),\r\n        timeOfDay: this.getTimeOfDayScore(),\r\n        channel: this.getChannelScore(channel),\r\n        recipientCount: this.getRecipientCountScore(recipientIds.length)\r\n      };\r\n      \r\n      // Calcular score predictivo (0-1)\r\n      const baseScore = Object.values(factors).reduce((a, b) => a + b, 0) / Object.keys(factors).length;\r\n      \r\n      // Ajustar seg√∫n caracter√≠sticas del mensaje\r\n      const sentimentScore = await this.analyzeMessageSentiment(message);\r\n      const finalScore = Math.min(1, Math.max(0, baseScore + sentimentScore * 0.2));\r\n      \r\n      return {\r\n        score: finalScore,\r\n        confidence: 0.75,\r\n        factors,\r\n        prediction: finalScore > 0.6 ? 'high' : finalScore > 0.3 ? 'medium' : 'low',\r\n        recommendations: this.getRecommendations(finalScore, factors)\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Error prediciendo engagement:', error);\r\n      return {\r\n        score: 0.5,\r\n        confidence: 0.3,\r\n        prediction: 'medium',\r\n        error: error.message\r\n      };\r\n    }\r\n  }\r\n\r\n  calculateMessageLengthScore(message) {\r\n    const length = message.length;\r\n    if (length < 50) return 0.3; // Muy corto\r\n    if (length < 150) return 0.8; // √ìptimo\r\n    if (length < 300) return 0.6; // Largo pero OK\r\n    return 0.4; // Muy largo\r\n  }\r\n\r\n  getTimeOfDayScore() {\r\n    const hour = new Date().getHours();\r\n    if (hour >= 9 && hour <= 11) return 0.9; // Horario √≥ptimo ma√±ana\r\n    if (hour >= 14 && hour <= 16) return 0.8; // Horario √≥ptimo tarde\r\n    if (hour >= 18 && hour <= 20) return 0.6; // Horario aceptable\r\n    return 0.3; // Horario no √≥ptimo\r\n  }\r\n\r\n  getChannelScore(channel) {\r\n    const scores = {\r\n      'whatsapp': 0.8,\r\n      'telegram': 0.7,\r\n      'email': 0.5,\r\n      'teams': 0.6\r\n    };\r\n    return scores[channel] || 0.5;\r\n  }\r\n\r\n  getRecipientCountScore(count) {\r\n    if (count === 1) return 0.9; // Personalizado\r\n    if (count <= 5) return 0.8; // Grupo peque√±o\r\n    if (count <= 20) return 0.6; // Grupo mediano\r\n    return 0.4; // Grupo grande\r\n  }\r\n\r\n  async analyzeMessageSentiment(message) {\r\n    try {\r\n      const analysis = await groqService.analyzeSentiment(message);\r\n      return analysis.score; // -1 a 1\r\n    } catch (error) {\r\n      return 0; // Neutral si hay error\r\n    }\r\n  }\r\n\r\n  getRecommendations(score, factors) {\r\n    const recommendations = [];\r\n    \r\n    if (score < 0.4) {\r\n      recommendations.push('Considerar acortar el mensaje');\r\n      recommendations.push('Enviar en horario de mayor actividad');\r\n    }\r\n    \r\n    if (factors.messageLength < 0.5) {\r\n      recommendations.push('El mensaje es muy corto, considerar agregar m√°s contexto');\r\n    }\r\n    \r\n    if (factors.timeOfDay < 0.5) {\r\n      recommendations.push('Programar para un horario m√°s √≥ptimo');\r\n    }\r\n    \r\n    return recommendations;\r\n  }\r\n}\r\n\r\n/**\r\n * Clase para optimizaci√≥n de notificaciones\r\n */\r\nclass NotificationOptimizer {\r\n  async getOptimalTiming(recipientIds, channel) {\r\n    try {\r\n      // Analizar patrones hist√≥ricos de comunicaci√≥n\r\n      const patterns = await this.analyzeHistoricalPatterns(recipientIds, channel);\r\n      \r\n      // Determinar mejores horarios basados en patrones\r\n      const optimalSlots = this.calculateOptimalSlots(patterns);\r\n      \r\n      return {\r\n        optimalSlots,\r\n        currentScore: this.getCurrentTimeScore(optimalSlots),\r\n        recommendations: this.getTimingRecommendations(optimalSlots),\r\n        nextOptimalTime: this.getNextOptimalTime(optimalSlots)\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Error optimizando timing:', error);\r\n      return {\r\n        optimalSlots: ['09:00', '14:00', '16:00'],\r\n        currentScore: 0.5,\r\n        recommendations: ['Usar horarios est√°ndar de oficina']\r\n      };\r\n    }\r\n  }\r\n\r\n  async analyzeHistoricalPatterns(recipientIds, channel) {\r\n    // Simular an√°lisis de patrones hist√≥ricos\r\n    // En producci√≥n, esto analizar√≠a datos reales de communication_logs\r\n    return {\r\n      morning: { start: '09:00', end: '11:00', effectiveness: 0.85 },\r\n      afternoon: { start: '14:00', end: '16:00', effectiveness: 0.75 },\r\n      evening: { start: '18:00', end: '20:00', effectiveness: 0.60 }\r\n    };\r\n  }\r\n\r\n  calculateOptimalSlots(patterns) {\r\n    const slots = [];\r\n    \r\n    Object.entries(patterns).forEach(([period, data]) => {\r\n      if (data.effectiveness > 0.7) {\r\n        slots.push(data.start);\r\n      }\r\n    });\r\n    \r\n    return slots.length > 0 ? slots : ['09:00', '14:00', '16:00'];\r\n  }\r\n\r\n  getCurrentTimeScore(optimalSlots) {\r\n    const currentTime = new Date().toTimeString().slice(0, 5);\r\n    return optimalSlots.includes(currentTime) ? 1.0 : 0.5;\r\n  }\r\n\r\n  getTimingRecommendations(optimalSlots) {\r\n    const recommendations = [];\r\n    const currentHour = new Date().getHours();\r\n    \r\n    if (currentHour < 9 || currentHour > 18) {\r\n      recommendations.push('Considerar programar para horario laboral');\r\n    }\r\n    \r\n    if (optimalSlots.length > 0) {\r\n      recommendations.push(`Mejores horarios: ${optimalSlots.join(', ')}`);\r\n    }\r\n    \r\n    return recommendations;\r\n  }\r\n\r\n  getNextOptimalTime(optimalSlots) {\r\n    const now = new Date();\r\n    const currentHour = now.getHours();\r\n    const currentMinute = now.getMinutes();\r\n    \r\n    for (const slot of optimalSlots) {\r\n      const [hour, minute] = slot.split(':').map(Number);\r\n      \r\n      if (hour > currentHour || (hour === currentHour && minute > currentMinute)) {\r\n        const nextTime = new Date();\r\n        nextTime.setHours(hour, minute, 0, 0);\r\n        return nextTime.toTimeString().slice(0, 5);\r\n      }\r\n    }\r\n    \r\n    // Si no hay horarios disponibles hoy, retornar el primero de ma√±ana\r\n    return optimalSlots[0];\r\n  }\r\n}\r\n\r\n// Crear y exportar la instancia √∫nica\r\nconst enhancedCommunicationService = new EnhancedCommunicationService();\r\nexport default enhancedCommunicationService;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\enhancedEmployeeFolderService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\externalKnowledgeService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'responseTime' is assigned a value but never used.","line":313,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":313,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Servicio de Integraci√≥n de Bases de Conocimiento Externas\r\n * \r\n * Este servicio permite integrar bases de conocimiento externas, FAQs y sistemas de IA\r\n * manteniendo el 100% de cumplimiento con las pol√≠ticas de WhatsApp Business 2024-2025.\r\n * \r\n * Caracter√≠sticas principales:\r\n * - Integraci√≥n con m√∫ltiples fuentes de conocimiento\r\n * - Validaci√≥n de contenido seg√∫n pol√≠ticas de WhatsApp\r\n * - Verificaci√≥n de consentimiento y ventana de 24 horas\r\n * - Sistema de confianza y calidad\r\n * - Escalado autom√°tico a humanos cuando es necesario\r\n * - Transparencia total con los usuarios\r\n */\r\n\r\nimport { supabase } from '../lib/supabase.js';\r\nimport whatsappComplianceService from './whatsappComplianceService.js';\r\n\r\nclass ExternalKnowledgeService {\r\n  constructor() {\r\n    this.knowledgeSources = new Map();\r\n    this.qualityThreshold = 0.8;\r\n    this.maxRetries = 2;\r\n    this.responseTimeout = 5000; // 5 segundos\r\n  }\r\n\r\n  /**\r\n   * Registrar una fuente de conocimiento externa\r\n   * @param {string} sourceId - ID √∫nico de la fuente\r\n   * @param {Object} config - Configuraci√≥n de la fuente\r\n   */\r\n  registerKnowledgeSource(sourceId, config) {\r\n    this.knowledgeSources.set(sourceId, {\r\n      id: sourceId,\r\n      type: config.type, // 'faq', 'api', 'database', 'ai', 'crm'\r\n      endpoint: config.endpoint,\r\n      priority: config.priority || 1,\r\n      enabled: config.enabled !== false,\r\n      confidence: config.confidence || 0.8,\r\n      timeout: config.timeout || this.responseTimeout,\r\n      headers: config.headers || {},\r\n      validation: config.validation || {},\r\n      requiresHuman: config.requiresHuman || false,\r\n      transparency: config.transparency || true,\r\n      ...config\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Obtener respuesta de base de conocimiento externa con cumplimiento\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {string} userPhone - Tel√©fono del usuario\r\n   * @param {string} message - Mensaje del usuario\r\n   * @param {Object} options - Opciones adicionales\r\n   * @returns {Promise<Object>} Respuesta validada\r\n   */\r\n  async getKnowledgeResponse(companyId, userPhone, message, options = {}) {\r\n    try {\r\n      console.log(`üîç Buscando respuesta en base externa para ${userPhone}`);\r\n\r\n      // 1. Verificaciones de cumplimiento CR√çTICAS\r\n      const complianceCheck = await this.validateComplianceRequirements(\r\n        companyId, \r\n        userPhone, \r\n        message\r\n      );\r\n\r\n      if (!complianceCheck.canProceed) {\r\n        throw new Error(`Bloqueado por cumplimiento: ${complianceCheck.reason}`);\r\n      }\r\n\r\n      // 2. Buscar en fuentes de conocimiento por orden de prioridad\r\n      const sortedSources = Array.from(this.knowledgeSources.values())\r\n        .filter(source => source.enabled)\r\n        .sort((a, b) => a.priority - b.priority);\r\n\r\n      let bestResponse = null;\r\n      let maxConfidence = 0;\r\n\r\n      for (const source of sortedSources) {\r\n        try {\r\n          const response = await this.queryKnowledgeSource(\r\n            source, \r\n            message, \r\n            companyId, \r\n            userPhone\r\n          );\r\n\r\n          if (response && response.confidence > maxConfidence) {\r\n            bestResponse = {\r\n              ...response,\r\n              sourceId: source.id,\r\n              sourceType: source.type,\r\n              sourceName: source.name || source.id\r\n            };\r\n            maxConfidence = response.confidence;\r\n\r\n            // Si encontramos una respuesta con alta confianza, podemos detenernos\r\n            if (maxConfidence >= this.qualityThreshold) {\r\n              break;\r\n            }\r\n          }\r\n        } catch (error) {\r\n          console.warn(`Error consultando fuente ${source.id}:`, error.message);\r\n          // Continuar con la siguiente fuente\r\n        }\r\n      }\r\n\r\n      // 3. Validar la mejor respuesta encontrada\r\n      if (!bestResponse) {\r\n        return {\r\n          success: false,\r\n          requiresHuman: true,\r\n          reason: 'No se encontr√≥ respuesta adecuada en bases de conocimiento',\r\n          suggestions: ['Escalando a agente humano']\r\n        };\r\n      }\r\n\r\n      // 4. Validaci√≥n de contenido seg√∫n pol√≠ticas de WhatsApp\r\n      const contentValidation = await whatsappComplianceService.validateMessageContent(\r\n        bestResponse.content,\r\n        bestResponse.type || 'text'\r\n      );\r\n\r\n      if (!contentValidation.valid) {\r\n        throw new Error(`Respuesta inv√°lida: ${contentValidation.reason}`);\r\n      }\r\n\r\n      // 5. Evaluar si requiere intervenci√≥n humana\r\n      const requiresHuman = await this.shouldEscalateToHuman(\r\n        bestResponse,\r\n        message,\r\n        complianceCheck\r\n      );\r\n\r\n      if (requiresHuman.required) {\r\n        return {\r\n          success: false,\r\n          requiresHuman: true,\r\n          reason: requiresHuman.reason,\r\n          suggestedResponse: bestResponse.content,\r\n          confidence: bestResponse.confidence,\r\n          source: bestResponse.sourceName\r\n        };\r\n      }\r\n\r\n      // 6. Registrar interacci√≥n y respuesta\r\n      await this.recordKnowledgeInteraction(\r\n        companyId,\r\n        userPhone,\r\n        message,\r\n        bestResponse,\r\n        complianceCheck\r\n      );\r\n\r\n      // 7. Agregar transparencia si es necesario\r\n      const finalResponse = this.addTransparencyMessage(bestResponse);\r\n\r\n      return {\r\n        success: true,\r\n        content: finalResponse.content,\r\n        confidence: bestResponse.confidence,\r\n        source: bestResponse.sourceName,\r\n        sourceType: bestResponse.sourceType,\r\n        responseTime: finalResponse.responseTime,\r\n        requiresHuman: false,\r\n        transparency: finalResponse.transparency\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error en getKnowledgeResponse:', error);\r\n      \r\n      // Registrar error de cumplimiento\r\n      await whatsappComplianceService.logComplianceEvent({\r\n        companyId,\r\n        eventType: 'knowledge_error',\r\n        details: {\r\n          error: error.message,\r\n          userPhone,\r\n          message: message.substring(0, 100)\r\n        }\r\n      });\r\n\r\n      return {\r\n        success: false,\r\n        error: error.message,\r\n        requiresHuman: true,\r\n        reason: 'Error en sistema de conocimiento'\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validar requisitos de cumplimiento antes de consultar base externa\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {string} userPhone - Tel√©fono del usuario\r\n   * @param {string} message - Mensaje del usuario\r\n   * @returns {Promise<Object>} Resultado de validaci√≥n\r\n   */\r\n  async validateComplianceRequirements(companyId, userPhone, message) {\r\n    try {\r\n      // 1. Verificar consentimiento activo\r\n      const hasConsent = await whatsappComplianceService.hasActiveConsent(\r\n        companyId,\r\n        userPhone\r\n      );\r\n\r\n      if (!hasConsent) {\r\n        return {\r\n          canProceed: false,\r\n          reason: 'No hay consentimiento activo para respuestas automatizadas'\r\n        };\r\n      }\r\n\r\n      // 2. Verificar ventana de 24 horas\r\n      const windowStatus = await whatsappComplianceService.check24HourWindow(\r\n        companyId,\r\n        userPhone\r\n      );\r\n\r\n      if (windowStatus.requiresTemplate) {\r\n        return {\r\n          canProceed: false,\r\n          reason: 'Se requiere plantilla de mensaje (fuera de ventana de 24 horas)',\r\n          requiresTemplate: true\r\n        };\r\n      }\r\n\r\n      // 3. Verificar calidad y l√≠mites\r\n      const qualityCheck = await whatsappComplianceService.checkQualityAndLimits(\r\n        companyId\r\n      );\r\n\r\n      if (!qualityCheck.success || !qualityCheck.limits.canSend) {\r\n        return {\r\n          canProceed: false,\r\n          reason: 'L√≠mites de env√≠o no disponibles por calidad del n√∫mero'\r\n        };\r\n      }\r\n\r\n      // 4. Validar mensaje de entrada\r\n      const inputValidation = await whatsappComplianceService.validateMessageContent(\r\n        message,\r\n        'text'\r\n      );\r\n\r\n      if (!inputValidation.valid) {\r\n        return {\r\n          canProceed: false,\r\n          reason: `Mensaje de entrada inv√°lido: ${inputValidation.reason}`\r\n        };\r\n      }\r\n\r\n      return {\r\n        canProceed: true,\r\n        windowStatus,\r\n        qualityCheck,\r\n        consentVerified: true\r\n      };\r\n\r\n    } catch (error) {\r\n      return {\r\n        canProceed: false,\r\n        reason: `Error en validaci√≥n de cumplimiento: ${error.message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Consultar una fuente espec√≠fica de conocimiento\r\n   * @param {Object} source - Configuraci√≥n de la fuente\r\n   * @param {string} message - Mensaje a consultar\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {string} userPhone - Tel√©fono del usuario\r\n   * @returns {Promise<Object>} Respuesta de la fuente\r\n   */\r\n  async queryKnowledgeSource(source, message, companyId, userPhone) {\r\n    const startTime = Date.now();\r\n\r\n    try {\r\n      let response;\r\n\r\n      switch (source.type) {\r\n        case 'faq':\r\n          response = await this.queryFAQ(source, message);\r\n          break;\r\n        case 'api':\r\n          response = await this.queryAPI(source, message);\r\n          break;\r\n        case 'database':\r\n          response = await this.queryDatabase(source, message, companyId);\r\n          break;\r\n        case 'ai':\r\n          response = await this.queryAI(source, message, userPhone);\r\n          break;\r\n        case 'crm':\r\n          response = await this.queryCRM(source, message, companyId, userPhone);\r\n          break;\r\n        default:\r\n          throw new Error(`Tipo de fuente no soportado: ${source.type}`);\r\n      }\r\n\r\n      const responseTime = Date.now() - startTime;\r\n\r\n      return {\r\n        ...response,\r\n        responseTime,\r\n        sourceId: source.id,\r\n        timestamp: new Date().toISOString()\r\n      };\r\n\r\n    } catch (error) {\r\n      const responseTime = Date.now() - startTime;\r\n      throw new Error(`Error consultando ${source.type}: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Consultar base de datos FAQ\r\n   * @param {Object} source - Configuraci√≥n de la fuente\r\n   * @param {string} message - Mensaje de consulta\r\n   * @returns {Promise<Object>} Respuesta FAQ\r\n   */\r\n  async queryFAQ(source, message) {\r\n    const { data, error } = await supabase\r\n      .from('faq_entries')\r\n      .select('*')\r\n      .eq('company_id', source.companyId)\r\n      .or(`question.ilike.%${message}%,answer.ilike.%${message}%,keywords.ilike.%${message}%`)\r\n      .eq('status', 'active')\r\n      .order('priority', { ascending: true })\r\n      .limit(5);\r\n\r\n    if (error) throw error;\r\n\r\n    if (!data || data.length === 0) {\r\n      return null;\r\n    }\r\n\r\n    // Encontrar la mejor coincidencia (similitud simple)\r\n    const bestMatch = data.find(item => \r\n      item.question.toLowerCase().includes(message.toLowerCase()) ||\r\n      message.toLowerCase().includes(item.question.toLowerCase())\r\n    ) || data[0];\r\n\r\n    return {\r\n      content: bestMatch.answer,\r\n      confidence: 0.9,\r\n      type: 'faq',\r\n      metadata: {\r\n        question: bestMatch.question,\r\n        category: bestMatch.category,\r\n        priority: bestMatch.priority\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Consultar API externa\r\n   * @param {Object} source - Configuraci√≥n de la fuente\r\n   * @param {string} message - Mensaje de consulta\r\n   * @returns {Promise<Object>} Respuesta de API\r\n   */\r\n  async queryAPI(source, message) {\r\n    const response = await fetch(source.endpoint, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        ...source.headers\r\n      },\r\n      body: JSON.stringify({\r\n        query: message,\r\n        timestamp: new Date().toISOString(),\r\n        source: 'whatsapp_business'\r\n      }),\r\n      signal: AbortSignal.timeout(source.timeout || this.responseTimeout)\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`API response: ${response.status} ${response.statusText}`);\r\n    }\r\n\r\n    const data = await response.json();\r\n\r\n    return {\r\n      content: data.answer || data.response || data.content,\r\n      confidence: data.confidence || source.confidence,\r\n      type: 'api_response',\r\n      metadata: {\r\n        endpoint: source.endpoint,\r\n        responseTime: data.responseTime,\r\n        requestId: data.requestId\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Consultar base de datos interna\r\n   * @param {Object} source - Configuraci√≥n de la fuente\r\n   * @param {string} message - Mensaje de consulta\r\n   * @param {number} companyId - ID de la empresa\r\n   * @returns {Promise<Object>} Respuesta de base de datos\r\n   */\r\n  async queryDatabase(source, message, companyId) {\r\n    const { data, error } = await supabase.rpc('search_knowledge_base', {\r\n      p_company_id: companyId,\r\n      p_query: message,\r\n      p_limit: 5\r\n    });\r\n\r\n    if (error) throw error;\r\n\r\n    if (!data || data.length === 0) {\r\n      return null;\r\n    }\r\n\r\n    const bestMatch = data[0];\r\n\r\n    return {\r\n      content: bestMatch.content,\r\n      confidence: bestMatch.similarity_score || 0.8,\r\n      type: 'database',\r\n      metadata: {\r\n        table: bestMatch.table_name,\r\n        id: bestMatch.record_id,\r\n        similarity: bestMatch.similarity_score\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Consultar modelo de IA\r\n   * @param {Object} source - Configuraci√≥n de la fuente\r\n   * @param {string} message - Mensaje de consulta\r\n   * @param {string} userPhone - Tel√©fono del usuario\r\n   * @returns {Promise<Object>} Respuesta de IA\r\n   */\r\n  async queryAI(source, message, userPhone) {\r\n    // Aqu√≠ se integrar√≠a con un servicio de IA como OpenAI, Claude, etc.\r\n    // Por ahora, simulamos una respuesta\r\n\r\n    const aiResponse = await this.callAIService({\r\n      prompt: message,\r\n      context: 'whatsapp_business_support',\r\n      userPhone: userPhone,\r\n      maxTokens: 150,\r\n      temperature: 0.7\r\n    });\r\n\r\n    return {\r\n      content: aiResponse.text,\r\n      confidence: aiResponse.confidence || 0.75,\r\n      type: 'ai_generated',\r\n      metadata: {\r\n        model: source.model || 'gpt-3.5-turbo',\r\n        tokens: aiResponse.tokens,\r\n        processingTime: aiResponse.processingTime\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Consultar sistema CRM\r\n   * @param {Object} source - Configuraci√≥n de la fuente\r\n   * @param {string} message - Mensaje de consulta\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {string} userPhone - Tel√©fono del usuario\r\n   * @returns {Promise<Object>} Respuesta del CRM\r\n   */\r\n  async queryCRM(source, message, companyId, userPhone) {\r\n    // Buscar informaci√≥n del cliente en el CRM\r\n    const { data: customer, error: customerError } = await supabase\r\n      .from('customers')\r\n      .select('*')\r\n      .eq('company_id', companyId)\r\n      .eq('phone', userPhone)\r\n      .single();\r\n\r\n    if (customerError && customerError.code !== 'PGRST116') {\r\n      throw customerError;\r\n    }\r\n\r\n    // Buscar historial de interacciones\r\n    const { data: history, error: historyError } = await supabase\r\n      .from('customer_interactions')\r\n      .select('*')\r\n      .eq('company_id', companyId)\r\n      .eq('customer_phone', userPhone)\r\n      .order('created_at', { ascending: false })\r\n      .limit(10);\r\n\r\n    if (historyError) throw historyError;\r\n\r\n    // Generar respuesta basada en informaci√≥n del CRM\r\n    const crmResponse = this.generateCRMResponse(message, customer, history);\r\n\r\n    return {\r\n      content: crmResponse.content,\r\n      confidence: crmResponse.confidence,\r\n      type: 'crm_data',\r\n      metadata: {\r\n        customerId: customer?.id,\r\n        hasHistory: history && history.length > 0,\r\n        lastInteraction: history?.[0]?.created_at\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Determinar si se debe escalar a humano\r\n   * @param {Object} response - Respuesta encontrada\r\n   * @param {string} originalMessage - Mensaje original\r\n   * @param {Object} complianceCheck - Verificaci√≥n de cumplimiento\r\n   * @returns {Promise<Object>} Decisi√≥n de escalado\r\n   */\r\n  async shouldEscalateToHuman(response, originalMessage, complianceCheck) {\r\n    const escalationTriggers = [\r\n      // Baja confianza en la respuesta\r\n      response.confidence < this.qualityThreshold,\r\n      \r\n      // Palabras clave que requieren intervenci√≥n humana\r\n      /humano|agente|persona|queja|emerggencia|urgente/i.test(originalMessage),\r\n      \r\n      // Fuente requiere validaci√≥n humana\r\n      response.sourceType === 'ai_generated' && response.confidence < 0.9,\r\n      \r\n      // Mensaje demasiado complejo\r\n      originalMessage.length > 200,\r\n      \r\n      // Solicitudes espec√≠ficas\r\n      /hablar con|representante|supervisor|gerente/i.test(originalMessage)\r\n    ];\r\n\r\n    const shouldEscalate = escalationTriggers.some(trigger => trigger === true);\r\n\r\n    if (shouldEscalate) {\r\n      let reason = 'Escalado a humano requerido';\r\n      \r\n      if (response.confidence < this.qualityThreshold) {\r\n        reason = `Baja confianza en respuesta (${(response.confidence * 100).toFixed(1)}%)`;\r\n      } else if (/humano|agente|persona/i.test(originalMessage)) {\r\n        reason = 'Usuario solicita expl√≠citamente hablar con humano';\r\n      } else if (/queja|emerggencia|urgente/i.test(originalMessage)) {\r\n        reason = 'Mensaje requiere atenci√≥n prioritaria';\r\n      }\r\n\r\n      return {\r\n        required: true,\r\n        reason,\r\n        suggestedResponse: response.content,\r\n        confidence: response.confidence\r\n      };\r\n    }\r\n\r\n    return {\r\n      required: false,\r\n      reason: 'Respuesta autom√°tica adecuada'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Agregar mensaje de transparencia sobre uso de IA/bases externas\r\n   * @param {Object} response - Respuesta a enviar\r\n   * @returns {Object} Respuesta con transparencia\r\n   */\r\n  addTransparencyMessage(response) {\r\n    const transparencyMessages = {\r\n      ai: 'ü§ñ *Respuesta generada por IA basada en nuestra base de conocimiento*\\n\\n',\r\n      faq: 'üìö *Respuesta de nuestra base de conocimiento*\\n\\n',\r\n      crm: 'üë§ *Informaci√≥n personalizada de tu historial*\\n\\n',\r\n      api: 'üîó *Respuesta obtenida de sistema externo*\\n\\n'\r\n    };\r\n\r\n    let transparencyText = '';\r\n    let needsTransparency = false;\r\n\r\n    // Agregar transparencia seg√∫n el tipo de fuente\r\n    if (response.sourceType === 'ai_generated' && response.confidence < 0.9) {\r\n      transparencyText = transparencyMessages.ai;\r\n      needsTransparency = true;\r\n    } else if (response.sourceType === 'faq') {\r\n      transparencyText = transparencyMessages.faq;\r\n      needsTransparency = true;\r\n    } else if (response.sourceType === 'crm_data') {\r\n      transparencyText = transparencyMessages.crm;\r\n      needsTransparency = true;\r\n    }\r\n\r\n    // Agregar opci√≥n de hablar con humano\r\n    const humanOption = '\\n\\n_Si prefieres hablar con un humano, responde \"HUMANO\"_';\r\n\r\n    return {\r\n      ...response,\r\n      content: needsTransparency \r\n        ? transparencyText + response.content + humanOption\r\n        : response.content + humanOption,\r\n      transparency: {\r\n        enabled: needsTransparency,\r\n        sourceType: response.sourceType,\r\n        confidence: response.confidence\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Registrar interacci√≥n con base de conocimiento\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {string} userPhone - Tel√©fono del usuario\r\n   * @param {string} originalMessage - Mensaje original\r\n   * @param {Object} response - Respuesta generada\r\n   * @param {Object} complianceCheck - Verificaci√≥n de cumplimiento\r\n   */\r\n  async recordKnowledgeInteraction(companyId, userPhone, originalMessage, response, complianceCheck) {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('knowledge_interactions')\r\n        .insert({\r\n          company_id: companyId,\r\n          user_phone: userPhone,\r\n          original_message: originalMessage,\r\n          response_content: response.content,\r\n          source_id: response.sourceId,\r\n          source_type: response.sourceType,\r\n          confidence: response.confidence,\r\n          response_time: response.responseTime,\r\n          requires_human: response.requiresHuman || false,\r\n          compliance_verified: complianceCheck.consentVerified,\r\n          window_verified: complianceCheck.windowStatus?.inWindow || false,\r\n          created_at: new Date().toISOString()\r\n        });\r\n\r\n      if (error) throw error;\r\n\r\n      // Tambi√©n registrar como interacci√≥n de usuario para mantener ventana activa\r\n      await whatsappComplianceService.recordUserInteraction(\r\n        companyId,\r\n        userPhone,\r\n        'knowledge_response',\r\n        {\r\n          source: response.sourceType,\r\n          confidence: response.confidence,\r\n          responseTime: response.responseTime\r\n        }\r\n      );\r\n\r\n    } catch (error) {\r\n      console.error('Error registrando interacci√≥n de conocimiento:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Simular llamada a servicio de IA (integraci√≥n real con OpenAI, Claude, etc.)\r\n   * @param {Object} params - Par√°metros para la API de IA\r\n   * @returns {Promise<Object>} Respuesta de la IA\r\n   */\r\n  async callAIService(params) {\r\n    // Aqu√≠ ir√≠a la integraci√≥n real con servicios como:\r\n    // - OpenAI GPT-4\r\n    // - Anthropic Claude\r\n    // - Google Gemini\r\n    // - Modelos locales\r\n    \r\n    // Por ahora, simulamos una respuesta\r\n    return new Promise((resolve) => {\r\n      setTimeout(() => {\r\n        resolve({\r\n          text: 'Esta es una respuesta generada por IA basada en tu consulta. Para obtener informaci√≥n m√°s espec√≠fica, te recomiendo hablar con uno de nuestros agentes.',\r\n          confidence: 0.75,\r\n          tokens: 45,\r\n          processingTime: 1200\r\n        });\r\n      }, 1000);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Generar respuesta basada en datos del CRM\r\n   * @param {string} message - Mensaje del usuario\r\n   * @param {Object} customer - Datos del cliente\r\n   * @param {Array} history - Historial de interacciones\r\n   * @returns {Object} Respuesta personalizada\r\n   */\r\n  generateCRMResponse(message, customer, history) {\r\n    if (!customer) {\r\n      return {\r\n        content: 'No encuentro tu informaci√≥n en nuestro sistema. ¬øPodr√≠as proporcionar tu n√∫mero de cliente o email?',\r\n        confidence: 0.6\r\n      };\r\n    }\r\n\r\n    // Respuestas personalizadas basadas en historial\r\n    const recentInteractions = history?.slice(0, 3) || [];\r\n    \r\n    if (recentInteractions.length > 0) {\r\n      const lastInteraction = recentInteractions[0];\r\n      return {\r\n        content: `Hola ${customer.name}. Veo que tu √∫ltima consulta fue sobre \"${lastInteraction.topic}\". ¬øEn qu√© puedo ayudarte hoy?`,\r\n        confidence: 0.9\r\n      };\r\n    }\r\n\r\n    return {\r\n      content: `Hola ${customer.name}. ¬øEn qu√© puedo ayudarte hoy?`,\r\n      confidence: 0.8\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Obtener estad√≠sticas de uso de bases de conocimiento\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {Object} filters - Filtros para las estad√≠sticas\r\n   * @returns {Promise<Object>} Estad√≠sticas de uso\r\n   */\r\n  async getKnowledgeStats(companyId, filters = {}) {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('knowledge_interactions')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .gte('created_at', filters.startDate || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString())\r\n        .lte('created_at', filters.endDate || new Date().toISOString());\r\n\r\n      if (error) throw error;\r\n\r\n      const stats = {\r\n        totalQueries: data?.length || 0,\r\n        autoResolved: data?.filter(i => !i.requires_human).length || 0,\r\n        escalatedToHuman: data?.filter(i => i.requires_human).length || 0,\r\n        averageConfidence: data?.reduce((sum, i) => sum + (i.confidence || 0), 0) / (data?.length || 1),\r\n        averageResponseTime: data?.reduce((sum, i) => sum + (i.response_time || 0), 0) / (data?.length || 1),\r\n        sourceUsage: {},\r\n        complianceRate: data?.filter(i => i.compliance_verified).length / (data?.length || 1) * 100\r\n      };\r\n\r\n      // Agrupar por tipo de fuente\r\n      data?.forEach(interaction => {\r\n        const sourceType = interaction.source_type || 'unknown';\r\n        stats.sourceUsage[sourceType] = (stats.sourceUsage[sourceType] || 0) + 1;\r\n      });\r\n\r\n      return stats;\r\n\r\n    } catch (error) {\r\n      console.error('Error obteniendo estad√≠sticas de conocimiento:', error);\r\n      return {\r\n        totalQueries: 0,\r\n        autoResolved: 0,\r\n        escalatedToHuman: 0,\r\n        averageConfidence: 0,\r\n        averageResponseTime: 0,\r\n        sourceUsage: {},\r\n        complianceRate: 0\r\n      };\r\n    }\r\n  }\r\n}\r\n\r\n// Crear instancia global del servicio\r\nconst externalKnowledgeService = new ExternalKnowledgeService();\r\n\r\n// Registrar fuentes de conocimiento por defecto\r\nexternalKnowledgeService.registerKnowledgeSource('internal_faq', {\r\n  type: 'faq',\r\n  priority: 1,\r\n  confidence: 0.9,\r\n  transparency: true\r\n});\r\n\r\nexternalKnowledgeService.registerKnowledgeSource('crm_data', {\r\n  type: 'crm',\r\n  priority: 2,\r\n  confidence: 0.85,\r\n  transparency: true\r\n});\r\n\r\nexternalKnowledgeService.registerKnowledgeSource('ai_assistant', {\r\n  type: 'ai',\r\n  priority: 3,\r\n  confidence: 0.75,\r\n  transparency: true,\r\n  requiresHuman: true\r\n});\r\n\r\nexport default externalKnowledgeService;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\fileContentExtractor.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\fileService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\gamificationService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\googleDrivePermissionsService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'createClient' is defined but never used.","line":7,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":22},{"ruleId":"import/no-anonymous-default-export","severity":1,"message":"Assign instance to a variable before exporting as module default","line":224,"column":1,"nodeType":"ExportDefaultDeclaration","endLine":224,"endColumn":51}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Google Drive Permissions Service\r\n * Gesti√≥n de permisos de Google Drive v√≠a API\r\n */\r\n\r\nimport logger from '../lib/logger.js'\r\nimport { createClient } from '@supabase/supabase-js'\r\n\r\nclass GoogleDrivePermissionsService {\r\n  constructor() {\r\n    this.supabase = null\r\n    this.currentUserId = null\r\n  }\r\n\r\n  /**\r\n   * Inicializa la conexi√≥n a Supabase\r\n   */\r\n  initializeSupabase(supabaseClient, userId) {\r\n    this.supabase = supabaseClient\r\n    this.currentUserId = userId\r\n    logger.info('GoogleDrivePermissionsService', `üîó Supabase inicializado para usuario ${userId}`)\r\n  }\r\n\r\n  /**\r\n   * Obtiene la configuraci√≥n de permisos para una empresa\r\n   */\r\n  async getCompanyPermissions(companyId) {\r\n    try {\r\n      const { data, error } = await this.supabase\r\n        .from('google_drive_permissions')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .eq('is_active', true)\r\n        .order('created_at', { ascending: false })\r\n\r\n      if (error) {\r\n        logger.error('GoogleDrivePermissionsService', 'Error obteniendo permisos:', error)\r\n        throw error\r\n      }\r\n\r\n      return data || []\r\n    } catch (error) {\r\n      logger.error('GoogleDrivePermissionsService', 'Error en getCompanyPermissions:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Guarda la configuraci√≥n de permisos para una empresa\r\n   */\r\n  async saveCompanyPermissions(companyId, permissions) {\r\n    try {\r\n      // Eliminar permisos existentes\r\n      await this.supabase\r\n        .from('google_drive_permissions')\r\n        .delete()\r\n        .eq('company_id', companyId)\r\n\r\n      // Insertar nuevos permisos\r\n      const permissionsToInsert = permissions.map(permission => ({\r\n        company_id: companyId,\r\n        employee_email: permission.employeeEmail,\r\n        permission_level: permission.permissionLevel,\r\n        folder_path: permission.folderPath || null,\r\n        is_active: true,\r\n        created_at: new Date().toISOString(),\r\n        updated_at: new Date().toISOString()\r\n      }))\r\n\r\n      const { data, error } = await this.supabase\r\n        .from('google_drive_permissions')\r\n        .insert(permissionsToInsert)\r\n        .select()\r\n\r\n      if (error) {\r\n        logger.error('GoogleDrivePermissionsService', 'Error guardando permisos:', error)\r\n        throw error\r\n      }\r\n\r\n      logger.info('GoogleDrivePermissionsService', `‚úÖ Permisos guardados para empresa ${companyId}`)\r\n      return data\r\n    } catch (error) {\r\n      logger.error('GoogleDrivePermissionsService', 'Error en saveCompanyPermissions:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Aplica permisos a Google Drive usando la API\r\n   */\r\n  async applyPermissionsToGoogleDrive(accessToken, folderId, permissions) {\r\n    try {\r\n      const results = []\r\n\r\n      for (const permission of permissions) {\r\n        try {\r\n          const response = await fetch(`https://www.googleapis.com/drive/v3/files/${folderId}/permissions`, {\r\n            method: 'POST',\r\n            headers: {\r\n              'Authorization': `Bearer ${accessToken}`,\r\n              'Content-Type': 'application/json'\r\n            },\r\n            body: JSON.stringify({\r\n              role: this.mapPermissionLevelToRole(permission.permissionLevel),\r\n              type: 'user',\r\n              emailAddress: permission.employeeEmail\r\n            })\r\n          })\r\n\r\n          if (response.ok) {\r\n            const result = await response.json()\r\n            results.push({\r\n              email: permission.employeeEmail,\r\n              success: true,\r\n              permissionId: result.id\r\n            })\r\n            logger.info('GoogleDrivePermissionsService', `‚úÖ Permiso aplicado para ${permission.employeeEmail}`)\r\n          } else {\r\n            const error = await response.json()\r\n            results.push({\r\n              email: permission.employeeEmail,\r\n              success: false,\r\n              error: error.error?.message || 'Error desconocido'\r\n            })\r\n            logger.error('GoogleDrivePermissionsService', `‚ùå Error aplicando permiso para ${permission.employeeEmail}:`, error)\r\n          }\r\n        } catch (error) {\r\n          results.push({\r\n            email: permission.employeeEmail,\r\n            success: false,\r\n            error: error.message\r\n          })\r\n          logger.error('GoogleDrivePermissionsService', `‚ùå Error en solicitud para ${permission.employeeEmail}:`, error)\r\n        }\r\n      }\r\n\r\n      return results\r\n    } catch (error) {\r\n      logger.error('GoogleDrivePermissionsService', 'Error aplicando permisos a Google Drive:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Mapea niveles de permiso a roles de Google Drive\r\n   */\r\n  mapPermissionLevelToRole(permissionLevel) {\r\n    const mapping = {\r\n      'viewer': 'reader',\r\n      'commenter': 'commenter',\r\n      'editor': 'writer',\r\n      'manager': 'owner'\r\n    }\r\n    return mapping[permissionLevel] || 'reader'\r\n  }\r\n\r\n  /**\r\n   * Obtiene plantillas predefinidas de permisos\r\n   */\r\n  getPermissionTemplates() {\r\n    return {\r\n      viewer: {\r\n        name: 'Visualizador',\r\n        description: 'Solo puede ver archivos y carpetas',\r\n        level: 'viewer'\r\n      },\r\n      commenter: {\r\n        name: 'Comentador',\r\n        description: 'Puede ver y comentar en archivos',\r\n        level: 'commenter'\r\n      },\r\n      editor: {\r\n        name: 'Editor',\r\n        description: 'Puede ver, editar y crear archivos',\r\n        level: 'editor'\r\n      },\r\n      manager: {\r\n        name: 'Administrador',\r\n        description: 'Control total sobre archivos y permisos',\r\n        level: 'manager'\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Valida configuraci√≥n de permisos\r\n   */\r\n  validatePermissions(permissions) {\r\n    const errors = []\r\n\r\n    if (!Array.isArray(permissions)) {\r\n      errors.push('Los permisos deben ser un array')\r\n      return errors\r\n    }\r\n\r\n    const validLevels = ['viewer', 'commenter', 'editor', 'manager']\r\n\r\n    permissions.forEach((permission, index) => {\r\n      if (!permission.employeeEmail || !permission.permissionLevel) {\r\n        errors.push(`Permiso ${index + 1}: Email y nivel de permiso son requeridos`)\r\n      }\r\n\r\n      if (permission.employeeEmail && !this.isValidEmail(permission.employeeEmail)) {\r\n        errors.push(`Permiso ${index + 1}: Email inv√°lido`)\r\n      }\r\n\r\n      if (permission.permissionLevel && !validLevels.includes(permission.permissionLevel)) {\r\n        errors.push(`Permiso ${index + 1}: Nivel de permiso inv√°lido`)\r\n      }\r\n    })\r\n\r\n    return errors\r\n  }\r\n\r\n  /**\r\n   * Valida formato de email\r\n   */\r\n  isValidEmail(email) {\r\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/\r\n    return emailRegex.test(email)\r\n  }\r\n}\r\n\r\nexport default new GoogleDrivePermissionsService()","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\googleDrivePersistenceService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":221,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":221,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Google Drive Persistence Service\r\n * Maneja la persistencia de credenciales de Google Drive en Supabase\r\n * Sincroniza tokens, maneja expiraci√≥n y actualizaci√≥n autom√°tica\r\n */\r\n\r\nimport supabaseDatabase from '../lib/supabaseDatabase.js';\r\n\r\nclass GoogleDrivePersistenceService {\r\n  constructor() {\r\n    this.tokenRefreshBuffer = 5 * 60 * 1000; // 5 minutos antes de expiraci√≥n\r\n    this.refreshTimers = new Map();\r\n  }\r\n\r\n  /**\r\n   * Guarda credenciales de Google Drive en Supabase\r\n   * @param {string} userId - ID del usuario\r\n   * @param {object} tokens - Tokens de OAuth (access_token, refresh_token, expires_in)\r\n   * @param {object} userInfo - Informaci√≥n del usuario (email, name, picture)\r\n   * @returns {Promise<{success: boolean, data: object, error: object}>}\r\n   */\r\n  async saveCredentials(userId, tokens, userInfo = {}) {\r\n    try {\r\n      if (!userId) {\r\n        throw new Error('userId es requerido');\r\n      }\r\n      if (!tokens || !tokens.access_token) {\r\n        throw new Error('tokens con access_token es requerido');\r\n      }\r\n\r\n      const tokenExpiresAt = new Date(Date.now() + (tokens.expires_in || 3600) * 1000);\r\n\r\n      const credentialsData = {\r\n        user_id: userId,\r\n        google_user_id: userInfo.id || null,\r\n        google_email: userInfo.email || null,\r\n        google_name: userInfo.name || null,\r\n        google_avatar_url: userInfo.picture || null,\r\n        access_token: tokens.access_token,\r\n        refresh_token: tokens.refresh_token || null,\r\n        token_expires_at: tokenExpiresAt.toISOString(),\r\n        scope: tokens.scope || 'https://www.googleapis.com/auth/drive',\r\n        is_active: true,\r\n        is_connected: true,\r\n        last_sync_at: new Date().toISOString(),\r\n        sync_status: 'success'\r\n      };\r\n\r\n      // Usar upsert para crear o actualizar\r\n      const { data, error } = await supabaseDatabase.googleDriveCredentials.upsert(credentialsData);\r\n\r\n      if (error) {\r\n        console.error('Error guardando credenciales de Google Drive:', error);\r\n        return { success: false, data: null, error };\r\n      }\r\n\r\n      console.log('Credenciales de Google Drive guardadas exitosamente');\r\n\r\n      // Configurar refresh autom√°tico de tokens\r\n      if (tokens.refresh_token) {\r\n        this.scheduleTokenRefresh(userId, tokens.expires_in || 3600);\r\n      }\r\n\r\n      return { success: true, data, error: null };\r\n    } catch (error) {\r\n      console.error('Error en saveCredentials:', error);\r\n      return { success: false, data: null, error: { message: error.message } };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene credenciales de Google Drive del usuario\r\n   * @param {string} userId - ID del usuario\r\n   * @returns {Promise<{success: boolean, data: object, error: object}>}\r\n   */\r\n  async getCredentials(userId) {\r\n    try {\r\n      if (!userId) {\r\n        throw new Error('userId es requerido');\r\n      }\r\n\r\n      const { data, error } = await supabaseDatabase.googleDriveCredentials.getByUserId(userId);\r\n\r\n      if (error) {\r\n        console.error('Error obteniendo credenciales:', error);\r\n        return { success: false, data: null, error };\r\n      }\r\n\r\n      if (!data) {\r\n        return { success: true, data: null, error: null };\r\n      }\r\n\r\n      // Verificar expiraci√≥n y reprogramar refresh si aplica\r\n      const expiresField = data.token_expires_at || data.expires_at;\r\n      let isExpired = false;\r\n      if (expiresField) {\r\n        const expiresAt = new Date(expiresField);\r\n        const now = new Date();\r\n        isExpired = expiresAt.getTime() <= now.getTime();\r\n\r\n        // Si NO est√° expirado y hay refresh_token, asegurar timer de refresh\r\n        if (!isExpired && data.refresh_token) {\r\n          const msUntilExpiry = Math.max(expiresAt.getTime() - now.getTime(), 0);\r\n          const secondsUntilExpiry = Math.floor(msUntilExpiry / 1000);\r\n          if (!this.refreshTimers.has(userId)) {\r\n            this.scheduleTokenRefresh(userId, secondsUntilExpiry);\r\n          }\r\n        }\r\n      }\r\n\r\n      return { success: true, data: { ...data, is_expired: isExpired }, error: null };\r\n    } catch (error) {\r\n      console.error('Error en getCredentials:', error);\r\n      return { success: false, data: null, error: { message: error.message } };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Actualiza tokens de Google Drive\r\n   * @param {string} userId - ID del usuario\r\n   * @param {object} tokens - Nuevos tokens\r\n   * @returns {Promise<{success: boolean, data: object, error: object}>}\r\n   */\r\n  async updateTokens(userId, tokens) {\r\n    try {\r\n      if (!userId) {\r\n        throw new Error('userId es requerido');\r\n      }\r\n      if (!tokens || !tokens.access_token) {\r\n        throw new Error('tokens con access_token es requerido');\r\n      }\r\n\r\n      const tokenExpiresAt = new Date(Date.now() + (tokens.expires_in || 3600) * 1000);\r\n\r\n      const updates = {\r\n        access_token: tokens.access_token,\r\n        refresh_token: tokens.refresh_token || undefined,\r\n        token_expires_at: tokenExpiresAt.toISOString(),\r\n        last_sync_at: new Date().toISOString(),\r\n        is_active: true,\r\n        is_connected: true,\r\n        sync_status: 'success'\r\n      };\r\n\r\n      // Remover undefined\r\n      Object.keys(updates).forEach(key => updates[key] === undefined && delete updates[key]);\r\n\r\n      const { data, error } = await supabaseDatabase.googleDriveCredentials.update(userId, updates);\r\n\r\n      if (error) {\r\n        console.error('Error actualizando tokens:', error);\r\n        return { success: false, data: null, error };\r\n      }\r\n\r\n      console.log('Tokens actualizados exitosamente');\r\n\r\n      // Reprogramar refresh\r\n      if (tokens.expires_in) {\r\n        this.scheduleTokenRefresh(userId, tokens.expires_in);\r\n      }\r\n\r\n      return { success: true, data, error: null };\r\n    } catch (error) {\r\n      console.error('Error en updateTokens:', error);\r\n      return { success: false, data: null, error: { message: error.message } };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verifica si las credenciales son v√°lidas\r\n   * @param {string} userId - ID del usuario\r\n   * @returns {Promise<boolean>}\r\n   */\r\n  async isConnected(userId) {\r\n    try {\r\n      const { data, error } = await this.getCredentials(userId);\r\n\r\n      if (error || !data) {\r\n        return false;\r\n      }\r\n\r\n      // Si est√° expirado pero hay refresh_token, intentar refrescar antes de declarar desconexi√≥n\r\n      if (data.is_expired && data.refresh_token) {\r\n        console.log('üîÑ [GoogleDrive] Token expirado, intentando refresh autom√°tico...');\r\n        const refreshResult = await this.attemptTokenRefresh(userId);\r\n        \r\n        if (!refreshResult.success) {\r\n          return false;\r\n        }\r\n        \r\n        // Reconsultar credenciales ya refrescadas\r\n        const { data: refreshed } = await this.getCredentials(userId);\r\n        if (!refreshed) return false;\r\n        return refreshed.is_connected === true && refreshed.is_expired !== true;\r\n      }\r\n\r\n      return data.is_connected === true && data.is_expired !== true;\r\n    } catch (error) {\r\n      console.error('‚ùå [GoogleDrive] Error en isConnected:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Desconecta Google Drive eliminando credenciales\r\n   * @param {string} userId - ID del usuario\r\n   * @returns {Promise<{success: boolean, error: object}>}\r\n   */\r\n  async disconnect(userId) {\r\n    try {\r\n      if (!userId) {\r\n        throw new Error('userId es requerido');\r\n      }\r\n\r\n      // Cancelar refresh timer si existe\r\n      if (this.refreshTimers.has(userId)) {\r\n        clearTimeout(this.refreshTimers.get(userId));\r\n        this.refreshTimers.delete(userId);\r\n      }\r\n\r\n      const { data, error } = await supabaseDatabase.googleDriveCredentials.delete(userId);\r\n\r\n      if (error) {\r\n        console.error('Error desconectando Google Drive:', error);\r\n        return { success: false, error };\r\n      }\r\n\r\n      console.log('Google Drive desconectado exitosamente');\r\n      return { success: true, error: null };\r\n    } catch (error) {\r\n      console.error('Error en disconnect:', error);\r\n      return { success: false, error: { message: error.message } };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Programa el refresh autom√°tico de tokens\r\n   * @param {string} userId - ID del usuario\r\n   * @param {number} expiresIn - Segundos hasta expiraci√≥n\r\n   */\r\n  scheduleTokenRefresh(userId, expiresIn) {\r\n    try {\r\n      // Cancelar timer anterior si existe\r\n      if (this.refreshTimers.has(userId)) {\r\n        clearTimeout(this.refreshTimers.get(userId));\r\n      }\r\n\r\n      // Calcular tiempo de refresh (5 minutos antes de expiraci√≥n)\r\n      const refreshTime = Math.max((expiresIn * 1000) - this.tokenRefreshBuffer, 60000);\r\n\r\n      const timer = setTimeout(async () => {\r\n        console.log(`Intentando refresh autom√°tico de tokens para usuario ${userId}`);\r\n        await this.attemptTokenRefresh(userId);\r\n      }, refreshTime);\r\n\r\n      this.refreshTimers.set(userId, timer);\r\n      console.log(`Token refresh programado para ${userId} en ${refreshTime}ms`);\r\n    } catch (error) {\r\n      console.error('Error programando token refresh:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Intenta refrescar tokens usando refresh_token\r\n   * @param {string} userId - ID del usuario\r\n   * @returns {Promise<{success: boolean, error: object}>}\r\n   */\r\n  async attemptTokenRefresh(userId) {\r\n    try {\r\n      const { data: credentials, error: getError } = await this.getCredentials(userId);\r\n\r\n      if (getError || !credentials || !credentials.refresh_token) {\r\n        console.warn('No se pueden refrescar tokens: credenciales no disponibles');\r\n        return { success: false, error: { message: 'No refresh token available' } };\r\n      }\r\n\r\n      // Llamar a endpoint de refresh de Google\r\n      const response = await fetch('https://oauth2.googleapis.com/token', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/x-www-form-urlencoded'\r\n        },\r\n        body: new URLSearchParams({\r\n          client_id: process.env.REACT_APP_GOOGLE_CLIENT_ID,\r\n          client_secret: process.env.REACT_APP_GOOGLE_CLIENT_SECRET,\r\n          refresh_token: credentials.refresh_token,\r\n          grant_type: 'refresh_token'\r\n        })\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Google token refresh failed: ${response.statusText}`);\r\n      }\r\n\r\n      const newTokens = await response.json();\r\n\r\n      // Actualizar tokens en Supabase\r\n      const { success, error } = await this.updateTokens(userId, newTokens);\r\n\r\n      if (!success) {\r\n        console.error('Error actualizando tokens refrescados:', error);\r\n        return { success: false, error };\r\n      }\r\n\r\n      console.log('Tokens refrescados exitosamente');\r\n      return { success: true, error: null };\r\n    } catch (error) {\r\n      console.error('Error en attemptTokenRefresh:', error);\r\n      return { success: false, error: { message: error.message } };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene el access token v√°lido (refrescando si es necesario)\r\n   * @param {string} userId - ID del usuario\r\n   * @returns {Promise<{token: string, error: object}>}\r\n   */\r\n  async getValidAccessToken(userId) {\r\n    try {\r\n      const { data: credentials, error } = await this.getCredentials(userId);\r\n\r\n      if (error || !credentials) {\r\n        return { token: null, error: { message: 'Credenciales no encontradas' } };\r\n      }\r\n\r\n      // Si est√° expirado, intentar refresh\r\n      if (credentials.is_expired && credentials.refresh_token) {\r\n        const { success, error: refreshError } = await this.attemptTokenRefresh(userId);\r\n        if (!success) {\r\n          return { token: null, error: refreshError };\r\n        }\r\n\r\n        // Obtener credenciales actualizadas\r\n        const { data: updatedCredentials } = await this.getCredentials(userId);\r\n        return { token: updatedCredentials.access_token, error: null };\r\n      }\r\n\r\n      return { token: credentials.access_token, error: null };\r\n    } catch (error) {\r\n      console.error('Error en getValidAccessToken:', error);\r\n      return { token: null, error: { message: error.message } };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene un estado amigable de conexi√≥n para UI\r\n   * @param {string} userId\r\n   * @returns {Promise<{connected: boolean, email: string|null, lastSync: string|null}>}\r\n   */\r\n  async getConnectionStatus(userId) {\r\n    try {\r\n      // Intentar obtener credenciales actuales\r\n      let { data } = await this.getCredentials(userId);\r\n      if (!data) {\r\n        return { connected: false, email: null, lastSync: null };\r\n      }\r\n\r\n      // Si est√°n expiradas y hay refresh_token, refrescar en el acto para no \"desconectar\" visualmente\r\n      const expiresField = data.token_expires_at || data.expires_at;\r\n      const isExpired = expiresField ? new Date(expiresField) <= new Date() : false;\r\n\r\n      if (isExpired && data.refresh_token) {\r\n        console.log('üîÑ [GoogleDrive] Refrescando token para mantener conexi√≥n activa...');\r\n        const refreshed = await this.attemptTokenRefresh(userId);\r\n        \r\n        if (refreshed.success) {\r\n          const res = await this.getCredentials(userId);\r\n          data = res.data || data;\r\n        }\r\n      }\r\n\r\n      // Recalcular expiraci√≥n tras potencial refresh\r\n      const expiresFieldAfter = data.token_expires_at || data.expires_at;\r\n      const isExpiredAfter = expiresFieldAfter ? new Date(expiresFieldAfter) <= new Date() : false;\r\n\r\n      return {\r\n        connected: data.is_connected === true && !isExpiredAfter,\r\n        email: data.google_email || data.user_email || null,\r\n        lastSync: data.last_sync_at || data.last_synced_at || null\r\n      };\r\n    } catch (e) {\r\n      console.error('‚ùå [GoogleDrive] Error en getConnectionStatus:', e);\r\n      return { connected: false, email: null, lastSync: null };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Revoca los tokens de Google del usuario en Google OAuth\r\n   * @param {string} userId\r\n   * @returns {Promise<{success: boolean, error?: object}>}\r\n   */\r\n  async revokeTokens(userId) {\r\n    try {\r\n      const { data: credentials } = await this.getCredentials(userId);\r\n      if (!credentials) return { success: true };\r\n\r\n      const tokenToRevoke = credentials.refresh_token || credentials.access_token;\r\n      if (!tokenToRevoke) return { success: true };\r\n\r\n      const resp = await fetch('https://oauth2.googleapis.com/revoke', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\r\n        body: new URLSearchParams({ token: tokenToRevoke })\r\n      });\r\n\r\n      if (!resp.ok) {\r\n        console.warn('No se pudo revocar token en Google:', resp.statusText);\r\n        return { success: false, error: { message: resp.statusText } };\r\n      }\r\n\r\n      console.log('Tokens de Google revocados correctamente');\r\n      return { success: true };\r\n    } catch (e) {\r\n      console.error('Error revocando tokens de Google:', e);\r\n      return { success: false, error: { message: e.message } };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Restablece completamente la integraci√≥n: revocar tokens y eliminar credenciales\r\n   * @param {string} userId\r\n   * @returns {Promise<{success: boolean, error?: object}>}\r\n   */\r\n  async hardReset(userId) {\r\n    try {\r\n      // Revocar en Google (si hay tokens)\r\n      await this.revokeTokens(userId);\r\n\r\n      // Eliminar registro en Supabase\r\n      const { error } = await supabaseDatabase.googleDriveCredentials.delete(userId);\r\n      if (error) {\r\n        console.error('Error eliminando credenciales en reset:', error);\r\n        return { success: false, error };\r\n      }\r\n\r\n      // Limpiar timers locales\r\n      if (this.refreshTimers.has(userId)) {\r\n        clearTimeout(this.refreshTimers.get(userId));\r\n        this.refreshTimers.delete(userId);\r\n      }\r\n\r\n      console.log('Hard reset de Google Drive completado para usuario', userId);\r\n      return { success: true };\r\n    } catch (e) {\r\n      console.error('Error en hardReset:', e);\r\n      return { success: false, error: { message: e.message } };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Limpia todos los timers de refresh\r\n   */\r\n  cleanup() {\r\n    this.refreshTimers.forEach(timer => clearTimeout(timer));\r\n    this.refreshTimers.clear();\r\n    console.log('Google Drive Persistence Service limpiado');\r\n  }\r\n}\r\n\r\nconst googleDrivePersistenceService = new GoogleDrivePersistenceService();\r\nexport default googleDrivePersistenceService;\r\n","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\googleDriveSyncService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\groqService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\inMemoryDraftService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\inMemoryUserService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\multiChannelCommunicationService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":182,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":182,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":211,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":211,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":240,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":240,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":300,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":300,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":332,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":332,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'savedData' is assigned a value but never used.","line":364,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":364,"endColumn":30},{"ruleId":"no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":396,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":396,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":481,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":481,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from '../lib/supabaseClient.js'\r\nimport organizedDatabaseService from './organizedDatabaseService.js'\r\nimport brevoService from './brevoService.js'\r\nimport brevoCampaignService from './brevoCampaignService.js'\r\n\r\nclass MultiChannelCommunicationService {\r\n  constructor() {\r\n    this.employees = []\r\n    this.companies = []\r\n    this.loadEmployeeData()\r\n    \r\n    this.channels = {\r\n      email: {\r\n        name: 'Email',\r\n        icon: 'üìß',\r\n        color: '#3B82F6',\r\n        enabled: true,\r\n        templates: ['newsletter', 'announcement', 'reminder', 'report']\r\n      },\r\n      teams: {\r\n        name: 'Microsoft Teams',\r\n        icon: 'üü£',\r\n        color: '#5B21B6',\r\n        enabled: true,\r\n        templates: ['meeting', 'update', 'alert', 'collaboration']\r\n      },\r\n      slack: {\r\n        name: 'Slack',\r\n        icon: 'üíú',\r\n        color: '#6366F1',\r\n        enabled: true,\r\n        templates: ['message', 'channel', 'dm', 'announcement']\r\n      },\r\n      sms: {\r\n        name: 'SMS',\r\n        icon: 'üì±',\r\n        color: '#10B981',\r\n        enabled: true,\r\n        templates: ['urgent', 'reminder', 'verification', 'alert']\r\n      },\r\n      video: {\r\n        name: 'Video Mensajes',\r\n        icon: 'üé•',\r\n        color: '#EF4444',\r\n        enabled: true,\r\n        templates: ['tutorial', 'announcement', 'training', 'update']\r\n      },\r\n      infographic: {\r\n        name: 'Infograf√≠as',\r\n        icon: 'üìä',\r\n        color: '#F59E0B',\r\n        enabled: true,\r\n        templates: ['report', 'statistics', 'process', 'timeline']\r\n      },\r\n      podcast: {\r\n        name: 'Podcasts Internos',\r\n        icon: 'üéôÔ∏è',\r\n        color: '#8B5CF6',\r\n        enabled: true,\r\n        templates: ['executive_update', 'training', 'interview', 'news']\r\n      }\r\n    }\r\n  }\r\n\r\n  // Obtener todos los canales disponibles\r\n  getAvailableChannels() {\r\n    return Object.entries(this.channels)\r\n      .filter(([key, channel]) => channel.enabled)\r\n      .map(([key, channel]) => ({ id: key, ...channel }))\r\n  }\r\n\r\n  // Enviar mensaje multicanal\r\n  async sendMultiChannelMessage(messageData) {\r\n    try {\r\n      const { channels, content, recipients, schedule, priority } = messageData\r\n      \r\n      const results = []\r\n      \r\n      for (const channelId of channels) {\r\n        const channel = this.channels[channelId]\r\n        if (!channel || !channel.enabled) continue\r\n        \r\n        const result = await this.sendToChannel(channelId, {\r\n          ...content,\r\n          recipients,\r\n          schedule,\r\n          priority\r\n        })\r\n        \r\n        results.push({\r\n          channel: channelId,\r\n          success: result.success,\r\n          messageId: result.messageId,\r\n          error: result.error\r\n        })\r\n      }\r\n      \r\n      return {\r\n        success: true,\r\n        results,\r\n        totalChannels: channels.length,\r\n        successfulChannels: results.filter(r => r.success).length\r\n      }\r\n    } catch (error) {\r\n      console.error('Error sending multichannel message:', error)\r\n      return { success: false, error: error.message }\r\n    }\r\n  }\r\n\r\n  // Enviar a un canal espec√≠fico\r\n  async sendToChannel(channelId, messageData) {\r\n    try {\r\n      switch (channelId) {\r\n        case 'email':\r\n          return await this.sendEmail(messageData)\r\n        case 'teams':\r\n          return await this.sendToTeams(messageData)\r\n        case 'slack':\r\n          return await this.sendToSlack(messageData)\r\n        case 'sms':\r\n          return await this.sendSMS(messageData)\r\n        case 'video':\r\n          return await this.sendVideoMessage(messageData)\r\n        case 'infographic':\r\n          return await this.generateInfographic(messageData)\r\n        case 'podcast':\r\n          return await this.createPodcast(messageData)\r\n        default:\r\n          throw new Error(`Canal ${channelId} no soportado`)\r\n      }\r\n    } catch (error) {\r\n      console.error(`Error sending to ${channelId}:`, error)\r\n      return { success: false, error: error.message }\r\n    }\r\n  }\r\n\r\n  // Enviar Email\r\n  async sendEmail(messageData) {\r\n    try {\r\n      const { subject, body, recipients, attachments, useBrevo = true } = messageData\r\n      \r\n      // Verificar si Brevo est√° configurado para env√≠o real\r\n      const brevoConfig = brevoService.loadConfiguration()\r\n      \r\n      if (useBrevo && brevoConfig.apiKey) {\r\n        // Usar Brevo para env√≠o real\r\n        try {\r\n          const result = await brevoService.sendBulkEmail({\r\n            to: recipients,\r\n            subject: subject,\r\n            htmlContent: body,\r\n            sender: {\r\n              name: brevoConfig.emailName || 'StaffHub',\r\n              email: brevoConfig.emailSender || 'noreply@staffhub.com'\r\n            },\r\n            testMode: brevoConfig.testMode || false\r\n          })\r\n          \r\n          // Crear campa√±a en Brevo para seguimiento\r\n          await brevoCampaignService.createCampaign({\r\n            name: `Email: ${subject}`,\r\n            type: 'email',\r\n            subject: subject,\r\n            content: body,\r\n            senderName: brevoConfig.emailName || 'StaffHub',\r\n            senderEmail: brevoConfig.emailSender || 'noreply@staffhub.com',\r\n            recipients: recipients.map(email => ({ email })),\r\n            testMode: brevoConfig.testMode || false\r\n          })\r\n          \r\n          return { success: true, messageId: result.messageId, provider: 'brevo' }\r\n        } catch (brevoError) {\r\n          console.warn('Error con Brevo, usando fallback:', brevoError.message)\r\n          // Continuar con el m√©todo fallback\r\n        }\r\n      }\r\n      \r\n      // M√©todo fallback (simulaci√≥n)\r\n      const messageId = `email_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n      \r\n      // Guardar en base de datos\r\n      const { data, error } = await supabase\r\n        .from('communication_logs')\r\n        .insert({\r\n          id: messageId,\r\n          channel: 'email',\r\n          subject,\r\n          content: body,\r\n          recipients: recipients.join(','),\r\n          status: 'sent',\r\n          sent_at: new Date().toISOString(),\r\n          metadata: { attachments, provider: 'fallback' }\r\n        })\r\n      \r\n      if (error) throw error\r\n      \r\n      return { success: true, messageId, provider: 'fallback' }\r\n    } catch (error) {\r\n      return { success: false, error: error.message }\r\n    }\r\n  }\r\n\r\n  // Enviar a Microsoft Teams\r\n  async sendToTeams(messageData) {\r\n    try {\r\n      const { title, body, recipients, channel } = messageData\r\n      \r\n      const messageId = `teams_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n      \r\n      // Guardar en base de datos\r\n      const { data, error } = await supabase\r\n        .from('communication_logs')\r\n        .insert({\r\n          id: messageId,\r\n          channel: 'teams',\r\n          subject: title,\r\n          content: body,\r\n          recipients: recipients.join(','),\r\n          status: 'sent',\r\n          sent_at: new Date().toISOString(),\r\n          metadata: { channel }\r\n        })\r\n      \r\n      if (error) throw error\r\n      \r\n      return { success: true, messageId }\r\n    } catch (error) {\r\n      return { success: false, error: error.message }\r\n    }\r\n  }\r\n\r\n  // Enviar a Slack\r\n  async sendToSlack(messageData) {\r\n    try {\r\n      const { text, recipients, channel } = messageData\r\n      \r\n      const messageId = `slack_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n      \r\n      // Guardar en base de datos\r\n      const { data, error } = await supabase\r\n        .from('communication_logs')\r\n        .insert({\r\n          id: messageId,\r\n          channel: 'slack',\r\n          subject: 'Slack Message',\r\n          content: text,\r\n          recipients: recipients.join(','),\r\n          status: 'sent',\r\n          sent_at: new Date().toISOString(),\r\n          metadata: { channel }\r\n        })\r\n      \r\n      if (error) throw error\r\n      \r\n      return { success: true, messageId }\r\n    } catch (error) {\r\n      return { success: false, error: error.message }\r\n    }\r\n  }\r\n\r\n  // Enviar SMS\r\n  async sendSMS(messageData) {\r\n    try {\r\n      const { message, recipients, urgent, useBrevo = true } = messageData\r\n      \r\n      // Verificar si Brevo est√° configurado para env√≠o real\r\n      const brevoConfig = brevoService.loadConfiguration()\r\n      \r\n      if (useBrevo && brevoConfig.apiKey) {\r\n        // Usar Brevo para env√≠o real\r\n        try {\r\n          const result = await brevoService.sendBulkSMS({\r\n            to: recipients,\r\n            message: message,\r\n            sender: brevoConfig.smsSender || 'StaffHub',\r\n            testMode: brevoConfig.testMode || false\r\n          })\r\n          \r\n          // Crear campa√±a en Brevo para seguimiento\r\n          await brevoCampaignService.createCampaign({\r\n            name: `SMS: ${message.substring(0, 50)}...`,\r\n            type: 'sms',\r\n            content: message,\r\n            senderName: brevoConfig.smsSender || 'StaffHub',\r\n            recipients: recipients.map(phone => ({ phoneNumber: phone })),\r\n            testMode: brevoConfig.testMode || false\r\n          })\r\n          \r\n          return { success: true, messageId: result.messageId, provider: 'brevo' }\r\n        } catch (brevoError) {\r\n          console.warn('Error con Brevo, usando fallback:', brevoError.message)\r\n          // Continuar con el m√©todo fallback\r\n        }\r\n      }\r\n      \r\n      // M√©todo fallback (simulaci√≥n)\r\n      const messageId = `sms_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n      \r\n      // Guardar en base de datos\r\n      const { data, error } = await supabase\r\n        .from('communication_logs')\r\n        .insert({\r\n          id: messageId,\r\n          channel: 'sms',\r\n          subject: 'SMS',\r\n          content: message,\r\n          recipients: recipients.join(','),\r\n          status: 'sent',\r\n          sent_at: new Date().toISOString(),\r\n          metadata: { urgent, provider: 'fallback' }\r\n        })\r\n      \r\n      if (error) throw error\r\n      \r\n      return { success: true, messageId, provider: 'fallback' }\r\n    } catch (error) {\r\n      return { success: false, error: error.message }\r\n    }\r\n  }\r\n\r\n  // Crear y enviar video mensaje\r\n  async sendVideoMessage(messageData) {\r\n    try {\r\n      const { title, script, duration, recipients, quality } = messageData\r\n      \r\n      const messageId = `video_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n      \r\n      // Simulaci√≥n de creaci√≥n de video\r\n      const videoUrl = `https://videos.company.com/${messageId}.mp4`\r\n      \r\n      // Guardar en base de datos\r\n      const { data, error } = await supabase\r\n        .from('communication_logs')\r\n        .insert({\r\n          id: messageId,\r\n          channel: 'video',\r\n          subject: title,\r\n          content: script,\r\n          recipients: recipients.join(','),\r\n          status: 'processing',\r\n          sent_at: new Date().toISOString(),\r\n          metadata: { duration, quality, videoUrl }\r\n        })\r\n      \r\n      if (error) throw error\r\n      \r\n      return { success: true, messageId, videoUrl }\r\n    } catch (error) {\r\n      return { success: false, error: error.message }\r\n    }\r\n  }\r\n\r\n  // Generar infograf√≠a autom√°tica\r\n  async generateInfographic(messageData) {\r\n    try {\r\n      const { title, data: infographicData, type, recipients, style } = messageData\r\n      \r\n      const messageId = `infographic_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n      \r\n      // Simulaci√≥n de generaci√≥n de infograf√≠a\r\n      const infographicUrl = `https://infographics.company.com/${messageId}.png`\r\n      \r\n      // Guardar en base de datos\r\n      const { data: savedData, error } = await supabase\r\n        .from('communication_logs')\r\n        .insert({\r\n          id: messageId,\r\n          channel: 'infographic',\r\n          subject: title,\r\n          content: JSON.stringify(infographicData),\r\n          recipients: recipients.join(','),\r\n          status: 'processing',\r\n          sent_at: new Date().toISOString(),\r\n          metadata: { type, style, infographicUrl }\r\n        })\r\n      \r\n      if (error) throw error\r\n      \r\n      return { success: true, messageId, infographicUrl }\r\n    } catch (error) {\r\n      return { success: false, error: error.message }\r\n    }\r\n  }\r\n\r\n  // Crear podcast interno\r\n  async createPodcast(messageData) {\r\n    try {\r\n      const { title, content, duration, host, guests, recipients } = messageData\r\n      \r\n      const messageId = `podcast_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n      \r\n      // Simulaci√≥n de creaci√≥n de podcast\r\n      const podcastUrl = `https://podcasts.company.com/${messageId}.mp3`\r\n      \r\n      // Guardar en base de datos\r\n      const { data, error } = await supabase\r\n        .from('communication_logs')\r\n        .insert({\r\n          id: messageId,\r\n          channel: 'podcast',\r\n          subject: title,\r\n          content: content,\r\n          recipients: recipients.join(','),\r\n          status: 'processing',\r\n          sent_at: new Date().toISOString(),\r\n          metadata: { duration, host, guests, podcastUrl }\r\n        })\r\n      \r\n      if (error) throw error\r\n      \r\n      return { success: true, messageId, podcastUrl }\r\n    } catch (error) {\r\n      return { success: false, error: error.message }\r\n    }\r\n  }\r\n\r\n  // Obtener estad√≠sticas por canal\r\n  async getChannelStats() {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('communication_logs')\r\n        .select('channel, status, sent_at')\r\n        .order('sent_at', { ascending: false })\r\n        .limit(1000)\r\n      \r\n      if (error) throw error\r\n      \r\n      const stats = {}\r\n      const channels = this.getAvailableChannels()\r\n      \r\n      // Inicializar estad√≠sticas\r\n      channels.forEach(channel => {\r\n        stats[channel.id] = {\r\n          name: channel.name,\r\n          icon: channel.icon,\r\n          color: channel.color,\r\n          sent: 0,\r\n          delivered: 0,\r\n          failed: 0,\r\n          pending: 0,\r\n          total: 0\r\n        }\r\n      })\r\n      \r\n      // Contar mensajes por canal y estado\r\n      data.forEach(log => {\r\n        if (stats[log.channel]) {\r\n          stats[log.channel].total++\r\n          stats[log.channel][log.status]++\r\n        }\r\n      })\r\n      \r\n      return stats\r\n    } catch (error) {\r\n      console.error('Error getting channel stats:', error)\r\n      return {}\r\n    }\r\n  }\r\n\r\n  // Obtener plantillas por canal\r\n  getTemplatesByChannel(channelId) {\r\n    const channel = this.channels[channelId]\r\n    if (!channel) return []\r\n    \r\n    return channel.templates.map(template => ({\r\n      id: `${channelId}_${template}`,\r\n      name: template.charAt(0).toUpperCase() + template.slice(1),\r\n      channel: channelId,\r\n      channelName: channel.name\r\n    }))\r\n  }\r\n\r\n  // Programar env√≠o multicanal\r\n  async scheduleMultiChannelMessage(messageData) {\r\n    try {\r\n      const { channels, content, recipients, scheduleTime, priority } = messageData\r\n      \r\n      const scheduleId = `schedule_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n      \r\n      // Guardar programaci√≥n en base de datos\r\n      const { data, error } = await supabase\r\n        .from('scheduled_messages')\r\n        .insert({\r\n          id: scheduleId,\r\n          channels: channels.join(','),\r\n          content: JSON.stringify(content),\r\n          recipients: recipients.join(','),\r\n          scheduled_time: scheduleTime,\r\n          priority: priority || 'normal',\r\n          status: 'scheduled',\r\n          created_at: new Date().toISOString()\r\n        })\r\n      \r\n      if (error) throw error\r\n      \r\n      return { success: true, scheduleId }\r\n    } catch (error) {\r\n      return { success: false, error: error.message }\r\n    }\r\n  }\r\n\r\n  // Cargar datos de empleados desde la base de datos\r\n  async loadEmployeeData() {\r\n    try {\r\n      // Cargar empleados desde el servicio en memoria\r\n      this.employees = await organizedDatabaseService.getEmployees() || []\r\n      this.companies = await organizedDatabaseService.getCompanies() || []\r\n      \r\n      console.log(`Cargados ${this.employees.length} empleados y ${this.companies.length} empresas`)\r\n    } catch (error) {\r\n      console.error('Error cargando datos de empleados:', error)\r\n      this.employees = []\r\n      this.companies = []\r\n    }\r\n  }\r\n\r\n  // Obtener todos los empleados\r\n  getEmployees() {\r\n    return this.employees\r\n  }\r\n\r\n  // Obtener empleados por empresa\r\n  getEmployeesByCompany(companyId) {\r\n    return this.employees.filter(employee => employee.companyId === companyId)\r\n  }\r\n\r\n  // Obtener empleados por departamento\r\n  getEmployeesByDepartment(department) {\r\n    return this.employees.filter(employee => employee.department === department)\r\n  }\r\n\r\n  // Obtener empleados por regi√≥n\r\n  getEmployeesByRegion(region) {\r\n    return this.employees.filter(employee => employee.region === region)\r\n  }\r\n\r\n  // Filtrar empleados con m√∫ltiples criterios\r\n  filterEmployees(filters = {}) {\r\n    let filteredEmployees = [...this.employees]\r\n    \r\n    if (filters.company) {\r\n      filteredEmployees = filteredEmployees.filter(emp =>\r\n        emp.company === filters.company || emp.companyId === filters.company\r\n      )\r\n    }\r\n    \r\n    if (filters.department) {\r\n      filteredEmployees = filteredEmployees.filter(emp =>\r\n        emp.department === filters.department\r\n      )\r\n    }\r\n    \r\n    if (filters.region) {\r\n      filteredEmployees = filteredEmployees.filter(emp =>\r\n        emp.region === filters.region\r\n      )\r\n    }\r\n    \r\n    if (filters.level) {\r\n      filteredEmployees = filteredEmployees.filter(emp =>\r\n        emp.level === filters.level\r\n      )\r\n    }\r\n    \r\n    if (filters.workMode) {\r\n      filteredEmployees = filteredEmployees.filter(emp =>\r\n        emp.workMode === filters.workMode\r\n      )\r\n    }\r\n    \r\n    if (filters.contractType) {\r\n      filteredEmployees = filteredEmployees.filter(emp =>\r\n        emp.contractType === filters.contractType\r\n      )\r\n    }\r\n    \r\n    return filteredEmployees\r\n  }\r\n\r\n  // Obtener destinatarios para comunicaci√≥n multicanal\r\n  getRecipientsForCommunication(filters = {}) {\r\n    const filteredEmployees = this.filterEmployees(filters)\r\n    \r\n    return filteredEmployees.map(employee => ({\r\n      id: employee.id,\r\n      name: employee.name,\r\n      email: employee.email,\r\n      phone: employee.phone,\r\n      company: employee.company,\r\n      department: employee.department,\r\n      region: employee.region,\r\n      level: employee.level,\r\n      position: employee.position,\r\n      workMode: employee.workMode,\r\n      contractType: employee.contractType,\r\n      // Canales disponibles para este empleado\r\n      availableChannels: this.getAvailableChannelsForEmployee(employee)\r\n    }))\r\n  }\r\n\r\n  // Determinar canales disponibles para un empleado espec√≠fico\r\n  getAvailableChannelsForEmployee(employee) {\r\n    const channels = []\r\n    \r\n    // Email - siempre disponible si hay email\r\n    if (employee.email) {\r\n      channels.push('email')\r\n    }\r\n    \r\n    // SMS - disponible si hay tel√©fono\r\n    if (employee.phone) {\r\n      channels.push('sms')\r\n    }\r\n    \r\n    // Teams - disponible para empleados corporativos\r\n    if (employee.level === 'Senior' || employee.level === 'Manager' || employee.level === 'Director') {\r\n      channels.push('teams')\r\n    }\r\n    \r\n    // Slack - disponible para equipos de tecnolog√≠a\r\n    if (employee.department === 'Technology' || employee.department === 'Engineering') {\r\n      channels.push('slack')\r\n    }\r\n    \r\n    // Video mensajes - disponible para todos\r\n    channels.push('video')\r\n    \r\n    // Infograf√≠as - disponible para todos\r\n    channels.push('infographic')\r\n    \r\n    // Podcasts - disponible para niveles senior y gerenciales\r\n    if (employee.level === 'Senior' || employee.level === 'Manager' || employee.level === 'Director') {\r\n      channels.push('podcast')\r\n    }\r\n    \r\n    return channels\r\n  }\r\n\r\n  // Enviar mensaje multicanal a empleados filtrados\r\n  async sendMultiChannelMessageToEmployees(messageData, employeeFilters = {}) {\r\n    try {\r\n      const recipients = this.getRecipientsForCommunication(employeeFilters)\r\n      \r\n      if (recipients.length === 0) {\r\n        return { success: false, error: 'No se encontraron empleados con los filtros especificados' }\r\n      }\r\n      \r\n      // Extraer emails y tel√©fonos para los destinatarios\r\n      const emailRecipients = recipients\r\n        .filter(r => r.email && messageData.channels.includes('email'))\r\n        .map(r => r.email)\r\n      \r\n      const smsRecipients = recipients\r\n        .filter(r => r.phone && messageData.channels.includes('sms'))\r\n        .map(r => r.phone)\r\n      \r\n      // Preparar datos para env√≠o\r\n      const enhancedMessageData = {\r\n        ...messageData,\r\n        recipients: {\r\n          email: emailRecipients,\r\n          sms: smsRecipients,\r\n          all: recipients.map(r => r.id)\r\n        }\r\n      }\r\n      \r\n      // Enviar mensaje multicanal\r\n      const result = await this.sendMultiChannelMessage(enhancedMessageData)\r\n      \r\n      // Registrar comunicaci√≥n espec√≠fica para empleados\r\n      if (result.success) {\r\n        await this.logEmployeeCommunication(result.results, recipients, employeeFilters)\r\n      }\r\n      \r\n      return {\r\n        ...result,\r\n        recipientsCount: recipients.length,\r\n        emailRecipients: emailRecipients.length,\r\n        smsRecipients: smsRecipients.length\r\n      }\r\n    } catch (error) {\r\n      console.error('Error sending multichannel message to employees:', error)\r\n      return { success: false, error: error.message }\r\n    }\r\n  }\r\n\r\n  // Registrar comunicaci√≥n de empleados en la base de datos\r\n  async logEmployeeCommunication(results, recipients, filters) {\r\n    try {\r\n      for (const result of results) {\r\n        await supabase\r\n          .from('employee_communication_logs')\r\n          .insert({\r\n            channel: result.channel,\r\n            message_id: result.messageId,\r\n            success: result.success,\r\n            recipients_count: recipients.length,\r\n            filters_applied: JSON.stringify(filters),\r\n            recipients_list: recipients.map(r => r.id),\r\n            sent_at: new Date().toISOString(),\r\n            error: result.error || null\r\n          })\r\n      }\r\n    } catch (error) {\r\n      console.error('Error logging employee communication:', error)\r\n    }\r\n  }\r\n\r\n  // Obtener estad√≠sticas de comunicaci√≥n por departamento\r\n  async getCommunicationStatsByDepartment() {\r\n    try {\r\n      const departments = [...new Set(this.employees.map(emp => emp.department))]\r\n      const stats = {}\r\n      \r\n      for (const department of departments) {\r\n        const departmentEmployees = this.getEmployeesByDepartment(department)\r\n        const { data, error } = await supabase\r\n          .from('employee_communication_logs')\r\n          .select('*')\r\n          .in('recipients_list', departmentEmployees.map(emp => emp.id))\r\n        \r\n        if (!error && data) {\r\n          stats[department] = {\r\n            employeeCount: departmentEmployees.length,\r\n            communicationsSent: data.length,\r\n            successfulCommunications: data.filter(log => log.success).length,\r\n            channelsUsed: [...new Set(data.map(log => log.channel))]\r\n          }\r\n        }\r\n      }\r\n      \r\n      return stats\r\n    } catch (error) {\r\n      console.error('Error getting communication stats by department:', error)\r\n      return {}\r\n    }\r\n  }\r\n\r\n  // Obtener estad√≠sticas de comunicaci√≥n por empresa\r\n  async getCommunicationStatsByCompany() {\r\n    try {\r\n      const stats = {}\r\n      \r\n      for (const company of this.companies) {\r\n        const companyEmployees = this.getEmployeesByCompany(company.id)\r\n        const { data, error } = await supabase\r\n          .from('employee_communication_logs')\r\n          .select('*')\r\n          .in('recipients_list', companyEmployees.map(emp => emp.id))\r\n        \r\n        if (!error && data) {\r\n          stats[company.name] = {\r\n            employeeCount: companyEmployees.length,\r\n            communicationsSent: data.length,\r\n            successfulCommunications: data.filter(log => log.success).length,\r\n            channelsUsed: [...new Set(data.map(log => log.channel))]\r\n          }\r\n        }\r\n      }\r\n      \r\n      return stats\r\n    } catch (error) {\r\n      console.error('Error getting communication stats by company:', error)\r\n      return {}\r\n    }\r\n  }\r\n\r\n  // Sincronizar plantillas con el sistema existente\r\n  syncTemplatesWithSystem(systemTemplates = []) {\r\n    try {\r\n      // Mapear plantillas del sistema a canales multicanal\r\n      const templateMapping = {\r\n        'WhatsApp': 'sms',\r\n        'Telegram': 'sms',\r\n        'Email': 'email',\r\n        'Teams': 'teams',\r\n        'Slack': 'slack'\r\n      }\r\n      \r\n      systemTemplates.forEach(template => {\r\n        const channelId = templateMapping[template.type]\r\n        if (channelId && this.channels[channelId]) {\r\n          // Agregar plantilla al canal correspondiente\r\n          if (!this.channels[channelId].systemTemplates) {\r\n            this.channels[channelId].systemTemplates = []\r\n          }\r\n          \r\n          this.channels[channelId].systemTemplates.push({\r\n            id: template.id,\r\n            name: template.name,\r\n            content: template.content,\r\n            type: template.type,\r\n            category: template.category,\r\n            autoTrigger: template.autoTrigger\r\n          })\r\n        }\r\n      })\r\n      \r\n      console.log('Plantillas sincronizadas con el sistema multicanal')\r\n    } catch (error) {\r\n      console.error('Error syncing templates with system:', error)\r\n    }\r\n  }\r\n\r\n  // Obtener plantillas combinadas (nativas + del sistema)\r\n  getCombinedTemplates(channelId) {\r\n    const channel = this.channels[channelId]\r\n    if (!channel) return []\r\n    \r\n    const templates = []\r\n    \r\n    // Plantillas nativas del canal\r\n    if (channel.templates) {\r\n      channel.templates.forEach(template => {\r\n        templates.push({\r\n          id: `${channelId}_${template}`,\r\n          name: template.charAt(0).toUpperCase() + template.slice(1),\r\n          content: '',\r\n          type: 'native',\r\n          category: 'general'\r\n        })\r\n      })\r\n    }\r\n    \r\n    // Plantillas del sistema\r\n    if (channel.systemTemplates) {\r\n      templates.push(...channel.systemTemplates)\r\n    }\r\n    \r\n    return templates\r\n  }\r\n}\r\n\r\nconst multiChannelService = new MultiChannelCommunicationService()\r\nexport default multiChannelService","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\multiCompanyManagementService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is assigned a value but never used.","line":643,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":643,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from '../lib/supabase.js'\r\n\r\n/**\r\n * Servicio de Gesti√≥n Multi-Empresa para Agencias\r\n * \r\n * Este servicio proporciona funcionalidades completas para:\r\n * - Gesti√≥n de m√∫ltiples empresas/clientes\r\n * - Control de l√≠mites de uso y costos\r\n * - Aislamiento completo de datos\r\n * - Facturaci√≥n y reportes por empresa\r\n * - Gesti√≥n de roles y permisos por empresa\r\n */\r\n\r\nclass MultiCompanyManagementService {\r\n  constructor() {\r\n    this.cache = new Map()\r\n    this.cacheTimeout = 5 * 60 * 1000 // 5 minutos\r\n  }\r\n\r\n  // ========================================\r\n  // GESTI√ìN DE EMPRESAS/CLIENTES\r\n  // ========================================\r\n\r\n  /**\r\n   * Crear nueva empresa/cliente para una agencia\r\n   * @param {Object} companyData - Datos de la empresa\r\n   * @param {string} agencyId - ID de la agencia\r\n   * @returns {Promise<Object>} Resultado de la creaci√≥n\r\n   */\r\n  async createCompany(companyData, agencyId) {\r\n    try {\r\n      console.log(`üè¢ Creando empresa para agencia ${agencyId}`);\r\n\r\n      // Validar que la agencia existe y tiene permisos\r\n      const agency = await this.getAgency(agencyId);\r\n      if (!agency) {\r\n        throw new Error('Agencia no encontrada o sin permisos');\r\n      }\r\n\r\n      // Verificar l√≠mite de empresas para la agencia\r\n      const companyCount = await this.getCompanyCount(agencyId);\r\n      if (companyCount >= agency.max_companies) {\r\n        throw new Error(`L√≠mite de empresas alcanzado (${agency.max_companies})`);\r\n      }\r\n\r\n      // Crear empresa con configuraci√≥n por defecto\r\n      const { data: company, error } = await supabase\r\n        .from('companies')\r\n        .insert({\r\n          ...companyData,\r\n          agency_id: agencyId,\r\n          status: 'active',\r\n          created_at: new Date().toISOString(),\r\n          // Configuraci√≥n por defecto para l√≠mites\r\n          monthly_limit: companyData.monthlyLimit || agency.default_monthly_limit || 1000,\r\n          daily_limit: companyData.dailyLimit || Math.floor((companyData.monthlyLimit || 1000) / 30),\r\n          message_cost: companyData.messageCost || 0.0525,\r\n          billing_cycle: companyData.billingCycle || 'monthly',\r\n          billing_email: companyData.billingEmail || companyData.contact_email,\r\n          // Configuraci√≥n de WhatsApp por defecto\r\n          whatsapp_configured: false,\r\n          whatsapp_status: 'not_configured',\r\n          // Configuraci√≥n de canales por defecto\r\n          email_enabled: true,\r\n          sms_enabled: true,\r\n          telegram_enabled: false,\r\n          whatsapp_enabled: false,\r\n          groq_enabled: false,\r\n          google_enabled: false,\r\n          microsoft_enabled: false,\r\n          slack_enabled: false,\r\n          teams_enabled: false,\r\n          hubspot_enabled: false,\r\n          salesforce_enabled: false\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      // Crear configuraci√≥n inicial de uso\r\n      await this.initializeUsageTracking(company.id);\r\n\r\n      // Crear configuraci√≥n de facturaci√≥n\r\n      await this.initializeBilling(company.id, companyData);\r\n\r\n      console.log(`‚úÖ Empresa ${company.name} creada exitosamente`);\r\n      \r\n      return {\r\n        success: true,\r\n        company,\r\n        message: `Empresa ${company.name} creada exitosamente`\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('‚ùå Error creando empresa:', error);\r\n      return {\r\n        success: false,\r\n        message: `Error creando empresa: ${error.message}`,\r\n        error: error.message\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener todas las empresas de una agencia\r\n   * @param {string} agencyId - ID de la agencia\r\n   * @param {Object} options - Opciones de filtrado\r\n   * @returns {Promise<Array>} Lista de empresas\r\n   */\r\n  async getAgencyCompanies(agencyId, options = {}) {\r\n    const {\r\n      status = null,\r\n      limit = 50,\r\n      offset = 0,\r\n      search = null\r\n    } = options;\r\n\r\n    const cacheKey = `agency_companies_${agencyId}_${JSON.stringify(options)}`;\r\n    const cached = this.getFromCache(cacheKey);\r\n    if (cached) return cached;\r\n\r\n    try {\r\n      let query = supabase\r\n        .from('companies')\r\n        .select('*')\r\n        .eq('agency_id', agencyId)\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (status) {\r\n        query = query.eq('status', status);\r\n      }\r\n\r\n      if (search) {\r\n        query = query.or(`name.ilike.%${search}%,rut.ilike.%${search}%`);\r\n      }\r\n\r\n      const { data, error } = await query\r\n        .range(offset, offset + limit - 1);\r\n\r\n      if (error) throw error;\r\n\r\n      // Obtener estad√≠sticas de uso para cada empresa\r\n      const companiesWithStats = await Promise.all(\r\n        (data || []).map(async (company) => {\r\n          const stats = await this.getCompanyUsageStats(company.id);\r\n          return {\r\n            ...company,\r\n            usage_stats: stats\r\n          };\r\n        })\r\n      );\r\n\r\n      this.setCache(cacheKey, companiesWithStats);\r\n      return companiesWithStats;\r\n\r\n    } catch (error) {\r\n      console.error('Error obteniendo empresas de agencia:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Actualizar informaci√≥n de una empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {Object} updateData - Datos a actualizar\r\n   * @param {string} agencyId - ID de la agencia (para verificaci√≥n)\r\n   * @returns {Promise<Object>} Resultado de la actualizaci√≥n\r\n   */\r\n  async updateCompany(companyId, updateData, agencyId) {\r\n    try {\r\n      // Verificar que la empresa pertenece a la agencia\r\n      const company = await this.getCompany(companyId);\r\n      if (!company || company.agency_id !== agencyId) {\r\n        throw new Error('Empresa no encontrada o sin permisos');\r\n      }\r\n\r\n      const { data, error } = await supabase\r\n        .from('companies')\r\n        .update({\r\n          ...updateData,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('id', companyId)\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      // Limpiar cache\r\n      this.clearCache(`agency_companies_${agencyId}_`);\r\n      this.clearCache(`company_${companyId}`);\r\n\r\n      return {\r\n        success: true,\r\n        company: data,\r\n        message: 'Empresa actualizada exitosamente'\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error actualizando empresa:', error);\r\n      return {\r\n        success: false,\r\n        message: `Error actualizando empresa: ${error.message}`,\r\n        error: error.message\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Suspender o reactivar una empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {string} status - Nuevo estado (active/suspended)\r\n   * @param {string} agencyId - ID de la agencia\r\n   * @returns {Promise<Object>} Resultado de la operaci√≥n\r\n   */\r\n  async setCompanyStatus(companyId, status, agencyId) {\r\n    return this.updateCompany(companyId, {\r\n      status,\r\n      suspended_at: status === 'suspended' ? new Date().toISOString() : null,\r\n      reactivated_at: status === 'active' ? new Date().toISOString() : null\r\n    }, agencyId);\r\n  }\r\n\r\n  // ========================================\r\n  // CONTROL DE L√çMITES Y COSTOS\r\n  // ========================================\r\n\r\n  /**\r\n   * Verificar si una empresa puede enviar mensajes\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {number} messageCount - Cantidad de mensajes a enviar\r\n   * @returns {Promise<Object>} Resultado de la verificaci√≥n\r\n   */\r\n  async checkMessageLimits(companyId, messageCount = 1) {\r\n    try {\r\n      const company = await this.getCompany(companyId);\r\n      if (!company) {\r\n        throw new Error('Empresa no encontrada');\r\n      }\r\n\r\n      // Obtener uso actual\r\n      const currentUsage = await this.getCurrentUsage(companyId);\r\n      \r\n      // Verificar l√≠mite diario\r\n      const dailyRemaining = company.daily_limit - currentUsage.daily_count;\r\n      if (dailyRemaining < messageCount) {\r\n        return {\r\n          canSend: false,\r\n          reason: `L√≠mite diario alcanzado. Restantes: ${dailyRemaining}`,\r\n          dailyLimit: company.daily_limit,\r\n          dailyUsed: currentUsage.daily_count,\r\n          dailyRemaining\r\n        };\r\n      }\r\n\r\n      // Verificar l√≠mite mensual\r\n      const monthlyRemaining = company.monthly_limit - currentUsage.monthly_count;\r\n      if (monthlyRemaining < messageCount) {\r\n        return {\r\n          canSend: false,\r\n          reason: `L√≠mite mensual alcanzado. Restantes: ${monthlyRemaining}`,\r\n          monthlyLimit: company.monthly_limit,\r\n          monthlyUsed: currentUsage.monthly_count,\r\n          monthlyRemaining\r\n        };\r\n      }\r\n\r\n      // Calcular costo estimado\r\n      const estimatedCost = messageCount * company.message_cost;\r\n\r\n      return {\r\n        canSend: true,\r\n        dailyRemaining: dailyRemaining - messageCount,\r\n        monthlyRemaining: monthlyRemaining - messageCount,\r\n        estimatedCost,\r\n        costPerMessage: company.message_cost\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error verificando l√≠mites:', error);\r\n      return {\r\n        canSend: false,\r\n        reason: `Error verificando l√≠mites: ${error.message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Registrar uso de mensajes para una empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {Object} usageData - Datos del uso\r\n   * @returns {Promise<Object>} Resultado del registro\r\n   */\r\n  async recordUsage(companyId, usageData) {\r\n    try {\r\n      const {\r\n        messageCount = 1,\r\n        messageType = 'text',\r\n        channel = 'whatsapp',\r\n        cost = null,\r\n        recipientCount = 1,\r\n        metadata = {}\r\n      } = usageData;\r\n\r\n      const company = await this.getCompany(companyId);\r\n      const actualCost = cost || (messageCount * company.message_cost);\r\n\r\n      // Registrar en tabla de uso\r\n      const { data, error } = await supabase\r\n        .from('company_usage_logs')\r\n        .insert({\r\n          company_id: companyId,\r\n          message_count: messageCount,\r\n          message_type: messageType,\r\n          channel,\r\n          cost: actualCost,\r\n          recipient_count: recipientCount,\r\n          metadata,\r\n          created_at: new Date().toISOString()\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      // Actualizar contadores en la tabla de empresas\r\n      await this.updateCompanyUsageCounters(companyId, messageCount, actualCost);\r\n\r\n      // Limpiar cache\r\n      this.clearCache(`company_usage_${companyId}`);\r\n\r\n      return {\r\n        success: true,\r\n        usage: data,\r\n        actualCost,\r\n        message: 'Uso registrado exitosamente'\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error registrando uso:', error);\r\n      return {\r\n        success: false,\r\n        message: `Error registrando uso: ${error.message}`,\r\n        error: error.message\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener estad√≠sticas de uso de una empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {Object} options - Opciones del per√≠odo\r\n   * @returns {Promise<Object>} Estad√≠sticas de uso\r\n   */\r\n  async getCompanyUsageStats(companyId, options = {}) {\r\n    const {\r\n      period = 'month', // day, week, month, year\r\n      startDate = null,\r\n      endDate = null\r\n    } = options;\r\n\r\n    const cacheKey = `company_usage_stats_${companyId}_${JSON.stringify(options)}`;\r\n    const cached = this.getFromCache(cacheKey);\r\n    if (cached) return cached;\r\n\r\n    try {\r\n      // Construir filtro de fechas\r\n      let dateFilter = {};\r\n      if (startDate && endDate) {\r\n        dateFilter = {\r\n          start: startDate,\r\n          end: endDate\r\n        };\r\n      } else {\r\n        dateFilter = this.getDateRange(period);\r\n      }\r\n\r\n      const { data, error } = await supabase\r\n        .from('company_usage_logs')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .gte('created_at', dateFilter.start)\r\n        .lte('created_at', dateFilter.end)\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (error) throw error;\r\n\r\n      // Procesar estad√≠sticas\r\n      const stats = {\r\n        period,\r\n        dateRange: dateFilter,\r\n        totalMessages: data?.reduce((sum, log) => sum + log.message_count, 0) || 0,\r\n        totalCost: data?.reduce((sum, log) => sum + (log.cost || 0), 0) || 0,\r\n        totalRecipients: data?.reduce((sum, log) => sum + log.recipient_count, 0) || 0,\r\n        avgCostPerMessage: 0,\r\n        usageByChannel: {},\r\n        usageByType: {},\r\n        dailyUsage: {},\r\n        weeklyUsage: {},\r\n        monthlyUsage: {}\r\n      };\r\n\r\n      // Calcular promedio\r\n      if (stats.totalMessages > 0) {\r\n        stats.avgCostPerMessage = stats.totalCost / stats.totalMessages;\r\n      }\r\n\r\n      // Agrupar por canal\r\n      data?.forEach(log => {\r\n        if (!stats.usageByChannel[log.channel]) {\r\n          stats.usageByChannel[log.channel] = {\r\n            messages: 0,\r\n            cost: 0,\r\n            recipients: 0\r\n          };\r\n        }\r\n        stats.usageByChannel[log.channel].messages += log.message_count;\r\n        stats.usageByChannel[log.channel].cost += log.cost || 0;\r\n        stats.usageByChannel[log.channel].recipients += log.recipient_count;\r\n      });\r\n\r\n      // Agrupar por tipo\r\n      data?.forEach(log => {\r\n        if (!stats.usageByType[log.message_type]) {\r\n          stats.usageByType[log.message_type] = {\r\n            messages: 0,\r\n            cost: 0\r\n          };\r\n        }\r\n        stats.usageByType[log.message_type].messages += log.message_count;\r\n        stats.usageByType[log.message_type].cost += log.cost || 0;\r\n      });\r\n\r\n      this.setCache(cacheKey, stats);\r\n      return stats;\r\n\r\n    } catch (error) {\r\n      console.error('Error obteniendo estad√≠sticas de uso:', error);\r\n      return {\r\n        period,\r\n        dateRange: this.getDateRange(period),\r\n        totalMessages: 0,\r\n        totalCost: 0,\r\n        totalRecipients: 0,\r\n        avgCostPerMessage: 0,\r\n        usageByChannel: {},\r\n        usageByType: {}\r\n      };\r\n    }\r\n  }\r\n\r\n  // ========================================\r\n  // FACTURACI√ìN Y BILLING\r\n  // ========================================\r\n\r\n  /**\r\n   * Generar factura para una empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {Object} billingOptions - Opciones de facturaci√≥n\r\n   * @returns {Promise<Object>} Factura generada\r\n   */\r\n  async generateInvoice(companyId, billingOptions = {}) {\r\n    try {\r\n      const {\r\n        period = 'monthly',\r\n        startDate = null,\r\n        endDate = null,\r\n        includeDetails = true\r\n      } = billingOptions;\r\n\r\n      const company = await this.getCompany(companyId);\r\n      if (!company) {\r\n        throw new Error('Empresa no encontrada');\r\n      }\r\n\r\n      // Obtener estad√≠sticas de uso del per√≠odo\r\n      const usageStats = await this.getCompanyUsageStats(companyId, {\r\n        period,\r\n        startDate,\r\n        endDate\r\n      });\r\n\r\n      // Calcular detalles de facturaci√≥n\r\n      const invoiceDetails = {\r\n        company_id: companyId,\r\n        company_name: company.name,\r\n        company_rut: company.rut,\r\n        billing_email: company.billing_email,\r\n        period,\r\n        date_range: usageStats.dateRange,\r\n        invoice_number: await this.generateInvoiceNumber(companyId),\r\n        issue_date: new Date().toISOString(),\r\n        due_date: this.calculateDueDate(company.billing_cycle),\r\n        status: 'pending',\r\n        subtotal: usageStats.totalCost,\r\n        tax_rate: 0.19, // 19% IVA en Chile\r\n        tax_amount: usageStats.totalCost * 0.19,\r\n        total_amount: usageStats.totalCost * 1.19,\r\n        currency: 'CLP',\r\n        usage_summary: {\r\n          total_messages: usageStats.totalMessages,\r\n          total_recipients: usageStats.totalRecipients,\r\n          avg_cost_per_message: usageStats.avgCostPerMessage,\r\n          usage_by_channel: usageStats.usageByChannel,\r\n          usage_by_type: usageStats.usageByType\r\n        }\r\n      };\r\n\r\n      // Guardar factura\r\n      const { data: invoice, error } = await supabase\r\n        .from('company_invoices')\r\n        .insert(invoiceDetails)\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      // Generar PDF de la factura (si se solicita)\r\n      let invoicePdf = null;\r\n      if (includeDetails) {\r\n        invoicePdf = await this.generateInvoicePDF(invoice, company, usageStats);\r\n      }\r\n\r\n      console.log(`‚úÖ Factura generada para ${company.name}: ${invoice.invoice_number}`);\r\n\r\n      return {\r\n        success: true,\r\n        invoice,\r\n        invoicePdf,\r\n        message: `Factura ${invoice.invoice_number} generada exitosamente`\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error generando factura:', error);\r\n      return {\r\n        success: false,\r\n        message: `Error generando factura: ${error.message}`,\r\n        error: error.message\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener facturas de una empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {Object} options - Opciones de filtrado\r\n   * @returns {Promise<Array>} Lista de facturas\r\n   */\r\n  async getCompanyInvoices(companyId, options = {}) {\r\n    const {\r\n      status = null,\r\n      limit = 50,\r\n      offset = 0\r\n    } = options;\r\n\r\n    try {\r\n      let query = supabase\r\n        .from('company_invoices')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .order('issue_date', { ascending: false });\r\n\r\n      if (status) {\r\n        query = query.eq('status', status);\r\n      }\r\n\r\n      const { data, error } = await query\r\n        .range(offset, offset + limit - 1);\r\n\r\n      if (error) throw error;\r\n\r\n      return data || [];\r\n\r\n    } catch (error) {\r\n      console.error('Error obteniendo facturas:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  // ========================================\r\n  // M√âTODOS UTILITARIAS\r\n  // ========================================\r\n\r\n  /**\r\n   * Obtener informaci√≥n de una empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @returns {Promise<Object>} Informaci√≥n de la empresa\r\n   */\r\n  async getCompany(companyId) {\r\n    const cacheKey = `company_${companyId}`;\r\n    const cached = this.getFromCache(cacheKey);\r\n    if (cached) return cached;\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('companies')\r\n        .select('*')\r\n        .eq('id', companyId)\r\n        .single();\r\n\r\n      if (error) return null;\r\n\r\n      this.setCache(cacheKey, data);\r\n      return data;\r\n\r\n    } catch (error) {\r\n      console.error('Error obteniendo empresa:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener informaci√≥n de una agencia\r\n   * @param {string} agencyId - ID de la agencia\r\n   * @returns {Promise<Object>} Informaci√≥n de la agencia\r\n   */\r\n  async getAgency(agencyId) {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('agencies')\r\n        .select('*')\r\n        .eq('id', agencyId)\r\n        .single();\r\n\r\n      if (error) return null;\r\n\r\n      return data;\r\n\r\n    } catch (error) {\r\n      console.error('Error obteniendo agencia:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener cantidad de empresas de una agencia\r\n   * @param {string} agencyId - ID de la agencia\r\n   * @returns {Promise<number>} Cantidad de empresas\r\n   */\r\n  async getCompanyCount(agencyId) {\r\n    try {\r\n      const { count, error } = await supabase\r\n        .from('companies')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('agency_id', agencyId);\r\n\r\n      return count || 0;\r\n\r\n    } catch (error) {\r\n      console.error('Error contando empresas:', error);\r\n      return 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Inicializar tracking de uso para una empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @returns {Promise<void>}\r\n   */\r\n  async initializeUsageTracking(companyId) {\r\n    try {\r\n      const today = new Date().toISOString().split('T')[0];\r\n      \r\n      await supabase\r\n        .from('company_usage_counters')\r\n        .insert({\r\n          company_id: companyId,\r\n          date: today,\r\n          daily_count: 0,\r\n          monthly_count: 0,\r\n          daily_cost: 0,\r\n          monthly_cost: 0,\r\n          created_at: new Date().toISOString()\r\n        });\r\n\r\n    } catch (error) {\r\n      console.error('Error inicializando tracking de uso:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Inicializar configuraci√≥n de facturaci√≥n\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {Object} companyData - Datos de la empresa\r\n   * @returns {Promise<void>}\r\n   */\r\n  async initializeBilling(companyId, companyData) {\r\n    try {\r\n      await supabase\r\n        .from('company_billing_config')\r\n        .insert({\r\n          company_id: companyId,\r\n          billing_cycle: companyData.billingCycle || 'monthly',\r\n          billing_email: companyData.billingEmail || companyData.contact_email,\r\n          auto_generate_invoices: true,\r\n          payment_method: 'manual',\r\n          tax_rate: 0.19,\r\n          currency: 'CLP',\r\n          created_at: new Date().toISOString()\r\n        });\r\n\r\n    } catch (error) {\r\n      console.error('Error inicializando facturaci√≥n:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener uso actual de una empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @returns {Promise<Object>} Uso actual\r\n   */\r\n  async getCurrentUsage(companyId) {\r\n    try {\r\n      const today = new Date().toISOString().split('T')[0];\r\n      const currentMonth = today.substring(0, 7); // YYYY-MM\r\n\r\n      // Obtener contador diario\r\n      const { data: dailyData } = await supabase\r\n        .from('company_usage_counters')\r\n        .select('daily_count, daily_cost')\r\n        .eq('company_id', companyId)\r\n        .eq('date', today)\r\n        .single();\r\n\r\n      // Obtener contador mensual\r\n      const { data: monthlyData } = await supabase\r\n        .from('company_usage_counters')\r\n        .select('monthly_count, monthly_cost')\r\n        .eq('company_id', companyId)\r\n        .eq('date', currentMonth)\r\n        .single();\r\n\r\n      return {\r\n        daily_count: dailyData?.daily_count || 0,\r\n        daily_cost: dailyData?.daily_cost || 0,\r\n        monthly_count: monthlyData?.monthly_count || 0,\r\n        monthly_cost: monthlyData?.monthly_cost || 0\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error obteniendo uso actual:', error);\r\n      return {\r\n        daily_count: 0,\r\n        daily_cost: 0,\r\n        monthly_count: 0,\r\n        monthly_cost: 0\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Actualizar contadores de uso de una empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {number} messageCount - Cantidad de mensajes\r\n   * @param {number} cost - Costo total\r\n   * @returns {Promise<void>}\r\n   */\r\n  async updateCompanyUsageCounters(companyId, messageCount, cost) {\r\n    try {\r\n      const today = new Date().toISOString().split('T')[0];\r\n      const currentMonth = today.substring(0, 7); // YYYY-MM\r\n\r\n      // Actualizar contador diario\r\n      await supabase.rpc('increment_daily_usage', {\r\n        p_company_id: companyId,\r\n        p_date: today,\r\n        p_message_count: messageCount,\r\n        p_cost: cost\r\n      });\r\n\r\n      // Actualizar contador mensual\r\n      await supabase.rpc('increment_monthly_usage', {\r\n        p_company_id: companyId,\r\n        p_month: currentMonth,\r\n        p_message_count: messageCount,\r\n        p_cost: cost\r\n      });\r\n\r\n    } catch (error) {\r\n      console.error('Error actualizando contadores:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generar n√∫mero de factura √∫nico\r\n   * @param {string} companyId - ID de la empresa\r\n   * @returns {Promise<string>} N√∫mero de factura\r\n   */\r\n  async generateInvoiceNumber(companyId) {\r\n    try {\r\n      const { data: company } = await supabase\r\n        .from('companies')\r\n        .select('name')\r\n        .eq('id', companyId)\r\n        .single();\r\n\r\n      const companyCode = company?.name?.substring(0, 3).toUpperCase() || 'EMP';\r\n      const timestamp = new Date().toISOString().replace(/[-:]/g, '').substring(0, 12);\r\n      \r\n      return `INV-${companyCode}-${timestamp}`;\r\n\r\n    } catch (error) {\r\n      console.error('Error generando n√∫mero de factura:', error);\r\n      return `INV-${Date.now()}`;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Calcular fecha de vencimiento\r\n   * @param {string} billingCycle - Ciclo de facturaci√≥n\r\n   * @returns {string} Fecha de vencimiento\r\n   */\r\n  calculateDueDate(billingCycle) {\r\n    const now = new Date();\r\n    \r\n    switch (billingCycle) {\r\n      case 'weekly':\r\n        return new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString();\r\n      case 'biweekly':\r\n        return new Date(now.getTime() + 14 * 24 * 60 * 60 * 1000).toISOString();\r\n      case 'monthly':\r\n        return new Date(now.getFullYear(), now.getMonth() + 1, 15).toISOString();\r\n      case 'quarterly':\r\n        return new Date(now.getFullYear(), now.getMonth() + 3, 15).toISOString();\r\n      default:\r\n        return new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generar PDF de factura (placeholder)\r\n   * @param {Object} invoice - Datos de la factura\r\n   * @param {Object} company - Datos de la empresa\r\n   * @param {Object} usageStats - Estad√≠sticas de uso\r\n   * @returns {Promise<string>} URL del PDF generado\r\n   */\r\n  async generateInvoicePDF(invoice, company, usageStats) {\r\n    // Placeholder para generaci√≥n de PDF\r\n    // En una implementaci√≥n real, aqu√≠ se usar√≠a una librer√≠a como jsPDF o Puppeteer\r\n    return `https://api.ejemplo.com/invoices/${invoice.id}/pdf`;\r\n  }\r\n\r\n  /**\r\n   * Obtener rango de fechas\r\n   * @param {string} period - Per√≠odo (day, week, month, year)\r\n   * @returns {Object} Rango de fechas\r\n   */\r\n  getDateRange(period) {\r\n    const now = new Date();\r\n    const end = now.toISOString();\r\n    \r\n    let start;\r\n    switch (period) {\r\n      case 'day':\r\n        start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();\r\n        break;\r\n      case 'week':\r\n        start = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString();\r\n        break;\r\n      case 'month':\r\n        start = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();\r\n        break;\r\n      case 'year':\r\n        start = new Date(now.getFullYear(), 0, 1).toISOString();\r\n        break;\r\n      default:\r\n        start = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();\r\n    }\r\n\r\n    return { start, end };\r\n  }\r\n\r\n  // ========================================\r\n  // M√âTODOS DE CACHE\r\n  // ========================================\r\n\r\n  getFromCache(key) {\r\n    const cached = this.cache.get(key);\r\n    if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {\r\n      return cached.data;\r\n    }\r\n    this.cache.delete(key);\r\n    return null;\r\n  }\r\n\r\n  setCache(key, data) {\r\n    this.cache.set(key, {\r\n      data,\r\n      timestamp: Date.now()\r\n    });\r\n  }\r\n\r\n  clearCache(key = null) {\r\n    if (key) {\r\n      this.cache.delete(key);\r\n    } else {\r\n      this.cache.clear();\r\n    }\r\n  }\r\n}\r\n\r\n// Crear instancia global del servicio\r\nconst multiCompanyManagementService = new MultiCompanyManagementService();\r\n\r\nexport default multiCompanyManagementService;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\multiWhatsAppService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'whatsappComplianceService' is defined but never used.","line":18,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":33},{"ruleId":"no-unused-vars","severity":1,"message":"'results' is assigned a value but never used.","line":344,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":344,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Servicio Multi-WhatsApp para Agencias\r\n *\r\n * Este servicio permite gestionar m√∫ltiples n√∫meros de WhatsApp,\r\n * uno por cada empresa/cliente. Ideal para agencias de comunicaci√≥n.\r\n *\r\n * Caracter√≠sticas principales:\r\n * - M√∫ltiples n√∫meros de WhatsApp por empresa\r\n * - Selecci√≥n autom√°tica de n√∫mero por empresa\r\n * - Rate limiting individual por n√∫mero\r\n * - Estad√≠sticas por empresa y por n√∫mero\r\n * - Plantillas por empresa\r\n * - Logs detallados de uso\r\n * - Cumplimiento con pol√≠ticas de WhatsApp Business 2024-2025\r\n */\r\n\r\nimport { supabase } from '../lib/supabase.js';\r\nimport whatsappComplianceService from './whatsappComplianceService.js';\r\n\r\nclass MultiWhatsAppService {\r\n  constructor() {\r\n    this.baseUrl = 'https://graph.facebook.com/v18.0'\r\n    this.cache = new Map()\r\n    this.cacheTimeout = 5 * 60 * 1000 // 5 minutos\r\n  }\r\n\r\n  // ========================================\r\n  // M√âTODOS DE CONFIGURACI√ìN\r\n  // ========================================\r\n\r\n  /**\r\n   * Configurar WhatsApp para una empresa espec√≠fica\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {Object} config - Configuraci√≥n de WhatsApp\r\n   * @returns {Promise<Object>} Resultado de la configuraci√≥n\r\n   */\r\n  async configureWhatsAppForCompany(companyId, config) {\r\n    try {\r\n      console.log(`üîß Configurando WhatsApp para empresa ${companyId}`);\r\n      \r\n      // Validar que la empresa existe\r\n      const { data: company, error: companyError } = await supabase\r\n        .from('companies')\r\n        .select('id, name')\r\n        .eq('id', companyId)\r\n        .single();\r\n\r\n      if (companyError || !company) {\r\n        throw new Error(`Empresa ${companyId} no encontrada`);\r\n      }\r\n\r\n      // Probar conexi√≥n con la API de Meta\r\n      const testResult = await this.testWhatsAppConnection(config);\r\n      \r\n      if (!testResult.success) {\r\n        throw new Error(`Error de conexi√≥n: ${testResult.error}`);\r\n      }\r\n\r\n      // Guardar configuraci√≥n en la base de datos\r\n      const { data: whatsappConfig, error: configError } = await supabase\r\n        .from('whatsapp_configs')\r\n        .upsert({\r\n          company_id: companyId,\r\n          access_token: config.accessToken,\r\n          phone_number_id: config.phoneNumberId,\r\n          webhook_verify_token: config.webhookVerifyToken || null,\r\n          display_phone_number: testResult.phoneInfo.display_phone_number,\r\n          verified_name: testResult.phoneInfo.verified_name,\r\n          quality_rating: testResult.phoneInfo.quality_rating,\r\n          is_active: true,\r\n          test_mode: config.testMode || false,\r\n          is_default: config.isDefault || false,\r\n          daily_limit: config.dailyLimit || 1000,\r\n          monthly_limit: config.monthlyLimit || 30000,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (configError) {\r\n        throw new Error(`Error guardando configuraci√≥n: ${configError.message}`);\r\n      }\r\n\r\n      // Actualizar informaci√≥n en la tabla de empresas\r\n      await supabase\r\n        .from('companies')\r\n        .update({\r\n          whatsapp_phone_number: testResult.phoneInfo.display_phone_number,\r\n          whatsapp_configured: true,\r\n          whatsapp_business_name: testResult.phoneInfo.verified_name,\r\n          whatsapp_status: 'connected',\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('id', companyId);\r\n\r\n      // Limpiar cache\r\n      this.clearCache(`whatsapp_config_${companyId}`);\r\n      this.clearCache('all_whatsapp_configs');\r\n\r\n      console.log(`‚úÖ WhatsApp configurado exitosamente para ${company.name}`);\r\n      \r\n      return {\r\n        success: true,\r\n        message: `WhatsApp configurado exitosamente para ${company.name}`,\r\n        config: whatsappConfig,\r\n        phoneInfo: testResult.phoneInfo\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error(`‚ùå Error configurando WhatsApp para empresa ${companyId}:`, error);\r\n      return {\r\n        success: false,\r\n        message: `Error configurando WhatsApp: ${error.message}`,\r\n        error: error.message\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Eliminar configuraci√≥n de WhatsApp para una empresa\r\n   * @param {number} companyId - ID de la empresa\r\n   * @returns {Promise<Object>} Resultado de la eliminaci√≥n\r\n   */\r\n  async deleteWhatsAppConfiguration(companyId) {\r\n    try {\r\n      console.log(`üóëÔ∏è Eliminando configuraci√≥n WhatsApp para empresa ${companyId}`);\r\n      \r\n      // Verificar que la empresa existe\r\n      const { data: company, error: companyError } = await supabase\r\n        .from('companies')\r\n        .select('id, name')\r\n        .eq('id', companyId)\r\n        .single();\r\n\r\n      if (companyError || !company) {\r\n        throw new Error(`Empresa ${companyId} no encontrada`);\r\n      }\r\n\r\n      // Desactivar configuraci√≥n en lugar de eliminar (para mantener historial)\r\n      const { error: updateError } = await supabase\r\n        .from('whatsapp_configs')\r\n        .update({\r\n          is_active: false,\r\n          deactivated_at: new Date().toISOString(),\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('company_id', companyId);\r\n\r\n      if (updateError) {\r\n        throw new Error(`Error desactivando configuraci√≥n: ${updateError.message}`);\r\n      }\r\n\r\n      // Actualizar informaci√≥n en la tabla de empresas\r\n      await supabase\r\n        .from('companies')\r\n        .update({\r\n          whatsapp_phone_number: null,\r\n          whatsapp_configured: false,\r\n          whatsapp_business_name: null,\r\n          whatsapp_status: 'disconnected',\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('id', companyId);\r\n\r\n      // Limpiar cache\r\n      this.clearCache(`whatsapp_config_${companyId}`);\r\n      this.clearCache('all_whatsapp_configs');\r\n\r\n      console.log(`‚úÖ Configuraci√≥n WhatsApp eliminada para ${company.name}`);\r\n      \r\n      return {\r\n        success: true,\r\n        message: `Configuraci√≥n WhatsApp eliminada exitosamente para ${company.name}`\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error(`‚ùå Error eliminando configuraci√≥n WhatsApp para empresa ${companyId}:`, error);\r\n      return {\r\n        success: false,\r\n        message: `Error eliminando configuraci√≥n: ${error.message}`,\r\n        error: error.message\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener configuraci√≥n de WhatsApp para una empresa\r\n   * @param {number} companyId - ID de la empresa\r\n   * @returns {Promise<Object>} Configuraci√≥n de WhatsApp\r\n   */\r\n  async getWhatsAppConfigByCompany(companyId) {\r\n    const cacheKey = `whatsapp_config_${companyId}`;\r\n    const cached = this.getFromCache(cacheKey);\r\n    if (cached) return cached;\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('whatsapp_configs')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .eq('is_active', true)\r\n        .single();\r\n\r\n      if (error) {\r\n        console.warn(`‚ö†Ô∏è No hay configuraci√≥n de WhatsApp para empresa ${companyId}`);\r\n        return null;\r\n      }\r\n\r\n      this.setCache(cacheKey, data);\r\n      return data;\r\n\r\n    } catch (error) {\r\n      console.error(`Error obteniendo configuraci√≥n WhatsApp para empresa ${companyId}:`, error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener todas las configuraciones de WhatsApp activas\r\n   * @returns {Promise<Array>} Lista de configuraciones activas\r\n   */\r\n  async getAllWhatsAppConfigs() {\r\n    const cacheKey = 'all_whatsapp_configs';\r\n    const cached = this.getFromCache(cacheKey);\r\n    if (cached) return cached;\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('active_whatsapp_configs')\r\n        .select('*')\r\n        .order('company_name', { ascending: true });\r\n\r\n      if (error) throw error;\r\n\r\n      this.setCache(cacheKey, data);\r\n      return data || [];\r\n\r\n    } catch (error) {\r\n      console.error('Error obteniendo todas las configuraciones de WhatsApp:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener configuraci√≥n por defecto (para agencias)\r\n   * @returns {Promise<Object>} Configuraci√≥n por defecto\r\n   */\r\n  async getDefaultWhatsAppConfig() {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('whatsapp_configs')\r\n        .select('*')\r\n        .eq('is_default', true)\r\n        .eq('is_active', true)\r\n        .single();\r\n\r\n      if (error) {\r\n        console.warn('‚ö†Ô∏è No hay configuraci√≥n de WhatsApp por defecto');\r\n        return null;\r\n      }\r\n\r\n      return data;\r\n\r\n    } catch (error) {\r\n      console.error('Error obteniendo configuraci√≥n por defecto:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // ========================================\r\n  // M√âTODOS DE ENV√çO DE MENSAJES\r\n  // ========================================\r\n\r\n  /**\r\n   * Enviar mensaje usando el n√∫mero de WhatsApp de una empresa espec√≠fica\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {Object} params - Par√°metros del mensaje\r\n   * @returns {Promise<Object>} Resultado del env√≠o\r\n   */\r\n  async sendMessageByCompany(companyId, params) {\r\n    try {\r\n      console.log(`üì§ Enviando mensaje WhatsApp para empresa ${companyId}`);\r\n      \r\n      // Obtener configuraci√≥n de la empresa\r\n      const config = await this.getWhatsAppConfigByCompany(companyId);\r\n      \r\n      if (!config) {\r\n        throw new Error(`No hay configuraci√≥n de WhatsApp para la empresa ${companyId}`);\r\n      }\r\n\r\n      // Verificar l√≠mites de uso\r\n      const limitCheck = await this.checkUsageLimits(config);\r\n      if (!limitCheck.canSend) {\r\n        throw new Error(`L√≠mite de uso excedido: ${limitCheck.reason}`);\r\n      }\r\n\r\n      // Enviar mensaje\r\n      const result = await this.sendMessage(config, params);\r\n\r\n      // Actualizar uso y registrar log\r\n      if (result.success) {\r\n        await this.updateUsage(config.id, 1);\r\n        await this.logWhatsAppMessage(config.company_id, config.id, {\r\n          ...result,\r\n          recipient_phone: result.recipientPhone,\r\n          message_content: params.message,\r\n          message_type: params.messageType || 'text'\r\n        });\r\n      }\r\n\r\n      return {\r\n        ...result,\r\n        companyId,\r\n        companyName: config.company_name\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error(`‚ùå Error enviando mensaje para empresa ${companyId}:`, error);\r\n      return {\r\n        success: false,\r\n        message: `Error enviando mensaje: ${error.message}`,\r\n        error: error.message,\r\n        companyId\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enviar mensaje masivo a m√∫ltiples empresas\r\n   * @param {Object} params - Par√°metros del env√≠o\r\n   * @returns {Promise<Object>} Resultado del env√≠o\r\n   */\r\n  async sendBulkMessageByCompanies(params) {\r\n    const {\r\n      companies, // Array de {companyId, recipients}\r\n      message,\r\n      templateName = null,\r\n      templateLanguage = 'es',\r\n      components = [],\r\n      messageType = 'text',\r\n      delayBetweenMessages = 1000\r\n    } = params;\r\n\r\n    const results = [];\r\n    const totalResults = {\r\n      totalCompanies: companies.length,\r\n      successfulCompanies: 0,\r\n      failedCompanies: 0,\r\n      totalRecipients: 0,\r\n      totalSuccessful: 0,\r\n      totalFailed: 0,\r\n      results: []\r\n    };\r\n\r\n    for (const companyData of companies) {\r\n      try {\r\n        console.log(`üì§ Procesando empresa ${companyData.companyId}...`);\r\n        \r\n        const result = await this.sendMessageByCompany(companyData.companyId, {\r\n          recipients: companyData.recipients,\r\n          message,\r\n          templateName,\r\n          templateLanguage,\r\n          components,\r\n          messageType\r\n        });\r\n\r\n        if (result.success) {\r\n          totalResults.successfulCompanies++;\r\n          totalResults.totalSuccessful += result.successfulDeliveries || 0;\r\n        } else {\r\n          totalResults.failedCompanies++;\r\n        }\r\n\r\n        totalResults.totalRecipients += result.recipientCount || 0;\r\n        totalResults.totalFailed += result.failedDeliveries || 0;\r\n\r\n        totalResults.results.push({\r\n          companyId: companyData.companyId,\r\n          result\r\n        });\r\n\r\n        // Delay entre empresas\r\n        if (delayBetweenMessages > 0) {\r\n          await new Promise(resolve => setTimeout(resolve, delayBetweenMessages));\r\n        }\r\n\r\n      } catch (error) {\r\n        console.error(`Error procesando empresa ${companyData.companyId}:`, error);\r\n        totalResults.failedCompanies++;\r\n        totalResults.results.push({\r\n          companyId: companyData.companyId,\r\n          error: error.message\r\n        });\r\n      }\r\n    }\r\n\r\n    return {\r\n      success: totalResults.successfulCompanies > 0,\r\n      message: `Env√≠o completado: ${totalResults.successfulCompanies}/${totalResults.totalCompanies} empresas exitosas`,\r\n      ...totalResults\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Enviar mensaje usando configuraci√≥n espec√≠fica\r\n   * @param {Object} config - Configuraci√≥n de WhatsApp\r\n   * @param {Object} params - Par√°metros del mensaje\r\n   * @returns {Promise<Object>} Resultado del env√≠o\r\n   */\r\n  async sendMessage(config, params) {\r\n    const {\r\n      recipients, // Array de n√∫meros de tel√©fono\r\n      message,\r\n      templateName = null,\r\n      templateLanguage = 'es',\r\n      components = [],\r\n      messageType = 'text'\r\n    } = params;\r\n\r\n    if (!recipients || recipients.length === 0) {\r\n      throw new Error('No hay destinatarios especificados');\r\n    }\r\n\r\n    const results = [];\r\n\r\n    for (const recipient of recipients) {\r\n      try {\r\n        const result = await this.sendSingleMessage(config, {\r\n          to: recipient,\r\n          message,\r\n          templateName,\r\n          templateLanguage,\r\n          components,\r\n          messageType\r\n        });\r\n\r\n        results.push({\r\n          recipient,\r\n          success: result.success,\r\n          messageId: result.messageId,\r\n          error: result.error\r\n        });\r\n\r\n        // Rate limiting entre mensajes\r\n        if (config.message_cooldown_seconds > 0) {\r\n          await new Promise(resolve => \r\n            setTimeout(resolve, config.message_cooldown_seconds * 1000)\r\n          );\r\n        }\r\n\r\n      } catch (error) {\r\n        results.push({\r\n          recipient,\r\n          success: false,\r\n          error: error.message\r\n        });\r\n      }\r\n    }\r\n\r\n    const successful = results.filter(r => r.success).length;\r\n    const failed = results.filter(r => !r.success).length;\r\n\r\n    return {\r\n      success: successful > 0,\r\n      totalRecipients: recipients.length,\r\n      successful,\r\n      failed,\r\n      successRate: (successful / recipients.length) * 100,\r\n      results\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Enviar mensaje individual\r\n   * @param {Object} config - Configuraci√≥n de WhatsApp\r\n   * @param {Object} params - Par√°metros del mensaje\r\n   * @returns {Promise<Object>} Resultado del env√≠o\r\n   */\r\n  async sendSingleMessage(config, params) {\r\n    const {\r\n      to,\r\n      message,\r\n      templateName = null,\r\n      templateLanguage = 'es',\r\n      components = [],\r\n      messageType = 'text'\r\n    } = params;\r\n\r\n    // Formatear n√∫mero de tel√©fono\r\n    const formattedPhone = this.formatPhoneNumber(to);\r\n\r\n    let payload = {\r\n      messaging_product: 'whatsapp',\r\n      to: formattedPhone\r\n    };\r\n\r\n    // Construir payload seg√∫n tipo de mensaje\r\n    if (messageType === 'template' && templateName) {\r\n      payload.type = 'template';\r\n      payload.template = {\r\n        name: templateName,\r\n        language: { code: templateLanguage },\r\n        components: components\r\n      };\r\n    } else {\r\n      payload.type = 'text';\r\n      payload.text = {\r\n        body: message\r\n      };\r\n    }\r\n\r\n    if (config.test_mode) {\r\n      // Modo prueba\r\n      return {\r\n        success: true,\r\n        messageId: `test_${Date.now()}`,\r\n        recipientPhone: formattedPhone,\r\n        testMode: true,\r\n        message: 'Mensaje de WhatsApp enviado (modo prueba)'\r\n      };\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(`${this.baseUrl}/${config.phone_number_id}/messages`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${config.access_token}`\r\n        },\r\n        body: JSON.stringify(payload)\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorData = await response.json();\r\n        throw new Error(`Error ${response.status}: ${errorData.error?.message || response.statusText}`);\r\n      }\r\n\r\n      const result = await response.json();\r\n\r\n      return {\r\n        success: true,\r\n        messageId: result.messages[0].id,\r\n        recipientPhone: formattedPhone,\r\n        status: result.messages[0].message_status,\r\n        timestamp: new Date().toISOString(),\r\n        result\r\n      };\r\n\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Error al enviar mensaje: ${error.message}`,\r\n        error: error.message,\r\n        recipientPhone: formattedPhone\r\n      };\r\n    }\r\n  }\r\n\r\n  // ========================================\r\n  // M√âTODOS DE UTILIDADES\r\n  // ========================================\r\n\r\n  /**\r\n   * Probar conexi√≥n con WhatsApp\r\n   * @param {Object} config - Configuraci√≥n de WhatsApp\r\n   * @returns {Promise<Object>} Resultado de la prueba\r\n   */\r\n  async testWhatsAppConnection(config) {\r\n    try {\r\n      const response = await fetch(`${this.baseUrl}/${config.phoneNumberId}`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Authorization': `Bearer ${config.accessToken}`\r\n        }\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Error ${response.status}: ${response.statusText}`);\r\n      }\r\n\r\n      const phoneInfo = await response.json();\r\n\r\n      return {\r\n        success: true,\r\n        message: 'Conexi√≥n exitosa con WhatsApp Business API',\r\n        phoneInfo: {\r\n          id: phoneInfo.id,\r\n          name: phoneInfo.display_phone_number,\r\n          verifiedName: phoneInfo.verified_name,\r\n          qualityRating: phoneInfo.quality_rating\r\n        }\r\n      };\r\n\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Error de conexi√≥n: ${error.message}`,\r\n        error: error.message\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verificar l√≠mites de uso\r\n   * @param {Object} config - Configuraci√≥n de WhatsApp\r\n   * @returns {Object} Resultado de la verificaci√≥n\r\n   */\r\n  async checkUsageLimits(config) {\r\n    try {\r\n      // Verificar l√≠mite diario\r\n      if (config.current_daily_usage >= config.daily_limit) {\r\n        return {\r\n          canSend: false,\r\n          reason: `L√≠mite diario alcanzado (${config.current_daily_usage}/${config.daily_limit})`\r\n        };\r\n      }\r\n\r\n      // Verificar l√≠mite mensual\r\n      if (config.current_monthly_usage >= config.monthly_limit) {\r\n        return {\r\n          canSend: false,\r\n          reason: `L√≠mite mensual alcanzado (${config.current_monthly_usage}/${config.monthly_limit})`\r\n        };\r\n      }\r\n\r\n      return {\r\n        canSend: true,\r\n        dailyRemaining: config.daily_limit - config.current_daily_usage,\r\n        monthlyRemaining: config.monthly_limit - config.current_monthly_usage\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error verificando l√≠mites de uso:', error);\r\n      return {\r\n        canSend: false,\r\n        reason: `Error verificando l√≠mites: ${error.message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Actualizar uso de mensajes\r\n   * @param {number} configId - ID de la configuraci√≥n\r\n   * @param {number} count - Cantidad de mensajes enviados\r\n   * @returns {Promise<void>}\r\n   */\r\n  async updateUsage(configId, count) {\r\n    try {\r\n      await supabase\r\n        .from('whatsapp_configs')\r\n        .update({\r\n          current_daily_usage: supabase.raw(`current_daily_usage + ${count}`),\r\n          current_monthly_usage: supabase.raw(`current_monthly_usage + ${count}`),\r\n          last_message_at: new Date().toISOString(),\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('id', configId);\r\n\r\n    } catch (error) {\r\n      console.error('Error actualizando uso de WhatsApp:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Registrar log de mensaje\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {number} configId - ID de la configuraci√≥n\r\n   * @param {Object} messageData - Datos del mensaje\r\n   * @returns {Promise<void>}\r\n   */\r\n  async logWhatsAppMessage(companyId, configId, messageData) {\r\n    try {\r\n      await supabase\r\n        .from('whatsapp_logs')\r\n        .insert({\r\n          company_id: companyId,\r\n          whatsapp_config_id: configId,\r\n          message_id: messageData.messageId,\r\n          recipient_phone: messageData.recipientPhone,\r\n          message_content: messageData.message_content,\r\n          message_type: messageData.message_type,\r\n          status: messageData.status || 'sent',\r\n          cost: 0.0525, // Costo est√°ndar por mensaje\r\n          sent_at: new Date().toISOString()\r\n        });\r\n\r\n    } catch (error) {\r\n      console.error('Error registrando log de WhatsApp:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Formatear n√∫mero de tel√©fono para WhatsApp\r\n   * @param {string} phone - N√∫mero de tel√©fono\r\n   * @returns {string} N√∫mero formateado\r\n   */\r\n  formatPhoneNumber(phone) {\r\n    // Eliminar caracteres no num√©ricos excepto +\r\n    let formatted = phone.replace(/[^d+]/g, '');\r\n    \r\n    // Asegurar que comience con +\r\n    if (!formatted.startsWith('+')) {\r\n      // Si no tiene c√≥digo de pa√≠s, asumir Chile (+56)\r\n      if (formatted.startsWith('9') && formatted.length === 9) {\r\n        formatted = '+56' + formatted;\r\n      } else {\r\n        formatted = '+' + formatted;\r\n      }\r\n    }\r\n    \r\n    return formatted;\r\n  }\r\n\r\n  /**\r\n   * Obtener estad√≠sticas de uso por empresa\r\n   * @param {number} companyId - ID de la empresa (opcional)\r\n   * @returns {Promise<Object>} Estad√≠sticas de uso\r\n   */\r\n  async getUsageStats(companyId = null) {\r\n    try {\r\n      let query = supabase\r\n        .from('whatsapp_logs')\r\n        .select(`\r\n          *,\r\n          companies:company_id (\r\n            id,\r\n            name\r\n          )\r\n        `);\r\n\r\n      if (companyId) {\r\n        query = query.eq('company_id', companyId);\r\n      }\r\n\r\n      const { data, error } = await query\r\n        .order('sent_at', { ascending: false })\r\n        .limit(1000);\r\n\r\n      if (error) throw error;\r\n\r\n      // Procesar estad√≠sticas\r\n      const stats = {\r\n        totalMessages: data?.length || 0,\r\n        sentMessages: data?.filter(log => log.status === 'sent').length || 0,\r\n        deliveredMessages: data?.filter(log => log.status === 'delivered').length || 0,\r\n        readMessages: data?.filter(log => log.status === 'read').length || 0,\r\n        failedMessages: data?.filter(log => log.status === 'failed').length || 0,\r\n        totalCost: data?.reduce((sum, log) => sum + (log.cost || 0), 0) || 0,\r\n        byCompany: {},\r\n        byStatus: {},\r\n        recentMessages: data?.slice(0, 10) || []\r\n      };\r\n\r\n      // Agrupar por empresa\r\n      data?.forEach(log => {\r\n        const companyName = log.companies?.name || 'Desconocida';\r\n        if (!stats.byCompany[companyName]) {\r\n          stats.byCompany[companyName] = {\r\n            total: 0,\r\n            sent: 0,\r\n            delivered: 0,\r\n            read: 0,\r\n            failed: 0,\r\n            cost: 0\r\n          };\r\n        }\r\n        \r\n        stats.byCompany[companyName].total++;\r\n        stats.byCompany[companyName][log.status]++;\r\n        stats.byCompany[companyName].cost += log.cost || 0;\r\n      });\r\n\r\n      // Agrupar por estado\r\n      data?.forEach(log => {\r\n        if (!stats.byStatus[log.status]) {\r\n          stats.byStatus[log.status] = 0;\r\n        }\r\n        stats.byStatus[log.status]++;\r\n      });\r\n\r\n      return stats;\r\n\r\n    } catch (error) {\r\n      console.error('Error obteniendo estad√≠sticas de uso:', error);\r\n      return {\r\n        totalMessages: 0,\r\n        sentMessages: 0,\r\n        deliveredMessages: 0,\r\n        readMessages: 0,\r\n        failedMessages: 0,\r\n        totalCost: 0,\r\n        byCompany: {},\r\n        byStatus: {},\r\n        recentMessages: []\r\n      };\r\n    }\r\n  }\r\n\r\n  // ========================================\r\n  // M√âTODOS DE CACHE\r\n  // ========================================\r\n\r\n  getFromCache(key) {\r\n    const cached = this.cache.get(key);\r\n    if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {\r\n      return cached.data;\r\n    }\r\n    this.cache.delete(key);\r\n    return null;\r\n  }\r\n\r\n  setCache(key, data) {\r\n    this.cache.set(key, {\r\n      data,\r\n      timestamp: Date.now()\r\n    });\r\n  }\r\n\r\n  clearCache(key = null) {\r\n    if (key) {\r\n      this.cache.delete(key);\r\n    } else {\r\n      this.cache.clear();\r\n    }\r\n  }\r\n}\r\n\r\n// Crear instancia global del servicio\r\nconst multiWhatsAppService = new MultiWhatsAppService();\r\n\r\nexport default multiWhatsAppService;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\organizedDatabaseService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\realTimeGamificationService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\realTimeStatsService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\templateService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\trendsAnalysisService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'tableCheck' is assigned a value but never used.","line":142,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":142,"endColumn":31},{"ruleId":"no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":415,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":415,"endColumn":21},{"ruleId":"no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":459,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":459,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from '../lib/supabase.js';\r\nimport groqService from './groqService.js';\r\n\r\nclass TrendsAnalysisService {\r\n  constructor() {\r\n    this.cache = new Map();\r\n    this.cacheTimeout = 60 * 60 * 1000; // 1 hora de cache\r\n  }\r\n\r\n  // ========================================\r\n  // M√âTODOS PRINCIPALES DE AN√ÅLISIS\r\n  // ========================================\r\n\r\n  // Generar insights para una empresa espec√≠fica usando datos reales\r\n  async generateCompanyInsights(companyIdentifier, forceRegenerate = false, isId = false) {\r\n    try {\r\n      console.log(`üîç Generando insights para ${companyIdentifier}...`);\r\n      \r\n      // Obtener datos reales de la empresa - soportar tanto ID como nombre\r\n      let companyData;\r\n      if (isId) {\r\n        // Si es ID, buscar directamente por ID\r\n        const { data, error } = await supabase\r\n          .from('companies')\r\n          .select('*')\r\n          .eq('id', companyIdentifier)\r\n          .maybeSingle();\r\n        \r\n        if (error) throw error;\r\n        companyData = data;\r\n      } else {\r\n        // Si es nombre, usar el m√©todo existente\r\n        companyData = await this.getCompanyRealData(companyIdentifier);\r\n      }\r\n      \r\n      if (!companyData) {\r\n        throw new Error(`Empresa ${companyIdentifier} no encontrada`);\r\n      }\r\n\r\n      // Verificar si ya existen insights recientes\r\n      if (!forceRegenerate) {\r\n        const existingInsights = await this.getExistingInsights(companyData.name);\r\n        if (existingInsights && existingInsights.length > 0) {\r\n          console.log(`‚úÖ Usando insights existentes para ${companyData.name}`);\r\n          const formattedInsights = this.formatInsights(existingInsights);\r\n          \r\n          // ‚úÖ CORRECCI√ìN: Tambi√©n obtener y retornar datos completos con insights existentes\r\n          const communicationMetrics = await this.getCommunicationMetrics(companyData.id);\r\n          const employeeData = await this.getEmployeeData(companyData.id);\r\n          \r\n          return {\r\n            ...formattedInsights,\r\n            communicationMetrics,\r\n            employeeData,\r\n            companyData\r\n          };\r\n        }\r\n      }\r\n\r\n      // Obtener m√©tricas de comunicaci√≥n reales\r\n      const communicationMetrics = await this.getCommunicationMetrics(companyData.id);\r\n      \r\n      // Obtener datos de empleados\r\n      const employeeData = await this.getEmployeeData(companyData.id);\r\n      \r\n      // Generar insights usando Groq AI con datos reales\r\n      const insights = await this.generateInsightsWithAI({\r\n        companyName: companyData.name,\r\n        companyData,\r\n        communicationMetrics,\r\n        employeeData\r\n      });\r\n\r\n      // Guardar insights en la base de datos\r\n      await this.saveInsights(companyData.name, insights);\r\n\r\n      console.log(`‚úÖ Insights generados y guardados para ${companyData.name}`);\r\n      \r\n      // ‚úÖ CORRECCI√ìN: Retornar TODOS los datos necesarios para el componente\r\n      return {\r\n        ...insights,\r\n        communicationMetrics,\r\n        employeeData,\r\n        companyData\r\n      };\r\n    } catch (error) {\r\n      console.error(`‚ùå Error generando insights para ${companyIdentifier}:`, error);\r\n      return this.getFallbackInsights(companyIdentifier);\r\n    }\r\n  }\r\n\r\n  // Obtener insights existentes de la base de datos\r\n  async getExistingInsights(companyName) {\r\n    try {\r\n      const { data: insights, error } = await supabase\r\n        .from('company_insights')\r\n        .select('*')\r\n        .eq('company_name', companyName)\r\n        .eq('is_active', true)\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (error) throw error;\r\n      \r\n      // Verificar si los insights son recientes (menos de 24 horas)\r\n      const now = new Date();\r\n      const validInsights = insights?.filter(insight => {\r\n        const createdAt = new Date(insight.created_at);\r\n        const hoursDiff = (now - createdAt) / (1000 * 60 * 60);\r\n        return hoursDiff < 24;\r\n      }) || [];\r\n\r\n      return validInsights;\r\n    } catch (error) {\r\n      console.error('Error obteniendo insights existentes:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  // Obtener datos reales de la empresa\r\n  async getCompanyRealData(companyName) {\r\n    try {\r\n      const { data: company, error } = await supabase\r\n        .from('companies')\r\n        .select('*')\r\n        .ilike('name', `%${companyName}%`)\r\n        .maybeSingle();\r\n\r\n      if (error) throw error;\r\n      return company;\r\n    } catch (error) {\r\n      console.error('Error obteniendo datos de empresa:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // Obtener m√©tricas de comunicaci√≥n reales\r\n  async getCommunicationMetrics(companyId) {\r\n    try {\r\n      console.log(`üîç DEBUG: Obteniendo m√©tricas de comunicaci√≥n para companyId: ${companyId}`);\r\n      \r\n      // Verificar si la tabla communication_logs existe\r\n      const { data: tableCheck, error: tableError } = await supabase\r\n        .from('communication_logs')\r\n        .select('id')\r\n        .limit(1);\r\n\r\n      console.log('üîç DEBUG: Tabla communication_logs existe:', !tableError ? 'S√ç' : 'NO');\r\n      if (tableError) {\r\n        console.log('üîç DEBUG: Error tabla communication_logs:', tableError.message);\r\n        return this.getEmptyMetrics();\r\n      }\r\n\r\n      const { data: logs, error } = await supabase\r\n        .from('communication_logs')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .order('created_at', { ascending: false })\r\n        .limit(1000);\r\n\r\n      console.log('üîç DEBUG: Logs encontrados para empresa:', logs?.length || 0);\r\n      if (error) {\r\n        console.log('üîç DEBUG: Error obteniendo logs:', error.message);\r\n        throw error;\r\n      }\r\n\r\n      const metrics = {\r\n        totalMessages: logs?.length || 0,\r\n        sentMessages: logs?.filter(log => log.status === 'sent').length || 0,\r\n        readMessages: logs?.filter(log => log.status === 'read').length || 0,\r\n        scheduledMessages: logs?.filter(log => log.status === 'scheduled').length || 0,\r\n        failedMessages: logs?.filter(log => log.status === 'failed').length || 0,\r\n        deliveryRate: 0,\r\n        readRate: 0,\r\n        engagementRate: 0,\r\n        channelUsage: {},\r\n        hourlyActivity: {},\r\n        dailyActivity: {},\r\n        recentActivity: logs?.slice(0, 50) || []\r\n      };\r\n\r\n      console.log('üîç DEBUG: M√©tricas b√°sicas calculadas:', {\r\n        totalMessages: metrics.totalMessages,\r\n        sentMessages: metrics.sentMessages,\r\n        readMessages: metrics.readMessages\r\n      });\r\n\r\n      // Calcular tasas\r\n      if (metrics.totalMessages > 0) {\r\n        metrics.deliveryRate = (metrics.sentMessages / metrics.totalMessages) * 100;\r\n        metrics.readRate = (metrics.readMessages / metrics.totalMessages) * 100;\r\n        metrics.engagementRate = ((metrics.sentMessages + metrics.readMessages) / metrics.totalMessages) * 100;\r\n      }\r\n\r\n      // Analizar patrones temporales y de canales\r\n      logs?.forEach(log => {\r\n        // An√°lisis por canal\r\n        const channel = log.channel_id || 'unknown';\r\n        metrics.channelUsage[channel] = (metrics.channelUsage[channel] || 0) + 1;\r\n\r\n        // An√°lisis por hora\r\n        if (log.created_at) {\r\n          const hour = new Date(log.created_at).getHours();\r\n          metrics.hourlyActivity[hour] = (metrics.hourlyActivity[hour] || 0) + 1;\r\n\r\n          const day = new Date(log.created_at).getDay();\r\n          metrics.dailyActivity[day] = (metrics.dailyActivity[day] || 0) + 1;\r\n        }\r\n      });\r\n\r\n      console.log('üîç DEBUG: M√©tricas finales de comunicaci√≥n:', metrics);\r\n      return metrics;\r\n    } catch (error) {\r\n      console.error('Error obteniendo m√©tricas de comunicaci√≥n:', error);\r\n      console.log('üîç DEBUG: Retornando m√©tricas vac√≠as debido a error');\r\n      return this.getEmptyMetrics();\r\n    }\r\n  }\r\n\r\n  // Obtener datos de empleados\r\n  async getEmployeeData(companyId) {\r\n    try {\r\n      const { data: employees, error } = await supabase\r\n        .from('employees')\r\n        .select('*')\r\n        .eq('company_id', companyId);\r\n\r\n      if (error) throw error;\r\n\r\n      const employeeData = {\r\n        totalEmployees: employees?.length || 0,\r\n        departments: {},\r\n        levels: {},\r\n        workModes: {},\r\n        regions: {},\r\n        positions: {}\r\n      };\r\n\r\n      // Analizar distribuci√≥n de empleados\r\n      employees?.forEach(employee => {\r\n        // Por departamento\r\n        const dept = employee.department || 'unknown';\r\n        employeeData.departments[dept] = (employeeData.departments[dept] || 0) + 1;\r\n\r\n        // Por nivel\r\n        const level = employee.level || 'unknown';\r\n        employeeData.levels[level] = (employeeData.levels[level] || 0) + 1;\r\n\r\n        // Por modo de trabajo\r\n        const workMode = employee.work_mode || 'unknown';\r\n        employeeData.workModes[workMode] = (employeeData.workModes[workMode] || 0) + 1;\r\n\r\n        // Por regi√≥n\r\n        const region = employee.region || 'unknown';\r\n        employeeData.regions[region] = (employeeData.regions[region] || 0) + 1;\r\n\r\n        // Por posici√≥n\r\n        const position = employee.position || 'unknown';\r\n        employeeData.positions[position] = (employeeData.positions[position] || 0) + 1;\r\n      });\r\n\r\n      return employeeData;\r\n    } catch (error) {\r\n      console.error('Error obteniendo datos de empleados:', error);\r\n      return this.getEmptyEmployeeData();\r\n    }\r\n  }\r\n\r\n  // Generar insights usando Groq AI con datos reales\r\n  async generateInsightsWithAI(data) {\r\n    try {\r\n      const { companyName, companyData, communicationMetrics, employeeData } = data;\r\n\r\n      // Construir prompt para Groq con datos reales\r\n      const prompt = this.buildAnalysisPrompt(companyName, companyData, communicationMetrics, employeeData);\r\n\r\n      // Generar insights usando Groq\r\n      const response = await groqService.generateCompletion({\r\n        messages: [\r\n          {\r\n            role: 'system',\r\n            content: `Eres un experto en an√°lisis de comunicaci√≥n empresarial y recursos humanos. \r\n            Analiza los datos proporcionados y genera insights accionables y espec√≠ficos.\r\n            Responde SIEMPRE en formato JSON con la siguiente estructura:\r\n            {\r\n              \"frontInsights\": [\r\n                {\r\n                  \"type\": \"positive|negative|warning|info\",\r\n                  \"title\": \"t√≠tulo breve\",\r\n                  \"description\": \"descripci√≥n detallada y espec√≠fica basada en los datos\"\r\n                }\r\n              ],\r\n              \"backInsights\": [\r\n                {\r\n                  \"type\": \"positive|negative|warning|info\", \r\n                  \"title\": \"t√≠tulo breve\",\r\n                  \"description\": \"descripci√≥n detallada y espec√≠fica basada en los datos\"\r\n                }\r\n              ]\r\n            }\r\n            \r\n            Los insights deben ser:\r\n            1. Basados en los datos reales proporcionados\r\n            2. Espec√≠ficos y accionables\r\n            3. Relevantes para la empresa\r\n            4. En espa√±ol\r\n            5. M√°ximo 5 insights por categor√≠a`\r\n          },\r\n          {\r\n            role: 'user',\r\n            content: prompt\r\n          }\r\n        ],\r\n        temperature: 0.3,\r\n        maxTokens: 2000\r\n      });\r\n\r\n      // Parsear respuesta JSON\r\n      let insights;\r\n      try {\r\n        insights = JSON.parse(response.content);\r\n      } catch (parseError) {\r\n        console.error('Error parseando respuesta de Groq:', parseError);\r\n        insights = this.getFallbackInsights(companyName);\r\n      }\r\n\r\n      return insights;\r\n    } catch (error) {\r\n      console.error('Error generando insights con IA:', error);\r\n      return this.getFallbackInsights(data.companyName);\r\n    }\r\n  }\r\n\r\n  // Construir prompt de an√°lisis con datos reales\r\n  buildAnalysisPrompt(companyName, companyData, communicationMetrics, employeeData) {\r\n    return `\r\nAnaliza los siguientes datos de la empresa \"${companyName}\" y genera insights inteligentes:\r\n\r\nDATOS DE LA EMPRESA:\r\n- Nombre: ${companyName}\r\n- ID: ${companyData.id}\r\n- Industria: ${companyData.industry || 'No especificada'}\r\n- Ubicaci√≥n: ${companyData.location || 'No especificada'}\r\n\r\nM√âTRICAS DE COMUNICACI√ìN:\r\n- Total de mensajes: ${communicationMetrics.totalMessages}\r\n- Mensajes enviados: ${communicationMetrics.sentMessages}\r\n- Mensajes le√≠dos: ${communicationMetrics.readMessages}\r\n- Tasa de entrega: ${communicationMetrics.deliveryRate.toFixed(1)}%\r\n- Tasa de lectura: ${communicationMetrics.readRate.toFixed(1)}%\r\n- Tasa de engagement: ${communicationMetrics.engagementRate.toFixed(1)}%\r\n\r\nUso de canales:\r\n${Object.entries(communicationMetrics.channelUsage).map(([channel, count]) => `- ${channel}: ${count} mensajes`).join('\\n')}\r\n\r\nActividad por hora (m√°s activas):\r\n${Object.entries(communicationMetrics.hourlyActivity)\r\n  .sort(([,a], [,b]) => b - a)\r\n  .slice(0, 5)\r\n  .map(([hour, count]) => `- ${hour}:00 - ${count} mensajes`).join('\\n')}\r\n\r\nDATOS DE EMPLEADOS:\r\n- Total de empleados: ${employeeData.totalEmployees}\r\n- Distribuci√≥n por departamentos:\r\n${Object.entries(employeeData.departments).map(([dept, count]) => `- ${dept}: ${count} empleados`).join('\\n')}\r\n\r\n- Distribuci√≥n por niveles:\r\n${Object.entries(employeeData.levels).map(([level, count]) => `- ${level}: ${count} empleados`).join('\\n')}\r\n\r\n- Modos de trabajo:\r\n${Object.entries(employeeData.workModes).map(([mode, count]) => `- ${mode}: ${count} empleados`).join('\\n')}\r\n\r\nGenera insights espec√≠ficos basados en estos datos. Identifica patrones, tendencias, oportunidades de mejora y puntos fuertes.\r\n`;\r\n  }\r\n\r\n  // Guardar insights en la base de datos\r\n  async saveInsights(companyName, insights) {\r\n    try {\r\n      // Primero, desactivar insights anteriores\r\n      await supabase\r\n        .from('company_insights')\r\n        .update({ is_active: false })\r\n        .eq('company_name', companyName);\r\n\r\n      // Guardar nuevos insights\r\n      const insightsToSave = [];\r\n\r\n      // Guardar front insights\r\n      insights.frontInsights?.forEach((insight, index) => {\r\n        insightsToSave.push({\r\n          company_name: companyName,\r\n          insight_type: 'front',\r\n          insight_category: insight.type,\r\n          title: insight.title,\r\n          description: insight.description,\r\n          confidence_score: 0.8,\r\n          data_source: 'groq_ai_analysis'\r\n        });\r\n      });\r\n\r\n      // Guardar back insights\r\n      insights.backInsights?.forEach((insight, index) => {\r\n        insightsToSave.push({\r\n          company_name: companyName,\r\n          insight_type: 'back',\r\n          insight_category: insight.type,\r\n          title: insight.title,\r\n          description: insight.description,\r\n          confidence_score: 0.8,\r\n          data_source: 'groq_ai_analysis'\r\n        });\r\n      });\r\n\r\n      if (insightsToSave.length > 0) {\r\n        const { data, error } = await supabase\r\n          .from('company_insights')\r\n          .insert(insightsToSave)\r\n          .select();\r\n\r\n        if (error) throw error;\r\n        console.log(`‚úÖ ${insightsToSave.length} insights guardados para ${companyName}`);\r\n      }\r\n\r\n      // Tambi√©n guardar m√©tricas actuales\r\n      await this.saveCompanyMetrics(companyName, insights);\r\n    } catch (error) {\r\n      console.error('Error guardando insights:', error);\r\n    }\r\n  }\r\n\r\n  // Guardar m√©tricas de la empresa\r\n  async saveCompanyMetrics(companyName, insights) {\r\n    try {\r\n      // Obtener datos actualizados de la empresa\r\n      const companyData = await this.getCompanyRealData(companyName);\r\n      if (!companyData) return;\r\n\r\n      const communicationMetrics = await this.getCommunicationMetrics(companyData.id);\r\n      const employeeData = await this.getEmployeeData(companyData.id);\r\n\r\n      const metrics = {\r\n        company_id: companyData.id,\r\n        company_name: companyName,\r\n        employee_count: employeeData.totalEmployees,\r\n        total_messages: communicationMetrics.totalMessages,\r\n        sent_messages: communicationMetrics.sentMessages,\r\n        read_messages: communicationMetrics.readMessages,\r\n        scheduled_messages: communicationMetrics.scheduledMessages,\r\n        draft_messages: communicationMetrics.failedMessages,\r\n        engagement_rate: communicationMetrics.engagementRate,\r\n        delivery_rate: communicationMetrics.deliveryRate,\r\n        sentiment_score: 0.5, // Placeholder, se puede calcular despu√©s\r\n        most_active_hour: this.getMostActiveHour(communicationMetrics.hourlyActivity),\r\n        most_active_day: this.getMostActiveDay(communicationMetrics.dailyActivity),\r\n        preferred_channel: this.getPreferredChannel(communicationMetrics.channelUsage)\r\n      };\r\n\r\n      // Upsert m√©tricas\r\n      const { data, error } = await supabase\r\n        .from('company_metrics')\r\n        .upsert(metrics, {\r\n          onConflict: 'company_name'\r\n        })\r\n        .select();\r\n\r\n      if (error) throw error;\r\n      console.log(`‚úÖ M√©tricas guardadas para ${companyName}`);\r\n    } catch (error) {\r\n      console.error('Error guardando m√©tricas:', error);\r\n    }\r\n  }\r\n\r\n  // ========================================\r\n  // M√âTODOS AUXILIARES\r\n  // ========================================\r\n\r\n  formatInsights(insights) {\r\n    const frontInsights = insights\r\n      .filter(i => i.insight_type === 'front')\r\n      .map(i => ({\r\n        type: i.insight_category,\r\n        title: i.title,\r\n        description: i.description\r\n      }));\r\n\r\n    const backInsights = insights\r\n      .filter(i => i.insight_type === 'back')\r\n      .map(i => ({\r\n        type: i.insight_category,\r\n        title: i.title,\r\n        description: i.description\r\n      }));\r\n\r\n    return { frontInsights, backInsights };\r\n  }\r\n\r\n  getMostActiveHour(hourlyActivity) {\r\n    if (!hourlyActivity || Object.keys(hourlyActivity).length === 0) return 9;\r\n    \r\n    return parseInt(Object.entries(hourlyActivity)\r\n      .sort(([,a], [,b]) => b - a)[0][0]);\r\n  }\r\n\r\n  getMostActiveDay(dailyActivity) {\r\n    if (!dailyActivity || Object.keys(dailyActivity).length === 0) return 1;\r\n    \r\n    return parseInt(Object.entries(dailyActivity)\r\n      .sort(([,a], [,b]) => b - a)[0][0]);\r\n  }\r\n\r\n  getPreferredChannel(channelUsage) {\r\n    if (!channelUsage || Object.keys(channelUsage).length === 0) return 'whatsapp';\r\n    \r\n    return Object.entries(channelUsage)\r\n      .sort(([,a], [,b]) => b - a)[0][0];\r\n  }\r\n\r\n  getEmptyMetrics() {\r\n    return {\r\n      totalMessages: 0,\r\n      sentMessages: 0,\r\n      readMessages: 0,\r\n      scheduledMessages: 0,\r\n      failedMessages: 0,\r\n      deliveryRate: 0,\r\n      readRate: 0,\r\n      engagementRate: 0,\r\n      channelUsage: {},\r\n      hourlyActivity: {},\r\n      dailyActivity: {},\r\n      recentActivity: []\r\n    };\r\n  }\r\n\r\n  getEmptyEmployeeData() {\r\n    return {\r\n      totalEmployees: 0,\r\n      departments: {},\r\n      levels: {},\r\n      workModes: {},\r\n      regions: {},\r\n      positions: {}\r\n    };\r\n  }\r\n\r\n  getFallbackInsights(companyName) {\r\n    return {\r\n      frontInsights: [\r\n        {\r\n          type: 'info',\r\n          title: 'Sin Datos de Comunicaci√≥n',\r\n          description: `No hay mensajes enviados para ${companyName}. Los insights se generar√°n autom√°ticamente cuando haya actividad de comunicaci√≥n real.`\r\n        },\r\n        {\r\n          type: 'info',\r\n          title: 'Sistema Listo',\r\n          description: 'El sistema est√° conectado a la base de datos y esperando datos reales para generar an√°lisis.'\r\n        }\r\n      ],\r\n      backInsights: [\r\n        {\r\n          type: 'info',\r\n          title: 'Estado Inicial',\r\n          description: 'Comienza a enviar mensajes para ver an√°lisis detallados y recomendaciones personalizadas.'\r\n        },\r\n        {\r\n          type: 'positive',\r\n          title: 'Base de Datos Conectada',\r\n          description: 'La conexi√≥n con Supabase est√° activa. Los datos se mostrar√°n en tiempo real.'\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  // ========================================\r\n  // M√âTODOS DE MANTENIMIENTO\r\n  // ========================================\r\n\r\n  // Limpiar insights expirados\r\n  async cleanupExpiredInsights() {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('company_insights')\r\n        .update({ is_active: false })\r\n        .lt('expires_at', new Date().toISOString())\r\n        .eq('is_active', true);\r\n\r\n      if (error) throw error;\r\n      console.log('‚úÖ Insights expirados limpiados');\r\n    } catch (error) {\r\n      console.error('Error limpiando insights expirados:', error);\r\n    }\r\n  }\r\n\r\n  // Generar insights para todas las empresas\r\n  async generateAllCompanyInsights() {\r\n    try {\r\n      console.log('üîÑ Generando insights para todas las empresas...');\r\n      \r\n      const { data: companies, error } = await supabase\r\n        .from('companies')\r\n        .select('name')\r\n        .order('name', { ascending: true });\r\n\r\n      if (error) throw error;\r\n\r\n      const results = [];\r\n      for (const company of companies || []) {\r\n        try {\r\n          const insights = await this.generateCompanyInsights(company.name, true);\r\n          results.push({ company: company.name, success: true, insights });\r\n        } catch (error) {\r\n          console.error(`Error generando insights para ${company.name}:`, error);\r\n          results.push({ company: company.name, success: false, error: error.message });\r\n        }\r\n      }\r\n\r\n      console.log(`‚úÖ Insights generados para ${results.filter(r => r.success).length} empresas`);\r\n      return results;\r\n    } catch (error) {\r\n      console.error('Error generando insights para todas las empresas:', error);\r\n      return [];\r\n    }\r\n  }\r\n}\r\n\r\n// Exportar instancia √∫nica\r\nconst trendsAnalysisService = new TrendsAnalysisService();\r\nexport default trendsAnalysisService;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\unifiedEmployeeFolderService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'logger' is defined but never used.","line":10,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'serviceInfo' is assigned a value but never used.","line":149,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":149,"endColumn":24},{"ruleId":"no-unused-vars","severity":1,"message":"'toKeep' is assigned a value but never used.","line":449,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":449,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * SERVICIO UNIFICADO ANTI-DUPLICACI√ìN\r\n * Reemplaza TODOS los servicios existentes y elimina duplicaciones\r\n */\r\n\r\nimport { supabase } from '../lib/supabaseClient.js'\r\nimport superLockService from '../lib/superLockService.js'\r\nimport organizedDatabaseService from './organizedDatabaseService.js'\r\nimport { hybridGoogleDrive } from '../lib/hybridGoogleDrive.js'\r\nimport logger from '../lib/logger.js'\r\n\r\nclass UnifiedEmployeeFolderService {\r\n  constructor() {\r\n    this.initialized = false\r\n    this.hybridDriveInitialized = false\r\n    this.supabase = supabase\r\n  }\r\n\r\n  /**\r\n   * INICIALIZAR SERVICIO\r\n   */\r\n  async initialize() {\r\n    if (this.initialized) return true\r\n    \r\n    try {\r\n      console.log('üöÄ Inicializando Servicio Unificado Anti-Duplicaci√≥n...')\r\n      \r\n      // Verificar conexi√≥n con Supabase\r\n      const { error } = await supabase.from('employee_folders').select('count').limit(1)\r\n      if (error) {\r\n        console.warn('‚ö†Ô∏è Verificaci√≥n de employee_folders fall√≥:', error.message)\r\n      }\r\n      \r\n      // Inicializar Hybrid Google Drive\r\n      await this.initializeHybridDrive()\r\n      \r\n      this.initialized = true\r\n      console.log('‚úÖ Servicio Unificado inicializado')\r\n      return true\r\n    } catch (error) {\r\n      console.error('‚ùå Error inicializando Servicio Unificado:', error)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * INICIALIZAR HYBRID DRIVE\r\n   */\r\n  async initializeHybridDrive() {\r\n    if (this.hybridDriveInitialized) return true\r\n    \r\n    try {\r\n      const success = await hybridGoogleDrive.initialize()\r\n      if (success) {\r\n        this.hybridDriveInitialized = true\r\n        const serviceInfo = hybridGoogleDrive.getServiceInfo()\r\n        console.log(`‚úÖ ${serviceInfo.service} inicializado para servicio unificado`)\r\n        return true\r\n      }\r\n      return false\r\n    } catch (error) {\r\n      console.error('‚ùå Error inicializando Hybrid Drive:', error)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * CREAR CARPETA CON SUPER LOCK OBLIGATORIO\r\n   */\r\n  async createEmployeeFolder(employeeEmail, employeeData) {\r\n    return await superLockService.withSuperLock(\r\n      employeeEmail,\r\n      async () => {\r\n        await this.initialize()\r\n        \r\n        // 1. VERIFICAR SI YA EXISTE EN SUPABASE\r\n        const existingSupabase = await this.checkSupabaseExists(employeeEmail)\r\n        if (existingSupabase) {\r\n          console.log(`üìÇ Carpeta ya existe en Supabase para ${employeeEmail}`)\r\n          return {\r\n            folder: existingSupabase,\r\n            created: false,\r\n            updated: false,\r\n            alreadyExists: true\r\n          }\r\n        }\r\n\r\n        // 2. VERIFICAR SI YA EXISTE EN GOOGLE DRIVE\r\n        const existingDrive = await this.checkDriveExists(employeeEmail, employeeData.name)\r\n        if (existingDrive) {\r\n          console.log(`üìÇ Carpeta ya existe en Drive para ${employeeEmail}`)\r\n          \r\n          // Crear registro en Supabase con datos de Drive existente\r\n          const folderData = await this.createSupabaseRecord(employeeEmail, employeeData, existingDrive.id, existingDrive.webViewLink)\r\n          return {\r\n            folder: folderData,\r\n            created: true,\r\n            updated: false,\r\n            alreadyExistedInDrive: true\r\n          }\r\n        }\r\n\r\n        // 3. CREAR NUEVA CARPETA\r\n        const newFolder = await this.createNewFolder(employeeEmail, employeeData)\r\n        return {\r\n          folder: newFolder,\r\n          created: true,\r\n          updated: false,\r\n          newlyCreated: true\r\n        }\r\n      },\r\n      'create_folder_unified'\r\n    )\r\n  }\r\n\r\n  /**\r\n   * VERIFICAR EXISTENCIA EN SUPABASE\r\n   */\r\n  async checkSupabaseExists(employeeEmail) {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('employee_folders')\r\n        .select('*')\r\n        .eq('employee_email', employeeEmail)\r\n        .maybeSingle()\r\n\r\n      if (error && error.code !== 'PGRST116') {\r\n        console.warn(`‚ö†Ô∏è Error verificando Supabase para ${employeeEmail}:`, error.message)\r\n        return null\r\n      }\r\n\r\n      return data\r\n    } catch (error) {\r\n      console.warn(`‚ö†Ô∏è Error verificando Supabase para ${employeeEmail}:`, error.message)\r\n      return null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * VERIFICAR EXISTENCIA EN GOOGLE DRIVE\r\n   */\r\n  async checkDriveExists(employeeEmail, employeeName) {\r\n    try {\r\n      if (!this.hybridDriveInitialized) {\r\n        console.log(`‚ö†Ô∏è Drive no inicializado para ${employeeEmail}`)\r\n        return null\r\n      }\r\n\r\n      const serviceInfo = hybridGoogleDrive.getServiceInfo()\r\n      const companyName = 'Empresa' // Se puede obtener de employeeData\r\n      \r\n      // Buscar carpeta principal de la empresa\r\n      const parentFolderName = `Empleados - ${companyName}`\r\n      const folders = await hybridGoogleDrive.listFiles()\r\n      const parentFolder = folders.find(folder =>\r\n        folder.name === parentFolderName &&\r\n        folder.mimeType === 'application/vnd.google-apps.folder'\r\n      )\r\n\r\n      if (!parentFolder) {\r\n        console.log(`üìÅ No se encontr√≥ carpeta principal para ${employeeEmail}`)\r\n        return null\r\n      }\r\n\r\n      // Buscar carpeta del empleado\r\n      const folderName = `${employeeName} (${employeeEmail})`\r\n      const employeeFiles = await hybridGoogleDrive.listFiles(parentFolder.id)\r\n      const existingFolder = employeeFiles.find(file =>\r\n        file.name === folderName &&\r\n        file.mimeType === 'application/vnd.google-apps.folder'\r\n      )\r\n\r\n      return existingFolder || null\r\n    } catch (error) {\r\n      console.warn(`‚ö†Ô∏è Error verificando Drive para ${employeeEmail}:`, error.message)\r\n      return null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * CREAR NUEVA CARPETA\r\n   */\r\n  async createNewFolder(employeeEmail, employeeData) {\r\n    try {\r\n      const companyName = await this.getCompanyName(employeeData.company_id)\r\n      \r\n      // 1. CREAR CARPETA EN GOOGLE DRIVE\r\n      const driveFolder = await this.createDriveFolder(employeeEmail, employeeData.name, companyName)\r\n      \r\n      // 2. CREAR REGISTRO EN SUPABASE\r\n      const supabaseRecord = await this.createSupabaseRecord(\r\n        employeeEmail,\r\n        employeeData,\r\n        driveFolder.id,\r\n        driveFolder.webViewLink || `https://drive.google.com/drive/folders/${driveFolder.id}`\r\n      )\r\n      \r\n      // 3. COMPARTIR CARPETA\r\n      await this.shareDriveFolder(driveFolder.id, employeeEmail)\r\n      \r\n      console.log(`‚úÖ Carpeta creada exitosamente para ${employeeEmail}`)\r\n      return supabaseRecord\r\n    } catch (error) {\r\n      console.error(`‚ùå Error creando carpeta para ${employeeEmail}:`, error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * CREAR CARPETA EN GOOGLE DRIVE\r\n   */\r\n  async createDriveFolder(employeeEmail, employeeName, companyName) {\r\n    try {\r\n      const parentFolderName = `Empleados - ${companyName}`\r\n      \r\n      // Buscar o crear carpeta principal\r\n      let parentFolder = await this.findOrCreateParentFolder(parentFolderName)\r\n      \r\n      // Crear carpeta del empleado\r\n      const folderName = `${employeeName} (${employeeEmail})`\r\n      const employeeFolder = await hybridGoogleDrive.createFolder(folderName, parentFolder.id)\r\n      \r\n      return employeeFolder\r\n    } catch (error) {\r\n      console.error(`‚ùå Error creando carpeta en Drive para ${employeeEmail}:`, error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * BUSCAR O CREAR CARPETA PRINCIPAL\r\n   */\r\n  async findOrCreateParentFolder(folderName) {\r\n    try {\r\n      const folders = await hybridGoogleDrive.listFiles()\r\n      const parentFolder = folders.find(folder =>\r\n        folder.name === folderName &&\r\n        folder.mimeType === 'application/vnd.google-apps.folder'\r\n      )\r\n\r\n      if (parentFolder) {\r\n        return parentFolder\r\n      } else {\r\n        return await hybridGoogleDrive.createFolder(folderName)\r\n      }\r\n    } catch (error) {\r\n      console.error(`‚ùå Error buscando/creando carpeta principal ${folderName}:`, error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * CREAR REGISTRO EN SUPABASE\r\n   */\r\n  async createSupabaseRecord(employeeEmail, employeeData, driveFolderId, driveFolderUrl) {\r\n    try {\r\n      const companyName = await this.getCompanyName(employeeData.company_id)\r\n      \r\n      const folderData = {\r\n        employee_email: employeeEmail,\r\n        employee_id: employeeData.id,\r\n        employee_name: employeeData.name,\r\n        employee_position: employeeData.position,\r\n        employee_department: employeeData.department,\r\n        employee_phone: employeeData.phone,\r\n        employee_region: employeeData.region,\r\n        employee_level: employeeData.level,\r\n        employee_work_mode: employeeData.work_mode,\r\n        employee_contract_type: employeeData.contract_type,\r\n        company_id: employeeData.company_id,\r\n        company_name: companyName,\r\n        drive_folder_id: driveFolderId,\r\n        drive_folder_url: driveFolderUrl,\r\n        settings: {\r\n          notificationPreferences: {\r\n            whatsapp: true,\r\n            telegram: true,\r\n            email: true\r\n          },\r\n          responseLanguage: 'es',\r\n          timezone: 'America/Santiago'\r\n        }\r\n      }\r\n\r\n      const { data, error } = await supabase\r\n        .from('employee_folders')\r\n        .insert(folderData)\r\n        .select()\r\n        .single()\r\n\r\n      if (error) throw error\r\n\r\n      // Crear configuraci√≥n de notificaciones\r\n      await this.createNotificationSettings(data.id)\r\n\r\n      return data\r\n    } catch (error) {\r\n      console.error(`‚ùå Error creando registro en Supabase para ${employeeEmail}:`, error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * COMPARTIR CARPETA\r\n   */\r\n  async shareDriveFolder(folderId, employeeEmail) {\r\n    try {\r\n      await hybridGoogleDrive.shareFolder(folderId, employeeEmail, 'writer')\r\n      console.log(`üì§ Carpeta compartida con ${employeeEmail}`)\r\n    } catch (error) {\r\n      console.warn(`‚ö†Ô∏è No se pudo compartir carpeta con ${employeeEmail}:`, error.message)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * CREAR CONFIGURACI√ìN DE NOTIFICACIONES\r\n   */\r\n  async createNotificationSettings(folderId) {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('employee_notification_settings')\r\n        .insert({\r\n          folder_id: folderId,\r\n          whatsapp_enabled: true,\r\n          telegram_enabled: true,\r\n          email_enabled: true,\r\n          response_language: 'es',\r\n          timezone: 'America/Santiago',\r\n          notification_preferences: {\r\n            whatsapp: true,\r\n            telegram: true,\r\n            email: true\r\n          }\r\n        })\r\n\r\n      if (error) throw error\r\n    } catch (error) {\r\n      console.error(`‚ùå Error creando configuraci√≥n de notificaciones:`, error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * OBTENER NOMBRE DE EMPRESA\r\n   */\r\n  async getCompanyName(companyId) {\r\n    try {\r\n      if (!companyId) return 'Empresa no especificada'\r\n      \r\n      const companies = await organizedDatabaseService.getCompanies()\r\n      const company = companies.find(comp => comp.id === companyId)\r\n      return company ? company.name : 'Empresa no encontrada'\r\n    } catch (error) {\r\n      console.warn(`‚ö†Ô∏è Error obteniendo nombre de empresa para ${companyId}:`, error.message)\r\n      return 'Empresa no especificada'\r\n    }\r\n  }\r\n\r\n  /**\r\n   * CREAR CARPETAS PARA TODOS LOS EMPLEADOS\r\n   */\r\n  async createFoldersForAllEmployees() {\r\n    try {\r\n      console.log('üöÄ Iniciando creaci√≥n masiva con servicio unificado...')\r\n      \r\n      const employees = await organizedDatabaseService.getEmployees()\r\n      let createdCount = 0\r\n      let updatedCount = 0\r\n      let alreadyExistsCount = 0\r\n      let errorCount = 0\r\n      const errors = []\r\n\r\n      for (const employee of employees) {\r\n        if (!employee.email) {\r\n          console.warn(`‚ö†Ô∏è Empleado sin email: ${employee.name}`)\r\n          continue\r\n        }\r\n\r\n        try {\r\n          const result = await this.createEmployeeFolder(employee.email, employee)\r\n          \r\n          if (result.created) {\r\n            if (result.newlyCreated) {\r\n              createdCount++\r\n            } else if (result.alreadyExistedInDrive) {\r\n              alreadyExistsCount++\r\n            }\r\n          } else if (result.updated) {\r\n            updatedCount++\r\n          } else if (result.alreadyExists) {\r\n            alreadyExistsCount++\r\n          }\r\n          \r\n          // Log de progreso cada 10 empleados\r\n          if ((createdCount + updatedCount + alreadyExistsCount) % 10 === 0) {\r\n            console.log(`üìä Progreso: ${createdCount + updatedCount + alreadyExistsCount} carpetas procesadas...`)\r\n          }\r\n\r\n        } catch (error) {\r\n          errorCount++\r\n          errors.push(`${employee.email}: ${error.message}`)\r\n          console.error(`‚ùå Error procesando ${employee.email}:`, error)\r\n        }\r\n      }\r\n\r\n      const summary = {\r\n        created: createdCount,\r\n        updated: updatedCount,\r\n        alreadyExisted: alreadyExistsCount,\r\n        errors: errorCount,\r\n        sampleErrors: errors.slice(0, 10)\r\n      }\r\n\r\n      console.log('üìä Resumen final:', summary)\r\n      return summary\r\n    } catch (error) {\r\n      console.error('‚ùå Error en creaci√≥n masiva:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * LIMPIAR DUPLICADOS EXISTENTES\r\n   */\r\n  async cleanupDuplicates() {\r\n    try {\r\n      console.log('üßπ Iniciando limpieza de duplicados...')\r\n      \r\n      const { data: folders, error } = await supabase\r\n        .from('employee_folders')\r\n        .select('*')\r\n        .order('created_at', { ascending: false })\r\n\r\n      if (error) throw error\r\n\r\n      const emailGroups = {}\r\n      folders.forEach(folder => {\r\n        const email = folder.employee_email\r\n        if (!emailGroups[email]) {\r\n          emailGroups[email] = []\r\n        }\r\n        emailGroups[email].push(folder)\r\n      })\r\n\r\n      let deletedCount = 0\r\n      for (const [email, group] of Object.entries(emailGroups)) {\r\n        if (group.length > 1) {\r\n          // Mantener el m√°s reciente, eliminar los dem√°s\r\n          const toKeep = group[0]\r\n          const toDelete = group.slice(1)\r\n          \r\n          for (const folder of toDelete) {\r\n            await supabase\r\n              .from('employee_folders')\r\n              .delete()\r\n              .eq('id', folder.id)\r\n            \r\n            deletedCount++\r\n            console.log(`üóëÔ∏è Eliminada carpeta duplicada para ${email} (ID: ${folder.id})`)\r\n          }\r\n        }\r\n      }\r\n\r\n      console.log(`‚úÖ Limpieza completada: ${deletedCount} duplicados eliminados`)\r\n      return { deletedCount }\r\n    } catch (error) {\r\n      console.error('‚ùå Error en limpieza de duplicados:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * OBTENER ESTAD√çSTICAS\r\n   */\r\n  async getStats() {\r\n    try {\r\n      const { data: folders } = await supabase\r\n        .from('employee_folders')\r\n        .select('*')\r\n\r\n      const lockStats = await superLockService.getSuperLockStats()\r\n      \r\n      return {\r\n        totalFolders: folders?.length || 0,\r\n        lockStats,\r\n        service: 'UnifiedEmployeeFolderService',\r\n        initialized: this.initialized,\r\n        driveInitialized: this.hybridDriveInitialized\r\n      }\r\n    } catch (error) {\r\n      console.error('‚ùå Error obteniendo estad√≠sticas:', error)\r\n      return {\r\n        totalFolders: 0,\r\n        lockStats: { active: 0, localCache: 0, total: 0 },\r\n        service: 'UnifiedEmployeeFolderService',\r\n        initialized: false,\r\n        driveInitialized: false\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Instancia singleton\r\nconst unifiedEmployeeFolderService = new UnifiedEmployeeFolderService()\r\n\r\nexport default unifiedEmployeeFolderService\r\nexport { UnifiedEmployeeFolderService }","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\userGoogleDriveService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\userSpecificGoogleDriveService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\whatsapp2026CompliantKnowledgeService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'responseTime' is assigned a value but never used.","line":650,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":650,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Servicio de Conocimiento Externo 100% Cumplido con T√©rminos WhatsApp Business 2026\r\n * \r\n * Este servicio implementa estrictamente los t√©rminos vigentes desde 15 de enero de 2026:\r\n * - Proveedores de Servicios Externos (PSE) autorizados\r\n * - Restricciones estrictas para Proveedores de IA\r\n * - Prohibici√≥n de perfiles y rastreo\r\n * - Responsabilidad total del cliente\r\n * - Reportes obligatorios\r\n */\r\n\r\nimport { supabase } from '../lib/supabase.js';\r\nimport whatsappComplianceService from './whatsappComplianceService.js';\r\n\r\nclass WhatsApp2026CompliantKnowledgeService {\r\n  constructor() {\r\n    this.authorizedProviders = new Map();\r\n    this.isolatedModels = new Map(); // Modelos aislados por cliente\r\n    this.usageTracker = new Map();\r\n    this.complianceReports = new Map();\r\n    \r\n    // Inicializar con proveedores permitidos por defecto\r\n    this.initializeDefaultProviders();\r\n  }\r\n\r\n  /**\r\n   * Inicializar proveedores por defecto cumpliendo t√©rminos 2026\r\n   */\r\n  initializeDefaultProviders() {\r\n    // FAQs internas (siempre permitidas)\r\n    this.authorizedProviders.set('internal_faq', {\r\n      id: 'internal_faq',\r\n      type: 'faq',\r\n      name: 'Base de Conocimiento Interna',\r\n      priority: 1,\r\n      requiresPSE: false,\r\n      aiProvider: false,\r\n      dataProcessing: 'internal_only',\r\n      allowedPurposes: ['customer_service', 'information_delivery'],\r\n      restrictions: {\r\n        noProfiling: true,\r\n        noDataSharing: true,\r\n        exclusiveUse: true\r\n      }\r\n    });\r\n\r\n    // CRM interno (siempre permitido)\r\n    this.authorizedProviders.set('internal_crm', {\r\n      id: 'internal_crm',\r\n      type: 'crm',\r\n      name: 'Sistema CRM Interno',\r\n      priority: 2,\r\n      requiresPSE: false,\r\n      aiProvider: false,\r\n      dataProcessing: 'internal_only',\r\n      allowedPurposes: ['customer_service', 'personalized_response'],\r\n      restrictions: {\r\n        noProfiling: true,\r\n        noDataSharing: true,\r\n        exclusiveUse: true\r\n      }\r\n    });\r\n\r\n    // Base de datos interna (siempre permitida)\r\n    this.authorizedProviders.set('internal_database', {\r\n      id: 'internal_database',\r\n      type: 'database',\r\n      name: 'Base de Datos Interna',\r\n      priority: 3,\r\n      requiresPSE: false,\r\n      aiProvider: false,\r\n      dataProcessing: 'internal_only',\r\n      allowedPurposes: ['information_retrieval', 'knowledge_search'],\r\n      restrictions: {\r\n        noProfiling: true,\r\n        noDataSharing: true,\r\n        exclusiveUse: true\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Registrar Proveedor de Servicios Externo (PSE) seg√∫n t√©rminos 2026\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {Object} pseConfig - Configuraci√≥n del PSE\r\n   */\r\n  async registerExternalServiceProvider(companyId, pseConfig) {\r\n    // Verificar cumplimiento de t√©rminos 2026\r\n    const complianceCheck = await this.validatePSECompliance(companyId, pseConfig);\r\n    \r\n    if (!complianceCheck.compliant) {\r\n      throw new Error(`PSE no cumple t√©rminos 2026: ${complianceCheck.reason}`);\r\n    }\r\n\r\n    // Registrar acuerdo escrito (simulado)\r\n    await this.recordPSEAgreement(companyId, pseConfig);\r\n\r\n    // Configurar proveedor con restricciones\r\n    const provider = {\r\n      ...pseConfig,\r\n      companyId,\r\n      registeredAt: new Date().toISOString(),\r\n      agreementStatus: 'active',\r\n      complianceVerified: true,\r\n      restrictions: {\r\n        ...pseConfig.restrictions,\r\n        noProfiling: true,\r\n        noDataSharing: true,\r\n        exclusiveUse: true,\r\n        noTrainingData: pseConfig.aiProvider || false\r\n      }\r\n    };\r\n\r\n    this.authorizedProviders.set(pseConfig.id, provider);\r\n    \r\n    // Inicializar tracking de uso\r\n    this.usageTracker.set(`${companyId}_${pseConfig.id}`, {\r\n      usage: [],\r\n      compliance: [],\r\n      incidents: []\r\n    });\r\n\r\n    return { success: true, providerId: pseConfig.id };\r\n  }\r\n\r\n  /**\r\n   * Validar cumplimiento de PSE seg√∫n t√©rminos 2026\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {Object} pseConfig - Configuraci√≥n del PSE\r\n   */\r\n  async validatePSECompliance(companyId, pseConfig) {\r\n    const issues = [];\r\n\r\n    // 1. Verificar acuerdo escrito\r\n    if (!pseConfig.writtenAgreement) {\r\n      issues.push('Se requiere acuerdo escrito con PSE');\r\n    }\r\n\r\n    // 2. Verificar prop√≥sito espec√≠fico\r\n    if (!pseConfig.specificPurpose || pseConfig.specificPurpose === 'general') {\r\n      issues.push('El PSE debe tener prop√≥sito espec√≠fico definido');\r\n    }\r\n\r\n    // 3. Verificar salvaguardas t√©cnicas\r\n    if (!pseConfig.technicalSafeguards || !pseConfig.technicalSafeguards.encryption) {\r\n      issues.push('El PSE debe tener salvaguardas t√©cnicas implementadas');\r\n    }\r\n\r\n    // 4. Verificar cumplimiento legal\r\n    if (!pseConfig.legalCompliance || !pseConfig.legalCompliance.gdprCompliant) {\r\n      issues.push('El PSE debe cumplir con leyes aplicables (GDPR, etc.)');\r\n    }\r\n\r\n    // 5. Restricciones espec√≠ficas para Proveedores de IA\r\n    if (pseConfig.aiProvider) {\r\n      const aiIssues = await this.validateAIProviderRestrictions(pseConfig);\r\n      issues.push(...aiIssues);\r\n    }\r\n\r\n    return {\r\n      compliant: issues.length === 0,\r\n      reason: issues.join('; ')\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Validar restricciones espec√≠ficas para Proveedores de IA\r\n   * @param {Object} aiConfig - Configuraci√≥n del proveedor de IA\r\n   */\r\n  async validateAIProviderRestrictions(aiConfig) {\r\n    const issues = [];\r\n\r\n    // 1. Verificar prohibici√≥n de acceso directo\r\n    if (aiConfig.directWhatsAppAccess) {\r\n      issues.push('Prohibido acceso directo a WhatsApp Business para proveedores de IA');\r\n    }\r\n\r\n    // 2. Verificar prohibici√≥n de entrenamiento\r\n    if (aiConfig.allowsTraining || aiConfig.dataForTraining) {\r\n      issues.push('Prohibido usar datos para entrenar modelos de IA');\r\n    }\r\n\r\n    // 3. Verificar uso exclusivo\r\n    if (!aiConfig.exclusiveUse) {\r\n      issues.push('Los modelos de IA deben ser para uso exclusivo del cliente');\r\n    }\r\n\r\n    // 4. Verificar aislamiento de modelos\r\n    if (!aiConfig.modelIsolation || aiConfig.modelIsolation !== 'complete') {\r\n      issues.push('Se requiere aislamiento completo de modelos por cliente');\r\n    }\r\n\r\n    return issues;\r\n  }\r\n\r\n  /**\r\n   * Obtener respuesta con cumplimiento 100% de t√©rminos 2026\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {string} userPhone - Tel√©fono del usuario\r\n   * @param {string} message - Mensaje del usuario\r\n   * @param {Object} options - Opciones adicionales\r\n   */\r\n  async getCompliantResponse(companyId, userPhone, message, options = {}) {\r\n    try {\r\n      console.log(`üîç Buscando respuesta cumplida con t√©rminos 2026 para ${userPhone}`);\r\n\r\n      // 1. Verificaciones de cumplimiento CR√çTICAS\r\n      const complianceCheck = await this.validate2026Requirements(companyId, userPhone, message);\r\n\r\n      if (!complianceCheck.canProceed) {\r\n        throw new Error(`Bloqueado por t√©rminos 2026: ${complianceCheck.reason}`);\r\n      }\r\n\r\n      // 2. Obtener proveedores autorizados para esta empresa\r\n      const authorizedSources = await this.getAuthorizedSources(companyId);\r\n\r\n      if (authorizedSources.length === 0) {\r\n        return {\r\n          success: false,\r\n          requiresHuman: true,\r\n          reason: 'No hay fuentes de conocimiento autorizadas',\r\n          complianceInfo: {\r\n            terms2026: true,\r\n            noAuthorizedProviders: true\r\n          }\r\n        };\r\n      }\r\n\r\n      // 3. Priorizar fuentes no-IA (m√°s seguras seg√∫n t√©rminos)\r\n      const prioritizedSources = this.prioritizeSources(authorizedSources);\r\n\r\n      let bestResponse = null;\r\n      let sourceUsed = null;\r\n\r\n      // 4. Buscar respuesta en fuentes autorizadas\r\n      for (const source of prioritizedSources) {\r\n        try {\r\n          const response = await this.queryAuthorizedSource(\r\n            source,\r\n            message,\r\n            companyId,\r\n            userPhone,\r\n            complianceCheck\r\n          );\r\n\r\n          if (response && response.compliant) {\r\n            bestResponse = response;\r\n            sourceUsed = source;\r\n            \r\n            // Si encontramos respuesta confiable, podemos detenernos\r\n            if (response.confidence >= 0.8) {\r\n              break;\r\n            }\r\n          }\r\n        } catch (error) {\r\n          console.warn(`Error consultando fuente ${source.id}:`, error.message);\r\n          \r\n          // Registrar incidente de cumplimiento\r\n          await this.recordComplianceIncident(companyId, source.id, error.message);\r\n        }\r\n      }\r\n\r\n      // 5. Evaluar respuesta encontrada\r\n      if (!bestResponse) {\r\n        return {\r\n          success: false,\r\n          requiresHuman: true,\r\n          reason: 'No se encontr√≥ respuesta adecuada en fuentes autorizadas',\r\n          complianceInfo: {\r\n            terms2026: true,\r\n            sourcesChecked: prioritizedSources.length,\r\n            noAdequateResponse: true\r\n          }\r\n        };\r\n      }\r\n\r\n      // 6. Validaci√≥n final de cumplimiento\r\n      const finalValidation = await this.validateFinalResponse(\r\n        bestResponse,\r\n        sourceUsed,\r\n        companyId,\r\n        userPhone\r\n      );\r\n\r\n      if (!finalValidation.compliant) {\r\n        throw new Error(`Respuesta final no cumple t√©rminos 2026: ${finalValidation.reason}`);\r\n      }\r\n\r\n      // 7. Registrar uso para responsabilidad del cliente\r\n      await this.recordCompliantUsage(\r\n        companyId,\r\n        userPhone,\r\n        message,\r\n        bestResponse,\r\n        sourceUsed\r\n      );\r\n\r\n      // 8. Agregar divulgaci√≥n de cumplimiento\r\n      const finalResponse = this.add2026ComplianceDisclosure(bestResponse, sourceUsed);\r\n\r\n      return {\r\n        success: true,\r\n        content: finalResponse.content,\r\n        confidence: bestResponse.confidence,\r\n        source: sourceUsed.name,\r\n        sourceType: sourceUsed.type,\r\n        complianceInfo: {\r\n          terms2026: true,\r\n          pseAuthorized: sourceUsed.requiresPSE,\r\n          aiProvider: sourceUsed.aiProvider,\r\n          dataProcessing: sourceUsed.dataProcessing,\r\n          noProfiling: true,\r\n          exclusiveUse: true\r\n        },\r\n        requiresHuman: false,\r\n        responseTime: bestResponse.responseTime\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error en getCompliantResponse:', error);\r\n      \r\n      // Registrar error de cumplimiento\r\n      await this.recordComplianceError(companyId, userPhone, error.message);\r\n\r\n      return {\r\n        success: false,\r\n        error: error.message,\r\n        requiresHuman: true,\r\n        reason: 'Error en sistema de conocimiento cumplido',\r\n        complianceInfo: {\r\n          terms2026: true,\r\n          errorRecorded: true\r\n        }\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validar requisitos espec√≠ficos de t√©rminos 2026\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {string} userPhone - Tel√©fono del usuario\r\n   * @param {string} message - Mensaje del usuario\r\n   */\r\n  async validate2026Requirements(companyId, userPhone, message) {\r\n    try {\r\n      // 1. Verificaciones de cumplimiento est√°ndar de WhatsApp\r\n      const standardCompliance = await whatsappComplianceService.validateComplianceRequirements(\r\n        companyId,\r\n        userPhone,\r\n        message\r\n      );\r\n\r\n      if (!standardCompliance.canProceed) {\r\n        return {\r\n          canProceed: false,\r\n          reason: standardCompliance.reason,\r\n          type: 'standard_compliance'\r\n        };\r\n      }\r\n\r\n      // 2. Verificaciones espec√≠ficas de t√©rminos 2026\r\n      const specificChecks = [\r\n        await this.verifyNoProfiling(companyId, userPhone),\r\n        await this.verifyAuthorizedProviders(companyId),\r\n        await this.verifyDataRestrictions(companyId),\r\n        await this.verifyClientResponsibility(companyId)\r\n      ];\r\n\r\n      const failedChecks = specificChecks.filter(check => !check.compliant);\r\n\r\n      if (failedChecks.length > 0) {\r\n        return {\r\n          canProceed: false,\r\n          reason: failedChecks.map(check => check.reason).join('; '),\r\n          type: 'terms2026_specific'\r\n        };\r\n      }\r\n\r\n      return {\r\n        canProceed: true,\r\n        standardCompliance,\r\n        terms2026Compliance: true\r\n      };\r\n\r\n    } catch (error) {\r\n      return {\r\n        canProceed: false,\r\n        reason: `Error en validaci√≥n t√©rminos 2026: ${error.message}`,\r\n        type: 'validation_error'\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verificar que no hay creaci√≥n de perfiles (prohibido por t√©rminos 2026)\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {string} userPhone - Tel√©fono del usuario\r\n   */\r\n  async verifyNoProfiling(companyId, userPhone) {\r\n    try {\r\n      // Verificar que no existen perfiles de este usuario\r\n      const { data, error } = await supabase\r\n        .from('user_profiles')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .eq('user_phone', userPhone);\r\n\r\n      if (error) throw error;\r\n\r\n      if (data && data.length > 0) {\r\n        return {\r\n          compliant: false,\r\n          reason: 'Existen perfiles de usuario (prohibido por t√©rminos 2026)'\r\n        };\r\n      }\r\n\r\n      return { compliant: true };\r\n\r\n    } catch (error) {\r\n      return {\r\n        compliant: false,\r\n        reason: `Error verificando perfiles: ${error.message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verificar proveedores autorizados para la empresa\r\n   * @param {number} companyId - ID de la empresa\r\n   */\r\n  async verifyAuthorizedProviders(companyId) {\r\n    try {\r\n      const authorizedProviders = Array.from(this.authorizedProviders.values())\r\n        .filter(provider => provider.companyId === companyId || !provider.companyId);\r\n\r\n      if (authorizedProviders.length === 0) {\r\n        return {\r\n          compliant: false,\r\n          reason: 'No hay proveedores autorizados configurados'\r\n        };\r\n      }\r\n\r\n      // Verificar que todos los proveedores cumplen t√©rminos\r\n      const nonCompliantProviders = authorizedProviders.filter(provider => {\r\n        return !provider.complianceVerified || provider.agreementStatus !== 'active';\r\n      });\r\n\r\n      if (nonCompliantProviders.length > 0) {\r\n        return {\r\n          compliant: false,\r\n          reason: `Proveedores no cumplen: ${nonCompliantProviders.map(p => p.id).join(', ')}`\r\n        };\r\n      }\r\n\r\n      return { compliant: true };\r\n\r\n    } catch (error) {\r\n      return {\r\n        compliant: false,\r\n        reason: `Error verificando proveedores: ${error.message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verificar restricciones de datos seg√∫n t√©rminos 2026\r\n   * @param {number} companyId - ID de la empresa\r\n   */\r\n  async verifyDataRestrictions(companyId) {\r\n    try {\r\n      // Verificar que no hay compartici√≥n de datos con terceros no autorizados\r\n      const { data, error } = await supabase\r\n        .from('data_sharing_logs')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .gte('created_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString());\r\n\r\n      if (error) throw error;\r\n\r\n      if (data && data.length > 0) {\r\n        const unauthorizedSharing = data.filter(log => !log.authorized_pse);\r\n        if (unauthorizedSharing.length > 0) {\r\n          return {\r\n            compliant: false,\r\n            reason: 'Compartici√≥n de datos no autorizada detectada'\r\n          };\r\n        }\r\n      }\r\n\r\n      return { compliant: true };\r\n\r\n    } catch (error) {\r\n      return {\r\n        compliant: false,\r\n        reason: `Error verificando restricciones de datos: ${error.message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verificar configuraci√≥n de responsabilidad del cliente\r\n   * @param {number} companyId - ID de la empresa\r\n   */\r\n  async verifyClientResponsibility(companyId) {\r\n    try {\r\n      // Verificar que est√° configurado el tracking de responsabilidad\r\n      const { data, error } = await supabase\r\n        .from('client_responsibility_config')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .single();\r\n\r\n      if (error && error.code !== 'PGRST116') throw error;\r\n\r\n      if (!data || !data.tracking_enabled) {\r\n        return {\r\n          compliant: false,\r\n          reason: 'No est√° configurado el tracking de responsabilidad del cliente'\r\n        };\r\n      }\r\n\r\n      return { compliant: true };\r\n\r\n    } catch (error) {\r\n      return {\r\n        compliant: false,\r\n        reason: `Error verificando responsabilidad: ${error.message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener fuentes autorizadas para la empresa\r\n   * @param {number} companyId - ID de la empresa\r\n   */\r\n  async getAuthorizedSources(companyId) {\r\n    return Array.from(this.authorizedProviders.values())\r\n      .filter(provider => {\r\n        // Incluir proveedores globales (sin companyId) y proveedores espec√≠ficos de la empresa\r\n        const belongsToCompany = !provider.companyId || provider.companyId === companyId;\r\n        \r\n        // Verificar que est√© activo y cumplido\r\n        const isActiveAndCompliant = provider.enabled !== false && \r\n                                   provider.complianceVerified && \r\n                                   provider.agreementStatus === 'active';\r\n\r\n        return belongsToCompany && isActiveAndCompliant;\r\n      })\r\n      .sort((a, b) => a.priority - b.priority);\r\n  }\r\n\r\n  /**\r\n   * Priorizar fuentes seg√∫n seguridad de t√©rminos 2026\r\n   * @param {Array} sources - Fuentes autorizadas\r\n   */\r\n  prioritizeSources(sources) {\r\n    // Prioridad: 1) No-IA internas, 2) No-AI externas, 3) IA aisladas, 4) IA externas\r\n    return sources.sort((a, b) => {\r\n      const getPriorityScore = (source) => {\r\n        let score = 0;\r\n        \r\n        // Preferir fuentes internas\r\n        if (!source.requiresPSE) score += 100;\r\n        \r\n        // Penalizar proveedores de IA\r\n        if (source.aiProvider) score -= 50;\r\n        \r\n        // Preferir procesamiento interno\r\n        if (source.dataProcessing === 'internal_only') score += 30;\r\n        \r\n        // Preferir mayor prioridad configurada\r\n        score += (100 - source.priority);\r\n        \r\n        return score;\r\n      };\r\n\r\n      return getPriorityScore(b) - getPriorityScore(a);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Consultar fuente autorizada con cumplimiento\r\n   * @param {Object} source - Fuente autorizada\r\n   * @param {string} message - Mensaje de consulta\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {string} userPhone - Tel√©fono del usuario\r\n   * @param {Object} complianceCheck - Verificaci√≥n de cumplimiento\r\n   */\r\n  async queryAuthorizedSource(source, message, companyId, userPhone, complianceCheck) {\r\n    const startTime = Date.now();\r\n\r\n    try {\r\n      let response;\r\n\r\n      // Verificaciones espec√≠ficas seg√∫n tipo de fuente\r\n      if (source.aiProvider) {\r\n        // Verificaciones adicionales para proveedores de IA\r\n        const aiCompliance = await this.validateAIUsage(source, companyId);\r\n        if (!aiCompliance.allowed) {\r\n          throw new Error(`Proveedor de IA no autorizado: ${aiCompliance.reason}`);\r\n        }\r\n      }\r\n\r\n      // Consultar seg√∫n tipo de fuente\r\n      switch (source.type) {\r\n        case 'faq':\r\n          response = await this.queryCompliantFAQ(source, message, companyId);\r\n          break;\r\n        case 'crm':\r\n          response = await this.queryCompliantCRM(source, message, companyId, userPhone);\r\n          break;\r\n        case 'database':\r\n          response = await this.queryCompliantDatabase(source, message, companyId);\r\n          break;\r\n        case 'api':\r\n          response = await this.queryCompliantAPI(source, message, companyId);\r\n          break;\r\n        case 'ai':\r\n          response = await this.queryCompliantAI(source, message, companyId, userPhone);\r\n          break;\r\n        default:\r\n          throw new Error(`Tipo de fuente no soportado: ${source.type}`);\r\n      }\r\n\r\n      const responseTime = Date.now() - startTime;\r\n\r\n      // Validar respuesta seg√∫n t√©rminos 2026\r\n      const responseValidation = await this.validateResponseCompliance(response, source);\r\n\r\n      if (!responseValidation.compliant) {\r\n        throw new Error(`Respuesta no cumple t√©rminos 2026: ${responseValidation.reason}`);\r\n      }\r\n\r\n      return {\r\n        ...response,\r\n        responseTime,\r\n        sourceId: source.id,\r\n        sourceType: source.type,\r\n        compliant: true,\r\n        complianceInfo: {\r\n          terms2026: true,\r\n          pseAuthorized: source.requiresPSE,\r\n          aiProvider: source.aiProvider,\r\n          noProfiling: true,\r\n          exclusiveUse: true\r\n        }\r\n      };\r\n\r\n    } catch (error) {\r\n      const responseTime = Date.now() - startTime;\r\n      throw new Error(`Error consultando ${source.type}: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Consultar FAQ con cumplimiento\r\n   * @param {Object} source - Fuente FAQ\r\n   * @param {string} message - Mensaje\r\n   * @param {number} companyId - ID de la empresa\r\n   */\r\n  async queryCompliantFAQ(source, message, companyId) {\r\n    const { data, error } = await supabase\r\n      .from('faq_entries')\r\n      .select('*')\r\n      .eq('company_id', companyId)\r\n      .or(`question.ilike.%${message}%,answer.ilike.%${message}%,keywords.ilike.%${message}%`)\r\n      .eq('status', 'active')\r\n      .order('priority', { ascending: true })\r\n      .limit(5);\r\n\r\n    if (error) throw error;\r\n\r\n    if (!data || data.length === 0) {\r\n      return null;\r\n    }\r\n\r\n    const bestMatch = data.find(item => \r\n      item.question.toLowerCase().includes(message.toLowerCase()) ||\r\n      message.toLowerCase().includes(item.question.toLowerCase())\r\n    ) || data[0];\r\n\r\n    return {\r\n      content: bestMatch.answer,\r\n      confidence: 0.9,\r\n      type: 'faq',\r\n      metadata: {\r\n        question: bestMatch.question,\r\n        category: bestMatch.category,\r\n        priority: bestMatch.priority,\r\n        noProfiling: true\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Consultar CRM con cumplimiento (sin perfiles)\r\n   * @param {Object} source - Fuente CRM\r\n   * @param {string} message - Mensaje\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {string} userPhone - Tel√©fono del usuario\r\n   */\r\n  async queryCompliantCRM(source, message, companyId, userPhone) {\r\n    // Buscar informaci√≥n espec√≠fica (sin crear perfiles)\r\n    const { data: customer, error: customerError } = await supabase\r\n      .from('customers')\r\n      .select('*')\r\n      .eq('company_id', companyId)\r\n      .eq('phone', userPhone)\r\n      .single();\r\n\r\n    if (customerError && customerError.code !== 'PGRST116') {\r\n      throw customerError;\r\n    }\r\n\r\n    // Buscar interacciones recientes (sin historial extenso que podr√≠a ser perfil)\r\n    const { data: recentInteractions, error: interactionError } = await supabase\r\n      .from('customer_interactions')\r\n      .select('*')\r\n      .eq('company_id', companyId)\r\n      .eq('customer_phone', userPhone)\r\n      .order('created_at', { ascending: false })\r\n      .limit(3); // Solo interacciones muy recientes\r\n\r\n    if (interactionError) throw interactionError;\r\n\r\n    // Generar respuesta sin crear/ampliar perfiles\r\n    const crmResponse = this.generateCompliantCRMResponse(message, customer, recentInteractions);\r\n\r\n    return {\r\n      content: crmResponse.content,\r\n      confidence: crmResponse.confidence,\r\n      type: 'crm_data',\r\n      metadata: {\r\n        hasRecentData: !!(customer && recentInteractions?.length > 0),\r\n        lastInteraction: recentInteractions?.[0]?.created_at,\r\n        noProfiling: true,\r\n        dataMinimal: true\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Generar respuesta CRM sin crear perfiles (cumpliendo t√©rminos 2026)\r\n   * @param {string} message - Mensaje del usuario\r\n   * @param {Object} customer - Datos del cliente\r\n   * @param {Array} interactions - Interacciones recientes\r\n   */\r\n  generateCompliantCRMResponse(message, customer, interactions) {\r\n    if (!customer) {\r\n      return {\r\n        content: 'No encuentro informaci√≥n reciente. ¬øEn qu√© puedo ayudarte?',\r\n        confidence: 0.6\r\n      };\r\n    }\r\n\r\n    // Respuesta basada solo en datos muy recientes (sin perfil hist√≥rico)\r\n    if (interactions && interactions.length > 0) {\r\n      const lastInteraction = interactions[0];\r\n      const hoursSinceLastInteraction = (Date.now() - new Date(lastInteraction.created_at).getTime()) / (1000 * 60 * 60);\r\n      \r\n      if (hoursSinceLastInteraction < 24) {\r\n        return {\r\n          content: `Veo que tu consulta reciente fue sobre \"${lastInteraction.topic}\". ¬øEn qu√© puedo ayudarte hoy?`,\r\n          confidence: 0.8\r\n        };\r\n      }\r\n    }\r\n\r\n    return {\r\n      content: `Hola. ¬øEn qu√© puedo ayudarte hoy?`,\r\n      confidence: 0.7\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Consultar base de datos con cumplimiento\r\n   * @param {Object} source - Fuente de base de datos\r\n   * @param {string} message - Mensaje\r\n   * @param {number} companyId - ID de la empresa\r\n   */\r\n  async queryCompliantDatabase(source, message, companyId) {\r\n    const { data, error } = await supabase.rpc('search_knowledge_base_compliant', {\r\n      p_company_id: companyId,\r\n      p_query: message,\r\n      p_limit: 5,\r\n      p_no_profiling: true // Par√°metro para asegurar cumplimiento\r\n    });\r\n\r\n    if (error) throw error;\r\n\r\n    if (!data || data.length === 0) {\r\n      return null;\r\n    }\r\n\r\n    const bestMatch = data[0];\r\n\r\n    return {\r\n      content: bestMatch.content,\r\n      confidence: bestMatch.similarity_score || 0.8,\r\n      type: 'database',\r\n      metadata: {\r\n        table: bestMatch.table_name,\r\n        id: bestMatch.record_id,\r\n        similarity: bestMatch.similarity_score,\r\n        noProfiling: true\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Consultar API externa con cumplimiento\r\n   * @param {Object} source - Fuente API\r\n   * @param {string} message - Mensaje\r\n   * @param {number} companyId - ID de la empresa\r\n   */\r\n  async queryCompliantAPI(source, message, companyId) {\r\n    const response = await fetch(source.endpoint, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'X-Company-ID': companyId.toString(),\r\n        'X-Terms-2026': 'compliant',\r\n        ...source.headers\r\n      },\r\n      body: JSON.stringify({\r\n        query: message,\r\n        timestamp: new Date().toISOString(),\r\n        source: 'whatsapp_business_2026_compliant',\r\n        noProfiling: true,\r\n        exclusiveUse: true\r\n      }),\r\n      signal: AbortSignal.timeout(source.timeout || 5000)\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`API response: ${response.status} ${response.statusText}`);\r\n    }\r\n\r\n    const data = await response.json();\r\n\r\n    // Validar que la API no incluye datos de perfil\r\n    if (data.profileData || data.userTracking) {\r\n      throw new Error('API devuelve datos de perfil (prohibido por t√©rminos 2026)');\r\n    }\r\n\r\n    return {\r\n      content: data.answer || data.response || data.content,\r\n      confidence: data.confidence || 0.8,\r\n      type: 'api_response',\r\n      metadata: {\r\n        endpoint: source.endpoint,\r\n        responseTime: data.responseTime,\r\n        requestId: data.requestId,\r\n        noProfiling: true\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Consultar IA con cumplimiento estricto de t√©rminos 2026\r\n   * @param {Object} source - Fuente de IA\r\n   * @param {string} message - Mensaje\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {string} userPhone - Tel√©fono del usuario\r\n   */\r\n  async queryCompliantAI(source, message, companyId, userPhone) {\r\n    // Verificaciones estrictas para IA seg√∫n t√©rminos 2026\r\n    \r\n    // 1. Obtener modelo aislado para este cliente\r\n    const isolatedModel = await this.getIsolatedModel(companyId, source);\r\n    \r\n    // 2. Procesar con prohibici√≥n expl√≠cita de entrenamiento\r\n    const response = await isolatedModel.generate({\r\n      input: message,\r\n      mode: 'inference_only', // Solo inferencia\r\n      training: false, // Expl√≠citamente prohibido\r\n      data_retention: 'none', // No retener datos\r\n      no_profiling: true,\r\n      exclusive_use: true,\r\n      user_hash: this.hashUserData(userPhone) // Hash en lugar de datos reales\r\n    });\r\n\r\n    // 3. Validar que no se usaron datos para entrenamiento\r\n    if (response.trainingDataUsed || response.modelUpdated) {\r\n      throw new Error('Modelo de IA us√≥ datos para entrenamiento (prohibido por t√©rminos 2026)');\r\n    }\r\n\r\n    return {\r\n      content: response.text,\r\n      confidence: response.confidence || 0.75,\r\n      type: 'ai_generated',\r\n      metadata: {\r\n        model: 'isolated_customer_model',\r\n        tokens: response.tokens,\r\n        processingTime: response.processingTime,\r\n        noTrainingData: true,\r\n        exclusiveUse: true,\r\n        modelIsolation: 'complete'\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Obtener modelo aislado para cliente (cumpliendo t√©rminos 2026)\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {Object} source - Fuente de IA\r\n   */\r\n  async getIsolatedModel(companyId, source) {\r\n    const modelKey = `${companyId}_${source.id}`;\r\n    \r\n    if (!this.isolatedModels.has(modelKey)) {\r\n      // Crear modelo completamente aislado\r\n      const isolatedModel = await this.createIsolatedModel({\r\n        companyId,\r\n        sourceId: source.id,\r\n        trainingData: 'none', // Sin datos de entrenamiento\r\n        baseModel: 'generic_untrained', // Modelo base no entrenado\r\n        isolation: 'complete', // Aislamiento completo\r\n        noProfiling: true,\r\n        exclusiveUse: true\r\n      });\r\n      \r\n      this.isolatedModels.set(modelKey, isolatedModel);\r\n    }\r\n    \r\n    return this.isolatedModels.get(modelKey);\r\n  }\r\n\r\n  /**\r\n   * Crear modelo aislado (simulado)\r\n   * @param {Object} config - Configuraci√≥n del modelo aislado\r\n   */\r\n  async createIsolatedModel(config) {\r\n    // Simulaci√≥n de creaci√≥n de modelo aislado\r\n    return {\r\n      generate: async (params) => {\r\n        // Simulaci√≥n de respuesta de IA aislada\r\n        return new Promise((resolve) => {\r\n          setTimeout(() => {\r\n            resolve({\r\n              text: 'Esta es una respuesta de IA aislada para uso exclusivo del cliente. No se utilizan datos para entrenamiento.',\r\n              confidence: 0.75,\r\n              tokens: 45,\r\n              processingTime: 1200,\r\n              trainingDataUsed: false,\r\n              modelUpdated: false\r\n            });\r\n          }, 1000);\r\n        });\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Validar cumplimiento de respuesta\r\n   * @param {Object} response - Respuesta a validar\r\n   * @param {Object} source - Fuente utilizada\r\n   */\r\n  async validateResponseCompliance(response, source) {\r\n    const issues = [];\r\n\r\n    // 1. Validar contenido seg√∫n pol√≠ticas de WhatsApp\r\n    const contentValidation = await whatsappComplianceService.validateMessageContent(\r\n      response.content,\r\n      response.type || 'text'\r\n    );\r\n\r\n    if (!contentValidation.valid) {\r\n      issues.push(`Contenido inv√°lido: ${contentValidation.reason}`);\r\n    }\r\n\r\n    // 2. Validar que no incluye datos de perfil\r\n    if (response.content.includes('perfil') || response.content.includes('historial completo')) {\r\n      issues.push('Respuesta incluye datos de perfil (prohibido por t√©rminos 2026)');\r\n    }\r\n\r\n    // 3. Validar fuente autorizada\r\n    if (!source.complianceVerified || source.agreementStatus !== 'active') {\r\n      issues.push('Fuente no autorizada o no cumplida');\r\n    }\r\n\r\n    return {\r\n      compliant: issues.length === 0,\r\n      reason: issues.join('; ')\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Agregar divulgaci√≥n de cumplimiento t√©rminos 2026\r\n   * @param {Object} response - Respuesta\r\n   * @param {Object} source - Fuente utilizada\r\n   */\r\n  add2026ComplianceDisclosure(response, source) {\r\n    let disclosureText = '';\r\n\r\n    // Transparencia seg√∫n tipo de fuente\r\n    if (source.aiProvider) {\r\n      disclosureText = 'ü§ñ *Respuesta generada por IA aislada para uso exclusivo*\\n\\n';\r\n    } else if (source.type === 'faq') {\r\n      disclosureText = 'üìö *Respuesta de base de conocimiento autorizada*\\n\\n';\r\n    } else if (source.type === 'crm') {\r\n      disclosureText = 'üë§ *Respuesta basada en datos recientes (sin perfiles)*\\n\\n';\r\n    }\r\n\r\n    // Opci√≥n de hablar con humano\r\n    const humanOption = '\\n\\n_Si prefieres hablar con un humano, responde \"HUMANO\"_';\r\n\r\n    return {\r\n      ...response,\r\n      content: disclosureText + response.content + humanOption,\r\n      transparency: {\r\n        terms2026: true,\r\n        sourceType: source.type,\r\n        aiProvider: source.aiProvider,\r\n        noProfiling: true,\r\n        exclusiveUse: true\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Registrar uso cumplido para responsabilidad del cliente\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {string} userPhone - Tel√©fono del usuario\r\n   * @param {string} originalMessage - Mensaje original\r\n   * @param {Object} response - Respuesta generada\r\n   * @param {Object} source - Fuente utilizada\r\n   */\r\n  async recordCompliantUsage(companyId, userPhone, originalMessage, response, source) {\r\n    try {\r\n      // Registrar en tabla de uso cumplido\r\n      const { error } = await supabase\r\n        .from('compliant_knowledge_usage')\r\n        .insert({\r\n          company_id: companyId,\r\n          user_phone_hash: this.hashUserData(userPhone), // Hash para privacidad\r\n          original_message_hash: this.hashUserData(originalMessage),\r\n          response_content: response.content,\r\n          source_id: source.id,\r\n          source_type: source.type,\r\n          pse_authorized: source.requiresPSE,\r\n          ai_provider: source.aiProvider,\r\n          confidence: response.confidence,\r\n          response_time: response.responseTime,\r\n          terms_2026_compliant: true,\r\n          no_profiling: true,\r\n          exclusive_use: true,\r\n          created_at: new Date().toISOString()\r\n        });\r\n\r\n      if (error) throw error;\r\n\r\n      // Tambi√©n registrar como interacci√≥n est√°ndar de WhatsApp\r\n      await whatsappComplianceService.recordUserInteraction(\r\n        companyId,\r\n        userPhone,\r\n        'compliant_knowledge_response',\r\n        {\r\n          source: source.type,\r\n          confidence: response.confidence,\r\n          terms2026: true\r\n        }\r\n      );\r\n\r\n    } catch (error) {\r\n      console.error('Error registrando uso cumplido:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generar hash para datos de usuario (privacidad)\r\n   * @param {string} data - Datos a hashear\r\n   */\r\n  hashUserData(data) {\r\n    // Simulaci√≥n de hash (en producci√≥n usar crypto real)\r\n    return btoa(data).replace(/[^a-zA-Z0-9]/g, '').substring(0, 16);\r\n  }\r\n\r\n  /**\r\n   * Generar reporte de cumplimiento para Meta\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {Object} period - Per√≠odo del reporte\r\n   */\r\n  async generateComplianceReport(companyId, period = {}) {\r\n    const report = {\r\n      period: period.start && period.end ? { start: period.start, end: period.end } : 'last_30_days',\r\n      companyId,\r\n      timestamp: new Date().toISOString(),\r\n      terms2026: true,\r\n      \r\n      // Reporte de PSE\r\n      externalProviders: await this.getExternalProviderReport(companyId, period),\r\n      \r\n      // Reporte de uso de IA\r\n      aiUsage: await this.getAIUsageReport(companyId, period),\r\n      \r\n      // Verificaci√≥n de restricciones\r\n      dataRestrictions: await this.getDataRestrictionsReport(companyId, period),\r\n      \r\n      // Incidentes de cumplimiento\r\n      complianceIncidents: await this.getComplianceIncidents(companyId, period),\r\n      \r\n      // Evidencia de cumplimiento\r\n      complianceEvidence: await this.getComplianceEvidence(companyId, period)\r\n    };\r\n\r\n    // Guardar reporte\r\n    await this.saveComplianceReport(companyId, report);\r\n\r\n    return report;\r\n  }\r\n\r\n  /**\r\n   * Obtener reporte de proveedores externos\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {Object} period - Per√≠odo\r\n   */\r\n  async getExternalProviderReport(companyId, period) {\r\n    const providers = Array.from(this.authorizedProviders.values())\r\n      .filter(p => p.companyId === companyId && p.requiresPSE);\r\n\r\n    return {\r\n      authorizedProviders: providers.map(p => ({\r\n        id: p.id,\r\n        name: p.name,\r\n        type: p.type,\r\n        agreementStatus: p.agreementStatus,\r\n        complianceVerified: p.complianceVerified\r\n      })),\r\n      usageStats: await this.getProviderUsageStats(companyId, period),\r\n      complianceStatus: 'verified'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Obtener reporte de uso de IA\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {Object} period - Per√≠odo\r\n   */\r\n  async getAIUsageReport(companyId, period) {\r\n    const { data, error } = await supabase\r\n      .from('compliant_knowledge_usage')\r\n      .select('*')\r\n      .eq('company_id', companyId)\r\n      .eq('ai_provider', true)\r\n      .gte('created_at', period.start || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString())\r\n      .lte('created_at', period.end || new Date().toISOString());\r\n\r\n    if (error) throw error;\r\n\r\n    return {\r\n      totalAIQueries: data?.length || 0,\r\n      averageConfidence: data?.reduce((sum, d) => sum + (d.confidence || 0), 0) / (data?.length || 1),\r\n      modelIsolationVerified: true,\r\n      noTrainingDataVerified: data?.every(d => d.no_profiling && d.exclusive_use) || false,\r\n      exclusiveUseVerified: true\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Guardar reporte de cumplimiento\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {Object} report - Reporte a guardar\r\n   */\r\n  async saveComplianceReport(companyId, report) {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('compliance_reports')\r\n        .insert({\r\n          company_id: companyId,\r\n          report_type: 'terms_2026_compliance',\r\n          report_data: report,\r\n          created_at: new Date().toISOString()\r\n        });\r\n\r\n      if (error) throw error;\r\n    } catch (error) {\r\n      console.error('Error guardando reporte de cumplimiento:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Registrar incidente de cumplimiento\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {string} providerId - ID del proveedor\r\n   * @param {string} description - Descripci√≥n del incidente\r\n   */\r\n  async recordComplianceIncident(companyId, providerId, description) {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('compliance_incidents')\r\n        .insert({\r\n          company_id: companyId,\r\n          provider_id: providerId,\r\n          incident_type: 'terms_2026_violation',\r\n          description,\r\n          severity: 'medium',\r\n          resolved: false,\r\n          created_at: new Date().toISOString()\r\n        });\r\n\r\n      if (error) throw error;\r\n    } catch (error) {\r\n      console.error('Error registrando incidente:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Registrar error de cumplimiento\r\n   * @param {number} companyId - ID de la empresa\r\n   * @param {string} userPhone - Tel√©fono del usuario\r\n   * @param {string} error - Error\r\n   */\r\n  async recordComplianceError(companyId, userPhone, error) {\r\n    try {\r\n      await supabase\r\n        .from('compliance_errors')\r\n        .insert({\r\n          company_id: companyId,\r\n          user_phone_hash: this.hashUserData(userPhone),\r\n          error_message: error,\r\n          error_type: 'terms_2026_compliance',\r\n          created_at: new Date().toISOString()\r\n        });\r\n    } catch (e) {\r\n      console.error('Error registrando error de cumplimiento:', e);\r\n    }\r\n  }\r\n}\r\n\r\n// Crear instancia global del servicio cumplido\r\nconst whatsapp2026CompliantKnowledgeService = new WhatsApp2026CompliantKnowledgeService();\r\n\r\nexport default whatsapp2026CompliantKnowledgeService;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\whatsappAIService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\whatsappComplianceService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'twentyFourHoursAgo' is assigned a value but never used.","line":204,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":204,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Servicio de Cumplimiento de Pol√≠ticas de WhatsApp Business\r\n * \r\n * Este servicio asegura que StaffHub cumpla con las pol√≠ticas actualizadas\r\n * de WhatsApp Business API (2024-2025)\r\n */\r\n\r\nimport { supabase } from '../lib/supabase.js';\r\n\r\nclass WhatsAppComplianceService {\r\n  constructor() {\r\n    this.consentCache = new Map();\r\n    this.windowCache = new Map();\r\n    this.cacheTimeout = 5 * 60 * 1000; // 5 minutos\r\n  }\r\n\r\n  // ========================================\r\n  // GESTI√ìN DE CONSENTIMIENTO\r\n  // ========================================\r\n\r\n  /**\r\n   * Verificar si hay consentimiento activo para un usuario\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {string} phoneNumber - N√∫mero de tel√©fono\r\n   * @returns {Promise<boolean>} Tiene consentimiento activo\r\n   */\r\n  async hasActiveConsent(companyId, phoneNumber) {\r\n    const cacheKey = `consent_${companyId}_${phoneNumber}`;\r\n    const cached = this.getFromCache(cacheKey);\r\n    if (cached !== null) return cached;\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('user_consent')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .eq('phone_number', this.formatPhoneNumber(phoneNumber))\r\n        .eq('status', 'active')\r\n        .single();\r\n\r\n      if (error || !data) {\r\n        this.setCache(cacheKey, false);\r\n        return false;\r\n      }\r\n\r\n      // Verificar que el consentimiento no haya expirado\r\n      const now = new Date();\r\n      const expiresAt = new Date(data.expires_at);\r\n      \r\n      const isActive = data.status === 'active' && expiresAt > now;\r\n      this.setCache(cacheKey, isActive);\r\n      \r\n      return isActive;\r\n\r\n    } catch (error) {\r\n      console.error('Error verificando consentimiento:', error);\r\n      this.setCache(cacheKey, false);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Registrar consentimiento de usuario\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {string} phoneNumber - N√∫mero de tel√©fono\r\n   * @param {string} consentType - Tipo de consentimiento (marketing, utility, authentication)\r\n   * @param {Object} metadata - Metadatos adicionales\r\n   * @returns {Promise<Object>} Resultado del registro\r\n   */\r\n  async recordConsent(companyId, phoneNumber, consentType, metadata = {}) {\r\n    try {\r\n      const now = new Date();\r\n      const expiresAt = new Date(now.getTime() + (365 * 24 * 60 * 60 * 1000)); // 1 a√±o\r\n\r\n      const { data, error } = await supabase\r\n        .from('user_consent')\r\n        .upsert({\r\n          company_id: companyId,\r\n          phone_number: this.formatPhoneNumber(phoneNumber),\r\n          consent_type: consentType,\r\n          status: 'active',\r\n          granted_at: now.toISOString(),\r\n          expires_at: expiresAt.toISOString(),\r\n          metadata: {\r\n            source: metadata.source || 'manual',\r\n            ip_address: metadata.ipAddress,\r\n            user_agent: metadata.userAgent,\r\n            ...metadata\r\n          },\r\n          created_at: now.toISOString()\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      // Limpiar cache\r\n      this.clearCache(`consent_${companyId}_${phoneNumber}`);\r\n\r\n      // Registrar evento de auditor√≠a\r\n      await this.logComplianceEvent({\r\n        companyId,\r\n        eventType: 'consent_granted',\r\n        details: {\r\n          phoneNumber,\r\n          consentType,\r\n          expiresAt: expiresAt.toISOString()\r\n        }\r\n      });\r\n\r\n      return {\r\n        success: true,\r\n        consent: data,\r\n        message: 'Consentimiento registrado exitosamente'\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error registrando consentimiento:', error);\r\n      return {\r\n        success: false,\r\n        message: `Error registrando consentimiento: ${error.message}`,\r\n        error: error.message\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Revocar consentimiento de usuario (Opt-out)\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {string} phoneNumber - N√∫mero de tel√©fono\r\n   * @param {Object} metadata - Metadatos adicionales\r\n   * @returns {Promise<Object>} Resultado de la revocaci√≥n\r\n   */\r\n  async revokeConsent(companyId, phoneNumber, metadata = {}) {\r\n    try {\r\n      const now = new Date();\r\n\r\n      const { data, error } = await supabase\r\n        .from('user_consent')\r\n        .update({\r\n          status: 'revoked',\r\n          revoked_at: now.toISOString(),\r\n          metadata: {\r\n            ...metadata,\r\n            revoked_at: now.toISOString()\r\n          }\r\n        })\r\n        .eq('company_id', companyId)\r\n        .eq('phone_number', this.formatPhoneNumber(phoneNumber))\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      // Limpiar cache\r\n      this.clearCache(`consent_${companyId}_${phoneNumber}`);\r\n\r\n      // Registrar evento de auditor√≠a\r\n      await this.logComplianceEvent({\r\n        companyId,\r\n        eventType: 'consent_revoked',\r\n        details: {\r\n          phoneNumber,\r\n          revokedAt: now.toISOString()\r\n        }\r\n      });\r\n\r\n      // Enviar confirmaci√≥n de opt-out si est√° configurado\r\n      await this.sendOptOutConfirmation(companyId, phoneNumber);\r\n\r\n      return {\r\n        success: true,\r\n        consent: data,\r\n        message: 'Consentimiento revocado exitosamente'\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error revocando consentimiento:', error);\r\n      return {\r\n        success: false,\r\n        message: `Error revocando consentimiento: ${error.message}`,\r\n        error: error.message\r\n      };\r\n    }\r\n  }\r\n\r\n  // ========================================\r\n  // VERIFICACI√ìN DE VENTANA DE 24 HORAS\r\n  // ========================================\r\n\r\n  /**\r\n   * Verificar si est√° dentro de la ventana de 24 horas\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {string} phoneNumber - N√∫mero de tel√©fono\r\n   * @returns {Promise<Object>} Estado de la ventana\r\n   */\r\n  async check24HourWindow(companyId, phoneNumber) {\r\n    const cacheKey = `window_${companyId}_${phoneNumber}`;\r\n    const cached = this.getFromCache(cacheKey);\r\n    if (cached !== null) return cached;\r\n\r\n    try {\r\n      const now = new Date();\r\n      const twentyFourHoursAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));\r\n\r\n      // Buscar √∫ltima interacci√≥n del usuario\r\n      const { data, error } = await supabase\r\n        .from('whatsapp_logs')\r\n        .select('created_at, direction, message_type')\r\n        .eq('company_id', companyId)\r\n        .eq('recipient_phone', this.formatPhoneNumber(phoneNumber))\r\n        .in('direction', ['inbound', 'status_update'])\r\n        .order('created_at', { ascending: false })\r\n        .limit(1)\r\n        .single();\r\n\r\n      if (error || !data) {\r\n        const result = {\r\n          inWindow: false,\r\n          lastInteraction: null,\r\n          hoursSinceInteraction: null,\r\n          requiresTemplate: true\r\n        };\r\n        this.setCache(cacheKey, result);\r\n        return result;\r\n      }\r\n\r\n      const lastInteraction = new Date(data.created_at);\r\n      const hoursSinceInteraction = (now - lastInteraction) / (1000 * 60 * 60);\r\n      const inWindow = hoursSinceInteraction <= 24;\r\n\r\n      const result = {\r\n        inWindow,\r\n        lastInteraction: data.created_at,\r\n        hoursSinceInteraction: Math.round(hoursSinceInteraction * 100) / 100,\r\n        requiresTemplate: !inWindow\r\n      };\r\n\r\n      this.setCache(cacheKey, result);\r\n      return result;\r\n\r\n    } catch (error) {\r\n      console.error('Error verificando ventana de 24 horas:', error);\r\n      const result = {\r\n        inWindow: false,\r\n        lastInteraction: null,\r\n        hoursSinceInteraction: null,\r\n        requiresTemplate: true,\r\n        error: error.message\r\n      };\r\n      this.setCache(cacheKey, result);\r\n      return result;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Registrar interacci√≥n del usuario (para mantener ventana activa)\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {string} phoneNumber - N√∫mero de tel√©fono\r\n   * @param {string} interactionType - Tipo de interacci√≥n\r\n   * @param {Object} metadata - Metadatos adicionales\r\n   * @returns {Promise<Object>} Resultado del registro\r\n   */\r\n  async recordUserInteraction(companyId, phoneNumber, interactionType, metadata = {}) {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('user_interactions')\r\n        .insert({\r\n          company_id: companyId,\r\n          phone_number: this.formatPhoneNumber(phoneNumber),\r\n          interaction_type: interactionType,\r\n          metadata,\r\n          created_at: new Date().toISOString()\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      // Limpiar cache de ventana\r\n      this.clearCache(`window_${companyId}_${phoneNumber}`);\r\n\r\n      return {\r\n        success: true,\r\n        interaction: data,\r\n        message: 'Interacci√≥n registrada exitosamente'\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error registrando interacci√≥n:', error);\r\n      return {\r\n        success: false,\r\n        message: `Error registrando interacci√≥n: ${error.message}`,\r\n        error: error.message\r\n      };\r\n    }\r\n  }\r\n\r\n  // ========================================\r\n  // VALIDACI√ìN DE CONTENIDO Y PLANTILLAS\r\n  // ========================================\r\n\r\n  /**\r\n   * Validar contenido de mensaje seg√∫n pol√≠ticas de WhatsApp\r\n   * @param {string} content - Contenido del mensaje\r\n   * @param {string} messageType - Tipo de mensaje (text, template, media)\r\n   * @returns {Promise<Object>} Resultado de la validaci√≥n\r\n   */\r\n  async validateMessageContent(content, messageType = 'text') {\r\n    try {\r\n      // Lista de contenido prohibido\r\n      const prohibitedContent = [\r\n        'spam', 'scam', 'fraud', 'illegal', 'adult content',\r\n        'gambling', 'alcohol', 'tobacco', 'weapons', 'drugs',\r\n        'hate speech', 'violence', 'terrorism'\r\n      ];\r\n\r\n      const lowerContent = content.toLowerCase();\r\n\r\n      // Verificar contenido prohibido\r\n      for (const term of prohibitedContent) {\r\n        if (lowerContent.includes(term)) {\r\n          return {\r\n            valid: false,\r\n            reason: `Contenido prohibido detectado: ${term}`,\r\n            severity: 'high',\r\n            category: 'prohibited_content'\r\n          };\r\n        }\r\n      }\r\n\r\n      // Verificar caracter√≠sticas de spam\r\n      const spamIndicators = [\r\n        /\\b(free|win|prize|lottery|congratulations|winner)\\b/i,\r\n        /\\b(urgent|act now|limited time|offer expires)\\b/i,\r\n        /\\b(click here|buy now|shop now)\\b/i,\r\n        /\\+\\d{1,3}.*\\d{3,}.*\\d{3,}.*\\d{4}/, // M√∫ltiples n√∫meros de tel√©fono\r\n        /([A-Z]{2,}){3,}/ // Exceso de may√∫sculas\r\n      ];\r\n\r\n      let spamScore = 0;\r\n      for (const indicator of spamIndicators) {\r\n        if (indicator.test(content)) {\r\n          spamScore++;\r\n        }\r\n      }\r\n\r\n      if (spamScore >= 2) {\r\n        return {\r\n          valid: false,\r\n          reason: 'Contenido detectado como posible spam',\r\n          severity: 'medium',\r\n          category: 'spam_indicators',\r\n          spamScore\r\n        };\r\n      }\r\n\r\n      // Validaciones espec√≠ficas por tipo\r\n      if (messageType === 'template') {\r\n        return this.validateTemplateContent(content);\r\n      }\r\n\r\n      return {\r\n        valid: true,\r\n        message: 'Contenido validado exitosamente',\r\n        spamScore: 0\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error validando contenido:', error);\r\n      return {\r\n        valid: false,\r\n        reason: `Error en validaci√≥n: ${error.message}`,\r\n        severity: 'low'\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validar contenido de plantilla\r\n   * @param {string} content - Contenido de la plantilla\r\n   * @returns {Object} Resultado de la validaci√≥n\r\n   */\r\n  validateTemplateContent(content) {\r\n    // Validaciones espec√≠ficas para plantillas\r\n    const templateRules = {\r\n      maxLength: 1024,\r\n      requiredPlaceholders: ['{{1}}', '{{2}}'],\r\n      prohibitedPhrases: ['unsubscribe', 'opt out', 'stop'],\r\n      maxVariables: 10\r\n    };\r\n\r\n    if (content.length > templateRules.maxLength) {\r\n      return {\r\n        valid: false,\r\n        reason: `Plantilla demasiado larga. M√°ximo ${templateRules.maxLength} caracteres`,\r\n        severity: 'medium',\r\n        category: 'template_length'\r\n      };\r\n    }\r\n\r\n    // Verificar frases prohibidas en plantillas\r\n    for (const phrase of templateRules.prohibitedPhrases) {\r\n      if (content.toLowerCase().includes(phrase)) {\r\n        return {\r\n          valid: false,\r\n          reason: `Frase prohibida en plantilla: ${phrase}`,\r\n          severity: 'high',\r\n          category: 'template_content'\r\n        };\r\n      }\r\n    }\r\n\r\n    return {\r\n      valid: true,\r\n      message: 'Plantilla validada exitosamente'\r\n    };\r\n  }\r\n\r\n  // ========================================\r\n  // MONITOREO DE CALIDAD Y L√çMITES\r\n  // ========================================\r\n\r\n  /**\r\n   * Verificar calidad del n√∫mero y ajustar l√≠mites\r\n   * @param {string} companyId - ID de la empresa\r\n   * @returns {Promise<Object>} Estado de calidad y l√≠mites\r\n   */\r\n  async checkQualityAndLimits(companyId) {\r\n    try {\r\n      // Obtener configuraci√≥n de WhatsApp\r\n      const { data: config, error } = await supabase\r\n        .from('whatsapp_configs')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .eq('is_active', true)\r\n        .single();\r\n\r\n      if (error || !config) {\r\n        throw new Error('No hay configuraci√≥n de WhatsApp activa');\r\n      }\r\n\r\n      // Calcular l√≠mites din√°micos basados en calidad\r\n      let baseDailyLimit = 1000;\r\n      let multiplier = 1;\r\n\r\n      switch (config.quality_rating) {\r\n        case 'GREEN':\r\n          multiplier = 1.5;\r\n          break;\r\n        case 'YELLOW':\r\n          multiplier = 0.7;\r\n          break;\r\n        case 'RED':\r\n          multiplier = 0; // Bloquear env√≠os\r\n          break;\r\n        default:\r\n          multiplier = 0.5;\r\n      }\r\n\r\n      // Ajustar por tasa de consentimiento\r\n      const consentRate = await this.getConsentRate(companyId);\r\n      multiplier *= consentRate;\r\n\r\n      const dynamicLimits = {\r\n        dailyLimit: Math.floor(baseDailyLimit * multiplier),\r\n        monthlyLimit: Math.floor(baseDailyLimit * multiplier * 30),\r\n        messagesPerSecond: config.quality_rating === 'GREEN' ? 10 : 5,\r\n        canSend: config.quality_rating !== 'RED',\r\n        qualityRating: config.quality_rating,\r\n        consentRate\r\n      };\r\n\r\n      // Enviar alertas si es necesario\r\n      if (config.quality_rating === 'RED') {\r\n        await this.sendQualityAlert(companyId, 'CRITICAL', {\r\n          message: 'N√∫mero en calificaci√≥n ROJA. Todos los env√≠os suspendidos.',\r\n          action: 'contact_support_immediately'\r\n        });\r\n      } else if (config.quality_rating === 'YELLOW') {\r\n        await this.sendQualityAlert(companyId, 'WARNING', {\r\n          message: 'Degradaci√≥n de calidad detectada. L√≠mites reducidos.',\r\n          recommendations: [\r\n            'Reducir mensajes de marketing',\r\n            'Mejorar tiempo de respuesta',\r\n            'Verificar contenido de mensajes'\r\n          ]\r\n        });\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        limits: dynamicLimits,\r\n        config\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error verificando calidad y l√≠mites:', error);\r\n      return {\r\n        success: false,\r\n        message: `Error verificando calidad: ${error.message}`,\r\n        error: error.message\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener tasa de consentimiento de una empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @returns {Promise<number>} Tasa de consentimiento (0-1)\r\n   */\r\n  async getConsentRate(companyId) {\r\n    try {\r\n      const { data: total, error: totalError } = await supabase\r\n        .from('user_consent')\r\n        .select('phone_number', { count: 'exact' })\r\n        .eq('company_id', companyId);\r\n\r\n      if (totalError) throw totalError;\r\n\r\n      const { data: active, error: activeError } = await supabase\r\n        .from('user_consent')\r\n        .select('phone_number', { count: 'exact' })\r\n        .eq('company_id', companyId)\r\n        .eq('status', 'active');\r\n\r\n      if (activeError) throw activeError;\r\n\r\n      const totalUsers = total || 0;\r\n      const activeUsers = active || 0;\r\n\r\n      return totalUsers > 0 ? activeUsers / totalUsers : 0;\r\n\r\n    } catch (error) {\r\n      console.error('Error calculando tasa de consentimiento:', error);\r\n      return 0.5; // Valor por defecto conservador\r\n    }\r\n  }\r\n\r\n  // ========================================\r\n  // UTILIDADES Y AUDITOR√çA\r\n  // ========================================\r\n\r\n  /**\r\n   * Formatear n√∫mero de tel√©fono\r\n   * @param {string} phone - N√∫mero de tel√©fono\r\n   * @returns {string} N√∫mero formateado\r\n   */\r\n  formatPhoneNumber(phone) {\r\n    // Eliminar caracteres no num√©ricos excepto +\r\n    let formatted = phone.replace(/[^\\d+]/g, '');\r\n    \r\n    // Asegurar que comience con +\r\n    if (!formatted.startsWith('+')) {\r\n      if (formatted.startsWith('9') && formatted.length === 9) {\r\n        formatted = '+56' + formatted; // Asumir Chile\r\n      } else {\r\n        formatted = '+' + formatted;\r\n      }\r\n    }\r\n    \r\n    return formatted;\r\n  }\r\n\r\n  /**\r\n   * Registrar evento de auditor√≠a de cumplimiento\r\n   * @param {Object} event - Datos del evento\r\n   * @returns {Promise<void>}\r\n   */\r\n  async logComplianceEvent(event) {\r\n    try {\r\n      await supabase\r\n        .from('compliance_logs')\r\n        .insert({\r\n          company_id: event.companyId,\r\n          event_type: event.eventType,\r\n          details: event.details,\r\n          user_id: event.userId || null,\r\n          ip_address: event.ipAddress || null,\r\n          user_agent: event.userAgent || null,\r\n          created_at: new Date().toISOString()\r\n        });\r\n\r\n    } catch (error) {\r\n      console.error('Error registrando evento de auditor√≠a:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enviar alerta de calidad\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {string} severity - Severidad (INFO, WARNING, CRITICAL)\r\n   * @param {Object} alertData - Datos de la alerta\r\n   * @returns {Promise<void>}\r\n   */\r\n  async sendQualityAlert(companyId, severity, alertData) {\r\n    try {\r\n      await supabase\r\n        .from('company_notifications')\r\n        .insert({\r\n          company_id: companyId,\r\n          type: 'quality_alert',\r\n          title: `Alerta de Calidad - ${severity}`,\r\n          message: alertData.message,\r\n          priority: severity.toLowerCase(),\r\n          metadata: alertData,\r\n          created_at: new Date().toISOString()\r\n        });\r\n\r\n    } catch (error) {\r\n      console.error('Error enviando alerta de calidad:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enviar confirmaci√≥n de opt-out\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {string} phoneNumber - N√∫mero de tel√©fono\r\n   * @returns {Promise<void>}\r\n   */\r\n  async sendOptOutConfirmation(companyId, phoneNumber) {\r\n    try {\r\n      // Importar servicio de WhatsApp para enviar confirmaci√≥n\r\n      const { default: multiWhatsAppService } = await import('./multiWhatsAppService.js');\r\n      \r\n      const config = await multiWhatsAppService.getWhatsAppConfigByCompany(companyId);\r\n      if (!config) return;\r\n\r\n      await multiWhatsAppService.sendMessageByCompany(companyId, {\r\n        recipients: [phoneNumber],\r\n        messageType: 'template',\r\n        templateName: 'opt_out_confirmation',\r\n        templateLanguage: 'es',\r\n        components: [\r\n          {\r\n            type: 'body',\r\n            parameters: [\r\n              {\r\n                type: 'text',\r\n                text: 'Has sido eliminado de nuestra lista de comunicaci√≥n. No recibir√°s m√°s mensajes.'\r\n              }\r\n            ]\r\n          }\r\n        ]\r\n      });\r\n\r\n    } catch (error) {\r\n      console.error('Error enviando confirmaci√≥n de opt-out:', error);\r\n    }\r\n  }\r\n\r\n  // ========================================\r\n  // M√âTODOS DE CACHE\r\n  // ========================================\r\n\r\n  getFromCache(key) {\r\n    const cached = this.consentCache.get(key) || this.windowCache.get(key);\r\n    if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {\r\n      return cached.data;\r\n    }\r\n    \r\n    this.consentCache.delete(key);\r\n    this.windowCache.delete(key);\r\n    return null;\r\n  }\r\n\r\n  setCache(key, data) {\r\n    const cacheData = {\r\n      data,\r\n      timestamp: Date.now()\r\n    };\r\n    \r\n    if (key.startsWith('consent_')) {\r\n      this.consentCache.set(key, cacheData);\r\n    } else if (key.startsWith('window_')) {\r\n      this.windowCache.set(key, cacheData);\r\n    }\r\n  }\r\n\r\n  clearCache(key = null) {\r\n    if (key) {\r\n      this.consentCache.delete(key);\r\n      this.windowCache.delete(key);\r\n    } else {\r\n      this.consentCache.clear();\r\n      this.windowCache.clear();\r\n    }\r\n  }\r\n}\r\n\r\n// Crear instancia global del servicio\r\nconst whatsappComplianceService = new WhatsAppComplianceService();\r\n\r\nexport default whatsappComplianceService;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\whatsappConnectionService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\whatsappOfficialService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\whatsappQueueService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'today' is assigned a value but never used.","line":248,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":248,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Servicio de Colas para WhatsApp Business API\r\n *\r\n * Gestiona el env√≠o masivo de mensajes respetando los l√≠mites de rate limiting\r\n * de WhatsApp Business API para evitar bloqueos y optimizar la entrega.\r\n */\r\n\r\nclass WhatsAppQueueService {\r\n  constructor() {\r\n    this.queues = new Map(); // companyId -> queue\r\n    this.processing = new Map(); // companyId -> boolean\r\n    this.batchSize = 10; // mensajes por lote\r\n    this.delayBetweenBatches = 1000; // 1 segundo entre lotes\r\n    this.maxRetries = 3;\r\n    this.retryDelay = 5000; // 5 segundos entre reintentos\r\n  }\r\n\r\n  /**\r\n   * Agrega mensajes a la cola de una empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {Array} messages - Array de mensajes a enviar\r\n   * @param {Object} options - Opciones adicionales\r\n   * @returns {Promise<Object>} Resultado de la operaci√≥n\r\n   */\r\n  async addToQueue(companyId, messages, options = {}) {\r\n    try {\r\n      if (!this.queues.has(companyId)) {\r\n        this.queues.set(companyId, []);\r\n      }\r\n\r\n      const queue = this.queues.get(companyId);\r\n      const messageBatch = {\r\n        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),\r\n        messages: messages,\r\n        options: {\r\n          priority: options.priority || 'normal', // high, normal, low\r\n          scheduledTime: options.scheduledTime || null,\r\n          campaignId: options.campaignId || null,\r\n          ...options\r\n        },\r\n        status: 'queued',\r\n        createdAt: new Date(),\r\n        retries: 0,\r\n        results: []\r\n      };\r\n\r\n      queue.push(messageBatch);\r\n\r\n      // Inicia el procesamiento si no est√° corriendo\r\n      if (!this.processing.get(companyId)) {\r\n        this.processQueue(companyId);\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        batchId: messageBatch.id,\r\n        queueLength: queue.length,\r\n        message: `Agregado lote de ${messages.length} mensajes a la cola`\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error agregando a cola:', error);\r\n      return {\r\n        success: false,\r\n        error: error.message\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Procesa la cola de mensajes de una empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   */\r\n  async processQueue(companyId) {\r\n    if (this.processing.get(companyId)) {\r\n      return; // Ya est√° procesando\r\n    }\r\n\r\n    this.processing.set(companyId, true);\r\n\r\n    try {\r\n      const queue = this.queues.get(companyId) || [];\r\n\r\n      while (queue.length > 0) {\r\n        const batch = queue[0]; // Procesar el primer lote\r\n\r\n        // Verificar si es hora programada\r\n        if (batch.options.scheduledTime && new Date() < new Date(batch.options.scheduledTime)) {\r\n          break; // Salir del loop, esperar al tiempo programado\r\n        }\r\n\r\n        try {\r\n          await this.processBatch(companyId, batch);\r\n          queue.shift(); // Remover el lote procesado exitosamente\r\n        } catch (error) {\r\n          console.error(`Error procesando lote ${batch.id}:`, error);\r\n\r\n          batch.retries++;\r\n          batch.lastError = error.message;\r\n\r\n          if (batch.retries >= this.maxRetries) {\r\n            console.error(`M√°ximo de reintentos alcanzado para lote ${batch.id}`);\r\n            batch.status = 'failed';\r\n            queue.shift(); // Remover despu√©s de m√°ximo reintentos\r\n          } else {\r\n            // Reintentar despu√©s de delay\r\n            await this.delay(this.retryDelay * batch.retries);\r\n            continue;\r\n          }\r\n        }\r\n\r\n        // Delay entre lotes para respetar rate limits\r\n        await this.delay(this.delayBetweenBatches);\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('Error procesando cola:', error);\r\n    } finally {\r\n      this.processing.set(companyId, false);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Procesa un lote de mensajes\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {Object} batch - Lote de mensajes\r\n   */\r\n  async processBatch(companyId, batch) {\r\n    const { messages, options } = batch;\r\n\r\n    // Obtener configuraci√≥n de WhatsApp para la empresa\r\n    const config = await this.getWhatsAppConfig(companyId);\r\n    if (!config) {\r\n      throw new Error(`No se encontr√≥ configuraci√≥n de WhatsApp para empresa ${companyId}`);\r\n    }\r\n\r\n    // Verificar l√≠mites de uso\r\n    await this.checkRateLimits(config);\r\n\r\n    // Procesar mensajes en lotes m√°s peque√±os\r\n    const results = [];\r\n    for (let i = 0; i < messages.length; i += this.batchSize) {\r\n      const messageBatch = messages.slice(i, i + this.batchSize);\r\n\r\n      try {\r\n        const batchResults = await this.sendMessageBatch(config, messageBatch, options);\r\n        results.push(...batchResults);\r\n\r\n        // Actualizar estad√≠sticas\r\n        await this.updateStats(config.id, batchResults);\r\n\r\n        // Peque√±o delay entre sub-lotes\r\n        if (i + this.batchSize < messages.length) {\r\n          await this.delay(500);\r\n        }\r\n\r\n      } catch (error) {\r\n        console.error('Error enviando lote de mensajes:', error);\r\n        throw error;\r\n      }\r\n    }\r\n\r\n    batch.status = 'completed';\r\n    batch.results = results;\r\n    batch.completedAt = new Date();\r\n\r\n    return results;\r\n  }\r\n\r\n  /**\r\n   * Env√≠a un lote de mensajes\r\n   * @param {Object} config - Configuraci√≥n de WhatsApp\r\n   * @param {Array} messages - Mensajes a enviar\r\n   * @param {Object} options - Opciones del env√≠o\r\n   * @returns {Promise<Array>} Resultados del env√≠o\r\n   */\r\n  async sendMessageBatch(config, messages, options) {\r\n    const results = [];\r\n\r\n    for (const message of messages) {\r\n      try {\r\n        const result = await this.sendSingleMessage(config, message, options);\r\n        results.push({\r\n          messageId: message.id,\r\n          success: true,\r\n          whatsappMessageId: result.id,\r\n          status: 'sent',\r\n          timestamp: new Date()\r\n        });\r\n\r\n      } catch (error) {\r\n        console.error(`Error enviando mensaje ${message.id}:`, error);\r\n        results.push({\r\n          messageId: message.id,\r\n          success: false,\r\n          error: error.message,\r\n          status: 'failed',\r\n          timestamp: new Date()\r\n        });\r\n      }\r\n    }\r\n\r\n    return results;\r\n  }\r\n\r\n  /**\r\n   * Env√≠a un mensaje individual\r\n   * @param {Object} config - Configuraci√≥n de WhatsApp\r\n   * @param {Object} message - Mensaje a enviar\r\n   * @param {Object} options - Opciones del env√≠o\r\n   * @returns {Promise<Object>} Resultado del env√≠o\r\n   */\r\n  async sendSingleMessage(config, message, options) {\r\n    const response = await fetch(`https://graph.facebook.com/v18.0/${config.phone_number_id}/messages`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${config.access_token}`,\r\n        'Content-Type': 'application/json'\r\n      },\r\n      body: JSON.stringify({\r\n        messaging_product: 'whatsapp',\r\n        to: message.to,\r\n        type: message.type || 'text',\r\n        text: message.type === 'text' ? { body: message.body } : undefined,\r\n        image: message.type === 'image' ? { link: message.mediaUrl } : undefined,\r\n        document: message.type === 'document' ? {\r\n          link: message.mediaUrl,\r\n          filename: message.filename\r\n        } : undefined,\r\n        ...message.additionalData\r\n      })\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const errorData = await response.json();\r\n      throw new Error(`WhatsApp API Error: ${errorData.error?.message || 'Unknown error'}`);\r\n    }\r\n\r\n    return await response.json();\r\n  }\r\n\r\n  /**\r\n   * Verifica l√≠mites de rate limiting\r\n   * @param {Object} config - Configuraci√≥n de WhatsApp\r\n   */\r\n  async checkRateLimits(config) {\r\n    const now = new Date();\r\n    const today = now.toISOString().split('T')[0];\r\n\r\n    // Verificar l√≠mites diarios\r\n    if (config.messages_sent_today >= config.daily_limit) {\r\n      throw new Error(`L√≠mite diario alcanzado (${config.daily_limit} mensajes)`);\r\n    }\r\n\r\n    // Verificar l√≠mites mensuales\r\n    if (config.messages_sent_month >= config.monthly_limit) {\r\n      throw new Error(`L√≠mite mensual alcanzado (${config.monthly_limit} mensajes)`);\r\n    }\r\n\r\n    // Verificar velocidad de env√≠o (no m√°s de X mensajes por minuto)\r\n    const recentMessages = await this.getRecentMessageCount(config.id, 60); // √∫ltimos 60 segundos\r\n    if (recentMessages >= 20) { // m√°ximo 20 mensajes por minuto\r\n      throw new Error('L√≠mite de velocidad alcanzado. Espera antes de enviar m√°s mensajes.');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene configuraci√≥n de WhatsApp para una empresa\r\n   * @param {string} companyId - ID de la empresa\r\n   * @returns {Promise<Object>} Configuraci√≥n\r\n   */\r\n  async getWhatsAppConfig(companyId) {\r\n    try {\r\n      const { supabase } = await import('../lib/supabaseClient.js');\r\n\r\n      const { data, error } = await supabase\r\n        .from('whatsapp_configs')\r\n        .select('*')\r\n        .eq('company_id', companyId)\r\n        .eq('is_active', true)\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      return data;\r\n    } catch (error) {\r\n      console.error('Error obteniendo configuraci√≥n:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene cantidad de mensajes recientes\r\n   * @param {string} configId - ID de configuraci√≥n\r\n   * @param {number} seconds - Segundos hacia atr√°s\r\n   * @returns {Promise<number>} Cantidad de mensajes\r\n   */\r\n  async getRecentMessageCount(configId, seconds) {\r\n    try {\r\n      const { supabase } = await import('../lib/supabaseClient.js');\r\n\r\n      const since = new Date(Date.now() - seconds * 1000).toISOString();\r\n\r\n      const { count, error } = await supabase\r\n        .from('whatsapp_logs')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('whatsapp_config_id', configId)\r\n        .eq('direction', 'outbound')\r\n        .gte('created_at', since);\r\n\r\n      if (error) throw error;\r\n      return count || 0;\r\n    } catch (error) {\r\n      console.error('Error obteniendo conteo de mensajes recientes:', error);\r\n      return 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Actualiza estad√≠sticas\r\n   * @param {string} configId - ID de configuraci√≥n\r\n   * @param {Array} results - Resultados del env√≠o\r\n   */\r\n  async updateStats(configId, results) {\r\n    try {\r\n      const { supabase } = await import('../lib/supabaseClient.js');\r\n\r\n      const successful = results.filter(r => r.success).length;\r\n      const failed = results.length - successful;\r\n\r\n      // Actualizar contadores\r\n      await supabase.rpc('increment_whatsapp_stats', {\r\n        config_id: configId,\r\n        sent_count: successful,\r\n        failed_count: failed\r\n      });\r\n\r\n    } catch (error) {\r\n      console.error('Error actualizando estad√≠sticas:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene estado de la cola\r\n   * @param {string} companyId - ID de la empresa\r\n   * @returns {Object} Estado de la cola\r\n   */\r\n  getQueueStatus(companyId) {\r\n    const queue = this.queues.get(companyId) || [];\r\n    const isProcessing = this.processing.get(companyId) || false;\r\n\r\n    return {\r\n      queueLength: queue.length,\r\n      isProcessing,\r\n      nextBatch: queue.length > 0 ? queue[0] : null,\r\n      totalMessages: queue.reduce((sum, batch) => sum + batch.messages.length, 0)\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Cancela un lote espec√≠fico\r\n   * @param {string} companyId - ID de la empresa\r\n   * @param {string} batchId - ID del lote\r\n   * @returns {boolean} True si se cancel√≥ exitosamente\r\n   */\r\n  cancelBatch(companyId, batchId) {\r\n    const queue = this.queues.get(companyId) || [];\r\n    const index = queue.findIndex(batch => batch.id === batchId);\r\n\r\n    if (index !== -1) {\r\n      queue.splice(index, 1);\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Pausa el procesamiento de una cola\r\n   * @param {string} companyId - ID de la empresa\r\n   */\r\n  pauseQueue(companyId) {\r\n    this.processing.set(companyId, false);\r\n  }\r\n\r\n  /**\r\n   * Reanuda el procesamiento de una cola\r\n   * @param {string} companyId - ID de la empresa\r\n   */\r\n  resumeQueue(companyId) {\r\n    if (!this.processing.get(companyId)) {\r\n      this.processQueue(companyId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Utilidad para delays\r\n   * @param {number} ms - Milisegundos\r\n   */\r\n  delay(ms) {\r\n    return new Promise(resolve => setTimeout(resolve, ms));\r\n  }\r\n\r\n  /**\r\n   * Limpia colas antiguas (opcional para mantenimiento)\r\n   */\r\n  cleanup() {\r\n    const cutoffTime = Date.now() - (24 * 60 * 60 * 1000); // 24 horas\r\n\r\n    for (const [companyId, queue] of this.queues.entries()) {\r\n      const filteredQueue = queue.filter(batch =>\r\n        batch.createdAt.getTime() > cutoffTime ||\r\n        batch.status === 'processing'\r\n      );\r\n\r\n      if (filteredQueue.length !== queue.length) {\r\n        this.queues.set(companyId, filteredQueue);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Exportar instancia √∫nica\r\nconst whatsappQueueService = new WhatsAppQueueService();\r\nexport default whatsappQueueService;","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\whatsappService.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'limit' is assigned a value but never used.","line":526,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":526,"endColumn":12}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Servicio de WhatsApp usando API oficial de Meta\r\n *\r\n * Este servicio proporciona una interfaz completa para:\r\n * - Configuraci√≥n de API de Meta WhatsApp\r\n * - Env√≠o de mensajes individuales y masivos\r\n * - Gesti√≥n de plantillas de mensaje\r\n * - Manejo de webhooks para estado de entrega\r\n * - Validaci√≥n de n√∫meros de tel√©fono\r\n * - Estad√≠sticas de uso\r\n *\r\n * NOTA: Este servicio ahora usa configurationService para persistencia\r\n * en lugar de localStorage directamente.\r\n */\r\n\r\nimport configurationService from './configurationService.js'\r\n\r\nclass WhatsAppService {\r\n  constructor() {\r\n    this.accessToken = null\r\n    this.phoneNumberId = null\r\n    this.webhookVerifyToken = null\r\n    this.baseUrl = 'https://graph.facebook.com/v18.0'\r\n    this.isConfigured = false\r\n    this.testMode = false\r\n    this.templates = new Map()\r\n  }\r\n\r\n  /**\r\n   * Configurar las credenciales de WhatsApp Business API\r\n   * @param {Object} config - Configuraci√≥n de WhatsApp\r\n   * @param {string} config.accessToken - Token de acceso de Meta\r\n   * @param {string} config.phoneNumberId - ID del n√∫mero de tel√©fono Business\r\n   * @param {string} config.webhookVerifyToken - Token de verificaci√≥n de webhook\r\n   * @param {boolean} config.testMode - Modo de prueba (opcional)\r\n   */\r\n  async configure(config) {\r\n    this.accessToken = config.accessToken\r\n    this.phoneNumberId = config.phoneNumberId\r\n    this.webhookVerifyToken = config.webhookVerifyToken\r\n    this.testMode = config.testMode || false\r\n    this.isConfigured = !!(config.accessToken && config.phoneNumberId)\r\n\r\n    // Guardar usando configurationService\r\n    if (config.accessToken) {\r\n      await configurationService.setConfig('integrations', 'whatsapp', {\r\n        accessToken: config.accessToken,\r\n        phoneNumberId: config.phoneNumberId,\r\n        webhookVerifyToken: config.webhookVerifyToken || '',\r\n        testMode: this.testMode\r\n      }, 'global', null, 'Configuraci√≥n de WhatsApp Business API')\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cargar configuraci√≥n desde configurationService\r\n   */\r\n  async loadConfiguration() {\r\n    try {\r\n      const config = await configurationService.getConfig('integrations', 'whatsapp', 'global', null, {})\r\n\r\n      if (config.accessToken && config.phoneNumberId) {\r\n        this.accessToken = config.accessToken\r\n        this.phoneNumberId = config.phoneNumberId\r\n        this.webhookVerifyToken = config.webhookVerifyToken || ''\r\n        this.testMode = config.testMode || false\r\n        this.isConfigured = true\r\n      }\r\n\r\n      return {\r\n        accessToken: this.accessToken,\r\n        phoneNumberId: this.phoneNumberId,\r\n        webhookVerifyToken: this.webhookVerifyToken,\r\n        testMode: this.testMode\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading WhatsApp configuration:', error)\r\n      return {\r\n        accessToken: null,\r\n        phoneNumberId: null,\r\n        webhookVerifyToken: null,\r\n        testMode: false\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Limpiar configuraci√≥n\r\n   */\r\n  async clearConfiguration() {\r\n    this.accessToken = null\r\n    this.phoneNumberId = null\r\n    this.webhookVerifyToken = null\r\n    this.testMode = false\r\n    this.isConfigured = false\r\n\r\n    try {\r\n      await configurationService.setConfig('integrations', 'whatsapp', {}, 'global', null, 'Configuraci√≥n de WhatsApp Business API - Limpiada')\r\n    } catch (error) {\r\n      console.error('Error clearing WhatsApp configuration:', error)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener headers para peticiones a la API\r\n   */\r\n  getHeaders() {\r\n    return {\r\n      'Content-Type': 'application/json',\r\n      'Authorization': `Bearer ${this.accessToken}`\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Probar conexi√≥n con la API de Meta WhatsApp\r\n   * @returns {Promise<Object>} Resultado de la prueba\r\n   */\r\n  async testConnection() {\r\n    if (!this.isConfigured) {\r\n      throw new Error('WhatsApp no est√° configurado. Por favor configura tu Access Token y Phone Number ID primero.')\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(`${this.baseUrl}/${this.phoneNumberId}`, {\r\n        method: 'GET',\r\n        headers: this.getHeaders()\r\n      })\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Error ${response.status}: ${response.statusText}`)\r\n      }\r\n\r\n      const phoneInfo = await response.json()\r\n      \r\n      return {\r\n        success: true,\r\n        message: 'Conexi√≥n exitosa con WhatsApp Business API',\r\n        phoneInfo: {\r\n          id: phoneInfo.id,\r\n          name: phoneInfo.display_phone_number,\r\n          verifiedName: phoneInfo.verified_name,\r\n          qualityRating: phoneInfo.quality_rating\r\n        }\r\n      }\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Error de conexi√≥n: ${error.message}`,\r\n        error: error.message\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enviar mensaje de WhatsApp\r\n   * @param {Object} params - Par√°metros del env√≠o\r\n   * @returns {Promise<Object>} Resultado del env√≠o\r\n   */\r\n  async sendMessage(params) {\r\n    if (!this.isConfigured) {\r\n      throw new Error('WhatsApp no est√° configurado')\r\n    }\r\n\r\n    const {\r\n      to, // N√∫mero de tel√©fono destinatario\r\n      message, // Contenido del mensaje\r\n      templateName = null, // Nombre de plantilla (opcional)\r\n      templateLanguage = 'es', // Idioma de plantilla\r\n      components = [], // Componentes de plantilla\r\n      messageType = 'text' // 'text', 'template', 'media'\r\n    } = params\r\n\r\n    // Validar destinatario\r\n    if (!to) {\r\n      throw new Error('El n√∫mero de tel√©fono del destinatario es obligatorio')\r\n    }\r\n\r\n    // Formatear n√∫mero de tel√©fono\r\n    const formattedPhone = this.formatPhoneNumber(to)\r\n\r\n    let payload = {\r\n      messaging_product: 'whatsapp',\r\n      to: formattedPhone\r\n    }\r\n\r\n    // Construir payload seg√∫n tipo de mensaje\r\n    if (messageType === 'template' && templateName) {\r\n      payload.type = 'template'\r\n      payload.template = {\r\n        name: templateName,\r\n        language: { code: templateLanguage },\r\n        components: components\r\n      }\r\n    } else {\r\n      payload.type = 'text'\r\n      payload.text = {\r\n        body: message\r\n      }\r\n    }\r\n\r\n    if (this.testMode) {\r\n      // En modo prueba, simular env√≠o\r\n      return {\r\n        success: true,\r\n        messageId: `test_${Date.now()}`,\r\n        recipientPhone: formattedPhone,\r\n        testMode: true,\r\n        message: 'Mensaje de WhatsApp enviado (modo prueba)'\r\n      }\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(`${this.baseUrl}/${this.phoneNumberId}/messages`, {\r\n        method: 'POST',\r\n        headers: this.getHeaders(),\r\n        body: JSON.stringify(payload)\r\n      })\r\n\r\n      if (!response.ok) {\r\n        const errorData = await response.json()\r\n        throw new Error(`Error ${response.status}: ${errorData.error?.message || response.statusText}`)\r\n      }\r\n\r\n      const result = await response.json()\r\n      \r\n      return {\r\n        success: true,\r\n        messageId: result.messages[0].id,\r\n        recipientPhone: formattedPhone,\r\n        status: result.messages[0].message_status,\r\n        timestamp: new Date().toISOString(),\r\n        result: result\r\n      }\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Error al enviar mensaje: ${error.message}`,\r\n        error: error.message,\r\n        recipientPhone: formattedPhone\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enviar mensaje masivo\r\n   * @param {Object} params - Par√°metros del env√≠o masivo\r\n   * @returns {Promise<Object>} Resultado del env√≠o\r\n   */\r\n  async sendBulkMessage(params) {\r\n    if (!this.isConfigured) {\r\n      throw new Error('WhatsApp no est√° configurado')\r\n    }\r\n\r\n    const {\r\n      recipients, // Array de n√∫meros de tel√©fono\r\n      message,\r\n      templateName = null,\r\n      templateLanguage = 'es',\r\n      components = [],\r\n      messageType = 'text',\r\n      delayBetweenMessages = 1000 // Delay en ms entre mensajes\r\n    } = params\r\n\r\n    // Validar destinatarios\r\n    if (!recipients || recipients.length === 0) {\r\n      throw new Error('No hay destinatarios especificados')\r\n    }\r\n\r\n    const results = []\r\n    \r\n    for (let i = 0; i < recipients.length; i++) {\r\n      const recipient = recipients[i]\r\n      \r\n      try {\r\n        const result = await this.sendMessage({\r\n          to: recipient,\r\n          message,\r\n          templateName,\r\n          templateLanguage,\r\n          components,\r\n          messageType\r\n        })\r\n        \r\n        results.push({\r\n          recipient,\r\n          success: result.success,\r\n          messageId: result.messageId,\r\n          error: result.error\r\n        })\r\n        \r\n        // Delay entre mensajes para evitar l√≠mites de rate limiting\r\n        if (delayBetweenMessages > 0 && i < recipients.length - 1) {\r\n          await new Promise(resolve => setTimeout(resolve, delayBetweenMessages))\r\n        }\r\n      } catch (error) {\r\n        results.push({\r\n          recipient,\r\n          success: false,\r\n          error: error.message\r\n        })\r\n      }\r\n    }\r\n\r\n    const successful = results.filter(r => r.success).length\r\n    const failed = results.filter(r => !r.success).length\r\n\r\n    return {\r\n      success: successful > 0,\r\n      totalRecipients: recipients.length,\r\n      successful,\r\n      failed,\r\n      successRate: (successful / recipients.length) * 100,\r\n      results: results\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Crear plantilla de mensaje\r\n   * @param {Object} template - Configuraci√≥n de plantilla\r\n   * @returns {Promise<Object>} Resultado de la creaci√≥n\r\n   */\r\n  async createTemplate(template) {\r\n    if (!this.isConfigured) {\r\n      throw new Error('WhatsApp no est√° configurado')\r\n    }\r\n\r\n    const {\r\n      name,\r\n      category,\r\n      language = 'es',\r\n      components\r\n    } = template\r\n\r\n    const payload = {\r\n      name,\r\n      category,\r\n      language,\r\n      components\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(`${this.baseUrl}/${this.phoneNumberId}/message_templates`, {\r\n        method: 'POST',\r\n        headers: this.getHeaders(),\r\n        body: JSON.stringify(payload)\r\n      })\r\n\r\n      if (!response.ok) {\r\n        const errorData = await response.json()\r\n        throw new Error(`Error ${response.status}: ${errorData.error?.message || response.statusText}`)\r\n      }\r\n\r\n      const result = await response.json()\r\n      \r\n      // Guardar plantilla en cach√©\r\n      this.templates.set(name, result)\r\n      \r\n      return {\r\n        success: true,\r\n        template: result,\r\n        message: 'Plantilla creada exitosamente'\r\n      }\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Error al crear plantilla: ${error.message}`,\r\n        error: error.message\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener plantillas de mensaje\r\n   * @returns {Promise<Object>} Lista de plantillas\r\n   */\r\n  async getTemplates() {\r\n    if (!this.isConfigured) {\r\n      throw new Error('WhatsApp no est√° configurado')\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(`${this.baseUrl}/${this.phoneNumberId}/message_templates`, {\r\n        method: 'GET',\r\n        headers: this.getHeaders()\r\n      })\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Error ${response.status}: ${response.statusText}`)\r\n      }\r\n\r\n      const data = await response.json()\r\n      \r\n      return {\r\n        success: true,\r\n        templates: data.data || [],\r\n        total: data.data?.length || 0\r\n      }\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Error al obtener plantillas: ${error.message}`,\r\n        error: error.message\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verificar webhook de WhatsApp\r\n   * @param {Object} params - Par√°metros de verificaci√≥n\r\n   * @returns {string} Token de verificaci√≥n\r\n   */\r\n  verifyWebhook(params) {\r\n    const { mode, token, challenge } = params\r\n    \r\n    if (mode === 'subscribe' && token === this.webhookVerifyToken) {\r\n      return challenge\r\n    }\r\n    \r\n    throw new Error('Verificaci√≥n de webhook fallida')\r\n  }\r\n\r\n  /**\r\n   * Procesar webhook entrante\r\n   * @param {Object} payload - Datos del webhook\r\n   * @returns {Object} Datos procesados\r\n   */\r\n  processWebhook(payload) {\r\n    try {\r\n      const messages = []\r\n      \r\n      if (payload.entry) {\r\n        for (const entry of payload.entry) {\r\n          if (entry.changes) {\r\n            for (const change of entry.changes) {\r\n              if (change.value?.messages) {\r\n                for (const message of change.value.messages) {\r\n                  messages.push({\r\n                    messageId: message.id,\r\n                    from: message.from,\r\n                    timestamp: message.timestamp,\r\n                    type: message.type,\r\n                    text: message.text?.body,\r\n                    status: message.status,\r\n                    direction: 'inbound'\r\n                  })\r\n                }\r\n              }\r\n              \r\n              if (change.value?.statuses) {\r\n                for (const status of change.value.statuses) {\r\n                  messages.push({\r\n                    messageId: status.id,\r\n                    recipient: status.recipient_id,\r\n                    timestamp: status.timestamp,\r\n                    status: status.status,\r\n                    errors: status.errors,\r\n                    direction: 'status_update'\r\n                  })\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n      \r\n      return {\r\n        success: true,\r\n        messages: messages\r\n      }\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Error procesando webhook: ${error.message}`,\r\n        error: error.message\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Formatear n√∫mero de tel√©fono para WhatsApp\r\n   * @param {string} phone - N√∫mero de tel√©fono\r\n   * @returns {string} N√∫mero formateado\r\n   */\r\n  formatPhoneNumber(phone) {\r\n    // Eliminar caracteres no num√©ricos excepto +\r\n    let formatted = phone.replace(/[^\\d+]/g, '')\r\n    \r\n    // Asegurar que comience con +\r\n    if (!formatted.startsWith('+')) {\r\n      // Si no tiene c√≥digo de pa√≠s, asumir Chile (+56)\r\n      if (formatted.startsWith('9') && formatted.length === 9) {\r\n        formatted = '+56' + formatted\r\n      } else {\r\n        formatted = '+' + formatted\r\n      }\r\n    }\r\n    \r\n    return formatted\r\n  }\r\n\r\n  /**\r\n   * Validar formato de n√∫mero de tel√©fono\r\n   * @param {string} phone - N√∫mero de tel√©fono\r\n   * @returns {boolean} V√°lido o no\r\n   */\r\n  validatePhoneNumber(phone) {\r\n    const formatted = this.formatPhoneNumber(phone)\r\n    // Expresi√≥n regular para n√∫meros internacionales\r\n    const phoneRegex = /^\\+[1-9]\\d{1,14}$/\r\n    return phoneRegex.test(formatted)\r\n  }\r\n\r\n  /**\r\n   * Obtener estad√≠sticas de uso\r\n   * @param {Object} params - Par√°metros de consulta\r\n   * @returns {Promise<Object>} Estad√≠sticas\r\n   */\r\n  async getStatistics(params = {}) {\r\n    if (!this.isConfigured) {\r\n      throw new Error('WhatsApp no est√° configurado')\r\n    }\r\n\r\n    const { \r\n      startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), // √öltimos 30 d√≠as\r\n      endDate = new Date(),\r\n      limit = 100\r\n    } = params\r\n\r\n    try {\r\n      // En una implementaci√≥n real, esto consultar√≠a la base de datos\r\n      // o usar√≠a las analytics de Meta API\r\n      \r\n      return {\r\n        success: true,\r\n        statistics: {\r\n          totalSent: 0,\r\n          totalDelivered: 0,\r\n          totalRead: 0,\r\n          deliveryRate: 0,\r\n          readRate: 0,\r\n          cost: 0,\r\n          period: { startDate, endDate }\r\n        }\r\n      }\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Error al obtener estad√≠sticas: ${error.message}`,\r\n        error: error.message\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtener informaci√≥n de la cuenta de WhatsApp Business\r\n   * @returns {Promise<Object>} Informaci√≥n de la cuenta\r\n   */\r\n  async getAccountInfo() {\r\n    if (!this.isConfigured) {\r\n      throw new Error('WhatsApp no est√° configurado')\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(`${this.baseUrl}/me`, {\r\n        method: 'GET',\r\n        headers: this.getHeaders()\r\n      })\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Error ${response.status}: ${response.statusText}`)\r\n      }\r\n\r\n      const account = await response.json()\r\n      \r\n      return {\r\n        success: true,\r\n        account: {\r\n          id: account.id,\r\n          name: account.name,\r\n          tasks: account.tasks\r\n        }\r\n      }\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Error al obtener informaci√≥n de la cuenta: ${error.message}`,\r\n        error: error.message\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enviar mensaje de prueba\r\n   * @param {string} phoneNumber - N√∫mero de tel√©fono\r\n   * @param {string} message - Mensaje de prueba\r\n   * @returns {Promise<Object>} Resultado del env√≠o\r\n   */\r\n  async sendTestMessage(phoneNumber, message = 'Este es un mensaje de prueba desde StaffHub') {\r\n    if (!this.isConfigured) {\r\n      throw new Error('WhatsApp no est√° configurado')\r\n    }\r\n\r\n    try {\r\n      const result = await this.sendMessage({\r\n        to: phoneNumber,\r\n        message: message,\r\n        messageType: 'text'\r\n      })\r\n\r\n      if (result.success) {\r\n        return {\r\n          success: true,\r\n          messageId: result.messageId,\r\n          testMode: result.testMode,\r\n          message: 'Mensaje de prueba enviado exitosamente'\r\n        }\r\n      } else {\r\n        throw new Error(result.error || 'Error al enviar mensaje de prueba')\r\n      }\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Error al enviar mensaje de prueba: ${error.message}`,\r\n        error: error.message\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Crear instancia global del servicio\r\nconst whatsappService = new WhatsAppService()\r\n\r\n// Cargar configuraci√≥n guardada al iniciar (as√≠ncronamente)\r\nwhatsappService.loadConfiguration().catch(error => {\r\n  console.error('Error loading WhatsApp configuration on startup:', error)\r\n})\r\n\r\nexport default whatsappService","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\services\\whatsappWahaService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\utils\\applicationHealthMonitor.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":169,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":169,"endColumn":19},{"ruleId":"default-case","severity":1,"message":"Expected a default case.","line":286,"column":5,"nodeType":"SwitchStatement","messageId":"missingDefaultCase","endLine":309,"endColumn":6}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Sistema de Monitoreo de Salud de la Aplicaci√≥n\r\n * Monitorea procesos, memoria y servicios cr√≠ticos autom√°ticamente\r\n */\r\n\r\nclass ApplicationHealthMonitor {\r\n  constructor() {\r\n    this.isMonitoring = false;\r\n    this.checkInterval = null;\r\n    this.memoryThreshold = 100 * 1024 * 1024; // 100MB\r\n    this.processThreshold = 3; // M√°ximo 3 procesos Node.js\r\n    this.alertCallbacks = [];\r\n    this.stats = {\r\n      checksPerformed: 0,\r\n      issuesDetected: 0,\r\n      lastCheck: null,\r\n      memoryUsage: [],\r\n      processCount: []\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Iniciar monitoreo autom√°tico\r\n   */\r\n  startMonitoring(intervalMs = 30000) { // Cada 30 segundos\r\n    if (this.isMonitoring) {\r\n      console.log('‚ö†Ô∏è Monitoreo ya est√° activo');\r\n      return;\r\n    }\r\n\r\n    this.isMonitoring = true;\r\n    this.checkInterval = setInterval(() => {\r\n      this.performHealthCheck();\r\n    }, intervalMs);\r\n\r\n    console.log('‚úÖ Sistema de monitoreo iniciado');\r\n    this.performHealthCheck(); // Primera verificaci√≥n inmediata\r\n  }\r\n\r\n  /**\r\n   * Detener monitoreo\r\n   */\r\n  stopMonitoring() {\r\n    if (this.checkInterval) {\r\n      clearInterval(this.checkInterval);\r\n      this.checkInterval = null;\r\n    }\r\n    this.isMonitoring = false;\r\n    console.log('‚èπÔ∏è Sistema de monitoreo detenido');\r\n  }\r\n\r\n  /**\r\n   * Realizar verificaci√≥n de salud\r\n   */\r\n  async performHealthCheck() {\r\n    try {\r\n      this.stats.checksPerformed++;\r\n      this.stats.lastCheck = new Date().toISOString();\r\n\r\n      const results = {\r\n        timestamp: new Date().toISOString(),\r\n        memory: await this.checkMemoryUsage(),\r\n        processes: await this.checkNodeProcesses(),\r\n        server: await this.checkServerHealth(),\r\n        services: await this.checkCriticalServices()\r\n      };\r\n\r\n      // Detectar problemas\r\n      const issues = this.detectIssues(results);\r\n      \r\n      if (issues.length > 0) {\r\n        this.stats.issuesDetected++;\r\n        this.handleIssues(issues);\r\n      }\r\n\r\n      // Guardar estad√≠sticas\r\n      this.updateStats(results);\r\n\r\n      console.log(`üîç Health check completado - ${issues.length} problemas detectados`);\r\n\r\n      return results;\r\n    } catch (error) {\r\n      console.error('‚ùå Error en health check:', error);\r\n      this.alertCallbacks.forEach(callback => callback('ERROR', error.message));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verificar uso de memoria\r\n   */\r\n  async checkMemoryUsage() {\r\n    const memUsage = process.memoryUsage();\r\n    const totalMB = Math.round(memUsage.rss / 1024 / 1024);\r\n    \r\n    return {\r\n      rss: memUsage.rss,\r\n      heapTotal: memUsage.heapTotal,\r\n      heapUsed: memUsage.heapUsed,\r\n      external: memUsage.external,\r\n      totalMB,\r\n      isHigh: totalMB > 100\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Verificar procesos Node.js\r\n   */\r\n  async checkNodeProcesses() {\r\n    try {\r\n      // En un entorno real, usar√≠as child_process para ejecutar tasklist\r\n      // Por ahora, simulamos la verificaci√≥n\r\n      return {\r\n        count: 1, // Solo este proceso principal\r\n        isHigh: false,\r\n        threshold: this.processThreshold\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        count: -1,\r\n        isHigh: false,\r\n        error: error.message\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verificar salud del servidor\r\n   */\r\n  async checkServerHealth() {\r\n    try {\r\n      const response = await fetch('http://localhost:3000', {\r\n        method: 'HEAD',\r\n        timeout: 5000\r\n      });\r\n      \r\n      return {\r\n        status: response.status,\r\n        isHealthy: response.status === 200,\r\n        responseTime: Date.now()\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        status: 0,\r\n        isHealthy: false,\r\n        error: error.message\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verificar servicios cr√≠ticos\r\n   */\r\n  async checkCriticalServices() {\r\n    const services = {\r\n      supabase: await this.checkSupabaseConnection(),\r\n      googleDrive: await this.checkGoogleDriveService()\r\n    };\r\n\r\n    return services;\r\n  }\r\n\r\n  /**\r\n   * Verificar conexi√≥n Supabase\r\n   */\r\n  async checkSupabaseConnection() {\r\n    try {\r\n      // Verificar si supabase client est√° disponible\r\n      const { supabase } = await import('./supabaseClient.js');\r\n      const { data, error } = await supabase.from('companies').select('count').limit(1);\r\n      \r\n      return {\r\n        isConnected: !error,\r\n        error: error?.message\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        isConnected: false,\r\n        error: error.message\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verificar servicio Google Drive\r\n   */\r\n  async checkGoogleDriveService() {\r\n    try {\r\n      const unifiedService = await import('./unifiedGoogleDriveService.js');\r\n      const service = unifiedService.default;\r\n      \r\n      return {\r\n        isAvailable: !!service,\r\n        isInitialized: service.isInitialized || false\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        isAvailable: false,\r\n        error: error.message\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Detectar problemas en los resultados\r\n   */\r\n  detectIssues(results) {\r\n    const issues = [];\r\n\r\n    // Problemas de memoria\r\n    if (results.memory.isHigh) {\r\n      issues.push({\r\n        type: 'MEMORY_HIGH',\r\n        severity: 'WARNING',\r\n        message: `Alto uso de memoria: ${results.memory.totalMB}MB`,\r\n        data: results.memory\r\n      });\r\n    }\r\n\r\n    // Problemas de procesos\r\n    if (results.processes.isHigh) {\r\n      issues.push({\r\n        type: 'PROCESS_HIGH',\r\n        severity: 'CRITICAL',\r\n        message: `Demasiados procesos Node.js: ${results.processes.count}`,\r\n        data: results.processes\r\n      });\r\n    }\r\n\r\n    // Problemas del servidor\r\n    if (!results.server.isHealthy) {\r\n      issues.push({\r\n        type: 'SERVER_DOWN',\r\n        severity: 'CRITICAL',\r\n        message: `Servidor no responde (HTTP ${results.server.status})`,\r\n        data: results.server\r\n      });\r\n    }\r\n\r\n    // Problemas de servicios\r\n    if (!results.services.supabase.isConnected) {\r\n      issues.push({\r\n        type: 'SUPABASE_DOWN',\r\n        severity: 'CRITICAL',\r\n        message: 'Supabase no disponible',\r\n        data: results.services.supabase\r\n      });\r\n    }\r\n\r\n    if (!results.services.googleDrive.isAvailable) {\r\n      issues.push({\r\n        type: 'GOOGLE_DRIVE_DOWN',\r\n        severity: 'WARNING',\r\n        message: 'Google Drive service no disponible',\r\n        data: results.services.googleDrive\r\n      });\r\n    }\r\n\r\n    return issues;\r\n  }\r\n\r\n  /**\r\n   * Manejar problemas detectados\r\n   */\r\n  handleIssues(issues) {\r\n    issues.forEach(issue => {\r\n      console.warn(`üö® ${issue.severity}: ${issue.message}`);\r\n      \r\n      // Notificar a callbacks registrados\r\n      this.alertCallbacks.forEach(callback => {\r\n        try {\r\n          callback(issue.type, issue.message, issue);\r\n        } catch (error) {\r\n          console.error('Error en alert callback:', error);\r\n        }\r\n      });\r\n\r\n      // Acciones autom√°ticas seg√∫n el tipo de problema\r\n      this.takeAutomaticAction(issue);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Tomar acciones autom√°ticas seg√∫n el problema\r\n   */\r\n  takeAutomaticAction(issue) {\r\n    switch (issue.type) {\r\n      case 'MEMORY_HIGH':\r\n        // Forzar garbage collection si est√° disponible\r\n        if (global.gc) {\r\n          global.gc();\r\n          console.log('üßπ Garbage collection ejecutado');\r\n        }\r\n        break;\r\n        \r\n      case 'PROCESS_HIGH':\r\n        // Log para revisi√≥n manual\r\n        console.log('üìä Procesos m√∫ltiples detectados - revisar manualmente');\r\n        break;\r\n        \r\n      case 'SERVER_DOWN':\r\n        // Intentar reinicio del servidor (solo en desarrollo)\r\n        if (process.env.NODE_ENV === 'development') {\r\n          console.log('üîÑ Intentando reinicio del servidor...');\r\n          setTimeout(() => {\r\n            process.exit(1); // Forzar reinicio\r\n          }, 5000);\r\n        }\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Actualizar estad√≠sticas\r\n   */\r\n  updateStats(results) {\r\n    this.stats.memoryUsage.push({\r\n      timestamp: Date.now(),\r\n      value: results.memory.totalMB\r\n    });\r\n\r\n    this.stats.processCount.push({\r\n      timestamp: Date.now(),\r\n      value: results.processes.count\r\n    });\r\n\r\n    // Mantener solo los √∫ltimos 100 registros\r\n    if (this.stats.memoryUsage.length > 100) {\r\n      this.stats.memoryUsage.shift();\r\n    }\r\n    if (this.stats.processCount.length > 100) {\r\n      this.stats.processCount.shift();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Registrar callback para alertas\r\n   */\r\n  onAlert(callback) {\r\n    this.alertCallbacks.push(callback);\r\n  }\r\n\r\n  /**\r\n   * Obtener estad√≠sticas actuales\r\n   */\r\n  getStats() {\r\n    return {\r\n      ...this.stats,\r\n      isMonitoring: this.isMonitoring,\r\n      currentMemory: this.stats.memoryUsage[this.stats.memoryUsage.length - 1],\r\n      currentProcesses: this.stats.processCount[this.stats.processCount.length - 1]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Generar reporte de salud\r\n   */\r\n  generateHealthReport() {\r\n    const stats = this.getStats();\r\n    const avgMemory = stats.memoryUsage.length > 0 \r\n      ? stats.memoryUsage.reduce((sum, item) => sum + item.value, 0) / stats.memoryUsage.length\r\n      : 0;\r\n\r\n    return {\r\n      summary: {\r\n        status: stats.issuesDetected === 0 ? 'HEALTHY' : 'ISSUES_DETECTED',\r\n        checksPerformed: stats.checksPerformed,\r\n        issuesDetected: stats.issuesDetected,\r\n        isMonitoring: stats.isMonitoring,\r\n        lastCheck: stats.lastCheck\r\n      },\r\n      metrics: {\r\n        averageMemoryMB: Math.round(avgMemory),\r\n        currentMemoryMB: stats.currentMemory?.value || 0,\r\n        currentProcesses: stats.currentProcesses?.value || 0,\r\n        memoryThreshold: this.memoryThreshold / 1024 / 1024,\r\n        processThreshold: this.processThreshold\r\n      },\r\n      recommendations: this.generateRecommendations(stats)\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Generar recomendaciones\r\n   */\r\n  generateRecommendations(stats) {\r\n    const recommendations = [];\r\n\r\n    if (stats.issuesDetected > 5) {\r\n      recommendations.push('Considera reiniciar la aplicaci√≥n - muchos problemas detectados');\r\n    }\r\n\r\n    const avgMemory = stats.memoryUsage.length > 0 \r\n      ? stats.memoryUsage.reduce((sum, item) => sum + item.value, 0) / stats.memoryUsage.length\r\n      : 0;\r\n\r\n    if (avgMemory > 80) {\r\n      recommendations.push('Alto uso promedio de memoria - revisar memory leaks');\r\n    }\r\n\r\n    if (stats.currentProcesses?.value > 2) {\r\n      recommendations.push('M√∫ltiples procesos detectados - verificar procesos zombie');\r\n    }\r\n\r\n    return recommendations;\r\n  }\r\n}\r\n\r\n// Instancia singleton\r\nconst healthMonitor = new ApplicationHealthMonitor();\r\n\r\nexport default healthMonitor;\r\nexport { ApplicationHealthMonitor };","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\utils\\auditUtils.js","messages":[{"ruleId":"import/no-anonymous-default-export","severity":1,"message":"Assign object to a variable before exporting as module default","line":570,"column":1,"nodeType":"ExportDefaultDeclaration","endLine":604,"endColumn":2}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Audit Utilities\r\n * Utilidades simplificadas para Auditor√≠a y Logging\r\n * \r\n * ‚úÖ NO MODIFICA c√≥digo existente\r\n * ‚úÖ Completamente independiente\r\n * ‚úÖ Puede ser desactivado sin afectar el sistema\r\n */\r\n\r\nimport auditService from '../lib/auditService.js'\r\n\r\n/**\r\n * Registrar evento de auditor√≠a simple\r\n * @param {string} userId - ID del usuario\r\n * @param {string} action - Acci√≥n realizada\r\n * @param {Object} details - Detalles adicionales\r\n * @returns {string} ID del log creado\r\n */\r\nexport const logEvent = (userId, action, details = {}) => {\r\n  return auditService.log(userId, action, details, 'INFO')\r\n}\r\n\r\n/**\r\n * Registrar evento de seguridad\r\n * @param {string} userId - ID del usuario\r\n * @param {string} event - Evento de seguridad\r\n * @param {Object} details - Detalles del evento\r\n * @param {string} severity - Severidad (LOW, MEDIUM, HIGH, CRITICAL)\r\n * @returns {string} ID del log creado\r\n */\r\nexport const logSecurity = (userId, event, details = {}, severity = 'MEDIUM') => {\r\n  return auditService.logSecurityEvent(userId, event, details, severity)\r\n}\r\n\r\n/**\r\n * Registrar evento de autenticaci√≥n\r\n * @param {string} userId - ID del usuario\r\n * @param {string} event - Evento de autenticaci√≥n\r\n * @param {Object} details - Detalles del evento\r\n * @param {boolean} success - Si fue exitoso\r\n * @returns {string} ID del log creado\r\n */\r\nexport const logAuth = (userId, event, details = {}, success = true) => {\r\n  return auditService.logAuthEvent(userId, event, details, success)\r\n}\r\n\r\n/**\r\n * Registrar acceso a datos\r\n * @param {string} userId - ID del usuario\r\n * @param {string} resource - Recurso accedido\r\n * @param {string} action - Acci√≥n realizada\r\n * @param {Object} details - Detalles del acceso\r\n * @returns {string} ID del log creado\r\n */\r\nexport const logDataAccess = (userId, resource, action, details = {}) => {\r\n  return auditService.logDataAccess(userId, resource, action, details)\r\n}\r\n\r\n/**\r\n * Registrar error\r\n * @param {string} userId - ID del usuario\r\n * @param {Error|string} error - Error ocurrido\r\n * @param {Object} context - Contexto del error\r\n * @returns {string} ID del log creado\r\n */\r\nexport const logError = (userId, error, context = {}) => {\r\n  const errorObj = typeof error === 'string' ? new Error(error) : error\r\n  return auditService.logError(userId, errorObj, context)\r\n}\r\n\r\n/**\r\n * Registrar m√©trica de rendimiento\r\n * @param {string} operation - Operaci√≥n medida\r\n * @param {number} duration - Duraci√≥n en ms\r\n * @param {Object} metrics - M√©tricas adicionales\r\n * @returns {string} ID del log creado\r\n */\r\nexport const logPerformance = (operation, duration, metrics = {}) => {\r\n  return auditService.logPerformance(operation, duration, metrics)\r\n}\r\n\r\n/**\r\n * Registrar advertencia\r\n * @param {string} userId - ID del usuario\r\n * @param {string} action - Acci√≥n que gener√≥ advertencia\r\n * @param {Object} details - Detalles de la advertencia\r\n * @returns {string} ID del log creado\r\n */\r\nexport const logWarning = (userId, action, details = {}) => {\r\n  return auditService.log(userId, action, details, 'WARN')\r\n}\r\n\r\n/**\r\n * Registrar evento cr√≠tico\r\n * @param {string} userId - ID del usuario\r\n * @param {string} action - Acci√≥n cr√≠tica\r\n * @param {Object} details - Detalles del evento\r\n * @returns {string} ID del log creado\r\n */\r\nexport const logCritical = (userId, action, details = {}) => {\r\n  return auditService.log(userId, action, details, 'CRITICAL')\r\n}\r\n\r\n/**\r\n * Registrar evento de depuraci√≥n\r\n * @param {string} userId - ID del usuario\r\n * @param {string} action - Acci√≥n de depuraci√≥n\r\n * @param {Object} details - Detalles del evento\r\n * @returns {string} ID del log creado\r\n */\r\nexport const logDebug = (userId, action, details = {}) => {\r\n  return auditService.log(userId, action, details, 'DEBUG')\r\n}\r\n\r\n/**\r\n * Buscar logs con filtros simples\r\n * @param {Object} filters - Filtros de b√∫squeda\r\n * @returns {Array} Logs filtrados\r\n */\r\nexport const searchLogs = (filters = {}) => {\r\n  return auditService.searchLogs(filters)\r\n}\r\n\r\n/**\r\n * Obtener logs de usuario espec√≠fico\r\n * @param {string} userId - ID del usuario\r\n * @param {Object} options - Opciones adicionales\r\n * @returns {Array} Logs del usuario\r\n */\r\nexport const getUserLogs = (userId, options = {}) => {\r\n  return auditService.searchLogs({ userId, ...options })\r\n}\r\n\r\n/**\r\n * Obtener logs de seguridad\r\n * @param {Object} filters - Filtros adicionales\r\n * @returns {Array} Logs de seguridad\r\n */\r\nexport const getSecurityLogs = (filters = {}) => {\r\n  return auditService.searchLogs({ category: 'security', ...filters })\r\n}\r\n\r\n/**\r\n * Obtener logs de errores\r\n * @param {Object} filters - Filtros adicionales\r\n * @returns {Array} Logs de errores\r\n */\r\nexport const getErrorLogs = (filters = {}) => {\r\n  return auditService.searchLogs({ level: 'ERROR', ...filters })\r\n}\r\n\r\n/**\r\n * Obtener logs de autenticaci√≥n\r\n * @param {Object} filters - Filtros adicionales\r\n * @returns {Array} Logs de autenticaci√≥n\r\n */\r\nexport const getAuthLogs = (filters = {}) => {\r\n  return auditService.searchLogs({ category: 'authentication', ...filters })\r\n}\r\n\r\n/**\r\n * Obtener logs por rango de fechas\r\n * @param {Date|string} startDate - Fecha de inicio\r\n * @param {Date|string} endDate - Fecha de fin\r\n * @param {Object} filters - Filtros adicionales\r\n * @returns {Array} Logs en rango de fechas\r\n */\r\nexport const getLogsByDateRange = (startDate, endDate, filters = {}) => {\r\n  return auditService.searchLogs({ startDate, endDate, ...filters })\r\n}\r\n\r\n/**\r\n * Obtener logs recientes\r\n * @param {number} hours - Horas hacia atr√°s\r\n * @param {Object} filters - Filtros adicionales\r\n * @returns {Array} Logs recientes\r\n */\r\nexport const getRecentLogs = (hours = 24, filters = {}) => {\r\n  const startDate = new Date()\r\n  startDate.setHours(startDate.getHours() - hours)\r\n  \r\n  return auditService.searchLogs({ startDate, ...filters })\r\n}\r\n\r\n/**\r\n * Obtener estad√≠sticas de logs\r\n * @param {Object} filters - Filtros para estad√≠sticas\r\n * @returns {Object} Estad√≠sticas\r\n */\r\nexport const getLogStats = (filters = {}) => {\r\n  return auditService.getLogStats(filters)\r\n}\r\n\r\n/**\r\n * Obtener resumen de actividad\r\n * @param {number} hours - Horas a analizar\r\n * @returns {Object} Resumen de actividad\r\n */\r\nexport const getActivitySummary = (hours = 24) => {\r\n  return auditService.getActivitySummary(hours)\r\n}\r\n\r\n/**\r\n * Exportar logs a JSON\r\n * @param {Object} filters - Filtros de exportaci√≥n\r\n * @returns {string} JSON con logs\r\n */\r\nexport const exportLogsJSON = (filters = {}) => {\r\n  return auditService.exportLogs(filters, 'json')\r\n}\r\n\r\n/**\r\n * Exportar logs a CSV\r\n * @param {Object} filters - Filtros de exportaci√≥n\r\n * @returns {string} CSV con logs\r\n */\r\nexport const exportLogsCSV = (filters = {}) => {\r\n  return auditService.exportLogs(filters, 'csv')\r\n}\r\n\r\n/**\r\n * Limpiar logs antiguos\r\n * @param {number} days - D√≠as de retenci√≥n\r\n * @returns {number} Cantidad de logs eliminados\r\n */\r\nexport const cleanupOldLogs = (days = 30) => {\r\n  return auditService.cleanupOldLogs(days)\r\n}\r\n\r\n/**\r\n * Middleware para logging de Express\r\n * @param {Object} req - Request de Express\r\n * @param {Object} res - Response de Express\r\n * @param {Function} next - Next function\r\n */\r\nexport const auditMiddleware = (req, res, next) => {\r\n  const startTime = Date.now()\r\n  \r\n  // Capturar respuesta\r\n  const originalSend = res.send\r\n  res.send = function(data) {\r\n    const duration = Date.now() - startTime\r\n    const userId = req.user?.id || 'anonymous'\r\n    \r\n    // Log de la solicitud\r\n    logEvent(userId, 'HTTP_REQUEST', {\r\n      method: req.method,\r\n      url: req.url,\r\n      statusCode: res.statusCode,\r\n      duration,\r\n      userAgent: req.get('User-Agent'),\r\n      ipAddress: req.ip\r\n    })\r\n    \r\n    return originalSend.call(this, data)\r\n  }\r\n  \r\n  next()\r\n}\r\n\r\n/**\r\n * Middleware para logging de errores\r\n * @param {Error} error - Error ocurrido\r\n * @param {Object} req - Request de Express\r\n * @param {Object} res - Response de Express\r\n * @param {Function} next - Next function\r\n */\r\nexport const errorAuditMiddleware = (error, req, res, next) => {\r\n  const userId = req.user?.id || 'anonymous'\r\n  \r\n  logError(userId, error, {\r\n    method: req.method,\r\n    url: req.url,\r\n    userAgent: req.get('User-Agent'),\r\n    ipAddress: req.ip\r\n  })\r\n  \r\n  next(error)\r\n}\r\n\r\n/**\r\n * Decorador para logging de m√©todos\r\n * @param {string} action - Acci√≥n a loguear\r\n * @param {Object} options - Opciones adicionales\r\n * @returns {Function} Decorador\r\n */\r\nexport const logMethod = (action, options = {}) => {\r\n  return (target, propertyName, descriptor) => {\r\n    const method = descriptor.value\r\n    \r\n    descriptor.value = function(...args) {\r\n      const userId = this.user?.id || 'anonymous'\r\n      const startTime = Date.now()\r\n      \r\n      try {\r\n        const result = method.apply(this, args)\r\n        \r\n        // Log de √©xito\r\n        if (result instanceof Promise) {\r\n          return result\r\n            .then(res => {\r\n              const duration = Date.now() - startTime\r\n              logEvent(userId, action, {\r\n                method: propertyName,\r\n                duration,\r\n                success: true,\r\n                ...options\r\n              })\r\n              return res\r\n            })\r\n            .catch(error => {\r\n              const duration = Date.now() - startTime\r\n              logError(userId, error, {\r\n                method: propertyName,\r\n                duration,\r\n                ...options\r\n              })\r\n              throw error\r\n            })\r\n        } else {\r\n          const duration = Date.now() - startTime\r\n          logEvent(userId, action, {\r\n            method: propertyName,\r\n            duration,\r\n            success: true,\r\n            ...options\r\n          })\r\n          return result\r\n        }\r\n      } catch (error) {\r\n        const duration = Date.now() - startTime\r\n        logError(userId, error, {\r\n          method: propertyName,\r\n          duration,\r\n          ...options\r\n        })\r\n        throw error\r\n      }\r\n    }\r\n    \r\n    return descriptor\r\n  }\r\n}\r\n\r\n/**\r\n * Decorador para medici√≥n de rendimiento\r\n * @param {string} operation - Nombre de la operaci√≥n\r\n * @returns {Function} Decorador\r\n */\r\nexport const measurePerformance = (operation) => {\r\n  return (target, propertyName, descriptor) => {\r\n    const method = descriptor.value\r\n    \r\n    descriptor.value = function(...args) {\r\n      const startTime = Date.now()\r\n      \r\n      try {\r\n        const result = method.apply(this, args)\r\n        \r\n        if (result instanceof Promise) {\r\n          return result\r\n            .then(res => {\r\n              const duration = Date.now() - startTime\r\n              logPerformance(operation, duration, {\r\n                method: propertyName\r\n              })\r\n              return res\r\n            })\r\n            .catch(error => {\r\n              const duration = Date.now() - startTime\r\n              logPerformance(operation, duration, {\r\n                method: propertyName,\r\n                error: error.message\r\n              })\r\n              throw error\r\n            })\r\n        } else {\r\n          const duration = Date.now() - startTime\r\n          logPerformance(operation, duration, {\r\n            method: propertyName\r\n          })\r\n          return result\r\n        }\r\n      } catch (error) {\r\n        const duration = Date.now() - startTime\r\n        logPerformance(operation, duration, {\r\n          method: propertyName,\r\n          error: error.message\r\n        })\r\n        throw error\r\n      }\r\n    }\r\n    \r\n    return descriptor\r\n  }\r\n}\r\n\r\n/**\r\n * Funci√≥n de utilidad para logging con contexto autom√°tico\r\n * @param {string} level - Nivel de log\r\n * @returns {Function} Funci√≥n de logging\r\n */\r\nexport const createLogger = (level = 'INFO') => {\r\n  return (userId, action, details = {}) => {\r\n    return auditService.log(userId, action, details, level)\r\n  }\r\n}\r\n\r\n/**\r\n * Logger espec√≠fico para seguridad\r\n */\r\nexport const securityLogger = {\r\n  loginAttempt: (userId, success, details = {}) => \r\n    logAuth(userId, 'LOGIN_ATTEMPT', details, success),\r\n  \r\n  loginFailed: (userId, reason, details = {}) => \r\n    logSecurity(userId, 'LOGIN_FAILED', { reason, ...details }, 'MEDIUM'),\r\n  \r\n  passwordChange: (userId, success, details = {}) => \r\n    logAuth(userId, 'PASSWORD_CHANGE', details, success),\r\n  \r\n  suspiciousActivity: (userId, activity, details = {}) => \r\n    logSecurity(userId, 'SUSPICIOUS_ACTIVITY', { activity, ...details }, 'HIGH'),\r\n  \r\n  unauthorizedAccess: (userId, resource, details = {}) => \r\n    logSecurity(userId, 'UNAUTHORIZED_ACCESS', { resource, ...details }, 'HIGH'),\r\n  \r\n  dataBreach: (userId, data, details = {}) => \r\n    logSecurity(userId, 'DATA_BREACH', { data, ...details }, 'CRITICAL')\r\n}\r\n\r\n/**\r\n * Logger espec√≠fico para aplicaciones\r\n */\r\nexport const appLogger = {\r\n  userAction: (userId, action, details = {}) => \r\n    logEvent(userId, `USER_${action.toUpperCase()}`, details),\r\n  \r\n  systemEvent: (event, details = {}) => \r\n    logEvent('SYSTEM', event, details),\r\n  \r\n  apiCall: (userId, endpoint, method, duration, statusCode) => \r\n    logEvent(userId, 'API_CALL', {\r\n      endpoint,\r\n      method,\r\n      duration,\r\n      statusCode\r\n    }),\r\n  \r\n  databaseQuery: (userId, table, operation, duration) => \r\n    logDataAccess(userId, table, operation, { duration }),\r\n  \r\n  fileAccess: (userId, filename, operation, details = {}) => \r\n    logDataAccess(userId, filename, operation, details)\r\n}\r\n\r\n/**\r\n * Logger espec√≠fico para rendimiento\r\n */\r\nexport const performanceLogger = {\r\n  slowQuery: (query, duration, details = {}) => \r\n    logPerformance('SLOW_QUERY', duration, { query, ...details }),\r\n  \r\n  memoryUsage: (used, total, details = {}) => \r\n    logPerformance('MEMORY_USAGE', used, { total, ...details }),\r\n  \r\n  cpuUsage: (usage, details = {}) => \r\n    logPerformance('CPU_USAGE', usage, details),\r\n  \r\n  responseTime: (endpoint, duration, details = {}) => \r\n    logPerformance('RESPONSE_TIME', duration, { endpoint, ...details }),\r\n  \r\n  throughput: (operations, timeWindow, details = {}) => \r\n    logPerformance('THROUGHPUT', operations, { timeWindow, ...details })\r\n}\r\n\r\n/**\r\n * Funci√≥n para crear logs estructurados\r\n * @param {string} userId - ID del usuario\r\n * @param {string} event - Evento\r\n * @param {Object} data - Datos estructurados\r\n * @param {string} level - Nivel de log\r\n * @returns {string} ID del log creado\r\n */\r\nexport const logStructured = (userId, event, data = {}, level = 'INFO') => {\r\n  const structuredData = {\r\n    event,\r\n    timestamp: new Date().toISOString(),\r\n    data,\r\n    schema: '1.0'\r\n  }\r\n  \r\n  return auditService.log(userId, event, structuredData, level)\r\n}\r\n\r\n/**\r\n * Funci√≥n para logging as√≠ncrono con batch\r\n * @param {Array} logs - Array de logs para procesar\r\n * @returns {Promise<Array>} IDs de logs creados\r\n */\r\nexport const batchLog = async (logs) => {\r\n  const results = []\r\n  \r\n  for (const logEntry of logs) {\r\n    try {\r\n      const { userId, action, details = {}, level = 'INFO' } = logEntry\r\n      const logId = auditService.log(userId, action, details, level)\r\n      results.push(logId)\r\n    } catch (error) {\r\n      console.error('Error in batch log:', error)\r\n      results.push(null)\r\n    }\r\n  }\r\n  \r\n  return results\r\n}\r\n\r\n/**\r\n * Funci√≥n para obtener m√©tricas de auditor√≠a\r\n * @param {Object} options - Opciones de m√©tricas\r\n * @returns {Object} M√©tricas de auditor√≠a\r\n */\r\nexport const getAuditMetrics = (options = {}) => {\r\n  const { hours = 24, category, userId } = options\r\n  \r\n  const filters = {}\r\n  if (category) filters.category = category\r\n  if (userId) filters.userId = userId\r\n  \r\n  const stats = auditService.getLogStats(filters)\r\n  const summary = auditService.getActivitySummary(hours)\r\n  \r\n  return {\r\n    timeRange: `${hours}h`,\r\n    stats,\r\n    summary,\r\n    generatedAt: new Date().toISOString()\r\n  }\r\n}\r\n\r\n/**\r\n * Funci√≥n para verificar salud del sistema de auditor√≠a\r\n * @returns {Object} Estado de salud del sistema\r\n */\r\nexport const getAuditHealth = () => {\r\n  try {\r\n    const totalLogs = auditService.logs.length\r\n    const recentLogs = getRecentLogs(1)\r\n    const errorRate = recentLogs.filter(log => log.level === 'ERROR').length / recentLogs.length\r\n    \r\n    return {\r\n      status: 'healthy',\r\n      totalLogs,\r\n      recentActivity: recentLogs.length,\r\n      errorRate: errorRate.toFixed(4),\r\n      lastLog: recentLogs.length > 0 ? recentLogs[0].timestamp : null,\r\n      memoryUsage: process.memoryUsage(),\r\n      uptime: process.uptime(),\r\n      checkedAt: new Date().toISOString()\r\n    }\r\n  } catch (error) {\r\n    return {\r\n      status: 'unhealthy',\r\n      error: error.message,\r\n      checkedAt: new Date().toISOString()\r\n    }\r\n  }\r\n}\r\n\r\nexport default {\r\n  logEvent,\r\n  logSecurity,\r\n  logAuth,\r\n  logDataAccess,\r\n  logError,\r\n  logPerformance,\r\n  logWarning,\r\n  logCritical,\r\n  logDebug,\r\n  searchLogs,\r\n  getUserLogs,\r\n  getSecurityLogs,\r\n  getErrorLogs,\r\n  getAuthLogs,\r\n  getLogsByDateRange,\r\n  getRecentLogs,\r\n  getLogStats,\r\n  getActivitySummary,\r\n  exportLogsJSON,\r\n  exportLogsCSV,\r\n  cleanupOldLogs,\r\n  auditMiddleware,\r\n  errorAuditMiddleware,\r\n  logMethod,\r\n  measurePerformance,\r\n  createLogger,\r\n  securityLogger,\r\n  appLogger,\r\n  performanceLogger,\r\n  logStructured,\r\n  batchLog,\r\n  getAuditMetrics,\r\n  getAuditHealth\r\n}","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\utils\\clearSupabaseCache.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\utils\\communicationUtils.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\utils\\cryptoUtils.js","messages":[{"ruleId":"import/no-anonymous-default-export","severity":1,"message":"Assign object to a variable before exporting as module default","line":419,"column":1,"nodeType":"ExportDefaultDeclaration","endLine":445,"endColumn":2}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Crypto Utilities\r\n * Utilidades criptogr√°ficas para encriptaci√≥n End-to-End\r\n * \r\n * ‚úÖ NO MODIFICA c√≥digo existente\r\n * ‚úÖ Completamente independiente\r\n * ‚úÖ Puede ser desactivado sin afectar el sistema\r\n */\r\n\r\nimport encryptionService from '../lib/encryptionService.js'\r\nimport keyManagement from '../lib/keyManagement.js'\r\n\r\n/**\r\n * Encriptar datos sensibles\r\n * @param {string|Object} data - Datos a encriptar\r\n * @param {string} keyId - ID de clave (opcional, usa la activa si no se proporciona)\r\n * @returns {string} Datos encriptados en base64\r\n */\r\nexport const encryptData = (data, keyId = null) => {\r\n  try {\r\n    let key\r\n    if (keyId) {\r\n      key = keyManagement.getKey(keyId)\r\n    } else {\r\n      const activeKey = keyManagement.getActiveKey()\r\n      key = activeKey.key\r\n    }\r\n\r\n    return encryptionService.encrypt(data, key)\r\n  } catch (error) {\r\n    console.error('Error encrypting data:', error)\r\n    throw new Error('Failed to encrypt data')\r\n  }\r\n}\r\n\r\n/**\r\n * Desencriptar datos\r\n * @param {string} encryptedData - Datos encriptados\r\n * @param {string} keyId - ID de clave (opcional, intenta todas las activas)\r\n * @param {boolean} parseJSON - Parsear como JSON\r\n * @returns {string|Object} Datos desencriptados\r\n */\r\nexport const decryptData = (encryptedData, keyId = null, parseJSON = false) => {\r\n  try {\r\n    if (keyId) {\r\n      const key = keyManagement.getKey(keyId)\r\n      return encryptionService.decrypt(encryptedData, key, parseJSON)\r\n    }\r\n\r\n    // Intentar con todas las claves activas\r\n    const activeKeys = keyManagement.getActiveKeys()\r\n    for (const { keyId: kid } of activeKeys) {\r\n      try {\r\n        const key = keyManagement.getKey(kid)\r\n        return encryptionService.decrypt(encryptedData, key, parseJSON)\r\n      } catch (e) {\r\n        // Continuar con la siguiente clave\r\n        continue\r\n      }\r\n    }\r\n\r\n    throw new Error('Failed to decrypt with any available key')\r\n  } catch (error) {\r\n    console.error('Error decrypting data:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\n/**\r\n * Encriptar con contrase√±a\r\n * @param {string|Object} data - Datos a encriptar\r\n * @param {string} password - Contrase√±a\r\n * @returns {string} Datos encriptados\r\n */\r\nexport const encryptWithPassword = (data, password) => {\r\n  try {\r\n    return encryptionService.encryptWithPassword(data, password)\r\n  } catch (error) {\r\n    console.error('Error encrypting with password:', error)\r\n    throw new Error('Failed to encrypt with password')\r\n  }\r\n}\r\n\r\n/**\r\n * Desencriptar con contrase√±a\r\n * @param {string} encryptedData - Datos encriptados\r\n * @param {string} password - Contrase√±a\r\n * @param {boolean} parseJSON - Parsear como JSON\r\n * @returns {string|Object} Datos desencriptados\r\n */\r\nexport const decryptWithPassword = (encryptedData, password, parseJSON = false) => {\r\n  try {\r\n    return encryptionService.decryptWithPassword(encryptedData, password, parseJSON)\r\n  } catch (error) {\r\n    console.error('Error decrypting with password:', error)\r\n    throw new Error('Failed to decrypt with password')\r\n  }\r\n}\r\n\r\n/**\r\n * Generar clave maestra\r\n * @param {string} password - Contrase√±a\r\n * @returns {Object} { keyId, key, salt, metadata }\r\n */\r\nexport const generateMasterKey = (password) => {\r\n  try {\r\n    return keyManagement.generateMasterKey(password)\r\n  } catch (error) {\r\n    console.error('Error generating master key:', error)\r\n    throw new Error('Failed to generate master key')\r\n  }\r\n}\r\n\r\n/**\r\n * Obtener clave activa\r\n * @returns {Object} { keyId, key, metadata }\r\n */\r\nexport const getActiveKey = () => {\r\n  try {\r\n    return keyManagement.getActiveKey()\r\n  } catch (error) {\r\n    console.error('Error getting active key:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\n/**\r\n * Rotar clave\r\n * @param {string} oldKeyId - ID de clave antigua\r\n * @param {string} password - Contrase√±a para nueva clave\r\n * @returns {Object} Nueva clave\r\n */\r\nexport const rotateKey = (oldKeyId, password) => {\r\n  try {\r\n    return keyManagement.rotateKey(oldKeyId, password)\r\n  } catch (error) {\r\n    console.error('Error rotating key:', error)\r\n    throw new Error('Failed to rotate key')\r\n  }\r\n}\r\n\r\n/**\r\n * Revocar clave\r\n * @param {string} keyId - ID de clave\r\n * @param {string} reason - Raz√≥n de revocaci√≥n\r\n */\r\nexport const revokeKey = (keyId, reason = 'Manual revocation') => {\r\n  try {\r\n    return keyManagement.revokeKey(keyId, reason)\r\n  } catch (error) {\r\n    console.error('Error revoking key:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\n/**\r\n * Crear hash HMAC\r\n * @param {string|Object} data - Datos\r\n * @param {string|Buffer} key - Clave HMAC\r\n * @returns {string} Hash\r\n */\r\nexport const createHMAC = (data, key) => {\r\n  try {\r\n    return encryptionService.createHMAC(data, key)\r\n  } catch (error) {\r\n    console.error('Error creating HMAC:', error)\r\n    throw new Error('Failed to create HMAC')\r\n  }\r\n}\r\n\r\n/**\r\n * Verificar HMAC\r\n * @param {string|Object} data - Datos\r\n * @param {string} hmac - HMAC a verificar\r\n * @param {string|Buffer} key - Clave HMAC\r\n * @returns {boolean} True si es v√°lido\r\n */\r\nexport const verifyHMAC = (data, hmac, key) => {\r\n  try {\r\n    return encryptionService.verifyHMAC(data, hmac, key)\r\n  } catch (error) {\r\n    console.error('Error verifying HMAC:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Hash seguro de contrase√±a\r\n * @param {string} password - Contrase√±a\r\n * @returns {string} Hash\r\n */\r\nexport const hashPassword = (password) => {\r\n  try {\r\n    return encryptionService.hashPassword(password)\r\n  } catch (error) {\r\n    console.error('Error hashing password:', error)\r\n    throw new Error('Failed to hash password')\r\n  }\r\n}\r\n\r\n/**\r\n * Verificar contrase√±a\r\n * @param {string} password - Contrase√±a a verificar\r\n * @param {string} hash - Hash almacenado\r\n * @returns {boolean} True si coincide\r\n */\r\nexport const verifyPassword = (password, hash) => {\r\n  try {\r\n    return encryptionService.verifyPassword(password, hash)\r\n  } catch (error) {\r\n    console.error('Error verifying password:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Generar clave aleatoria\r\n * @returns {string} Clave en base64\r\n */\r\nexport const generateRandomKey = () => {\r\n  try {\r\n    return encryptionService.generateKeyBase64()\r\n  } catch (error) {\r\n    console.error('Error generating random key:', error)\r\n    throw new Error('Failed to generate random key')\r\n  }\r\n}\r\n\r\n/**\r\n * Generar IV aleatorio\r\n * @returns {string} IV en base64\r\n */\r\nexport const generateRandomIV = () => {\r\n  try {\r\n    return encryptionService.generateIV().toString('base64')\r\n  } catch (error) {\r\n    console.error('Error generating random IV:', error)\r\n    throw new Error('Failed to generate random IV')\r\n  }\r\n}\r\n\r\n/**\r\n * Generar salt aleatorio\r\n * @returns {string} Salt en base64\r\n */\r\nexport const generateRandomSalt = () => {\r\n  try {\r\n    return encryptionService.generateSalt().toString('base64')\r\n  } catch (error) {\r\n    console.error('Error generating random salt:', error)\r\n    throw new Error('Failed to generate random salt')\r\n  }\r\n}\r\n\r\n/**\r\n * Exportar clave encriptada\r\n * @param {string} keyId - ID de clave\r\n * @param {string} exportPassword - Contrase√±a para exportaci√≥n\r\n * @returns {string} Clave encriptada\r\n */\r\nexport const exportKey = (keyId, exportPassword) => {\r\n  try {\r\n    return keyManagement.exportKey(keyId, exportPassword)\r\n  } catch (error) {\r\n    console.error('Error exporting key:', error)\r\n    throw new Error('Failed to export key')\r\n  }\r\n}\r\n\r\n/**\r\n * Importar clave encriptada\r\n * @param {string} encryptedKey - Clave encriptada\r\n * @param {string} importPassword - Contrase√±a para importaci√≥n\r\n * @returns {Object} { keyId, metadata }\r\n */\r\nexport const importKey = (encryptedKey, importPassword) => {\r\n  try {\r\n    return keyManagement.importKey(encryptedKey, importPassword)\r\n  } catch (error) {\r\n    console.error('Error importing key:', error)\r\n    throw new Error('Failed to import key')\r\n  }\r\n}\r\n\r\n/**\r\n * Obtener estad√≠sticas de encriptaci√≥n\r\n * @returns {Object} Estad√≠sticas\r\n */\r\nexport const getEncryptionStats = () => {\r\n  try {\r\n    return {\r\n      encryption: encryptionService.getStats(),\r\n      keyManagement: keyManagement.getStats()\r\n    }\r\n  } catch (error) {\r\n    console.error('Error getting encryption stats:', error)\r\n    return {}\r\n  }\r\n}\r\n\r\n/**\r\n * Obtener metadatos de clave\r\n * @param {string} keyId - ID de clave\r\n * @returns {Object} Metadatos\r\n */\r\nexport const getKeyMetadata = (keyId) => {\r\n  try {\r\n    return keyManagement.getKeyMetadata(keyId)\r\n  } catch (error) {\r\n    console.error('Error getting key metadata:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\n/**\r\n * Obtener todas las claves activas\r\n * @returns {Array} Claves activas\r\n */\r\nexport const getActiveKeys = () => {\r\n  try {\r\n    return keyManagement.getActiveKeys()\r\n  } catch (error) {\r\n    console.error('Error getting active keys:', error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * Limpiar claves expiradas\r\n * @returns {number} N√∫mero de claves eliminadas\r\n */\r\nexport const cleanupExpiredKeys = () => {\r\n  try {\r\n    return keyManagement.cleanupExpiredKeys()\r\n  } catch (error) {\r\n    console.error('Error cleaning up expired keys:', error)\r\n    return 0\r\n  }\r\n}\r\n\r\n/**\r\n * Verificar si clave necesita rotaci√≥n\r\n * @param {string} keyId - ID de clave\r\n * @returns {boolean} True si necesita rotaci√≥n\r\n */\r\nexport const needsKeyRotation = (keyId) => {\r\n  try {\r\n    return keyManagement.needsRotation(keyId)\r\n  } catch (error) {\r\n    console.error('Error checking key rotation:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Verificar si clave est√° expirada\r\n * @param {string} keyId - ID de clave\r\n * @returns {boolean} True si est√° expirada\r\n */\r\nexport const isKeyExpired = (keyId) => {\r\n  try {\r\n    return keyManagement.isExpired(keyId)\r\n  } catch (error) {\r\n    console.error('Error checking key expiration:', error)\r\n    return true\r\n  }\r\n}\r\n\r\n/**\r\n * Encriptar objeto completo\r\n * @param {Object} obj - Objeto a encriptar\r\n * @param {string} keyId - ID de clave (opcional)\r\n * @returns {Object} Objeto con datos encriptados\r\n */\r\nexport const encryptObject = (obj, keyId = null) => {\r\n  try {\r\n    const encrypted = {}\r\n    for (const [key, value] of Object.entries(obj)) {\r\n      if (value !== null && value !== undefined) {\r\n        encrypted[key] = encryptData(value, keyId)\r\n      } else {\r\n        encrypted[key] = value\r\n      }\r\n    }\r\n    return encrypted\r\n  } catch (error) {\r\n    console.error('Error encrypting object:', error)\r\n    throw new Error('Failed to encrypt object')\r\n  }\r\n}\r\n\r\n/**\r\n * Desencriptar objeto completo\r\n * @param {Object} obj - Objeto con datos encriptados\r\n * @param {string} keyId - ID de clave (opcional)\r\n * @returns {Object} Objeto desencriptado\r\n */\r\nexport const decryptObject = (obj, keyId = null) => {\r\n  try {\r\n    const decrypted = {}\r\n    for (const [key, value] of Object.entries(obj)) {\r\n      if (typeof value === 'string' && value.length > 0) {\r\n        try {\r\n          decrypted[key] = decryptData(value, keyId, true)\r\n        } catch (e) {\r\n          decrypted[key] = value\r\n        }\r\n      } else {\r\n        decrypted[key] = value\r\n      }\r\n    }\r\n    return decrypted\r\n  } catch (error) {\r\n    console.error('Error decrypting object:', error)\r\n    throw new Error('Failed to decrypt object')\r\n  }\r\n}\r\n\r\nexport default {\r\n  encryptData,\r\n  decryptData,\r\n  encryptWithPassword,\r\n  decryptWithPassword,\r\n  generateMasterKey,\r\n  getActiveKey,\r\n  rotateKey,\r\n  revokeKey,\r\n  createHMAC,\r\n  verifyHMAC,\r\n  hashPassword,\r\n  verifyPassword,\r\n  generateRandomKey,\r\n  generateRandomIV,\r\n  generateRandomSalt,\r\n  exportKey,\r\n  importKey,\r\n  getEncryptionStats,\r\n  getKeyMetadata,\r\n  getActiveKeys,\r\n  cleanupExpiredKeys,\r\n  needsKeyRotation,\r\n  isKeyExpired,\r\n  encryptObject,\r\n  decryptObject\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\utils\\formatters.js","messages":[{"ruleId":"no-useless-escape","severity":1,"message":"Unnecessary escape character: \\-.","line":324,"column":19,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":324,"endColumn":20,"suggestions":[{"messageId":"removeEscape","fix":{"range":[9871,9872],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[9871,9871],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":1,"message":"Unnecessary escape character: \\-.","line":325,"column":15,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":325,"endColumn":16,"suggestions":[{"messageId":"removeEscape","fix":{"range":[9898,9899],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[9898,9898],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":1,"message":"Unnecessary escape character: \\-.","line":325,"column":17,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":325,"endColumn":18,"suggestions":[{"messageId":"removeEscape","fix":{"range":[9900,9901],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[9900,9900],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"import/no-anonymous-default-export","severity":1,"message":"Assign object to a variable before exporting as module default","line":403,"column":1,"nodeType":"ExportDefaultDeclaration","endLine":422,"endColumn":3}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Utilidades de formateo para el sistema multi-empresa\r\n */\r\n\r\n/**\r\n * Formatear cantidad de n√∫meros con separadores de miles\r\n * @param {number} value - Valor a formatear\r\n * @param {string} locale - Configuraci√≥n regional (default: 'es-CL')\r\n * @returns {string} Valor formateado\r\n */\r\nexport const formatNumber = (value, locale = 'es-CL') => {\r\n  if (value === null || value === undefined || isNaN(value)) {\r\n    return '0';\r\n  }\r\n  \r\n  return new Intl.NumberFormat(locale, {\r\n    maximumFractionDigits: 0\r\n  }).format(value);\r\n};\r\n\r\n/**\r\n * Formatear cantidad de n√∫meros con decimales\r\n * @param {number} value - Valor a formatear\r\n * @param {number} decimals - Cantidad de decimales (default: 2)\r\n * @param {string} locale - Configuraci√≥n regional (default: 'es-CL')\r\n * @returns {string} Valor formateado\r\n */\r\nexport const formatDecimal = (value, decimals = 2, locale = 'es-CL') => {\r\n  if (value === null || value === undefined || isNaN(value)) {\r\n    return '0';\r\n  }\r\n  \r\n  return new Intl.NumberFormat(locale, {\r\n    minimumFractionDigits: decimals,\r\n    maximumFractionDigits: decimals\r\n  }).format(value);\r\n};\r\n\r\n/**\r\n * Formatear moneda (Pesos Chilenos por defecto)\r\n * @param {number} value - Valor a formatear\r\n * @param {string} currency - C√≥digo de moneda (default: 'CLP')\r\n * @param {string} locale - Configuraci√≥n regional (default: 'es-CL')\r\n * @returns {string} Valor formateado como moneda\r\n */\r\nexport const formatCurrency = (value, currency = 'CLP', locale = 'es-CL') => {\r\n  if (value === null || value === undefined || isNaN(value)) {\r\n    return '$0';\r\n  }\r\n  \r\n  // Para CLP no mostrar decimales\r\n  const options = {\r\n    style: 'currency',\r\n    currency: currency,\r\n    minimumFractionDigits: currency === 'CLP' ? 0 : 2,\r\n    maximumFractionDigits: currency === 'CLP' ? 0 : 2\r\n  };\r\n  \r\n  return new Intl.NumberFormat(locale, options).format(value);\r\n};\r\n\r\n/**\r\n * Formatear porcentaje\r\n * @param {number} value - Valor decimal (0.1 = 10%)\r\n * @param {number} decimals - Cantidad de decimales (default: 1)\r\n * @param {string} locale - Configuraci√≥n regional (default: 'es-CL')\r\n * @returns {string} Valor formateado como porcentaje\r\n */\r\nexport const formatPercentage = (value, decimals = 1, locale = 'es-CL') => {\r\n  if (value === null || value === undefined || isNaN(value)) {\r\n    return '0%';\r\n  }\r\n  \r\n  return new Intl.NumberFormat(locale, {\r\n    style: 'percent',\r\n    minimumFractionDigits: decimals,\r\n    maximumFractionDigits: decimals\r\n  }).format(value);\r\n};\r\n\r\n/**\r\n * Formatear fecha\r\n * @param {string|Date} date - Fecha a formatear\r\n * @param {Object} options - Opciones de formateo\r\n * @param {string} locale - Configuraci√≥n regional (default: 'es-CL')\r\n * @returns {string} Fecha formateada\r\n */\r\nexport const formatDate = (date, options = {}, locale = 'es-CL') => {\r\n  if (!date) return '';\r\n  \r\n  const dateObj = typeof date === 'string' ? new Date(date) : date;\r\n  \r\n  if (isNaN(dateObj.getTime())) return '';\r\n  \r\n  const defaultOptions = {\r\n    year: 'numeric',\r\n    month: 'short',\r\n    day: 'numeric'\r\n  };\r\n  \r\n  const formatOptions = { ...defaultOptions, ...options };\r\n  \r\n  return new Intl.DateTimeFormat(locale, formatOptions).format(dateObj);\r\n};\r\n\r\n/**\r\n * Formatear fecha y hora\r\n * @param {string|Date} date - Fecha a formatear\r\n * @param {Object} options - Opciones de formateo\r\n * @param {string} locale - Configuraci√≥n regional (default: 'es-CL')\r\n * @returns {string} Fecha y hora formateada\r\n */\r\nexport const formatDateTime = (date, options = {}, locale = 'es-CL') => {\r\n  if (!date) return '';\r\n  \r\n  const dateObj = typeof date === 'string' ? new Date(date) : date;\r\n  \r\n  if (isNaN(dateObj.getTime())) return '';\r\n  \r\n  const defaultOptions = {\r\n    year: 'numeric',\r\n    month: 'short',\r\n    day: 'numeric',\r\n    hour: '2-digit',\r\n    minute: '2-digit'\r\n  };\r\n  \r\n  const formatOptions = { ...defaultOptions, ...options };\r\n  \r\n  return new Intl.DateTimeFormat(locale, formatOptions).format(dateObj);\r\n};\r\n\r\n/**\r\n * Formatear hora relativa (hace 2 horas, ayer, etc.)\r\n * @param {string|Date} date - Fecha a formatear\r\n * @param {string} locale - Configuraci√≥n regional (default: 'es-CL')\r\n * @returns {string} Tiempo relativo formateado\r\n */\r\nexport const formatRelativeTime = (date, locale = 'es-CL') => {\r\n  if (!date) return '';\r\n  \r\n  const dateObj = typeof date === 'string' ? new Date(date) : date;\r\n  \r\n  if (isNaN(dateObj.getTime())) return '';\r\n  \r\n  const now = new Date();\r\n  const diffInSeconds = Math.floor((now - dateObj) / 1000);\r\n  \r\n  if (diffInSeconds < 60) {\r\n    return 'ahora';\r\n  }\r\n  \r\n  const diffInMinutes = Math.floor(diffInSeconds / 60);\r\n  if (diffInMinutes < 60) {\r\n    return `hace ${diffInMinutes} minuto${diffInMinutes !== 1 ? 's' : ''}`;\r\n  }\r\n  \r\n  const diffInHours = Math.floor(diffInMinutes / 60);\r\n  if (diffInHours < 24) {\r\n    return `hace ${diffInHours} hora${diffInHours !== 1 ? 's' : ''}`;\r\n  }\r\n  \r\n  const diffInDays = Math.floor(diffInHours / 24);\r\n  if (diffInDays < 7) {\r\n    if (diffInDays === 1) return 'ayer';\r\n    return `hace ${diffInDays} d√≠as`;\r\n  }\r\n  \r\n  const diffInWeeks = Math.floor(diffInDays / 7);\r\n  if (diffInWeeks < 4) {\r\n    return `hace ${diffInWeeks} semana${diffInWeeks !== 1 ? 's' : ''}`;\r\n  }\r\n  \r\n  const diffInMonths = Math.floor(diffInDays / 30);\r\n  if (diffInMonths < 12) {\r\n    return `hace ${diffInMonths} mes${diffInMonths !== 1 ? 'es' : ''}`;\r\n  }\r\n  \r\n  const diffInYears = Math.floor(diffInDays / 365);\r\n  return `hace ${diffInYears} a√±o${diffInYears !== 1 ? 's' : ''}`;\r\n};\r\n\r\n/**\r\n * Formatear tama√±o de archivo\r\n * @param {number} bytes - Tama√±o en bytes\r\n * @param {number} decimals - Cantidad de decimales (default: 2)\r\n * @returns {string} Tama√±o formateado\r\n */\r\nexport const formatFileSize = (bytes, decimals = 2) => {\r\n  if (bytes === 0) return '0 Bytes';\r\n  \r\n  const k = 1024;\r\n  const dm = decimals < 0 ? 0 : decimals;\r\n  const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];\r\n  \r\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n  \r\n  return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];\r\n};\r\n\r\n/**\r\n * Formatear duraci√≥n en milisegundos a formato legible\r\n * @param {number} milliseconds - Duraci√≥n en milisegundos\r\n * @returns {string} Duraci√≥n formateada\r\n */\r\nexport const formatDuration = (milliseconds) => {\r\n  if (!milliseconds || milliseconds === 0) return '0ms';\r\n  \r\n  const seconds = Math.floor(milliseconds / 1000);\r\n  const minutes = Math.floor(seconds / 60);\r\n  const hours = Math.floor(minutes / 60);\r\n  const days = Math.floor(hours / 24);\r\n  \r\n  if (days > 0) {\r\n    return `${days}d ${hours % 24}h ${minutes % 60}m`;\r\n  } else if (hours > 0) {\r\n    return `${hours}h ${minutes % 60}m`;\r\n  } else if (minutes > 0) {\r\n    return `${minutes}m ${seconds % 60}s`;\r\n  } else if (seconds > 0) {\r\n    return `${seconds}s`;\r\n  } else {\r\n    return `${milliseconds}ms`;\r\n  }\r\n};\r\n\r\n/**\r\n * Formatear n√∫mero de tel√©fono chileno\r\n * @param {string} phone - N√∫mero de tel√©fono\r\n * @returns {string} Tel√©fono formateado\r\n */\r\nexport const formatChileanPhone = (phone) => {\r\n  if (!phone) return '';\r\n  \r\n  // Limpiar el n√∫mero\r\n  const cleanPhone = phone.replace(/\\D/g, '');\r\n  \r\n  // Verificar si es un n√∫mero chileno v√°lido\r\n  if (cleanPhone.length === 9 && cleanPhone.startsWith('9')) {\r\n    // Formato: 9 1234 5678\r\n    return `${cleanPhone.slice(0, 1)} ${cleanPhone.slice(1, 5)} ${cleanPhone.slice(5)}`;\r\n  } else if (cleanPhone.length === 11 && cleanPhone.startsWith('569')) {\r\n    // Formato: +56 9 1234 5678\r\n    return `+56 ${cleanPhone.slice(2, 3)} ${cleanPhone.slice(3, 7)} ${cleanPhone.slice(7)}`;\r\n  } else if (cleanPhone.length === 12 && cleanPhone.startsWith('569')) {\r\n    // Formato: +56 9 1234 5678\r\n    return `+56 ${cleanPhone.slice(3, 4)} ${cleanPhone.slice(4, 8)} ${cleanPhone.slice(8)}`;\r\n  }\r\n  \r\n  // Si no coincide con los formatos chilenos, devolver el n√∫mero limpio\r\n  return cleanPhone;\r\n};\r\n\r\n/**\r\n * Formatear RUT chileno\r\n * @param {string} rut - RUT sin formatear\r\n * @returns {string} RUT formateado con puntos y gui√≥n\r\n */\r\nexport const formatChileanRUT = (rut) => {\r\n  if (!rut) return '';\r\n  \r\n  // Limpiar el RUT\r\n  const cleanRut = rut.replace(/[^\\dKk]/g, '');\r\n  \r\n  if (cleanRut.length < 2) return cleanRut;\r\n  \r\n  // Separar n√∫mero y d√≠gito verificador\r\n  const number = cleanRut.slice(0, -1);\r\n  const verifier = cleanRut.slice(-1).toUpperCase();\r\n  \r\n  // Formatear n√∫mero con puntos\r\n  const formattedNumber = new Intl.NumberFormat('es-CL').format(parseInt(number, 10));\r\n  \r\n  return `${formattedNumber}-${verifier}`;\r\n};\r\n\r\n/**\r\n * Validar RUT chileno\r\n * @param {string} rut - RUT a validar\r\n * @returns {boolean} True si es v√°lido\r\n */\r\nexport const validateChileanRUT = (rut) => {\r\n  if (!rut) return false;\r\n  \r\n  // Limpiar el RUT\r\n  const cleanRut = rut.replace(/[^\\dKk]/g, '');\r\n  \r\n  if (cleanRut.length < 2) return false;\r\n  \r\n  // Separar n√∫mero y d√≠gito verificador\r\n  const number = cleanRut.slice(0, -1);\r\n  const verifier = cleanRut.slice(-1).toUpperCase();\r\n  \r\n  // Calcular d√≠gito verificador\r\n  let sum = 0;\r\n  let factor = 2;\r\n  \r\n  for (let i = number.length - 1; i >= 0; i--) {\r\n    sum += parseInt(number[i], 10) * factor;\r\n    factor = factor === 7 ? 2 : factor + 1;\r\n  }\r\n  \r\n  const calculatedVerifier = 11 - (sum % 11);\r\n  const expectedVerifier = calculatedVerifier === 11 ? '0' : \r\n                          calculatedVerifier === 10 ? 'K' : \r\n                          calculatedVerifier.toString();\r\n  \r\n  return verifier === expectedVerifier;\r\n};\r\n\r\n/**\r\n * Formatear texto para URL (slug)\r\n * @param {string} text - Texto a formatear\r\n * @returns {string} Texto formateado como slug\r\n */\r\nexport const formatSlug = (text) => {\r\n  if (!text) return '';\r\n  \r\n  return text\r\n    .toString()\r\n    .toLowerCase()\r\n    .trim()\r\n    .replace(/\\s+/g, '-')\r\n    .replace(/[^\\w\\-]+/g, '')\r\n    .replace(/\\-\\-+/g, '-')\r\n    .replace(/^-+/, '')\r\n    .replace(/-+$/, '');\r\n};\r\n\r\n/**\r\n * Truncar texto\r\n * @param {string} text - Texto a truncar\r\n * @param {number} maxLength - Longitud m√°xima\r\n * @param {string} suffix - Sufijo (default: '...')\r\n * @returns {string} Texto truncado\r\n */\r\nexport const truncateText = (text, maxLength, suffix = '...') => {\r\n  if (!text) return '';\r\n  \r\n  if (text.length <= maxLength) return text;\r\n  \r\n  return text.substring(0, maxLength - suffix.length) + suffix;\r\n};\r\n\r\n/**\r\n * Capitalizar primera letra\r\n * @param {string} text - Texto a capitalizar\r\n * @returns {string} Texto capitalizado\r\n */\r\nexport const capitalize = (text) => {\r\n  if (!text) return '';\r\n  \r\n  return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();\r\n};\r\n\r\n/**\r\n * Capitalizar cada palabra\r\n * @param {string} text - Texto a capitalizar\r\n * @returns {string} Texto con cada palabra capitalizada\r\n */\r\nexport const capitalizeWords = (text) => {\r\n  if (!text) return '';\r\n  \r\n  return text.split(' ').map(word => capitalize(word)).join(' ');\r\n};\r\n\r\n/**\r\n * Formatear estado de mensaje\r\n * @param {string} status - Estado del mensaje\r\n * @returns {Object} Objeto con estado formateado\r\n */\r\nexport const formatMessageStatus = (status) => {\r\n  const statusMap = {\r\n    pending: { text: 'Pendiente', color: 'yellow', icon: 'ClockIcon' },\r\n    sent: { text: 'Enviado', color: 'blue', icon: 'PaperAirplaneIcon' },\r\n    delivered: { text: 'Entregado', color: 'green', icon: 'CheckCircleIcon' },\r\n    read: { text: 'Le√≠do', color: 'green', icon: 'CheckIcon' },\r\n    failed: { text: 'Fallido', color: 'red', icon: 'XCircleIcon' },\r\n    cancelled: { text: 'Cancelado', color: 'gray', icon: 'XMarkIcon' }\r\n  };\r\n  \r\n  return statusMap[status] || { text: status, color: 'gray', icon: 'QuestionMarkCircleIcon' };\r\n};\r\n\r\n/**\r\n * Formatear tipo de canal\r\n * @param {string} channel - Tipo de canal\r\n * @returns {Object} Objeto con canal formateado\r\n */\r\nexport const formatChannelType = (channel) => {\r\n  const channelMap = {\r\n    email: { text: 'Email', color: 'blue', icon: 'EnvelopeIcon' },\r\n    sms: { text: 'SMS', color: 'green', icon: 'PhoneIcon' },\r\n    whatsapp: { text: 'WhatsApp', color: 'green', icon: 'ChatBubbleLeftRightIcon' },\r\n    telegram: { text: 'Telegram', color: 'blue', icon: 'ChatBubbleLeftRightIcon' },\r\n    push: { text: 'Push', color: 'purple', icon: 'BellIcon' },\r\n    webhook: { text: 'Webhook', color: 'gray', icon: 'LinkIcon' }\r\n  };\r\n  \r\n  return channelMap[channel] || { text: channel, color: 'gray', icon: 'QuestionMarkCircleIcon' };\r\n};\r\n\r\nexport default {\r\n  formatNumber,\r\n  formatDecimal,\r\n  formatCurrency,\r\n  formatPercentage,\r\n  formatDate,\r\n  formatDateTime,\r\n  formatRelativeTime,\r\n  formatFileSize,\r\n  formatDuration,\r\n  formatChileanPhone,\r\n  formatChileanRUT,\r\n  validateChileanRUT,\r\n  formatSlug,\r\n  truncateText,\r\n  capitalize,\r\n  capitalizeWords,\r\n  formatMessageStatus,\r\n  formatChannelType\r\n};","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\utils\\healthMonitorInitializer.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\utils\\lazyLoadComponent.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'fallback' is assigned a value but never used.","line":36,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":36,"endColumn":13},{"ruleId":"no-unused-vars","severity":1,"message":"'restOptions' is assigned a value but never used.","line":159,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":159,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Lazy Load Component Utility\r\n * Utilidad para lazy loading de componentes React\r\n * \r\n * ‚úÖ NO MODIFICA c√≥digo existente\r\n * ‚úÖ Completamente independiente\r\n * ‚úÖ Puede ser desactivado sin afectar el sistema\r\n */\r\n\r\nimport React, { Suspense, lazy } from 'react'\r\n\r\n/**\r\n * Componente de fallback mientras carga\r\n */\r\nconst DefaultFallback = () => (\r\n  <div style={{\r\n    display: 'flex',\r\n    justifyContent: 'center',\r\n    alignItems: 'center',\r\n    minHeight: '200px',\r\n    fontSize: '14px',\r\n    color: '#666'\r\n  }}>\r\n    <div>Cargando...</div>\r\n  </div>\r\n)\r\n\r\n/**\r\n * Lazy load un componente con retry autom√°tico\r\n * @param {Function} importFn - Funci√≥n que retorna import()\r\n * @param {Object} options - Opciones de configuraci√≥n\r\n * @returns {React.Component} Componente lazy loaded\r\n */\r\nexport const lazyLoadComponent = (importFn, options = {}) => {\r\n  const {\r\n    fallback = <DefaultFallback />,\r\n    retries = 3,\r\n    delay = 1000,\r\n    onError = null\r\n  } = options\r\n\r\n  let retryCount = 0\r\n\r\n  const LazyComponent = lazy(() => {\r\n    return importFn().catch(error => {\r\n      if (retryCount < retries) {\r\n        retryCount++\r\n        console.warn(`Retry ${retryCount}/${retries} loading component...`)\r\n        \r\n        return new Promise(resolve => {\r\n          setTimeout(() => {\r\n            resolve(importFn())\r\n          }, delay)\r\n        })\r\n      }\r\n\r\n      console.error('Failed to load component:', error)\r\n      if (onError) onError(error)\r\n      \r\n      throw error\r\n    })\r\n  })\r\n\r\n  return LazyComponent\r\n}\r\n\r\n/**\r\n * Lazy load m√∫ltiples componentes\r\n * @param {Object} components - Objeto con componentes a lazy load\r\n * @param {Object} options - Opciones de configuraci√≥n\r\n * @returns {Object} Objeto con componentes lazy loaded\r\n */\r\nexport const lazyLoadComponents = (components = {}, options = {}) => {\r\n  const lazyComponents = {}\r\n\r\n  for (const [key, importFn] of Object.entries(components)) {\r\n    lazyComponents[key] = lazyLoadComponent(importFn, options)\r\n  }\r\n\r\n  return lazyComponents\r\n}\r\n\r\n/**\r\n * Wrapper para Suspense con fallback personalizado\r\n * @param {React.Component} Component - Componente lazy loaded\r\n * @param {React.Component} fallback - Componente de fallback\r\n * @returns {React.Component} Componente envuelto en Suspense\r\n */\r\nexport const withSuspense = (Component, fallback = <DefaultFallback />) => {\r\n  return (props) => (\r\n    <Suspense fallback={fallback}>\r\n      <Component {...props} />\r\n    </Suspense>\r\n  )\r\n}\r\n\r\n/**\r\n * Lazy load por ruta (para React Router)\r\n * @param {Function} importFn - Funci√≥n que retorna import()\r\n * @param {Object} options - Opciones de configuraci√≥n\r\n * @returns {Object} Objeto con componente y fallback para React Router\r\n */\r\nexport const lazyLoadRoute = (importFn, options = {}) => {\r\n  const {\r\n    fallback = <DefaultFallback />,\r\n    ...restOptions\r\n  } = options\r\n\r\n  const Component = lazyLoadComponent(importFn, restOptions)\r\n\r\n  return {\r\n    Component: withSuspense(Component, fallback),\r\n    fallback\r\n  }\r\n}\r\n\r\n/**\r\n * Lazy load con prefetch\r\n * @param {Function} importFn - Funci√≥n que retorna import()\r\n * @param {Object} options - Opciones de configuraci√≥n\r\n * @returns {Object} Objeto con componente y funci√≥n de prefetch\r\n */\r\nexport const lazyLoadWithPrefetch = (importFn, options = {}) => {\r\n  const {\r\n    fallback = <DefaultFallback />,\r\n    ...restOptions\r\n  } = options\r\n\r\n  const Component = lazyLoadComponent(importFn, restOptions)\r\n  let prefetched = false\r\n\r\n  const prefetch = () => {\r\n    if (!prefetched) {\r\n      prefetched = true\r\n      importFn().catch(error => {\r\n        console.warn('Prefetch failed:', error)\r\n      })\r\n    }\r\n  }\r\n\r\n  return {\r\n    Component: withSuspense(Component, fallback),\r\n    prefetch,\r\n    fallback\r\n  }\r\n}\r\n\r\n/**\r\n * Lazy load con timeout\r\n * @param {Function} importFn - Funci√≥n que retorna import()\r\n * @param {number} timeoutMs - Timeout en milisegundos\r\n * @param {Object} options - Opciones de configuraci√≥n\r\n * @returns {React.Component} Componente lazy loaded con timeout\r\n */\r\nexport const lazyLoadWithTimeout = (importFn, timeoutMs = 10000, options = {}) => {\r\n  const {\r\n    fallback = <DefaultFallback />,\r\n    onTimeout = null,\r\n    ...restOptions\r\n  } = options\r\n\r\n  const LazyComponent = lazy(() => {\r\n    return Promise.race([\r\n      importFn(),\r\n      new Promise((_, reject) =>\r\n        setTimeout(() => {\r\n          const error = new Error(`Component loading timeout after ${timeoutMs}ms`)\r\n          if (onTimeout) onTimeout(error)\r\n          reject(error)\r\n        }, timeoutMs)\r\n      )\r\n    ])\r\n  })\r\n\r\n  return withSuspense(LazyComponent, fallback)\r\n}\r\n\r\n/**\r\n * Lazy load con error boundary\r\n * @param {Function} importFn - Funci√≥n que retorna import()\r\n * @param {Object} options - Opciones de configuraci√≥n\r\n * @returns {React.Component} Componente lazy loaded con error boundary\r\n */\r\nexport const lazyLoadWithErrorBoundary = (importFn, options = {}) => {\r\n  const {\r\n    fallback = <DefaultFallback />,\r\n    errorFallback = null,\r\n    onError = null\r\n  } = options\r\n\r\n  const Component = lazyLoadComponent(importFn, options)\r\n\r\n  class ErrorBoundary extends React.Component {\r\n    constructor(props) {\r\n      super(props)\r\n      this.state = { hasError: false, error: null }\r\n    }\r\n\r\n    static getDerivedStateFromError(error) {\r\n      return { hasError: true, error }\r\n    }\r\n\r\n    componentDidCatch(error, errorInfo) {\r\n      console.error('Component error:', error, errorInfo)\r\n      if (onError) onError(error, errorInfo)\r\n    }\r\n\r\n    render() {\r\n      if (this.state.hasError) {\r\n        return errorFallback || (\r\n          <div style={{\r\n            padding: '20px',\r\n            color: '#d32f2f',\r\n            backgroundColor: '#ffebee',\r\n            borderRadius: '4px'\r\n          }}>\r\n            Error loading component: {this.state.error?.message}\r\n          </div>\r\n        )\r\n      }\r\n\r\n      return (\r\n        <Suspense fallback={fallback}>\r\n          <Component {...this.props} />\r\n        </Suspense>\r\n      )\r\n    }\r\n  }\r\n\r\n  return ErrorBoundary\r\n}\r\n\r\n/**\r\n * Lazy load con estad√≠sticas\r\n * @param {Function} importFn - Funci√≥n que retorna import()\r\n * @param {Object} options - Opciones de configuraci√≥n\r\n * @returns {Object} Objeto con componente y estad√≠sticas\r\n */\r\nexport const lazyLoadWithStats = (importFn, options = {}) => {\r\n  const {\r\n    fallback = <DefaultFallback />,\r\n    name = 'Component'\r\n  } = options\r\n\r\n  const stats = {\r\n    name,\r\n    startTime: null,\r\n    endTime: null,\r\n    duration: null,\r\n    success: false,\r\n    error: null\r\n  }\r\n\r\n  const LazyComponent = lazy(() => {\r\n    stats.startTime = performance.now()\r\n\r\n    return importFn()\r\n      .then(module => {\r\n        stats.endTime = performance.now()\r\n        stats.duration = stats.endTime - stats.startTime\r\n        stats.success = true\r\n        console.log(`‚úÖ ${name} loaded in ${stats.duration.toFixed(2)}ms`)\r\n        return module\r\n      })\r\n      .catch(error => {\r\n        stats.endTime = performance.now()\r\n        stats.duration = stats.endTime - stats.startTime\r\n        stats.error = error\r\n        console.error(`‚ùå ${name} failed to load after ${stats.duration.toFixed(2)}ms:`, error)\r\n        throw error\r\n      })\r\n  })\r\n\r\n  return {\r\n    Component: withSuspense(LazyComponent, fallback),\r\n    stats,\r\n    fallback\r\n  }\r\n}\r\n\r\n/**\r\n * Lazy load con cach√©\r\n * @param {Function} importFn - Funci√≥n que retorna import()\r\n * @param {Object} options - Opciones de configuraci√≥n\r\n * @returns {Object} Objeto con componente y funciones de cach√©\r\n */\r\nexport const lazyLoadWithCache = (importFn, options = {}) => {\r\n  const {\r\n    fallback = <DefaultFallback />,\r\n    cacheKey = null\r\n  } = options\r\n\r\n  let cachedModule = null\r\n  const key = cacheKey || importFn.toString()\r\n\r\n  const LazyComponent = lazy(() => {\r\n    if (cachedModule) {\r\n      console.log(`üì¶ Using cached module: ${key}`)\r\n      return Promise.resolve(cachedModule)\r\n    }\r\n\r\n    return importFn().then(module => {\r\n      cachedModule = module\r\n      console.log(`üíæ Cached module: ${key}`)\r\n      return module\r\n    })\r\n  })\r\n\r\n  return {\r\n    Component: withSuspense(LazyComponent, fallback),\r\n    clearCache: () => {\r\n      cachedModule = null\r\n      console.log(`üóëÔ∏è Cleared cache: ${key}`)\r\n    },\r\n    fallback\r\n  }\r\n}\r\n\r\nexport default lazyLoadComponent\r\n","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\utils\\mfaUtils.js","messages":[{"ruleId":"import/no-anonymous-default-export","severity":1,"message":"Assign object to a variable before exporting as module default","line":370,"column":1,"nodeType":"ExportDefaultDeclaration","endLine":388,"endColumn":2}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * MFA Utilities\r\n * Utilidades para Autenticaci√≥n Multi-Factor\r\n * \r\n * ‚úÖ NO MODIFICA c√≥digo existente\r\n * ‚úÖ Completamente independiente\r\n * ‚úÖ Puede ser desactivado sin afectar el sistema\r\n */\r\n\r\nimport mfaService from '../lib/mfaService.js'\r\n\r\n/**\r\n * Generar secreto TOTP para usuario\r\n * @param {string} email - Email del usuario\r\n * @param {string} issuer - Nombre de la aplicaci√≥n\r\n * @returns {Object} { secret, qrCodeUrl, backupCodes }\r\n */\r\nexport const generateTOTPSecret = (email = 'user@example.com', issuer = 'BrifyRRHH') => {\r\n  try {\r\n    const result = mfaService.generateTOTPSecret()\r\n    const qrCodeUrl = mfaService.generateQRCodeURL(result.secret, email, issuer)\r\n    \r\n    return {\r\n      ...result,\r\n      qrCodeUrl\r\n    }\r\n  } catch (error) {\r\n    console.error('Error generating TOTP secret:', error)\r\n    throw new Error('Failed to generate TOTP secret')\r\n  }\r\n}\r\n\r\n/**\r\n * Verificar c√≥digo TOTP\r\n * @param {string} secret - Secreto TOTP\r\n * @param {string} token - Token a verificar\r\n * @returns {boolean} True si es v√°lido\r\n */\r\nexport const verifyTOTP = (secret, token) => {\r\n  try {\r\n    return mfaService.verifyTOTP(secret, token)\r\n  } catch (error) {\r\n    console.error('Error verifying TOTP:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Generar OTP por SMS\r\n * @param {string} userId - ID del usuario\r\n * @param {string} phoneNumber - N√∫mero de tel√©fono\r\n * @returns {Object} { otp, expiresAt, maskedPhone }\r\n */\r\nexport const generateSMSOTP = (userId, phoneNumber) => {\r\n  try {\r\n    return mfaService.generateSMSOTP(userId, phoneNumber)\r\n  } catch (error) {\r\n    console.error('Error generating SMS OTP:', error)\r\n    throw new Error('Failed to generate SMS OTP')\r\n  }\r\n}\r\n\r\n/**\r\n * Verificar OTP por SMS\r\n * @param {string} userId - ID del usuario\r\n * @param {string} otp - OTP a verificar\r\n * @returns {boolean} True si es v√°lido\r\n */\r\nexport const verifySMSOTP = (userId, otp) => {\r\n  try {\r\n    return mfaService.verifySMSOTP(userId, otp)\r\n  } catch (error) {\r\n    console.error('Error verifying SMS OTP:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Generar c√≥digos de respaldo\r\n * @param {number} count - Cantidad de c√≥digos\r\n * @returns {Array} Array de c√≥digos\r\n */\r\nexport const generateBackupCodes = (count = 10) => {\r\n  try {\r\n    return mfaService.generateBackupCodes(count)\r\n  } catch (error) {\r\n    console.error('Error generating backup codes:', error)\r\n    throw new Error('Failed to generate backup codes')\r\n  }\r\n}\r\n\r\n/**\r\n * Verificar c√≥digo de respaldo\r\n * @param {string} userId - ID del usuario\r\n * @param {string} code - C√≥digo a verificar\r\n * @returns {boolean} True si es v√°lido\r\n */\r\nexport const verifyBackupCode = (userId, code) => {\r\n  try {\r\n    return mfaService.verifyBackupCode(userId, code)\r\n  } catch (error) {\r\n    console.error('Error verifying backup code:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Registrar MFA para usuario\r\n * @param {string} userId - ID del usuario\r\n * @param {Object} mfaConfig - Configuraci√≥n MFA\r\n * @returns {Object} Resultado del registro\r\n */\r\nexport const registerMFA = (userId, mfaConfig) => {\r\n  try {\r\n    return mfaService.registerMFA(userId, mfaConfig)\r\n  } catch (error) {\r\n    console.error('Error registering MFA:', error)\r\n    throw new Error('Failed to register MFA')\r\n  }\r\n}\r\n\r\n/**\r\n * Obtener configuraci√≥n MFA del usuario\r\n * @param {string} userId - ID del usuario\r\n * @returns {Object} Configuraci√≥n MFA\r\n */\r\nexport const getMFAConfig = (userId) => {\r\n  try {\r\n    return mfaService.getMFAConfig(userId)\r\n  } catch (error) {\r\n    console.error('Error getting MFA config:', error)\r\n    return null\r\n  }\r\n}\r\n\r\n/**\r\n * Deshabilitar MFA para usuario\r\n * @param {string} userId - ID del usuario\r\n * @returns {Object} Resultado\r\n */\r\nexport const disableMFA = (userId) => {\r\n  try {\r\n    return mfaService.disableMFA(userId)\r\n  } catch (error) {\r\n    console.error('Error disabling MFA:', error)\r\n    throw new Error('Failed to disable MFA')\r\n  }\r\n}\r\n\r\n/**\r\n * Obtener estad√≠sticas de MFA\r\n * @returns {Object} Estad√≠sticas\r\n */\r\nexport const getMFAStats = () => {\r\n  try {\r\n    return mfaService.getStats()\r\n  } catch (error) {\r\n    console.error('Error getting MFA stats:', error)\r\n    return {}\r\n  }\r\n}\r\n\r\n/**\r\n * Configurar MFA completo para usuario (TOTP + SMS + Backup Codes)\r\n * @param {string} userId - ID del usuario\r\n * @param {string} email - Email del usuario\r\n * @param {string} phoneNumber - N√∫mero de tel√©fono\r\n * @returns {Object} Configuraci√≥n completa\r\n */\r\nexport const setupCompleteMFA = (userId, email, phoneNumber) => {\r\n  try {\r\n    // Generar TOTP\r\n    const totp = generateTOTPSecret(email)\r\n    \r\n    // Generar SMS OTP\r\n    const smsOTP = generateSMSOTP(userId, phoneNumber)\r\n    \r\n    // Generar c√≥digos de respaldo\r\n    const backupCodes = generateBackupCodes(10)\r\n\r\n    // Registrar MFA\r\n    const mfaConfig = {\r\n      totpSecret: totp.secret,\r\n      phoneNumber,\r\n      backupCodes\r\n    }\r\n\r\n    const result = registerMFA(userId, mfaConfig)\r\n\r\n    return {\r\n      userId,\r\n      status: 'configured',\r\n      totp: {\r\n        secret: totp.secret,\r\n        qrCodeUrl: totp.qrCodeUrl\r\n      },\r\n      sms: {\r\n        maskedPhone: smsOTP.maskedPhone,\r\n        expiresAt: smsOTP.expiresAt\r\n      },\r\n      backupCodes,\r\n      methods: result.methods\r\n    }\r\n  } catch (error) {\r\n    console.error('Error setting up complete MFA:', error)\r\n    throw new Error('Failed to setup complete MFA')\r\n  }\r\n}\r\n\r\n/**\r\n * Verificar MFA (intenta todos los m√©todos disponibles)\r\n * @param {string} userId - ID del usuario\r\n * @param {string} token - Token a verificar (TOTP, SMS OTP o Backup Code)\r\n * @param {string} secret - Secreto TOTP (si se verifica TOTP)\r\n * @returns {Object} { success, method, message }\r\n */\r\nexport const verifyMFA = (userId, token, secret = null) => {\r\n  try {\r\n    const config = getMFAConfig(userId)\r\n    \r\n    if (!config || !config.enabled) {\r\n      return {\r\n        success: false,\r\n        method: null,\r\n        message: 'MFA not enabled for this user'\r\n      }\r\n    }\r\n\r\n    // Intentar verificar como TOTP\r\n    if (config.methods.totp && secret) {\r\n      if (verifyTOTP(secret, token)) {\r\n        return {\r\n          success: true,\r\n          method: 'totp',\r\n          message: 'TOTP verified successfully'\r\n        }\r\n      }\r\n    }\r\n\r\n    // Intentar verificar como SMS OTP\r\n    if (config.methods.sms) {\r\n      if (verifySMSOTP(userId, token)) {\r\n        return {\r\n          success: true,\r\n          method: 'sms',\r\n          message: 'SMS OTP verified successfully'\r\n        }\r\n      }\r\n    }\r\n\r\n    // Intentar verificar como Backup Code\r\n    if (config.methods.backupCodes > 0) {\r\n      if (verifyBackupCode(userId, token)) {\r\n        return {\r\n          success: true,\r\n          method: 'backup_code',\r\n          message: 'Backup code verified successfully'\r\n        }\r\n      }\r\n    }\r\n\r\n    return {\r\n      success: false,\r\n      method: null,\r\n      message: 'Invalid token'\r\n    }\r\n  } catch (error) {\r\n    console.error('Error verifying MFA:', error)\r\n    return {\r\n      success: false,\r\n      method: null,\r\n      message: 'Error verifying MFA'\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Obtener informaci√≥n de MFA para mostrar en UI\r\n * @param {string} userId - ID del usuario\r\n * @returns {Object} Informaci√≥n formateada\r\n */\r\nexport const getMFAInfo = (userId) => {\r\n  try {\r\n    const config = getMFAConfig(userId)\r\n    \r\n    if (!config) {\r\n      return {\r\n        enabled: false,\r\n        methods: [],\r\n        message: 'MFA not configured'\r\n      }\r\n    }\r\n\r\n    const methods = []\r\n    if (config.methods.totp) methods.push('Authenticator App (TOTP)')\r\n    if (config.methods.sms) methods.push('SMS OTP')\r\n    if (config.methods.backupCodes > 0) methods.push(`Backup Codes (${config.methods.backupCodes} remaining)`)\r\n\r\n    return {\r\n      enabled: config.enabled,\r\n      methods,\r\n      registeredAt: new Date(config.registeredAt).toLocaleString(),\r\n      message: `MFA enabled with ${methods.length} method(s)`\r\n    }\r\n  } catch (error) {\r\n    console.error('Error getting MFA info:', error)\r\n    return {\r\n      enabled: false,\r\n      methods: [],\r\n      message: 'Error retrieving MFA info'\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Formatear c√≥digo de respaldo para mostrar\r\n * @param {string} code - C√≥digo sin formato\r\n * @returns {string} C√≥digo formateado\r\n */\r\nexport const formatBackupCode = (code) => {\r\n  try {\r\n    const cleaned = code.toUpperCase().replace(/\\s/g, '')\r\n    return `${cleaned.slice(0, 4)}-${cleaned.slice(4, 8)}`\r\n  } catch (error) {\r\n    return code\r\n  }\r\n}\r\n\r\n/**\r\n * Validar formato de c√≥digo TOTP\r\n * @param {string} token - Token a validar\r\n * @returns {boolean} True si es v√°lido\r\n */\r\nexport const isValidTOTPFormat = (token) => {\r\n  try {\r\n    return /^\\d{6}$/.test(token)\r\n  } catch (error) {\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Validar formato de c√≥digo de respaldo\r\n * @param {string} code - C√≥digo a validar\r\n * @returns {boolean} True si es v√°lido\r\n */\r\nexport const isValidBackupCodeFormat = (code) => {\r\n  try {\r\n    const cleaned = code.toUpperCase().replace(/\\s/g, '')\r\n    return /^[A-F0-9]{8}$/.test(cleaned)\r\n  } catch (error) {\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Obtener tiempo restante para TOTP actual\r\n * @returns {number} Segundos restantes (0-30)\r\n */\r\nexport const getTOTPTimeRemaining = () => {\r\n  try {\r\n    const now = Math.floor(Date.now() / 1000)\r\n    const period = 30\r\n    return period - (now % period)\r\n  } catch (error) {\r\n    return 0\r\n  }\r\n}\r\n\r\nexport default {\r\n  generateTOTPSecret,\r\n  verifyTOTP,\r\n  generateSMSOTP,\r\n  verifySMSOTP,\r\n  generateBackupCodes,\r\n  verifyBackupCode,\r\n  registerMFA,\r\n  getMFAConfig,\r\n  disableMFA,\r\n  getMFAStats,\r\n  setupCompleteMFA,\r\n  verifyMFA,\r\n  getMFAInfo,\r\n  formatBackupCode,\r\n  isValidTOTPFormat,\r\n  isValidBackupCodeFormat,\r\n  getTOTPTimeRemaining\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\utils\\nuclearCleanup.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\utils\\performanceMonitor.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]},{"filePath":"c:\\Users\\admin\\Desktop\\AIntelligence\\RRHH Brify\\BrifyRRHHv2-main\\src\\utils\\rbacUtils.js","messages":[{"ruleId":"import/no-anonymous-default-export","severity":1,"message":"Assign object to a variable before exporting as module default","line":481,"column":1,"nodeType":"ExportDefaultDeclaration","endLine":509,"endColumn":2}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * RBAC Utilities\r\n * Utilidades para Control de Acceso Basado en Roles\r\n * \r\n * ‚úÖ NO MODIFICA c√≥digo existente\r\n * ‚úÖ Completamente independiente\r\n * ‚úÖ Puede ser desactivado sin afectar el sistema\r\n */\r\n\r\nimport rbacService from '../lib/rbacService.js'\r\n\r\n/**\r\n * Verificar si usuario tiene permiso\r\n * @param {string} userId - ID del usuario\r\n * @param {string} permissionId - ID del permiso\r\n * @returns {boolean} True si tiene permiso\r\n */\r\nexport const hasPermission = (userId, permissionId) => {\r\n  try {\r\n    return rbacService.hasPermission(userId, permissionId)\r\n  } catch (error) {\r\n    console.error('Error checking permission:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Verificar si usuario tiene rol espec√≠fico\r\n * @param {string} userId - ID del usuario\r\n * @param {string} roleId - ID del rol\r\n * @returns {boolean} True si tiene el rol\r\n */\r\nexport const hasRole = (userId, roleId) => {\r\n  try {\r\n    const userRoles = rbacService.getUserRoles(userId)\r\n    return userRoles.some(role => role.id === roleId)\r\n  } catch (error) {\r\n    console.error('Error checking role:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Verificar si usuario tiene al menos uno de los roles\r\n * @param {string} userId - ID del usuario\r\n * @param {Array} roleIds - Array de IDs de roles\r\n * @returns {boolean} True si tiene al menos un rol\r\n */\r\nexport const hasAnyRole = (userId, roleIds) => {\r\n  try {\r\n    const userRoles = rbacService.getUserRoles(userId)\r\n    const userRoleIds = userRoles.map(role => role.id)\r\n    return roleIds.some(roleId => userRoleIds.includes(roleId))\r\n  } catch (error) {\r\n    console.error('Error checking any role:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Verificar si usuario tiene todos los roles\r\n * @param {string} userId - ID del usuario\r\n * @param {Array} roleIds - Array de IDs de roles\r\n * @returns {boolean} True si tiene todos los roles\r\n */\r\nexport const hasAllRoles = (userId, roleIds) => {\r\n  try {\r\n    const userRoles = rbacService.getUserRoles(userId)\r\n    const userRoleIds = userRoles.map(role => role.id)\r\n    return roleIds.every(roleId => userRoleIds.includes(roleId))\r\n  } catch (error) {\r\n    console.error('Error checking all roles:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Obtener todos los permisos de usuario\r\n * @param {string} userId - ID del usuario\r\n * @returns {Array} Array de permisos\r\n */\r\nexport const getUserPermissions = (userId) => {\r\n  try {\r\n    return rbacService.getUserPermissions(userId)\r\n  } catch (error) {\r\n    console.error('Error getting user permissions:', error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * Obtener roles de usuario\r\n * @param {string} userId - ID del usuario\r\n * @returns {Array} Array de roles\r\n */\r\nexport const getUserRoles = (userId) => {\r\n  try {\r\n    return rbacService.getUserRoles(userId)\r\n  } catch (error) {\r\n    console.error('Error getting user roles:', error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * Obtener nivel m√°ximo de usuario\r\n * @param {string} userId - ID del usuario\r\n * @returns {number} Nivel m√°ximo\r\n */\r\nexport const getUserMaxLevel = (userId) => {\r\n  try {\r\n    const userRoles = rbacService.getUserRoles(userId)\r\n    if (userRoles.length === 0) return 0\r\n    return Math.max(...userRoles.map(role => role.level))\r\n  } catch (error) {\r\n    console.error('Error getting user max level:', error)\r\n    return 0\r\n  }\r\n}\r\n\r\n/**\r\n * Asignar rol a usuario\r\n * @param {string} userId - ID del usuario\r\n * @param {string} roleId - ID del rol\r\n * @param {string} assignedBy - Usuario que asigna\r\n * @returns {boolean} True si se asign√≥\r\n */\r\nexport const assignRole = (userId, roleId, assignedBy) => {\r\n  try {\r\n    return rbacService.assignRole(userId, roleId, assignedBy)\r\n  } catch (error) {\r\n    console.error('Error assigning role:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\n/**\r\n * Revocar rol de usuario\r\n * @param {string} userId - ID del usuario\r\n * @param {string} roleId - ID del rol\r\n * @param {string} revokedBy - Usuario que revoca\r\n * @returns {boolean} True si se revoc√≥\r\n */\r\nexport const revokeRole = (userId, roleId, revokedBy) => {\r\n  try {\r\n    return rbacService.revokeRole(userId, roleId, revokedBy)\r\n  } catch (error) {\r\n    console.error('Error revoking role:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\n/**\r\n * Crear nuevo rol\r\n * @param {Object} roleData - Datos del rol\r\n * @returns {Object} Rol creado\r\n */\r\nexport const createRole = (roleData) => {\r\n  try {\r\n    return rbacService.createRole(roleData)\r\n  } catch (error) {\r\n    console.error('Error creating role:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\n/**\r\n * Actualizar rol existente\r\n * @param {string} roleId - ID del rol\r\n * @param {Object} updates - Datos a actualizar\r\n * @returns {Object} Rol actualizado\r\n */\r\nexport const updateRole = (roleId, updates) => {\r\n  try {\r\n    return rbacService.updateRole(roleId, updates)\r\n  } catch (error) {\r\n    console.error('Error updating role:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\n/**\r\n * Eliminar rol\r\n * @param {string} roleId - ID del rol\r\n * @param {string} deletedBy - Usuario que elimina\r\n * @returns {boolean} True si se elimin√≥\r\n */\r\nexport const deleteRole = (roleId, deletedBy) => {\r\n  try {\r\n    return rbacService.deleteRole(roleId, deletedBy)\r\n  } catch (error) {\r\n    console.error('Error deleting role:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\n/**\r\n * Delegar rol a otro usuario\r\n * @param {string} delegatorId - ID del usuario que delega\r\n * @param {string} delegateeId - ID del usuario que recibe delegaci√≥n\r\n * @param {string} roleId - ID del rol a delegar\r\n * @param {Object} options - Opciones de delegaci√≥n\r\n * @returns {Object} Delegaci√≥n creada\r\n */\r\nexport const delegateRole = (delegatorId, delegateeId, roleId, options = {}) => {\r\n  try {\r\n    return rbacService.delegateRole(delegatorId, delegateeId, roleId, options)\r\n  } catch (error) {\r\n    console.error('Error delegating role:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\n/**\r\n * Obtener logs de auditor√≠a\r\n * @param {Object} filters - Filtros de b√∫squeda\r\n * @returns {Array} Logs filtrados\r\n */\r\nexport const getAuditLogs = (filters = {}) => {\r\n  try {\r\n    return rbacService.getAuditLogs(filters)\r\n  } catch (error) {\r\n    console.error('Error getting audit logs:', error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * Obtener todos los roles\r\n * @returns {Array} Array de roles\r\n */\r\nexport const getAllRoles = () => {\r\n  try {\r\n    return rbacService.getAllRoles()\r\n  } catch (error) {\r\n    console.error('Error getting all roles:', error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * Obtener todos los permisos\r\n * @returns {Array} Array de permisos\r\n */\r\nexport const getAllPermissions = () => {\r\n  try {\r\n    return rbacService.getAllPermissions()\r\n  } catch (error) {\r\n    console.error('Error getting all permissions:', error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * Obtener permisos por categor√≠a\r\n * @param {string} category - Categor√≠a de permisos\r\n * @returns {Array} Array de permisos filtrados\r\n */\r\nexport const getPermissionsByCategory = (category) => {\r\n  try {\r\n    const allPermissions = rbacService.getAllPermissions()\r\n    return allPermissions.filter(perm => perm.category === category)\r\n  } catch (error) {\r\n    console.error('Error getting permissions by category:', error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * Obtener estad√≠sticas de RBAC\r\n * @returns {Object} Estad√≠sticas\r\n */\r\nexport const getRBACStats = () => {\r\n  try {\r\n    return rbacService.getStats()\r\n  } catch (error) {\r\n    console.error('Error getting RBAC stats:', error)\r\n    return {}\r\n  }\r\n}\r\n\r\n/**\r\n * Verificar si usuario puede acceder a recurso espec√≠fico\r\n * @param {string} userId - ID del usuario\r\n * @param {string} resource - Recurso a acceder\r\n * @param {string} action - Acci√≥n a realizar\r\n * @returns {boolean} True si puede acceder\r\n */\r\nexport const canAccess = (userId, resource, action) => {\r\n  try {\r\n    const permissionId = `${resource}.${action}`\r\n    return rbacService.hasPermission(userId, permissionId)\r\n  } catch (error) {\r\n    console.error('Error checking access:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Middleware para verificar permisos\r\n * @param {string} permissionId - ID del permiso requerido\r\n * @returns {Function} Middleware\r\n */\r\nexport const requirePermission = (permissionId) => {\r\n  return (userId) => {\r\n    return hasPermission(userId, permissionId)\r\n  }\r\n}\r\n\r\n/**\r\n * Middleware para verificar rol\r\n * @param {string} roleId - ID del rol requerido\r\n * @returns {Function} Middleware\r\n */\r\nexport const requireRole = (roleId) => {\r\n  return (userId) => {\r\n    return hasRole(userId, roleId)\r\n  }\r\n}\r\n\r\n/**\r\n * Middleware para verificar nivel m√≠nimo\r\n * @param {number} minLevel - Nivel m√≠nimo requerido\r\n * @returns {Function} Middleware\r\n */\r\nexport const requireLevel = (minLevel) => {\r\n  return (userId) => {\r\n    return getUserMaxLevel(userId) >= minLevel\r\n  }\r\n}\r\n\r\n/**\r\n * Obtener informaci√≥n de acceso para UI\r\n * @param {string} userId - ID del usuario\r\n * @returns {Object} Informaci√≥n formateada\r\n */\r\nexport const getAccessInfo = (userId) => {\r\n  try {\r\n    const userRoles = getUserRoles(userId)\r\n    const userPermissions = getUserPermissions(userId)\r\n    const maxLevel = getUserMaxLevel(userId)\r\n\r\n    return {\r\n      userId,\r\n      roles: userRoles.map(role => ({\r\n        id: role.id,\r\n        name: role.name,\r\n        level: role.level\r\n      })),\r\n      permissions: userPermissions.map(perm => ({\r\n        id: perm.id,\r\n        name: perm.name,\r\n        category: perm.category\r\n      })),\r\n      maxLevel,\r\n      canCreate: hasPermission(userId, 'user.create'),\r\n      canRead: hasPermission(userId, 'user.read'),\r\n      canUpdate: hasPermission(userId, 'user.update'),\r\n      canDelete: hasPermission(userId, 'user.delete'),\r\n      isAdmin: hasRole(userId, 'admin'),\r\n      isManager: hasRole(userId, 'manager'),\r\n      isUser: hasRole(userId, 'user'),\r\n      isViewer: hasRole(userId, 'viewer')\r\n    }\r\n  } catch (error) {\r\n    console.error('Error getting access info:', error)\r\n    return {\r\n      userId,\r\n      roles: [],\r\n      permissions: [],\r\n      maxLevel: 0,\r\n      canCreate: false,\r\n      canRead: false,\r\n      canUpdate: false,\r\n      canDelete: false,\r\n      isAdmin: false,\r\n      isManager: false,\r\n      isUser: false,\r\n      isViewer: false\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Filtrar recursos por permisos de usuario\r\n * @param {Array} resources - Array de recursos\r\n * @param {string} userId - ID del usuario\r\n * @param {string} action - Acci√≥n a verificar\r\n * @returns {Array} Recursos filtrados\r\n */\r\nexport const filterByPermission = (resources, userId, action = 'read') => {\r\n  try {\r\n    return resources.filter(resource => {\r\n      const permissionId = `${resource.type}.${action}`\r\n      return hasPermission(userId, permissionId)\r\n    })\r\n  } catch (error) {\r\n    console.error('Error filtering by permission:', error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * Configurar RBAC para usuario inicial\r\n * @param {string} userId - ID del usuario\r\n * @param {string} initialRole - Rol inicial\r\n * @param {string} assignedBy - Usuario que asigna\r\n * @returns {boolean} True si se configur√≥\r\n */\r\nexport const setupInitialRBAC = (userId, initialRole = 'user', assignedBy = 'system') => {\r\n  try {\r\n    return assignRole(userId, initialRole, assignedBy)\r\n  } catch (error) {\r\n    console.error('Error setting up initial RBAC:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\n/**\r\n * Promover usuario a rol superior\r\n * @param {string} userId - ID del usuario\r\n * @param {string} newRole - Nuevo rol\r\n * @param {string} promotedBy - Usuario que promueve\r\n * @returns {boolean} True si se promovi√≥\r\n */\r\nexport const promoteUser = (userId, newRole, promotedBy) => {\r\n  try {\r\n    const currentLevel = getUserMaxLevel(userId)\r\n    const newRoleData = getAllRoles().find(role => role.id === newRole)\r\n    \r\n    if (!newRoleData) {\r\n      throw new Error('Role not found')\r\n    }\r\n\r\n    if (newRoleData.level <= currentLevel) {\r\n      throw new Error('New role must be higher level')\r\n    }\r\n\r\n    return assignRole(userId, newRole, promotedBy)\r\n  } catch (error) {\r\n    console.error('Error promoting user:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\n/**\r\n * Degradar usuario a rol inferior\r\n * @param {string} userId - ID del usuario\r\n * @param {string} newRole - Nuevo rol\r\n * @param {string} degradedBy - Usuario que degrada\r\n * @returns {boolean} True si se degrad√≥\r\n */\r\nexport const demoteUser = (userId, newRole, degradedBy) => {\r\n  try {\r\n    const currentLevel = getUserMaxLevel(userId)\r\n    const newRoleData = getAllRoles().find(role => role.id === newRole)\r\n    \r\n    if (!newRoleData) {\r\n      throw new Error('Role not found')\r\n    }\r\n\r\n    if (newRoleData.level >= currentLevel) {\r\n      throw new Error('New role must be lower level')\r\n    }\r\n\r\n    // Revocar roles superiores\r\n    const userRoles = getUserRoles(userId)\r\n    userRoles.forEach(role => {\r\n      if (role.level > newRoleData.level) {\r\n        revokeRole(userId, role.id, degradedBy)\r\n      }\r\n    })\r\n\r\n    return assignRole(userId, newRole, degradedBy)\r\n  } catch (error) {\r\n    console.error('Error demoting user:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\nexport default {\r\n  hasPermission,\r\n  hasRole,\r\n  hasAnyRole,\r\n  hasAllRoles,\r\n  getUserPermissions,\r\n  getUserRoles,\r\n  getUserMaxLevel,\r\n  assignRole,\r\n  revokeRole,\r\n  createRole,\r\n  updateRole,\r\n  deleteRole,\r\n  delegateRole,\r\n  getAuditLogs,\r\n  getAllRoles,\r\n  getAllPermissions,\r\n  getPermissionsByCategory,\r\n  getRBACStats,\r\n  canAccess,\r\n  requirePermission,\r\n  requireRole,\r\n  requireLevel,\r\n  getAccessInfo,\r\n  filterByPermission,\r\n  setupInitialRBAC,\r\n  promoteUser,\r\n  demoteUser\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"dot-location","replacedBy":[]},{"ruleId":"new-parens","replacedBy":[]},{"ruleId":"no-mixed-operators","replacedBy":[]},{"ruleId":"no-new-object","replacedBy":["no-object-constructor"]},{"ruleId":"no-whitespace-before-property","replacedBy":[]},{"ruleId":"rest-spread-spacing","replacedBy":[]}]}]
